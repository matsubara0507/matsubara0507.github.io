<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
    <title>ひげメモ</title>
    <link href="https://matsubara0507.github.io/feed.xml" rel="self" type="application/rss+xml" />
    <link href="https://matsubara0507.github.io" />
    <id>https://matsubara0507.github.io/feed.xml</id>
    <author>
        <name>MATSUBARA Nobutada</name>
    </author>
    <updated>2021-07-29T11:18:SZ</updated>

    <entry>
        <title>Bazel で Haskell の Custom Setup をする</title>
        <link href="https://matsubara0507.github.ioposts/2021-07-30-rules_haskell-with-setup_deps.html"/>
        <id>https://matsubara0507.github.ioposts/2021-07-30-rules_haskell-with-setup_deps.html</id>
        <updated>2021-07-30T00:00:SZ</updated>
        <category term="Bazel"/>
        <category term="Haskell"/>
        <summary></summary>
        <content type="html"><![CDATA[<p>Bazel を使って Haskell アプリケーションをビルドしてるんですけど，依存パッケージが Custom Setup を使ってるときにちょっと躓いたので，そのメモ書きです．</p>
<h2 id="bazel-で-custom-setup">Bazel で Custom Setup</h2>
<p><a href="https://github.com/matsubara0507/mdium">mdium</a> という CLI ツールを実験的に Bazel でビルドをしている． LTS を 18.0 にあげようと依存パッケージをアップデートしたところ，次のようなエラーが出た：</p>
<pre><code>/private/var/tmp/.../sandbox/darwin-sandbox/10/execroot/mdium/external/stackage/xml-conduit-1.9.1.1/Setup.hs:3:1: error:
    Could not find module ‘Distribution.Extra.Doctest’
    Perhaps you meant Distribution.Simple.Doctest (from Cabal-3.2.1.0)
    Use -v (or `:set -v` in ghci) to see a list of the files searched for.
  |
3 | import Distribution.Extra.Doctest (defaultMainWithDoctests)
  | ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^</code></pre>
<p>Stack でビルドした場合には起きないエラーだ． エラーの内容はどうやら，Cabal の Custom Setup で利用している依存パッケージが足りていないようだ（Custom Setup については「<a href="https://haskell.e-bigmoon.com/posts/2018/12-25-cabal-preprocessing.html">cabal build で package.yaml を使う - BIGMOON Haskeller's BLOG</a>」が日本語記事では分かりやすい）．</p>
<p><a href="https://github.com/tweag/rules_haskell">tweag/rules_haskell</a> で Issue を漁ったところ，<a href="https://github.com/tweag/rules_haskell/issues/1314">まさに同じの</a>があった． どうやら <code>setup_deps</code> を使えば良いらしい：</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode py"><code class="sourceCode python"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a>stack_snapshot(</span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a>    name <span class="op">=</span> <span class="st">&quot;stackage&quot;</span>,</span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a>    packages <span class="op">=</span> [</span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;aeson&quot;</span>,</span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;base&quot;</span>,</span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;dotenv&quot;</span>,</span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;extensible&quot;</span>,</span>
<span id="cb2-8"><a href="#cb2-8" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;fallible&quot;</span>,</span>
<span id="cb2-9"><a href="#cb2-9" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;github&quot;</span>,</span>
<span id="cb2-10"><a href="#cb2-10" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;mix&quot;</span>,</span>
<span id="cb2-11"><a href="#cb2-11" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;mix-json-logger&quot;</span>,</span>
<span id="cb2-12"><a href="#cb2-12" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;mix-plugin-github&quot;</span>,</span>
<span id="cb2-13"><a href="#cb2-13" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;pandoc&quot;</span>,</span>
<span id="cb2-14"><a href="#cb2-14" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;pandoc-types&quot;</span>,</span>
<span id="cb2-15"><a href="#cb2-15" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;rio&quot;</span>,</span>
<span id="cb2-16"><a href="#cb2-16" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;wreq&quot;</span>,</span>
<span id="cb2-17"><a href="#cb2-17" aria-hidden="true" tabindex="-1"></a>    ],</span>
<span id="cb2-18"><a href="#cb2-18" aria-hidden="true" tabindex="-1"></a>    setup_deps <span class="op">=</span> {</span>
<span id="cb2-19"><a href="#cb2-19" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;xml-conduit&quot;</span>: [<span class="st">&quot;cabal-doctest&quot;</span>], <span class="co"># 追記</span></span>
<span id="cb2-20"><a href="#cb2-20" aria-hidden="true" tabindex="-1"></a>    },</span>
<span id="cb2-21"><a href="#cb2-21" aria-hidden="true" tabindex="-1"></a>    local_snapshot <span class="op">=</span> <span class="st">&quot;//:stack-snapshot.yaml&quot;</span>,</span>
<span id="cb2-22"><a href="#cb2-22" aria-hidden="true" tabindex="-1"></a>)</span></code></pre></div>
<p>うまくビルドできました． やったね．</p>
<h2 id="おまけhazell-で対応する">おまけ：hazell で対応する</h2>
<p>ぶっちゃけ，表題の「Bazel で Haskell の Custom Setup をする」に関してはこれでおしまい． Issue もあるので記事にするほどのことでもない（笑）．</p>
<p>ただ，私は <code>stack_snapshot</code> ルールを<a href="https://github.com/matsubara0507/hazell">自作ツール hazell</a> を使って hpack の package.yaml から生成している． しかし，残念ながら <code>setup_deps</code> には対応していないので対応する必要があった（ここからが本題）．</p>
<h1 id="section"></h1>
<p><a href="https://github.com/matsubara0507/hazell/pull/1">作業PRはコチラ</a></p>
<h3 id="dict-型を扱えるようにする">Dict 型を扱えるようにする</h3>
<p>実は，今までの機能であれば <a href="https://docs.bazel.build/versions/main/skylark/lib/globals.html#dict">Dict 型</a>を扱う必要がなかったので未対応だった（WORKSPACE などを読み込むとエラーになる）． まずはここから対応する．</p>
<p>まずは Bazel ルールの引数の型 <code>RuleArg</code> を拡張する：</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="kw">data</span> <span class="dt">RuleArg</span></span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a>  <span class="ot">=</span> <span class="dt">RuleArgString</span> <span class="dt">String</span></span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a>  <span class="op">|</span> <span class="dt">RuleArgBool</span> <span class="dt">Bool</span></span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a>  <span class="op">|</span> <span class="dt">RuleArgArray</span> [<span class="dt">RuleArg</span>]</span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a>  <span class="op">|</span> <span class="dt">RuleArgDict</span> (<span class="dt">Map</span> <span class="dt">String</span> <span class="dt">RuleArg</span>) <span class="co">-- 追加</span></span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true" tabindex="-1"></a>  <span class="op">|</span> <span class="dt">RuleArgConst</span> <span class="dt">String</span></span>
<span id="cb3-7"><a href="#cb3-7" aria-hidden="true" tabindex="-1"></a>  <span class="op">|</span> <span class="dt">RuleArgGlob</span> <span class="dt">String</span></span></code></pre></div>
<p><code>Map</code> を使うと，元のキーの順番が保持されないが，まぁ本質的には困らないのでとりあえず <code>Map</code> にした． フォーマットするときにモヤモヤしだしたらキーの順番が保持される仕組みを考えることとする．</p>
<p>次にパーサーを追加：</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="ot">buildRuleArgParser ::</span> <span class="dt">Parser</span> <span class="dt">RuleArg</span></span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a>buildRuleArgParser</span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a>    <span class="ot">=</span> buildRuleArgArrayParser</span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a>  <span class="op">&lt;|&gt;</span> buildRuleArgDictParser  <span class="co">-- 追加</span></span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a>  <span class="op">&lt;|&gt;</span> buildRuleArgBoolParser</span>
<span id="cb4-6"><a href="#cb4-6" aria-hidden="true" tabindex="-1"></a>   <span class="op">...</span></span>
<span id="cb4-7"><a href="#cb4-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-8"><a href="#cb4-8" aria-hidden="true" tabindex="-1"></a><span class="co">-- `{ &quot;key&quot; : value, &quot;key&quot; : value }` って感じのをパースしたい</span></span>
<span id="cb4-9"><a href="#cb4-9" aria-hidden="true" tabindex="-1"></a><span class="ot">buildRuleArgDictParser ::</span> <span class="dt">Parser</span> <span class="dt">RuleArg</span></span>
<span id="cb4-10"><a href="#cb4-10" aria-hidden="true" tabindex="-1"></a>buildRuleArgDictParser <span class="ot">=</span> <span class="kw">do</span></span>
<span id="cb4-11"><a href="#cb4-11" aria-hidden="true" tabindex="-1"></a>  char <span class="ch">&#39;{&#39;</span></span>
<span id="cb4-12"><a href="#cb4-12" aria-hidden="true" tabindex="-1"></a>  space</span>
<span id="cb4-13"><a href="#cb4-13" aria-hidden="true" tabindex="-1"></a>  dict <span class="ot">&lt;-</span> buildRuleDictMemberParser <span class="ot">`sepAndEndBy`</span> (comma, space <span class="op">&gt;&gt;</span> char <span class="ch">&#39;}&#39;</span>)</span>
<span id="cb4-14"><a href="#cb4-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pure</span> <span class="op">$</span> <span class="dt">RuleArgDict</span> (Map.fromList dict)</span>
<span id="cb4-15"><a href="#cb4-15" aria-hidden="true" tabindex="-1"></a>  <span class="kw">where</span></span>
<span id="cb4-16"><a href="#cb4-16" aria-hidden="true" tabindex="-1"></a><span class="ot">    buildRuleDictMemberParser ::</span> <span class="dt">Parser</span> (<span class="dt">String</span>, <span class="dt">RuleArg</span>)</span>
<span id="cb4-17"><a href="#cb4-17" aria-hidden="true" tabindex="-1"></a>    buildRuleDictMemberParser <span class="ot">=</span> <span class="kw">do</span></span>
<span id="cb4-18"><a href="#cb4-18" aria-hidden="true" tabindex="-1"></a>      key <span class="ot">&lt;-</span> stringLitParser</span>
<span id="cb4-19"><a href="#cb4-19" aria-hidden="true" tabindex="-1"></a>      space</span>
<span id="cb4-20"><a href="#cb4-20" aria-hidden="true" tabindex="-1"></a>      char <span class="ch">&#39;:&#39;</span></span>
<span id="cb4-21"><a href="#cb4-21" aria-hidden="true" tabindex="-1"></a>      space</span>
<span id="cb4-22"><a href="#cb4-22" aria-hidden="true" tabindex="-1"></a>      val <span class="ot">&lt;-</span> buildRuleArgParser</span>
<span id="cb4-23"><a href="#cb4-23" aria-hidden="true" tabindex="-1"></a>      <span class="fu">pure</span> (key, val)</span></code></pre></div>
<p><code>sepAndEndBy</code> コンビネーターは自分で定義しているやつで，名前の通りセパレーターと終端に使うパーサーをそれぞれ指定して繰り返し処理させる．</p>
<p>最後にプリティプリンターを定義して完成：</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="kw">instance</span> <span class="dt">Pretty</span> <span class="dt">RuleArg</span> <span class="kw">where</span></span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a>  pretty (<span class="dt">RuleArgString</span> str)  <span class="ot">=</span> fromString (<span class="fu">show</span> str)</span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a>  pretty (<span class="dt">RuleArgBool</span> <span class="dt">True</span>)   <span class="ot">=</span> <span class="st">&quot;True&quot;</span></span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a>  <span class="op">...</span></span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a>  pretty (<span class="dt">RuleArgDict</span> dict)   <span class="ot">=</span> pretteyDict dict <span class="co">-- 追加</span></span>
<span id="cb5-6"><a href="#cb5-6" aria-hidden="true" tabindex="-1"></a>  <span class="op">...</span></span>
<span id="cb5-7"><a href="#cb5-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-8"><a href="#cb5-8" aria-hidden="true" tabindex="-1"></a><span class="co">-- 要素がある場合は次のように出力したい：</span></span>
<span id="cb5-9"><a href="#cb5-9" aria-hidden="true" tabindex="-1"></a><span class="co">--  hoge = {</span></span>
<span id="cb5-10"><a href="#cb5-10" aria-hidden="true" tabindex="-1"></a><span class="co">--    &quot;key1&quot;: value1,</span></span>
<span id="cb5-11"><a href="#cb5-11" aria-hidden="true" tabindex="-1"></a><span class="co">--    &quot;key2&quot;: value2,</span></span>
<span id="cb5-12"><a href="#cb5-12" aria-hidden="true" tabindex="-1"></a><span class="co">--  }</span></span>
<span id="cb5-13"><a href="#cb5-13" aria-hidden="true" tabindex="-1"></a><span class="ot">pretteyDict ::</span> <span class="dt">Map</span> <span class="dt">String</span> <span class="dt">RuleArg</span> <span class="ot">-&gt;</span> <span class="dt">Doc</span> ann</span>
<span id="cb5-14"><a href="#cb5-14" aria-hidden="true" tabindex="-1"></a>pretteyDict dict <span class="ot">=</span></span>
<span id="cb5-15"><a href="#cb5-15" aria-hidden="true" tabindex="-1"></a>  <span class="kw">if</span> Map.null dict <span class="kw">then</span></span>
<span id="cb5-16"><a href="#cb5-16" aria-hidden="true" tabindex="-1"></a>    <span class="st">&quot;{}&quot;</span></span>
<span id="cb5-17"><a href="#cb5-17" aria-hidden="true" tabindex="-1"></a>  <span class="kw">else</span></span>
<span id="cb5-18"><a href="#cb5-18" aria-hidden="true" tabindex="-1"></a>    vsep [nest <span class="dv">4</span> <span class="op">$</span> vsep (<span class="st">&quot;{&quot;</span> <span class="op">:</span> pretteyDict&#39; dict), <span class="st">&quot;}&quot;</span>]</span>
<span id="cb5-19"><a href="#cb5-19" aria-hidden="true" tabindex="-1"></a>  <span class="kw">where</span></span>
<span id="cb5-20"><a href="#cb5-20" aria-hidden="true" tabindex="-1"></a>    pretteyDict&#39; <span class="ot">=</span> <span class="fu">map</span> (\(k, v) <span class="ot">-&gt;</span> fromString (<span class="fu">show</span> k) <span class="op">&lt;&gt;</span> <span class="st">&quot;: &quot;</span> <span class="op">&lt;&gt;</span> pretty v <span class="op">&lt;&gt;</span> <span class="st">&quot;,&quot;</span>) <span class="op">.</span> Map.toList</span></code></pre></div>
<p>これで hazell に修正した WORKSPACE ファイルを食わしてもパースエラーが起きなくなった． しかし，追記した <code>setup_deps</code> が消えてしまう． 困った．</p>
<h3 id="未定義の引数は残すようにする">未定義の引数は残すようにする</h3>
<p>実は，元の <code>stack_snapshot</code> と新しく生成した <code>stack_snapshot</code> のマージが雑すぎて，新しく生成した <code>stack_snapshot</code> にない引数は消してしまうようになっていた． なので，元の <code>stack_snapshot</code> にある引数はちゃんと保持するようにマージ処理を書き直した：</p>
<div class="sourceCode" id="cb6"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="kw">qualified</span> <span class="dt">Data.Map.Merge.Strict</span> <span class="kw">as</span> <span class="dt">Map</span></span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a><span class="ot">mergeRuleArgs ::</span> <span class="dt">BuildContent</span> <span class="ot">-&gt;</span> <span class="dt">Rule</span> <span class="ot">-&gt;</span> <span class="dt">BuildContent</span></span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a>mergeRuleArgs (<span class="dt">BuildRule</span> name args) rule <span class="ot">=</span></span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a>  <span class="dt">BuildRule</span> name <span class="op">.</span> Map.toList <span class="op">$</span> Map.merge</span>
<span id="cb6-6"><a href="#cb6-6" aria-hidden="true" tabindex="-1"></a>    Map.preserveMissing</span>
<span id="cb6-7"><a href="#cb6-7" aria-hidden="true" tabindex="-1"></a>    Map.preserveMissing</span>
<span id="cb6-8"><a href="#cb6-8" aria-hidden="true" tabindex="-1"></a>    (Map.zipWithMatched <span class="op">$</span> \_ old new <span class="ot">-&gt;</span> new)</span>
<span id="cb6-9"><a href="#cb6-9" aria-hidden="true" tabindex="-1"></a>    (Map.fromList args)</span>
<span id="cb6-10"><a href="#cb6-10" aria-hidden="true" tabindex="-1"></a>    (Map.fromList <span class="op">$</span> ruleArgs rule)</span>
<span id="cb6-11"><a href="#cb6-11" aria-hidden="true" tabindex="-1"></a>mergeRuleArgs content _ <span class="ot">=</span> content</span></code></pre></div>
<p>1引数目が WORKSPACE ファイルをパースして得た元々の <code>stack_snapshot</code> ルールで，2引数目が package.yaml から生成した新しい <code>stack_snapshot</code> ルール（型が違うのはお気になさらず）． 連想配列の結合にはどうやら <a href="https://hackage.haskell.org/package/containers-0.6.5.1/docs/Data-Map-Merge-Strict.html#v:merge"><code>Data.Map.Merge</code> の <code>merge</code> 関数</a>を利用すると良いらしい（もちろん，もっとパフォーマンスの良いサードパーティパッケージはあるだろうが）． <code>merge</code> 関数は3つの関数を受け取る高階関数である． 型がぱっと見謎（<code>SimpleWhenMissing k a c</code> など）だが，要するに次の3つのケースに関する関数を要求している（<code>merge m1 m2</code>）：</p>
<ol>
<li><code>m1</code> だけ要素があった場合の <code>key -&gt; m1Value -&gt; Maybe newValue</code> な関数</li>
<li><code>m2</code> だけ要素があった場合の <code>key -&gt; m2Value -&gt; Maybe newValue</code> な関数</li>
<li>両方に要素があった場合の <code>key -&gt; m1Value -&gt; m2Value -&gt; Maybe newValue</code> な関数</li>
</ol>
<p>全て最後が <code>Maybe</code> なのは，<code>Nothing</code> の場合はキーそのものを消すためだ． 今回は (1)(2) はヒットした方をそのまま利用し，(3) の場合は新しい方（<code>m2</code>）優先にしたい． ヒットしたのをそのまま使う場合は <code>preserveMissing</code> 関数を使えばよい． <code>zipWithMatched</code> 関数は，前述した <code>Nothing</code> のケースを排除した <code>zip</code> 関数のようなものだ．</p>
<h3 id="cabal-ファイルを集める">Cabal ファイルを集める</h3>
<p>正直，機能的にはここまでで十分だったが，せっかくなので <code>setup_deps</code> も自動生成する方法を実装してみる． Custom Setup の依存パッケージは Cabal ファイルの <code>custom-setup</code> の <code>setup-depends</code> に書いてある． つまり，まずはインダイレクトも含む全ての依存パッケージの Cabal ファイルを集める必要がある（これはなかなか大変）．</p>
<p>現在解析している package.yaml には直接の依存パッケージしか書いてないので依存パッケージの依存パッケージなども含めて列挙する方法を考える． いろいろ試行錯誤した結果，とりあえずは <code>stack ls</code> を使うことにした（Stack も Haskell 製なので，いずれ直接扱えるようにしたい）：</p>
<div class="sourceCode" id="cb7"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="dt">RIO.Process</span> (<span class="dt">HasProcessContext</span>, proc, readProcessStdout_, withWorkingDir)</span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a>runStackLs</span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a><span class="ot">  ::</span> (<span class="dt">HasProcessContext</span> env, <span class="dt">HasLogFunc</span> env, <span class="dt">MonadReader</span> env m, <span class="dt">MonadIO</span> m, <span class="dt">HasCallStack</span>)</span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a>  <span class="ot">=&gt;</span> <span class="dt">FilePath</span> <span class="ot">-&gt;</span> m [<span class="dt">DotPayload</span>]</span>
<span id="cb7-6"><a href="#cb7-6" aria-hidden="true" tabindex="-1"></a>runStackLs path <span class="ot">=</span> <span class="kw">do</span></span>
<span id="cb7-7"><a href="#cb7-7" aria-hidden="true" tabindex="-1"></a>  out <span class="ot">&lt;-</span> proc <span class="st">&quot;stack&quot;</span> [<span class="st">&quot;ls&quot;</span>, <span class="st">&quot;dependencies&quot;</span>, <span class="st">&quot;json&quot;</span>, <span class="st">&quot;--test&quot;</span>] (withWorkingDir path <span class="op">.</span> readProcessStdout_)</span>
<span id="cb7-8"><a href="#cb7-8" aria-hidden="true" tabindex="-1"></a>  <span class="kw">case</span> JSON.eitherDecode out <span class="kw">of</span></span>
<span id="cb7-9"><a href="#cb7-9" aria-hidden="true" tabindex="-1"></a>    <span class="dt">Left</span> e  <span class="ot">-&gt;</span> logError (displayShow e) <span class="op">&gt;&gt;</span> <span class="fu">pure</span> <span class="fu">mempty</span></span>
<span id="cb7-10"><a href="#cb7-10" aria-hidden="true" tabindex="-1"></a>    <span class="dt">Right</span> a <span class="ot">-&gt;</span> <span class="fu">pure</span> a</span></code></pre></div>
<p>rio を利用して外部コマンドを安全に呼び出すには <a href="https://hackage.haskell.org/package/rio-0.1.20.0/docs/RIO-Process.html"><code>RIO.Process</code> モジュール</a>を使うのだが少しクセがある． 基本は <code>HasProcessContext m</code> 型クラス配下のモナド <code>m</code> で <a href="https://hackage.haskell.org/package/rio-0.1.20.0/docs/RIO-Process.html#v:proc"><code>proc</code> 関数</a>を呼べば良い：</p>
<div class="sourceCode" id="cb8"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a>proc</span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a><span class="ot">  ::</span> (<span class="dt">HasProcessContext</span> env, <span class="dt">HasLogFunc</span> env, <span class="dt">MonadReader</span> env m, <span class="dt">MonadIO</span> m, <span class="dt">HasCallStack</span>)	 </span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a>  <span class="ot">=&gt;</span> <span class="dt">FilePath</span>	</span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a>  <span class="ot">-&gt;</span> [<span class="dt">String</span>]	</span>
<span id="cb8-5"><a href="#cb8-5" aria-hidden="true" tabindex="-1"></a>  <span class="ot">-&gt;</span> (<span class="dt">ProcessConfig</span> () () () <span class="ot">-&gt;</span> m a)	 </span>
<span id="cb8-6"><a href="#cb8-6" aria-hidden="true" tabindex="-1"></a>  <span class="ot">-&gt;</span> m a</span></code></pre></div>
<p>1引数目と2引数目が呼び出したいコマンドと与える引数なのだが，問題は3引数目． これは，コマンドを呼び出すプロセスの設定を関数結合な感じで定義している． 例えば今回は，返り値として標準出力が欲しいので <code>readProcessStdout_</code> を使い，加えて実行ディレクトリを変えたいので <code>withWorkingDir</code> も呼んでいる． 他にも Exit Code を返り値にしたり，標準入力を与えたりするコンビネーターが存在する．</p>
<p>で，<code>stack ls</code> の結果は JSON 形式で出力してパースしている． <code>DotPayload</code> 型は <a href="https://github.com/commercialhaskell/stack/blob/v2.7.1/src/Stack/Dot.hs">Stack のコード</a>を呼んで必要なものだけ切り出した型だ． あとは <code>DotPayload</code> から Cabal ファイルを拾ってくる関数を定義するだけ：</p>
<div class="sourceCode" id="cb9"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="kw">type</span> <span class="dt">CabalPackage</span> <span class="ot">=</span> <span class="dt">Cabal.PackageDescription</span></span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a><span class="ot">readCabalFile ::</span> <span class="dt">MonadIO</span> m <span class="ot">=&gt;</span> <span class="dt">DotPayload</span> <span class="ot">-&gt;</span> m (<span class="dt">Maybe</span> (<span class="dt">Either</span> <span class="dt">String</span> <span class="dt">CabalPackage</span>))</span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true" tabindex="-1"></a>readCabalFile payload <span class="ot">=</span></span>
<span id="cb9-5"><a href="#cb9-5" aria-hidden="true" tabindex="-1"></a>  <span class="co">-- hackage 以外の場合はいったん未対応</span></span>
<span id="cb9-6"><a href="#cb9-6" aria-hidden="true" tabindex="-1"></a>  <span class="kw">case</span> payloadLocation payload <span class="kw">of</span></span>
<span id="cb9-7"><a href="#cb9-7" aria-hidden="true" tabindex="-1"></a>    (<span class="dt">Just</span> (<span class="dt">PackageLocation</span> <span class="st">&quot;hackage&quot;</span> url)) <span class="ot">-&gt;</span> <span class="kw">do</span></span>
<span id="cb9-8"><a href="#cb9-8" aria-hidden="true" tabindex="-1"></a>      <span class="dt">Just</span> <span class="op">.</span> (parsePackageDescription <span class="op">=&lt;&lt;</span>) <span class="op">&lt;$&gt;</span> get (Text.unpack url <span class="op">++</span> <span class="st">&quot;/&quot;</span> <span class="op">++</span> packageName <span class="op">++</span> <span class="st">&quot;.cabal&quot;</span>)</span>
<span id="cb9-9"><a href="#cb9-9" aria-hidden="true" tabindex="-1"></a>    _ <span class="ot">-&gt;</span></span>
<span id="cb9-10"><a href="#cb9-10" aria-hidden="true" tabindex="-1"></a>      <span class="fu">pure</span> <span class="dt">Nothing</span></span>
<span id="cb9-11"><a href="#cb9-11" aria-hidden="true" tabindex="-1"></a>  <span class="kw">where</span></span>
<span id="cb9-12"><a href="#cb9-12" aria-hidden="true" tabindex="-1"></a>    packageName <span class="ot">=</span> Text.unpack (payloadName payload)</span>
<span id="cb9-13"><a href="#cb9-13" aria-hidden="true" tabindex="-1"></a>    parsePackageDescription b <span class="ot">=</span> <span class="kw">case</span> Cabal.parseGenericPackageDescriptionMaybe b <span class="kw">of</span></span>
<span id="cb9-14"><a href="#cb9-14" aria-hidden="true" tabindex="-1"></a>      <span class="dt">Nothing</span> <span class="ot">-&gt;</span> <span class="dt">Left</span> <span class="op">$</span> <span class="st">&quot;cannnot parse to cabal file &quot;</span> <span class="op">++</span> packageName</span>
<span id="cb9-15"><a href="#cb9-15" aria-hidden="true" tabindex="-1"></a>      <span class="dt">Just</span> p  <span class="ot">-&gt;</span> <span class="dt">Right</span> <span class="op">$</span> Cabal.packageDescription p</span></code></pre></div>
<p>Cabal ファイルは Hackage から引くことができる（例えば <code>https://hackage.haskell.org/package/rio-0.1.20.0/rio.cabal</code> など）． <code>get</code> 関数は req パッケージを使って自分で定義した，いい感じにしただけの GET HTTP リクエストするだけの関数（割愛）で，これを使って取ってきている． <a href="https://hackage.haskell.org/package/Cabal-3.4.0.0/docs/Distribution-PackageDescription-Parsec.html#v:parseGenericPackageDescriptionMaybe">Cabal ファイルのパーサーは Cabal パッケージにある</a>のでそれを利用しているだけだ．</p>
<h3 id="setup_deps-を生成する"><code>setup_deps</code> を生成する</h3>
<p>あとは集めた Cabal ファイルを使って <code>setup_deps</code> を構築するだけだ． Cabal パッケージの関数をそのまま呼ぶことで Custom Setup 用の依存パッケージは集めることができる：</p>
<div class="sourceCode" id="cb10"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="kw">qualified</span> <span class="dt">Distribution.Types.Dependency</span>  <span class="kw">as</span> <span class="dt">Cabal</span></span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="kw">qualified</span> <span class="dt">Distribution.Types.PackageId</span>   <span class="kw">as</span> <span class="dt">Cabal</span></span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="kw">qualified</span> <span class="dt">Distribution.Types.PackageName</span> <span class="kw">as</span> <span class="dt">Cabal</span></span>
<span id="cb10-4"><a href="#cb10-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-5"><a href="#cb10-5" aria-hidden="true" tabindex="-1"></a><span class="ot">toSetupDeps ::</span> <span class="dt">CabalPackage</span> <span class="ot">-&gt;</span> [<span class="dt">String</span>]</span>
<span id="cb10-6"><a href="#cb10-6" aria-hidden="true" tabindex="-1"></a>toSetupDeps <span class="ot">=</span></span>
<span id="cb10-7"><a href="#cb10-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">fmap</span> (Cabal.unPackageName <span class="op">.</span> Cabal.depPkgName) <span class="op">.</span> <span class="fu">maybe</span> [] Cabal.setupDepends <span class="op">.</span> Cabal.setupBuildInfo</span>
<span id="cb10-8"><a href="#cb10-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-9"><a href="#cb10-9" aria-hidden="true" tabindex="-1"></a><span class="ot">toPackageName ::</span> <span class="dt">CabalPackage</span> <span class="ot">-&gt;</span> <span class="dt">String</span></span>
<span id="cb10-10"><a href="#cb10-10" aria-hidden="true" tabindex="-1"></a>toPackageName <span class="ot">=</span></span>
<span id="cb10-11"><a href="#cb10-11" aria-hidden="true" tabindex="-1"></a>  Cabal.unPackageName <span class="op">.</span> Cabal.pkgName <span class="op">.</span> Cabal.package</span></code></pre></div>
<p>これを雑に <code>setup_deps</code> にしたところ，Cabal パッケージなど不要なのが大量に出てきてしまった． おそらく，<a href="https://downloads.haskell.org/~ghc/8.10.4/docs/html/users_guide/packages.html#using-packages">GHC にデフォルト含まれるパッケージ</a> は <code>setup_deps</code> に指定する必要がない気がするので弾くようにした：</p>
<div class="sourceCode" id="cb11"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a><span class="ot">buildSetupDeps ::</span> [<span class="dt">CabalPackage</span>] <span class="ot">-&gt;</span> [(<span class="dt">Maybe</span> [<span class="dt">Char</span>], <span class="dt">RuleArg</span>)]</span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a>buildSetupDeps cabals <span class="ot">=</span></span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a>  <span class="kw">case</span> [(Cabal.toPackageName c, <span class="dt">RuleArgArray</span> ds) <span class="op">|</span> c <span class="ot">&lt;-</span> cabals, <span class="kw">let</span> ds <span class="ot">=</span> toSetupDepsArg c, <span class="fu">not</span> (<span class="fu">null</span> ds)] <span class="kw">of</span></span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true" tabindex="-1"></a>    [] <span class="ot">-&gt;</span></span>
<span id="cb11-5"><a href="#cb11-5" aria-hidden="true" tabindex="-1"></a>      []</span>
<span id="cb11-6"><a href="#cb11-6" aria-hidden="true" tabindex="-1"></a>    deps <span class="ot">-&gt;</span></span>
<span id="cb11-7"><a href="#cb11-7" aria-hidden="true" tabindex="-1"></a>      [(<span class="dt">Just</span> <span class="st">&quot;setup_deps&quot;</span>, <span class="dt">RuleArgDict</span> <span class="op">$</span> Map.fromList deps)]</span>
<span id="cb11-8"><a href="#cb11-8" aria-hidden="true" tabindex="-1"></a>  <span class="kw">where</span></span>
<span id="cb11-9"><a href="#cb11-9" aria-hidden="true" tabindex="-1"></a>    toSetupDepsArg <span class="ot">=</span> <span class="fu">fmap</span> <span class="dt">RuleArgString</span> <span class="op">.</span> <span class="fu">filter</span> (<span class="fu">not</span> <span class="op">.</span> (<span class="ot">`elem`</span> ghcPkgs)) <span class="op">.</span> Cabal.toSetupDeps</span>
<span id="cb11-10"><a href="#cb11-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-11"><a href="#cb11-11" aria-hidden="true" tabindex="-1"></a><span class="ot">ghcPkgs ::</span> [<span class="dt">String</span>]</span>
<span id="cb11-12"><a href="#cb11-12" aria-hidden="true" tabindex="-1"></a>ghcPkgs <span class="ot">=</span> [<span class="st">&quot;Cabal&quot;</span>, <span class="op">...</span> ]</span></code></pre></div>
<p>これで無事完成．</p>
<h2 id="おしまい">おしまい</h2>
<p>ちなみに，全ての Cabal ファイルを集めて <code>setup_deps</code> を構築するのはそこそこ時間がかかるため，するかしないかをフラグで制御できるようにしてる． Hackage にある Cabal ファイルはパッケージのバージョン毎に（たぶん）不変なのでローカルにキャッシュする方法を用意したいね．</p>]]></content>
    </entry>
    <entry>
        <title>ここを Hakyll から Slick に移行してみた</title>
        <link href="https://matsubara0507.github.ioposts/2021-06-13-my-site-use-slick.html"/>
        <id>https://matsubara0507.github.ioposts/2021-06-13-my-site-use-slick.html</id>
        <updated>2021-06-13T00:00:SZ</updated>
        <category term="site"/>
        <category term="Haskell"/>
        <summary></summary>
        <content type="html"><![CDATA[<p>特に深い理由はないですが，新しいツールを触ってみようかと思い変えてみました。</p>
<h2 id="slick">Slick</h2>
<p><a href="https://github.com/ChrisPenner/slick">Slick</a> は Hakyll と同じような Haskell 製の静的サイトジェネレーターで，サイトの生成方法自体を自身でプログラミングする． <a href="https://github.com/ChrisPenner/slick#another-static-site-generator-what-about-hakylljekyll">GitHub の README 曰く</a>，Hakyll はモナドに隠蔽されすぎてよくわからないから，もっとわかりやすいのを作った（超意訳）だそうだ． 実際，両方同じようなコードを書いてみた感じ，確かに Slick の方がわかりやすい（シンプル）．</p>
<p>Slick は内部的な処理の多くを外部パッケージに委ねている：</p>
<ul>
<li>ビルドシステムには <a href="https://shakebuild.com/">Shake</a> を利用している（提供するサブコマンドやビルド結果のキャッシュなど）</li>
<li>Markdown から HTML への変換は <a href="https://hackage.haskell.org/package/pandoc">Pandoc</a> を利用している（Hakyll と同じ）</li>
<li>テンプレートのレンダリングには <a href="https://hackage.haskell.org/package/mustache">Mustache</a> を利用している</li>
</ul>
<p>それぞれについては，あまり詳しいことを僕は知らないので，ここでは解説しません．</p>
<h2 id="カスタマイズする">カスタマイズする</h2>
<p>Slick の作者は <a href="https://github.com/ChrisPenner/slick-template">ChrisPenner/slick-template</a> というテンプレートリポジトリを用意しているので，これをベースにカスタマイズしていく． 正直なところ，半分は元の Hakyll でのテンプレートを再現するため．</p>
<h3 id="extensible-レコード">extensible レコード</h3>
<p>まずはいきなりテンプレートの再現ではないやつ．</p>
<p>slick-template で使っていたレコード型を extensible レコードに置き換える． 例えば：</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="kw">type</span> <span class="dt">SiteMeta</span> <span class="ot">=</span> <span class="dt">Record</span></span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a>  &#39;[ <span class="st">&quot;siteTitle&quot;</span>   <span class="op">&gt;:</span> <span class="dt">String</span></span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a>   , <span class="st">&quot;domain&quot;</span>      <span class="op">&gt;:</span> <span class="dt">String</span></span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a>   , <span class="st">&quot;author&quot;</span>      <span class="op">&gt;:</span> <span class="dt">String</span></span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a>   , <span class="st">&quot;description&quot;</span> <span class="op">&gt;:</span> <span class="dt">String</span></span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a>   , <span class="st">&quot;twitter&quot;</span>     <span class="op">&gt;:</span> <span class="dt">Maybe</span> <span class="dt">String</span></span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a>   , <span class="st">&quot;github&quot;</span>      <span class="op">&gt;:</span> <span class="dt">Maybe</span> <span class="dt">String</span></span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a>   ]</span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a><span class="kw">type</span> <span class="dt">Post</span> <span class="ot">=</span> <span class="dt">Record</span> (&#39;[ <span class="st">&quot;date&quot;</span> <span class="op">&gt;:</span> <span class="dt">String</span>, <span class="st">&quot;url&quot;</span> <span class="op">&gt;:</span> <span class="dt">String</span> ] <span class="op">++</span> <span class="dt">FrontMatterParams</span>)</span>
<span id="cb1-11"><a href="#cb1-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-12"><a href="#cb1-12" aria-hidden="true" tabindex="-1"></a><span class="kw">type</span> <span class="dt">FrontMatterParams</span> <span class="ot">=</span></span>
<span id="cb1-13"><a href="#cb1-13" aria-hidden="true" tabindex="-1"></a>  &#39;[ <span class="st">&quot;title&quot;</span>   <span class="op">&gt;:</span> <span class="dt">String</span></span>
<span id="cb1-14"><a href="#cb1-14" aria-hidden="true" tabindex="-1"></a>   , <span class="st">&quot;tags&quot;</span>    <span class="op">&gt;:</span> [<span class="dt">Tag</span>]</span>
<span id="cb1-15"><a href="#cb1-15" aria-hidden="true" tabindex="-1"></a>   , <span class="st">&quot;image&quot;</span>   <span class="op">&gt;:</span> <span class="dt">Maybe</span> <span class="dt">String</span></span>
<span id="cb1-16"><a href="#cb1-16" aria-hidden="true" tabindex="-1"></a>   , <span class="st">&quot;content&quot;</span> <span class="op">&gt;:</span> <span class="dt">String</span></span>
<span id="cb1-17"><a href="#cb1-17" aria-hidden="true" tabindex="-1"></a>   ]</span></code></pre></div>
<p>フロントマターの部分だけ分けてるのは後述．</p>
<p>extensible を使うのに利点はあって，slick-template では <code>substitute</code> に渡す <code>ToMustache k</code> の値を結合するときに aeson の <code>Value</code> 型に変換して無理やり足しているが，extensible レコードであれば <code>happend</code> だけですむ． 無論このためには extensible レコードを <code>ToMustache</code> 型クラスのインスタンスにする必要がある：</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="kw">deriving</span> <span class="kw">instance</span> <span class="dt">ToMustache</span> (h (<span class="dt">TargetOf</span> kv)) <span class="ot">=&gt;</span> <span class="dt">ToMustache</span> (<span class="dt">Field</span> h kv)</span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a><span class="kw">deriving</span> <span class="kw">instance</span> <span class="dt">ToMustache</span> a <span class="ot">=&gt;</span> <span class="dt">ToMustache</span> (<span class="dt">Identity</span> a)</span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a><span class="kw">instance</span> <span class="dt">Forall</span> (<span class="dt">KeyTargetAre</span> <span class="dt">KnownSymbol</span> (<span class="dt">Instance1</span> <span class="dt">ToMustache</span> h)) xs <span class="ot">=&gt;</span> <span class="dt">ToMustache</span> (xs <span class="op">:&amp;</span> <span class="dt">Field</span> h) <span class="kw">where</span></span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a>  toMustache <span class="ot">=</span> <span class="dt">Object</span> <span class="op">.</span> hfoldlWithIndexFor</span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a>    (<span class="dt">Proxy</span> <span class="op">@</span> (<span class="dt">KeyTargetAre</span> <span class="dt">KnownSymbol</span> (<span class="dt">Instance1</span> <span class="dt">ToMustache</span> h)))</span>
<span id="cb2-8"><a href="#cb2-8" aria-hidden="true" tabindex="-1"></a>    (\k m v <span class="ot">-&gt;</span> HM.insert (stringKeyOf k) (toMustache v) m)</span>
<span id="cb2-9"><a href="#cb2-9" aria-hidden="true" tabindex="-1"></a>    HM.empty</span></code></pre></div>
<p>また，Shake のキャッシュ（<code>cacheAction</code>）を利用するには生成物の型（例えば <code>Post</code>）が <code>Binary</code> 型クラスのインスタンスになってないといけない：</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="kw">deriving</span> <span class="kw">instance</span> <span class="dt">Binary</span> (h (<span class="dt">TargetOf</span> kv)) <span class="ot">=&gt;</span> <span class="dt">Binary</span> (<span class="dt">Field</span> h kv)</span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a><span class="kw">instance</span> <span class="dt">Forall</span> (<span class="dt">KeyTargetAre</span> <span class="dt">KnownSymbol</span> (<span class="dt">Instance1</span> <span class="dt">Binary</span> h)) xs <span class="ot">=&gt;</span> <span class="dt">Binary</span> (xs <span class="op">:&amp;</span> <span class="dt">Field</span> h) <span class="kw">where</span></span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a>    get <span class="ot">=</span> hgenerateFor</span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a>      (<span class="dt">Proxy</span> <span class="op">@</span> (<span class="dt">KeyTargetAre</span> <span class="dt">KnownSymbol</span> (<span class="dt">Instance1</span> <span class="dt">Binary</span> h)))</span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true" tabindex="-1"></a>      (<span class="fu">const</span> Binary.get)</span>
<span id="cb3-7"><a href="#cb3-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-8"><a href="#cb3-8" aria-hidden="true" tabindex="-1"></a>    put <span class="ot">=</span> <span class="fu">flip</span> appEndo (<span class="fu">return</span> ()) <span class="op">.</span> hfoldMap getConst <span class="op">.</span></span>
<span id="cb3-9"><a href="#cb3-9" aria-hidden="true" tabindex="-1"></a>      hzipWith</span>
<span id="cb3-10"><a href="#cb3-10" aria-hidden="true" tabindex="-1"></a>        (\(<span class="dt">Comp</span> <span class="dt">Dict</span>) x <span class="ot">-&gt;</span> <span class="dt">Const</span> <span class="op">$</span> <span class="dt">Endo</span> <span class="op">$</span> (Binary.put x <span class="op">&gt;&gt;</span>))</span>
<span id="cb3-11"><a href="#cb3-11" aria-hidden="true" tabindex="-1"></a>        (<span class="ot">library ::</span> xs <span class="op">:&amp;</span> <span class="dt">Comp</span> <span class="dt">Dict</span> (<span class="dt">KeyTargetAre</span> <span class="dt">KnownSymbol</span> (<span class="dt">Instance1</span> <span class="dt">Binary</span> h)))</span></code></pre></div>
<p>これは<a href="https://github.com/fumieval/extensible/commit/d6e067e805f92a7c336fd4cc68042985ee13e6b8">過去に extensible 本体にあったインスタンス</a>を参考にした（今は実装されてない，理由は知らない）． 一応 <a href="https://hackage.haskell.org/package/binary-0.8.8.0/docs/Data-Binary.html#t:Binary"><code>decode . encode == id</code> という性質</a>は満たしているっぽいので大丈夫だろう．</p>
<h1 id="section"></h1>
<p>さて，例えば以上を踏まえて <code>buildPost</code> を書き換えると次のようになった（<a href="https://github.com/ChrisPenner/slick-template/blob/129b85152a481db19efc5e65e80b55a52af4a985/app/Main.hs#L100-L112">元はこんな感じ</a>）：</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="ot">buildPost ::</span> <span class="dt">FilePath</span> <span class="ot">-&gt;</span> <span class="dt">Action</span> <span class="dt">Post</span></span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a>buildPost srcPath <span class="ot">=</span> cacheAction (<span class="st">&quot;build&quot;</span><span class="ot"> ::</span> <span class="dt">T.Text</span>, srcPath) <span class="op">$</span> <span class="kw">do</span></span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a>  postContent <span class="ot">&lt;-</span> readFile&#39; srcPath</span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a>  postData    <span class="ot">&lt;-</span> markdownToHTML&#39; <span class="op">@</span>(<span class="dt">Record</span> <span class="dt">FrontMatterParams</span>) (T.pack postContent)</span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a>  <span class="kw">let</span> postUrl   <span class="ot">=</span> dropDirectory1 (srcPath <span class="op">-&lt;.&gt;</span> <span class="st">&quot;html&quot;</span>)</span>
<span id="cb4-6"><a href="#cb4-6" aria-hidden="true" tabindex="-1"></a>      postData&#39; <span class="ot">=</span> happend siteMeta <span class="op">$</span> <span class="op">#</span>url <span class="op">@=</span> postUrl <span class="op">&lt;:</span> <span class="op">#</span>date <span class="op">@=</span> <span class="st">&quot;...&quot;</span> <span class="op">&lt;:</span> postData</span>
<span id="cb4-7"><a href="#cb4-7" aria-hidden="true" tabindex="-1"></a>  template <span class="ot">&lt;-</span> compileTemplate&#39; <span class="st">&quot;site/templates/post.html&quot;</span></span>
<span id="cb4-8"><a href="#cb4-8" aria-hidden="true" tabindex="-1"></a>  writeFile&#39; (outputFolder <span class="op">&lt;/&gt;</span> postUrl) <span class="op">$</span> T.unpack (substitute template postData&#39;)</span>
<span id="cb4-9"><a href="#cb4-9" aria-hidden="true" tabindex="-1"></a>  convert postData&#39;</span></code></pre></div>
<p>日付（<code>date</code> フィールド）については後述． <code>markdownToHTML' :: FromJSON a =&gt; Text -&gt; Action a</code> は本文を Markdown から HTML に変換して型 <code>a</code> の <code>content</code> フィールドへ格納し，残りのフィールドをフロントマターとしてパースする． <code>TypeApplication</code> 言語拡張でフロントマターの型を明記してるのは，具体的な型がはっきりしていないと <code>happend</code> できないからだ． ちなみに，今回定義した <code>FrontMatterParams</code> 型はタイトルとタグとサムネイル用画像をフロントマターとして与えている．</p>
<h3 id="記事のパスから投稿日を出す">記事のパスから投稿日を出す</h3>
<p>slick-template では投稿日をフロントマターで指定していたが，このサイトでは記事のパス（<code>YYYY/MM-DD-name.md</code>）で指定していた． なので，そのような動作をするように修正する：</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="ot">buildPost ::</span> <span class="dt">FilePath</span> <span class="ot">-&gt;</span> <span class="dt">Action</span> <span class="dt">Post</span></span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a>buildPost srcPath <span class="ot">=</span> cacheAction (<span class="st">&quot;build&quot;</span><span class="ot"> ::</span> <span class="dt">T.Text</span>, srcPath) <span class="op">$</span> <span class="kw">do</span></span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a>  postContent <span class="ot">&lt;-</span> readFile&#39; srcPath</span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a>  postData    <span class="ot">&lt;-</span> markdownToHTML&#39; <span class="op">@</span>(<span class="dt">Record</span> <span class="dt">FrontMatterParams</span>) (T.pack postContent)</span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a>      <span class="co">-- YYYY/MM-DD-name.md から YYYY-MM-DD-name.html にしている </span></span>
<span id="cb5-6"><a href="#cb5-6" aria-hidden="true" tabindex="-1"></a>  <span class="kw">let</span> postUrl   <span class="ot">=</span> dropDirectory1 (takeDirectory srcPath <span class="op">&lt;&gt;</span> <span class="st">&quot;-&quot;</span> <span class="op">&lt;&gt;</span> takeFileName srcPath <span class="op">-&lt;.&gt;</span> <span class="st">&quot;html&quot;</span>)</span>
<span id="cb5-7"><a href="#cb5-7" aria-hidden="true" tabindex="-1"></a>      postData&#39; <span class="ot">=</span> happend siteMeta <span class="op">$</span> <span class="op">#</span>url <span class="op">@=</span> postUrl <span class="op">&lt;:</span> <span class="op">#</span>date <span class="op">@=</span> formatToHumanDate srcPath <span class="op">&lt;:</span> postData</span>
<span id="cb5-8"><a href="#cb5-8" aria-hidden="true" tabindex="-1"></a>  <span class="op">...</span> <span class="co">-- 割愛</span></span>
<span id="cb5-9"><a href="#cb5-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-10"><a href="#cb5-10" aria-hidden="true" tabindex="-1"></a><span class="ot">formatToHumanDate ::</span> <span class="dt">FilePath</span> <span class="ot">-&gt;</span> <span class="dt">String</span></span>
<span id="cb5-11"><a href="#cb5-11" aria-hidden="true" tabindex="-1"></a>formatToHumanDate p <span class="ot">=</span> formatTime defaultTimeLocale <span class="st">&quot;%b %e, %Y&quot;</span> parsedTime</span>
<span id="cb5-12"><a href="#cb5-12" aria-hidden="true" tabindex="-1"></a>  <span class="kw">where</span></span>
<span id="cb5-13"><a href="#cb5-13" aria-hidden="true" tabindex="-1"></a>    parsedTime <span class="ot">=</span> parseTimeOrError <span class="dt">True</span> defaultTimeLocale <span class="st">&quot;%Y-%m-%d&quot;</span> (year <span class="op">&lt;&gt;</span> <span class="st">&quot;-&quot;</span> <span class="op">&lt;&gt;</span> date)<span class="ot"> ::</span> <span class="dt">UTCTime</span></span>
<span id="cb5-14"><a href="#cb5-14" aria-hidden="true" tabindex="-1"></a>    date <span class="ot">=</span> <span class="fu">take</span> <span class="dv">5</span> <span class="op">$</span> takeFileName p</span>
<span id="cb5-15"><a href="#cb5-15" aria-hidden="true" tabindex="-1"></a>    year <span class="ot">=</span> takeFileName <span class="op">$</span> takeDirectory p</span></code></pre></div>
<p>ちなみに，このパス操作系の関数は <code>Development.Shake.FilePath</code> にあるのを利用している．</p>
<h3 id="ページネーション">ページネーション</h3>
<p>slick-template では，記事の一覧がインデックスページにズラーっといくらでも並ぶようになっている． これを10記事ぐらいずつに分けて表示できるようにする：</p>
<div class="sourceCode" id="cb6"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="ot">buildArchive ::</span> [<span class="dt">Post</span>] <span class="ot">-&gt;</span> <span class="dt">Action</span> ()</span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a>buildArchive posts <span class="ot">=</span> <span class="kw">do</span></span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a>  archiveT <span class="ot">&lt;-</span> compileTemplate&#39; <span class="st">&quot;site/templates/archive.html&quot;</span></span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a>  <span class="co">-- posts が古い順なので reverse している</span></span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a>  buildWithPagenation archiveT siteMeta (<span class="fu">reverse</span> posts) (outputFolder <span class="op">&lt;/&gt;</span> <span class="st">&quot;archive&quot;</span>)</span>
<span id="cb6-6"><a href="#cb6-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-7"><a href="#cb6-7" aria-hidden="true" tabindex="-1"></a>buildWithPagenation</span>
<span id="cb6-8"><a href="#cb6-8" aria-hidden="true" tabindex="-1"></a><span class="ot">  ::</span> <span class="dt">Forall</span> (<span class="dt">KeyTargetAre</span> <span class="dt">KnownSymbol</span> (<span class="dt">Instance1</span> <span class="dt">ToMustache</span> <span class="dt">Identity</span>)) (xs <span class="op">++</span> <span class="dt">PagenationInfoParams</span>)</span>
<span id="cb6-9"><a href="#cb6-9" aria-hidden="true" tabindex="-1"></a>  <span class="ot">=&gt;</span> <span class="dt">Template</span></span>
<span id="cb6-10"><a href="#cb6-10" aria-hidden="true" tabindex="-1"></a>  <span class="ot">-&gt;</span> (xs <span class="op">:&amp;</span> <span class="dt">Field</span> <span class="dt">Identity</span>)</span>
<span id="cb6-11"><a href="#cb6-11" aria-hidden="true" tabindex="-1"></a>  <span class="ot">-&gt;</span> [<span class="dt">Post</span>]</span>
<span id="cb6-12"><a href="#cb6-12" aria-hidden="true" tabindex="-1"></a>  <span class="ot">-&gt;</span> <span class="dt">FilePath</span></span>
<span id="cb6-13"><a href="#cb6-13" aria-hidden="true" tabindex="-1"></a>  <span class="ot">-&gt;</span> <span class="dt">Action</span> ()</span>
<span id="cb6-14"><a href="#cb6-14" aria-hidden="true" tabindex="-1"></a>buildWithPagenation t r posts dir <span class="ot">=</span> go <span class="dv">1</span> posts</span>
<span id="cb6-15"><a href="#cb6-15" aria-hidden="true" tabindex="-1"></a>  <span class="kw">where</span></span>
<span id="cb6-16"><a href="#cb6-16" aria-hidden="true" tabindex="-1"></a>    pageSize <span class="ot">=</span> <span class="dv">10</span></span>
<span id="cb6-17"><a href="#cb6-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-18"><a href="#cb6-18" aria-hidden="true" tabindex="-1"></a><span class="ot">    go ::</span> <span class="dt">Int</span> <span class="ot">-&gt;</span> [<span class="dt">Post</span>] <span class="ot">-&gt;</span> <span class="dt">Action</span> ()</span>
<span id="cb6-19"><a href="#cb6-19" aria-hidden="true" tabindex="-1"></a>    go _ [] <span class="ot">=</span> <span class="fu">pure</span> ()</span>
<span id="cb6-20"><a href="#cb6-20" aria-hidden="true" tabindex="-1"></a>    go n posts&#39; <span class="ot">=</span> <span class="kw">do</span></span>
<span id="cb6-21"><a href="#cb6-21" aria-hidden="true" tabindex="-1"></a>      <span class="kw">let</span> info <span class="ot">=</span> <span class="op">#</span>posts <span class="op">@=</span> <span class="fu">take</span> pageSize posts&#39;</span>
<span id="cb6-22"><a href="#cb6-22" aria-hidden="true" tabindex="-1"></a>              <span class="op">&lt;:</span> <span class="op">#</span>prevPageNum <span class="op">@=</span> guarded (<span class="op">&gt;</span> <span class="dv">0</span>) (n <span class="op">-</span> <span class="dv">1</span>)</span>
<span id="cb6-23"><a href="#cb6-23" aria-hidden="true" tabindex="-1"></a>              <span class="op">&lt;:</span> <span class="op">#</span>nextPageNum <span class="op">@=</span> guarded (<span class="fu">const</span> <span class="op">$</span> <span class="fu">length</span> posts&#39; <span class="op">&gt;</span> pageSize) (n <span class="op">+</span> <span class="dv">1</span>)</span>
<span id="cb6-24"><a href="#cb6-24" aria-hidden="true" tabindex="-1"></a>              <span class="op">&lt;:</span> nil</span>
<span id="cb6-25"><a href="#cb6-25" aria-hidden="true" tabindex="-1"></a>      writeFile&#39; (dir <span class="op">&lt;/&gt;</span> <span class="fu">show</span> n <span class="op">-&lt;.&gt;</span> <span class="st">&quot;html&quot;</span>) <span class="op">$</span> T.unpack (substitute t <span class="op">$</span> happend r info)</span>
<span id="cb6-26"><a href="#cb6-26" aria-hidden="true" tabindex="-1"></a>      go (n <span class="op">+</span> <span class="dv">1</span>) (<span class="fu">drop</span> pageSize posts&#39;)</span>
<span id="cb6-27"><a href="#cb6-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-28"><a href="#cb6-28" aria-hidden="true" tabindex="-1"></a><span class="ot">    guarded ::</span> (a <span class="ot">-&gt;</span> <span class="dt">Bool</span>) <span class="ot">-&gt;</span> a <span class="ot">-&gt;</span> <span class="dt">Maybe</span> a</span>
<span id="cb6-29"><a href="#cb6-29" aria-hidden="true" tabindex="-1"></a>    guarded p a <span class="ot">=</span> <span class="kw">if</span> p a <span class="kw">then</span> <span class="dt">Just</span> a <span class="kw">else</span> <span class="dt">Nothing</span></span></code></pre></div>
<p><code>buildWithPagenation</code> がページネーションしてくれる本体で，あとでタグページでも利用したいので別関数に切り出している． 単純に <code>posts</code> を分割するだけではダメで，現在と前後のページ番号をテンプレートに渡してあげる必要がある． そのために簡単な再帰処理をしている．</p>
<p>ちなみに，<code>buildWithPagenation</code> の型が仰々しいのは <code>happend</code> するメタデータを任意の extensible レコードにしたかったからだ． 型パズルに悩んだ結果，型を書かないときに <a href="https://github.com/haskell/haskell-language-server">HLS</a> がサジェストしてくれた型をそのまま書いたら通った（パズルできてないじゃん）． HLS 最高．</p>
<h3 id="タグページ">タグページ</h3>
<p>slick-template では，タグをフロントマターに記述できるようになってはいるものの，タグページはないので自作した：</p>
<div class="sourceCode" id="cb7"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="ot">buildTagPages ::</span> [<span class="dt">Post</span>] <span class="ot">-&gt;</span> <span class="dt">Action</span> [(<span class="dt">Tag</span>, <span class="dt">Int</span>)]</span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a>buildTagPages posts <span class="ot">=</span> <span class="kw">do</span></span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a>  tagT <span class="ot">&lt;-</span> compileTemplate&#39; <span class="st">&quot;site/templates/tags.html&quot;</span></span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a>  forM (groupByTag posts) <span class="op">$</span> \(tag, posts&#39;) <span class="ot">-&gt;</span> <span class="kw">do</span></span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a>    buildWithPagenation tagT (<span class="op">#</span>tag <span class="op">@=</span> tag <span class="op">&lt;:</span> siteMeta) posts&#39; (outputFolder <span class="op">&lt;/&gt;</span> <span class="st">&quot;tags&quot;</span> <span class="op">&lt;/&gt;</span> tag)</span>
<span id="cb7-6"><a href="#cb7-6" aria-hidden="true" tabindex="-1"></a>    <span class="fu">pure</span> (tag, <span class="fu">length</span> posts&#39;)</span>
<span id="cb7-7"><a href="#cb7-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-8"><a href="#cb7-8" aria-hidden="true" tabindex="-1"></a><span class="ot">groupByTag ::</span> [<span class="dt">Post</span>] <span class="ot">-&gt;</span> [(<span class="dt">Tag</span>, [<span class="dt">Post</span>])]</span>
<span id="cb7-9"><a href="#cb7-9" aria-hidden="true" tabindex="-1"></a>groupByTag <span class="ot">=</span> HML.toList <span class="op">.</span> <span class="fu">foldl</span> go <span class="fu">mempty</span></span>
<span id="cb7-10"><a href="#cb7-10" aria-hidden="true" tabindex="-1"></a>  <span class="kw">where</span></span>
<span id="cb7-11"><a href="#cb7-11" aria-hidden="true" tabindex="-1"></a><span class="ot">    go ::</span> <span class="dt">HML.HashMap</span> <span class="dt">Tag</span> [<span class="dt">Post</span>] <span class="ot">-&gt;</span> <span class="dt">Post</span> <span class="ot">-&gt;</span> <span class="dt">HML.HashMap</span> <span class="dt">Tag</span> [<span class="dt">Post</span>]</span>
<span id="cb7-12"><a href="#cb7-12" aria-hidden="true" tabindex="-1"></a>    go acc post <span class="ot">=</span></span>
<span id="cb7-13"><a href="#cb7-13" aria-hidden="true" tabindex="-1"></a>      <span class="fu">foldl</span> (\acc&#39; tag <span class="ot">-&gt;</span> HML.insertWith (<span class="op">++</span>) tag [post] acc&#39;) acc (post <span class="op">^.</span> <span class="op">#</span>tags)</span></code></pre></div>
<p>前述したとおり，こっちでも <code>buildWithPagenation</code> を使っているが，<code>siteMeta</code> の他にタグの情報もテンプレートに渡したかったので仰々しい型にしたのだ． <code>buildTagPages</code> がタグ情報を返しているのはインデックスページに <a href="https://hackage.haskell.org/package/hakyll-4.14.0.0/docs/Hakyll-Web-Tags.html#v:renderTagCloud">Hakyll のタグクラウド</a>を設定したいからだ：</p>
<div class="sourceCode" id="cb8"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="ot">buildIndex ::</span> [(<span class="dt">Tag</span>, <span class="dt">Int</span>)] <span class="ot">-&gt;</span> [<span class="dt">Post</span>] <span class="ot">-&gt;</span> <span class="dt">Action</span> ()</span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a>buildIndex tags posts <span class="ot">=</span> <span class="kw">do</span></span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a>  indexT <span class="ot">&lt;-</span> compileTemplate&#39; <span class="st">&quot;site/templates/index.html&quot;</span></span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a>  <span class="kw">let</span> indexHTML <span class="ot">=</span> T.unpack <span class="op">$</span> substitute indexT (happend siteMeta indexInfo)</span>
<span id="cb8-5"><a href="#cb8-5" aria-hidden="true" tabindex="-1"></a>  writeFile&#39; (outputFolder <span class="op">&lt;/&gt;</span> <span class="st">&quot;index.html&quot;</span>) indexHTML</span>
<span id="cb8-6"><a href="#cb8-6" aria-hidden="true" tabindex="-1"></a>  <span class="kw">where</span></span>
<span id="cb8-7"><a href="#cb8-7" aria-hidden="true" tabindex="-1"></a>    indexInfo <span class="ot">=</span> <span class="op">#</span>tags <span class="op">@=</span> tagsInfo <span class="op">&lt;:</span> <span class="op">#</span>posts <span class="op">@=</span> <span class="fu">take</span> <span class="dv">4</span> (<span class="fu">reverse</span> posts) <span class="op">&lt;:</span><span class="ot"> nil ::</span> <span class="dt">IndexInfo</span></span>
<span id="cb8-8"><a href="#cb8-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-9"><a href="#cb8-9" aria-hidden="true" tabindex="-1"></a>    tagsInfo <span class="ot">=</span> <span class="fu">map</span> (<span class="fu">uncurry</span> toTagInfo) (L.sortOn <span class="fu">fst</span> tags)</span>
<span id="cb8-10"><a href="#cb8-10" aria-hidden="true" tabindex="-1"></a>    minCnt <span class="ot">=</span> <span class="fu">maximum</span> <span class="op">$</span> <span class="fu">map</span> <span class="fu">snd</span> tags</span>
<span id="cb8-11"><a href="#cb8-11" aria-hidden="true" tabindex="-1"></a>    maxCnt <span class="ot">=</span> <span class="fu">minimum</span> <span class="op">$</span> <span class="fu">map</span> <span class="fu">snd</span> tags</span>
<span id="cb8-12"><a href="#cb8-12" aria-hidden="true" tabindex="-1"></a>    toTagInfo tag n</span>
<span id="cb8-13"><a href="#cb8-13" aria-hidden="true" tabindex="-1"></a>       <span class="ot">=</span> <span class="op">#</span>name <span class="op">@=</span> tag</span>
<span id="cb8-14"><a href="#cb8-14" aria-hidden="true" tabindex="-1"></a>      <span class="op">&lt;:</span> <span class="op">#</span>size <span class="op">@=</span> calcSize <span class="fl">120.0</span> <span class="fl">80.0</span> n minCnt maxCnt</span>
<span id="cb8-15"><a href="#cb8-15" aria-hidden="true" tabindex="-1"></a>      <span class="op">&lt;:</span> nil</span>
<span id="cb8-16"><a href="#cb8-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-17"><a href="#cb8-17" aria-hidden="true" tabindex="-1"></a><span class="ot">    calcSize ::</span> <span class="dt">Double</span> <span class="ot">-&gt;</span> <span class="dt">Double</span> <span class="ot">-&gt;</span> <span class="dt">Int</span> <span class="ot">-&gt;</span> <span class="dt">Int</span> <span class="ot">-&gt;</span> <span class="dt">Int</span> <span class="ot">-&gt;</span> <span class="dt">Int</span></span>
<span id="cb8-18"><a href="#cb8-18" aria-hidden="true" tabindex="-1"></a>    calcSize minSize maxSize cnt min&#39; max&#39; <span class="ot">=</span></span>
<span id="cb8-19"><a href="#cb8-19" aria-hidden="true" tabindex="-1"></a>      <span class="kw">let</span> diff <span class="ot">=</span> <span class="dv">1</span> <span class="op">+</span> <span class="fu">fromIntegral</span> max&#39; <span class="op">-</span> <span class="fu">fromIntegral</span> min&#39;</span>
<span id="cb8-20"><a href="#cb8-20" aria-hidden="true" tabindex="-1"></a>          relative <span class="ot">=</span> (<span class="fu">fromIntegral</span> cnt <span class="op">-</span> <span class="fu">fromIntegral</span> min&#39;) <span class="op">/</span> diff</span>
<span id="cb8-21"><a href="#cb8-21" aria-hidden="true" tabindex="-1"></a>      <span class="kw">in</span> <span class="fu">floor</span> <span class="op">$</span> minSize <span class="op">+</span> relative <span class="op">*</span> (maxSize <span class="op">-</span> minSize)</span></code></pre></div>
<p><code>tagsInfo</code> 周りの処理は Hakyll のコードを参考にして書いただけ．</p>
<h3 id="シンタックスハイライト">シンタックスハイライト</h3>
<p>slick-template では，シンタックスハイライトを自前の CSS で定義していたが，ここでは <a href="https://hackage.haskell.org/package/skylighting">skylighting パッケージ</a>のを利用していたいたのでそうする：</p>
<div class="sourceCode" id="cb9"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="ot">buildHighlightCss ::</span> <span class="dt">Action</span> ()</span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a>buildHighlightCss <span class="ot">=</span></span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a>  writeFile&#39; (outputFolder <span class="op">&lt;/&gt;</span> <span class="st">&quot;css&quot;</span> <span class="op">&lt;/&gt;</span> <span class="st">&quot;highlight.css&quot;</span>) <span class="op">$</span> styleToCss pygments</span></code></pre></div>
<h2 id="おしまい">おしまい</h2>
<p>思ったよりさくっとできた．</p>]]></content>
    </entry>
    <entry>
        <title>家計簿アプリを作る：HaskellでSQL編</title>
        <link href="https://matsubara0507.github.ioposts/2021-04-01-create-homelyapp-part1.html"/>
        <id>https://matsubara0507.github.ioposts/2021-04-01-create-homelyapp-part1.html</id>
        <updated>2021-04-01T00:00:SZ</updated>
        <category term="Haskell"/>
        <summary></summary>
        <content type="html"><![CDATA[<p>自分用に Haskell で<a href="https://github.com/matsubara0507/homelyapp">家計簿アプリ的なの</a>を作り始めました． 今回はまずバックエンドでのDBとの繋ぎの部分のメモ書きです．</p>
<h2 id="バックエンドの構成">バックエンドの構成</h2>
<ul>
<li>バックエンドには Servant を使う（今回はあまり関係ない）</li>
<li>DB には SQLite を（とりあえず）使う</li>
<li>両者のつなぎには <a href="https://hackage.haskell.org/package/persistent">Persistent</a>/<a href="https://hackage.haskell.org/package/esqueleto">Esqueleto</a> を使う</li>
</ul>
<p>Persistent はいわゆるORマッパーのようなライブラリで，型安全にDBを扱う方法を提供してくれる． しかし，<code>JOIN</code> のような SQL 特有の機能は提供しておらず，そういうのを利用するのに Esqueleto を使う．</p>
<p>個人利用なので規模的にわざわざ RDB を使う必要はないのだが，このアプリケーションは Haskell のサンドボックスも兼ねてるので，無駄にガチガチな構成を利用することにした．</p>
<h3 id="扱うデータ構造">扱うデータ構造</h3>
<p>自分用なので，まずはシンプルに出費やらを記録する「Expense」というデータ構造と，それをグループ分けする用の「Label」を用意：</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="co">-- extensible を使っています</span></span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="dt">Data.Extensible</span></span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a><span class="kw">type</span> <span class="dt">ExpendId</span> <span class="ot">=</span> <span class="dt">Int64</span></span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a><span class="kw">type</span> <span class="dt">Expense</span> <span class="ot">=</span> <span class="dt">Record</span></span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a>  &#39;[ <span class="st">&quot;amount&quot;</span>      <span class="op">&gt;:</span> <span class="dt">Int</span> <span class="co">-- 円</span></span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a>   , <span class="st">&quot;date&quot;</span>        <span class="op">&gt;:</span> <span class="dt">Day</span></span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a>   , <span class="st">&quot;description&quot;</span> <span class="op">&gt;:</span> <span class="dt">Text</span></span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a>   , <span class="st">&quot;labels&quot;</span>      <span class="op">&gt;:</span> <span class="dt">Set</span> <span class="dt">LabelId</span></span>
<span id="cb1-11"><a href="#cb1-11" aria-hidden="true" tabindex="-1"></a>   ]</span>
<span id="cb1-12"><a href="#cb1-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-13"><a href="#cb1-13" aria-hidden="true" tabindex="-1"></a><span class="kw">type</span> <span class="dt">LabelId</span> <span class="ot">=</span> <span class="dt">Int64</span></span>
<span id="cb1-14"><a href="#cb1-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-15"><a href="#cb1-15" aria-hidden="true" tabindex="-1"></a><span class="kw">type</span> <span class="dt">Label</span> <span class="ot">=</span> <span class="dt">Record</span></span>
<span id="cb1-16"><a href="#cb1-16" aria-hidden="true" tabindex="-1"></a>  &#39;[ <span class="st">&quot;name&quot;</span>        <span class="op">&gt;:</span> <span class="dt">Text</span></span>
<span id="cb1-17"><a href="#cb1-17" aria-hidden="true" tabindex="-1"></a>   , <span class="st">&quot;description&quot;</span> <span class="op">&gt;:</span> <span class="dt">Text</span></span>
<span id="cb1-18"><a href="#cb1-18" aria-hidden="true" tabindex="-1"></a>   ]</span></code></pre></div>
<h3 id="rdb側のデータ構造">RDB側のデータ構造</h3>
<p>これとは別に RDB 用のデータ構造を Persistent で定義する：</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="dt">Database.Persist.TH</span></span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a>share [mkPersist sqlSettings, mkDeleteCascade sqlSettings, mkMigrate <span class="st">&quot;migrateAll&quot;</span>] [persistLowerCase|</span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a>ExpenseData</span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a>  amount Int</span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a>  date UTCTime</span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a>  description Text</span>
<span id="cb2-8"><a href="#cb2-8" aria-hidden="true" tabindex="-1"></a>  created UTCTime default=CURRENT_TIME</span>
<span id="cb2-9"><a href="#cb2-9" aria-hidden="true" tabindex="-1"></a>  updated UTCTime default=CURRENT_TIME</span>
<span id="cb2-10"><a href="#cb2-10" aria-hidden="true" tabindex="-1"></a>  deriving Show</span>
<span id="cb2-11"><a href="#cb2-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-12"><a href="#cb2-12" aria-hidden="true" tabindex="-1"></a>LabelData</span>
<span id="cb2-13"><a href="#cb2-13" aria-hidden="true" tabindex="-1"></a>  name Text</span>
<span id="cb2-14"><a href="#cb2-14" aria-hidden="true" tabindex="-1"></a>  description Text</span>
<span id="cb2-15"><a href="#cb2-15" aria-hidden="true" tabindex="-1"></a>  deriving Show</span>
<span id="cb2-16"><a href="#cb2-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-17"><a href="#cb2-17" aria-hidden="true" tabindex="-1"></a>ExpenseLabelRel</span>
<span id="cb2-18"><a href="#cb2-18" aria-hidden="true" tabindex="-1"></a>  expenseId ExpenseDataId</span>
<span id="cb2-19"><a href="#cb2-19" aria-hidden="true" tabindex="-1"></a>  labelId LabelDataId</span>
<span id="cb2-20"><a href="#cb2-20" aria-hidden="true" tabindex="-1"></a>  deriving Show</span>
<span id="cb2-21"><a href="#cb2-21" aria-hidden="true" tabindex="-1"></a>|]</span></code></pre></div>
<p>Persistent と extensible のレコードをいい感じに Template Haskell で繋ぐ方法はよくわからないので，愚直に２つ定義するようにしている． Persistent のデータから extensible のレコードへ変換する関数を定義する：</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="ot">toEpense ::</span> <span class="dt">ExpenseData</span> <span class="ot">-&gt;</span> <span class="dt">Set</span> <span class="dt">LabelId</span> <span class="ot">-&gt;</span> <span class="dt">Expense</span></span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a>toEpense (<span class="dt">ExpenseData</span> amount date description _ _) ls</span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a>     <span class="ot">=</span> <span class="op">#</span>amount      <span class="op">@=</span> amount</span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a>    <span class="op">&lt;:</span> <span class="op">#</span>date        <span class="op">@=</span> utctDay date</span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a>    <span class="op">&lt;:</span> <span class="op">#</span>description <span class="op">@=</span> description</span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true" tabindex="-1"></a>    <span class="op">&lt;:</span> <span class="op">#</span>labels      <span class="op">@=</span> ls</span>
<span id="cb3-7"><a href="#cb3-7" aria-hidden="true" tabindex="-1"></a>    <span class="op">&lt;:</span> nil</span>
<span id="cb3-8"><a href="#cb3-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-9"><a href="#cb3-9" aria-hidden="true" tabindex="-1"></a><span class="ot">toLabel ::</span> <span class="dt">LabelData</span> <span class="ot">-&gt;</span> <span class="dt">Label</span></span>
<span id="cb3-10"><a href="#cb3-10" aria-hidden="true" tabindex="-1"></a>toLabel (<span class="dt">LabelData</span> name description)</span>
<span id="cb3-11"><a href="#cb3-11" aria-hidden="true" tabindex="-1"></a>    <span class="ot">=</span> <span class="op">#</span>name         <span class="op">@=</span> name</span>
<span id="cb3-12"><a href="#cb3-12" aria-hidden="true" tabindex="-1"></a>    <span class="op">&lt;:</span> <span class="op">#</span>description <span class="op">@=</span> description</span>
<span id="cb3-13"><a href="#cb3-13" aria-hidden="true" tabindex="-1"></a>    <span class="op">&lt;:</span> nil</span></code></pre></div>
<h2 id="db操作を定義">DB操作を定義</h2>
<p>参照・挿入・削除をとりあえず定義する．</p>
<h3 id="label-の操作">Label の操作</h3>
<p>まずは全ての <code>Label</code> を返すだけの関数を定義する：</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span>           <span class="dt">Database.Esqueleto.Experimental</span> <span class="kw">hiding</span> (set, (^.))</span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="kw">qualified</span> <span class="dt">Database.Esqueleto.Experimental</span> <span class="kw">as</span> <span class="dt">DB</span></span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="kw">qualified</span> <span class="dt">Mix.Plugin.Persist.Sqlite</span>       <span class="kw">as</span> <span class="dt">MixDB</span></span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a><span class="kw">type</span> <span class="dt">SQLitable</span> m env <span class="ot">=</span> </span>
<span id="cb4-6"><a href="#cb4-6" aria-hidden="true" tabindex="-1"></a>  (<span class="dt">MixDB.HasSqliteConfig</span> env, <span class="dt">HasLogFunc</span> env, <span class="dt">MonadReader</span> env m, <span class="dt">MonadUnliftIO</span> m)</span>
<span id="cb4-7"><a href="#cb4-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-8"><a href="#cb4-8" aria-hidden="true" tabindex="-1"></a><span class="ot">selectLabelAll ::</span> <span class="dt">SQLitable</span> m env <span class="ot">=&gt;</span> m (<span class="dt">Map</span> <span class="dt">LabelId</span> <span class="dt">Label</span>)</span>
<span id="cb4-9"><a href="#cb4-9" aria-hidden="true" tabindex="-1"></a>selectLabelAll <span class="ot">=</span> MixDB.run <span class="op">$</span> <span class="kw">do</span></span>
<span id="cb4-10"><a href="#cb4-10" aria-hidden="true" tabindex="-1"></a>  labels <span class="ot">&lt;-</span> select <span class="op">$</span> from <span class="op">$</span> <span class="dt">Table</span> <span class="op">@</span><span class="dt">LabelData</span></span>
<span id="cb4-11"><a href="#cb4-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pure</span> <span class="op">$</span> Map.fromList (liftA2 (,) (fromSqlKey <span class="op">.</span> entityKey) (toLabel <span class="op">.</span> entityVal) <span class="op">&lt;$&gt;</span> labels)</span></code></pre></div>
<p>自分は <a href="https://hackage.haskell.org/package/rio">rio</a> を愛用しており，それを拡張した <a href="https://github.com/matsubara0507/mix.hs">mix.hs</a> という自作の簡易フレームワークを利用している． そのため，基本的には <code>RIO Env a</code> という型を利用すれば，副作用のある処理（ログとか）はだいたい書けるのだが，テストがしやすいように敢えて細かい制約を記述しておく． その制約を <code>ConstraintKinds</code> 拡張を利用してエイリアスしたのが <code>SQLitable</code> だ（名前が雑）．</p>
<p>Esqueleto は現在（バージョン3.4.2），SQL の書き方を刷新している最中っぽく，新しい記法は <a href="https://hackage.haskell.org/package/esqueleto-3.4.2.0/docs/Database-Esqueleto-Experimental.html"><code>Database.Esqueleto.Experimental</code></a> で利用できる． 今まではラムダ式を利用して <code>FROM</code> の部分をこう書いていてた：</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a>select <span class="op">$</span></span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a>  from <span class="op">$</span> \people <span class="ot">-&gt;</span> <span class="kw">do</span></span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a>    where_ (people <span class="op">^.</span> <span class="dt">PersonName</span> <span class="op">==.</span> val <span class="st">&quot;John&quot;</span>)</span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a>    <span class="fu">pure</span> people</span></code></pre></div>
<p>のに対して，新しい記法では <code>TypeApplications</code> を利用してこう書く：</p>
<div class="sourceCode" id="cb6"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a>select <span class="op">$</span> <span class="kw">do</span></span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a>  people <span class="ot">&lt;-</span> from <span class="op">$</span> <span class="dt">Table</span> <span class="op">@</span><span class="dt">Person</span></span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a>  where_ (people <span class="op">^.</span> <span class="dt">PersonName</span> <span class="op">==.</span> val <span class="st">&quot;John&quot;</span>)</span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pure</span> people</span></code></pre></div>
<p>経緯などについてはあまり詳しく追ってないが<a href="https://github.com/bitemyapp/esqueleto/pull/172">このPR</a>から辿れそう．</p>
<h1 id="section"></h1>
<p><code>Label</code> の挿入，ID を指定しての参照・削除も簡単なのでさくっと定義：</p>
<div class="sourceCode" id="cb7"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="ot">findLabelById ::</span> <span class="dt">SQLitable</span> m env <span class="ot">=&gt;</span> <span class="dt">LabelId</span> <span class="ot">-&gt;</span> m (<span class="dt">Maybe</span> <span class="dt">Label</span>)</span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a>findLabelById idx <span class="ot">=</span></span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a>  MixDB.run <span class="op">$</span> <span class="fu">fmap</span> toLabel <span class="op">&lt;$&gt;</span> get (toSqlKey idx)</span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a><span class="ot">insertLabel ::</span> <span class="dt">SQLitable</span> m env <span class="ot">=&gt;</span> <span class="dt">Label</span> <span class="ot">-&gt;</span> m <span class="dt">LabelId</span></span>
<span id="cb7-6"><a href="#cb7-6" aria-hidden="true" tabindex="-1"></a>insertLabel label <span class="ot">=</span></span>
<span id="cb7-7"><a href="#cb7-7" aria-hidden="true" tabindex="-1"></a>  MixDB.run <span class="op">$</span> fromSqlKey <span class="op">&lt;$&gt;</span> insert (<span class="dt">LabelData</span> (label <span class="op">^.</span> <span class="op">#</span>name) (label <span class="op">^.</span> <span class="op">#</span>description))</span>
<span id="cb7-8"><a href="#cb7-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-9"><a href="#cb7-9" aria-hidden="true" tabindex="-1"></a><span class="ot">deleteLabelById ::</span> <span class="dt">SQLitable</span> m env <span class="ot">=&gt;</span> <span class="dt">LabelId</span> <span class="ot">-&gt;</span> m ()</span>
<span id="cb7-10"><a href="#cb7-10" aria-hidden="true" tabindex="-1"></a>deleteLabelById idx <span class="ot">=</span></span>
<span id="cb7-11"><a href="#cb7-11" aria-hidden="true" tabindex="-1"></a>  MixDB.run <span class="op">$</span> deleteKey (toSqlKey<span class="ot"> idx ::</span> <span class="dt">Key</span> <span class="dt">LabelData</span>)</span></code></pre></div>
<h3 id="expense-の操作">Expense の操作</h3>
<p>次に <code>Expense</code> の参照を定義する：</p>
<div class="sourceCode" id="cb8"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="ot">findExpenseById ::</span> <span class="dt">SQLitable</span> m env <span class="ot">=&gt;</span> <span class="dt">ExpenseId</span> <span class="ot">-&gt;</span> m (<span class="dt">Maybe</span> <span class="dt">Expense</span>)</span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a>findExpenseById idx <span class="ot">=</span> MixDB.run <span class="op">$</span> <span class="kw">do</span></span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a>  expense <span class="ot">&lt;-</span> get <span class="op">$</span> toSqlKey idx</span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a>  for expense <span class="op">$</span> \e <span class="ot">-&gt;</span> <span class="kw">do</span>  <span class="co">-- for :: Maybe a -&gt; (a -&gt; m b) -&gt; m (Maybe b)</span></span>
<span id="cb8-5"><a href="#cb8-5" aria-hidden="true" tabindex="-1"></a>    lids <span class="ot">&lt;-</span> select <span class="op">$</span> <span class="kw">do</span></span>
<span id="cb8-6"><a href="#cb8-6" aria-hidden="true" tabindex="-1"></a>      el <span class="ot">&lt;-</span> from <span class="op">$</span> <span class="dt">Table</span> <span class="op">@</span><span class="dt">ExpenseLabelRel</span></span>
<span id="cb8-7"><a href="#cb8-7" aria-hidden="true" tabindex="-1"></a>      where_ ((el <span class="op">DB.^.</span> <span class="dt">ExpenseLabelRelExpenseId</span>) <span class="op">==.</span> val (toSqlKey idx))</span>
<span id="cb8-8"><a href="#cb8-8" aria-hidden="true" tabindex="-1"></a>      <span class="fu">pure</span> (el <span class="op">DB.^.</span> <span class="dt">ExpenseLabelRelLabelId</span>)</span>
<span id="cb8-9"><a href="#cb8-9" aria-hidden="true" tabindex="-1"></a>    <span class="fu">pure</span> <span class="op">$</span> toEpense e (Set.fromList <span class="op">$</span> fromSqlKey <span class="op">.</span> unValue <span class="op">&lt;$&gt;</span> lids)</span></code></pre></div>
<p><code>Expense</code> と <code>Label</code> の関係は <code>ExpenseLabel</code> で定義しているので，それも引っ張ってくる（もっと賢い SQL があるかもだがお気になさらず）． ちなみに <code>DB.^.</code> としているのは，rio でインポートされる lens の <code>(^.)</code> とバッティングするためだ．</p>
<p>挿入時には逆に <code>ExpenseLabel</code> も一緒に挿入するようにする：</p>
<div class="sourceCode" id="cb9"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="ot">insertExpense ::</span> <span class="dt">SQLitable</span> m env <span class="ot">=&gt;</span> <span class="dt">Expense</span> <span class="ot">-&gt;</span> m <span class="dt">ExpenseId</span></span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a>insertExpense expense <span class="ot">=</span> MixDB.run <span class="op">$</span> <span class="kw">do</span></span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a>  expenseId <span class="ot">&lt;-</span> insert expenseData</span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true" tabindex="-1"></a>  insertMany_ <span class="op">$</span> <span class="dt">ExpenseLabelRel</span> expenseId <span class="op">.</span> toSqlKey <span class="op">&lt;$&gt;</span> Set.toList (expense <span class="op">^.</span> <span class="op">#</span>labels)</span>
<span id="cb9-5"><a href="#cb9-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pure</span> <span class="op">$</span> fromSqlKey expenseId</span>
<span id="cb9-6"><a href="#cb9-6" aria-hidden="true" tabindex="-1"></a>  <span class="kw">where</span></span>
<span id="cb9-7"><a href="#cb9-7" aria-hidden="true" tabindex="-1"></a>    expenseData <span class="ot">=</span> <span class="dt">ExpenseData</span></span>
<span id="cb9-8"><a href="#cb9-8" aria-hidden="true" tabindex="-1"></a>      (expense <span class="op">^.</span> <span class="op">#</span>amount)</span>
<span id="cb9-9"><a href="#cb9-9" aria-hidden="true" tabindex="-1"></a>      (<span class="dt">UTCTime</span> (expense <span class="op">^.</span> <span class="op">#</span>date) <span class="dv">0</span>)</span>
<span id="cb9-10"><a href="#cb9-10" aria-hidden="true" tabindex="-1"></a>      (expense <span class="op">^.</span> <span class="op">#</span>description)</span>
<span id="cb9-11"><a href="#cb9-11" aria-hidden="true" tabindex="-1"></a>      zeroTime <span class="co">-- default で初期化されるがなんか値を与える必要があるっぽい？</span></span>
<span id="cb9-12"><a href="#cb9-12" aria-hidden="true" tabindex="-1"></a>      zeroTime</span>
<span id="cb9-13"><a href="#cb9-13" aria-hidden="true" tabindex="-1"></a>    zeroTime <span class="ot">=</span> <span class="dt">UTCTime</span> (<span class="dt">ModifiedJulianDay</span> <span class="dv">0</span>) <span class="dv">0</span></span></code></pre></div>
<p><code>insertMany_</code> を利用することでひとつのクエリで一気に挿入をしてくれる． ちなみに，ID のリストが返ってくる <code>insertMany</code> は，SQLite の場合はひとつのクエリではなく <code>insert</code> を <code>mapM</code> しているだけなので注意．</p>
<p>もちろん，削除の場合も <code>ExpenseLabel</code> を一緒に削除する：</p>
<div class="sourceCode" id="cb10"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="ot">deleteExpenseById ::</span> <span class="dt">SQLitable</span> m env <span class="ot">=&gt;</span> <span class="dt">ExpenseId</span>  <span class="ot">-&gt;</span> m ()</span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a>deleteExpenseById idx <span class="ot">=</span></span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a>  MixDB.run <span class="op">$</span> deleteCascade (toSqlKey<span class="ot"> idx ::</span> <span class="dt">Key</span> <span class="dt">ExpenseData</span>)</span></code></pre></div>
<p><code>deleteCascade</code> を使うことで関連するデータも全て削除してくれる（<code>ON DELETE CASCADE</code>）．</p>
<p>最後に年月を指定して <code>Expense</code> を取得する関数を定義する：</p>
<div class="sourceCode" id="cb11"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a><span class="ot">selectExpensesByMonth ::</span> <span class="dt">SQLitable</span> m env <span class="ot">=&gt;</span> (<span class="dt">Integer</span>, <span class="dt">Int</span>) <span class="ot">-&gt;</span> m (<span class="dt">Map</span> <span class="dt">ExpenseId</span> <span class="dt">Expense</span>)</span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a>selectExpensesByMonth (y, m) <span class="ot">=</span></span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a>  MixDB.run <span class="op">$</span> <span class="kw">do</span></span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true" tabindex="-1"></a>    es <span class="ot">&lt;-</span> select <span class="op">$</span> <span class="kw">do</span></span>
<span id="cb11-5"><a href="#cb11-5" aria-hidden="true" tabindex="-1"></a>      e <span class="ot">&lt;-</span> from <span class="op">$</span> <span class="dt">Table</span> <span class="op">@</span><span class="dt">ExpenseData</span></span>
<span id="cb11-6"><a href="#cb11-6" aria-hidden="true" tabindex="-1"></a>      where_ (between (e <span class="op">DB.^.</span> <span class="dt">ExpenseDataDate</span>) (val startDate, val endDate))</span>
<span id="cb11-7"><a href="#cb11-7" aria-hidden="true" tabindex="-1"></a>      <span class="fu">pure</span> e</span>
<span id="cb11-8"><a href="#cb11-8" aria-hidden="true" tabindex="-1"></a>    <span class="kw">let</span> eIds <span class="ot">=</span> <span class="fu">fmap</span> entityKey es</span>
<span id="cb11-9"><a href="#cb11-9" aria-hidden="true" tabindex="-1"></a>    els <span class="ot">&lt;-</span> select <span class="op">$</span> <span class="kw">do</span></span>
<span id="cb11-10"><a href="#cb11-10" aria-hidden="true" tabindex="-1"></a>      el <span class="ot">&lt;-</span> from <span class="op">$</span> <span class="dt">Table</span> <span class="op">@</span><span class="dt">ExpenseLabelRel</span></span>
<span id="cb11-11"><a href="#cb11-11" aria-hidden="true" tabindex="-1"></a>      where_ ((el <span class="op">DB.^.</span> <span class="dt">ExpenseLabelRelExpenseId</span>) <span class="ot">`in_`</span> valList eIds)</span>
<span id="cb11-12"><a href="#cb11-12" aria-hidden="true" tabindex="-1"></a>      <span class="fu">pure</span> el</span>
<span id="cb11-13"><a href="#cb11-13" aria-hidden="true" tabindex="-1"></a>    <span class="fu">pure</span> <span class="op">$</span> Map.fromList (fromExpenseDataWith (toLabelIdsMap <span class="op">$</span> <span class="fu">fmap</span> entityVal els) <span class="op">&lt;$&gt;</span> es)</span>
<span id="cb11-14"><a href="#cb11-14" aria-hidden="true" tabindex="-1"></a>  <span class="kw">where</span></span>
<span id="cb11-15"><a href="#cb11-15" aria-hidden="true" tabindex="-1"></a>    startDay  <span class="ot">=</span> fromGregorian y m <span class="dv">1</span></span>
<span id="cb11-16"><a href="#cb11-16" aria-hidden="true" tabindex="-1"></a>    startDate <span class="ot">=</span> <span class="dt">UTCTime</span> startDay <span class="dv">0</span></span>
<span id="cb11-17"><a href="#cb11-17" aria-hidden="true" tabindex="-1"></a>    endDate   <span class="ot">=</span> addUTCTime (<span class="op">-</span><span class="dv">1</span>) <span class="op">$</span> <span class="dt">UTCTime</span> (addGregorianMonthsClip <span class="dv">1</span> startDay) <span class="dv">0</span></span>
<span id="cb11-18"><a href="#cb11-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-19"><a href="#cb11-19" aria-hidden="true" tabindex="-1"></a><span class="ot">fromExpenseDataWith ::</span> <span class="dt">Map</span> <span class="dt">ExpenseId</span> (<span class="dt">Set</span> <span class="dt">LabelId</span>) <span class="ot">-&gt;</span> <span class="dt">Entity</span> <span class="dt">ExpenseData</span> <span class="ot">-&gt;</span> (<span class="dt">ExpenseId</span>, <span class="dt">Expense</span>)</span>
<span id="cb11-20"><a href="#cb11-20" aria-hidden="true" tabindex="-1"></a>fromExpenseDataWith labelMap e <span class="ot">=</span></span>
<span id="cb11-21"><a href="#cb11-21" aria-hidden="true" tabindex="-1"></a>  ( fromSqlKey <span class="op">$</span> entityKey e</span>
<span id="cb11-22"><a href="#cb11-22" aria-hidden="true" tabindex="-1"></a>  , toEpense (entityVal e) <span class="op">$</span> fromMaybe <span class="fu">mempty</span> (Map.lookup (fromSqlKey <span class="op">$</span> entityKey e) labelMap)</span>
<span id="cb11-23"><a href="#cb11-23" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb11-24"><a href="#cb11-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-25"><a href="#cb11-25" aria-hidden="true" tabindex="-1"></a><span class="ot">toLabelIdsMap ::</span> [<span class="dt">ExpenseLabelRel</span>] <span class="ot">-&gt;</span> <span class="dt">Map</span> <span class="dt">ExpenseId</span> (<span class="dt">Set</span> <span class="dt">LabelId</span>)</span>
<span id="cb11-26"><a href="#cb11-26" aria-hidden="true" tabindex="-1"></a>toLabelIdsMap <span class="ot">=</span> </span>
<span id="cb11-27"><a href="#cb11-27" aria-hidden="true" tabindex="-1"></a>  Map.fromListWith (<span class="op">&lt;&gt;</span>) <span class="op">.</span> <span class="fu">fmap</span> (\(<span class="dt">ExpenseLabelRel</span> eid lid) <span class="ot">-&gt;</span> (fromSqlKey eid, Set.singleton <span class="op">$</span> fromSqlKey lid))</span></code></pre></div>
<p><code>IN</code> 句には1000個を超える要素は渡せないが，まぁここはとりあえずあとで直す．</p>
<h2 id="テストを書く">テストを書く</h2>
<p>テストには <a href="https://hackage.haskell.org/package/tasty">tasty</a> を利用している． テストの用の <code>Env</code> を定義する：</p>
<div class="sourceCode" id="cb12"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a><span class="kw">type</span> <span class="dt">TestEnv</span> <span class="ot">=</span> <span class="dt">Record</span></span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a>  &#39;[ <span class="st">&quot;logger&quot;</span> <span class="op">&gt;:</span> <span class="dt">LogFunc</span></span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a>   , <span class="st">&quot;sqlite&quot;</span> <span class="op">&gt;:</span> <span class="dt">MixDB.Config</span></span>
<span id="cb12-4"><a href="#cb12-4" aria-hidden="true" tabindex="-1"></a>   ]</span>
<span id="cb12-5"><a href="#cb12-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-6"><a href="#cb12-6" aria-hidden="true" tabindex="-1"></a><span class="ot">mkPlugin ::</span> <span class="dt">Text</span> <span class="ot">-&gt;</span> <span class="dt">Mix.Plugin</span> a m <span class="dt">TestEnv</span></span>
<span id="cb12-7"><a href="#cb12-7" aria-hidden="true" tabindex="-1"></a>mkPlugin path <span class="ot">=</span> hsequence</span>
<span id="cb12-8"><a href="#cb12-8" aria-hidden="true" tabindex="-1"></a>   <span class="op">$</span> <span class="op">#</span>logger <span class="op">&lt;@=&gt;</span> <span class="fu">pure</span> (mkLogFunc <span class="op">$</span> \_ _ _ _ <span class="ot">-&gt;</span> <span class="fu">pure</span> ()) <span class="co">-- NoLogging</span></span>
<span id="cb12-9"><a href="#cb12-9" aria-hidden="true" tabindex="-1"></a>  <span class="op">&lt;:</span> <span class="op">#</span>sqlite <span class="op">&lt;@=&gt;</span> MixDB.buildPluginWithoutPool path</span>
<span id="cb12-10"><a href="#cb12-10" aria-hidden="true" tabindex="-1"></a>  <span class="op">&lt;:</span> nil</span></code></pre></div>
<p>ロギングは要らないので何もしないロギングを渡しておく． ローカルの一時的なパスを指定してマイグレーションをするようにする：</p>
<div class="sourceCode" id="cb13"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span>           <span class="dt">Test.Tasty</span></span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true" tabindex="-1"></a><span class="ot">withMigrateOn ::</span> <span class="dt">MonadUnliftIO</span> m <span class="ot">=&gt;</span> <span class="dt">Text</span> <span class="ot">-&gt;</span> m <span class="dt">TestTree</span> <span class="ot">-&gt;</span> m <span class="dt">TestTree</span></span>
<span id="cb13-4"><a href="#cb13-4" aria-hidden="true" tabindex="-1"></a>withMigrateOn path spec <span class="ot">=</span></span>
<span id="cb13-5"><a href="#cb13-5" aria-hidden="true" tabindex="-1"></a>  bracket</span>
<span id="cb13-6"><a href="#cb13-6" aria-hidden="true" tabindex="-1"></a>    migrateForTest</span>
<span id="cb13-7"><a href="#cb13-7" aria-hidden="true" tabindex="-1"></a>    (\_ <span class="ot">-&gt;</span> removeFile <span class="op">$</span> Text.unpack path)</span>
<span id="cb13-8"><a href="#cb13-8" aria-hidden="true" tabindex="-1"></a>    (<span class="fu">const</span> spec)</span>
<span id="cb13-9"><a href="#cb13-9" aria-hidden="true" tabindex="-1"></a>  <span class="kw">where</span></span>
<span id="cb13-10"><a href="#cb13-10" aria-hidden="true" tabindex="-1"></a>    migrateForTest <span class="ot">=</span> <span class="kw">do</span></span>
<span id="cb13-11"><a href="#cb13-11" aria-hidden="true" tabindex="-1"></a>      createDirectoryIfMissing <span class="dt">True</span> (takeDirectory <span class="op">$</span> Text.unpack path)</span>
<span id="cb13-12"><a href="#cb13-12" aria-hidden="true" tabindex="-1"></a>      Mix.run (mkPlugin path) (MixDB.runMigrate migrateAll)</span></code></pre></div>
<p><code>bracket</code> を利用して最後には SQLite のファイルごと削除するようにした． ちなみに，Persistent の SQLite の設定には <code>:memory:</code> というオンメモリで動作するものもある． しかしこれは一つの <code>Mix.run</code> でしか共有できないため今回は使いにくい． なので，愚直に一時的なテストファイルを作成することにした．</p>
<h1 id="section-1"></h1>
<p>テスト自体はこんな感じ：</p>
<div class="sourceCode" id="cb14"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a><span class="ot">tests ::</span> <span class="dt">IO</span> <span class="dt">TestTree</span></span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a>tests <span class="ot">=</span> withMigrateOn dbPath <span class="op">$</span></span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true" tabindex="-1"></a>  testSpec <span class="st">&quot;Homely.DB&quot;</span> <span class="op">$</span> <span class="kw">do</span></span>
<span id="cb14-4"><a href="#cb14-4" aria-hidden="true" tabindex="-1"></a>    describe <span class="st">&quot;selectExpensesByMonth&quot;</span> <span class="op">$</span> <span class="kw">do</span></span>
<span id="cb14-5"><a href="#cb14-5" aria-hidden="true" tabindex="-1"></a>      context <span class="st">&quot;with label&quot;</span> <span class="op">$</span> <span class="kw">do</span></span>
<span id="cb14-6"><a href="#cb14-6" aria-hidden="true" tabindex="-1"></a>        <span class="kw">let</span> label1 <span class="ot">=</span> <span class="op">#</span>name <span class="op">@=</span> <span class="st">&quot;hoge&quot;</span> <span class="op">&lt;:</span> <span class="op">#</span>description <span class="op">@=</span> <span class="st">&quot;hogege&quot;</span> <span class="op">&lt;:</span> nil</span>
<span id="cb14-7"><a href="#cb14-7" aria-hidden="true" tabindex="-1"></a>            label2 <span class="ot">=</span> <span class="op">#</span>name <span class="op">@=</span> <span class="st">&quot;fuga&quot;</span> <span class="op">&lt;:</span> <span class="op">#</span>description <span class="op">@=</span> <span class="st">&quot;fugaga&quot;</span> <span class="op">&lt;:</span> nil</span>
<span id="cb14-8"><a href="#cb14-8" aria-hidden="true" tabindex="-1"></a>        labelIds <span class="ot">&lt;-</span> runIO <span class="op">$</span> runWithDB <span class="op">$</span> Set.fromList <span class="op">&lt;$&gt;</span> <span class="fu">mapM</span> insertLabel [label1, label2]</span>
<span id="cb14-9"><a href="#cb14-9" aria-hidden="true" tabindex="-1"></a>        <span class="kw">let</span> expect1 <span class="ot">=</span> <span class="op">#</span>amount      <span class="op">@=</span> <span class="dv">1000</span></span>
<span id="cb14-10"><a href="#cb14-10" aria-hidden="true" tabindex="-1"></a>                   <span class="op">&lt;:</span> <span class="op">#</span>date        <span class="op">@=</span> fromGregorian <span class="dv">2021</span> <span class="dv">3</span> <span class="dv">21</span></span>
<span id="cb14-11"><a href="#cb14-11" aria-hidden="true" tabindex="-1"></a>                   <span class="op">&lt;:</span> <span class="op">#</span>description <span class="op">@=</span> <span class="st">&quot;test&quot;</span></span>
<span id="cb14-12"><a href="#cb14-12" aria-hidden="true" tabindex="-1"></a>                   <span class="op">&lt;:</span> <span class="op">#</span>labels      <span class="op">@=</span> labelIds</span>
<span id="cb14-13"><a href="#cb14-13" aria-hidden="true" tabindex="-1"></a>                   <span class="op">&lt;:</span> nil</span>
<span id="cb14-14"><a href="#cb14-14" aria-hidden="true" tabindex="-1"></a>            expect2 <span class="ot">=</span> <span class="op">#</span>amount      <span class="op">@=</span> <span class="dv">3000</span></span>
<span id="cb14-15"><a href="#cb14-15" aria-hidden="true" tabindex="-1"></a>                   <span class="op">&lt;:</span> <span class="op">#</span>date        <span class="op">@=</span> fromGregorian <span class="dv">2021</span> <span class="dv">3</span> <span class="dv">22</span></span>
<span id="cb14-16"><a href="#cb14-16" aria-hidden="true" tabindex="-1"></a>                   <span class="op">&lt;:</span> <span class="op">#</span>description <span class="op">@=</span> <span class="st">&quot;test&quot;</span></span>
<span id="cb14-17"><a href="#cb14-17" aria-hidden="true" tabindex="-1"></a>                   <span class="op">&lt;:</span> <span class="op">#</span>labels      <span class="op">@=</span> Set.take <span class="dv">1</span> labelIds</span>
<span id="cb14-18"><a href="#cb14-18" aria-hidden="true" tabindex="-1"></a>                   <span class="op">&lt;:</span> nil</span>
<span id="cb14-19"><a href="#cb14-19" aria-hidden="true" tabindex="-1"></a>        actual <span class="ot">&lt;-</span> runIO <span class="op">$</span> runWithDB <span class="op">$</span> <span class="kw">do</span></span>
<span id="cb14-20"><a href="#cb14-20" aria-hidden="true" tabindex="-1"></a>          idx1 <span class="ot">&lt;-</span> insertExpense expect1</span>
<span id="cb14-21"><a href="#cb14-21" aria-hidden="true" tabindex="-1"></a>          idx2 <span class="ot">&lt;-</span> insertExpense expect2</span>
<span id="cb14-22"><a href="#cb14-22" aria-hidden="true" tabindex="-1"></a>          es <span class="ot">&lt;-</span> selectExpensesByMonth (<span class="dv">2021</span>, <span class="dv">3</span>)</span>
<span id="cb14-23"><a href="#cb14-23" aria-hidden="true" tabindex="-1"></a>          deleteExpenseById idx1</span>
<span id="cb14-24"><a href="#cb14-24" aria-hidden="true" tabindex="-1"></a>          deleteExpenseById idx2</span>
<span id="cb14-25"><a href="#cb14-25" aria-hidden="true" tabindex="-1"></a>          <span class="fu">mapM_</span> deleteLabelById <span class="op">$</span> Set.toList labelIds</span>
<span id="cb14-26"><a href="#cb14-26" aria-hidden="true" tabindex="-1"></a>          <span class="fu">pure</span> es</span>
<span id="cb14-27"><a href="#cb14-27" aria-hidden="true" tabindex="-1"></a>        it <span class="st">&quot;insert Expense&quot;</span> <span class="op">$</span></span>
<span id="cb14-28"><a href="#cb14-28" aria-hidden="true" tabindex="-1"></a>          Map.elems actual <span class="ot">`shouldBe`</span> [expect1, expect2]</span>
<span id="cb14-29"><a href="#cb14-29" aria-hidden="true" tabindex="-1"></a>  <span class="kw">where</span></span>
<span id="cb14-30"><a href="#cb14-30" aria-hidden="true" tabindex="-1"></a>    dbPath <span class="ot">=</span> <span class="st">&quot;./tmp/test.sqlite&quot;</span></span>
<span id="cb14-31"><a href="#cb14-31" aria-hidden="true" tabindex="-1"></a><span class="ot">    runWithDB ::</span> <span class="dt">RIO</span> <span class="dt">TestEnv</span> a <span class="ot">-&gt;</span> <span class="dt">IO</span> a</span>
<span id="cb14-32"><a href="#cb14-32" aria-hidden="true" tabindex="-1"></a>    runWithDB <span class="ot">=</span> Mix.run (mkPlugin dbPath)</span></code></pre></div>
<p>他のテストへ干渉しないように，一度作ったデータは毎回削除するようにしている． ここはまぁなんか良い方法がないかおいおい考えます．</p>
<h2 id="おしまい">おしまい</h2>
<p>果たしていつ完成するのやら．</p>]]></content>
    </entry>
    <entry>
        <title>Haskell のための自作 Docker イメージを GitHub Container Registry に移行する</title>
        <link href="https://matsubara0507.github.ioposts/2021-02-21-replace-haskell-docker-images-to-ghcr.html"/>
        <id>https://matsubara0507.github.ioposts/2021-02-21-replace-haskell-docker-images-to-ghcr.html</id>
        <updated>2021-02-21T00:00:SZ</updated>
        <category term="Docker"/>
        <category term="GitHub-Actions"/>
        <summary></summary>
        <content type="html"><![CDATA[<p>Haskell Stack の Docker Integration などで個人的に使う Docker イメージを自作しています． その雛形を下記のリポジトリで管理していました：</p>
<iframe width="320" height="163" scrolling="no" frameborder="0" src="https://matsubara0507.github.io/my-github-cards/?target=matsubara0507/haskell-dockerfiles" >
</iframe>
<p>これは TravisCI で Docker イメージのビルドとプッシュをし，Docker Hub にイメージを置いてあります． しかし，<a href="https://blog.travis-ci.com/2020-11-02-travis-ci-new-billing">TravisCI は料金プランが大幅改定されて OSS であっても専用のプランに申し込まないと無料で使えなくなってしまいました</a>． また，Docker Hub に関しては無料枠の場合は使われていないイメージ（確か6ヶ月プルされてないイメージ）がだんだん消されていく使用に変わりました．</p>
<p>なので，今回は TravisCI の代わりに GitHub Actions へ，Docker Hub の代わりに GitHub Container Registry へ移行することにしました．</p>
<h2 id="cicd-でやっていたこと">CI/CD でやっていたこと</h2>
<p>元々，matsubara0507/stack-build のイメージだけ定期的に更新していた． Stack の Docker Integration では，Docker のイメージタグの指定がない場合は resolver をタグの代わりにする：</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode yaml"><code class="sourceCode yaml"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="fu">resolver</span><span class="kw">:</span><span class="at"> lts-17.4</span></span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="fu">packages</span><span class="kw">:</span></span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="kw">-</span><span class="at"> .</span></span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a><span class="fu">extra-deps</span><span class="kw">:</span><span class="at"> </span><span class="kw">[]</span></span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a><span class="fu">docker</span><span class="kw">:</span></span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">repo</span><span class="kw">:</span><span class="at"> matsubara0507/stack-build</span></span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">enable</span><span class="kw">:</span><span class="at"> </span><span class="ch">false</span></span></code></pre></div>
<p>この場合，<code>stack --docker build</code> で利用するイメージは Docker Hub 上の <code>matsubara0507/stack-build:lts-17.4</code> になる． <code>docker.repo</code> にタグまで含ませた場合はタグまで含んだイメージを利用する．</p>
<p>Stack を開発している fpco が出してるイメージは resolver 毎にタグを作って Docker Hub に上げてあったので，それを真似して自分も resolver 毎にタグを作っていた． <a href="https://github.com/matsubara0507/dockwright">dockwright</a> というツールと TravisCI の定期実行を利用して Stackage に resolver が追加されるたびに自動で新しいタグを生成していた． しかし，タグだけが変わって中身は変わってないので GitHub Container Registry にするついでに，この方法を止めることにした．</p>
<h1 id="section"></h1>
<p>また，dockwright の機能を利用して Dockerfile でインストールする Haskell Stack のバージョンを自動で更新していた．</p>
<h2 id="github-actions-ですること">GitHub Actions ですること</h2>
<p>以下の2つをする</p>
<ul>
<li>PR や master の更新で Docker イメージを GitHub Container Registry にビルド・プッシュ</li>
<li>Dockerfile でインストールする Haskell Stack のバージョンを定期的に自動更新</li>
</ul>
<p>作業 PR は<a href="https://github.com/matsubara0507/haskell-dockerfiles/pull/1">こちら</a>．</p>
<h3 id="docker-イメージのビルドプッシュ">Docker イメージのビルド・プッシュ</h3>
<p>haskell-dockerfiles では以下の複数のイメージを管理していた：</p>
<ul>
<li>matsubara0507/stack-build
<ul>
<li>ビルドするときに利用する</li>
</ul></li>
<li>matsubara0507/ubuntu-for-haskell
<ul>
<li>Haskellアプリケーションを Docker イメージ化するときのベースイメージ</li>
<li>git コマンドも入った <code>git</code> タグもある</li>
</ul></li>
</ul>
<p>それぞれ別の Dockerfile で管理しているので，適当に matrix にして分けてあげる：</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode yaml"><code class="sourceCode yaml"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="fu">name</span><span class="kw">:</span><span class="at"> Build docker images</span></span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a><span class="co"># ...</span></span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a><span class="fu">jobs</span><span class="kw">:</span></span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">build</span><span class="kw">:</span></span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">name</span><span class="kw">:</span><span class="at"> Build docker images for ${{ matrix.dir }}</span></span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">runs-on</span><span class="kw">:</span><span class="at"> ubuntu-18.04</span></span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">strategy</span><span class="kw">:</span></span>
<span id="cb2-8"><a href="#cb2-8" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="fu">fail-fast</span><span class="kw">:</span><span class="at"> </span><span class="ch">false</span></span>
<span id="cb2-9"><a href="#cb2-9" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="fu">matrix</span><span class="kw">:</span></span>
<span id="cb2-10"><a href="#cb2-10" aria-hidden="true" tabindex="-1"></a><span class="at">        </span><span class="fu">dir</span><span class="kw">:</span></span>
<span id="cb2-11"><a href="#cb2-11" aria-hidden="true" tabindex="-1"></a><span class="at">        </span><span class="kw">-</span><span class="at"> </span><span class="st">&quot;stack-build&quot;</span></span>
<span id="cb2-12"><a href="#cb2-12" aria-hidden="true" tabindex="-1"></a><span class="at">        </span><span class="kw">-</span><span class="at"> </span><span class="st">&quot;ubuntu-for-haskell&quot;</span></span>
<span id="cb2-13"><a href="#cb2-13" aria-hidden="true" tabindex="-1"></a><span class="at">        </span><span class="kw">-</span><span class="at"> </span><span class="st">&quot;ubuntu-for-haskell-with-git&quot;</span></span>
<span id="cb2-14"><a href="#cb2-14" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">steps</span><span class="kw">:</span></span>
<span id="cb2-15"><a href="#cb2-15" aria-hidden="true" tabindex="-1"></a><span class="co">    # ...</span></span>
<span id="cb2-16"><a href="#cb2-16" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="kw">-</span><span class="at"> </span><span class="fu">name</span><span class="kw">:</span><span class="at"> Build and push</span></span>
<span id="cb2-17"><a href="#cb2-17" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="fu">uses</span><span class="kw">:</span><span class="at"> docker/build-push-action@v2</span></span>
<span id="cb2-18"><a href="#cb2-18" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="fu">with</span><span class="kw">:</span></span>
<span id="cb2-19"><a href="#cb2-19" aria-hidden="true" tabindex="-1"></a><span class="at">        </span><span class="fu">context</span><span class="kw">:</span><span class="at"> ${{ matrix.dir }}</span></span>
<span id="cb2-20"><a href="#cb2-20" aria-hidden="true" tabindex="-1"></a><span class="at">        </span><span class="fu">builder</span><span class="kw">:</span><span class="at"> ${{ steps.buildx.outputs.name }}</span></span>
<span id="cb2-21"><a href="#cb2-21" aria-hidden="true" tabindex="-1"></a><span class="at">        </span><span class="fu">tags</span><span class="kw">:</span><span class="co"> # 問題はココ</span></span>
<span id="cb2-22"><a href="#cb2-22" aria-hidden="true" tabindex="-1"></a><span class="at">        </span><span class="fu">push</span><span class="kw">:</span><span class="at"> ${{ github.event_name != &#39;pull_request&#39; }}</span></span></code></pre></div>
<p>問題はタグだ． <code>stack-build</code> と <code>ubuntu-for-haskell</code> はそれぞれのディレクトリ名がイメージ名で <code>latest</code> と <code>18.04</code> タグを作って欲しい． <code>ubuntu-for-haskell-with-git</code> は <code>ubuntu-for-haskell:git</code> を作って欲しい． dockwright には設定ファイルからイメージタグを生成するコマンドがあるので，それを利用する：</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode yaml"><code class="sourceCode yaml"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="co"># ubuntu-for-haskell/.dockwritht.yaml</span></span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a><span class="fu">image</span><span class="kw">:</span><span class="at"> </span><span class="st">&quot;matsubara0507/ubuntu-for-haskell&quot;</span></span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a><span class="fu">tags</span><span class="kw">:</span></span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a><span class="kw">-</span><span class="at"> </span><span class="fu">type</span><span class="kw">:</span><span class="at"> value</span></span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">keys</span><span class="kw">:</span></span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="kw">-</span><span class="at"> latest</span></span>
<span id="cb3-7"><a href="#cb3-7" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="kw">-</span><span class="at"> </span><span class="st">&quot;18.04&quot;</span></span>
<span id="cb3-8"><a href="#cb3-8" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">always</span><span class="kw">:</span><span class="at"> </span><span class="ch">true</span></span></code></pre></div>
<div class="sourceCode" id="cb4"><pre class="sourceCode yaml"><code class="sourceCode yaml"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="co"># ubuntu-for-haskell-with-git/.dockwritht.yaml</span></span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a><span class="fu">image</span><span class="kw">:</span><span class="at"> </span><span class="st">&quot;matsubara0507/ubuntu-for-haskell&quot;</span></span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a><span class="fu">tags</span><span class="kw">:</span></span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a><span class="kw">-</span><span class="at"> </span><span class="fu">type</span><span class="kw">:</span><span class="at"> value</span></span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">keys</span><span class="kw">:</span></span>
<span id="cb4-6"><a href="#cb4-6" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="kw">-</span><span class="at"> git</span></span>
<span id="cb4-7"><a href="#cb4-7" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">always</span><span class="kw">:</span><span class="at"> </span><span class="ch">true</span></span></code></pre></div>
<p>で，この設定ファイルでコマンドを実行すると：</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode sh"><code class="sourceCode bash"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="ex">$</span> dockwright ubuntu-for-haskell/.dockwright.yaml <span class="at">--new-tags</span> <span class="at">--with-name</span></span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a><span class="ex">matsubara0507/ubuntu-for-haskell:18.04</span></span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a><span class="ex">matsubara0507/ubuntu-for-haskell:latest</span></span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a><span class="ex">$</span> dockwright ubuntu-for-haskell-with-git/.dockwright.yaml <span class="at">--new-tags</span> <span class="at">--with-name</span></span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a><span class="ex">matsubara0507/ubuntu-for-haskell:git</span></span></code></pre></div>
<p>となる． あとはいい感じに GitHub Actions の output 機能へ渡してあげる：</p>
<div class="sourceCode" id="cb6"><pre class="sourceCode yaml"><code class="sourceCode yaml"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="co"># ...</span></span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">steps</span><span class="kw">:</span></span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a><span class="co">    # ...</span></span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="kw">-</span><span class="at"> </span><span class="fu">name</span><span class="kw">:</span><span class="at"> Prepare</span></span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="fu">id</span><span class="kw">:</span><span class="at"> prep</span></span>
<span id="cb6-6"><a href="#cb6-6" aria-hidden="true" tabindex="-1"></a><span class="fu">      run</span><span class="kw">: </span><span class="ch">|</span></span>
<span id="cb6-7"><a href="#cb6-7" aria-hidden="true" tabindex="-1"></a>        TAGS=$(make -s new-tags dir=${{ matrix.dir }} | xargs -ITAG printf &quot;,ghcr.io/TAG&quot;)</span>
<span id="cb6-8"><a href="#cb6-8" aria-hidden="true" tabindex="-1"></a>        echo ::set-output name=tags::${TAGS#,}</span>
<span id="cb6-9"><a href="#cb6-9" aria-hidden="true" tabindex="-1"></a><span class="co">    # ...</span></span>
<span id="cb6-10"><a href="#cb6-10" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="kw">-</span><span class="at"> </span><span class="fu">name</span><span class="kw">:</span><span class="at"> Build and push</span></span>
<span id="cb6-11"><a href="#cb6-11" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="fu">uses</span><span class="kw">:</span><span class="at"> docker/build-push-action@v2</span></span>
<span id="cb6-12"><a href="#cb6-12" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="fu">with</span><span class="kw">:</span></span>
<span id="cb6-13"><a href="#cb6-13" aria-hidden="true" tabindex="-1"></a><span class="at">        </span><span class="fu">context</span><span class="kw">:</span><span class="at"> ${{ matrix.dir }}</span></span>
<span id="cb6-14"><a href="#cb6-14" aria-hidden="true" tabindex="-1"></a><span class="at">        </span><span class="fu">builder</span><span class="kw">:</span><span class="at"> ${{ steps.buildx.outputs.name }}</span></span>
<span id="cb6-15"><a href="#cb6-15" aria-hidden="true" tabindex="-1"></a><span class="at">        </span><span class="fu">tags</span><span class="kw">:</span><span class="at"> ${{ steps.prep.outputs.tags }}</span></span>
<span id="cb6-16"><a href="#cb6-16" aria-hidden="true" tabindex="-1"></a><span class="at">        </span><span class="fu">push</span><span class="kw">:</span><span class="at"> ${{ github.event_name != &#39;pull_request&#39; }}</span></span></code></pre></div>
<p><code>make</code> は <code>dockwright</code> のコマンドを情略しているだけ． 結果をいい感じに <code>,</code> 区切りでつなげるのに手間取った．</p>
<h3 id="stack-のバージョンを定期的に自動更新">Stack のバージョンを定期的に自動更新</h3>
<p>こっちはもっと簡単． Dockerfile を生成したいのは stack-build だけなので適当に設定をして（ここは割愛），コマンドを実行するだけ：</p>
<div class="sourceCode" id="cb7"><pre class="sourceCode yaml"><code class="sourceCode yaml"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="fu">name</span><span class="kw">:</span><span class="at"> Update Dockerfile</span></span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a><span class="fu">on</span><span class="kw">:</span></span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">schedule</span><span class="kw">:</span></span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="kw">-</span><span class="at"> </span><span class="fu">cron</span><span class="kw">:</span><span class="at"> </span><span class="st">&#39;0 0 * * *&#39;</span></span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a><span class="fu">jobs</span><span class="kw">:</span></span>
<span id="cb7-6"><a href="#cb7-6" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">update</span><span class="kw">:</span></span>
<span id="cb7-7"><a href="#cb7-7" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">name</span><span class="kw">:</span><span class="at"> Update Dockerfile for ${{ matrix.dir }}</span></span>
<span id="cb7-8"><a href="#cb7-8" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">runs-on</span><span class="kw">:</span><span class="at"> ubuntu-18.04</span></span>
<span id="cb7-9"><a href="#cb7-9" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">strategy</span><span class="kw">:</span></span>
<span id="cb7-10"><a href="#cb7-10" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="fu">fail-fast</span><span class="kw">:</span><span class="at"> </span><span class="ch">false</span></span>
<span id="cb7-11"><a href="#cb7-11" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="fu">matrix</span><span class="kw">:</span></span>
<span id="cb7-12"><a href="#cb7-12" aria-hidden="true" tabindex="-1"></a><span class="at">        </span><span class="fu">dir</span><span class="kw">:</span></span>
<span id="cb7-13"><a href="#cb7-13" aria-hidden="true" tabindex="-1"></a><span class="at">        </span><span class="kw">-</span><span class="at"> stack-build</span></span>
<span id="cb7-14"><a href="#cb7-14" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">steps</span><span class="kw">:</span></span>
<span id="cb7-15"><a href="#cb7-15" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="kw">-</span><span class="at"> </span><span class="fu">uses</span><span class="kw">:</span><span class="at"> actions/checkout@v2</span></span>
<span id="cb7-16"><a href="#cb7-16" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="kw">-</span><span class="at"> </span><span class="fu">name</span><span class="kw">:</span><span class="at"> Build Dockerfile</span></span>
<span id="cb7-17"><a href="#cb7-17" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="fu">run</span><span class="kw">:</span><span class="at"> make dockerfile dir=${{ matrix.dir }}</span></span>
<span id="cb7-18"><a href="#cb7-18" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="kw">-</span><span class="at"> </span><span class="fu">name</span><span class="kw">:</span><span class="at"> Push changes</span></span>
<span id="cb7-19"><a href="#cb7-19" aria-hidden="true" tabindex="-1"></a><span class="fu">      run</span><span class="kw">: </span><span class="ch">|</span></span>
<span id="cb7-20"><a href="#cb7-20" aria-hidden="true" tabindex="-1"></a>        git config --local user.email &quot;bot@example.com&quot;</span>
<span id="cb7-21"><a href="#cb7-21" aria-hidden="true" tabindex="-1"></a>        git config --local user.name &quot;Bot&quot;</span>
<span id="cb7-22"><a href="#cb7-22" aria-hidden="true" tabindex="-1"></a>        git status</span>
<span id="cb7-23"><a href="#cb7-23" aria-hidden="true" tabindex="-1"></a>        git add -A</span>
<span id="cb7-24"><a href="#cb7-24" aria-hidden="true" tabindex="-1"></a>        git diff --staged --quiet || git commit -m &quot;[skip ci] Update Dockerfile for ${{ matrix.dir }}&quot;</span>
<span id="cb7-25"><a href="#cb7-25" aria-hidden="true" tabindex="-1"></a>        git push origin master</span></code></pre></div>
<p>GitHub Actions は自身のリポジトリへのコミットも簡単．</p>
<h2 id="github-containr-registry-へプッシュ">GitHub Containr Registry へプッシュ</h2>
<p>GitHub Actions から GitHub Container Registry へプッシュするには <code>docker/login-action</code> アクションを使うだけ：</p>
<div class="sourceCode" id="cb8"><pre class="sourceCode yaml"><code class="sourceCode yaml"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="fu">name</span><span class="kw">:</span><span class="at"> Build docker images</span></span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a><span class="co"># ...</span></span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">steps</span><span class="kw">:</span></span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a><span class="at">    ...</span></span>
<span id="cb8-5"><a href="#cb8-5" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="kw">-</span><span class="at"> </span><span class="fu">name</span><span class="kw">:</span><span class="at"> Login to GitHub Container Registry</span></span>
<span id="cb8-6"><a href="#cb8-6" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="fu">uses</span><span class="kw">:</span><span class="at"> docker/login-action@v1</span></span>
<span id="cb8-7"><a href="#cb8-7" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="fu">with</span><span class="kw">:</span></span>
<span id="cb8-8"><a href="#cb8-8" aria-hidden="true" tabindex="-1"></a><span class="at">        </span><span class="fu">registry</span><span class="kw">:</span><span class="at"> ghcr.io</span></span>
<span id="cb8-9"><a href="#cb8-9" aria-hidden="true" tabindex="-1"></a><span class="at">        </span><span class="fu">username</span><span class="kw">:</span><span class="at"> matsubara0507</span></span>
<span id="cb8-10"><a href="#cb8-10" aria-hidden="true" tabindex="-1"></a><span class="at">        </span><span class="fu">password</span><span class="kw">:</span><span class="at"> ${{ secrets.CR_PAT }}</span></span></code></pre></div>
<p>GitHub Actions にデフォルトで設定されているトークンでは GitHub Container Registry へプッシュできない． なので，個別に Personal Access Token を生成し，<code>write:packages</code> 権限を与えてシークレットに設定する必要がある．</p>
<p>実際にプッシュしたのがこちら：</p>
<ul>
<li><a href="https://github.com/users/matsubara0507/packages/container/package/stack-build">matsubara0507/stack-build</a></li>
<li><a href="https://github.com/users/matsubara0507/packages/container/package/ubuntu-for-haskell">matsubara0507/ubuntu-for-haskell</a></li>
</ul>
<p>デフォルトはプライベートになってしまうので，あとで手動でパブリックにしてあげる必要がある．</p>
<h2 id="おまけstack-で-docker-pull-できない">おまけ：stack で docker pull できない</h2>
<p>試しに Stack の Docker Integration してみたら：</p>
<div class="sourceCode" id="cb9"><pre class="sourceCode sh"><code class="sourceCode bash"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="ex">$</span> stack <span class="at">--docker</span> build</span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a><span class="ex">Pulling</span> image from registry: <span class="st">&#39;ghcr.io/matsubara0507/stack-build:18.04&#39;</span></span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a><span class="ex">fork/exec</span> /usr/local/bin/com.docker.cli: bad file descriptor</span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true" tabindex="-1"></a><span class="ex">Could</span> not pull Docker image:</span>
<span id="cb9-5"><a href="#cb9-5" aria-hidden="true" tabindex="-1"></a>    <span class="ex">ghcr.io/matsubara0507/stack-build:18.04</span></span>
<span id="cb9-6"><a href="#cb9-6" aria-hidden="true" tabindex="-1"></a><span class="ex">There</span> may not be an image on the registry for your resolver<span class="st">&#39;s LTS version in</span></span>
<span id="cb9-7"><a href="#cb9-7" aria-hidden="true" tabindex="-1"></a><span class="st">your configuration file.</span></span></code></pre></div>
<p>よくわからないが，<code>docker login</code> で事前にしてあるはずの認証結果がうまく渡せてないっぽい？？ とりあえず，先に <code>docker pull</code> しておけばそれを利用してくれるので，その方法で回避してください．</p>
<h2 id="おまけdockwright-の更新">おまけ：dockwright の更新</h2>
<p>ついでに dockwright も更新した（<a href="https://github.com/matsubara0507/dockwright/pull/4">作業PR</a>）：</p>
<ul>
<li>CI/CD を TravisCI から GitHub Actions へ移行</li>
<li>Container Registry を Docker Hub から GitHub Container Registry に移行</li>
<li>resolver を lts-14.4 から lts-17.4 にアップデート</li>
</ul>
<p>resolver が上がった結果 req パッケージと language-docker パッケージ関連で修正を入れた． req は URL の文字列を req で使えるようにパースする関数が変わり，<a href="https://hackage.haskell.org/package/modern-uri">modern-uri</a> パッケージを使うようになった：</p>
<div class="sourceCode" id="cb10"><pre class="sourceCode diff"><code class="sourceCode diff"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a>        tags &lt;- runReq defaultHttpConfig (responseBody &lt;$&gt; buildReq opts)</span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a>        MixLogger.logDebugR &quot;fetched tags with next url&quot; (#next @= (tags ^. #next) &lt;: nil)</span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a><span class="st">-       let nextOpts = fmap snd $ parseUrlHttps =&lt;&lt; Text.encodeUtf8 &lt;$&gt; tags ^. #next</span></span>
<span id="cb10-4"><a href="#cb10-4" aria-hidden="true" tabindex="-1"></a><span class="va">+       let nextOpts = fmap snd $ useHttpsURI =&lt;&lt; URI.mkURI =&lt;&lt; tags ^. #next</span></span>
<span id="cb10-5"><a href="#cb10-5" aria-hidden="true" tabindex="-1"></a>        threadDelay 100_000</span></code></pre></div>
<p>language-docker は 9.0 から Dockerfile を記述する EDSL の部分を別パッケージ <a href="https://hackage.haskell.org/package/dockerfile-creator">dockerfile-creator</a> に分かれたのでインポート先を変更した：</p>
<div class="sourceCode" id="cb11"><pre class="sourceCode diff"><code class="sourceCode diff"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a>  import           Dockwright.Fetch       (fetchEnvVal)</span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a>  import           Language.Docker        (Dockerfile)</span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a>  import qualified Language.Docker        as Docker</span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true" tabindex="-1"></a><span class="va">+ import qualified Language.Docker.EDSL   as Docker</span></span></code></pre></div>
<h2 id="おしまい">おしまい</h2>
<p>早く GitHub Actions のトークンで GitHub Container Registry にプッシュできるようになって欲しい．</p>]]></content>
    </entry>
    <entry>
        <title>hpack の設定から Bazel の設定を自動生成するツール Hazell を作った</title>
        <link href="https://matsubara0507.github.ioposts/2021-02-15-create-hazell.html"/>
        <id>https://matsubara0507.github.ioposts/2021-02-15-create-hazell.html</id>
        <updated>2021-02-15T00:00:SZ</updated>
        <category term="Haskell"/>
        <category term="Bazel"/>
        <category term="application"/>
        <summary></summary>
        <content type="html"><![CDATA[<p>趣味のアプリケーションを新しく Haskell×Elm×Bazel で実装しようと考えてます． しかし，Bazel の設定は Haskell，というか <a href="https://github.com/sol/hpack">hpack</a> の設定に比べると煩雑で面倒臭いです（重複がいくつかある）． なので，hpack から Cabal ファイルを生成するように，Bazel の設定ファイルを生成できるようにすれば楽ができるなと考えて作りました．</p>
<h2 id="完成品">完成品</h2>
<iframe width="320" height="184" scrolling="no" frameborder="0" src="https://matsubara0507.github.io/my-github-cards/?target=matsubara0507/hazell" >
</iframe>
<p>まだ途中で，現状できるのは：</p>
<ul>
<li>hpack の設定から WORKSPACE の <code>stack_snapshot</code> ルールを置き換える</li>
<li>hpack の設定から BUILD.bazel の <code>haskell_library</code> ルールを置き換える</li>
</ul>
<p>置き換えるとあるが，そもそもなければ追加する． また，すでにある WORKSPACE ファイルや BUILD.bazel に書き込むために Bazel の設定ファイルのパーサーを自作した． しかし，構文定義を読んで真面目に実装しておらず，あくまで自分のユースケースで動く程度な雑実装だ．</p>
<h2 id="作る">作る</h2>
<p>おおきく4ステップ</p>
<ol>
<li>hpack の設定から Bazel の設定を構築（Haskell のデータ型として）</li>
<li>Bazel の設定をパースして読み込む</li>
<li>Haskell関連のところだけ置き換える</li>
<li>Bazel の設定を PrettyPrint する</li>
</ol>
<h3 id="1-hpack-の設定から-bazel-の設定を構築">1. hpack の設定から Bazel の設定を構築</h3>
<p>まずは hpack の設定を読み込む． これは簡単で，hpack が hpack を利用したツールを作る用に，そういうパッケージを公開してくれている．</p>
<ul>
<li><a href="https://hackage.haskell.org/package/hpack">hpack: A modern format for Haskell packages - Hackage</a></li>
</ul>
<p>このパッケージの <code>readPackageConfig</code> を利用することで読み込める：</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="ot">main ::</span> <span class="dt">IO</span> ()</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a>main <span class="ot">=</span> <span class="kw">do</span></span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a>  <span class="kw">let</span> opts <span class="ot">=</span> Hpack.defaultDecodeOptions </span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a>  result <span class="ot">&lt;-</span> Hpack.readPackageConfig opts</span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a>  <span class="kw">case</span> result <span class="kw">of</span></span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a>    <span class="dt">Left</span> e <span class="ot">-&gt;</span> </span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a>      <span class="fu">fail</span> e</span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a>    <span class="dt">Right</span> r <span class="ot">-&gt;</span> <span class="kw">do</span></span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a>      <span class="kw">let</span> package <span class="ot">=</span> Hpack.decodeResultPackage r</span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a>      <span class="co">-- package が Hpack.Package 型の値</span></span></code></pre></div>
<p>例えば，<code>Hpack.packageDependencies package</code> で全ての依存パッケージのリストを参照したり，<code>Hpack.packageLibrary package</code> でライブラリの設定を参照したりできる．</p>
<p>次に，Bazel の設定を表現する型を定義した：</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="kw">data</span> <span class="dt">Rule</span> <span class="ot">=</span> <span class="dt">Rule</span></span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a>  {<span class="ot"> ruleName ::</span> <span class="dt">String</span> <span class="co">-- http_archive とか stack_snapshot などの Bazel ルール名</span></span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a>  ,<span class="ot"> ruleDef  ::</span> <span class="dt">String</span> <span class="co">-- load で利用する Bazel ルールの定義先</span></span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a>  ,<span class="ot"> ruleArgs ::</span> [(<span class="dt">Maybe</span> <span class="dt">String</span>, <span class="dt">RuleArg</span>)] <span class="co">-- 1つ目の要素は `name = &quot;abc&quot;` の name</span></span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a>  } <span class="kw">deriving</span> (<span class="dt">Show</span>, <span class="dt">Eq</span>)</span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a><span class="kw">data</span> <span class="dt">RuleArg</span></span>
<span id="cb2-8"><a href="#cb2-8" aria-hidden="true" tabindex="-1"></a>  <span class="ot">=</span> <span class="dt">RuleArgString</span> <span class="dt">String</span></span>
<span id="cb2-9"><a href="#cb2-9" aria-hidden="true" tabindex="-1"></a>  <span class="op">|</span> <span class="dt">RuleArgBool</span> <span class="dt">Bool</span></span>
<span id="cb2-10"><a href="#cb2-10" aria-hidden="true" tabindex="-1"></a>  <span class="op">|</span> <span class="dt">RuleArgArray</span> [<span class="dt">RuleArg</span>]</span>
<span id="cb2-11"><a href="#cb2-11" aria-hidden="true" tabindex="-1"></a>  <span class="op">|</span> <span class="dt">RuleArgConst</span> <span class="dt">String</span></span>
<span id="cb2-12"><a href="#cb2-12" aria-hidden="true" tabindex="-1"></a>  <span class="op">|</span> <span class="dt">RuleArgGlob</span> <span class="dt">String</span></span>
<span id="cb2-13"><a href="#cb2-13" aria-hidden="true" tabindex="-1"></a>  <span class="kw">deriving</span> (<span class="dt">Show</span>, <span class="dt">Eq</span>)</span></code></pre></div>
<p><code>RuleArg</code> はとりあえず今回必要になった分だけ定義した． 本当は辞書型やリストの結合式が書けたりするが，ちょっとパーサーがめんどくさいのでサボった．</p>
<p>最後に，<code>Rule</code> 型で <code>stack_snapshot</code> ルールと <code>haskell_libarary</code> ルールを <code>Hpack.Package</code> から生成する関数を定義する：</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="ot">buildStackSnapshotRule ::</span> <span class="dt">Hpack.Package</span> <span class="ot">-&gt;</span> <span class="dt">Rule</span></span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a>buildStackSnapshotRule package localSnapshot <span class="ot">=</span> <span class="dt">Rule</span> { <span class="op">..</span> }</span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a>  <span class="kw">where</span></span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a>    ruleName <span class="ot">=</span> <span class="st">&quot;stack_snapshot&quot;</span></span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a>    ruleDef <span class="ot">=</span> <span class="st">&quot;@rules_haskell//haskell:cabal.bzl&quot;</span></span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true" tabindex="-1"></a>    ruleArgs <span class="ot">=</span></span>
<span id="cb3-7"><a href="#cb3-7" aria-hidden="true" tabindex="-1"></a>      [ (<span class="dt">Just</span> <span class="st">&quot;name&quot;</span>, <span class="dt">RuleArgString</span> <span class="st">&quot;stackage&quot;</span>)</span>
<span id="cb3-8"><a href="#cb3-8" aria-hidden="true" tabindex="-1"></a>      , (<span class="dt">Just</span> <span class="st">&quot;packages&quot;</span>, <span class="dt">RuleArgArray</span> <span class="op">$</span> <span class="fu">map</span> <span class="dt">RuleArgString</span> dependencies)</span>
<span id="cb3-9"><a href="#cb3-9" aria-hidden="true" tabindex="-1"></a>      , (<span class="dt">Just</span> <span class="st">&quot;local_snapshot&quot;</span>, <span class="dt">RuleArgString</span> <span class="st">&quot;//:stack-snapshot.yaml&quot;</span>) <span class="co">-- ここの拡張性はとりあえずサボる</span></span>
<span id="cb3-10"><a href="#cb3-10" aria-hidden="true" tabindex="-1"></a>      ]</span>
<span id="cb3-11"><a href="#cb3-11" aria-hidden="true" tabindex="-1"></a>    dependencies <span class="ot">=</span></span>
<span id="cb3-12"><a href="#cb3-12" aria-hidden="true" tabindex="-1"></a>      <span class="co">-- 自分自身はあとで生成するので省く</span></span>
<span id="cb3-13"><a href="#cb3-13" aria-hidden="true" tabindex="-1"></a>      <span class="fu">filter</span> (<span class="op">/=</span> Hpack.packageName package) <span class="op">$</span> <span class="fu">map</span> <span class="fu">fst</span> (Hpack.packageDependencies package)</span>
<span id="cb3-14"><a href="#cb3-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-15"><a href="#cb3-15" aria-hidden="true" tabindex="-1"></a><span class="ot">buildHaskellLibraryRule ::</span> <span class="dt">Hpack.Package</span> <span class="ot">-&gt;</span> <span class="dt">Rule</span></span>
<span id="cb3-16"><a href="#cb3-16" aria-hidden="true" tabindex="-1"></a>buildHaskellLibraryRule package <span class="ot">=</span> <span class="dt">Rule</span> { <span class="op">..</span> }</span>
<span id="cb3-17"><a href="#cb3-17" aria-hidden="true" tabindex="-1"></a>  <span class="kw">where</span></span>
<span id="cb3-18"><a href="#cb3-18" aria-hidden="true" tabindex="-1"></a>    ruleName <span class="ot">=</span> <span class="st">&quot;haskell_library&quot;</span></span>
<span id="cb3-19"><a href="#cb3-19" aria-hidden="true" tabindex="-1"></a>    ruleDef <span class="ot">=</span> <span class="st">&quot;@rules_haskell//haskell:defs.bzl&quot;</span></span>
<span id="cb3-20"><a href="#cb3-20" aria-hidden="true" tabindex="-1"></a>    ruleArgs <span class="ot">=</span> buildRuleArgs (Hpack.packageLibrary package)</span>
<span id="cb3-21"><a href="#cb3-21" aria-hidden="true" tabindex="-1"></a>    buildRuleArgs <span class="dt">Nothing</span> <span class="ot">=</span> []</span>
<span id="cb3-22"><a href="#cb3-22" aria-hidden="true" tabindex="-1"></a>    buildRuleArgs (<span class="dt">Just</span> lib) <span class="ot">=</span></span>
<span id="cb3-23"><a href="#cb3-23" aria-hidden="true" tabindex="-1"></a>      [ (<span class="dt">Just</span> <span class="st">&quot;name&quot;</span>, <span class="dt">RuleArgString</span> <span class="op">$</span> Hpack.packageName package <span class="op">&lt;&gt;</span> <span class="st">&quot;-library&quot;</span>)</span>
<span id="cb3-24"><a href="#cb3-24" aria-hidden="true" tabindex="-1"></a>        <span class="co">-- `source-dirs` が複数あった場合はとりあえず無視</span></span>
<span id="cb3-25"><a href="#cb3-25" aria-hidden="true" tabindex="-1"></a>      , (<span class="dt">Just</span> <span class="st">&quot;src_strip_prefix&quot;</span>, <span class="dt">RuleArgString</span> <span class="op">$</span> <span class="fu">head</span> (Hpack.sectionSourceDirs lib))</span>
<span id="cb3-26"><a href="#cb3-26" aria-hidden="true" tabindex="-1"></a>      , (<span class="dt">Just</span> <span class="st">&quot;srcs&quot;</span>, <span class="dt">RuleArgGlob</span> <span class="op">$</span> <span class="fu">head</span> (Hpack.sectionSourceDirs lib) <span class="op">&lt;&gt;</span> <span class="st">&quot;/**/*.hs&quot;</span>)</span>
<span id="cb3-27"><a href="#cb3-27" aria-hidden="true" tabindex="-1"></a>      , (<span class="dt">Just</span> <span class="st">&quot;deps&quot;</span>, <span class="dt">RuleArgArray</span> <span class="op">$</span> <span class="fu">map</span> <span class="dt">RuleArgString</span> (dependencies lib))</span>
<span id="cb3-28"><a href="#cb3-28" aria-hidden="true" tabindex="-1"></a>      , (<span class="dt">Just</span> <span class="st">&quot;compiler_flags&quot;</span>, <span class="dt">RuleArgConst</span> <span class="st">&quot;GHC_FLAGS&quot;</span>) <span class="co">-- いったん定数でお茶を濁す</span></span>
<span id="cb3-29"><a href="#cb3-29" aria-hidden="true" tabindex="-1"></a>      ]</span>
<span id="cb3-30"><a href="#cb3-30" aria-hidden="true" tabindex="-1"></a>    dependencies lib <span class="ot">=</span> </span>
<span id="cb3-31"><a href="#cb3-31" aria-hidden="true" tabindex="-1"></a>      <span class="fu">map</span> (<span class="st">&quot;@stackage//:&quot;</span> <span class="op">&lt;&gt;</span>) <span class="op">$</span> Map.keys (Hpack.unDependencies <span class="op">$</span> Hpack.sectionDependencies lib)</span></code></pre></div>
<h3 id="2-bazel-の設定をパースして読み込む">2. Bazel の設定をパースして読み込む</h3>
<p>ここが大変． ざっと探した感じ，BUILD ファイルの構文定義が見つからなかったので雰囲気でパーサーを自作する． 例えば，次のようなファイルを眺めてみると：</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode py"><code class="sourceCode python"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Set all target’s visibility in this package to &quot;public&quot;.</span></span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a>package(default_visibility <span class="op">=</span> [<span class="st">&quot;//visibility:public&quot;</span>])</span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a>load(</span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a>    <span class="st">&quot;//:build/common.bzl&quot;</span>,</span>
<span id="cb4-6"><a href="#cb4-6" aria-hidden="true" tabindex="-1"></a>    <span class="st">&quot;GHC_FLAGS&quot;</span>,</span>
<span id="cb4-7"><a href="#cb4-7" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb4-8"><a href="#cb4-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-9"><a href="#cb4-9" aria-hidden="true" tabindex="-1"></a>load(</span>
<span id="cb4-10"><a href="#cb4-10" aria-hidden="true" tabindex="-1"></a>    <span class="st">&quot;@rules_haskell//haskell:defs.bzl&quot;</span>,</span>
<span id="cb4-11"><a href="#cb4-11" aria-hidden="true" tabindex="-1"></a>    <span class="st">&quot;haskell_library&quot;</span>,</span>
<span id="cb4-12"><a href="#cb4-12" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb4-13"><a href="#cb4-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-14"><a href="#cb4-14" aria-hidden="true" tabindex="-1"></a>haskell_library(</span>
<span id="cb4-15"><a href="#cb4-15" aria-hidden="true" tabindex="-1"></a>    name <span class="op">=</span> <span class="st">&quot;hazell-library&quot;</span>,</span>
<span id="cb4-16"><a href="#cb4-16" aria-hidden="true" tabindex="-1"></a>    src_strip_prefix <span class="op">=</span> <span class="st">&quot;src&quot;</span>,</span>
<span id="cb4-17"><a href="#cb4-17" aria-hidden="true" tabindex="-1"></a>    srcs <span class="op">=</span> glob([<span class="st">&quot;src/**/*.hs&quot;</span>]),</span>
<span id="cb4-18"><a href="#cb4-18" aria-hidden="true" tabindex="-1"></a>    deps <span class="op">=</span> [</span>
<span id="cb4-19"><a href="#cb4-19" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;@stackage//:base&quot;</span>,</span>
<span id="cb4-20"><a href="#cb4-20" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;@stackage//:containers&quot;</span>,</span>
<span id="cb4-21"><a href="#cb4-21" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;@stackage//:filepath&quot;</span>,</span>
<span id="cb4-22"><a href="#cb4-22" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;@stackage//:hpack&quot;</span>,</span>
<span id="cb4-23"><a href="#cb4-23" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;@stackage//:megaparsec&quot;</span>,</span>
<span id="cb4-24"><a href="#cb4-24" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;@stackage//:prettyprinter&quot;</span>,</span>
<span id="cb4-25"><a href="#cb4-25" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;@stackage//:text&quot;</span>,</span>
<span id="cb4-26"><a href="#cb4-26" aria-hidden="true" tabindex="-1"></a>    ],</span>
<span id="cb4-27"><a href="#cb4-27" aria-hidden="true" tabindex="-1"></a>    compiler_flags <span class="op">=</span> GHC_FLAGS,</span>
<span id="cb4-28"><a href="#cb4-28" aria-hidden="true" tabindex="-1"></a>)</span></code></pre></div>
<p>構成要素は：</p>
<ul>
<li>コメント</li>
<li><code>hoge(name = "fuga")</code> という関数呼び出し（省略可能な名前付き引数）</li>
</ul>
<p>ぐらいだ． なので，他にも細かい記法はあるかもしれないが，いったんこれのリストとしてパースする：</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="kw">type</span> <span class="dt">BuildFile</span> <span class="ot">=</span> [<span class="dt">BuildContent</span>]</span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a><span class="kw">data</span> <span class="dt">BuildContent</span></span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a>  <span class="ot">=</span> <span class="dt">BuildRule</span> <span class="dt">Text</span> [(<span class="dt">Maybe</span> <span class="dt">String</span>, <span class="dt">RuleArg</span>)]</span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a>  <span class="op">|</span> <span class="dt">BuildComment</span> <span class="dt">Text</span></span>
<span id="cb5-6"><a href="#cb5-6" aria-hidden="true" tabindex="-1"></a>  <span class="op">|</span> <span class="dt">BuildNewline</span> <span class="co">-- 改行も保存したいので</span></span>
<span id="cb5-7"><a href="#cb5-7" aria-hidden="true" tabindex="-1"></a>  <span class="kw">deriving</span> (<span class="dt">Show</span>, <span class="dt">Eq</span>)</span></code></pre></div>
<p>パーサーを作るには megaparsec パッケージを利用する：</p>
<ul>
<li><a href="https://hackage.haskell.org/package/megaparsec">megaparsec: Monadic parser combinators - Hackage</a></li>
</ul>
<p>一つ一つ説明すると長くなるので細かくは割愛． 工夫した点として，BUILD ファイルでの関数呼び出しや配列はいわゆるケツカンマを許容している：</p>
<div class="sourceCode" id="cb6"><pre class="sourceCode py"><code class="sourceCode python"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="co"># どちらもOK</span></span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a>[</span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a>    <span class="va">True</span>,</span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a>    <span class="va">True</span></span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a>]</span>
<span id="cb6-6"><a href="#cb6-6" aria-hidden="true" tabindex="-1"></a>[</span>
<span id="cb6-7"><a href="#cb6-7" aria-hidden="true" tabindex="-1"></a>    <span class="va">True</span>,</span>
<span id="cb6-8"><a href="#cb6-8" aria-hidden="true" tabindex="-1"></a>    <span class="va">True</span>,</span>
<span id="cb6-9"><a href="#cb6-9" aria-hidden="true" tabindex="-1"></a>]</span></code></pre></div>
<p>これを <code>sepBy</code> で実現するのは難しいので専用のコンビネーターを自作した：</p>
<div class="sourceCode" id="cb7"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="ot">sepAndEndBy ::</span> <span class="dt">MonadPlus</span> m <span class="ot">=&gt;</span> m a <span class="ot">-&gt;</span> (m sep, m end) <span class="ot">-&gt;</span> m [a]</span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a>sepAndEndBy p (sep, end) <span class="ot">=</span> go</span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a>  <span class="kw">where</span></span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a>    go <span class="ot">=</span> <span class="kw">do</span></span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a>      r <span class="ot">&lt;-</span> optional p</span>
<span id="cb7-6"><a href="#cb7-6" aria-hidden="true" tabindex="-1"></a>      <span class="kw">case</span> r <span class="kw">of</span></span>
<span id="cb7-7"><a href="#cb7-7" aria-hidden="true" tabindex="-1"></a>        <span class="dt">Nothing</span> <span class="ot">-&gt;</span> end <span class="op">$&gt;</span> []</span>
<span id="cb7-8"><a href="#cb7-8" aria-hidden="true" tabindex="-1"></a>        <span class="dt">Just</span> x <span class="ot">-&gt;</span> <span class="kw">do</span></span>
<span id="cb7-9"><a href="#cb7-9" aria-hidden="true" tabindex="-1"></a>          s <span class="ot">&lt;-</span> optional sep</span>
<span id="cb7-10"><a href="#cb7-10" aria-hidden="true" tabindex="-1"></a>          <span class="kw">case</span> s <span class="kw">of</span></span>
<span id="cb7-11"><a href="#cb7-11" aria-hidden="true" tabindex="-1"></a>            <span class="dt">Nothing</span> <span class="ot">-&gt;</span> end <span class="op">$&gt;</span> [x]</span>
<span id="cb7-12"><a href="#cb7-12" aria-hidden="true" tabindex="-1"></a>            <span class="dt">Just</span> _  <span class="ot">-&gt;</span> (x<span class="op">:</span>) <span class="op">&lt;$&gt;</span> go</span>
<span id="cb7-13"><a href="#cb7-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-14"><a href="#cb7-14" aria-hidden="true" tabindex="-1"></a><span class="co">-- 例えば配列</span></span>
<span id="cb7-15"><a href="#cb7-15" aria-hidden="true" tabindex="-1"></a><span class="ot">buildRuleArgArrayParser ::</span> <span class="dt">Parser</span> <span class="dt">RuleArg</span></span>
<span id="cb7-16"><a href="#cb7-16" aria-hidden="true" tabindex="-1"></a>buildRuleArgArrayParser <span class="ot">=</span> <span class="kw">do</span></span>
<span id="cb7-17"><a href="#cb7-17" aria-hidden="true" tabindex="-1"></a>  char <span class="ch">&#39;[&#39;</span></span>
<span id="cb7-18"><a href="#cb7-18" aria-hidden="true" tabindex="-1"></a>  space</span>
<span id="cb7-19"><a href="#cb7-19" aria-hidden="true" tabindex="-1"></a>  arr <span class="ot">&lt;-</span> buildRuleArgParser <span class="ot">`sepAndEndBy`</span> (comma, space <span class="op">&gt;&gt;</span> char <span class="ch">&#39;]&#39;</span>)</span>
<span id="cb7-20"><a href="#cb7-20" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pure</span> <span class="op">$</span> <span class="dt">RuleArgArray</span> arr</span></code></pre></div>
<p>あと，工夫というか困ったところで名前付き引数があった． いろいろ考えた結果，とりあえず泥臭い方法をとった：</p>
<div class="sourceCode" id="cb8"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="ot">buildRuleParser ::</span> <span class="dt">Parser</span> <span class="dt">BuildContent</span></span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a>buildRuleParser <span class="ot">=</span> <span class="kw">do</span></span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a>  name <span class="ot">&lt;-</span> nameParser <span class="co">-- `A-Z0-9a-z_` からなる文字列</span></span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a>  char <span class="ch">&#39;(&#39;</span></span>
<span id="cb8-5"><a href="#cb8-5" aria-hidden="true" tabindex="-1"></a>  space</span>
<span id="cb8-6"><a href="#cb8-6" aria-hidden="true" tabindex="-1"></a>  args <span class="ot">&lt;-</span> argParser <span class="ot">`sepAndEndBy`</span> (comma, space <span class="op">&gt;&gt;</span> char <span class="ch">&#39;)&#39;</span>)</span>
<span id="cb8-7"><a href="#cb8-7" aria-hidden="true" tabindex="-1"></a>  optional newline</span>
<span id="cb8-8"><a href="#cb8-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pure</span> <span class="op">$</span> <span class="dt">BuildRule</span> (Text.pack name) args</span>
<span id="cb8-9"><a href="#cb8-9" aria-hidden="true" tabindex="-1"></a>  <span class="kw">where</span></span>
<span id="cb8-10"><a href="#cb8-10" aria-hidden="true" tabindex="-1"></a>    argParser <span class="ot">=</span> buildRuleArgWithNameParser <span class="op">&lt;|&gt;</span> buildRuleArgWithoutNameParser</span>
<span id="cb8-11"><a href="#cb8-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-12"><a href="#cb8-12" aria-hidden="true" tabindex="-1"></a><span class="ot">buildRuleArgWithNameParser ::</span> <span class="dt">Parser</span> (<span class="dt">Maybe</span> <span class="dt">String</span>, <span class="dt">RuleArg</span>)</span>
<span id="cb8-13"><a href="#cb8-13" aria-hidden="true" tabindex="-1"></a>buildRuleArgWithNameParser <span class="ot">=</span> <span class="kw">do</span></span>
<span id="cb8-14"><a href="#cb8-14" aria-hidden="true" tabindex="-1"></a>  <span class="co">-- try を付けると失敗しても入力文字を消費しない（その代わり効率が悪くなる）</span></span>
<span id="cb8-15"><a href="#cb8-15" aria-hidden="true" tabindex="-1"></a>  name <span class="ot">&lt;-</span> try <span class="op">$</span> nameParser <span class="op">&lt;*</span> space <span class="op">&lt;*</span> char <span class="ch">&#39;=&#39;</span></span>
<span id="cb8-16"><a href="#cb8-16" aria-hidden="true" tabindex="-1"></a>  space</span>
<span id="cb8-17"><a href="#cb8-17" aria-hidden="true" tabindex="-1"></a>  (<span class="dt">Just</span> name,) <span class="op">&lt;$&gt;</span> buildRuleArgParser</span>
<span id="cb8-18"><a href="#cb8-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-19"><a href="#cb8-19" aria-hidden="true" tabindex="-1"></a><span class="ot">buildRuleArgWithoutNameParser ::</span> <span class="dt">Parser</span> (<span class="dt">Maybe</span> <span class="dt">String</span>, <span class="dt">RuleArg</span>)</span>
<span id="cb8-20"><a href="#cb8-20" aria-hidden="true" tabindex="-1"></a>buildRuleArgWithoutNameParser <span class="ot">=</span> (<span class="dt">Nothing</span>,) <span class="op">&lt;$&gt;</span> buildRuleArgParser</span></code></pre></div>
<p>ちゃんと実装するなら，いったん <code>nameParser</code> して，後ろに <code>=</code> があれば名前付き引数で無ければ変数かなんかとするみたいにすれば良いかしら．</p>
<h3 id="3-haskell関連のところだけ置き換える">3. Haskell関連のところだけ置き換える</h3>
<p>WORKSPACE ファイルや BUILD.bazel ファイルを読み込んで， (2) のパーサーで <code>BuildFile</code> 型の値に変換する． そのうち，<code>stack_snapshot</code> ルールや <code>haskell_libarary</code> ルールのものを検知して，(1) で生成したものに置き換える． ことを実装したのが次の関数だ：</p>
<div class="sourceCode" id="cb9"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="ot">replaceStackSnapshotRule ::</span> <span class="dt">Hpack.Package</span> <span class="ot">-&gt;</span> <span class="dt">FilePath</span> <span class="ot">-&gt;</span> <span class="dt">BuildFile</span> <span class="ot">-&gt;</span> <span class="dt">BuildFile</span></span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a>replaceStackSnapshotRule package stackSnapshotPath ws <span class="ot">=</span></span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a>  <span class="kw">if</span> <span class="fu">any</span> (<span class="ot">`isRule`</span> stackSnapshotRule) ws <span class="kw">then</span></span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true" tabindex="-1"></a>    ws <span class="op">&lt;&amp;&gt;</span> \content <span class="ot">-&gt;</span></span>
<span id="cb9-5"><a href="#cb9-5" aria-hidden="true" tabindex="-1"></a>      <span class="kw">if</span> content <span class="ot">`isRule`</span> stackSnapshotRule <span class="kw">then</span></span>
<span id="cb9-6"><a href="#cb9-6" aria-hidden="true" tabindex="-1"></a>        stackSnapshotContent</span>
<span id="cb9-7"><a href="#cb9-7" aria-hidden="true" tabindex="-1"></a>      <span class="kw">else</span></span>
<span id="cb9-8"><a href="#cb9-8" aria-hidden="true" tabindex="-1"></a>        content</span>
<span id="cb9-9"><a href="#cb9-9" aria-hidden="true" tabindex="-1"></a>  <span class="kw">else</span></span>
<span id="cb9-10"><a href="#cb9-10" aria-hidden="true" tabindex="-1"></a>    ws <span class="op">++</span> [<span class="dt">BuildNewline</span>, loadContent, <span class="dt">BuildNewline</span>, stackSnapshotContent]</span>
<span id="cb9-11"><a href="#cb9-11" aria-hidden="true" tabindex="-1"></a>  <span class="kw">where</span></span>
<span id="cb9-12"><a href="#cb9-12" aria-hidden="true" tabindex="-1"></a>    stackSnapshotRule <span class="ot">=</span> buildStackSnapshotRule package stackSnapshotPath</span>
<span id="cb9-13"><a href="#cb9-13" aria-hidden="true" tabindex="-1"></a>    (loadContent, stackSnapshotContent) <span class="ot">=</span> fromRule stackSnapshotRule</span>
<span id="cb9-14"><a href="#cb9-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-15"><a href="#cb9-15" aria-hidden="true" tabindex="-1"></a><span class="ot">isRule ::</span> <span class="dt">BuildContent</span> <span class="ot">-&gt;</span> <span class="dt">Rule</span> <span class="ot">-&gt;</span> <span class="dt">Bool</span></span>
<span id="cb9-16"><a href="#cb9-16" aria-hidden="true" tabindex="-1"></a>isRule (<span class="dt">BuildRule</span> name _) rule <span class="ot">=</span> name <span class="op">==</span> <span class="fu">pack</span> (ruleName rule)</span>
<span id="cb9-17"><a href="#cb9-17" aria-hidden="true" tabindex="-1"></a>isRule _ _                     <span class="ot">=</span> <span class="dt">False</span></span>
<span id="cb9-18"><a href="#cb9-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-19"><a href="#cb9-19" aria-hidden="true" tabindex="-1"></a><span class="ot">isStringArg ::</span> <span class="dt">RuleArg</span> <span class="ot">-&gt;</span> <span class="dt">String</span> <span class="ot">-&gt;</span> <span class="dt">Bool</span></span>
<span id="cb9-20"><a href="#cb9-20" aria-hidden="true" tabindex="-1"></a>isStringArg (<span class="dt">RuleArgString</span> str) str&#39; <span class="ot">=</span> str <span class="op">==</span> str&#39;</span>
<span id="cb9-21"><a href="#cb9-21" aria-hidden="true" tabindex="-1"></a>isStringArg _ _                      <span class="ot">=</span> <span class="dt">False</span></span>
<span id="cb9-22"><a href="#cb9-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-23"><a href="#cb9-23" aria-hidden="true" tabindex="-1"></a><span class="ot">fromRule ::</span> <span class="dt">Rule</span> <span class="ot">-&gt;</span> (<span class="dt">BuildContent</span>, <span class="dt">BuildContent</span>)</span>
<span id="cb9-24"><a href="#cb9-24" aria-hidden="true" tabindex="-1"></a>fromRule rule <span class="ot">=</span></span>
<span id="cb9-25"><a href="#cb9-25" aria-hidden="true" tabindex="-1"></a>  ( <span class="dt">BuildRule</span> <span class="st">&quot;load&quot;</span></span>
<span id="cb9-26"><a href="#cb9-26" aria-hidden="true" tabindex="-1"></a>      [ (<span class="dt">Nothing</span>, <span class="dt">RuleArgString</span> <span class="op">$</span> ruleDef rule)</span>
<span id="cb9-27"><a href="#cb9-27" aria-hidden="true" tabindex="-1"></a>      , (<span class="dt">Nothing</span>, <span class="dt">RuleArgString</span> <span class="op">$</span> ruleName rule)</span>
<span id="cb9-28"><a href="#cb9-28" aria-hidden="true" tabindex="-1"></a>      ]</span>
<span id="cb9-29"><a href="#cb9-29" aria-hidden="true" tabindex="-1"></a>  , <span class="dt">BuildRule</span> (<span class="fu">pack</span> <span class="op">$</span> ruleName rule) <span class="op">$</span> ruleArgs rule</span>
<span id="cb9-30"><a href="#cb9-30" aria-hidden="true" tabindex="-1"></a>  )</span></code></pre></div>
<p>これは <code>stack_snapshot</code> ルール版． <code>haskell_library</code> ルールの場合もほとんど同じなので割愛する．</p>
<h3 id="4-bazel-の設定を-prettyprint-する">4. Bazel の設定を PrettyPrint する</h3>
<p>最後に，(3) の結果をいい感じに出力するために PrettyPrint する． 今回はそのために prettyprinter パッケージを利用する．</p>
<ul>
<li><a href="https://hackage.haskell.org/package/prettyprinter">prettyprinter: A modern, easy to use, well-documented, extensible pretty-printer - Hackage</a></li>
</ul>
<p>任意の型の PrettyPrint の仕方を定義するには，その型の <code>Pretty</code> 型クラスインスタンスを定義すれば良い． 今回出力したいのは <code>BuildFile</code> 型もとい <code>BuildContent</code> 型の値なので，その型の <code>Pretty</code> 型クラスインスタンスを定義する：</p>
<div class="sourceCode" id="cb10"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="kw">instance</span> <span class="dt">Pretty</span> <span class="dt">BuildContent</span> <span class="kw">where</span></span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a>  pretty (<span class="dt">BuildRule</span> name args)  <span class="ot">=</span> prettyMethodCall (Text.unpack name) (<span class="fu">map</span> prettyMethodArg args)</span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a>  pretty (<span class="dt">BuildComment</span> comment) <span class="ot">=</span> <span class="st">&quot;#&quot;</span> <span class="op">&lt;&gt;</span> fromString (Text.unpack comment)</span>
<span id="cb10-4"><a href="#cb10-4" aria-hidden="true" tabindex="-1"></a>  pretty <span class="dt">BuildNewline</span>           <span class="ot">=</span> <span class="st">&quot;&quot;</span></span>
<span id="cb10-5"><a href="#cb10-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-6"><a href="#cb10-6" aria-hidden="true" tabindex="-1"></a><span class="kw">instance</span> <span class="dt">Pretty</span> <span class="dt">RuleArg</span> <span class="kw">where</span></span>
<span id="cb10-7"><a href="#cb10-7" aria-hidden="true" tabindex="-1"></a>  pretty (<span class="dt">RuleArgString</span> str)  <span class="ot">=</span> fromString (<span class="fu">show</span> str) <span class="co">-- show すると文字列の前後に `&quot;` が付く</span></span>
<span id="cb10-8"><a href="#cb10-8" aria-hidden="true" tabindex="-1"></a>  pretty (<span class="dt">RuleArgBool</span> <span class="dt">True</span>)   <span class="ot">=</span> <span class="st">&quot;True&quot;</span></span>
<span id="cb10-9"><a href="#cb10-9" aria-hidden="true" tabindex="-1"></a>  pretty (<span class="dt">RuleArgBool</span> <span class="dt">False</span>)  <span class="ot">=</span> <span class="st">&quot;False&quot;</span></span>
<span id="cb10-10"><a href="#cb10-10" aria-hidden="true" tabindex="-1"></a>  pretty (<span class="dt">RuleArgConst</span> name)  <span class="ot">=</span> fromString name</span>
<span id="cb10-11"><a href="#cb10-11" aria-hidden="true" tabindex="-1"></a>  pretty (<span class="dt">RuleArgGlob</span> path)   <span class="ot">=</span> <span class="st">&quot;glob([&quot;</span> <span class="op">&lt;&gt;</span> fromString (<span class="fu">show</span> path) <span class="op">&lt;&gt;</span> <span class="st">&quot;])&quot;</span></span>
<span id="cb10-12"><a href="#cb10-12" aria-hidden="true" tabindex="-1"></a>  <span class="co">-- 配列の要素数によって場合分け</span></span>
<span id="cb10-13"><a href="#cb10-13" aria-hidden="true" tabindex="-1"></a>  pretty (<span class="dt">RuleArgArray</span> [])    <span class="ot">=</span> <span class="st">&quot;[]&quot;</span></span>
<span id="cb10-14"><a href="#cb10-14" aria-hidden="true" tabindex="-1"></a>  pretty (<span class="dt">RuleArgArray</span> [arg]) <span class="ot">=</span> <span class="st">&quot;[&quot;</span> <span class="op">&lt;&gt;</span> pretty arg <span class="op">&lt;&gt;</span> <span class="st">&quot;]&quot;</span></span>
<span id="cb10-15"><a href="#cb10-15" aria-hidden="true" tabindex="-1"></a>  pretty (<span class="dt">RuleArgArray</span> args)  <span class="ot">=</span> vsep [nest <span class="dv">4</span> <span class="op">$</span> vsep (<span class="st">&quot;[&quot;</span> <span class="op">:</span> <span class="fu">map</span> ((<span class="op">&lt;&gt;</span> <span class="st">&quot;,&quot;</span>) <span class="op">.</span> pretty) args), <span class="st">&quot;]&quot;</span>]</span>
<span id="cb10-16"><a href="#cb10-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-17"><a href="#cb10-17" aria-hidden="true" tabindex="-1"></a><span class="co">-- 関数呼び出しの引数の個数によって場合分け</span></span>
<span id="cb10-18"><a href="#cb10-18" aria-hidden="true" tabindex="-1"></a><span class="ot">prettyMethodCall ::</span> <span class="dt">String</span> <span class="ot">-&gt;</span> [<span class="dt">Doc</span> ann] <span class="ot">-&gt;</span> <span class="dt">Doc</span> ann</span>
<span id="cb10-19"><a href="#cb10-19" aria-hidden="true" tabindex="-1"></a>prettyMethodCall name []    <span class="ot">=</span> fromString name <span class="op">&lt;&gt;</span> <span class="st">&quot;()&quot;</span></span>
<span id="cb10-20"><a href="#cb10-20" aria-hidden="true" tabindex="-1"></a>prettyMethodCall name [arg] <span class="ot">=</span> fromString name <span class="op">&lt;&gt;</span> <span class="st">&quot;(&quot;</span> <span class="op">&lt;&gt;</span> arg <span class="op">&lt;&gt;</span> <span class="st">&quot;)&quot;</span></span>
<span id="cb10-21"><a href="#cb10-21" aria-hidden="true" tabindex="-1"></a>prettyMethodCall name args  <span class="ot">=</span> vsep [nest <span class="dv">4</span> <span class="op">$</span> vsep (fromString name <span class="op">&lt;&gt;</span> <span class="st">&quot;(&quot;</span> <span class="op">:</span> <span class="fu">map</span> (<span class="op">&lt;&gt;</span> <span class="st">&quot;,&quot;</span>) args), <span class="st">&quot;)&quot;</span>]</span>
<span id="cb10-22"><a href="#cb10-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-23"><a href="#cb10-23" aria-hidden="true" tabindex="-1"></a><span class="ot">prettyMethodArg ::</span> (<span class="dt">Maybe</span> <span class="dt">String</span>, <span class="dt">RuleArg</span>) <span class="ot">-&gt;</span> <span class="dt">Doc</span> ann</span>
<span id="cb10-24"><a href="#cb10-24" aria-hidden="true" tabindex="-1"></a>prettyMethodArg (<span class="dt">Nothing</span>, val)  <span class="ot">=</span> pretty val</span>
<span id="cb10-25"><a href="#cb10-25" aria-hidden="true" tabindex="-1"></a>prettyMethodArg (<span class="dt">Just</span> key, val) <span class="ot">=</span> fromString key <span class="op">&lt;+&gt;</span> <span class="st">&quot;=&quot;</span> <span class="op">&lt;+&gt;</span> pretty val</span></code></pre></div>
<p><code>pretty</code> の構成要素は <code>Doc a</code> 型である． <code>&lt;&gt;</code> は空白無しで結合，<code>&lt;+&gt;</code> は空白有りで結合になる． <code>vsep</code> で与えた <code>Doc a</code> 型のリストを改行で結合してくれる． <code>nest 4 (vsep [...])</code> とすることで <code>vsep</code> の2要素目から4スペースでインデントしてくれる． つまり，<code>vsep [nest 4 $ vsep ["[", "True,", "True,"], "]"]</code> は次のようになる：</p>
<div class="sourceCode" id="cb11"><pre class="sourceCode py"><code class="sourceCode python"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a>[</span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a>    <span class="va">True</span>,</span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a>    <span class="va">True</span>,</span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true" tabindex="-1"></a>]</span></code></pre></div>
<p>便利ですね．</p>
<h2 id="おしまい">おしまい</h2>
<p>思いの外，さくっとできた． それよりも作りたいアプリケーションの方を作らないと笑</p>]]></content>
    </entry>
    <entry>
        <title>rules_elm を作る</title>
        <link href="https://matsubara0507.github.ioposts/2021-01-18-create-rules_elm.html"/>
        <id>https://matsubara0507.github.ioposts/2021-01-18-create-rules_elm.html</id>
        <updated>2021-01-18T00:00:SZ</updated>
        <category term="Elm"/>
        <category term="Bazel"/>
        <summary></summary>
        <content type="html"><![CDATA[<p>Elm 用の Bazel ルールがないので作ったという話です． 正確には <a href="https://github.com/EdSchouten/rules_elm">EdSchouten/rules_elm</a> がありますが，最新バージョンの 0.19.1 には対応してなかったので，対応したものを自作しました．</p>
<h2 id="作ったもの">作ったもの</h2>
<iframe width="320" height="142" scrolling="no" frameborder="0" src="https://matsubara0507.github.io/my-github-cards/?target=matsubara0507/rules_elm" >
</iframe>
<p>まず作ったのは：</p>
<ul>
<li>Elm コンパイラをインストールする（Toolchain）</li>
<li><code>elm make</code> をする Bazel ルール（<code>elm_make</code>）</li>
<li>Windows でも動作する</li>
</ul>
<p>要するに <code>elm make</code> をできるようにしただけ．</p>
<h2 id="作る">作る</h2>
<h3 id="elmコンパイラを取得する">Elmコンパイラを取得する</h3>
<p>これが結構めんどくさかった． というのも，基本的になんらかのバイナリをとってくる場合は <code>repository_ctx.download</code> を使い，ダウンロード対象が <code>zip</code> や <code>tar.gz</code> でついでに展開する場合は <code>repository_ctx.download_and_extract</code> を使う． しかし，Elm コンパイラは <code>gz</code> だけでこれは <code>repository_ctx.download_and_extract</code> で展開できない． 困った．</p>
<h2 id="section"></h2>
<p>Bazel 仲間に知恵をもらった結果，次のように <code>repository_ctx.download</code> でふつーに落としてきて <code>gzip</code> で展開するようにした（無理やり）：</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode py"><code class="sourceCode python"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> _elm_compiler_impl(ctx):</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a>    os <span class="op">=</span> ctx.attr.os</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a>    version <span class="op">=</span> ctx.attr.version</span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a>    file_name <span class="op">=</span> <span class="st">&quot;elm-</span><span class="sc">{}</span><span class="st">&quot;</span>.<span class="bu">format</span>(os)</span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a>    ctx.download(</span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a>        url <span class="op">=</span> <span class="st">&quot;https://github.com/elm/compiler/releases/download/</span><span class="sc">{}</span><span class="st">/binary-for-</span><span class="sc">{}</span><span class="st">-64-bit.gz&quot;</span>.<span class="bu">format</span>(version, os),</span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a>        sha256 <span class="op">=</span> ctx.attr.checksum,</span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a>        output <span class="op">=</span> file_name <span class="op">+</span> <span class="st">&quot;.gz&quot;</span>,</span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a>    ctx.execute([ctx.which(<span class="st">&quot;gzip&quot;</span>), <span class="st">&quot;-d&quot;</span>, file_name <span class="op">+</span> <span class="st">&quot;.gz&quot;</span>])</span>
<span id="cb1-11"><a href="#cb1-11" aria-hidden="true" tabindex="-1"></a>    ctx.execute([ctx.which(<span class="st">&quot;chmod&quot;</span>), <span class="st">&quot;+x&quot;</span>, file_name])</span>
<span id="cb1-12"><a href="#cb1-12" aria-hidden="true" tabindex="-1"></a>    ...</span></code></pre></div>
<h3 id="elm-make-をするルールを作る"><code>elm make</code> をするルールを作る</h3>
<p>こっちで大変だったのは，なんとか Windows でも動作するようにすることだった． というのも，できれば Elm プロジェクトがリポジトリのルートに無い場合でも動作するようにしたくて，この場合は生成物（<code>--output</code> の引数）や elm バイナリを絶対パスにしたい． しかし，Windows の動作も考慮するとシェルスクリプトでは絶対パスへの変換をうまく動かすことが難しい．</p>
<p>ということでいろいろ試行錯誤した結果，最終的には Python を噛ませることでお茶を濁すことにした． 下記のような Python スクリプトをテンプレートで生成し：</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode py"><code class="sourceCode python"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="co">#!/usr/bin/env python3</span></span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a><span class="co"># elm_wrapper.py ELM_PROJECT_ROOT [ARGS_FOR_ELM...]</span></span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a><span class="co">#  １引数目の ELM_PROJECT_ROOT だけ Elm プロジェクトへの相対パスで残りは elm コマンドへの引数</span></span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> os</span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> os.path</span>
<span id="cb2-8"><a href="#cb2-8" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> subprocess</span>
<span id="cb2-9"><a href="#cb2-9" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> sys</span>
<span id="cb2-10"><a href="#cb2-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-11"><a href="#cb2-11" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> run(cmd, <span class="op">*</span>args, <span class="op">**</span>kwargs):</span>
<span id="cb2-12"><a href="#cb2-12" aria-hidden="true" tabindex="-1"></a>    <span class="cf">try</span>:</span>
<span id="cb2-13"><a href="#cb2-13" aria-hidden="true" tabindex="-1"></a>        subprocess.run(cmd, check<span class="op">=</span><span class="va">True</span>, stdout<span class="op">=</span>subprocess.PIPE, stderr<span class="op">=</span>subprocess.PIPE, <span class="op">*</span>args, <span class="op">**</span>kwargs)</span>
<span id="cb2-14"><a href="#cb2-14" aria-hidden="true" tabindex="-1"></a>    <span class="cf">except</span> subprocess.CalledProcessError <span class="im">as</span> err:</span>
<span id="cb2-15"><a href="#cb2-15" aria-hidden="true" tabindex="-1"></a>        sys.stdout.<span class="bu">buffer</span>.write(err.stdout)</span>
<span id="cb2-16"><a href="#cb2-16" aria-hidden="true" tabindex="-1"></a>        sys.stderr.<span class="bu">buffer</span>.write(err.stderr)</span>
<span id="cb2-17"><a href="#cb2-17" aria-hidden="true" tabindex="-1"></a>        <span class="cf">raise</span></span>
<span id="cb2-18"><a href="#cb2-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-19"><a href="#cb2-19" aria-hidden="true" tabindex="-1"></a>elm_runtime_path <span class="op">=</span> os.path.abspath(<span class="st">&quot;path/to/elm&quot;</span>) <span class="co"># ここはテンプレート</span></span>
<span id="cb2-20"><a href="#cb2-20" aria-hidden="true" tabindex="-1"></a>elm_project_root <span class="op">=</span> sys.argv.pop(<span class="dv">1</span>)</span>
<span id="cb2-21"><a href="#cb2-21" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> i, arg <span class="kw">in</span> <span class="bu">enumerate</span>(sys.argv):</span>
<span id="cb2-22"><a href="#cb2-22" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> arg <span class="op">==</span> <span class="st">&quot;--output&quot;</span>:</span>
<span id="cb2-23"><a href="#cb2-23" aria-hidden="true" tabindex="-1"></a>        sys.argv[i<span class="op">+</span><span class="dv">1</span>] <span class="op">=</span> os.path.abspath(sys.argv[i<span class="op">+</span><span class="dv">1</span>])</span>
<span id="cb2-24"><a href="#cb2-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-25"><a href="#cb2-25" aria-hidden="true" tabindex="-1"></a><span class="co"># HOME: getAppUserDataDirectory:getEnv: does not exist (no environment variable)</span></span>
<span id="cb2-26"><a href="#cb2-26" aria-hidden="true" tabindex="-1"></a><span class="co">#  というエラーが出るので適当に定義しておく</span></span>
<span id="cb2-27"><a href="#cb2-27" aria-hidden="true" tabindex="-1"></a>os.putenv(<span class="st">&quot;HOME&quot;</span>, os.getcwd())</span>
<span id="cb2-28"><a href="#cb2-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-29"><a href="#cb2-29" aria-hidden="true" tabindex="-1"></a>os.chdir(elm_project_root)</span>
<span id="cb2-30"><a href="#cb2-30" aria-hidden="true" tabindex="-1"></a>run([elm_runtime_path] <span class="op">+</span> sys.argv[<span class="dv">1</span>:])</span></code></pre></div>
<p>これを <code>py_binary</code> で固めておいて次のように利用する：</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode py"><code class="sourceCode python"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> _elm_make_impl(ctx):</span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a>    elm_compiler <span class="op">=</span> ctx.toolchains[<span class="st">&quot;@rules_elm//elm:toolchain&quot;</span>].elm</span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a>    output_file <span class="op">=</span> ctx.actions.declare_file(ctx.attr.output)</span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a>    ctx.actions.run(</span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a>        executable <span class="op">=</span> ctx.executable._elm_wrapper,</span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true" tabindex="-1"></a>        arguments <span class="op">=</span> [</span>
<span id="cb3-7"><a href="#cb3-7" aria-hidden="true" tabindex="-1"></a>            ctx.<span class="bu">file</span>.elm_json.dirname,</span>
<span id="cb3-8"><a href="#cb3-8" aria-hidden="true" tabindex="-1"></a>            <span class="st">&quot;make&quot;</span>, ctx.attr.main, <span class="st">&quot;--output&quot;</span>, output_file.path,</span>
<span id="cb3-9"><a href="#cb3-9" aria-hidden="true" tabindex="-1"></a>        ],</span>
<span id="cb3-10"><a href="#cb3-10" aria-hidden="true" tabindex="-1"></a>        inputs <span class="op">=</span> [elm_compiler, ctx.<span class="bu">file</span>.elm_json] <span class="op">+</span> ctx.files.srcs,</span>
<span id="cb3-11"><a href="#cb3-11" aria-hidden="true" tabindex="-1"></a>        outputs <span class="op">=</span> [output_file],</span>
<span id="cb3-12"><a href="#cb3-12" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb3-13"><a href="#cb3-13" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> [DefaultInfo(files <span class="op">=</span> depset([output_file]))]</span>
<span id="cb3-14"><a href="#cb3-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-15"><a href="#cb3-15" aria-hidden="true" tabindex="-1"></a>elm_make <span class="op">=</span> rule(</span>
<span id="cb3-16"><a href="#cb3-16" aria-hidden="true" tabindex="-1"></a>    _elm_make_impl,</span>
<span id="cb3-17"><a href="#cb3-17" aria-hidden="true" tabindex="-1"></a>    attrs <span class="op">=</span> {</span>
<span id="cb3-18"><a href="#cb3-18" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;srcs&quot;</span>: attr.label_list(allow_files <span class="op">=</span> <span class="va">True</span>),</span>
<span id="cb3-19"><a href="#cb3-19" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;elm_json&quot;</span>: attr.label(mandatory <span class="op">=</span> <span class="va">True</span>, allow_single_file <span class="op">=</span> <span class="va">True</span>),</span>
<span id="cb3-20"><a href="#cb3-20" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;main&quot;</span>: attr.string(default <span class="op">=</span> <span class="st">&quot;src/Main.elm&quot;</span>),</span>
<span id="cb3-21"><a href="#cb3-21" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;output&quot;</span>: attr.string(default <span class="op">=</span> <span class="st">&quot;index.html&quot;</span>),</span>
<span id="cb3-22"><a href="#cb3-22" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;_elm_wrapper&quot;</span>: attr.label(</span>
<span id="cb3-23"><a href="#cb3-23" aria-hidden="true" tabindex="-1"></a>            executable <span class="op">=</span> <span class="va">True</span>,</span>
<span id="cb3-24"><a href="#cb3-24" aria-hidden="true" tabindex="-1"></a>            cfg <span class="op">=</span> <span class="st">&quot;host&quot;</span>,</span>
<span id="cb3-25"><a href="#cb3-25" aria-hidden="true" tabindex="-1"></a>            default <span class="op">=</span> Label(<span class="st">&quot;@rules_elm//elm:elm_wrapper&quot;</span>), <span class="co"># py_binary で固めたやつ</span></span>
<span id="cb3-26"><a href="#cb3-26" aria-hidden="true" tabindex="-1"></a>        ),</span>
<span id="cb3-27"><a href="#cb3-27" aria-hidden="true" tabindex="-1"></a>    },</span>
<span id="cb3-28"><a href="#cb3-28" aria-hidden="true" tabindex="-1"></a>    toolchains <span class="op">=</span> [</span>
<span id="cb3-29"><a href="#cb3-29" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;@rules_elm//elm:toolchain&quot;</span>,</span>
<span id="cb3-30"><a href="#cb3-30" aria-hidden="true" tabindex="-1"></a>    ]</span>
<span id="cb3-31"><a href="#cb3-31" aria-hidden="true" tabindex="-1"></a>)</span></code></pre></div>
<p>この方法は <code>tweag/rules_haskell</code> の cabal コマンド関連でも同様のことをしている（目的が同じかはわからないが参考にした）．</p>
<h2 id="使う">使う</h2>
<p>試しに使った：</p>
<ul>
<li><a href="https://github.com/matsubara0507/mixlogue/pull/7">Add Bazel by matsubara0507 · #7 · matsubara0507/mixlogue</a></li>
</ul>
<p>mixlogue は Haskell + Elm の簡単なプログラム． この PR では Haskell のビルドも Bazel にしている．</p>
<h2 id="課題">課題</h2>
<ol>
<li>依存パッケージを Bazel で管理していないので毎回依存パッケージのインストールからする</li>
<li>もっと Toolchain を活用する</li>
</ol>
<p>(1)は単純な話． 普通 Bazel は依存パッケージを明示的に記述することで，無駄に依存パッケージを何回もインストールしようとするのを防ぐ方法をとる． しかし，<code>elm_make</code> は雑に作ったので毎回インストールしちゃうっていう．</p>
<p>(2)は，Toolchain の <code>action</code> なんかに <code>elm</code> コマンドの振る舞いを突っ込んだ方がかっこいいかなーっていうだけ．</p>
<p>次回，頑張る．</p>
<h2 id="おしまい">おしまい</h2>]]></content>
    </entry>
    <entry>
        <title>rules_haskell でパッケージの依存関係がうまく解決できない時</title>
        <link href="https://matsubara0507.github.ioposts/2021-01-01-missing-dependencies-with-rules_haskell.html"/>
        <id>https://matsubara0507.github.ioposts/2021-01-01-missing-dependencies-with-rules_haskell.html</id>
        <updated>2021-01-01T00:00:SZ</updated>
        <category term="Haskell"/>
        <category term="Bazel"/>
        <summary></summary>
        <content type="html"><![CDATA[<p>ちょっとした rules_haskell で起きたエラーに関するメモ書きです（Bazel の話）．</p>
<h2 id="起きたエラー">起きたエラー</h2>
<p>具体的には「<a href="/posts/2021-01-01-mdium-with-gist.html">MarkdownをMediumへポストするときにコードブロックをGistのリンクにする</a>」をやっていたときに起きたエラー：</p>
<pre><code>$ bazel build //:mdium
...
ERROR: /.../external/stackage/BUILD.bazel:1277:22: HaskellCabalLibrary @stackage//:hslua failed (Exit 1) cabal_wrapper failed: error executing command bazel-out/host/bin/external/rules_haskell/haskell/cabal_wrapper lib:hslua hslua-1.3.0 true external/stackage/hslua-1.3.0/Setup.hs external/stackage/hslua-1.3.0 ... (remaining 9 argument(s) skipped)

Use --sandbox_debug to see verbose messages from the sandbox
Setup.hs: Encountered missing dependencies:
base-compat &gt;=0.10
...</code></pre>
<p>base-compat はバージョン 0.11.2 が入ってるはずなので，この依存関係は満たしているはずなのに...？？？</p>
<h2 id="原因">原因</h2>
<p>hslua-1.3.0 の Cabal ファイルを読んでたら気づいた：</p>
<pre class="cabal"><code>  if impl(ghc &lt; 8.8)
    build-depends:       base-compat          &gt;= 0.10
    hs-source-dirs:      prelude
    other-modules:       Prelude</code></pre>
<p><code>if impl(ghc &lt; 8.8)</code> の部分． もしかして，Bazel の依存パッケージを解決してるときにこの分岐がうまくいってない？つまり GHC のバージョンが間違ってる？</p>
<p>正解でした．</p>
<h2 id="対処">対処</h2>
<p>GHC のバージョンは rules_haskell の <code>rules_haskell_toolchains</code> の <code>version</code> 引数で指定できる． 指定しない場合は デフォルトで 8.6.5 が利用される． 決して，<code>stack_snapshot</code> で指定した LTS から自動で解決されない（はず）． 僕はこの仕様をすっかり忘れており，LTS では GHC 8.8 系を利用しているのに GHC 8.6 でビルドをしていた． 結果として，依存パッケージの解決がめちゃくちゃになっていたのだ．</p>
<p>対処法は簡単で，<code>rules_haskell_toolchains</code> で <code>version</code> を指定すれば良い：</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode py"><code class="sourceCode python"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a>http_archive(</span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a>    name <span class="op">=</span> <span class="st">&quot;rules_haskell&quot;</span>,</span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a>    strip_prefix <span class="op">=</span> <span class="st">&quot;rules_haskell-3b8182ca5287cf93687fff1cefd98910f683b679&quot;</span>,</span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a>    urls <span class="op">=</span> [<span class="st">&quot;https://github.com/tweag/rules_haskell/archive/3b8182ca5287cf93687fff1cefd98910f683b679.tar.gz&quot;</span>],</span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a>    sha256 <span class="op">=</span> <span class="st">&quot;85f269adfecfc5760fae6017608f7efebfccb719c22c7e71af03c4887f54b08e&quot;</span>,</span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb3-7"><a href="#cb3-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-8"><a href="#cb3-8" aria-hidden="true" tabindex="-1"></a>load(</span>
<span id="cb3-9"><a href="#cb3-9" aria-hidden="true" tabindex="-1"></a>    <span class="st">&quot;@rules_haskell//haskell:toolchain.bzl&quot;</span>,</span>
<span id="cb3-10"><a href="#cb3-10" aria-hidden="true" tabindex="-1"></a>    <span class="st">&quot;rules_haskell_toolchains&quot;</span>,</span>
<span id="cb3-11"><a href="#cb3-11" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb3-12"><a href="#cb3-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-13"><a href="#cb3-13" aria-hidden="true" tabindex="-1"></a>rules_haskell_toolchains(version <span class="op">=</span> <span class="st">&quot;8.8.4&quot;</span>)</span></code></pre></div>
<p>ちなみに，rules_haskell の現在の最新のバージョンタグである v0.13 を使わずに，直接最新のコミットハッシュを指定しているのは，v0.13 では LTS で利用している 8.8.4 が無いからだ．</p>
<h2 id="おしまい">おしまい</h2>
<p>本当にちょっとしたことだけど念のため記事にしておいた． rules_haskell が流行ったあかつきにはきっと助かる人が出るはず笑</p>]]></content>
    </entry>
    <entry>
        <title>MarkdownをMediumへポストするときにコードブロックをGistのリンクにする</title>
        <link href="https://matsubara0507.github.ioposts/2021-01-01-mdium-with-gist.html"/>
        <id>https://matsubara0507.github.ioposts/2021-01-01-mdium-with-gist.html</id>
        <updated>2021-01-01T00:00:SZ</updated>
        <category term="Haskell"/>
        <category term="application"/>
        <summary></summary>
        <content type="html"><![CDATA[<p>「<a href="/posts/2018-11-04-create-mdium.html">Markdownで書いたテキストをMediumへポストする(mdium)</a>」で作った Markdown で書いたテキストを Medium へポストするツールですが，ちょくちょく改良を続けてます． 今回は Pandoc を利用して、コードブロックを Gist のリンクに置き換える機能を追加したので，そのことについてのメモ書きです．</p>
<h2 id="medium-のシンタックスハイライト">Medium のシンタックスハイライト</h2>
<p>Medium は普通にコードブロックを記述するとシンタックハイライトされずダサい：</p>
<p><img src="/assets/mdium-with-gist/medium-code-block.jpg" /></p>
<p>これをなんとかする方法の一つに Gist のリンクを貼って埋め込みにするというのがある：</p>
<p><img src="/assets/mdium-with-gist/medium-code-block-using-gist.jpg" /></p>
<p>ただし，一つの Gist に一つのファイルを設定しないといけないのでコスパが最悪で，1つの記事に対してこんな感じに大量の Gist を作る必要がある：</p>
<p><img src="/assets/mdium-with-gist/many-gists-for-medium.jpg" /></p>
<p>最近はその Gist を使った方法をとっているが，いちいち Gist に手で置き換えるのはめんどいよね． ってことで，自作ツールの mdium が自動でやってくれるようにした．</p>
<h2 id="作る">作る</h2>
<p>作業 PR はこれです：</p>
<ul>
<li><a href="https://github.com/matsubara0507/mdium/pull/9">Add gist option · #9 · matsubara0507/mdium</a></li>
</ul>
<h3 id="gist-を作成する-api">Gist を作成する API</h3>
<p><a href="https://docs.github.com/rest/reference/gists#create-a-gist">GitHub API には Gist を作成するものがある</a>． しかし，私がよく使う <a href="https://hackage.haskell.org/package/github">Haskell の GitHub クライアント</a>には Gist を作成する関数が作られてなかった． ので，作成してとりあえず PR を出した：</p>
<ul>
<li><a href="https://github.com/phadej/github/pull/455">Add endpoint to create gist · #455 · phadej/github</a></li>
</ul>
<p>実は（リファレンスからは分かりにくい？）注意点があって：</p>
<ol>
<li><code>files</code> は <code>{"hoge.txt": {"content": "abc"}}</code> って感じのJSONオブジェクト</li>
<li><code>description</code> パラメーターや <code>files</code> の <code>content</code> は <code>null</code> を渡せない</li>
<li><code>public</code> を <code>null</code> にした場合レスポンスの <code>public</code> も <code>null</code> になる</li>
</ol>
<p>aeson で <code>Maybe</code> を使ってオプショナルなパラメーターを表現した場合は強制的に <code>null</code> が渡される． <del>そのため，<code>description</code> はオプショナルなパラメーターだが型を <code>Text</code> にした</del> が，レビューで次のようにやればいいよって返ってきた：</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="kw">instance</span> <span class="dt">ToJSON</span> <span class="dt">NewGist</span> <span class="kw">where</span></span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a>    toJSON <span class="dt">NewGist</span> { <span class="op">...</span> } <span class="ot">=</span> object <span class="op">$</span> <span class="fu">filter</span> notNull</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a>                   [ <span class="st">&quot;description&quot;</span> <span class="op">.=</span> newGistDescription</span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a>                   , <span class="st">&quot;files&quot;</span>       <span class="op">.=</span> newGistFiles</span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a>                   , <span class="st">&quot;public&quot;</span>      <span class="op">.=</span> newGistPublic</span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a>                   ]</span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a>      <span class="kw">where</span></span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a>        notNull (_, <span class="dt">Null</span>) <span class="ot">=</span> <span class="dt">False</span></span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a>        notNull (_, _)    <span class="ot">=</span> <span class="dt">True</span></span></code></pre></div>
<p>なるほど，レビュー感謝． で，<code>public</code> は，すでにある <code>Gist</code> 型（レスポンスに使いたい）の <code>public</code> が <code>Maybe Bool</code> ではなく <code>Bool</code> なので (3) の挙動が困る． そのため，<code>public</code> パラメーターの型も <code>Bool</code> にしたが，<code>description</code> 同様に <code>filter notNull</code> 効かせたので普通に <code>Maybe Bool</code> で良くなった． ちなみに，デフォルトは <code>false</code>．</p>
<h3 id="pandoc-で書き換える">Pandoc で書き換える</h3>
<p>少しオーバースペックのような気がするが，Pandoc を利用して Markdown をパースする：</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="ot">customizeContent ::</span> <span class="dt">Text</span> <span class="ot">-&gt;</span> <span class="dt">RIO</span> <span class="dt">Env</span> <span class="dt">Text</span></span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a>customizeContent content <span class="ot">=</span> liftIO <span class="op">.</span> Pandoc.runIOorExplode <span class="op">$</span> <span class="kw">do</span></span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a>  p0 <span class="ot">&lt;-</span> Pandoc.readCommonMark Pandoc.def content</span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a>  Pandoc.writeCommonMark Pandoc.def p0</span></code></pre></div>
<p><code>readMarkdown</code> というのもあるが，GFM などを使う場合は <code>readCommonMark</code> の方を使う． <code>p0</code> というのが <code>Pandoc</code> 型の値で，<code>Walkable</code> を利用することで任意のブロックに対してのみ変換を適用したりできる：</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="ot">customizeContent ::</span> <span class="dt">Text</span> <span class="ot">-&gt;</span> <span class="dt">RIO</span> <span class="dt">Env</span> <span class="dt">Text</span></span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a>customizeContent content <span class="ot">=</span> <span class="kw">do</span></span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a>  p0 <span class="ot">&lt;-</span> liftIO <span class="op">$</span> Pandoc.runIOorExplode (Pandoc.readCommonMark Pandoc.def content)</span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a>  p1 <span class="ot">&lt;-</span> Pandoc.walkPandocM replaceCodeBlockToGistLink p0</span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a>  liftIO <span class="op">$</span> Pandoc.runIOorExplode (Pandoc.writeCommonMark Pandoc.def p1)</span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-7"><a href="#cb3-7" aria-hidden="true" tabindex="-1"></a><span class="ot">replaceCodeBlockToGistLink ::</span> <span class="dt">Pandoc.Block</span> <span class="ot">-&gt;</span> <span class="dt">RIO</span> <span class="dt">Env</span> <span class="dt">Pandoc.Block</span></span>
<span id="cb3-8"><a href="#cb3-8" aria-hidden="true" tabindex="-1"></a>replaceCodeBlockToGistLink <span class="ot">=</span> \<span class="kw">case</span></span>
<span id="cb3-9"><a href="#cb3-9" aria-hidden="true" tabindex="-1"></a>  <span class="dt">Pandoc.CodeBlock</span> attr txt <span class="ot">-&gt;</span> <span class="fu">undefined</span> <span class="co">-- 書き換える</span></span>
<span id="cb3-10"><a href="#cb3-10" aria-hidden="true" tabindex="-1"></a>  block <span class="ot">-&gt;</span> <span class="fu">pure</span> block</span></code></pre></div>
<p>Gist がよしなにプログラミング言語を特定してシンタックスハイライトするにはファイルの拡張子が必要だ． コードブロックのバッククオートの後ろに指定している拡張子を取得するために <code>attr</code> を見てみると <code>("", ["hs"], [])</code> となっていた（プログラミング言語名も指定できるけど，拡張子だけを指定してるとする）． なので，これを利用する：</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="ot">replaceCodeBlockToGistLink ::</span> <span class="dt">Pandoc.Block</span> <span class="ot">-&gt;</span> <span class="dt">RIO</span> <span class="dt">Env</span> <span class="dt">Pandoc.Block</span></span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a>replaceCodeBlockToGistLink <span class="ot">=</span> \<span class="kw">case</span></span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a>  <span class="dt">Pandoc.CodeBlock</span> (_, [ext], _) txt <span class="ot">-&gt;</span> <span class="kw">do</span></span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a>    gist <span class="ot">&lt;-</span> lift <span class="op">$</span> createGist ext txt</span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a>    <span class="fu">pure</span> <span class="op">$</span> <span class="dt">Pandoc.Plain</span> [<span class="dt">Pandoc.Str</span> (GitHub.getUrl <span class="op">$</span> GitHub.gistHtmlUrl gist)]</span>
<span id="cb4-6"><a href="#cb4-6" aria-hidden="true" tabindex="-1"></a>  block <span class="ot">-&gt;</span> <span class="fu">pure</span> block</span>
<span id="cb4-7"><a href="#cb4-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-8"><a href="#cb4-8" aria-hidden="true" tabindex="-1"></a><span class="ot">createGist ::</span> <span class="dt">Text</span> <span class="ot">-&gt;</span> <span class="dt">Text</span> <span class="ot">-&gt;</span> <span class="dt">RIO</span> <span class="dt">Env</span> <span class="dt">GitHub.Gist</span></span>
<span id="cb4-9"><a href="#cb4-9" aria-hidden="true" tabindex="-1"></a>createGist ext txt <span class="ot">=</span> <span class="kw">do</span></span>
<span id="cb4-10"><a href="#cb4-10" aria-hidden="true" tabindex="-1"></a>  <span class="kw">let</span> files <span class="ot">=</span> HM.fromList [(<span class="st">&quot;sample.&quot;</span> <span class="op">&lt;&gt;</span> ext, <span class="dt">GitHub.NewGistFile</span> txt)]</span>
<span id="cb4-11"><a href="#cb4-11" aria-hidden="true" tabindex="-1"></a>  <span class="co">-- とりあえずエラーハンドリングは適当に throwM する</span></span>
<span id="cb4-12"><a href="#cb4-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">either</span> throwM <span class="fu">pure</span> <span class="op">=&lt;&lt;</span> MixGitHub.fetch (GitHub.createGistR <span class="op">$</span> <span class="dt">GitHub.NewGist</span> <span class="st">&quot;&quot;</span> files <span class="dt">True</span>)</span></code></pre></div>
<p><code>MixGitHub.fetch</code> というのは<a href="https://github.com/matsubara0507/mix.hs/tree/master/mix-plugin-github">これ</a>です． 便利です．</p>
<p>これでとりあえず，コードブロックから Gist を作ってリンクに置き換えることができるようになった．</p>
<h3 id="gist-のファイル名を工夫する">Gist のファイル名を工夫する</h3>
<p>現状だと全ての Gist ファイルが <code>sample.hs</code> みたいに拡張子以外は一緒になってしまう． なのでプレフィックスを指定できるようにするのと，何個目のコードブロックかで <code>sample1.hs</code> や <code>sample2.hs</code> みたいにできるようにしたい． そのために <code>State</code> モナドを利用する：</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="ot">customizeContent ::</span> <span class="dt">Text</span> <span class="ot">-&gt;</span> <span class="dt">RIO</span> <span class="dt">Env</span> <span class="dt">Text</span></span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a>customizeContent content <span class="ot">=</span> <span class="kw">do</span></span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a>  p0 <span class="ot">&lt;-</span> liftIO <span class="op">$</span> Pandoc.runIOorExplode (Pandoc.readCommonMark Pandoc.def content)</span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a>  p1 <span class="ot">&lt;-</span> <span class="fu">fst</span> <span class="op">&lt;$&gt;</span> runStateT (Pandoc.walkPandocM replaceCodeBlockToGistLink p0) <span class="dv">1</span></span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a>  liftIO <span class="op">$</span> Pandoc.runIOorExplode (Pandoc.writeCommonMark Pandoc.def p1)</span>
<span id="cb5-6"><a href="#cb5-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-7"><a href="#cb5-7" aria-hidden="true" tabindex="-1"></a><span class="ot">replaceCodeBlockToGistLink ::</span>  <span class="dt">Pandoc.Block</span> <span class="ot">-&gt;</span> <span class="dt">StateT</span> <span class="dt">Int</span> (<span class="dt">RIO</span> <span class="dt">Env</span>) <span class="dt">Pandoc.Block</span></span>
<span id="cb5-8"><a href="#cb5-8" aria-hidden="true" tabindex="-1"></a>replaceCodeBlockToGistLink <span class="ot">=</span> \<span class="kw">case</span></span>
<span id="cb5-9"><a href="#cb5-9" aria-hidden="true" tabindex="-1"></a>  <span class="dt">Pandoc.CodeBlock</span> (_, [ext], _) txt <span class="ot">-&gt;</span> <span class="kw">do</span></span>
<span id="cb5-10"><a href="#cb5-10" aria-hidden="true" tabindex="-1"></a>    cnt  <span class="ot">&lt;-</span> State.get</span>
<span id="cb5-11"><a href="#cb5-11" aria-hidden="true" tabindex="-1"></a>    gist <span class="ot">&lt;-</span> lift <span class="op">$</span> createGist (tshow cnt) ext txt</span>
<span id="cb5-12"><a href="#cb5-12" aria-hidden="true" tabindex="-1"></a>    State.modify (<span class="op">+</span> <span class="dv">1</span>)</span>
<span id="cb5-13"><a href="#cb5-13" aria-hidden="true" tabindex="-1"></a>    <span class="fu">pure</span> <span class="op">$</span> <span class="dt">Pandoc.Plain</span> [<span class="dt">Pandoc.Str</span> (GitHub.getUrl <span class="op">$</span> GitHub.gistHtmlUrl gist)]</span>
<span id="cb5-14"><a href="#cb5-14" aria-hidden="true" tabindex="-1"></a>  block <span class="ot">-&gt;</span> <span class="fu">pure</span> block</span>
<span id="cb5-15"><a href="#cb5-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-16"><a href="#cb5-16" aria-hidden="true" tabindex="-1"></a><span class="ot">createGist ::</span> <span class="dt">Text</span> <span class="ot">-&gt;</span> <span class="dt">Text</span> <span class="ot">-&gt;</span> <span class="dt">Text</span> <span class="ot">-&gt;</span> <span class="dt">RIO</span> <span class="dt">Env</span> <span class="dt">GitHub.Gist</span></span>
<span id="cb5-17"><a href="#cb5-17" aria-hidden="true" tabindex="-1"></a>createGist suffix ext txt <span class="ot">=</span> <span class="kw">do</span></span>
<span id="cb5-18"><a href="#cb5-18" aria-hidden="true" tabindex="-1"></a>  <span class="kw">let</span> files <span class="ot">=</span> HM.fromList [(<span class="st">&quot;sample&quot;</span> <span class="op">&lt;&gt;</span> suffix <span class="op">&lt;&gt;</span> <span class="st">&quot;.&quot;</span> <span class="op">&lt;&gt;</span> ext, <span class="dt">GitHub.NewGistFile</span> txt)]</span>
<span id="cb5-19"><a href="#cb5-19" aria-hidden="true" tabindex="-1"></a>  <span class="fu">either</span> throwM <span class="fu">pure</span> <span class="op">=&lt;&lt;</span> MixGitHub.fetch (GitHub.createGistR <span class="op">$</span> <span class="dt">GitHub.NewGist</span> <span class="st">&quot;&quot;</span> files <span class="dt">True</span>)</span></code></pre></div>
<p>プレフィックスはコマンドのオプションから指定して，適当に <code>createGist</code> まで持ってくるだけなので割愛． これで完全に手作業してたのが自動化された．</p>
<h2 id="おしまい">おしまい</h2>
<p>Pandoc パッケージのビルドがゲキオモなのがネックだけどね．</p>]]></content>
    </entry>
    <entry>
        <title>外部ツールのバージョンアップを GitHub Actions で検知する</title>
        <link href="https://matsubara0507.github.ioposts/2020-12-14-check-release-using-github-actions.html"/>
        <id>https://matsubara0507.github.ioposts/2020-12-14-check-release-using-github-actions.html</id>
        <updated>2020-12-14T00:00:SZ</updated>
        <category term="GitHub-Actions"/>
        <summary></summary>
        <content type="html"><![CDATA[<p>GitHub Actions のアクションや Bazel ルールを書いたりすると，外部のアプリケーションのアップデートを検知したいときがしばしばあります． いろいろ試行錯誤した結果，GitHub Actions を使って実現することにしたので，本記事はそのメモ書きです．</p>
<h1 id="section"></h1>
<p>ちなみに，本記事は「<a href="https://qiita.com/advent-calendar/2020/github-actions">GitHub Actions Advent Calendar 2020</a>」の14日目の記事です．</p>
<h2 id="github-actions-を設定する">GitHub Actions を設定する</h2>
<p>実際に導入した PR がこちら：</p>
<ul>
<li><a href="https://github.com/matsubara0507/rules_yq/pull/1">Add GitHub Action to check new yq version by matsubara0507 · Pull Request #1 · matsubara0507/rules_yq</a></li>
</ul>
<p><a href="https://github.com/mikefarah/yq">yq</a> と言うツールのリリースを検知しようとしている． ちなみに，最新のバージョンは中の処理のデフォルト値として利用している．</p>
<h3 id="デフォルト値を取り出す">デフォルト値を取り出す</h3>
<p>まずは，現在のデフォルトのバージョンを参照しやすいように別ファイル（yq/default.bzl）にしておく：</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode py"><code class="sourceCode python"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a>YQ_DEFAULT_VERSION <span class="op">=</span> <span class="st">&quot;3.4.1&quot;</span></span></code></pre></div>
<p>これを sed でいい感じに取り出して GitHub Actions の output に入れていく：</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode yaml"><code class="sourceCode yaml"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="fu">jobs</span><span class="kw">:</span></span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">build</span><span class="kw">:</span></span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">name</span><span class="kw">:</span><span class="at"> Build new version commit</span></span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">runs-on</span><span class="kw">:</span><span class="at"> ubuntu-latest</span></span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">env</span><span class="kw">:</span></span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="fu">DEFAULT_FILE_PATH</span><span class="kw">:</span><span class="at"> yq/default.bzl</span></span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">steps</span><span class="kw">:</span></span>
<span id="cb2-8"><a href="#cb2-8" aria-hidden="true" tabindex="-1"></a><span class="at">    ...</span></span>
<span id="cb2-9"><a href="#cb2-9" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="kw">-</span><span class="at"> </span><span class="fu">name</span><span class="kw">:</span><span class="at"> Set default version</span></span>
<span id="cb2-10"><a href="#cb2-10" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="fu">id</span><span class="kw">:</span><span class="at"> default</span></span>
<span id="cb2-11"><a href="#cb2-11" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="fu">run</span><span class="kw">:</span><span class="at"> echo &quot;::set-output name=version::$(sed -e s/YQ_DEFAULT_VERSION\ =\ //g $DEFAULT_FILE_PATH | sed -e s/\&quot;//g)&quot;</span></span></code></pre></div>
<p><code>::set-output</code> というのは GitHub Actions の記法で， step 毎の結果を同じ job 間で共有するために使う．以降の step で <code>steps.default.outputs.version</code> という形で <code>sed</code> の結果を参照できるようになる．</p>
<h3 id="最新のリリースバージョンを取り出す">最新のリリースバージョンを取り出す</h3>
<p>最新のリリースは <a href="https://docs.github.com/en/free-pro-team@latest/rest/reference/repos#get-the-latest-release">GitHub のリリースから API</a> を使って取得する． API のレスポンスからバージョンの情報を <code>jq</code> でいい感じに取り出して，また output に入れておく：</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode yaml"><code class="sourceCode yaml"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="fu">jobs</span><span class="kw">:</span></span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">build</span><span class="kw">:</span></span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">name</span><span class="kw">:</span><span class="at"> Build new version commit</span></span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">runs-on</span><span class="kw">:</span><span class="at"> ubuntu-latest</span></span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">env</span><span class="kw">:</span></span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="fu">DEFAULT_FILE_PATH</span><span class="kw">:</span><span class="at"> yq/default.bzl</span></span>
<span id="cb3-7"><a href="#cb3-7" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="fu">LATEST_LINK</span><span class="kw">:</span><span class="at"> https://api.github.com/repos/mikefarah/yq/releases/latest</span></span>
<span id="cb3-8"><a href="#cb3-8" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">steps</span><span class="kw">:</span></span>
<span id="cb3-9"><a href="#cb3-9" aria-hidden="true" tabindex="-1"></a><span class="at">    ...</span></span>
<span id="cb3-10"><a href="#cb3-10" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="kw">-</span><span class="at"> </span><span class="fu">name</span><span class="kw">:</span><span class="at"> Set latest version</span></span>
<span id="cb3-11"><a href="#cb3-11" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="fu">id</span><span class="kw">:</span><span class="at"> latest</span></span>
<span id="cb3-12"><a href="#cb3-12" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="fu">run</span><span class="kw">:</span><span class="at"> echo &quot;::set-output name=version::$(curl -s $LATEST_LINK | jq .tag_name | sed -e s/\&quot;//g)&quot;</span></span></code></pre></div>
<p>以降の step で <code>steps.latest.outputs.version</code> という形で <code>jq</code> の結果を参照できるようになる．</p>
<h3 id="デフォルト値を更新する">デフォルト値を更新する</h3>
<p>これら2つのバージョンが異なるときにだけデフォルト値を更新するようにする：</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode yaml"><code class="sourceCode yaml"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="fu">jobs</span><span class="kw">:</span></span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">build</span><span class="kw">:</span></span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">name</span><span class="kw">:</span><span class="at"> Build new version commit</span></span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">runs-on</span><span class="kw">:</span><span class="at"> ubuntu-latest</span></span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">env</span><span class="kw">:</span></span>
<span id="cb4-6"><a href="#cb4-6" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="fu">DEFAULT_FILE_PATH</span><span class="kw">:</span><span class="at"> yq/default.bzl</span></span>
<span id="cb4-7"><a href="#cb4-7" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="fu">LATEST_LINK</span><span class="kw">:</span><span class="at"> https://api.github.com/repos/mikefarah/yq/releases/latest</span></span>
<span id="cb4-8"><a href="#cb4-8" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">steps</span><span class="kw">:</span></span>
<span id="cb4-9"><a href="#cb4-9" aria-hidden="true" tabindex="-1"></a><span class="at">    ...</span></span>
<span id="cb4-10"><a href="#cb4-10" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="kw">-</span><span class="at"> </span><span class="fu">name</span><span class="kw">:</span><span class="at"> Update new version default.bzl</span></span>
<span id="cb4-11"><a href="#cb4-11" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="fu">if</span><span class="kw">:</span><span class="at"> ${{ steps.latest.outputs.version != steps.default.outputs.version }}</span></span>
<span id="cb4-12"><a href="#cb4-12" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="fu">env</span><span class="kw">:</span></span>
<span id="cb4-13"><a href="#cb4-13" aria-hidden="true" tabindex="-1"></a><span class="at">        </span><span class="fu">NEW_VERSION</span><span class="kw">:</span><span class="at"> ${{ steps.latest.outputs.version }}</span></span>
<span id="cb4-14"><a href="#cb4-14" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="fu">run</span><span class="kw">:</span><span class="at"> echo &quot;YQ_DEFAULT_VERSION = \&quot;$NEW_VERSION\&quot;&quot; &gt; $DEFAULT_FILE_PATH    </span></span></code></pre></div>
<p>ただ切り出しておいたファイルを上書きしているだけ．</p>
<h3 id="prを作成する">PRを作成する</h3>
<p><a href="https://github.com/peter-evans/create-pull-request">peter-evans/create-pull-request</a> という GitHub Actions を利用する：</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode yaml"><code class="sourceCode yaml"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="fu">jobs</span><span class="kw">:</span></span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">build</span><span class="kw">:</span></span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">name</span><span class="kw">:</span><span class="at"> Build new version commit</span></span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">runs-on</span><span class="kw">:</span><span class="at"> ubuntu-latest</span></span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">env</span><span class="kw">:</span></span>
<span id="cb5-6"><a href="#cb5-6" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="fu">DEFAULT_FILE_PATH</span><span class="kw">:</span><span class="at"> yq/default.bzl</span></span>
<span id="cb5-7"><a href="#cb5-7" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="fu">LATEST_LINK</span><span class="kw">:</span><span class="at"> https://api.github.com/repos/mikefarah/yq/releases/latest</span></span>
<span id="cb5-8"><a href="#cb5-8" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">steps</span><span class="kw">:</span></span>
<span id="cb5-9"><a href="#cb5-9" aria-hidden="true" tabindex="-1"></a><span class="at">    ...</span></span>
<span id="cb5-10"><a href="#cb5-10" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="kw">-</span><span class="at"> </span><span class="fu">name</span><span class="kw">:</span><span class="at"> Create Pull Request</span></span>
<span id="cb5-11"><a href="#cb5-11" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="fu">if</span><span class="kw">:</span><span class="at"> ${{ steps.latest.outputs.version != steps.default.outputs.version }}</span></span>
<span id="cb5-12"><a href="#cb5-12" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="fu">uses</span><span class="kw">:</span><span class="at"> peter-evans/create-pull-request@v3.5.1</span></span>
<span id="cb5-13"><a href="#cb5-13" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="fu">with</span><span class="kw">:</span></span>
<span id="cb5-14"><a href="#cb5-14" aria-hidden="true" tabindex="-1"></a><span class="at">        </span><span class="fu">token</span><span class="kw">:</span><span class="at"> ${{ secrets.GITHUB_TOKEN }}</span></span>
<span id="cb5-15"><a href="#cb5-15" aria-hidden="true" tabindex="-1"></a><span class="at">        </span><span class="fu">commit-message</span><span class="kw">:</span><span class="at"> </span><span class="st">&#39;Feat: update default yq version&#39;</span></span>
<span id="cb5-16"><a href="#cb5-16" aria-hidden="true" tabindex="-1"></a><span class="at">        </span><span class="fu">title</span><span class="kw">:</span><span class="at"> Release new yq version ${{ steps.latest.outputs.version }}</span></span>
<span id="cb5-17"><a href="#cb5-17" aria-hidden="true" tabindex="-1"></a><span class="fu">        body</span><span class="kw">: </span><span class="ch">|</span></span>
<span id="cb5-18"><a href="#cb5-18" aria-hidden="true" tabindex="-1"></a>         @matsubara0507</span>
<span id="cb5-19"><a href="#cb5-19" aria-hidden="true" tabindex="-1"></a>         - [x] update default version in yq</span>
<span id="cb5-20"><a href="#cb5-20" aria-hidden="true" tabindex="-1"></a>         - [ ] add new checksums to yq/toolchain.bzl</span>
<span id="cb5-21"><a href="#cb5-21" aria-hidden="true" tabindex="-1"></a>         - [ ] update documents (README, actions.yml)</span>
<span id="cb5-22"><a href="#cb5-22" aria-hidden="true" tabindex="-1"></a>         - [ ] update sample workflow</span>
<span id="cb5-23"><a href="#cb5-23" aria-hidden="true" tabindex="-1"></a><span class="at">        </span><span class="fu">labels</span><span class="kw">:</span><span class="at"> New yq Version</span></span>
<span id="cb5-24"><a href="#cb5-24" aria-hidden="true" tabindex="-1"></a><span class="at">        </span><span class="fu">branch</span><span class="kw">:</span><span class="at"> yq-version-${{ steps.latest.outputs.version }}</span></span>
<span id="cb5-25"><a href="#cb5-25" aria-hidden="true" tabindex="-1"></a><span class="at">        </span><span class="fu">base</span><span class="kw">:</span><span class="at"> main</span><span class="co">  # 最近作ったリポジトリなので main がデフォルトブランチ</span></span>
<span id="cb5-26"><a href="#cb5-26" aria-hidden="true" tabindex="-1"></a><span class="at">        </span><span class="fu">draft</span><span class="kw">:</span><span class="at"> </span><span class="ch">true</span><span class="co"> # ドラフトPRにしてくれる</span></span></code></pre></div>
<p><code>body</code> のところに自分の GitHub アカウントをメンションしておくと，GitHub のスマホアプリとかで通知されて気付きやすい． こんな感じの PR が出来上がる：</p>
<p><img src="/assets/check-release-using-github-actions/pr.jpg" /></p>
<p>ちなみに，すでにブランチがある場合は PR が作成されない． また，PR を放置しているうちに新しいバージョンがリリースされた場合は，新しい PR がもう一個でき上がる．</p>
<h2 id="おしまい">おしまい</h2>
<p>結構便利です．</p>]]></content>
    </entry>
    <entry>
        <title>Elm で Featherweight Go を書いてみた（その１）</title>
        <link href="https://matsubara0507.github.ioposts/2020-12-07-fg-with-elm-part1.html"/>
        <id>https://matsubara0507.github.ioposts/2020-12-07-fg-with-elm-part1.html</id>
        <updated>2020-12-07T00:00:SZ</updated>
        <category term="Elm"/>
        <category term="Go"/>
        <summary></summary>
        <content type="html"><![CDATA[<p>タイトルの通り，Elm で Featherweight Go を作って遊んでました． 本記事はそのメモ書きです．</p>
<h1 id="section"></h1>
<p>あとこれは <a href="https://qiita.com/advent-calendar/2020/elm">Elm Advent Calendar 2020</a> の7日目の記事です．</p>
<h2 id="featherweight-go">Featherweight Go</h2>
<p>Go にジェネリクスを導入するために考案された，極めてミニマムな Go 処理系（の形式的な定義）． そのまんま「<a href="https://arxiv.org/abs/2005.11710">Featherweight Go</a>」という論文が出てる． 前に，ざっくり日本語でまとめました：</p>
<ul>
<li><a href="https://matsubara0507.github.io/posts/2020-07-02-read-featherweight-go.html">Featherweight Go を読んでみた - ひげメモ</a></li>
</ul>
<p>論文では Featherweight Go（以下 FG）と，それにジェネリクスを追加した Featherweight Generics Go の構文規則・評価規則・型付け規則などが定義されており，型安全性が証明されている． 今回は，Featherweight Go のパーサーと型検査器を論文の定義に則って Elm で実装した話．</p>
<p>ちなみに評価の方は実装しないです．</p>
<h2 id="elm">Elm</h2>
<p>Elm は JavaScript へとトランスパイルされる Web フロントエンドに特化した純粋関数型プログラミング言語． 構文は Haskell に似ているが，言語機能自体は Haskell のように多彩ではなく，極めてコンパクトである．</p>
<p>今回 Elm を使う理由は2つあって：</p>
<ol>
<li>Elm でプログラミング言語作る人がほとんど居ないから</li>
<li>簡単に Web ビュー側を作れるから</li>
</ol>
<p>です．</p>
<h3 id="elm-でパーサーを作るには">Elm でパーサーを作るには</h3>
<p>Elm でパーサーを記述するには <a href="https://package.elm-lang.org/packages/elm/parser">elm/parser</a> という公式が提供しているパーサーコンビネーターライブラリを使う．</p>
<h2 id="fgのパーサーを作る">FGのパーサーを作る</h2>
<p>構文規則は次の通り：</p>
<p><img src="/assets/read-featherweight-go/fg.jpg" /></p>
<p>これを Elm でひたすら実装していく．</p>
<h3 id="構文の型を定義">構文の型を定義</h3>
<p>まずは，構文を表現する型を定義しよう． ひたすら予約語にあたる部分を排除するだけだ：</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode elm"><code class="sourceCode elm"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="kw">module</span> <span class="dt">Go</span><span class="op">.</span><span class="dt">Featherweight</span><span class="op">.</span><span class="dt">Syntax</span> <span class="kw">exposing</span> (<span class="op">..</span>)</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="kw">type</span> <span class="kw">alias</span> <span class="dt">Program</span> <span class="op">=</span></span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a>    { <span class="fu">decls</span> : <span class="dt">List</span> <span class="dt">Declaration</span><span class="op">,</span> <span class="fu">exp</span> : <span class="dt">Expression</span> }</span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a><span class="kw">type</span> <span class="dt">Declaration</span></span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a>    <span class="op">=</span> <span class="dt">TDecl</span></span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a>        { <span class="fu">name</span> : <span class="dt">TypeName</span></span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a>        <span class="op">,</span> <span class="fu">literal</span> : <span class="dt">TypeLiteral</span></span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb1-11"><a href="#cb1-11" aria-hidden="true" tabindex="-1"></a>    <span class="op">|</span> <span class="dt">MDecl</span></span>
<span id="cb1-12"><a href="#cb1-12" aria-hidden="true" tabindex="-1"></a>        { <span class="fu">recv</span> : ( <span class="dt">VarName</span><span class="op">,</span> <span class="dt">TypeName</span> )</span>
<span id="cb1-13"><a href="#cb1-13" aria-hidden="true" tabindex="-1"></a>        <span class="op">,</span> <span class="fu">name</span> : <span class="dt">MethodName</span></span>
<span id="cb1-14"><a href="#cb1-14" aria-hidden="true" tabindex="-1"></a>        <span class="op">,</span> <span class="fu">sign</span> : <span class="dt">MethodSignature</span></span>
<span id="cb1-15"><a href="#cb1-15" aria-hidden="true" tabindex="-1"></a>        <span class="op">,</span> <span class="fu">retv</span> : <span class="dt">Expression</span></span>
<span id="cb1-16"><a href="#cb1-16" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb1-17"><a href="#cb1-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-18"><a href="#cb1-18" aria-hidden="true" tabindex="-1"></a><span class="kw">type</span> <span class="kw">alias</span> <span class="dt">TypeName</span> <span class="op">=</span> <span class="dt">String</span></span>
<span id="cb1-19"><a href="#cb1-19" aria-hidden="true" tabindex="-1"></a><span class="kw">type</span> <span class="kw">alias</span> <span class="dt">VarName</span> <span class="op">=</span> <span class="dt">String</span></span>
<span id="cb1-20"><a href="#cb1-20" aria-hidden="true" tabindex="-1"></a><span class="kw">type</span> <span class="kw">alias</span> <span class="dt">MethodName</span> <span class="op">=</span> <span class="dt">String</span></span>
<span id="cb1-21"><a href="#cb1-21" aria-hidden="true" tabindex="-1"></a><span class="kw">type</span> <span class="kw">alias</span> <span class="dt">FieldName</span> <span class="op">=</span> <span class="dt">String</span></span>
<span id="cb1-22"><a href="#cb1-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-23"><a href="#cb1-23" aria-hidden="true" tabindex="-1"></a><span class="kw">type</span> <span class="dt">TypeLiteral</span></span>
<span id="cb1-24"><a href="#cb1-24" aria-hidden="true" tabindex="-1"></a>    <span class="op">=</span> <span class="dt">Structure</span> (<span class="dt">List</span> ( <span class="dt">FieldName</span><span class="op">,</span> <span class="dt">TypeName</span> ))</span>
<span id="cb1-25"><a href="#cb1-25" aria-hidden="true" tabindex="-1"></a>    <span class="op">|</span> <span class="dt">Interface</span> (<span class="dt">List</span> <span class="dt">MethodSpecific</span>)</span>
<span id="cb1-26"><a href="#cb1-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-27"><a href="#cb1-27" aria-hidden="true" tabindex="-1"></a><span class="kw">type</span> <span class="kw">alias</span> <span class="dt">MethodSpecific</span> <span class="op">=</span></span>
<span id="cb1-28"><a href="#cb1-28" aria-hidden="true" tabindex="-1"></a>    { <span class="fu">name</span> : <span class="dt">MethodName</span><span class="op">,</span> <span class="fu">sign</span> : <span class="dt">MethodSignature</span> }</span>
<span id="cb1-29"><a href="#cb1-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-30"><a href="#cb1-30" aria-hidden="true" tabindex="-1"></a><span class="kw">type</span> <span class="kw">alias</span> <span class="dt">MethodSignature</span> <span class="op">=</span></span>
<span id="cb1-31"><a href="#cb1-31" aria-hidden="true" tabindex="-1"></a>    { <span class="fu">args</span> : <span class="dt">List</span> ( <span class="dt">VarName</span><span class="op">,</span> <span class="dt">TypeName</span> )<span class="op">,</span> <span class="fu">rett</span> : <span class="dt">TypeName</span> }</span>
<span id="cb1-32"><a href="#cb1-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-33"><a href="#cb1-33" aria-hidden="true" tabindex="-1"></a><span class="kw">type</span> <span class="dt">Expression</span></span>
<span id="cb1-34"><a href="#cb1-34" aria-hidden="true" tabindex="-1"></a>    <span class="op">=</span> <span class="dt">Var</span> <span class="dt">VarName</span></span>
<span id="cb1-35"><a href="#cb1-35" aria-hidden="true" tabindex="-1"></a>    <span class="op">|</span> <span class="dt">MethodCall</span></span>
<span id="cb1-36"><a href="#cb1-36" aria-hidden="true" tabindex="-1"></a>        { <span class="fu">exp</span> : <span class="dt">Expression</span></span>
<span id="cb1-37"><a href="#cb1-37" aria-hidden="true" tabindex="-1"></a>        <span class="op">,</span> <span class="fu">method</span> : <span class="dt">MethodName</span></span>
<span id="cb1-38"><a href="#cb1-38" aria-hidden="true" tabindex="-1"></a>        <span class="op">,</span> <span class="fu">args</span> : <span class="dt">List</span> <span class="dt">Expression</span></span>
<span id="cb1-39"><a href="#cb1-39" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb1-40"><a href="#cb1-40" aria-hidden="true" tabindex="-1"></a>    <span class="op">|</span> <span class="dt">StructLiteral</span></span>
<span id="cb1-41"><a href="#cb1-41" aria-hidden="true" tabindex="-1"></a>        { <span class="fu">struct</span> : <span class="dt">TypeName</span></span>
<span id="cb1-42"><a href="#cb1-42" aria-hidden="true" tabindex="-1"></a>        <span class="op">,</span> <span class="fu">args</span> : <span class="dt">List</span> <span class="dt">Expression</span></span>
<span id="cb1-43"><a href="#cb1-43" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb1-44"><a href="#cb1-44" aria-hidden="true" tabindex="-1"></a>    <span class="op">|</span> <span class="dt">SelectField</span></span>
<span id="cb1-45"><a href="#cb1-45" aria-hidden="true" tabindex="-1"></a>        { <span class="fu">exp</span> : <span class="dt">Expression</span></span>
<span id="cb1-46"><a href="#cb1-46" aria-hidden="true" tabindex="-1"></a>        <span class="op">,</span> <span class="fu">field</span> : <span class="dt">FieldName</span></span>
<span id="cb1-47"><a href="#cb1-47" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb1-48"><a href="#cb1-48" aria-hidden="true" tabindex="-1"></a>    <span class="op">|</span> <span class="dt">TypeAssertion</span></span>
<span id="cb1-49"><a href="#cb1-49" aria-hidden="true" tabindex="-1"></a>        { <span class="fu">exp</span> : <span class="dt">Expression</span></span>
<span id="cb1-50"><a href="#cb1-50" aria-hidden="true" tabindex="-1"></a>        <span class="op">,</span> <span class="fu">ty</span> : <span class="dt">TypeName</span></span>
<span id="cb1-51"><a href="#cb1-51" aria-hidden="true" tabindex="-1"></a>        }</span></code></pre></div>
<h3 id="パーサーを書く">パーサーを書く</h3>
<p>先に，FG のパーサーを記述する上で便利なヘルパー関数をいくつか定義しておく：</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode elm"><code class="sourceCode elm"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="kw">module</span> <span class="dt">Go</span><span class="op">.</span><span class="dt">Parser</span><span class="op">.</span><span class="dt">Helper</span> <span class="kw">exposing</span> (<span class="op">..</span>)</span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a><span class="fu">newlineSequence</span> : <span class="dt">Parser</span> () <span class="op">-&gt;</span> <span class="dt">Parser</span> <span class="fu">a</span> <span class="op">-&gt;</span> <span class="dt">Parser</span> (<span class="dt">List</span> <span class="fu">a</span>)</span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a><span class="fu">newlineSequence</span> <span class="fu">end</span> <span class="fu">p</span> <span class="op">=</span> <span class="op">...</span></span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a><span class="fu">blockWith</span> : ( <span class="dt">String</span><span class="op">,</span> <span class="dt">String</span> ) <span class="op">-&gt;</span> <span class="dt">Parser</span> <span class="fu">a</span> <span class="op">-&gt;</span> <span class="dt">Parser</span> (<span class="dt">List</span> <span class="fu">a</span>)</span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a><span class="fu">blockWith</span> ( <span class="fu">start</span><span class="op">,</span> <span class="fu">end</span> ) <span class="fu">p</span> <span class="op">=</span> <span class="op">...</span></span>
<span id="cb2-8"><a href="#cb2-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-9"><a href="#cb2-9" aria-hidden="true" tabindex="-1"></a><span class="fu">whitespaces</span> : <span class="dt">Parser</span> ()</span>
<span id="cb2-10"><a href="#cb2-10" aria-hidden="true" tabindex="-1"></a><span class="fu">whitespaces</span> <span class="op">=</span> <span class="op">...</span></span>
<span id="cb2-11"><a href="#cb2-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-12"><a href="#cb2-12" aria-hidden="true" tabindex="-1"></a><span class="fu">newlines</span> : <span class="dt">Parser</span> ()</span>
<span id="cb2-13"><a href="#cb2-13" aria-hidden="true" tabindex="-1"></a><span class="fu">newlines</span> <span class="op">=</span> <span class="op">...</span></span></code></pre></div>
<p><a href="https://github.com/matsubara0507/featherweight-go/blob/4ce84918c80b0852b4c32989bdbfe29331ab1fe9/src/Go/Parser/Helper.elm">実装はこの辺りを見てください</a>． <code>newlineSequence</code> は改行区切りで引数のパーサーを実行してくれる． 例えば，構造体のフィールドを改行区切りで列挙するのをパースするのに役立つ． <code>blockWith</code> は，1引数目で与えた開始文字列と終端文字列で囲まれてかつ，2引数目のパーサーをカンマ区切りで実行してくれる． 関数定義の引数のパースなどに役立つ． <code>whitespaces</code> は1つ以上の空白を，<code>newlines</code> は1つ以上の改行をパースする．</p>
<p>で，まずは「プログラム」の部分のパーサーだ． プログラムは次のようなのをパースしたい：</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode go"><code class="sourceCode go"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="kw">package</span> main</span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a><span class="co">// 構造体や関数の定義</span></span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a><span class="kw">func</span> main<span class="op">()</span> <span class="op">{</span></span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true" tabindex="-1"></a>    _ <span class="op">=</span> <span class="op">..</span> <span class="co">// なんらかの式</span></span>
<span id="cb3-7"><a href="#cb3-7" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p>とりあえず，式や構造体の定義のパーサーはあるものと仮定して実装する：</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode elm"><code class="sourceCode elm"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="dt">Parser</span> <span class="kw">exposing</span> (<span class="op">..</span>)</span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="dt">Go</span><span class="op">.</span><span class="dt">Parser</span><span class="op">.</span><span class="dt">Helper</span> <span class="kw">exposing</span> (<span class="op">..</span>)</span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a><span class="fu">parser</span> : <span class="dt">Parser</span> <span class="dt">Program</span></span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a><span class="fu">parser</span> <span class="op">=</span></span>
<span id="cb4-6"><a href="#cb4-6" aria-hidden="true" tabindex="-1"></a>    <span class="kw">let</span></span>
<span id="cb4-7"><a href="#cb4-7" aria-hidden="true" tabindex="-1"></a>        <span class="fu">parseMainPackage</span> <span class="op">=</span> <span class="co">-- package main の部分</span></span>
<span id="cb4-8"><a href="#cb4-8" aria-hidden="true" tabindex="-1"></a>            <span class="fu">succeed</span> ()</span>
<span id="cb4-9"><a href="#cb4-9" aria-hidden="true" tabindex="-1"></a>                <span class="op">|.</span> <span class="fu">keyword</span> <span class="st">&quot;package&quot;</span></span>
<span id="cb4-10"><a href="#cb4-10" aria-hidden="true" tabindex="-1"></a>                <span class="op">|.</span> <span class="fu">whitespaces</span></span>
<span id="cb4-11"><a href="#cb4-11" aria-hidden="true" tabindex="-1"></a>                <span class="op">|.</span> <span class="fu">keyword</span> <span class="st">&quot;main&quot;</span></span>
<span id="cb4-12"><a href="#cb4-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-13"><a href="#cb4-13" aria-hidden="true" tabindex="-1"></a>        <span class="fu">parseMainFunc</span> <span class="op">=</span> <span class="co">-- func main() の部分</span></span>
<span id="cb4-14"><a href="#cb4-14" aria-hidden="true" tabindex="-1"></a>            <span class="fu">succeed</span> ()</span>
<span id="cb4-15"><a href="#cb4-15" aria-hidden="true" tabindex="-1"></a>                <span class="op">|.</span> <span class="fu">backtrackable</span> (<span class="fu">keyword</span> <span class="st">&quot;func&quot;</span>)</span>
<span id="cb4-16"><a href="#cb4-16" aria-hidden="true" tabindex="-1"></a>                <span class="op">|.</span> <span class="fu">backtrackable</span> <span class="fu">whitespaces</span></span>
<span id="cb4-17"><a href="#cb4-17" aria-hidden="true" tabindex="-1"></a>                <span class="op">|.</span> <span class="fu">keyword</span> <span class="st">&quot;main()&quot;</span></span>
<span id="cb4-18"><a href="#cb4-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-19"><a href="#cb4-19" aria-hidden="true" tabindex="-1"></a>        <span class="fu">parseMainExp</span> <span class="op">=</span> <span class="co">-- _ = e の部分</span></span>
<span id="cb4-20"><a href="#cb4-20" aria-hidden="true" tabindex="-1"></a>            <span class="fu">succeed</span> <span class="fu">identity</span></span>
<span id="cb4-21"><a href="#cb4-21" aria-hidden="true" tabindex="-1"></a>                <span class="op">|.</span> <span class="fu">symbol</span> <span class="st">&quot;_&quot;</span></span>
<span id="cb4-22"><a href="#cb4-22" aria-hidden="true" tabindex="-1"></a>                <span class="op">|.</span> <span class="fu">whitespaces</span></span>
<span id="cb4-23"><a href="#cb4-23" aria-hidden="true" tabindex="-1"></a>                <span class="op">|.</span> <span class="fu">symbol</span> <span class="st">&quot;=&quot;</span></span>
<span id="cb4-24"><a href="#cb4-24" aria-hidden="true" tabindex="-1"></a>                <span class="op">|.</span> <span class="fu">whitespaces</span></span>
<span id="cb4-25"><a href="#cb4-25" aria-hidden="true" tabindex="-1"></a>                <span class="op">|=</span> <span class="fu">expParser</span></span>
<span id="cb4-26"><a href="#cb4-26" aria-hidden="true" tabindex="-1"></a>    <span class="kw">in</span></span>
<span id="cb4-27"><a href="#cb4-27" aria-hidden="true" tabindex="-1"></a>    <span class="fu">succeed</span> <span class="dt">Program</span></span>
<span id="cb4-28"><a href="#cb4-28" aria-hidden="true" tabindex="-1"></a>        <span class="op">|.</span> <span class="fu">parseMainPackage</span></span>
<span id="cb4-29"><a href="#cb4-29" aria-hidden="true" tabindex="-1"></a>        <span class="op">|.</span> <span class="fu">newlines</span></span>
<span id="cb4-30"><a href="#cb4-30" aria-hidden="true" tabindex="-1"></a>        <span class="op">|=</span> <span class="fu">newlineSequence</span> <span class="fu">parseMainFunc</span> <span class="fu">declParser</span></span>
<span id="cb4-31"><a href="#cb4-31" aria-hidden="true" tabindex="-1"></a>        <span class="op">|.</span> <span class="fu">spaces</span></span>
<span id="cb4-32"><a href="#cb4-32" aria-hidden="true" tabindex="-1"></a>        <span class="op">|.</span> <span class="fu">symbol</span> <span class="st">&quot;{&quot;</span></span>
<span id="cb4-33"><a href="#cb4-33" aria-hidden="true" tabindex="-1"></a>        <span class="op">|.</span> <span class="fu">spaces</span></span>
<span id="cb4-34"><a href="#cb4-34" aria-hidden="true" tabindex="-1"></a>        <span class="op">|=</span> <span class="fu">parseMainExp</span></span>
<span id="cb4-35"><a href="#cb4-35" aria-hidden="true" tabindex="-1"></a>        <span class="op">|.</span> <span class="fu">spaces</span></span>
<span id="cb4-36"><a href="#cb4-36" aria-hidden="true" tabindex="-1"></a>        <span class="op">|.</span> <span class="fu">symbol</span> <span class="st">&quot;}&quot;</span></span>
<span id="cb4-37"><a href="#cb4-37" aria-hidden="true" tabindex="-1"></a>        <span class="op">|.</span> <span class="fu">spaces</span></span>
<span id="cb4-38"><a href="#cb4-38" aria-hidden="true" tabindex="-1"></a>        <span class="op">|.</span> <span class="dt">Parser</span><span class="op">.</span><span class="fu">end</span></span>
<span id="cb4-39"><a href="#cb4-39" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-40"><a href="#cb4-40" aria-hidden="true" tabindex="-1"></a><span class="fu">declParser</span> : <span class="dt">Parser</span> <span class="dt">Declaration</span></span>
<span id="cb4-41"><a href="#cb4-41" aria-hidden="true" tabindex="-1"></a><span class="fu">declParser</span> <span class="op">=</span> <span class="dt">Debug</span><span class="op">.</span><span class="fu">todo</span> <span class="st">&quot;Decl Parser&quot;</span></span>
<span id="cb4-42"><a href="#cb4-42" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-43"><a href="#cb4-43" aria-hidden="true" tabindex="-1"></a><span class="fu">expParser</span> : <span class="dt">Parser</span> <span class="dt">Expression</span></span>
<span id="cb4-44"><a href="#cb4-44" aria-hidden="true" tabindex="-1"></a><span class="fu">expParser</span> <span class="op">=</span> <span class="dt">Debug</span><span class="op">.</span><span class="fu">todo</span> <span class="st">&quot;Exp Parser&quot;</span></span></code></pre></div>
<p>基本的に <code>declParser</code> や <code>expParser</code> も同じように構文定義を見ながら実装していくだけなので割愛する（<a href="https://github.com/matsubara0507/featherweight-go/blob/4ce84918c80b0852b4c32989bdbfe29331ab1fe9/tests/Test/Go/Featherweight/Syntax.elm">コード</a>）． 1つだけ，なんらかの変数をパースするパーサーだけは書いておく． elm/parser には <code>variable</code> というまさにこれをやるパーサーコンビネーターがあるのでこれを利用する：</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode elm"><code class="sourceCode elm"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="fu">nameParser</span> : <span class="dt">Parser</span> <span class="dt">String</span></span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a><span class="fu">nameParser</span> <span class="op">=</span></span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a>    <span class="fu">variable</span></span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a>        { <span class="fu">start</span> <span class="op">=</span> <span class="dt">Char</span><span class="op">.</span><span class="fu">isAlphaNum</span> <span class="co">-- 先頭文字，小文字や数字を含まないとかできる</span></span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a>        <span class="op">,</span> <span class="fu">inner</span> <span class="op">=</span> \<span class="fu">c</span> <span class="op">-&gt;</span> <span class="dt">Char</span><span class="op">.</span><span class="fu">isAlphaNum</span> <span class="fu">c</span> <span class="op">||</span> <span class="fu">c</span> <span class="op">==</span> <span class="ch">&#39;_&#39;</span></span>
<span id="cb5-6"><a href="#cb5-6" aria-hidden="true" tabindex="-1"></a>        <span class="op">,</span> <span class="fu">reserved</span> <span class="op">=</span> <span class="fu">keywords</span>     <span class="co">-- 変数にはならない予約を列挙する</span></span>
<span id="cb5-7"><a href="#cb5-7" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb5-8"><a href="#cb5-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-9"><a href="#cb5-9" aria-hidden="true" tabindex="-1"></a><span class="fu">keywords</span> : <span class="dt">Set</span> <span class="dt">String</span></span>
<span id="cb5-10"><a href="#cb5-10" aria-hidden="true" tabindex="-1"></a><span class="fu">keywords</span> <span class="op">=</span></span>
<span id="cb5-11"><a href="#cb5-11" aria-hidden="true" tabindex="-1"></a>    <span class="dt">Set</span><span class="op">.</span><span class="fu">fromList</span></span>
<span id="cb5-12"><a href="#cb5-12" aria-hidden="true" tabindex="-1"></a>        [ <span class="st">&quot;package&quot;</span></span>
<span id="cb5-13"><a href="#cb5-13" aria-hidden="true" tabindex="-1"></a>        <span class="op">,</span> <span class="st">&quot;main&quot;</span></span>
<span id="cb5-14"><a href="#cb5-14" aria-hidden="true" tabindex="-1"></a>        <span class="op">,</span> <span class="st">&quot;func&quot;</span></span>
<span id="cb5-15"><a href="#cb5-15" aria-hidden="true" tabindex="-1"></a>        <span class="op">,</span> <span class="st">&quot;struct&quot;</span></span>
<span id="cb5-16"><a href="#cb5-16" aria-hidden="true" tabindex="-1"></a>        <span class="op">,</span> <span class="st">&quot;interface&quot;</span></span>
<span id="cb5-17"><a href="#cb5-17" aria-hidden="true" tabindex="-1"></a>        <span class="op">,</span> <span class="st">&quot;type&quot;</span></span>
<span id="cb5-18"><a href="#cb5-18" aria-hidden="true" tabindex="-1"></a>        <span class="op">,</span> <span class="st">&quot;return&quot;</span></span>
<span id="cb5-19"><a href="#cb5-19" aria-hidden="true" tabindex="-1"></a>        ]</span></code></pre></div>
<h3 id="テスト">テスト</h3>
<p>とりあえず簡単に，FGの論文にあるサンプルコードが動作するかのテストだけを書いた：</p>
<div class="sourceCode" id="cb6"><pre class="sourceCode elm"><code class="sourceCode elm"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="kw">module</span> <span class="dt">Test</span><span class="op">.</span><span class="dt">Go</span><span class="op">.</span><span class="dt">Featherweight</span><span class="op">.</span><span class="dt">Syntax</span> <span class="kw">exposing</span> (<span class="fu">suite</span>)</span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="dt">Go</span><span class="op">.</span><span class="dt">Featherweight</span><span class="op">.</span><span class="dt">Syntax</span> <span class="kw">exposing</span> (<span class="op">..</span>)</span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="dt">Parser</span></span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="dt">Test</span> <span class="kw">exposing</span> (<span class="op">..</span>)</span>
<span id="cb6-6"><a href="#cb6-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-7"><a href="#cb6-7" aria-hidden="true" tabindex="-1"></a><span class="fu">suite</span> : <span class="dt">Test</span></span>
<span id="cb6-8"><a href="#cb6-8" aria-hidden="true" tabindex="-1"></a><span class="fu">suite</span> <span class="op">=</span></span>
<span id="cb6-9"><a href="#cb6-9" aria-hidden="true" tabindex="-1"></a>    <span class="fu">describe</span> <span class="st">&quot;module Go.Featherweight.Syntax&quot;</span></span>
<span id="cb6-10"><a href="#cb6-10" aria-hidden="true" tabindex="-1"></a>        [ <span class="fu">describe</span> <span class="st">&quot;parser&quot;</span></span>
<span id="cb6-11"><a href="#cb6-11" aria-hidden="true" tabindex="-1"></a>            [ <span class="fu">test</span> <span class="st">&quot;parse sample FG code&quot;</span> <span class="op">&lt;|</span></span>
<span id="cb6-12"><a href="#cb6-12" aria-hidden="true" tabindex="-1"></a>                \<span class="fu">_</span> <span class="op">-&gt;</span></span>
<span id="cb6-13"><a href="#cb6-13" aria-hidden="true" tabindex="-1"></a>                    <span class="dt">Parser</span><span class="op">.</span><span class="fu">run</span> <span class="fu">parser</span> <span class="fu">sample</span></span>
<span id="cb6-14"><a href="#cb6-14" aria-hidden="true" tabindex="-1"></a>                        <span class="op">|&gt;</span> <span class="dt">Expect</span><span class="op">.</span><span class="fu">equal</span> (<span class="dt">Ok</span> <span class="op">&lt;|</span> { <span class="fu">decls</span> <span class="op">=</span> <span class="op">...,</span> <span class="fu">exp</span> <span class="op">=</span> <span class="op">...</span> }</span>
<span id="cb6-15"><a href="#cb6-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-16"><a href="#cb6-16" aria-hidden="true" tabindex="-1"></a><span class="fu">sample</span> : <span class="dt">String</span></span>
<span id="cb6-17"><a href="#cb6-17" aria-hidden="true" tabindex="-1"></a><span class="fu">sample</span> <span class="op">=</span></span>
<span id="cb6-18"><a href="#cb6-18" aria-hidden="true" tabindex="-1"></a>    <span class="dt">String</span><span class="op">.</span><span class="fu">dropLeft</span> <span class="dv">1</span></span>
<span id="cb6-19"><a href="#cb6-19" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;&quot;&quot;</span></span>
<span id="cb6-20"><a href="#cb6-20" aria-hidden="true" tabindex="-1"></a><span class="st">package main</span></span>
<span id="cb6-21"><a href="#cb6-21" aria-hidden="true" tabindex="-1"></a><span class="st">type Any interface {}</span></span>
<span id="cb6-22"><a href="#cb6-22" aria-hidden="true" tabindex="-1"></a><span class="st">type Function interface {</span></span>
<span id="cb6-23"><a href="#cb6-23" aria-hidden="true" tabindex="-1"></a><span class="st">    Apply(x Any) Any</span></span>
<span id="cb6-24"><a href="#cb6-24" aria-hidden="true" tabindex="-1"></a><span class="st">}</span></span>
<span id="cb6-25"><a href="#cb6-25" aria-hidden="true" tabindex="-1"></a><span class="st">type incr struct { n int }</span></span>
<span id="cb6-26"><a href="#cb6-26" aria-hidden="true" tabindex="-1"></a><span class="st">func (this incr) Apply(x Any) Any {</span></span>
<span id="cb6-27"><a href="#cb6-27" aria-hidden="true" tabindex="-1"></a><span class="st">    return this.n.add(x.(int))</span></span>
<span id="cb6-28"><a href="#cb6-28" aria-hidden="true" tabindex="-1"></a><span class="st">}</span></span>
<span id="cb6-29"><a href="#cb6-29" aria-hidden="true" tabindex="-1"></a><span class="st">type pos struct {}</span></span>
<span id="cb6-30"><a href="#cb6-30" aria-hidden="true" tabindex="-1"></a><span class="st">func (this pos) Apply(x Any) Any {</span></span>
<span id="cb6-31"><a href="#cb6-31" aria-hidden="true" tabindex="-1"></a><span class="st">    return x.(int).lt(zero)</span></span>
<span id="cb6-32"><a href="#cb6-32" aria-hidden="true" tabindex="-1"></a><span class="st">}</span></span>
<span id="cb6-33"><a href="#cb6-33" aria-hidden="true" tabindex="-1"></a><span class="st">type compose struct {</span></span>
<span id="cb6-34"><a href="#cb6-34" aria-hidden="true" tabindex="-1"></a><span class="st">    f Function</span></span>
<span id="cb6-35"><a href="#cb6-35" aria-hidden="true" tabindex="-1"></a><span class="st">    g Function</span></span>
<span id="cb6-36"><a href="#cb6-36" aria-hidden="true" tabindex="-1"></a><span class="st">}</span></span>
<span id="cb6-37"><a href="#cb6-37" aria-hidden="true" tabindex="-1"></a><span class="st">func (this compose) Apply(x Any) Any {</span></span>
<span id="cb6-38"><a href="#cb6-38" aria-hidden="true" tabindex="-1"></a><span class="st">    return this.g.Apply(this.f.Apply(x))</span></span>
<span id="cb6-39"><a href="#cb6-39" aria-hidden="true" tabindex="-1"></a><span class="st">}</span></span>
<span id="cb6-40"><a href="#cb6-40" aria-hidden="true" tabindex="-1"></a><span class="st">func main(){</span></span>
<span id="cb6-41"><a href="#cb6-41" aria-hidden="true" tabindex="-1"></a><span class="st">    _ = compose{incr{x}, pos{}}.Apply(y).(bool)</span></span>
<span id="cb6-42"><a href="#cb6-42" aria-hidden="true" tabindex="-1"></a><span class="st">}</span></span>
<span id="cb6-43"><a href="#cb6-43" aria-hidden="true" tabindex="-1"></a><span class="st">&quot;&quot;&quot;</span></span></code></pre></div>
<h2 id="fgの型検査器を作る">FGの型検査器を作る</h2>
<p>型検査器を作るにはとりあえず，論文の型付け規則（3.3節の図11）をそのまんま実装していけばいい． まぁまぁ量があるので型付け規則自体は載せません（論文を見て）．</p>
<h3 id="例プログラムの型付け規則">例：プログラムの型付け規則</h3>
<p>全部載せると膨大なので，「プログラム」の型付け規則とその実装だけ． 型付け規則は次のようになっている：</p>
<pre><code>distinct(tdecls(seq(D)))
distinct(mdecls(seq(D)))
seq(D ok)
[] |- e : t
---------------------------------------------
package main; seq(D) func main { _ = e } ok</code></pre>
<p>数式で書くの大変なので，だいぶ本来の記法と離れちゃってますが雰囲気として，<code>---</code> より上が全て成り立てば下が成り立つという感じ． 下の <code>... ok</code> というのは「プログラム」が正しく型付けされていることを意味しており，上のそれぞれは：</p>
<ul>
<li><code>D</code> というのは型（構造体・インターフェース）の宣言かメソッドの宣言</li>
<li><code>seq(D)</code> は <code>D</code> のリスト（シーケンス）</li>
<li><code>tdecls(seq(D))</code> は <code>seq(D)</code> のうち型の宣言だけを集めたもの</li>
<li><code>mdecls(seq(D))</code> は <code>seq(D)</code> のうちメソッドの宣言だけを集めたもの</li>
<li><code>distinct(xs)</code> は <code>xs</code> 内に重複がないことを意味する（つまり，型やメソッドが重複してたらダメ）</li>
<li><code>D ok</code> は宣言 <code>D</code> が正しく型付けされていることを意味する</li>
<li><code>seq(D ok)</code> は <code>seq(D)</code> の全ての宣言が正しく型付けされていることを意味する</li>
<li><code>[] |- e : t</code> は式 <code>e</code> がなんらかの型 <code>t</code> で型付けされていることを意味する</li>
</ul>
<p>最後ので <code>[]</code> は空の型環境を意味している． 型環境はある式がどの型になるかの辞書だ． つまり，Elm で実装するとこんな感じ：</p>
<div class="sourceCode" id="cb8"><pre class="sourceCode elm"><code class="sourceCode elm"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="kw">module</span> <span class="dt">Go</span><span class="op">.</span><span class="dt">Featherweight</span><span class="op">.</span><span class="dt">Type</span> <span class="kw">exposing</span> (<span class="op">..</span>)</span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="dt">Dict</span> <span class="kw">exposing</span> (<span class="dt">Dict</span>)</span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="dt">Go</span><span class="op">.</span><span class="dt">Featherweight</span><span class="op">.</span><span class="dt">Syntax</span> <span class="kw">as</span> <span class="dt">FG</span> <span class="kw">exposing</span> (<span class="op">..</span>)</span>
<span id="cb8-5"><a href="#cb8-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-6"><a href="#cb8-6" aria-hidden="true" tabindex="-1"></a><span class="kw">type</span> <span class="kw">alias</span> <span class="dt">Gamma</span> <span class="op">=</span></span>
<span id="cb8-7"><a href="#cb8-7" aria-hidden="true" tabindex="-1"></a>    <span class="dt">Dict</span> <span class="dt">VarName</span> <span class="dt">TypeName</span></span></code></pre></div>
<p>また，型検査をするには <code>seq(D)</code> で宣言されている型やメソッドの情報が必要だ． 論文の数理論理学的な定義では，情報が必要になるたびに <code>seq(D)</code> から引っ張ってきている． しかし，実際のプログラムでそれをやると効率が悪いので，事前にそのような辞書を環境（<code>Env</code>）として定義しておく：</p>
<div class="sourceCode" id="cb9"><pre class="sourceCode elm"><code class="sourceCode elm"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="kw">type</span> <span class="kw">alias</span> <span class="dt">Env</span> <span class="op">=</span></span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a>    ( <span class="dt">Gamma</span><span class="op">,</span> <span class="dt">DeclMap</span> )</span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true" tabindex="-1"></a><span class="co">-- 型名をキー</span></span>
<span id="cb9-5"><a href="#cb9-5" aria-hidden="true" tabindex="-1"></a><span class="co">-- 型の情報（`TypeLiteral`）とメソッドの情報（`MethodSpecific`）が値</span></span>
<span id="cb9-6"><a href="#cb9-6" aria-hidden="true" tabindex="-1"></a><span class="kw">type</span> <span class="kw">alias</span> <span class="dt">DeclMap</span> <span class="op">=</span></span>
<span id="cb9-7"><a href="#cb9-7" aria-hidden="true" tabindex="-1"></a>    <span class="dt">Dict</span> <span class="dt">TypeName</span> ( <span class="dt">TypeLiteral</span><span class="op">,</span> <span class="dt">List</span> <span class="dt">MethodSpecific</span> )</span>
<span id="cb9-8"><a href="#cb9-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-9"><a href="#cb9-9" aria-hidden="true" tabindex="-1"></a><span class="fu">newEnv</span> : <span class="dt">List</span> <span class="dt">Declaration</span> <span class="op">-&gt;</span> <span class="dt">Env</span></span>
<span id="cb9-10"><a href="#cb9-10" aria-hidden="true" tabindex="-1"></a><span class="fu">newEnv</span> <span class="fu">decls</span> <span class="op">=</span></span>
<span id="cb9-11"><a href="#cb9-11" aria-hidden="true" tabindex="-1"></a>    ( <span class="dt">Dict</span><span class="op">.</span><span class="fu">empty</span><span class="op">,</span> <span class="fu">mkDeclMap</span> <span class="fu">decls</span> )</span>
<span id="cb9-12"><a href="#cb9-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-13"><a href="#cb9-13" aria-hidden="true" tabindex="-1"></a><span class="fu">mkDeclMap</span> : <span class="dt">List</span> <span class="dt">Declaration</span> <span class="op">-&gt;</span> <span class="dt">DeclMap</span></span>
<span id="cb9-14"><a href="#cb9-14" aria-hidden="true" tabindex="-1"></a><span class="fu">mkDeclMap</span> <span class="fu">decls</span> <span class="op">=</span> <span class="op">...</span> <span class="co">-- ちょっと複雑なので割愛</span></span></code></pre></div>
<p>で，「プログラム」の型付け規則をそのまんま実装すると次のようになる：</p>
<div class="sourceCode" id="cb10"><pre class="sourceCode elm"><code class="sourceCode elm"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="kw">module</span> <span class="dt">Go</span><span class="op">.</span><span class="dt">Featherweight</span><span class="op">.</span><span class="dt">Type</span> <span class="kw">exposing</span> (<span class="op">..</span>)</span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a><span class="fu">check</span> : <span class="dt">FG</span><span class="op">.</span><span class="dt">Program</span> <span class="op">-&gt;</span> <span class="dt">Result</span> <span class="dt">TypeError</span> ()</span>
<span id="cb10-4"><a href="#cb10-4" aria-hidden="true" tabindex="-1"></a><span class="fu">check</span> <span class="fu">p</span> <span class="op">=</span></span>
<span id="cb10-5"><a href="#cb10-5" aria-hidden="true" tabindex="-1"></a>    <span class="kw">let</span></span>
<span id="cb10-6"><a href="#cb10-6" aria-hidden="true" tabindex="-1"></a>        <span class="fu">env</span> <span class="op">=</span></span>
<span id="cb10-7"><a href="#cb10-7" aria-hidden="true" tabindex="-1"></a>            <span class="fu">newEnv</span> <span class="fu">p</span><span class="op">.</span><span class="fu">decls</span></span>
<span id="cb10-8"><a href="#cb10-8" aria-hidden="true" tabindex="-1"></a>        <span class="fu">dmap</span> <span class="op">=</span></span>
<span id="cb10-9"><a href="#cb10-9" aria-hidden="true" tabindex="-1"></a>            <span class="dt">Tuple</span><span class="op">.</span><span class="fu">second</span> <span class="fu">env</span></span>
<span id="cb10-10"><a href="#cb10-10" aria-hidden="true" tabindex="-1"></a>    <span class="kw">in</span></span>
<span id="cb10-11"><a href="#cb10-11" aria-hidden="true" tabindex="-1"></a>    <span class="fu">combine_</span></span>
<span id="cb10-12"><a href="#cb10-12" aria-hidden="true" tabindex="-1"></a>        [ <span class="fu">distinct</span> (<span class="fu">tdecls</span> <span class="fu">p</span><span class="op">.</span><span class="fu">decls</span>)</span>
<span id="cb10-13"><a href="#cb10-13" aria-hidden="true" tabindex="-1"></a>            <span class="op">|&gt;</span> <span class="dt">Result</span><span class="op">.</span><span class="fu">mapError</span> (<span class="dt">DuplicatedDefinition</span> <span class="st">&quot;type&quot;</span>)</span>
<span id="cb10-14"><a href="#cb10-14" aria-hidden="true" tabindex="-1"></a>        <span class="op">,</span> <span class="fu">distinct</span> (<span class="fu">mdecls</span> <span class="fu">p</span><span class="op">.</span><span class="fu">decls</span>)</span>
<span id="cb10-15"><a href="#cb10-15" aria-hidden="true" tabindex="-1"></a>            <span class="op">|&gt;</span> <span class="dt">Result</span><span class="op">.</span><span class="fu">mapError</span> (\( <span class="fu">x</span><span class="op">,</span> <span class="fu">y</span> ) <span class="op">-&gt;</span> <span class="dt">DuplicatedDefinition</span> <span class="st">&quot;method&quot;</span> (<span class="fu">x</span> <span class="op">++</span> <span class="st">&quot;.&quot;</span> <span class="op">++</span> <span class="fu">y</span>))</span>
<span id="cb10-16"><a href="#cb10-16" aria-hidden="true" tabindex="-1"></a>        <span class="op">,</span> <span class="fu">combine_</span> (<span class="dt">List</span><span class="op">.</span><span class="fu">map</span> (<span class="fu">checkDeclWith</span> <span class="fu">dmap</span>) <span class="fu">p</span><span class="op">.</span><span class="fu">decls</span>)</span>
<span id="cb10-17"><a href="#cb10-17" aria-hidden="true" tabindex="-1"></a>        <span class="op">,</span> <span class="fu">typeInferWith</span> <span class="fu">env</span> <span class="fu">p</span><span class="op">.</span><span class="fu">exp</span></span>
<span id="cb10-18"><a href="#cb10-18" aria-hidden="true" tabindex="-1"></a>            <span class="op">|&gt;</span> <span class="dt">Result</span><span class="op">.</span><span class="fu">map</span> (<span class="fu">always</span> ())</span>
<span id="cb10-19"><a href="#cb10-19" aria-hidden="true" tabindex="-1"></a>        ]</span>
<span id="cb10-20"><a href="#cb10-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-21"><a href="#cb10-21" aria-hidden="true" tabindex="-1"></a><span class="co">-- `Result.combine` は `Result e a` を返すが</span></span>
<span id="cb10-22"><a href="#cb10-22" aria-hidden="true" tabindex="-1"></a><span class="co">-- `Result e ()` を返す関数が欲しかった</span></span>
<span id="cb10-23"><a href="#cb10-23" aria-hidden="true" tabindex="-1"></a><span class="fu">combine_</span> : <span class="dt">List</span> (<span class="dt">Result</span> <span class="fu">e</span> <span class="fu">a</span>) <span class="op">-&gt;</span> <span class="dt">Result</span> <span class="fu">e</span> ()</span>
<span id="cb10-24"><a href="#cb10-24" aria-hidden="true" tabindex="-1"></a><span class="fu">combine_</span> <span class="op">=</span></span>
<span id="cb10-25"><a href="#cb10-25" aria-hidden="true" tabindex="-1"></a>    <span class="dt">Result</span><span class="op">.</span><span class="fu">map</span> (<span class="fu">always</span> ()) <span class="op">&lt;&lt;</span> <span class="dt">Result</span><span class="op">.</span><span class="fu">combine</span></span>
<span id="cb10-26"><a href="#cb10-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-27"><a href="#cb10-27" aria-hidden="true" tabindex="-1"></a><span class="co">-- 重複のチェックは</span></span>
<span id="cb10-28"><a href="#cb10-28" aria-hidden="true" tabindex="-1"></a><span class="co">-- 型の場合は型名が重複してないかどうか</span></span>
<span id="cb10-29"><a href="#cb10-29" aria-hidden="true" tabindex="-1"></a><span class="co">-- メソッドの場合は型名+メソッド名が重複してないかどうか</span></span>
<span id="cb10-30"><a href="#cb10-30" aria-hidden="true" tabindex="-1"></a><span class="fu">distinct</span> : <span class="dt">List</span> <span class="fu">comparable</span> <span class="op">-&gt;</span> <span class="dt">Result</span> <span class="fu">comparable</span> ()</span>
<span id="cb10-31"><a href="#cb10-31" aria-hidden="true" tabindex="-1"></a><span class="fu">tdecls</span> : <span class="dt">List</span> <span class="dt">Declaration</span> <span class="op">-&gt;</span> <span class="dt">List</span> <span class="dt">TypeName</span></span>
<span id="cb10-32"><a href="#cb10-32" aria-hidden="true" tabindex="-1"></a><span class="fu">mdecls</span> : <span class="dt">List</span> <span class="dt">Declaration</span> <span class="op">-&gt;</span> <span class="dt">List</span> ( <span class="dt">TypeName</span><span class="op">,</span> <span class="dt">MethodName</span> )</span>
<span id="cb10-33"><a href="#cb10-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-34"><a href="#cb10-34" aria-hidden="true" tabindex="-1"></a><span class="fu">checkDeclWith</span> : <span class="dt">DeclMap</span> <span class="op">-&gt;</span> <span class="dt">Declaration</span> <span class="op">-&gt;</span> <span class="dt">Result</span> <span class="dt">TypeError</span> ()</span>
<span id="cb10-35"><a href="#cb10-35" aria-hidden="true" tabindex="-1"></a><span class="fu">checkDeclWith</span> <span class="fu">dmap</span> <span class="fu">d</span> <span class="op">=</span> <span class="op">...</span></span>
<span id="cb10-36"><a href="#cb10-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-37"><a href="#cb10-37" aria-hidden="true" tabindex="-1"></a><span class="fu">typeInferWith</span> : <span class="dt">Env</span> <span class="op">-&gt;</span> <span class="dt">Expression</span> <span class="op">-&gt;</span> <span class="dt">Result</span> <span class="dt">TypeError</span> <span class="dt">TypeName</span></span>
<span id="cb10-38"><a href="#cb10-38" aria-hidden="true" tabindex="-1"></a><span class="fu">typeInferWith</span> <span class="fu">env</span> <span class="fu">exp</span> <span class="op">=</span> <span class="op">...</span></span></code></pre></div>
<p><code>checkDeclWith</code> は与えた宣言（<code>Declaration</code>）が正しく型付けされているかどうかをチェックする． つまり <code>D ok</code> にあたる． <code>typeInferWith</code> は2引数目の式（<code>Expression</code>）の型を推論して返す関数だ． 推論できない場合は <code>TypeError</code> を返し，推論できた場合はその型名を返す． 「プログラム」の <code>e</code> の場合，どんな型に推論されても問題ないので <code>Result.map (always ())</code> で結果を破棄している．</p>
<p>これを型付け規則分作らないといけない． まぁまぁしんどかった．</p>
<h2 id="webページを作る">Webページを作る</h2>
<p>Elm なので，FGのコードを書くと型検査してくれるページを作った：</p>
<p><img src="/assets/fg-with-elm/fg-parser-page.jpg" /></p>
<p>やっていることは簡単で，テキストエリアの文字列を <code>Go.Featherweight.Syntax.parser</code> でパースして <code>Program</code> 型の値を作り，それをそのまま <code>Go.Featherweight.Type.check</code> しているだけ． そして，結果がエラーだったらそのエラーメッセージを出力して，エラーでなければ「OK」って出しているだけ．</p>
<h2 id="おしまい">おしまい</h2>
<p>作ってから時間が経ってしまったので，記事が結構雑だ．．． その２では Featherweight Generics Go のパーサーと型検査器です．</p>]]></content>
    </entry>
</feed>
