<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE html>
<html lang="ja">

  <head>
  <meta charset="utf-8">
  <link rel="icon" href="../assets/icon.jpg">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
    
      <meta property="og:title" content="Elchemy 入門 : その２" />
    
  

  <meta property="og:site_name" content="ひげメモ" />

  

  
    <script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-86386380-1', 'auto');
  ga('send', 'pageview');
</script>

  

  <title>
    
      
        Elchemy 入門 : その２
      
    
  </title>

  <link rel="stylesheet" href="../css/main.css">
  <link rel="stylesheet" href="../css/highlight.css">
  <link rel="stylesheet" type="text/css" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.4.0/css/font-awesome.min.css" />
</head>


  <body>
      <div class="outer">

        <header class="site-header">

  <div class="wrapper">

    <a class="site-title" href="https://matsubara0507.github.io/">ひげメモ</a>

  </div>

  <div class="header-badge">
    <a href="https://matsubara0507.github.io/">
        <img src="../assets/icon.jpg" />
    </a>
  </div>

</header>


        <div class="page-content">
          <div class="wrapper">
            <article class="post card" itemscope itemtype="http://schema.org/BlogPosting">
 <div class="card-content">
  <header class="post-header">
    <h1 class="post-title" itemprop="name headline">Elchemy 入門 : その２</h1>
    <p class="post-meta">
      <time datetime="2018-06-16" itemprop="datePublished">
        Jun 16, 2018
      </time>
      
      
      <div class="tags">
          <i class="fa fa-tags"></i> <a href="../tags/Elchemy.html">Elchemy</a> <a href="../tags/Elm.html">Elm</a> <a href="../tags/Elixir.html">Elixir</a>
      </div>
      
    </p>
  </header>

  <div class="post-content" itemprop="articleBody">
    <p>Elm から Elixir のトランスパイラ，<a href="https://github.com/wende/elmchemy">Elchemy</a> についてイロイロと調べたのでまとめていきます． <a href="https://matsubara0507.github.io/posts/2018-06-15-introduce-elchemy-part1.html">前回はコチラ</a>． 今回は</p>
<ul>
<li><a href="https://hackernoon.com/elmchemy-write-type-safe-elixir-code-with-elms-syntax-part-2-our-own-rpg-character-module-cedbf7da138d">Tutorial その２</a>をやってみた</li>
<li>Phoenix で ToDo アプリを作る</li>
</ul>
<p>の2本立てです． ちなみに，現在のバージョンは 0.7.4 です．</p>
<h2 id="tutorial-そのをやってみた">Tutorial その２をやってみた</h2>
<p>Tutorial その２では Elchemy を利用した独自ライブラリを作成する． 以下の手順で行うそうだ．</p>
<ol type="1">
<li>エイリアス型を定義</li>
<li>ユニオン型を定義</li>
<li>関数としてエイリアスやタグを用いる</li>
<li>ユニオン型でのパターンマッチ</li>
<li>関数として演算子を使う・独自の演算子を定義する</li>
<li>別のモジュールから型やエイリアス型をインポートする</li>
</ol>
<p>基本的に Elm の書き方講座みたいなものなので，最悪っ困ったら Elm を勉強してください(丸投げ)． ちなみに，元記事の全てを細かく追従せず，ざっくりと掻い摘んで書き出している． なので細かくは元記事を読んでね．</p>
<h2 id="section"></h2>
<p>あと，<a href="https://github.com/wende/elmchemy-article-example">このコードは全て作者さんが GitHub に挙げている</a>．</p>
<h3 id="その前に">その前に</h3>
<p>テストを書こう，ということでテストを Elixir で書いている． 今回の作成するライブラリはどうやら，ゲームか何かのキャラを制御する物らしい</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode elixir"><code class="sourceCode elixir"><a class="sourceLine" id="cb1-1" title="1"><span class="co"># character_test.exs</span></a>
<a class="sourceLine" id="cb1-2" title="2"><span class="kw">defmodule</span> <span class="cn">CharacterTest</span> <span class="kw">do</span></a>
<a class="sourceLine" id="cb1-3" title="3">  <span class="im">use</span> <span class="cn">ExUnit</span><span class="op">.</span><span class="cn">Case</span></a>
<a class="sourceLine" id="cb1-4" title="4">  <span class="im">use</span> <span class="cn">Elchemy</span></a>
<a class="sourceLine" id="cb1-5" title="5"></a>
<a class="sourceLine" id="cb1-6" title="6">  test <span class="st">&quot;Character has name, last name and such&quot;</span> <span class="kw">do</span></a>
<a class="sourceLine" id="cb1-7" title="7">      gordon <span class="op">=</span> <span class="cn">Character</span><span class="op">.</span>new(<span class="st">&quot;Gordon&quot;</span>, <span class="st">&quot;Freemonad&quot;</span>, <span class="va">:male</span>)</a>
<a class="sourceLine" id="cb1-8" title="8"></a>
<a class="sourceLine" id="cb1-9" title="9">      assert gordon<span class="op">.</span>name <span class="op">==</span> <span class="st">&quot;Gordon&quot;</span></a>
<a class="sourceLine" id="cb1-10" title="10">      assert gordon<span class="op">.</span>surname <span class="op">==</span> <span class="st">&quot;Freemonad&quot;</span></a>
<a class="sourceLine" id="cb1-11" title="11">      assert gordon<span class="op">.</span>gender <span class="op">==</span> <span class="va">:male</span></a>
<a class="sourceLine" id="cb1-12" title="12">  <span class="kw">end</span></a>
<a class="sourceLine" id="cb1-13" title="13"></a>
<a class="sourceLine" id="cb1-14" title="14">  test <span class="st">&quot;Has stats&quot;</span> <span class="kw">do</span></a>
<a class="sourceLine" id="cb1-15" title="15">    gordon <span class="op">=</span> <span class="cn">Character</span><span class="op">.</span>new(<span class="st">&quot;Gordon&quot;</span>, <span class="st">&quot;Freemonad&quot;</span>, <span class="va">:male</span>)</a>
<a class="sourceLine" id="cb1-16" title="16"></a>
<a class="sourceLine" id="cb1-17" title="17">    stats <span class="op">=</span> [<span class="va">:strength</span>, <span class="va">:intelligence</span>, <span class="va">:vitality</span>]</a>
<a class="sourceLine" id="cb1-18" title="18">    <span class="kw">for</span> s <span class="op">&lt;-</span> stats <span class="kw">do</span></a>
<a class="sourceLine" id="cb1-19" title="19">      assert is_integer(gordon<span class="op">.</span>stats[s]), <span class="st">&quot;No </span><span class="ot">#{</span>s<span class="ot">}</span><span class="st"> stat in </span><span class="ot">#{</span>inspect gordon<span class="ot">}</span><span class="st">&quot;</span></a>
<a class="sourceLine" id="cb1-20" title="20">    <span class="kw">end</span></a>
<a class="sourceLine" id="cb1-21" title="21"></a>
<a class="sourceLine" id="cb1-22" title="22">    assert <span class="cn">Character</span><span class="op">.</span>set_stat(<span class="va">:vitality</span>, <span class="dv">10</span>, gordon)<span class="op">.</span>stats<span class="op">.</span>vitality <span class="op">==</span> <span class="dv">10</span></a>
<a class="sourceLine" id="cb1-23" title="23">  <span class="kw">end</span></a>
<a class="sourceLine" id="cb1-24" title="24"></a>
<a class="sourceLine" id="cb1-25" title="25">  test <span class="st">&quot;Boosting visality boosts health&quot;</span> <span class="kw">do</span></a>
<a class="sourceLine" id="cb1-26" title="26">    gordon <span class="op">=</span> <span class="cn">Character</span><span class="op">.</span>new(<span class="st">&quot;Gordon&quot;</span>, <span class="st">&quot;Freemonad&quot;</span>, <span class="va">:male</span>)</a>
<a class="sourceLine" id="cb1-27" title="27"></a>
<a class="sourceLine" id="cb1-28" title="28">    { hp, packed_gordon_max } <span class="op">=</span> <span class="cn">Character</span><span class="op">.</span>set_stat(<span class="va">:vitality</span>, <span class="dv">10</span>, gordon)<span class="op">.</span>health</a>
<a class="sourceLine" id="cb1-29" title="29">    { _, weak_gordon_max }    <span class="op">=</span> <span class="cn">Character</span><span class="op">.</span>set_stat(<span class="va">:vitality</span>, <span class="dv">0</span>, gordon)<span class="op">.</span>health</a>
<a class="sourceLine" id="cb1-30" title="30"></a>
<a class="sourceLine" id="cb1-31" title="31">    assert packed_gordon_max <span class="op">&gt;</span> weak_gordon_max</a>
<a class="sourceLine" id="cb1-32" title="32">    assert hp <span class="op">==</span> packed_gordon_max</a>
<a class="sourceLine" id="cb1-33" title="33">  <span class="kw">end</span></a>
<a class="sourceLine" id="cb1-34" title="34"></a>
<a class="sourceLine" id="cb1-35" title="35">  test <span class="st">&quot;Can equip weapon only if intelligence is enough&quot;</span> <span class="kw">do</span></a>
<a class="sourceLine" id="cb1-36" title="36">    gordon <span class="op">=</span> <span class="cn">Character</span><span class="op">.</span>new(<span class="st">&quot;Gordon&quot;</span>, <span class="st">&quot;Freemonad&quot;</span>, <span class="va">:male</span>)</a>
<a class="sourceLine" id="cb1-37" title="37">    weapon <span class="op">=</span> <span class="cn">Weapon</span><span class="op">.</span>new(<span class="st">&quot;Sci fi blaster thingy&quot;</span>, <span class="dv">9</span> ,<span class="dv">100</span>)</a>
<a class="sourceLine" id="cb1-38" title="38"></a>
<a class="sourceLine" id="cb1-39" title="39">    dumb_gordon <span class="op">=</span> <span class="cn">Character</span><span class="op">.</span>set_stat(<span class="va">:intelligence</span>, <span class="dv">0</span>, gordon)</a>
<a class="sourceLine" id="cb1-40" title="40">    smart_gordon <span class="op">=</span> <span class="cn">Character</span><span class="op">.</span>set_stat(<span class="va">:intelligence</span>, <span class="dv">10</span>, gordon)</a>
<a class="sourceLine" id="cb1-41" title="41"></a>
<a class="sourceLine" id="cb1-42" title="42">    assert {<span class="va">:error</span>, <span class="st">&quot;Too dumb&quot;</span>} <span class="op">=</span> <span class="cn">Character</span><span class="op">.</span>equip(weapon, dumb_gordon)</a>
<a class="sourceLine" id="cb1-43" title="43">    assert {<span class="va">:ok</span>, equipped_gordon} <span class="op">=</span> <span class="cn">Character</span><span class="op">.</span>equip(weapon, smart_gordon)</a>
<a class="sourceLine" id="cb1-44" title="44">    assert equipped_gordon<span class="op">.</span>arm <span class="op">==</span> {weapon}</a>
<a class="sourceLine" id="cb1-45" title="45">  <span class="kw">end</span></a>
<a class="sourceLine" id="cb1-46" title="46"><span class="kw">end</span></a></code></pre></div>
<h3 id="キャラクターを定義">キャラクターを定義</h3>
<h4 id="型エイリアス">1. 型エイリアス</h4>
<p>関数型なのでまずはドメインモデルの型を定義する． テストより，<code>name</code> <code>surname</code> <code>gender</code> をフィールドとして持っているのが分かるので次のような型を定義した．</p>
<pre class="elm"><code>module Character exposing (..)

type alias Character =
    { name : String
    , surname : String
    , gender : Gender
    }</code></pre>
<p>何故エイリアスなのかというと，構造的サブタイピイングが出来るようにだと思う(たぶん)．</p>
<h4 id="ユニオン型">2. ユニオン型</h4>
<p><code>Gender</code> 型が無いので定義する． こっちは列挙型みたいなのが欲しいので、ユニオン型を用いる．</p>
<pre class="elm"><code>type Gender
    = Male
    | Female
    | Other</code></pre>
<h4 id="関数としての型エイリアス">3. 関数としての型エイリアス</h4>
<p>Elixir っぽい <code>new</code> 関数を定義してやろう． Elm の場合，エイリアス型を定義すれば同名の値コンストラクタができるので，それをラップすればよい</p>
<pre class="elm"><code>new : String -&gt; String -&gt; Gender -&gt; Character
new name surname gender =
    Character
      name
      surname
      gender</code></pre>
<h3 id="キャラクターにステータスを持たせる">キャラクターにステータスを持たせる</h3>
<p>キャラクターにいくつかのステータスを持たせよう．</p>
<pre class="elm"><code>type alias Character =
    { name : String
    , surname : String
    , gender : Gender
    , health : (Int, Int)
    , stats : Stats
    }

type alias Stats =
    { strength : Int
    , intelligence : Int
    , vitality : Int
    }

new : String -&gt; String -&gt; Gender -&gt; Character
new name surname gender =
    Character
      name
      surname
      gender
      (100,100)
      (Stats 0 0 0)</code></pre>
<p><code>health</code> はどうやら HP みたいなものらしい(現在のHPと上限)．</p>
<h3 id="パターンマッチ">4. パターンマッチ</h3>
<p>ステータスを更新する関数を定義しよう．</p>
<pre class="elm"><code>type Stat
    = Strength
    | Intelligence
    | Vitality

setStat : Stat -&gt; Int -&gt; Character -&gt; Character
setStat stat value character =
    let
      stats = character.stats
    in
    case stat of
        Strength -&gt;
            { character | stats = { stats | strength = value } }
        Intelligence -&gt;
            { character | stats = { stats | intelligence = value } }
        Vitality -&gt;
            { character | stats = { stats | vitality = value } }        </code></pre>
<p>残念ながらこの <code>setStat</code> は正しくない． テストを見ればわかるが <code>Vitality</code> を更新した場合は <code>health</code> も更新する必要がある．</p>
<h4 id="演算子">5. 演算子</h4>
<p><code>health</code> はタプル型だ． タプルの更新をいい感じにするために，カスタム演算子を定義してみよう．</p>
<pre class="elm"><code>(&lt;$) : (a, b) -&gt; (a -&gt; c) -&gt; (c, b)
(&lt;$) tuple f = Tuple.mapFirst f tuple

($&gt;) : (a, b) -&gt; (b -&gt; c) -&gt; (a, c)
($&gt;) tuple f = Tuple.mapSecond f tuple</code></pre>
<p>これを使って <code>setStat</code> の <code>Vitality</code> の部分を正しく修正する．</p>
<pre class="elm"><code>setStat : Stat -&gt; Int -&gt; Character -&gt; Character
setStat stat value character =
    let
      stats = character.stats
    in
    case stat of
        ...
        Vitality -&gt;
            { character
                | stats = { stats | vitality = value }
                , health =
                    character.health
                      &lt;$ (+) ((value - stats.vitality) * 10)
                      $&gt; always (100 + 10 * value)
            }                </code></pre>
<h3 id="ウェポンを持たせる">ウェポンを持たせる</h3>
<h4 id="インポート">インポート</h4>
<p>新しく <code>Weapon.elm</code> ファイルを作り，新しいモジュール定義する．</p>
<pre class="elm"><code>module Weapon exposing (..)

type alias Weapon =
    { name : String
    , level : Int
    , damage : Int
    }

new : String -&gt; Int -&gt; Int -&gt; Weapon
new name level damage = Weapon name level damage</code></pre>
<p>このモジュールをインポートして <code>Character</code> 型を拡張しよう</p>
<pre class="elm"><code>import Weapon exposing (Weapon)

type alias Character =
    { name : String
    , surname : String
    , gender : Gender
    , health : (Int, Int)
    , stats : Stats
    , arm : Maybe Weapon
    }

new : String -&gt; String -&gt; Gender -&gt; Character
new name surname gender =
    Character
      name
      surname
      gender
      (100,100)
      (Stats 0 0 0)
      Nothing</code></pre>
<p>最後に <code>equip</code> 関数を作って完成． これで全てのテストが通るはずだ．</p>
<pre class="elm"><code>equip : Weapon -&gt; Character -&gt; Result String Character
equip weapon character =
    if weapon.level &lt; character.status.intelligence then
        Ok { character | arm = Just weapon }
    else
        Err &quot;Too dumb&quot;</code></pre>
<p>「頭悪すぎ」ってひどい(笑)</p>
<h2 id="phoenix-で-todo-アプリを作る">Phoenix で ToDo アプリを作る</h2>
<p>Elchemy が実際にどの程度有用かを感じるために，Elchemy + Elm + Phoenix で超簡易的な Todo アプリを作ってみた．</p>
<ul>
<li><a href="https://gitlab.com/matsubara0507/elchemy_todo_app">MATSUBARA Nobutada / elchemy_todo_app · GitLab</a></li>
</ul>
<p>過去に <a href="https://github.com/matsubara0507/patissier-test">Elm + Phoenix で社内ツールを作ったり</a>，<a href="https://matsubara0507.github.io/posts/2017-12-13-elm-and-haskell-for-elmer.html">Elm + Haskell で Todo アプリを書いてみたり</a>したので，その辺りからコードや構成はパクッて来てます． GitLab に置いてるのは，モノは試しってやつ(笑)．</p>
<h3 id="phoenix-をインストール">Phoenix をインストール</h3>
<p>Elchemy (および Elixir・Elm・npm) はインストールされているとする． <a href="https://hexdocs.pm/phoenix/installation.html">Phoenix のサイト</a>にある通りにやればよい．</p>
<pre><code>$ mix archive.install https://github.com/phoenixframework/archives/raw/master/phx_new.ez</code></pre>
<h3 id="project-を作成">Project を作成</h3>
<p>こんな時のために <code>elchemy init</code> というコマンドがある(？)．</p>
<pre><code>$ mix phx.new elchemy_todo_app --no-ecto
$ cd elchemy_todo_app
$ elchemy init</code></pre>
<p><code>elchemy new</code> との違いは，<code>mix.exs</code> の Elixir のバージョンが古いのと <code>.formatter.exs</code> ぐらいかな？ 今回は DB をわざわざ使うのがめんどくさいので，ストレージっぽい GenServer を定義する(なので <code>--no-ecto</code>)．</p>
<h3 id="crud-を作る">CRUD を作る</h3>
<p>Phoenix に CRUD を追加するには，まず<code>router.ex</code> にルーティングを足す.</p>
<div class="sourceCode" id="cb14"><pre class="sourceCode elixir"><code class="sourceCode elixir"><a class="sourceLine" id="cb14-1" title="1"><span class="kw">defmodule</span> <span class="cn">ElchemyTodoAppWeb</span><span class="op">.</span><span class="cn">Router</span> <span class="kw">do</span></a>
<a class="sourceLine" id="cb14-2" title="2">  <span class="im">use</span> <span class="cn">ElchemyTodoAppWeb</span>, <span class="va">:router</span></a>
<a class="sourceLine" id="cb14-3" title="3"></a>
<a class="sourceLine" id="cb14-4" title="4">  <span class="op">...</span></a>
<a class="sourceLine" id="cb14-5" title="5"></a>
<a class="sourceLine" id="cb14-6" title="6">  pipeline <span class="va">:api</span> <span class="kw">do</span></a>
<a class="sourceLine" id="cb14-7" title="7">    plug(<span class="va">:accepts</span>, [<span class="st">&quot;json&quot;</span>])</a>
<a class="sourceLine" id="cb14-8" title="8">  <span class="kw">end</span></a>
<a class="sourceLine" id="cb14-9" title="9"></a>
<a class="sourceLine" id="cb14-10" title="10">  scope <span class="st">&quot;/api&quot;</span>, <span class="cn">ElchemyTodoAppWeb</span> <span class="kw">do</span></a>
<a class="sourceLine" id="cb14-11" title="11">    pipe_through(<span class="va">:api</span>)</a>
<a class="sourceLine" id="cb14-12" title="12">    resources(<span class="st">&quot;/todos&quot;</span>, <span class="cn">TodoController</span>, <span class="va">only:</span> [<span class="va">:index</span>, <span class="va">:create</span>, <span class="va">:update</span>, <span class="va">:delete</span>])</a>
<a class="sourceLine" id="cb14-13" title="13">  <span class="kw">end</span></a>
<a class="sourceLine" id="cb14-14" title="14"><span class="kw">end</span></a></code></pre></div>
<p>次にコントロラーを定義し，</p>
<div class="sourceCode" id="cb15"><pre class="sourceCode elixir"><code class="sourceCode elixir"><a class="sourceLine" id="cb15-1" title="1"><span class="kw">defmodule</span> <span class="cn">ElchemyTodoAppWeb</span><span class="op">.</span><span class="cn">TodoController</span> <span class="kw">do</span></a>
<a class="sourceLine" id="cb15-2" title="2">  <span class="im">alias</span> <span class="cn">Models</span><span class="op">.</span><span class="cn">Todo</span>, <span class="va">as:</span> <span class="cn">Todo</span></a>
<a class="sourceLine" id="cb15-3" title="3">  <span class="im">use</span> <span class="cn">ElchemyTodoAppWeb</span>, <span class="va">:controller</span></a>
<a class="sourceLine" id="cb15-4" title="4"></a>
<a class="sourceLine" id="cb15-5" title="5">  <span class="kw">def</span> index(conn, _params), <span class="kw">do</span>: render(conn, <span class="st">&quot;todos.json&quot;</span>, %{<span class="va">todos:</span> <span class="op">...</span> })</a>
<a class="sourceLine" id="cb15-6" title="6">  <span class="kw">def</span> create(conn, params), <span class="kw">do</span>: render(conn, <span class="st">&quot;todos.json&quot;</span>, %{<span class="va">todos:</span> <span class="op">...</span> })</a>
<a class="sourceLine" id="cb15-7" title="7">  <span class="kw">def</span> update(conn, params), <span class="kw">do</span>: render(conn, <span class="st">&quot;todos.json&quot;</span>, %{<span class="va">todos:</span> <span class="op">...</span> })</a>
<a class="sourceLine" id="cb15-8" title="8">  <span class="kw">def</span> delete(conn, %{<span class="st">&quot;id&quot;</span> <span class="op">=&gt;</span> id}), <span class="kw">do</span>: render(conn, <span class="st">&quot;todos.json&quot;</span>, %{<span class="va">todos:</span> <span class="op">...</span> })</a>
<a class="sourceLine" id="cb15-9" title="9"><span class="kw">end</span></a></code></pre></div>
<p>(<code>...</code> の部分は後で埋める) そして View を定義する。</p>
<div class="sourceCode" id="cb16"><pre class="sourceCode elixir"><code class="sourceCode elixir"><a class="sourceLine" id="cb16-1" title="1"><span class="kw">defmodule</span> <span class="cn">ElchemyTodoAppWeb</span><span class="op">.</span><span class="cn">TodoView</span> <span class="kw">do</span></a>
<a class="sourceLine" id="cb16-2" title="2">  <span class="im">use</span> <span class="cn">ElchemyTodoAppWeb</span>, <span class="va">:view</span></a>
<a class="sourceLine" id="cb16-3" title="3">  <span class="kw">def</span> render(<span class="st">&quot;todos.json&quot;</span>, %{<span class="va">todos:</span> todos}), <span class="kw">do</span>: todos</a>
<a class="sourceLine" id="cb16-4" title="4"><span class="kw">end</span></a></code></pre></div>
<p>さてここから　Elchemy だ。 モデルを Elchemy で定義する. というかモデル以外はマクロ色が強過ぎてうまくいかなかった.</p>
<h3 id="elchemy-でモデルを">Elchemy でモデルを</h3>
<p>まずは型を定義.</p>
<pre class="elm"><code>module Data.Todo exposing (..)
import Dict

type alias Todo =
    { id : String
    , title : String
    , done : Bool
    }

type alias Todos =
    Dict.Dict String Todo</code></pre>
<p>ここはフロント共有したいので別途切り出しておく. DBをサボるために GenServer なモデルを定義する.</p>
<pre class="elm"><code>module Models.Todo exposing (..)

import Data.Todo exposing (Todo, Todos)
import Dict
import Elchemy exposing (..)

{- ex
   use GenServer

   def start_link(init \\ %{ todos: %{}, cnt: 0 }), do: GenServer.start_link(__MODULE__, init, name: :todos)

   def init(state), do: {:ok, state}

   def handle_call(:get, _client, state), do: {:reply, state, state}

   def handle_cast({:set, new_state}, _state), do: {:noreply, new_state}

   def gen_(params) do
     %{
       id: params[&quot;id&quot;],
       title: params[&quot;title&quot;],
       done: params[&quot;done&quot;]
     }
   end
-}

type alias State =
    { todos : Todos
    , cnt : Int
    }

type Name
    = Todos

type Action
    = Get
    | Set State

gen : params -&gt; Todo
gen = ffi &quot;Models.Todo&quot; &quot;gen_&quot;

getState : State
getState = call_ Todos Get

setState : State -&gt; State
setState state = cast_ Todos (Set state) |&gt; always state

call_ : Name -&gt; Action -&gt; a
call_ = ffi &quot;GenServer&quot; &quot;call&quot;

cast_ : Name -&gt; Action -&gt; a
cast_ = ffi &quot;GenServer&quot; &quot;cast&quot;</code></pre>
<p><code>Todos</code> と削除された <code>Todo</code> も含めた総数を表した <code>Int</code> を持った <code>State</code> 型を状態として GenServer に保持して欲しい． 出力した Elixir コードにだけモジュールをインポートさせたり，うまく型付けできない関数を Elixir コードに張り付けるには，コメントアウト <code>{- ex ... -}</code> 使う． この中に書いた Elixir コードはそのまま出力先に貼り付けられる(濫用厳禁！)．</p>
<p>Elixir モジュールの関数を呼び出すには <code>Elchemy</code> モジュールにある <code>ffi</code> 関数を使う． ただし，<code>ffi</code> 関数をファーストクラスには扱えない． 次のようなエラーが出る．</p>
<pre><code>Ffi inside function body is deprecated since Elchemy 0.3</code></pre>
<p><code>Name</code> 型や <code>Action</code> 型は Elchemy が代数的データ型をアトムとタプルに変換することと，GenServer の使い方を知っていれば意図するところが分かるだろう． 逆にそれらを知っていなければ読みとれないと思う…</p>
<h2 id="section-1"></h2>
<p>コントローラーから呼ばれるインターフェースは <code>getState</code> と <code>setState</code> を用いることで簡単に書けた．</p>
<pre class="elm"><code>gets : List Todo
gets = Dict.values (.todos getState)

add : Todo -&gt; List Todo
add todo =
    let
        { todos, cnt } = getState
        newId   = toString cnt
        newTodo = { todo | id = newId }
        state   = { todos = Dict.insert newId newTodo todos, cnt = cnt + 1 }
    in
    setState state
        |&gt; .todos
        |&gt; Dict.values

update : Todo -&gt; List Todo
update todo =
    let
        { todos, cnt } = getState
        state = { todos = Dict.update todo.id (Maybe.map &lt;| always todo) todos, cnt = cnt }
    in
    setState state
        |&gt; .todos
        |&gt; Dict.values

remove : String -&gt; List Todo
remove todoId =
    let
        { todos, cnt } =
            getState
        state =
            { todos = Dict.remove todoId todos, cnt = cnt }
    in
    setState state
        |&gt; .todos
        |&gt; Dict.values</code></pre>
<p>コントローラーの <code>...</code> を書き換えてやれば完成だ．</p>
<div class="sourceCode" id="cb21"><pre class="sourceCode elixir"><code class="sourceCode elixir"><a class="sourceLine" id="cb21-1" title="1">  <span class="kw">def</span> index(conn, _params), <span class="kw">do</span>: render(conn, <span class="st">&quot;todos.json&quot;</span>, %{<span class="va">todos:</span> <span class="cn">Todo</span><span class="op">.</span>gets()})</a>
<a class="sourceLine" id="cb21-2" title="2">  <span class="kw">def</span> create(conn, params), <span class="kw">do</span>: render(conn, <span class="st">&quot;todos.json&quot;</span>, %{<span class="va">todos:</span> <span class="cn">Todo</span><span class="op">.</span>add(<span class="cn">Todo</span><span class="op">.</span>gen(params))})</a>
<a class="sourceLine" id="cb21-3" title="3">  <span class="kw">def</span> update(conn, params), <span class="kw">do</span>: render(conn, <span class="st">&quot;todos.json&quot;</span>, %{<span class="va">todos:</span> <span class="cn">Todo</span><span class="op">.</span>update(<span class="cn">Todo</span><span class="op">.</span>gen(params))})</a>
<a class="sourceLine" id="cb21-4" title="4">  <span class="kw">def</span> delete(conn, %{<span class="st">&quot;id&quot;</span> <span class="op">=&gt;</span> id}), <span class="kw">do</span>: render(conn, <span class="st">&quot;todos.json&quot;</span>, %{<span class="va">todos:</span> <span class="cn">Todo</span><span class="op">.</span>remove(id)})</a>
<a class="sourceLine" id="cb21-5" title="5"><span class="kw">end</span></a></code></pre></div>
<p>ちなみに出力された Elixir コードは<a href="https://gitlab.com/matsubara0507/elchemy_todo_app/blob/443777cee3e8435ee15f04ada6437e41e3af064b/lib/data/todo.elchemy.ex">ココ</a>と<a href="https://gitlab.com/matsubara0507/elchemy_todo_app/blob/443777cee3e8435ee15f04ada6437e41e3af064b/lib/models/todo.elchemy.ex">ココ</a>です． 興味がある人は見てください．</p>
<h3 id="elm-brunch">Elm Brunch</h3>
<p>Brunch 設定が難しかったので，本質的には Elchemy と関係ないけど残しておく．</p>
<p>Phoenix 1.3 系ではトップレベルに <code>assets</code> というディレクトリがあり，HTML/JS/CSS/画像 のような静的ファイルはここに置いておく． Brunch を使って複数の JS や CSS を合わせることが出来る． <a href="https://github.com/madsflensted/elm-brunch">elm-brunch</a> を使うことで Elm を JS にコンパイルしてくれる．</p>
<p>branch-config に次のような設定を書き加えてあげる． Elm のフロントコードは <code>lib/web/elm</code> に置いてある．</p>
<div class="sourceCode" id="cb22"><pre class="sourceCode javascript"><code class="sourceCode javascript"><a class="sourceLine" id="cb22-1" title="1"><span class="va">exports</span>.<span class="at">config</span> <span class="op">=</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb22-2" title="2">  ...</a>
<a class="sourceLine" id="cb22-3" title="3">  <span class="dt">paths</span><span class="op">:</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb22-4" title="4">    <span class="dt">watched</span><span class="op">:</span> [<span class="st">&quot;static&quot;</span><span class="op">,</span> <span class="st">&quot;css&quot;</span><span class="op">,</span> <span class="st">&quot;js&quot;</span><span class="op">,</span> <span class="st">&quot;vendor&quot;</span><span class="op">,</span> <span class="st">&quot;../lib/web/elm&quot;</span>]<span class="op">,</span></a>
<a class="sourceLine" id="cb22-5" title="5">    <span class="dt">public</span><span class="op">:</span> <span class="st">&quot;../priv/static&quot;</span></a>
<a class="sourceLine" id="cb22-6" title="6">  <span class="op">},</span></a>
<a class="sourceLine" id="cb22-7" title="7"></a>
<a class="sourceLine" id="cb22-8" title="8">  <span class="dt">plugins</span><span class="op">:</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb22-9" title="9">    <span class="dt">elmBrunch</span><span class="op">:</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb22-10" title="10">      <span class="dt">elmFolder</span><span class="op">:</span> <span class="st">&quot;../lib/web/elm&quot;</span><span class="op">,</span></a>
<a class="sourceLine" id="cb22-11" title="11">      <span class="dt">mainModules</span><span class="op">:</span> [<span class="st">&quot;Main.elm&quot;</span>]<span class="op">,</span></a>
<a class="sourceLine" id="cb22-12" title="12">      <span class="dt">outputFolder</span><span class="op">:</span> <span class="st">&quot;vendor&quot;</span></a>
<a class="sourceLine" id="cb22-13" title="13">    <span class="op">},</span></a>
<a class="sourceLine" id="cb22-14" title="14">  ...</a>
<a class="sourceLine" id="cb22-15" title="15">  <span class="op">}</span></a>
<a class="sourceLine" id="cb22-16" title="16">  ...</a>
<a class="sourceLine" id="cb22-17" title="17"><span class="op">}</span></a></code></pre></div>
<h3 id="フロント部分">フロント部分</h3>
<p>ほんの少しだがコードを再利用できる． API クライアントは以下のようになる．</p>
<pre class="elm"><code>module TodoAPI exposing (..)

import Data.Todo exposing (Todo)
import Http

getTodos : Http.Request (List Todo)
getTodos =
    Http.request
        { method =
            &quot;GET&quot;
        , headers =
            []
        , url =
            String.join &quot;/&quot;
                [ baseUrl
                , &quot;todos&quot;
                ]
        , body =
            Http.emptyBody
        , expect =
            Http.expectJson (list decodeTodo)
        , timeout =
            Nothing
        , withCredentials =
            False
        }</code></pre>
<p>ホントはこの当たりも Elchemy を使って生成できるとよいのだが… もしかして <a href="https://github.com/saschatimme/elm-phoenix">elm-phoenix</a> なるものを使えばよかったのかな？ また，The Elm Architecture 部分は長いので割愛．</p>
<h2 id="section-2"></h2>
<p>ホントは assets 回りが他にもたくさんあるが,本質的な部分はこれで完成． あとはモロモロインストールして <code>mix phx.server</code> とすれば動作するはずだ．</p>
<h3 id="感想">感想</h3>
<ul>
<li><strong>うれしみ</strong>
<ul>
<li>静的検査は神</li>
<li>フロントとコードを共有できる</li>
</ul></li>
<li><strong>つらみ</strong>
<ul>
<li>Phoenix のいくつかは型付けできない
<ul>
<li>ルーティングの引数</li>
<li>へテロリストのようなモノ</li>
<li>結局ここで良く分からんエラーに…</li>
</ul></li>
<li>コンパイルが遅い</li>
</ul></li>
</ul>
<h2 id="おしまい">おしまい</h2>
<p>今度は処理系の中身でも追ってみようかな．</p>
  </div>
</div>
</article>

          </div>
        </div>

        <footer class="site-footer">

  <div class="wrapper">

    <span class="footer-heading">ひげメモ</span>

  </div>

  <div class="page-content card" style="display: flex; justify-content: center; padding: 5px 0px">
    <a href="https://haskell.jp/blog/posts/links.html#matsubara0507.github.io">
      <img width="234" src="https://haskell.jp/img/supported-by-haskell-jp.svg" alt="Supported By Haskell-jp.">
    </a>
  </div>

</footer>


      </div>
  </body>

</html>
