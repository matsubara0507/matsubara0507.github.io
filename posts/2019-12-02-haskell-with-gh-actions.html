<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE html>
<html lang="ja">

  <head>
  <meta charset="utf-8">
  <link rel="icon" href="../assets/icon.jpg">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
    
      <meta property="og:title" content="Haskell で GitHub Actions する" />
    
  

  <meta property="og:site_name" content="ひげメモ" />

  
    <meta property="og:image" content="/assets/haskell-with-gh-actions/after.jpg" />
  

  
    <script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-86386380-1', 'auto');
  ga('send', 'pageview');
</script>

  

  <title>
    
      
        Haskell で GitHub Actions する
      
    
  </title>

  <link rel="stylesheet" href="../css/main.css">
  <link rel="stylesheet" href="../css/highlight.css">
  <link rel="stylesheet" type="text/css" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.4.0/css/font-awesome.min.css" />
</head>


  <body>
      <div class="outer">

        <header class="site-header">

  <div class="wrapper">

    <a class="site-title" href="https://matsubara0507.github.io/">ひげメモ</a>

  </div>

  <div class="header-badge">
    <a href="https://matsubara0507.github.io/">
        <img src="../assets/icon.jpg" />
    </a>
  </div>

</header>


        <div class="page-content">
          <div class="wrapper">
            <article class="post card" itemscope itemtype="http://schema.org/BlogPosting">
 <div class="card-content">
  <header class="post-header">
    <h1 class="post-title" itemprop="name headline">Haskell で GitHub Actions する</h1>
    <p class="post-meta">
      <time datetime="2019-12-02" itemprop="datePublished">
        Dec 2, 2019
      </time>
      
      
      <div class="tags">
          <i class="fa fa-tags"></i> <a href="../tags/Haskell.html">Haskell</a> <a href="../tags/GitHub-Actions.html">GitHub-Actions</a> <a href="../tags/TypeScript.html">TypeScript</a>
      </div>
      
    </p>
  </header>

  <div class="post-content" itemprop="articleBody">
    <p>本記事は「<a href="https://qiita.com/advent-calendar/2019/haskell">Haskell Advent Calendar 2019</a>」の2日目の記事です．</p>
<h1 id="section"></h1>
<p>2019/11/13 に GA された GitHub Actions を使って，Haskell プロジェクト，とりわけ Haskell Stack を使ったプロジェクトを CI/CD します．</p>
<p>ちなみに，試すために導入した PR はこれです:</p>
<ul>
<li><a href="https://github.com/matsubara0507/octbook/pull/1">自動ビルドを追加 by matsubara0507 · Pull Request #1 · matsubara0507/octbook</a></li>
</ul>
<p>これは適当な設定ファイルから GitHub の Organization や Organization の Team 機能にユーザーを招待したりキックしたりするための CLI ツールです．</p>
<h2 id="cabal-の場合">Cabal の場合</h2>
<p>はわりかし簡単． Haskell のセットアップは公式がすでに用意してくれてるのでこれを使えば良い:</p>
<ul>
<li><a href="https://github.com/actions/setup-haskell">actions/setup-haskell: Set up your GitHub Actions workflow with a specific version of Haskell (GHC and Cabal)</a></li>
</ul>
<p>こんな感じ:</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode yaml"><code class="sourceCode yaml"><span id="cb1-1"><a href="#cb1-1"></a><span class="fu">jobs</span><span class="kw">:</span></span>
<span id="cb1-2"><a href="#cb1-2"></a><span class="at">  </span><span class="fu">build</span><span class="kw">:</span></span>
<span id="cb1-3"><a href="#cb1-3"></a><span class="at">    </span><span class="fu">name</span><span class="kw">:</span><span class="at"> ghc ${{ matrix.ghc }}</span></span>
<span id="cb1-4"><a href="#cb1-4"></a><span class="at">    </span><span class="fu">runs-on</span><span class="kw">:</span><span class="at"> ubuntu-16.04</span></span>
<span id="cb1-5"><a href="#cb1-5"></a><span class="at">    </span><span class="fu">strategy</span><span class="kw">:</span></span>
<span id="cb1-6"><a href="#cb1-6"></a><span class="at">      </span><span class="fu">matrix</span><span class="kw">:</span></span>
<span id="cb1-7"><a href="#cb1-7"></a><span class="at">        </span><span class="fu">ghc</span><span class="kw">:</span><span class="at"> </span><span class="kw">[</span><span class="st">&quot;8.2.2&quot;</span><span class="kw">,</span><span class="at"> </span><span class="st">&quot;8.4.4&quot;</span><span class="kw">,</span><span class="at"> </span><span class="st">&quot;8.6.5&quot;</span><span class="kw">,</span><span class="at"> </span><span class="st">&quot;8.8.1&quot;</span><span class="kw">]</span></span>
<span id="cb1-8"><a href="#cb1-8"></a><span class="at">        </span><span class="fu">cabal</span><span class="kw">:</span><span class="at"> </span><span class="kw">[</span><span class="st">&quot;3.0&quot;</span><span class="kw">]</span></span>
<span id="cb1-9"><a href="#cb1-9"></a></span>
<span id="cb1-10"><a href="#cb1-10"></a><span class="at">    </span><span class="fu">steps</span><span class="kw">:</span></span>
<span id="cb1-11"><a href="#cb1-11"></a><span class="at">    </span><span class="kw">-</span><span class="at"> </span><span class="fu">uses</span><span class="kw">:</span><span class="at"> actions/checkout@master</span></span>
<span id="cb1-12"><a href="#cb1-12"></a><span class="at">      </span><span class="fu">with</span><span class="kw">:</span></span>
<span id="cb1-13"><a href="#cb1-13"></a><span class="at">        </span><span class="fu">fetch-depth</span><span class="kw">:</span><span class="at"> </span><span class="dv">1</span></span>
<span id="cb1-14"><a href="#cb1-14"></a><span class="at">    </span><span class="kw">-</span><span class="at"> </span><span class="fu">uses</span><span class="kw">:</span><span class="at"> actions/setup-haskell@v1</span></span>
<span id="cb1-15"><a href="#cb1-15"></a><span class="at">      </span><span class="fu">name</span><span class="kw">:</span><span class="at"> Setup Haskell</span></span>
<span id="cb1-16"><a href="#cb1-16"></a><span class="at">      </span><span class="fu">with</span><span class="kw">:</span></span>
<span id="cb1-17"><a href="#cb1-17"></a><span class="at">        </span><span class="fu">ghc-version</span><span class="kw">:</span><span class="at"> ${{ matrix.ghc }}</span></span>
<span id="cb1-18"><a href="#cb1-18"></a><span class="at">        </span><span class="fu">cabal-version</span><span class="kw">:</span><span class="at"> ${{ matrix.cabal }}</span></span></code></pre></div>
<p>Haskell パッケージ系のリポジトリなら，こんな感じに matrix の設定をすると良い． で，キャッシュする場合は，この matrix ごとに <code>~/.cabal/store</code> だけをキャッシュすれば十分らしい（教えてもらった）:</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode yaml"><code class="sourceCode yaml"><span id="cb2-1"><a href="#cb2-1"></a><span class="at">   </span><span class="fu">steps</span><span class="kw">:</span></span>
<span id="cb2-2"><a href="#cb2-2"></a><span class="at">   ...</span></span>
<span id="cb2-3"><a href="#cb2-3"></a><span class="at">    </span><span class="kw">-</span><span class="at"> </span><span class="fu">name</span><span class="kw">:</span><span class="at"> Cache .cabal</span></span>
<span id="cb2-4"><a href="#cb2-4"></a><span class="at">      </span><span class="fu">uses</span><span class="kw">:</span><span class="at"> actions/cache@preview</span></span>
<span id="cb2-5"><a href="#cb2-5"></a><span class="at">      </span><span class="fu">with</span><span class="kw">:</span></span>
<span id="cb2-6"><a href="#cb2-6"></a><span class="at">        </span><span class="fu">path</span><span class="kw">:</span><span class="at"> ~/.cabal/store</span></span>
<span id="cb2-7"><a href="#cb2-7"></a><span class="at">        </span><span class="fu">key</span><span class="kw">:</span><span class="at"> ${{ matrix.ghc }}-cabal-${{ hashFiles('**/fallible.cabal') }}</span></span>
<span id="cb2-8"><a href="#cb2-8"></a><span class="fu">        restore-keys</span><span class="kw">: </span><span class="ch">|</span></span>
<span id="cb2-9"><a href="#cb2-9"></a>          ${{ matrix.ghc }}-cabal-</span>
<span id="cb2-10"><a href="#cb2-10"></a><span class="at">    </span><span class="kw">-</span><span class="at"> </span><span class="fu">uses</span><span class="kw">:</span><span class="at"> actions/setup-haskell@v1</span></span>
<span id="cb2-11"><a href="#cb2-11"></a><span class="at">      </span><span class="fu">name</span><span class="kw">:</span><span class="at"> Setup Haskell</span></span>
<span id="cb2-12"><a href="#cb2-12"></a><span class="at">      </span><span class="fu">with</span><span class="kw">:</span></span>
<span id="cb2-13"><a href="#cb2-13"></a><span class="at">        </span><span class="fu">ghc-version</span><span class="kw">:</span><span class="at"> ${{ matrix.ghc }}</span></span>
<span id="cb2-14"><a href="#cb2-14"></a><span class="at">        </span><span class="fu">cabal-version</span><span class="kw">:</span><span class="at"> ${{ matrix.cabal }}</span></span>
<span id="cb2-15"><a href="#cb2-15"></a><span class="at">    </span><span class="kw">-</span><span class="at"> </span><span class="fu">name</span><span class="kw">:</span><span class="at"> Install dependencies</span></span>
<span id="cb2-16"><a href="#cb2-16"></a><span class="fu">      run</span><span class="kw">: </span><span class="ch">|</span></span>
<span id="cb2-17"><a href="#cb2-17"></a>        cabal v2-update</span>
<span id="cb2-18"><a href="#cb2-18"></a>        cabal v2-build --only-dependencies</span>
<span id="cb2-19"><a href="#cb2-19"></a><span class="at">    </span><span class="kw">-</span><span class="at"> </span><span class="fu">name</span><span class="kw">:</span><span class="at"> Build &amp; test</span></span>
<span id="cb2-20"><a href="#cb2-20"></a><span class="fu">      run</span><span class="kw">: </span><span class="ch">|</span></span>
<span id="cb2-21"><a href="#cb2-21"></a>        cabal v2-build</span>
<span id="cb2-22"><a href="#cb2-22"></a>        cabal v2-test</span></code></pre></div>
<p>Cabal の方はちゃんと調査してないのでこんでお終い（すいません）．</p>
<h2 id="stack-の場合">Stack の場合</h2>
<p>こっからが本題．</p>
<p>Stack はキャッシュすべきディレクトリ <code>~/.stack</code> がでかすぎる． 下記は試しに GitHub Actions 上で <code>du</code> して見た結果だ:</p>
<pre><code>$ du -sh ~/.stack/*
4.0K    /home/runner/.stack/config.yaml
1.3G    /home/runner/.stack/pantry
553M    /home/runner/.stack/pantry.sqlite3
0       /home/runner/.stack/pantry.sqlite3.pantry-write-lock
1.8G    /home/runner/.stack/programs
16M     /home/runner/.stack/setup-exe-cache
64K     /home/runner/.stack/setup-exe-src
462M    /home/runner/.stack/snapshots
192K    /home/runner/.stack/stack.sqlite3
0       /home/runner/.stack/stack.sqlite3.pantry-write-lock</code></pre>
<p>現在，<code>actions/cache@v1</code> では一度にキャッシュできるディレクトリの最大サイズは400MBしかない（今後緩和される可能性はあるが）． <code>actions/cache</code> は内部で gzip かなんかで圧縮しているので，この数字まんまではない． 試しに，このまんまキャッシュしてみたら次のような警告が出た:</p>
<pre><code>Post job cleanup.
/bin/tar -cz -f /home/runner/work/_temp/2706cc23-8789-4ed4-b4ec-4e7143b1cc98/cache.tgz -C /home/runner/.stack .
##[warning]Cache size of 814014541 bytes is over the 400MB limit, not saving cache.</code></pre>
<p>800MB強，意外と少ない！</p>
<p>余談だが，<del>そのうち</del> v1.0.2 から<a href="https://github.com/actions/cache/pull/85">毎回キャッシュサイズが見れるようになる</a>はず（今でも <code>ACTIONS_STEP_DEBUG</code> を Secret に設定すると見れる）．</p>
<h3 id="system-ghc-を使う">system-ghc を使う</h3>
<p>stack は <code>--system-ghc</code> オプションを使うことで stack がインストールした GHC の代わりに，ホストマシンの GHC を直接使ってくれる:</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode yaml"><code class="sourceCode yaml"><span id="cb5-1"><a href="#cb5-1"></a><span class="fu">jobs</span><span class="kw">:</span></span>
<span id="cb5-2"><a href="#cb5-2"></a><span class="at">  </span><span class="fu">build</span><span class="kw">:</span></span>
<span id="cb5-3"><a href="#cb5-3"></a><span class="at">    </span><span class="fu">runs-on</span><span class="kw">:</span><span class="at"> ubuntu-18.04</span></span>
<span id="cb5-4"><a href="#cb5-4"></a><span class="at">    </span><span class="fu">strategy</span><span class="kw">:</span></span>
<span id="cb5-5"><a href="#cb5-5"></a><span class="at">      </span><span class="fu">matrix</span><span class="kw">:</span></span>
<span id="cb5-6"><a href="#cb5-6"></a><span class="at">        </span><span class="fu">ghc</span><span class="kw">:</span><span class="at"> </span><span class="kw">[</span><span class="st">&quot;8.6.5&quot;</span><span class="kw">]</span></span>
<span id="cb5-7"><a href="#cb5-7"></a><span class="at">        </span><span class="fu">cabal</span><span class="kw">:</span><span class="at"> </span><span class="kw">[</span><span class="st">&quot;3.0&quot;</span><span class="kw">]</span></span>
<span id="cb5-8"><a href="#cb5-8"></a><span class="at">        </span><span class="fu">cache-version</span><span class="kw">:</span><span class="at"> </span><span class="kw">[</span><span class="st">&quot;v4&quot;</span><span class="kw">]</span></span>
<span id="cb5-9"><a href="#cb5-9"></a></span>
<span id="cb5-10"><a href="#cb5-10"></a><span class="at">    </span><span class="fu">steps</span><span class="kw">:</span></span>
<span id="cb5-11"><a href="#cb5-11"></a><span class="at">    </span><span class="kw">-</span><span class="at"> </span><span class="fu">uses</span><span class="kw">:</span><span class="at"> actions/checkout@v1</span></span>
<span id="cb5-12"><a href="#cb5-12"></a><span class="at">      </span><span class="fu">with</span><span class="kw">:</span></span>
<span id="cb5-13"><a href="#cb5-13"></a><span class="at">        </span><span class="fu">fetch-depth</span><span class="kw">:</span><span class="at"> </span><span class="dv">1</span></span>
<span id="cb5-14"><a href="#cb5-14"></a><span class="at">    </span><span class="kw">-</span><span class="at"> </span><span class="fu">name</span><span class="kw">:</span><span class="at"> Setup Haskell</span></span>
<span id="cb5-15"><a href="#cb5-15"></a><span class="at">      </span><span class="fu">uses</span><span class="kw">:</span><span class="at"> actions/setup-haskell@v1</span></span>
<span id="cb5-16"><a href="#cb5-16"></a><span class="at">      </span><span class="fu">with</span><span class="kw">:</span></span>
<span id="cb5-17"><a href="#cb5-17"></a><span class="at">        </span><span class="fu">ghc-version</span><span class="kw">:</span><span class="at"> ${{ matrix.ghc }}</span></span>
<span id="cb5-18"><a href="#cb5-18"></a><span class="at">        </span><span class="fu">cabal-version</span><span class="kw">:</span><span class="at"> ${{ matrix.cabal }}</span></span>
<span id="cb5-19"><a href="#cb5-19"></a><span class="at">    </span><span class="kw">-</span><span class="at"> </span><span class="fu">uses</span><span class="kw">:</span><span class="at"> mstksg/setup-stack@v1</span></span>
<span id="cb5-20"><a href="#cb5-20"></a><span class="at">    </span><span class="kw">-</span><span class="at"> </span><span class="fu">name</span><span class="kw">:</span><span class="at"> Install dependencies</span></span>
<span id="cb5-21"><a href="#cb5-21"></a><span class="at">      </span><span class="fu">run</span><span class="kw">:</span><span class="at"> stack --system-ghc build --only-dependencies</span></span>
<span id="cb5-22"><a href="#cb5-22"></a><span class="at">    </span><span class="kw">-</span><span class="at"> </span><span class="fu">name</span><span class="kw">:</span><span class="at"> Build binary</span></span>
<span id="cb5-23"><a href="#cb5-23"></a><span class="at">      </span><span class="fu">run</span><span class="kw">:</span><span class="at"> stack --system-ghc install --local-bin-path=./bin</span></span></code></pre></div>
<p>なんと system-ghc を使うことで <code>~/.stack/programs</code> が保存されなくなった（ここには stack がインストールした GHC が保存されてた）． これで，半分弱の削減に成功．残り約500MB．</p>
<h3 id="必殺奥義-分割キャッシュ">必殺奥義: 分割キャッシュ</h3>
<p>実は，キャッシュの最大サイズ 400MB は <strong>一つのディレクトリ毎の最大サイズ</strong> だ． なので，別々のディレクトリを別々にキャッシュすれば，最大 2GB までキャッシュできる（これがリポジトリ単位での最大サイズ）．</p>
<p><code>~/.stack/pantry</code> というのが単体で 1.3GB ある． なので，これだけとそれ以外をキャッシュするようにしてみる． ちなみに，<a href="https://docs.haskellstack.org/en/stable/pantry">Pantry というのが Stack の依存パッケージのキャッシュシステム</a>だ．</p>
<p>ここで問題が1つ． actions/cache はディレクトリを1つ指定して，それを圧縮しキャッシュしする． 複数のディレクトリを指定したり，中の一部のファイルだけを除外したりなどはできない（少なくとも現在のバージョンでは）． もちろん，一旦 <code>mv</code> してキャッシュし，restore したら <code>mv</code> し直せば良い． が，めんどいね． 単純なことはソフトウェアで解決しよう． ソフトウェアエンジニアの精神です（？）．</p>
<p>ということで，それをやってくれるアクションがこちら:</p>
<ul>
<li><a href="https://github.com/matsubara0507/actions/tree/master/move-files">actions/move-files at master · matsubara0507/actions</a></li>
</ul>
<p>ついに TypeScript デビューした． はい，actions/cache を参考にしてきていい感じに書き直しただけです． <code>mkdir</code> や <code>mv</code> は <a href="https://github.com/actions/toolkit/tree/master/packages/io">actions/toolkit</a> にあるので簡単に実装できた:</p>
<div class="sourceCode" id="cb6"><pre class="sourceCode typescript"><code class="sourceCode typescript"><span id="cb6-1"><a href="#cb6-1"></a><span class="im">import</span> <span class="op">*</span> <span class="im">as</span> core <span class="im">from</span> <span class="st">&quot;@actions/core&quot;</span><span class="op">;</span></span>
<span id="cb6-2"><a href="#cb6-2"></a><span class="im">import</span> <span class="op">*</span> <span class="im">as</span> io <span class="im">from</span> <span class="st">&quot;@actions/io&quot;</span><span class="op">;</span></span>
<span id="cb6-3"><a href="#cb6-3"></a><span class="im">import</span> <span class="op">*</span> <span class="im">as</span> utils <span class="im">from</span> <span class="st">&quot;./utils/actionUtils&quot;</span><span class="op">;</span></span>
<span id="cb6-4"><a href="#cb6-4"></a></span>
<span id="cb6-5"><a href="#cb6-5"></a><span class="kw">async</span> <span class="kw">function</span> <span class="fu">run</span>()<span class="op">:</span> <span class="bu">Promise</span><span class="op">&lt;</span><span class="dt">void</span><span class="op">&gt;</span> <span class="op">{</span></span>
<span id="cb6-6"><a href="#cb6-6"></a>    <span class="cf">try</span> <span class="op">{</span></span>
<span id="cb6-7"><a href="#cb6-7"></a>        <span class="kw">const</span> source <span class="op">=</span> <span class="va">utils</span><span class="op">.</span><span class="fu">resolvePath</span>(</span>
<span id="cb6-8"><a href="#cb6-8"></a>            <span class="va">core</span><span class="op">.</span><span class="fu">getInput</span>(<span class="st">&quot;source_dir&quot;</span><span class="op">,</span> <span class="op">{</span> required<span class="op">:</span> <span class="kw">true</span> <span class="op">}</span>)</span>
<span id="cb6-9"><a href="#cb6-9"></a>        )<span class="op">;</span></span>
<span id="cb6-10"><a href="#cb6-10"></a>        <span class="co">// 残念ながら inputs は文字列しか渡せないので改行で分割してる</span></span>
<span id="cb6-11"><a href="#cb6-11"></a>        <span class="kw">const</span> files <span class="op">=</span> core</span>
<span id="cb6-12"><a href="#cb6-12"></a>            .<span class="fu">getInput</span>(<span class="st">&quot;source_files&quot;</span><span class="op">,</span> <span class="op">{</span> required<span class="op">:</span> <span class="kw">true</span> <span class="op">}</span>)</span>
<span id="cb6-13"><a href="#cb6-13"></a>            .<span class="fu">split</span>(<span class="ss">/</span><span class="sc">\r?\n</span><span class="ss">/</span>)</span>
<span id="cb6-14"><a href="#cb6-14"></a>            .<span class="fu">filter</span>(pat <span class="kw">=&gt;</span> pat)</span>
<span id="cb6-15"><a href="#cb6-15"></a>            .<span class="fu">map</span>(pat <span class="kw">=&gt;</span> <span class="va">pat</span><span class="op">.</span><span class="fu">trim</span>())<span class="op">;</span></span>
<span id="cb6-16"><a href="#cb6-16"></a>        <span class="kw">const</span> target <span class="op">=</span> <span class="va">utils</span><span class="op">.</span><span class="fu">resolvePath</span>(</span>
<span id="cb6-17"><a href="#cb6-17"></a>            <span class="va">core</span><span class="op">.</span><span class="fu">getInput</span>(<span class="st">&quot;target_dir&quot;</span><span class="op">,</span> <span class="op">{</span> required<span class="op">:</span> <span class="kw">true</span> <span class="op">}</span>)</span>
<span id="cb6-18"><a href="#cb6-18"></a>        )<span class="op">;</span></span>
<span id="cb6-19"><a href="#cb6-19"></a></span>
<span id="cb6-20"><a href="#cb6-20"></a>        <span class="cf">await</span> <span class="va">io</span><span class="op">.</span><span class="fu">mkdirP</span>(target)<span class="op">;</span></span>
<span id="cb6-21"><a href="#cb6-21"></a>        <span class="va">core</span><span class="op">.</span><span class="fu">debug</span>(<span class="vs">`mkdir -p </span><span class="sc">${</span>target<span class="sc">}</span><span class="vs">`</span>)<span class="op">;</span></span>
<span id="cb6-22"><a href="#cb6-22"></a></span>
<span id="cb6-23"><a href="#cb6-23"></a>        <span class="va">files</span><span class="op">.</span><span class="fu">forEach</span>(<span class="kw">async</span> <span class="fu">function</span>(file) <span class="op">{</span></span>
<span id="cb6-24"><a href="#cb6-24"></a>            <span class="cf">try</span> <span class="op">{</span></span>
<span id="cb6-25"><a href="#cb6-25"></a>                <span class="kw">const</span> path <span class="op">=</span> <span class="va">source</span><span class="op">.</span><span class="fu">concat</span>(<span class="st">&quot;/&quot;</span><span class="op">,</span> file)<span class="op">;</span></span>
<span id="cb6-26"><a href="#cb6-26"></a>                <span class="cf">await</span> <span class="va">io</span><span class="op">.</span><span class="fu">mv</span>(path<span class="op">,</span> target)<span class="op">;</span></span>
<span id="cb6-27"><a href="#cb6-27"></a>                <span class="va">core</span><span class="op">.</span><span class="fu">debug</span>(<span class="vs">`mv </span><span class="sc">${</span>path<span class="sc">}</span><span class="vs"> to </span><span class="sc">${</span>target<span class="sc">}</span><span class="vs">`</span>)<span class="op">;</span></span>
<span id="cb6-28"><a href="#cb6-28"></a>            <span class="op">}</span> <span class="fu">catch</span> (error) <span class="op">{</span></span>
<span id="cb6-29"><a href="#cb6-29"></a>                <span class="va">core</span><span class="op">.</span><span class="fu">warning</span>(<span class="va">error</span><span class="op">.</span><span class="at">message</span>)<span class="op">;</span></span>
<span id="cb6-30"><a href="#cb6-30"></a>            <span class="op">}</span></span>
<span id="cb6-31"><a href="#cb6-31"></a>        <span class="op">}</span>)<span class="op">;</span></span>
<span id="cb6-32"><a href="#cb6-32"></a>    <span class="op">}</span> <span class="fu">catch</span> (error) <span class="op">{</span></span>
<span id="cb6-33"><a href="#cb6-33"></a>        <span class="va">core</span><span class="op">.</span><span class="fu">warning</span>(<span class="va">error</span><span class="op">.</span><span class="at">message</span>)<span class="op">;</span></span>
<span id="cb6-34"><a href="#cb6-34"></a>    <span class="op">}</span></span>
<span id="cb6-35"><a href="#cb6-35"></a><span class="op">}</span></span>
<span id="cb6-36"><a href="#cb6-36"></a></span>
<span id="cb6-37"><a href="#cb6-37"></a><span class="fu">run</span>()<span class="op">;</span></span>
<span id="cb6-38"><a href="#cb6-38"></a></span>
<span id="cb6-39"><a href="#cb6-39"></a><span class="im">export</span> <span class="im">default</span> run<span class="op">;</span></span></code></pre></div>
<p>使うときはこんな感じ:</p>
<div class="sourceCode" id="cb7"><pre class="sourceCode yaml"><code class="sourceCode yaml"><span id="cb7-1"><a href="#cb7-1"></a><span class="at">    </span><span class="kw">-</span><span class="at"> </span><span class="fu">name</span><span class="kw">:</span><span class="at"> Move .stack/pantry to temp</span></span>
<span id="cb7-2"><a href="#cb7-2"></a><span class="at">      </span><span class="fu">uses</span><span class="kw">:</span><span class="at"> matsubara0507/actions/move-files@master</span></span>
<span id="cb7-3"><a href="#cb7-3"></a><span class="at">      </span><span class="fu">with</span><span class="kw">:</span></span>
<span id="cb7-4"><a href="#cb7-4"></a><span class="at">        </span><span class="fu">source_dir</span><span class="kw">:</span><span class="at"> ~/.stack-temp/pantry</span></span>
<span id="cb7-5"><a href="#cb7-5"></a><span class="fu">        source_files</span><span class="kw">: </span><span class="ch">|</span></span>
<span id="cb7-6"><a href="#cb7-6"></a>          pantry</span>
<span id="cb7-7"><a href="#cb7-7"></a><span class="at">        </span><span class="fu">target_dir</span><span class="kw">:</span><span class="at"> ~/.stack</span></span></code></pre></div>
<p>実は，GitHub Actions には隠し機能（現状ドキュメントには書いてない）として <code>post</code> と <code>post-if</code> というのがある（<code>actions.yml</code> に設定できる）:</p>
<div class="sourceCode" id="cb8"><pre class="sourceCode yaml"><code class="sourceCode yaml"><span id="cb8-1"><a href="#cb8-1"></a><span class="fu">name</span><span class="kw">:</span><span class="at"> </span><span class="st">'Move Files'</span></span>
<span id="cb8-2"><a href="#cb8-2"></a><span class="fu">description</span><span class="kw">:</span><span class="at"> </span><span class="st">'move files to other direcotory'</span></span>
<span id="cb8-3"><a href="#cb8-3"></a><span class="fu">inputs</span><span class="kw">:</span></span>
<span id="cb8-4"><a href="#cb8-4"></a><span class="at">  </span><span class="fu">source_dir</span><span class="kw">:</span></span>
<span id="cb8-5"><a href="#cb8-5"></a><span class="at">    </span><span class="fu">required</span><span class="kw">:</span><span class="at"> </span><span class="ch">true</span></span>
<span id="cb8-6"><a href="#cb8-6"></a><span class="at">  </span><span class="fu">source_files</span><span class="kw">:</span></span>
<span id="cb8-7"><a href="#cb8-7"></a><span class="at">    </span><span class="fu">required</span><span class="kw">:</span><span class="at"> </span><span class="ch">true</span></span>
<span id="cb8-8"><a href="#cb8-8"></a><span class="at">  </span><span class="fu">target_dir</span><span class="kw">:</span></span>
<span id="cb8-9"><a href="#cb8-9"></a><span class="at">    </span><span class="fu">require</span><span class="kw">:</span><span class="at"> </span><span class="ch">true</span></span>
<span id="cb8-10"><a href="#cb8-10"></a><span class="fu">runs</span><span class="kw">:</span></span>
<span id="cb8-11"><a href="#cb8-11"></a><span class="at">  </span><span class="fu">using</span><span class="kw">:</span><span class="at"> </span><span class="st">'node12'</span></span>
<span id="cb8-12"><a href="#cb8-12"></a><span class="at">  </span><span class="fu">main</span><span class="kw">:</span><span class="at"> </span><span class="st">'dist/move/index.js'</span></span>
<span id="cb8-13"><a href="#cb8-13"></a><span class="at">  </span><span class="fu">post</span><span class="kw">:</span><span class="at"> </span><span class="st">'dist/restore/index.js'</span><span class="co"> # move.ts とは全く逆のことをするだけ</span></span>
<span id="cb8-14"><a href="#cb8-14"></a><span class="at">  </span><span class="fu">post-if</span><span class="kw">:</span><span class="at"> </span><span class="st">'success()'</span><span class="co">          # move が成功したときにだけ</span></span></code></pre></div>
<p>これは <a href="https://github.com/actions/cache">actions/cache</a> や <a href="https://github.com/actions/checkout">actions/checkout</a> がやっているやつで，ジョブステップの最後にデストラクタのように指定したアクションを実行してくれる機能だ． ちなみに，実行したステップとは逆順にポストステップは実行する．</p>
<p>これと actions/cache を組み合わせることで，自由にキャッシュしたいディレクトリを分割してキャッシュすることができるようになった！</p>
<div class="sourceCode" id="cb9"><pre class="sourceCode yaml"><code class="sourceCode yaml"><span id="cb9-1"><a href="#cb9-1"></a><span class="at">    </span><span class="fu">steps</span><span class="kw">:</span></span>
<span id="cb9-2"><a href="#cb9-2"></a><span class="at">    </span><span class="kw">-</span><span class="at"> </span><span class="fu">uses</span><span class="kw">:</span><span class="at"> actions/checkout@v1</span></span>
<span id="cb9-3"><a href="#cb9-3"></a><span class="at">      </span><span class="fu">with</span><span class="kw">:</span></span>
<span id="cb9-4"><a href="#cb9-4"></a><span class="at">        </span><span class="fu">fetch-depth</span><span class="kw">:</span><span class="at"> </span><span class="dv">1</span></span>
<span id="cb9-5"><a href="#cb9-5"></a></span>
<span id="cb9-6"><a href="#cb9-6"></a><span class="at">    </span><span class="kw">-</span><span class="at"> </span><span class="fu">name</span><span class="kw">:</span><span class="at"> Cache .stack</span></span>
<span id="cb9-7"><a href="#cb9-7"></a><span class="at">      </span><span class="fu">id</span><span class="kw">:</span><span class="at"> cache-stack</span></span>
<span id="cb9-8"><a href="#cb9-8"></a><span class="at">      </span><span class="fu">uses</span><span class="kw">:</span><span class="at"> actions/cache@v1</span></span>
<span id="cb9-9"><a href="#cb9-9"></a><span class="at">      </span><span class="fu">with</span><span class="kw">:</span></span>
<span id="cb9-10"><a href="#cb9-10"></a><span class="at">        </span><span class="fu">path</span><span class="kw">:</span><span class="at"> ~/.stack</span></span>
<span id="cb9-11"><a href="#cb9-11"></a><span class="at">        </span><span class="fu">key</span><span class="kw">:</span><span class="at"> ${{ runner.os }}-stack-${{ hashFiles('**/stack.yaml.lock') }}</span></span>
<span id="cb9-12"><a href="#cb9-12"></a><span class="fu">        restore-keys</span><span class="kw">: </span><span class="ch">|</span></span>
<span id="cb9-13"><a href="#cb9-13"></a>          ${{ runner.os }}-stack-</span>
<span id="cb9-14"><a href="#cb9-14"></a></span>
<span id="cb9-15"><a href="#cb9-15"></a><span class="at">    </span><span class="kw">-</span><span class="at"> </span><span class="fu">name</span><span class="kw">:</span><span class="at"> Cache .stack/pantry</span></span>
<span id="cb9-16"><a href="#cb9-16"></a><span class="at">      </span><span class="fu">id</span><span class="kw">:</span><span class="at"> cache-pantry</span></span>
<span id="cb9-17"><a href="#cb9-17"></a><span class="at">      </span><span class="fu">uses</span><span class="kw">:</span><span class="at"> actions/cache@v1</span></span>
<span id="cb9-18"><a href="#cb9-18"></a><span class="at">      </span><span class="fu">with</span><span class="kw">:</span></span>
<span id="cb9-19"><a href="#cb9-19"></a><span class="at">        </span><span class="fu">path</span><span class="kw">:</span><span class="at"> ~/.stack-temp/pantry</span></span>
<span id="cb9-20"><a href="#cb9-20"></a><span class="at">        </span><span class="fu">key</span><span class="kw">:</span><span class="at"> ${{ runner.os }}-pantry-${{ hashFiles('**/stack.yaml.lock') }}</span></span>
<span id="cb9-21"><a href="#cb9-21"></a><span class="fu">        restore-keys</span><span class="kw">: </span><span class="ch">|</span></span>
<span id="cb9-22"><a href="#cb9-22"></a>          ${{ runner.os }}-pantry-</span>
<span id="cb9-23"><a href="#cb9-23"></a></span>
<span id="cb9-24"><a href="#cb9-24"></a><span class="at">    </span><span class="kw">-</span><span class="at"> </span><span class="fu">name</span><span class="kw">:</span><span class="at"> Move .stack/pantry to temp</span></span>
<span id="cb9-25"><a href="#cb9-25"></a><span class="at">      </span><span class="fu">uses</span><span class="kw">:</span><span class="at"> matsubara0507/actions/move-files@master</span></span>
<span id="cb9-26"><a href="#cb9-26"></a><span class="at">      </span><span class="fu">with</span><span class="kw">:</span></span>
<span id="cb9-27"><a href="#cb9-27"></a><span class="at">        </span><span class="fu">source_dir</span><span class="kw">:</span><span class="at"> ~/.stack-temp/pantry</span></span>
<span id="cb9-28"><a href="#cb9-28"></a><span class="fu">        source_files</span><span class="kw">: </span><span class="ch">|</span></span>
<span id="cb9-29"><a href="#cb9-29"></a>          pantry</span>
<span id="cb9-30"><a href="#cb9-30"></a><span class="at">        </span><span class="fu">target_dir</span><span class="kw">:</span><span class="at"> ~/.stack</span></span>
<span id="cb9-31"><a href="#cb9-31"></a></span>
<span id="cb9-32"><a href="#cb9-32"></a><span class="at">    </span><span class="kw">-</span><span class="at"> </span><span class="fu">uses</span><span class="kw">:</span><span class="at"> actions/setup-haskell@v1</span></span>
<span id="cb9-33"><a href="#cb9-33"></a><span class="at">    ...</span></span></code></pre></div>
<p>ちょっとわかりにくいですが，別々にキャッシュしたディレクトリを <code>move-files</code> で合体させるイメージ．</p>
<h3 id="キャッシュバージョンを付ける">キャッシュバージョンを付ける</h3>
<p>今回の PR のコミット履歴を見るとわかるのだが迷走してる． なぜかというと，actions/cache の「cache save は cache key が <strong>ヒットしなかったときにだけ</strong> 行う」という性質に気づくのに時間がかかったから． <code>key</code> にはヒットせず <code>restore-keys</code> でヒットしたときには restore をして更にキャッシュを更新する． しかし，key に変更が無いとズーーーット古いキャッシュを使い続けてしまった． 変だと思った．</p>
<p><a href="https://github.com/actions/cache/issues/2">現状キャッシュを手動でクリアする方法が無い</a>． まぁなんでも良かったので cache-version というサフィックスを付けることにした笑:</p>
<div class="sourceCode" id="cb10"><pre class="sourceCode yaml"><code class="sourceCode yaml"><span id="cb10-1"><a href="#cb10-1"></a><span class="at">    </span><span class="fu">strategy</span><span class="kw">:</span></span>
<span id="cb10-2"><a href="#cb10-2"></a><span class="at">      </span><span class="fu">matrix</span><span class="kw">:</span></span>
<span id="cb10-3"><a href="#cb10-3"></a><span class="at">        </span><span class="fu">ghc</span><span class="kw">:</span><span class="at"> </span><span class="kw">[</span><span class="st">&quot;8.6.5&quot;</span><span class="kw">]</span></span>
<span id="cb10-4"><a href="#cb10-4"></a><span class="at">        </span><span class="fu">cabal</span><span class="kw">:</span><span class="at"> </span><span class="kw">[</span><span class="st">&quot;3.0&quot;</span><span class="kw">]</span></span>
<span id="cb10-5"><a href="#cb10-5"></a><span class="at">        </span><span class="fu">cache-version</span><span class="kw">:</span><span class="at"> </span><span class="kw">[</span><span class="st">&quot;v4&quot;</span><span class="kw">]</span></span>
<span id="cb10-6"><a href="#cb10-6"></a></span>
<span id="cb10-7"><a href="#cb10-7"></a><span class="at">    </span><span class="fu">steps</span><span class="kw">:</span></span>
<span id="cb10-8"><a href="#cb10-8"></a><span class="at">    </span><span class="kw">-</span><span class="at"> </span><span class="fu">uses</span><span class="kw">:</span><span class="at"> actions/checkout@v1</span></span>
<span id="cb10-9"><a href="#cb10-9"></a><span class="at">      </span><span class="fu">with</span><span class="kw">:</span></span>
<span id="cb10-10"><a href="#cb10-10"></a><span class="at">        </span><span class="fu">fetch-depth</span><span class="kw">:</span><span class="at"> </span><span class="dv">1</span></span>
<span id="cb10-11"><a href="#cb10-11"></a></span>
<span id="cb10-12"><a href="#cb10-12"></a><span class="at">    </span><span class="kw">-</span><span class="at"> </span><span class="fu">name</span><span class="kw">:</span><span class="at"> Cache .stack</span></span>
<span id="cb10-13"><a href="#cb10-13"></a><span class="at">      </span><span class="fu">id</span><span class="kw">:</span><span class="at"> cache-stack</span></span>
<span id="cb10-14"><a href="#cb10-14"></a><span class="at">      </span><span class="fu">uses</span><span class="kw">:</span><span class="at"> actions/cache@v1</span></span>
<span id="cb10-15"><a href="#cb10-15"></a><span class="at">      </span><span class="fu">with</span><span class="kw">:</span></span>
<span id="cb10-16"><a href="#cb10-16"></a><span class="at">        </span><span class="fu">path</span><span class="kw">:</span><span class="at"> ~/.stack</span></span>
<span id="cb10-17"><a href="#cb10-17"></a><span class="at">        </span><span class="fu">key</span><span class="kw">:</span><span class="at"> ${{ runner.os }}-stack-${{ hashFiles('**/stack.yaml.lock') }}-${{ matrix.cache-version }}</span></span>
<span id="cb10-18"><a href="#cb10-18"></a><span class="fu">        restore-keys</span><span class="kw">: </span><span class="ch">|</span></span>
<span id="cb10-19"><a href="#cb10-19"></a>          ${{ runner.os }}-stack-</span></code></pre></div>
<p>少なくとも，キャッシュを試行錯誤してるときには便利だ．</p>
<h3 id="ビフォーアフター">ビフォーアフター</h3>
<p>もともと25分以上かかかっていたビルドが:</p>
<p><img src="../assets/haskell-with-gh-actions/before.jpg" /></p>
<p>なんと2分まで減った！</p>
<p><img src="../assets/haskell-with-gh-actions/after.jpg" /></p>
<h2 id="おまけ-github-packages">おまけ: GitHub Packages</h2>
<p>Haskell プログラムのバイナリを配布するために，僕は普段 Docker Image にして Docker Hub に置いてた． しかし，先日 GitHub の 2019年のもう一つの目玉機能「GitHub Packages」も GA されたので，こっちに置いてみることにした（なんと Docker レジストリにもなる）．</p>
<p><a href="https://github.com/matsubara0507/octbook/packages"><img src="../assets/haskell-with-gh-actions/image.jpg" /></a></p>
<p>ちなみに，現状パブリックリポジトリのパッケージであっても <code>docker pull</code> するのに認証が必要である． その点がとても残念(改善されることを祈る)．</p>
<h3 id="ログイン">ログイン</h3>
<p>意外と手間取った． どうやら MFA 設定してるとトークンを使う他ないらしい． しかも，新しく（？）追加された <code>write:packages</code> というスコープをオンしないとダメっぽい．</p>
<h3 id="github-actions-からプッシュ">GitHub Actions からプッシュ</h3>
<p>こんな感じ</p>
<div class="sourceCode" id="cb11"><pre class="sourceCode yaml"><code class="sourceCode yaml"><span id="cb11-1"><a href="#cb11-1"></a><span class="at">    </span><span class="kw">-</span><span class="at"> </span><span class="fu">name</span><span class="kw">:</span><span class="at"> Build binary</span></span>
<span id="cb11-2"><a href="#cb11-2"></a><span class="at">      </span><span class="fu">run</span><span class="kw">:</span><span class="at"> stack --system-ghc install --local-bin-path=./bin</span></span>
<span id="cb11-3"><a href="#cb11-3"></a></span>
<span id="cb11-4"><a href="#cb11-4"></a><span class="at">    </span><span class="kw">-</span><span class="at"> </span><span class="fu">name</span><span class="kw">:</span><span class="at"> Build Docker Image</span></span>
<span id="cb11-5"><a href="#cb11-5"></a><span class="at">      </span><span class="fu">run</span><span class="kw">:</span><span class="at"> docker build -t octbook . --build-arg local_bin_path=./bin</span></span>
<span id="cb11-6"><a href="#cb11-6"></a></span>
<span id="cb11-7"><a href="#cb11-7"></a><span class="at">    </span><span class="kw">-</span><span class="at"> </span><span class="fu">name</span><span class="kw">:</span><span class="at"> Push Docker Image</span></span>
<span id="cb11-8"><a href="#cb11-8"></a><span class="at">      </span><span class="fu">if</span><span class="kw">:</span><span class="at"> github.ref == 'refs/heads/master'</span></span>
<span id="cb11-9"><a href="#cb11-9"></a><span class="fu">      run</span><span class="kw">: </span><span class="ch">|</span></span>
<span id="cb11-10"><a href="#cb11-10"></a>        echo ${{ secrets.GITHUB_TOKEN }} | docker login docker.pkg.github.com -u matsubara0507 --password-stdin</span>
<span id="cb11-11"><a href="#cb11-11"></a>        docker tag octbook docker.pkg.github.com/matsubara0507/octbook/cli</span>
<span id="cb11-12"><a href="#cb11-12"></a>        docker push docker.pkg.github.com/matsubara0507/octbook/cli:latest</span>
<span id="cb11-13"><a href="#cb11-13"></a></span>
<span id="cb11-14"><a href="#cb11-14"></a><span class="at">    </span><span class="kw">-</span><span class="at"> </span><span class="fu">name</span><span class="kw">:</span><span class="at"> Push Docker Image (tag)</span></span>
<span id="cb11-15"><a href="#cb11-15"></a><span class="at">      </span><span class="fu">if</span><span class="kw">:</span><span class="at"> startsWith(github.ref, 'refs/tags/')</span></span>
<span id="cb11-16"><a href="#cb11-16"></a><span class="fu">      run</span><span class="kw">: </span><span class="ch">|</span></span>
<span id="cb11-17"><a href="#cb11-17"></a>        echo ${{ secrets.GITHUB_TOKEN }} | docker login docker.pkg.github.com -u matsubara0507 --password-stdin</span>
<span id="cb11-18"><a href="#cb11-18"></a>        docker tag octbook docker.pkg.github.com/matsubara0507/octbook/cli:${GITHUB_REF#refs/tags/}</span>
<span id="cb11-19"><a href="#cb11-19"></a>        docker push docker.pkg.github.com/matsubara0507/octbook/cli:${GITHUB_REF#refs/tags/}</span></code></pre></div>
<p><code>if: github.ref == 'refs/heads/master'</code> とすることで master ブランチのときだけ，<code>if: startsWith(github.ref, 'refs/tags/')</code> とすることで tag のときだけ，それぞれのステップを評価させることができる．</p>
<p>ちなみに，<code>GITHUB_TOKEN</code> という Secret はデフォルトで用意されてる． <a href="https://help.github.com/en/actions/automating-your-workflow-with-github-actions/authenticating-with-the-github_token#permissions-for-the-github_token">スコープについてはここに書いてある</a>． packages の read/write があるのでそのまま利用できるね．</p>
<h2 id="おしまい">おしまい</h2>
<p>まぁきっと数ヶ月後ぐらいにはキャッシュ容量の制限が緩和されてこんなことしなくても良くなると思うけど．</p>
  </div>

  <footer class="post-footer">
    <a href="https://twitter.com/share?ref_src=twsrc%5Etfw" class="twitter-share-button" data-show-count="false">Tweet</a>
    <script async src="https://platform.twitter.com/widgets.js" charset="utf-8"></script>
  </footer>
</div>
</article>

          </div>
        </div>

        <footer class="site-footer">

  <div class="wrapper">

    <span class="footer-heading">ひげメモ</span>

  </div>

  <div class="page-content card" style="display: flex; justify-content: center; padding: 5px 0px">
    <a href="https://haskell.jp/blog/posts/links.html#matsubara0507.github.io">
      <img width="234" src="https://haskell.jp/img/supported-by-haskell-jp.svg" alt="Supported By Haskell-jp.">
    </a>
  </div>

</footer>


      </div>
  </body>

</html>
