<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE html>
<html lang="ja">

  <head>
  <meta charset="utf-8">
  <link rel="icon" href="../assets/icon.jpg">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
    
      <meta property="og:title" content="rust-reversi やってみた" />
    
  

  <meta property="og:site_name" content="ひげメモ" />

  

  
    <script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-86386380-1', 'auto');
  ga('send', 'pageview');
</script>

  

  <title>
    
      
        rust-reversi やってみた
      
    
  </title>

  <link rel="stylesheet" href="../css/main.css">
  <link rel="stylesheet" href="../css/highlight.css">
  <link rel="stylesheet" type="text/css" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.4.0/css/font-awesome.min.css" />
</head>


  <body>
      <div class="outer">

        <header class="site-header">

  <div class="wrapper">

    <a class="site-title" href="https://matsubara0507.github.io/">ひげメモ</a>

  </div>

  <div class="header-badge">
    <a href="https://matsubara0507.github.io/">
        <img src="../assets/icon.jpg" />
    </a>
  </div>

</header>


        <div class="page-content">
          <div class="wrapper">
            <article class="post card" itemscope itemtype="http://schema.org/BlogPosting">
 <div class="card-content">
  <header class="post-header">
    <h1 class="post-title" itemprop="name headline">rust-reversi やってみた</h1>
    <p class="post-meta">
      <time datetime="2018-06-21" itemprop="datePublished">
        Jun 21, 2018
      </time>
      
      
      <div class="tags">
          <i class="fa fa-tags"></i> <a href="../tags/Rust.html">Rust</a>
      </div>
      
    </p>
  </header>

  <div class="post-content" itemprop="articleBody">
    <p>現在，会社の同期と週一で Rust の勉強会をやっていまして，普段は <a href="https://y-yu.github.io/trpl-2nd-pdf/book.pdf">The Rust Programming Language: 2nd Edition の日本語版</a> を輪読しているのですが，3月ぐらいにあった <a href="https://internship.cookpad.com/2018/spring/">Cookpad Spring 1day Internship 2018</a> の Rust コースの資料が公開されたため，皆でハッカソンしてみました．</p>
<ul>
<li><a href="https://github.com/KOBA789/rust-reversi">KOBA789/rust-reversi: Cookpad Spring 1day Internship 2018 Rust プログラミングコースで使用された講義資料 - GitHub</a></li>
</ul>
<p>今回は実際にやってみてのメモ書きです． 主に躓いたとこのメモです．</p>
<h2 id="section"></h2>
<p>ちなみに，ぼくの Rust の経験値は上記の本を17章まで読んだだけで，ほとんど書いたことないですね(輪読は7章，自分で少し先を読んでいる)． あと，<a href="https://github.com/matsubara0507/rust-reversi/tree/reversi-impl">回答はフォークしてあげてあります</a>．</p>
<h3 id="躓いたところ">躓いたところ</h3>
<p>めちゃくちゃしょーーーーもないところばっかです(笑)</p>
<ol type="1">
<li>固定長配列の map</li>
<li>パターンマッチの変数</li>
<li>index の x と y が逆</li>
<li>既に置いてあるかの検査</li>
</ol>
<h3 id="何を作っているか">何を作っているか</h3>
<p>そもそも課題は何かというと，オセロ(リバーシ)です． 試しに実行してみるとこんな感じ．</p>
<pre><code>$ cargo run
   Compiling reversi v0.1.0 (file:///Users/nobutada.matsubara/git/rust/rust-reversi)
     Running `target/debug/reversi`
  a b c d e f g h
 +-+-+-+-+-+-+-+-+
1| | | | | | | | |
 +-+-+-+-+-+-+-+-+
2| | | | | | | | |
 +-+-+-+-+-+-+-+-+
3| | | | | | | | |
 +-+-+-+-+-+-+-+-+
4| | | |O|X| | | |
 +-+-+-+-+-+-+-+-+
5| | | |X|O| | | |
 +-+-+-+-+-+-+-+-+
6| | | | | | | | |
 +-+-+-+-+-+-+-+-+
7| | | | | | | | |
 +-+-+-+-+-+-+-+-+
8| | | | | | | | |
 +-+-+-+-+-+-+-+-+

B 2 - 2 W
Turn: Black
  a b c d e f g h
 +-+-+-+-+-+-+-+-+
1| | | | | | | | |
 +-+-+-+-+-+-+-+-+
2| | | | | | | | |
 +-+-+-+-+-+-+-+-+
3| | | | | | | | |
 +-+-+-+-+-+-+-+-+
4| | |X|X|X| | | |
 +-+-+-+-+-+-+-+-+
5| | | |X|O| | | |
 +-+-+-+-+-+-+-+-+
6| | | | | | | | |
 +-+-+-+-+-+-+-+-+
7| | | | | | | | |
 +-+-+-+-+-+-+-+-+
8| | | | | | | | |
 +-+-+-+-+-+-+-+-+

B 4 - 1 W
Turn: White
0) c3
1) c5
2) e3</code></pre>
<p>全部一から作れではなく，リポジトリをクローンして <code>src/coord.rs</code> と <code>src/board.rs</code> の <code>unimplemented!();</code> となっている個所の実装を与えるだけ． ご丁寧なことにテストも用意してあるので，<code>cargo test</code> を実行しまくってオールグリーンになれば出来上がり(たぶん)．</p>
<h2 id="section-1"></h2>
<p>ちなみに，クライアントの同期が <code>unimplemented();</code> に感動していたので，調子に乗って <a href="https://matthew.brecknell.net/post/hole-driven-haskell/">Hole driven Programming</a> について語ってしまった．</p>
<h3 id="関数が呼べない">0. 関数が呼べない</h3>
<p>ゼロ引数関数は <code>xxx.method</code> はダメで，<code>xxx.method()</code> しなきゃいけないってのが何度もあった(笑) 普段は Haskell を書いているせいですね．</p>
<h3 id="固定長配列の-map">1. 固定長配列の map</h3>
<div class="sourceCode" id="cb2"><pre class="sourceCode rust"><code class="sourceCode rust"><a class="sourceLine" id="cb2-1" data-line-number="1"><span class="co">/// 指定の色の石を指定の位置に置いたとき、指定の方向へひっくり返せる石の数を返す</span></a>
<a class="sourceLine" id="cb2-2" data-line-number="2"><span class="kw">fn</span> get_flip(&amp;<span class="kw">self</span>, piece: Piece, <span class="kw">mut</span> pos: Coord, dir: Coord) -&gt; <span class="dt">u8</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb2-3" data-line-number="3">    ...</a>
<a class="sourceLine" id="cb2-4" data-line-number="4"><span class="op">}</span></a>
<a class="sourceLine" id="cb2-5" data-line-number="5"></a>
<a class="sourceLine" id="cb2-6" data-line-number="6"><span class="co">/// 指定の色の石を指定の位置に置いたときの `Move` を返す</span></a>
<a class="sourceLine" id="cb2-7" data-line-number="7"><span class="co">/// 戻り値の `Move` には8方向分の `get_flip` の結果が含まれる</span></a>
<a class="sourceLine" id="cb2-8" data-line-number="8"><span class="kw">fn</span> get_move(&amp;<span class="kw">self</span>, piece: Piece, pos: Coord) -&gt; Move <span class="op">{</span></a>
<a class="sourceLine" id="cb2-9" data-line-number="9">    <span class="pp">unimplemented!</span>();</a>
<a class="sourceLine" id="cb2-10" data-line-number="10"><span class="op">}</span></a></code></pre></div>
<p>とあり</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode rust"><code class="sourceCode rust"><a class="sourceLine" id="cb3-1" data-line-number="1"><span class="kw">pub</span> <span class="kw">struct</span> Move <span class="op">{</span></a>
<a class="sourceLine" id="cb3-2" data-line-number="2">    <span class="kw">pub</span> pos: Coord,</a>
<a class="sourceLine" id="cb3-3" data-line-number="3">    flips: <span class="op">[</span><span class="dt">u8</span>; <span class="dv">8</span><span class="op">]</span>,</a>
<a class="sourceLine" id="cb3-4" data-line-number="4"><span class="op">}</span></a>
<a class="sourceLine" id="cb3-5" data-line-number="5"></a>
<a class="sourceLine" id="cb3-6" data-line-number="6"><span class="kw">const</span> DIRECTIONS: <span class="op">[</span>Coord; <span class="dv">8</span><span class="op">]</span> = <span class="op">[</span></a>
<a class="sourceLine" id="cb3-7" data-line-number="7">    Coord(-<span class="dv">1</span>, -<span class="dv">1</span>), <span class="co">//左上</span></a>
<a class="sourceLine" id="cb3-8" data-line-number="8">    Coord(<span class="dv">0</span>, -<span class="dv">1</span>),  <span class="co">//真上</span></a>
<a class="sourceLine" id="cb3-9" data-line-number="9">    Coord(<span class="dv">1</span>, -<span class="dv">1</span>),  <span class="co">//右上</span></a>
<a class="sourceLine" id="cb3-10" data-line-number="10">    Coord(-<span class="dv">1</span>, <span class="dv">0</span>),  <span class="co">//真左</span></a>
<a class="sourceLine" id="cb3-11" data-line-number="11">    Coord(<span class="dv">1</span>, <span class="dv">0</span>),   <span class="co">//真右</span></a>
<a class="sourceLine" id="cb3-12" data-line-number="12">    Coord(-<span class="dv">1</span>, <span class="dv">1</span>),  <span class="co">//左下</span></a>
<a class="sourceLine" id="cb3-13" data-line-number="13">    Coord(<span class="dv">0</span>, <span class="dv">1</span>),   <span class="co">//真下</span></a>
<a class="sourceLine" id="cb3-14" data-line-number="14">    Coord(<span class="dv">1</span>, <span class="dv">1</span>),   <span class="co">//右下</span></a>
<a class="sourceLine" id="cb3-15" data-line-number="15"><span class="op">]</span>;</a></code></pre></div>
<p>なので，<code>move.flips = DIRECTIONS.map (|dir| self.get_flip(piece, pos, dir))</code> って具合にいけそうだと思ったのだ． しかし，悲しいことに組み込みでは <strong>固定長配列に対するこのような操作はないようだ</strong>(間違っていたらゴメンナサイ…)． なので結局諦めて for 文を回した…</p>
<p>何か良い方法があったら教えて欲しい.</p>
<h3 id="パターンマッチの変数">2. パターンマッチの変数</h3>
<p>すごい間抜けな話です．</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode rust"><code class="sourceCode rust"><a class="sourceLine" id="cb4-1" data-line-number="1"><span class="co">/// 指定の色の石を指定の位置に置いたとき、指定の方向へひっくり返せる石の数を返す</span></a>
<a class="sourceLine" id="cb4-2" data-line-number="2"><span class="co">///</span></a>
<a class="sourceLine" id="cb4-3" data-line-number="3"><span class="co">/// * `piece` - 置く石の色</span></a>
<a class="sourceLine" id="cb4-4" data-line-number="4"><span class="co">/// * `pos` - 石を置く位置</span></a>
<a class="sourceLine" id="cb4-5" data-line-number="5"><span class="co">/// * `dir` - ひっくり返せる石を探す方向。`DIRECTIONS` の要素のいずれかが渡される</span></a>
<a class="sourceLine" id="cb4-6" data-line-number="6"><span class="kw">fn</span> get_flip(&amp;<span class="kw">self</span>, piece: Piece, <span class="kw">mut</span> pos: Coord, dir: Coord) -&gt; <span class="dt">u8</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb4-7" data-line-number="7">    <span class="kw">let</span> opponent = piece.opponent();</a>
<a class="sourceLine" id="cb4-8" data-line-number="8">    <span class="kw">let</span> <span class="kw">mut</span> cnt = <span class="dv">0</span>;</a>
<a class="sourceLine" id="cb4-9" data-line-number="9">    <span class="kw">loop</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb4-10" data-line-number="10">        pos += dir;</a>
<a class="sourceLine" id="cb4-11" data-line-number="11">        <span class="kw">match</span> <span class="kw">self</span>.matrix<span class="op">[</span>pos<span class="op">]</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb4-12" data-line-number="12">            <span class="cn">None</span>           =&gt; <span class="kw">return</span> <span class="dv">0</span>,</a>
<a class="sourceLine" id="cb4-13" data-line-number="13">            <span class="cn">Some</span>(piece)    =&gt; <span class="kw">return</span> cnt,</a>
<a class="sourceLine" id="cb4-14" data-line-number="14">            <span class="cn">Some</span>(opponent) =&gt; cnt += <span class="dv">1</span>,</a>
<a class="sourceLine" id="cb4-15" data-line-number="15">        <span class="op">}</span></a>
<a class="sourceLine" id="cb4-16" data-line-number="16">    <span class="op">}</span></a>
<a class="sourceLine" id="cb4-17" data-line-number="17"><span class="op">}</span></a></code></pre></div>
<p>とか書いていたが，全然テストが通らない． それもそのはずで <strong>パターンマッチの中の変数は代入になる</strong> だけで，<code>if self.matrix[target] == Some(piece) { ... }</code> とは異なる． シャーディングぅぅぅぅぅとか思ったけど，きっと警告出てたよね…</p>
<pre><code>warning: unreachable pattern
   --&gt; src/board.rs:165:17
    |
165 |                 Some(opponent) =&gt; cnt += 1,
    |                 ^^^^^^^^^^^^^^
    |
    = note: #[warn(unreachable_patterns)] on by default

warning: unused variable: `opponent`
   --&gt; src/board.rs:158:13
    |
158 |         let opponent = piece.opponent();
    |             ^^^^^^^^ help: consider using `_opponent` instead
    |
    = note: #[warn(unused_variables)] on by default

warning: unused variable: `piece`
   --&gt; src/board.rs:164:22
    |
164 |                 Some(piece)    =&gt; return cnt,
    |                      ^^^^^ help: consider using `_piece` instead

warning: unused variable: `opponent`
   --&gt; src/board.rs:165:22
    |
165 |                 Some(opponent) =&gt; cnt += 1,
    |                      ^^^^^^^^ help: consider using `_opponent` instead</code></pre>
<p>出てたね…</p>
<h3 id="index-の-x-と-y-が逆">3. index の x と y が逆</h3>
<p>普段二重配列とかやんないからさ…</p>
<div class="sourceCode" id="cb6"><pre class="sourceCode rust"><code class="sourceCode rust"><a class="sourceLine" id="cb6-1" data-line-number="1"><span class="co">/// ベクトルを表現する構造体</span></a>
<a class="sourceLine" id="cb6-2" data-line-number="2"><span class="kw">pub</span> <span class="kw">struct</span> Coord(<span class="kw">pub</span> <span class="dt">i8</span>, <span class="kw">pub</span> <span class="dt">i8</span>);</a>
<a class="sourceLine" id="cb6-3" data-line-number="3"></a>
<a class="sourceLine" id="cb6-4" data-line-number="4"><span class="co">/// `[]` 演算子のオーバーロード</span></a>
<a class="sourceLine" id="cb6-5" data-line-number="5"><span class="kw">impl</span> Index&lt;Coord&gt; <span class="kw">for</span> Matrix <span class="op">{</span></a>
<a class="sourceLine" id="cb6-6" data-line-number="6">    <span class="kw">type</span> Output = <span class="dt">Option</span>&lt;Piece&gt;;</a>
<a class="sourceLine" id="cb6-7" data-line-number="7">    <span class="co">/// 第一引数に与えられた座標の状態を返す</span></a>
<a class="sourceLine" id="cb6-8" data-line-number="8">    <span class="co">/// 座標が盤面の範囲外であった場合は None が返る。</span></a>
<a class="sourceLine" id="cb6-9" data-line-number="9">    <span class="kw">fn</span> index(&amp;<span class="kw">self</span>, index: Coord) -&gt; &amp;<span class="kw">Self</span>::Output <span class="op">{</span></a>
<a class="sourceLine" id="cb6-10" data-line-number="10">        <span class="kw">if</span> <span class="kw">self</span>.is_in_range(index) <span class="op">{</span></a>
<a class="sourceLine" id="cb6-11" data-line-number="11">            &amp;<span class="kw">self</span>.<span class="dv">0</span><span class="op">[</span>index.<span class="dv">0</span> <span class="kw">as</span> <span class="dt">usize</span><span class="op">][</span>index.<span class="dv">1</span> <span class="kw">as</span> <span class="dt">usize</span><span class="op">]</span></a>
<a class="sourceLine" id="cb6-12" data-line-number="12">        <span class="op">}</span> <span class="kw">else</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb6-13" data-line-number="13">            &amp;<span class="cn">None</span></a>
<a class="sourceLine" id="cb6-14" data-line-number="14">        <span class="op">}</span></a>
<a class="sourceLine" id="cb6-15" data-line-number="15">    <span class="op">}</span></a>
<a class="sourceLine" id="cb6-16" data-line-number="16"><span class="op">}</span></a></code></pre></div>
<p>とか最初書いていた． <code>Coord</code> 型はひとつ目が X 座標でふたつ目が Y 座標． <code>&amp;self.0[index.0 as usize][index.1 as usize]</code> のところが逆ですね…</p>
<h3 id="既に置いてあるかの検査">4. 既に置いてあるかの検査</h3>
<p><code>moves</code> のテストが何故かとおらない． <code>moves</code> は盤上の全ての合法手，“手” を表す <code>Move</code> 型は手を打つ場所(<code>Coord</code> 型)と各方向のひっくり返す数を持っている，を列挙する関数．</p>
<pre><code>---- board::tests::test_board_moves stdout ----
	thread 'board::tests::test_board_moves' panicked at 'assertion failed: `(left == right)`
  left: `6`,
 right: `37`', src/board.rs:366:9</code></pre>
<p>めちゃくちゃ多い． テストを読んでイロイロと出力させてみたところ，既にピースが置いてある場合のチェックを忘れていた(バカ)．</p>
<h3 id="オールグリーン">オールグリーン</h3>
<pre><code>$ cargo test
   Compiling reversi v0.1.0 (file:///Users/nobutada.matsubara/git/rust/rust-reversi)
    Finished dev [unoptimized + debuginfo] target(s) in 1.27 secs
     Running target/debug/deps/reversi-ae2013b8997f878b

running 12 tests
test board::tests::test_board_count_mut ... ok
test board::tests::test_board_get_move ... ok
test board::tests::test_board_get_flip ... ok
test board::tests::test_board_do_move ... ok
test board::tests::test_do_flip ... ok
test board::tests::test_matrix_index ... ok
test board::tests::test_board_moves ... ok
test board::tests::test_matrix_index_mut ... ok
test board::tests::test_matrix_is_in_range ... ok
test board::tests::test_move_is_legal ... ok
test coord::tests::test_coord_add ... ok
test coord::tests::test_coord_add_assign ... ok

test result: ok. 12 passed; 0 failed; 0 ignored; 0 measured; 0 filtered out</code></pre>
<h2 id="感想">感想</h2>
<p>基本構文を覚えてないので，とりあえず雑に書いてビルドして怒られたら直す，的なことをしながら，静的検査さいこ～とか言いながらやってた(疲れてる)． おかげで <code>&amp;</code> とか <code>*</code> を雑にあつかってて良くないですね． まぁ楽しかったからいいけど．</p>
<h2 id="おまけ">おまけ</h2>
<p><code>get_flip</code> 関数のところ，関数型プログラマーらしく(?)再帰にして見た. 速度は変わるんかな？</p>
<div class="sourceCode" id="cb9"><pre class="sourceCode rust"><code class="sourceCode rust"><a class="sourceLine" id="cb9-1" data-line-number="1"><span class="kw">fn</span> get_flip(&amp;<span class="kw">self</span>, piece: Piece, pos: Coord, dir: Coord) -&gt; <span class="dt">u8</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb9-2" data-line-number="2">    <span class="kw">self</span>.go_get_flip(piece, pos, dir).unwrap_or(<span class="dv">0</span>)</a>
<a class="sourceLine" id="cb9-3" data-line-number="3"><span class="op">}</span></a>
<a class="sourceLine" id="cb9-4" data-line-number="4"></a>
<a class="sourceLine" id="cb9-5" data-line-number="5"><span class="kw">fn</span> go_get_flip(&amp;<span class="kw">self</span>, piece: Piece, pos: Coord, dir: Coord) -&gt; <span class="dt">Option</span>&lt;<span class="dt">u8</span>&gt; <span class="op">{</span></a>
<a class="sourceLine" id="cb9-6" data-line-number="6">    <span class="kw">let</span> target = pos + dir;</a>
<a class="sourceLine" id="cb9-7" data-line-number="7">    <span class="kw">if</span> <span class="kw">self</span>.matrix<span class="op">[</span>target<span class="op">]</span> == <span class="cn">Some</span>(piece.opponent()) <span class="op">{</span></a>
<a class="sourceLine" id="cb9-8" data-line-number="8">        <span class="kw">self</span>.go_get_flip(piece, target, dir).map(|x| x + <span class="dv">1</span>)</a>
<a class="sourceLine" id="cb9-9" data-line-number="9">    <span class="op">}</span> <span class="kw">else</span> <span class="kw">if</span> <span class="kw">self</span>.matrix<span class="op">[</span>target<span class="op">]</span> == <span class="cn">Some</span>(piece) <span class="op">{</span></a>
<a class="sourceLine" id="cb9-10" data-line-number="10">        <span class="cn">Some</span>(<span class="dv">0</span>)</a>
<a class="sourceLine" id="cb9-11" data-line-number="11">    <span class="op">}</span> <span class="kw">else</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb9-12" data-line-number="12">        <span class="cn">None</span></a>
<a class="sourceLine" id="cb9-13" data-line-number="13">    <span class="op">}</span></a>
<a class="sourceLine" id="cb9-14" data-line-number="14"><span class="op">}</span></a></code></pre></div>
<h2 id="おしまい">おしまい</h2>
<p>Haskell 版でも作ってみようかしらん．</p>
  </div>
</div>
</article>

          </div>
        </div>

        <footer class="site-footer">

  <div class="wrapper">

    <span class="footer-heading">ひげメモ</span>

  </div>

  <div class="page-content card" style="display: flex; justify-content: center; padding: 5px 0px">
    <a href="https://haskell.jp/blog/posts/links.html#matsubara0507.github.io">
      <img width="234" src="https://haskell.jp/img/supported-by-haskell-jp.svg" alt="Supported By Haskell-jp.">
    </a>
  </div>

</footer>


      </div>
  </body>

</html>
