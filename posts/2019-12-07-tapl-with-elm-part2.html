<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE html>
<html lang="ja">

  <head>
  <meta charset="utf-8">
  <link rel="icon" href="../assets/icon.jpg">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
    
      <meta property="og:title" content="Elm で作る TaPL のラムダ計算（その２）" />
    
  

  <meta property="og:site_name" content="ひげメモ" />

  
    <meta property="og:image" content="/assets/tapl-with-elm/chap7.jpg" />
  

  
    <script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-86386380-1', 'auto');
  ga('send', 'pageview');
</script>

  

  <title>
    
      
        Elm で作る TaPL のラムダ計算（その２）
      
    
  </title>

  <link rel="stylesheet" href="../css/main.css">
  <link rel="stylesheet" href="../css/highlight.css">
  <link rel="stylesheet" type="text/css" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.4.0/css/font-awesome.min.css" />
</head>


  <body>
      <div class="outer">

        <header class="site-header">

  <div class="wrapper">

    <a class="site-title" href="https://matsubara0507.github.io/">ひげメモ</a>

  </div>

  <div class="header-badge">
    <a href="https://matsubara0507.github.io/">
        <img src="../assets/icon.jpg" />
    </a>
  </div>

</header>


        <div class="page-content">
          <div class="wrapper">
            <article class="post card" itemscope itemtype="http://schema.org/BlogPosting">
 <div class="card-content">
  <header class="post-header">
    <h1 class="post-title" itemprop="name headline">Elm で作る TaPL のラムダ計算（その２）</h1>
    <p class="post-meta">
      <time datetime="2019-12-07" itemprop="datePublished">
        Dec 7, 2019
      </time>
      
      
      <div class="tags">
          <i class="fa fa-tags"></i> <a href="../tags/Elm.html">Elm</a>
      </div>
      
    </p>
  </header>

  <div class="post-content" itemprop="articleBody">
    <p>本記事は「<a href="https://qiita.com/advent-calendar/2019/lang_dev">言語実装 Advent Calendar 2019</a>」の7日目の記事です．</p>
<h1 id="section"></h1>
<p>表題の通り，TaPL という書籍で紹介されているプログラミング言語の実装例を Elm でやってみたという話です（その２）． <a href="https://matsubara0507.github.io/posts/2019-12-06-tapl-with-elm-part1.html">その１</a>はこちら．</p>
<ul>
<li>第4章 算術式のML実装</li>
<li>第7章 ラムダ計算の ML 実装 (本記事はココ)
<ul>
<li>型無しラムダ計算を実装</li>
<li>以降はこれを拡張していく(たしか)</li>
</ul></li>
<li>第10章 単純型のML実装
<ul>
<li>7章のを型付きラムダ計算にする</li>
</ul></li>
<li>第17章 部分型付けの ML 実装</li>
<li>第25章 System F の ML 実装
<ul>
<li>最後に型の多相性を追加</li>
</ul></li>
</ul>
<p>実装は全て下記のリポジトリにあげています:</p>
<ul>
<li><a href="https://github.com/matsubara0507/ELaMbda">matsubara0507/ELaMbda - GitHub</a></li>
</ul>
<p>また，前回同様に<a href="https://matsubara0507.github.io/ELaMbda/?chap=chap7">Web ブラウザから遊べるようになってます</a>．</p>
<p><a href="https://matsubara0507.github.io/ELaMbda/?chap=chap7&amp;exp=(\x%20.%20x%20x)%20(\x%20.%20x%20x)"><img src="../assets/tapl-with-elm/chap7.jpg" /></a></p>
<h2 id="第7章-ラムダ計算の-ml-実装">第7章 ラムダ計算の ML 実装</h2>
<p>さぁいよいよみんな大好き(型なし)ラムダ計算です． ちなみに，ラムダ計算の数理論理学的な議論は5章でしている．</p>
<h3 id="構文規則">構文規則</h3>
<p>構文規則はこんな感じ:</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode txt"><code class="sourceCode default"><span id="cb1-1"><a href="#cb1-1"></a>t := x       [変数]</span>
<span id="cb1-2"><a href="#cb1-2"></a>   | \x . t  [ラムダ抽象]</span>
<span id="cb1-3"><a href="#cb1-3"></a>   | t t     [関数適用]</span>
<span id="cb1-4"><a href="#cb1-4"></a></span>
<span id="cb1-5"><a href="#cb1-5"></a>v := \x . t</span></code></pre></div>
<p>なんと前回の算術式より構文規則がシンプル． ラムダ計算というのは「関数」しかないプログラミング言語で，ラムダ抽象というのが最近の多くの言語で導入されている無名関数や関数オブジェクトと言われるものだ（たぶん）．</p>
<p>まずはこれを Elm 上の型として定義する:</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode elm"><code class="sourceCode elm"><span id="cb2-1"><a href="#cb2-1"></a><span class="kw">type</span> <span class="dt">Term</span></span>
<span id="cb2-2"><a href="#cb2-2"></a>    <span class="op">=</span> <span class="dt">TmVar</span> <span class="dt">Int</span> <span class="dt">Int</span></span>
<span id="cb2-3"><a href="#cb2-3"></a>    <span class="op">|</span> <span class="dt">TmAbs</span> <span class="dt">String</span> <span class="dt">Term</span></span>
<span id="cb2-4"><a href="#cb2-4"></a>    <span class="op">|</span> <span class="dt">TmApp</span> <span class="dt">Term</span> <span class="dt">Term</span></span>
<span id="cb2-5"><a href="#cb2-5"></a></span>
<span id="cb2-6"><a href="#cb2-6"></a><span class="co">-- 値はラムダ抽象だけ</span></span>
<span id="cb2-7"><a href="#cb2-7"></a><span class="fu">isval</span> : <span class="dt">Context</span> <span class="op">-&gt;</span> <span class="dt">Term</span> <span class="op">-&gt;</span> <span class="dt">Bool</span></span>
<span id="cb2-8"><a href="#cb2-8"></a><span class="fu">isval</span> <span class="fu">_</span> <span class="fu">t</span> <span class="op">=</span></span>
<span id="cb2-9"><a href="#cb2-9"></a>    <span class="cf">case</span> <span class="fu">t</span> <span class="cf">of</span></span>
<span id="cb2-10"><a href="#cb2-10"></a>        <span class="dt">TmAbs</span> <span class="fu">_</span> <span class="fu">_</span> <span class="op">-&gt;</span></span>
<span id="cb2-11"><a href="#cb2-11"></a>            <span class="dt">True</span></span>
<span id="cb2-12"><a href="#cb2-12"></a></span>
<span id="cb2-13"><a href="#cb2-13"></a>        <span class="fu">_</span> <span class="op">-&gt;</span></span>
<span id="cb2-14"><a href="#cb2-14"></a>            <span class="dt">False</span></span>
<span id="cb2-15"><a href="#cb2-15"></a></span>
<span id="cb2-16"><a href="#cb2-16"></a><span class="co">-- 変数名を保持している（表示用）</span></span>
<span id="cb2-17"><a href="#cb2-17"></a><span class="co">-- Binding の意味は現状まだない（次回以降ちゃんと使う）</span></span>
<span id="cb2-18"><a href="#cb2-18"></a><span class="kw">type</span> <span class="kw">alias</span> <span class="dt">Context</span> <span class="op">=</span>　<span class="dt">List</span> ( <span class="dt">String</span><span class="op">,</span> <span class="dt">Binding</span> )</span>
<span id="cb2-19"><a href="#cb2-19"></a><span class="kw">type</span> <span class="dt">Binding</span>　<span class="op">=</span> <span class="dt">NameBind</span></span></code></pre></div>
<p><code>TmVar</code> が少しキモ． 2つの <code>Int</code> は変数が関数全体の中でどの位置にいるかを表している:</p>
<ul>
<li>1つ目の Int は<a href="https://en.wikipedia.org/wiki/De_Bruijn_index">ドブラウン・インデックス</a> (束縛されたラムダ抽象までの距離)</li>
<li>2つ目の Int は一番外のラムダ抽象までの距離(深さ)</li>
<li>e.g. <code>(\x. \f. f x) (\x. x)</code> の場合は <code>TmApp (TmAbs "x" (TmAbs "f" (TmApp (TmVar 0 2) (TmVar 1 2)))) (TmAbs "x" (TmVar 0 1))</code></li>
</ul>
<p>ちなみに，<code>TmAbs String Term</code> の文字列型は変数名で基本的に表示用．</p>
<h3 id="評価規則">評価規則</h3>
<p>評価規則も同様にシンプル:</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode txt"><code class="sourceCode default"><span id="cb3-1"><a href="#cb3-1"></a> t1 =&gt; t1'</span>
<span id="cb3-2"><a href="#cb3-2"></a>---------------</span>
<span id="cb3-3"><a href="#cb3-3"></a> t1 t2 =&gt; t1' t2</span>
<span id="cb3-4"><a href="#cb3-4"></a></span>
<span id="cb3-5"><a href="#cb3-5"></a> t2 =&gt; t2'</span>
<span id="cb3-6"><a href="#cb3-6"></a>---------------</span>
<span id="cb3-7"><a href="#cb3-7"></a> v1 t2 =&gt; v1 t2'</span>
<span id="cb3-8"><a href="#cb3-8"></a></span>
<span id="cb3-9"><a href="#cb3-9"></a>(\x.t12) v2 -&gt; [x|-&gt; v2]t12</span></code></pre></div>
<p>3つ目のが関数適用で，<code>[x|-&gt; v2]t12</code> 記法は <code>t12</code> 内の変数 <code>x</code> を全て <code>v2</code> に置き換えるという意味である． ここで，<code>v2</code> が値というのがキモだ． すなわち正格評価される．</p>
<p>これをパターンマッチを使って実装すると次の通り:</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode elm"><code class="sourceCode elm"><span id="cb4-1"><a href="#cb4-1"></a><span class="co">-- 止まらない可能性があるから注意</span></span>
<span id="cb4-2"><a href="#cb4-2"></a><span class="fu">eval</span> : <span class="dt">Context</span> <span class="op">-&gt;</span> <span class="dt">Term</span> <span class="op">-&gt;</span> <span class="dt">Maybe</span> <span class="dt">Term</span></span>
<span id="cb4-3"><a href="#cb4-3"></a><span class="fu">eval</span> <span class="fu">ctx</span> <span class="fu">t</span> <span class="op">=</span></span>
<span id="cb4-4"><a href="#cb4-4"></a>    <span class="cf">if</span> <span class="fu">isval</span> <span class="fu">ctx</span> <span class="fu">t</span> <span class="cf">then</span></span>
<span id="cb4-5"><a href="#cb4-5"></a>        <span class="dt">Just</span> <span class="fu">t</span></span>
<span id="cb4-6"><a href="#cb4-6"></a></span>
<span id="cb4-7"><a href="#cb4-7"></a>    <span class="cf">else</span></span>
<span id="cb4-8"><a href="#cb4-8"></a>        <span class="dt">Maybe</span><span class="op">.</span><span class="fu">andThen</span> (<span class="fu">eval</span> <span class="fu">ctx</span>) (<span class="fu">eval1</span> <span class="fu">ctx</span> <span class="fu">t</span>)</span>
<span id="cb4-9"><a href="#cb4-9"></a></span>
<span id="cb4-10"><a href="#cb4-10"></a><span class="fu">eval1</span> : <span class="dt">Context</span> <span class="op">-&gt;</span> <span class="dt">Term</span> <span class="op">-&gt;</span> <span class="dt">Maybe</span> <span class="dt">Term</span></span>
<span id="cb4-11"><a href="#cb4-11"></a><span class="fu">eval1</span> <span class="fu">ctx</span> <span class="fu">t</span> <span class="op">=</span></span>
<span id="cb4-12"><a href="#cb4-12"></a>    <span class="cf">case</span> <span class="fu">t</span> <span class="cf">of</span></span>
<span id="cb4-13"><a href="#cb4-13"></a>        <span class="dt">TmApp</span> (<span class="dt">TmAbs</span> <span class="fu">x</span> <span class="fu">t12</span>) <span class="fu">t2</span> <span class="op">-&gt;</span></span>
<span id="cb4-14"><a href="#cb4-14"></a>            <span class="cf">if</span> <span class="fu">isval</span> <span class="fu">ctx</span> <span class="fu">t2</span> <span class="cf">then</span></span>
<span id="cb4-15"><a href="#cb4-15"></a>                <span class="dt">Just</span> (<span class="fu">termSubstTop</span> <span class="fu">t2</span> <span class="fu">t12</span>)</span>
<span id="cb4-16"><a href="#cb4-16"></a>            <span class="cf">else</span></span>
<span id="cb4-17"><a href="#cb4-17"></a>                <span class="dt">Maybe</span><span class="op">.</span><span class="fu">map</span> (<span class="dt">TmApp</span> (<span class="dt">TmAbs</span> <span class="fu">x</span> <span class="fu">t12</span>)) (<span class="fu">eval1</span> <span class="fu">ctx</span> <span class="fu">t2</span>)</span>
<span id="cb4-18"><a href="#cb4-18"></a></span>
<span id="cb4-19"><a href="#cb4-19"></a>        <span class="dt">TmApp</span> <span class="fu">t1</span> <span class="fu">t2</span> <span class="op">-&gt;</span></span>
<span id="cb4-20"><a href="#cb4-20"></a>            <span class="dt">Maybe</span><span class="op">.</span><span class="fu">map</span> (<span class="fu">flip</span> <span class="dt">TmApp</span> <span class="fu">t2</span>) (<span class="fu">eval1</span> <span class="fu">ctx</span> <span class="fu">t1</span>)</span>
<span id="cb4-21"><a href="#cb4-21"></a></span>
<span id="cb4-22"><a href="#cb4-22"></a>        <span class="fu">_</span> <span class="op">-&gt;</span></span>
<span id="cb4-23"><a href="#cb4-23"></a>            <span class="dt">Nothing</span></span>
<span id="cb4-24"><a href="#cb4-24"></a></span>
<span id="cb4-25"><a href="#cb4-25"></a><span class="fu">termSubstTop</span> : <span class="dt">Term</span> <span class="op">-&gt;</span> <span class="dt">Term</span> <span class="op">-&gt;</span> <span class="dt">Term</span></span>
<span id="cb4-26"><a href="#cb4-26"></a><span class="fu">termSubstTop</span> <span class="op">=</span> <span class="op">...</span></span></code></pre></div>
<p><code>termSubstTop</code> という新しい関数が出てきた． 変数を置き換える(代入する)上で重要なのは同じ変数名の変数が出てきたときに，それらを区別して〜〜ってのがあり，それをいい感じにやるための工夫が <code>TmVar</code> の2つの <code>Int</code> だ． この実装上の工夫は第6章で説明されているので，買って読んでください(おい)．</p>
<h1 id="section-1"></h1>
<p>で，<code>termSubstTop</code> の実装はこんな感じ(本書にも全部書いてある):</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode elm"><code class="sourceCode elm"><span id="cb5-1"><a href="#cb5-1"></a><span class="co">-- v2 と t12 を渡して [x|-&gt;v2]t12 が返ってくる</span></span>
<span id="cb5-2"><a href="#cb5-2"></a><span class="co">-- termSubst 0 なので一番外の変数を置き換える</span></span>
<span id="cb5-3"><a href="#cb5-3"></a><span class="co">-- 置き換えた後 -1 シフトしないといけない(一番外のラムダ抽象が剥がれるので)</span></span>
<span id="cb5-4"><a href="#cb5-4"></a><span class="co">-- 先に 1 だけシフトしてるのは代入後の s は -1 シフトして欲しくないから</span></span>
<span id="cb5-5"><a href="#cb5-5"></a><span class="fu">termSubstTop</span> : <span class="dt">Term</span> <span class="op">-&gt;</span> <span class="dt">Term</span> <span class="op">-&gt;</span> <span class="dt">Term</span></span>
<span id="cb5-6"><a href="#cb5-6"></a><span class="fu">termSubstTop</span> <span class="fu">s</span> <span class="fu">t</span> <span class="op">=</span></span>
<span id="cb5-7"><a href="#cb5-7"></a>    <span class="fu">termShift</span> <span class="op">-</span><span class="dv">1</span> (<span class="fu">termSubst</span> <span class="dv">0</span> (<span class="fu">termShift</span> <span class="dv">1</span> <span class="fu">s</span>) <span class="fu">t</span>)</span>
<span id="cb5-8"><a href="#cb5-8"></a></span>
<span id="cb5-9"><a href="#cb5-9"></a><span class="co">-- 項 tt 中の j 番の変数へ項 s を代入 [j|-&gt;s]t する</span></span>
<span id="cb5-10"><a href="#cb5-10"></a><span class="fu">termSubst</span> : <span class="dt">Int</span> <span class="op">-&gt;</span> <span class="dt">Term</span> <span class="op">-&gt;</span> <span class="dt">Term</span> <span class="op">-&gt;</span> <span class="dt">Term</span></span>
<span id="cb5-11"><a href="#cb5-11"></a><span class="fu">termSubst</span> <span class="fu">j</span> <span class="fu">s</span> <span class="fu">tt</span> <span class="op">=</span></span>
<span id="cb5-12"><a href="#cb5-12"></a>    <span class="kw">let</span></span>
<span id="cb5-13"><a href="#cb5-13"></a>        <span class="fu">walk</span> <span class="fu">c</span> <span class="fu">t</span> <span class="op">=</span></span>
<span id="cb5-14"><a href="#cb5-14"></a>            <span class="cf">case</span> <span class="fu">t</span> <span class="cf">of</span></span>
<span id="cb5-15"><a href="#cb5-15"></a>                <span class="dt">TmVar</span> <span class="fu">x</span> <span class="fu">n</span> <span class="op">-&gt;</span></span>
<span id="cb5-16"><a href="#cb5-16"></a>                    <span class="cf">if</span> <span class="fu">x</span> <span class="op">==</span> <span class="fu">j</span> <span class="op">+</span> <span class="fu">c</span> <span class="cf">then</span></span>
<span id="cb5-17"><a href="#cb5-17"></a>                        <span class="co">-- 潜ったぶんだけドブラウン・インデックスをシフト</span></span>
<span id="cb5-18"><a href="#cb5-18"></a>                        <span class="fu">termShift</span> <span class="fu">c</span> <span class="fu">s</span></span>
<span id="cb5-19"><a href="#cb5-19"></a>                    <span class="cf">else</span></span>
<span id="cb5-20"><a href="#cb5-20"></a>                        <span class="dt">TmVar</span> <span class="fu">x</span> <span class="fu">n</span></span>
<span id="cb5-21"><a href="#cb5-21"></a></span>
<span id="cb5-22"><a href="#cb5-22"></a>                <span class="dt">TmAbs</span> <span class="fu">x</span> <span class="fu">t1</span> <span class="op">-&gt;</span></span>
<span id="cb5-23"><a href="#cb5-23"></a>                    <span class="dt">TmAbs</span> <span class="fu">x</span> (<span class="fu">walk</span> (<span class="fu">c</span> <span class="op">+</span> <span class="dv">1</span>) <span class="fu">t1</span>)</span>
<span id="cb5-24"><a href="#cb5-24"></a></span>
<span id="cb5-25"><a href="#cb5-25"></a>                <span class="dt">TmApp</span> <span class="fu">t1</span> <span class="fu">t2</span> <span class="op">-&gt;</span></span>
<span id="cb5-26"><a href="#cb5-26"></a>                    <span class="dt">TmApp</span> (<span class="fu">walk</span> <span class="fu">c</span> <span class="fu">t1</span>) (<span class="fu">walk</span> <span class="fu">c</span> <span class="fu">t2</span>)</span>
<span id="cb5-27"><a href="#cb5-27"></a>    <span class="kw">in</span></span>
<span id="cb5-28"><a href="#cb5-28"></a>    <span class="fu">walk</span> <span class="dv">0</span> <span class="fu">tt</span></span>
<span id="cb5-29"><a href="#cb5-29"></a></span>
<span id="cb5-30"><a href="#cb5-30"></a><span class="co">-- 項 tt の自由変数のドブラウン・インデックスを d だけシフト</span></span>
<span id="cb5-31"><a href="#cb5-31"></a><span class="fu">termShift</span> : <span class="dt">Int</span> <span class="op">-&gt;</span> <span class="dt">Term</span> <span class="op">-&gt;</span> <span class="dt">Term</span></span>
<span id="cb5-32"><a href="#cb5-32"></a><span class="fu">termShift</span> <span class="fu">d</span> <span class="fu">tt</span> <span class="op">=</span></span>
<span id="cb5-33"><a href="#cb5-33"></a>    <span class="kw">let</span></span>
<span id="cb5-34"><a href="#cb5-34"></a>        <span class="fu">walk</span> <span class="fu">c</span> <span class="fu">t</span> <span class="op">=</span></span>
<span id="cb5-35"><a href="#cb5-35"></a>            <span class="cf">case</span> <span class="fu">t</span> <span class="cf">of</span></span>
<span id="cb5-36"><a href="#cb5-36"></a>                <span class="dt">TmVar</span> <span class="fu">x</span> <span class="fu">n</span> <span class="op">-&gt;</span></span>
<span id="cb5-37"><a href="#cb5-37"></a>                    <span class="co">-- c はラムダ抽象の深さ</span></span>
<span id="cb5-38"><a href="#cb5-38"></a>                    <span class="co">-- x は変数が束縛されたのラムダ抽象までの距離</span></span>
<span id="cb5-39"><a href="#cb5-39"></a>                    <span class="co">-- したがって x &gt;= c は自由変数</span></span>
<span id="cb5-40"><a href="#cb5-40"></a>                    <span class="cf">if</span> <span class="fu">x</span> <span class="op">&gt;=</span> <span class="fu">c</span> <span class="cf">then</span></span>
<span id="cb5-41"><a href="#cb5-41"></a>                        <span class="dt">TmVar</span> (<span class="fu">x</span> <span class="op">+</span> <span class="fu">d</span>) (<span class="fu">n</span> <span class="op">+</span> <span class="fu">d</span>)</span>
<span id="cb5-42"><a href="#cb5-42"></a>                    <span class="cf">else</span></span>
<span id="cb5-43"><a href="#cb5-43"></a>                        <span class="dt">TmVar</span> <span class="fu">x</span> (<span class="fu">n</span> <span class="op">+</span> <span class="fu">d</span>)</span>
<span id="cb5-44"><a href="#cb5-44"></a></span>
<span id="cb5-45"><a href="#cb5-45"></a>                <span class="dt">TmAbs</span> <span class="fu">x</span> <span class="fu">t1</span> <span class="op">-&gt;</span></span>
<span id="cb5-46"><a href="#cb5-46"></a>                    <span class="dt">TmAbs</span> <span class="fu">x</span> (<span class="fu">walk</span> (<span class="fu">c</span> <span class="op">+</span> <span class="dv">1</span>) <span class="fu">t1</span>)</span>
<span id="cb5-47"><a href="#cb5-47"></a></span>
<span id="cb5-48"><a href="#cb5-48"></a>                <span class="dt">TmApp</span> <span class="fu">t1</span> <span class="fu">t2</span> <span class="op">-&gt;</span></span>
<span id="cb5-49"><a href="#cb5-49"></a>                    <span class="dt">TmApp</span> (<span class="fu">walk</span> <span class="fu">c</span> <span class="fu">t1</span>) (<span class="fu">walk</span> <span class="fu">c</span> <span class="fu">t2</span>)</span>
<span id="cb5-50"><a href="#cb5-50"></a>    <span class="kw">in</span></span>
<span id="cb5-51"><a href="#cb5-51"></a>    <span class="fu">walk</span> <span class="dv">0</span> <span class="fu">tt</span></span></code></pre></div>
<p>REPL で確かめてみる:</p>
<div class="sourceCode" id="cb6"><pre class="sourceCode elm"><code class="sourceCode elm"><span id="cb6-1"><a href="#cb6-1"></a><span class="op">$</span> <span class="fu">elm</span> <span class="fu">repl</span></span>
<span id="cb6-2"><a href="#cb6-2"></a><span class="co">---- Elm 0.19.1 ----------------------------------------------------------------</span></span>
<span id="cb6-3"><a href="#cb6-3"></a><span class="dt">Say</span> :<span class="fu">help</span> <span class="fu">for</span> <span class="fu">help</span> <span class="fu">and</span> :<span class="fu">exit</span> <span class="fu">to</span> <span class="fu">exit</span><span class="op">!</span> <span class="dt">More</span> <span class="fu">at</span> <span class="op">&lt;</span><span class="fu">https</span>:<span class="op">//</span><span class="fu">elm</span><span class="op">-</span><span class="fu">lang</span><span class="op">.</span><span class="fu">org</span><span class="op">/</span><span class="dv">0</span><span class="op">.</span><span class="dv">19</span><span class="op">.</span><span class="dv">1</span><span class="op">/</span><span class="fu">repl</span><span class="op">&gt;</span></span>
<span id="cb6-4"><a href="#cb6-4"></a><span class="co">--------------------------------------------------------------------------------</span></span>
<span id="cb6-5"><a href="#cb6-5"></a><span class="op">&gt;</span> <span class="kw">import</span> <span class="dt">TaPL</span><span class="op">.</span><span class="dt">Chap7</span> <span class="kw">as</span> <span class="dt">Chap7</span> <span class="kw">exposing</span> (<span class="dt">Term</span> (<span class="op">..</span>))</span>
<span id="cb6-6"><a href="#cb6-6"></a><span class="op">&gt;</span> <span class="dt">Chap7</span><span class="op">.</span><span class="fu">eval</span> [] (<span class="dt">TmApp</span> (<span class="dt">TmAbs</span> <span class="st">&quot;x&quot;</span> (<span class="dt">TmAbs</span> <span class="st">&quot;f&quot;</span> (<span class="dt">TmApp</span> (<span class="dt">TmVar</span> <span class="dv">0</span> <span class="dv">2</span>) (<span class="dt">TmVar</span> <span class="dv">1</span> <span class="dv">2</span>)))) (<span class="dt">TmAbs</span> <span class="st">&quot;x&quot;</span> (<span class="dt">TmVar</span> <span class="dv">0</span> <span class="dv">1</span>)))</span>
<span id="cb6-7"><a href="#cb6-7"></a><span class="dt">Just</span> (<span class="dt">TmAbs</span> <span class="st">&quot;f&quot;</span> (<span class="dt">TmApp</span> (<span class="dt">TmVar</span> <span class="dv">0</span> <span class="dv">1</span>) (<span class="dt">TmAbs</span> <span class="st">&quot;x&quot;</span> (<span class="dt">TmVar</span> <span class="dv">0</span> <span class="dv">2</span>))))</span>
<span id="cb6-8"><a href="#cb6-8"></a>    : <span class="dt">Maybe</span> <span class="dt">Term</span></span></code></pre></div>
<p><code>(\x . (\f . f x)) (\x . x)</code> を評価して <code>\f . f (\x . x)</code> という結果を得た．</p>
<h3 id="文字列へ変換">文字列へ変換</h3>
<p>変数がインデックス表記になっているため読みにくい． なので文字列への変換関数とパーサーを記述しよう．</p>
<p>まずは文字列の変換から． こっちは TaPL にも(ほとんど)書いてある:</p>
<div class="sourceCode" id="cb7"><pre class="sourceCode elm"><code class="sourceCode elm"><span id="cb7-1"><a href="#cb7-1"></a><span class="co">-- これは TaPL にはない</span></span>
<span id="cb7-2"><a href="#cb7-2"></a><span class="fu">display</span> : <span class="dt">Term</span> <span class="op">-&gt;</span> <span class="dt">String</span></span>
<span id="cb7-3"><a href="#cb7-3"></a><span class="fu">display</span> <span class="fu">t</span> <span class="op">=</span></span>
<span id="cb7-4"><a href="#cb7-4"></a>    <span class="fu">printtm</span> [] <span class="fu">t</span></span>
<span id="cb7-5"><a href="#cb7-5"></a>        <span class="op">|&gt;</span> <span class="dt">Maybe</span><span class="op">.</span><span class="fu">map</span> (<span class="fu">dropIfStartsWith</span> <span class="st">&quot;(&quot;</span>) <span class="co">-- 最初と最後のカッコを消している</span></span>
<span id="cb7-6"><a href="#cb7-6"></a>        <span class="op">|&gt;</span> <span class="dt">Maybe</span><span class="op">.</span><span class="fu">map</span> (<span class="fu">dropIfEndsWith</span> <span class="st">&quot;)&quot;</span>)</span>
<span id="cb7-7"><a href="#cb7-7"></a>        <span class="op">|&gt;</span> <span class="dt">Maybe</span><span class="op">.</span><span class="fu">withDefault</span> <span class="st">&quot;&quot;</span></span>
<span id="cb7-8"><a href="#cb7-8"></a></span>
<span id="cb7-9"><a href="#cb7-9"></a><span class="co">-- インデックスが間違っている場合は Nothing になる</span></span>
<span id="cb7-10"><a href="#cb7-10"></a><span class="fu">printtm</span> : <span class="dt">Context</span> <span class="op">-&gt;</span> <span class="dt">Term</span> <span class="op">-&gt;</span> <span class="dt">Maybe</span> <span class="dt">String</span></span>
<span id="cb7-11"><a href="#cb7-11"></a><span class="fu">printtm</span> <span class="fu">ctx</span> <span class="fu">t</span> <span class="op">=</span>　<span class="op">...</span></span></code></pre></div>
<p>前回と異なり，今回は文字列に変換できない場合がある． インデックスが間違っている場合だ． その場合は <code>Notihng</code> が返るようにしている(TaPL の場合は例外)． <code>printtm</code> は <code>Term</code> 型に対するパターンマッチで記述する:</p>
<div class="sourceCode" id="cb8"><pre class="sourceCode elm"><code class="sourceCode elm"><span id="cb8-1"><a href="#cb8-1"></a><span class="fu">printtm</span> : <span class="dt">Context</span> <span class="op">-&gt;</span> <span class="dt">Term</span> <span class="op">-&gt;</span> <span class="dt">Maybe</span> <span class="dt">String</span></span>
<span id="cb8-2"><a href="#cb8-2"></a><span class="fu">printtm</span> <span class="fu">ctx</span> <span class="fu">t</span> <span class="op">=</span></span>
<span id="cb8-3"><a href="#cb8-3"></a>    <span class="cf">case</span> <span class="fu">t</span> <span class="cf">of</span></span>
<span id="cb8-4"><a href="#cb8-4"></a>        <span class="dt">TmAbs</span> <span class="fu">x</span> <span class="fu">t1</span> <span class="op">-&gt;</span></span>
<span id="cb8-5"><a href="#cb8-5"></a>            <span class="kw">let</span></span>
<span id="cb8-6"><a href="#cb8-6"></a>                ( <span class="fu">ctx1</span><span class="op">,</span> <span class="fu">x1</span> ) <span class="op">=</span></span>
<span id="cb8-7"><a href="#cb8-7"></a>                    <span class="co">-- 被らない変数名を生成</span></span>
<span id="cb8-8"><a href="#cb8-8"></a>                    <span class="fu">pickfreshname</span> <span class="fu">ctx</span> <span class="fu">x</span></span>
<span id="cb8-9"><a href="#cb8-9"></a>            <span class="kw">in</span></span>
<span id="cb8-10"><a href="#cb8-10"></a>            <span class="dt">Maybe</span><span class="op">.</span><span class="fu">map</span></span>
<span id="cb8-11"><a href="#cb8-11"></a>                (\<span class="fu">s1</span> <span class="op">-&gt;</span> <span class="dt">String</span><span class="op">.</span><span class="fu">concat</span> [ <span class="st">&quot;(\\&quot;</span><span class="op">,</span> <span class="fu">x1</span><span class="op">,</span> <span class="st">&quot;. &quot;</span><span class="op">,</span> <span class="fu">s1</span><span class="op">,</span> <span class="st">&quot;)&quot;</span> ])</span>
<span id="cb8-12"><a href="#cb8-12"></a>                (<span class="fu">printtm</span> <span class="fu">ctx1</span> <span class="fu">t1</span>)</span>
<span id="cb8-13"><a href="#cb8-13"></a></span>
<span id="cb8-14"><a href="#cb8-14"></a>        <span class="dt">TmApp</span> <span class="fu">t1</span> <span class="fu">t2</span> <span class="op">-&gt;</span></span>
<span id="cb8-15"><a href="#cb8-15"></a>            <span class="dt">Maybe</span><span class="op">.</span><span class="fu">map2</span></span>
<span id="cb8-16"><a href="#cb8-16"></a>                (\<span class="fu">s1</span> <span class="fu">s2</span> <span class="op">-&gt;</span> <span class="dt">String</span><span class="op">.</span><span class="fu">concat</span> [ <span class="st">&quot;(&quot;</span><span class="op">,</span> <span class="fu">s1</span><span class="op">,</span> <span class="st">&quot; &quot;</span><span class="op">,</span> <span class="fu">s2</span><span class="op">,</span> <span class="st">&quot;)&quot;</span> ])</span>
<span id="cb8-17"><a href="#cb8-17"></a>                (<span class="fu">printtm</span> <span class="fu">ctx</span> <span class="fu">t1</span>)</span>
<span id="cb8-18"><a href="#cb8-18"></a>                (<span class="fu">printtm</span> <span class="fu">ctx</span> <span class="fu">t2</span>)</span>
<span id="cb8-19"><a href="#cb8-19"></a></span>
<span id="cb8-20"><a href="#cb8-20"></a>        <span class="dt">TmVar</span> <span class="fu">x</span> <span class="fu">n</span> <span class="op">-&gt;</span></span>
<span id="cb8-21"><a href="#cb8-21"></a>            <span class="co">-- ctx には変数がどんどん保存される</span></span>
<span id="cb8-22"><a href="#cb8-22"></a>            <span class="co">-- そのため ctx の長さと n の長さが等しくないといけない</span></span>
<span id="cb8-23"><a href="#cb8-23"></a>            <span class="cf">if</span> <span class="fu">ctxlength</span> <span class="fu">ctx</span> <span class="op">==</span> <span class="fu">n</span> <span class="cf">then</span></span>
<span id="cb8-24"><a href="#cb8-24"></a>                <span class="co">-- ctx から変数名をドブラウン・インデックスで引いてくる</span></span>
<span id="cb8-25"><a href="#cb8-25"></a>                <span class="fu">index2name</span> <span class="fu">ctx</span> <span class="fu">x</span></span>
<span id="cb8-26"><a href="#cb8-26"></a>            <span class="cf">else</span></span>
<span id="cb8-27"><a href="#cb8-27"></a>                <span class="dt">Nothing</span></span></code></pre></div>
<p><code>pickfreshname</code> や <code>ctxlength</code> や <code>index2name</code> の実装は本書にはない． 振る舞いの説明が書いてあるので，それを読んで実装する必要がある． なので，僕は次のように実装したがもう少しエレガントな実装があるかもしれない:</p>
<div class="sourceCode" id="cb9"><pre class="sourceCode elm"><code class="sourceCode elm"><span id="cb9-1"><a href="#cb9-1"></a><span class="co">-- 変数名が重複しないように後ろに ' を足して Context の先頭に追加</span></span>
<span id="cb9-2"><a href="#cb9-2"></a><span class="fu">pickfreshname</span> : <span class="dt">Context</span> <span class="op">-&gt;</span> <span class="dt">String</span> <span class="op">-&gt;</span> ( <span class="dt">Context</span><span class="op">,</span> <span class="dt">String</span> )</span>
<span id="cb9-3"><a href="#cb9-3"></a><span class="fu">pickfreshname</span> <span class="fu">ctx</span> <span class="fu">x</span> <span class="op">=</span></span>
<span id="cb9-4"><a href="#cb9-4"></a>    <span class="kw">let</span></span>
<span id="cb9-5"><a href="#cb9-5"></a>        <span class="fu">x1</span> <span class="op">=</span></span>
<span id="cb9-6"><a href="#cb9-6"></a>            <span class="fu">ctx</span></span>
<span id="cb9-7"><a href="#cb9-7"></a>                <span class="op">|&gt;</span> <span class="dt">List</span><span class="op">.</span><span class="fu">map</span> <span class="dt">Tuple</span><span class="op">.</span><span class="fu">first</span></span>
<span id="cb9-8"><a href="#cb9-8"></a>                <span class="op">|&gt;</span> <span class="dt">List</span><span class="op">.</span><span class="fu">filter</span> (<span class="dt">String</span><span class="op">.</span><span class="fu">startsWith</span> <span class="fu">x</span>)</span>
<span id="cb9-9"><a href="#cb9-9"></a>                <span class="op">|&gt;</span> <span class="dt">List</span><span class="op">.</span><span class="fu">maximum</span></span>
<span id="cb9-10"><a href="#cb9-10"></a>                <span class="op">|&gt;</span> <span class="dt">Maybe</span><span class="op">.</span><span class="fu">map</span> (\<span class="fu">a</span> <span class="op">-&gt;</span> <span class="fu">a</span> <span class="op">++</span> <span class="st">&quot;'&quot;</span>)</span>
<span id="cb9-11"><a href="#cb9-11"></a>                <span class="op">|&gt;</span> <span class="dt">Maybe</span><span class="op">.</span><span class="fu">withDefault</span> <span class="fu">x</span></span>
<span id="cb9-12"><a href="#cb9-12"></a>    <span class="kw">in</span></span>
<span id="cb9-13"><a href="#cb9-13"></a>    ( ( <span class="fu">x1</span><span class="op">,</span> <span class="dt">NameBind</span> ) <span class="op">::</span> <span class="fu">ctx</span><span class="op">,</span> <span class="fu">x1</span> )</span>
<span id="cb9-14"><a href="#cb9-14"></a></span>
<span id="cb9-15"><a href="#cb9-15"></a><span class="fu">ctxlength</span> : <span class="dt">Context</span> <span class="op">-&gt;</span> <span class="dt">Int</span></span>
<span id="cb9-16"><a href="#cb9-16"></a><span class="fu">ctxlength</span> <span class="fu">ctx</span> <span class="op">=</span></span>
<span id="cb9-17"><a href="#cb9-17"></a>    <span class="dt">List</span><span class="op">.</span><span class="fu">length</span> <span class="fu">ctx</span></span>
<span id="cb9-18"><a href="#cb9-18"></a></span>
<span id="cb9-19"><a href="#cb9-19"></a><span class="co">-- ドブラウン・インデックスは束縛されたラムダ抽象への距離</span></span>
<span id="cb9-20"><a href="#cb9-20"></a><span class="co">-- Context はラムダ抽象のたびに先頭に対応する変数を追加する</span></span>
<span id="cb9-21"><a href="#cb9-21"></a><span class="co">-- なので，そのままリストへのインデックスアクセスで良い</span></span>
<span id="cb9-22"><a href="#cb9-22"></a><span class="fu">index2name</span> : <span class="dt">Context</span> <span class="op">-&gt;</span> <span class="dt">Int</span> <span class="op">-&gt;</span> <span class="dt">Maybe</span> <span class="dt">String</span></span>
<span id="cb9-23"><a href="#cb9-23"></a><span class="fu">index2name</span> <span class="fu">ctx</span> <span class="fu">x</span> <span class="op">=</span></span>
<span id="cb9-24"><a href="#cb9-24"></a>    <span class="cf">case</span> <span class="dt">List</span><span class="op">.</span><span class="fu">getAt</span> <span class="fu">x</span> <span class="fu">ctx</span> <span class="cf">of</span></span>
<span id="cb9-25"><a href="#cb9-25"></a>        <span class="dt">Just</span> ( <span class="fu">str</span><span class="op">,</span> <span class="fu">_</span> ) <span class="op">-&gt;</span></span>
<span id="cb9-26"><a href="#cb9-26"></a>            <span class="dt">Just</span> <span class="fu">str</span></span>
<span id="cb9-27"><a href="#cb9-27"></a></span>
<span id="cb9-28"><a href="#cb9-28"></a>        <span class="fu">_</span> <span class="op">-&gt;</span></span>
<span id="cb9-29"><a href="#cb9-29"></a>            <span class="dt">Nothing</span></span></code></pre></div>
<p>REPL で試してみよう:</p>
<div class="sourceCode" id="cb10"><pre class="sourceCode elm"><code class="sourceCode elm"><span id="cb10-1"><a href="#cb10-1"></a><span class="op">&gt;</span> <span class="dt">Chap7</span><span class="op">.</span><span class="fu">display</span> (<span class="dt">TmApp</span> (<span class="dt">TmAbs</span> <span class="st">&quot;x&quot;</span> (<span class="dt">TmAbs</span> <span class="st">&quot;f&quot;</span> (<span class="dt">TmApp</span> (<span class="dt">TmVar</span> <span class="dv">0</span> <span class="dv">2</span>) (<span class="dt">TmVar</span> <span class="dv">1</span> <span class="dv">2</span>)))) (<span class="dt">TmAbs</span> <span class="st">&quot;x&quot;</span> (<span class="dt">TmVar</span> <span class="dv">0</span> <span class="dv">1</span>)))</span>
<span id="cb10-2"><a href="#cb10-2"></a><span class="st">&quot;(\\x. (\\f. (f x))) (\\x. x)&quot;</span> : <span class="dt">String</span></span>
<span id="cb10-3"><a href="#cb10-3"></a><span class="op">&gt;</span> <span class="dt">Chap7</span><span class="op">.</span><span class="fu">eval</span> [] (<span class="dt">TmApp</span> (<span class="dt">TmAbs</span> <span class="st">&quot;x&quot;</span> (<span class="dt">TmAbs</span> <span class="st">&quot;f&quot;</span> (<span class="dt">TmApp</span> (<span class="dt">TmVar</span> <span class="dv">0</span> <span class="dv">2</span>) (<span class="dt">TmVar</span> <span class="dv">1</span> <span class="dv">2</span>)))) (<span class="dt">TmAbs</span> <span class="st">&quot;x&quot;</span> (<span class="dt">TmVar</span> <span class="dv">0</span> <span class="dv">1</span>))) <span class="op">|&gt;</span> <span class="dt">Maybe</span><span class="op">.</span><span class="fu">map</span> <span class="dt">Chap7</span><span class="op">.</span><span class="fu">display</span></span>
<span id="cb10-4"><a href="#cb10-4"></a><span class="dt">Just</span> (<span class="st">&quot;\\f. (f (\\x. x))&quot;</span>) : <span class="dt">Maybe</span> <span class="dt">String</span></span></code></pre></div>
<p>いい感じ．</p>
<h3 id="パーサー">パーサー</h3>
<p>前回同様 <a href="https://package.elm-lang.org/packages/elm/parser">elm/parser</a> を使う． ドブラウン・インデックスなどを構築していく必要があるので，それらを保持した <code>Context</code> という型を用意する(紛らわしいが，モジュールが違い外に出さない型なので大丈夫):</p>
<div class="sourceCode" id="cb11"><pre class="sourceCode elm"><code class="sourceCode elm"><span id="cb11-1"><a href="#cb11-1"></a><span class="kw">module</span> <span class="dt">TaPL</span><span class="op">.</span><span class="dt">Chap7</span><span class="op">.</span><span class="dt">Parser</span> <span class="kw">exposing</span> (<span class="fu">parse</span>)</span>
<span id="cb11-2"><a href="#cb11-2"></a></span>
<span id="cb11-3"><a href="#cb11-3"></a><span class="kw">import</span> <span class="dt">Parser</span> <span class="kw">exposing</span> ((<span class="op">|.</span>)<span class="op">,</span> (<span class="op">|=</span>)<span class="op">,</span> <span class="dt">Parser</span>)</span>
<span id="cb11-4"><a href="#cb11-4"></a></span>
<span id="cb11-5"><a href="#cb11-5"></a><span class="kw">type</span> <span class="kw">alias</span> <span class="dt">Context</span> <span class="op">=</span></span>
<span id="cb11-6"><a href="#cb11-6"></a>    { <span class="fu">env</span> : <span class="dt">Dict</span> <span class="dt">String</span> <span class="dt">Int</span> <span class="co">-- 変数名とドブラウンインデックスの対応</span></span>
<span id="cb11-7"><a href="#cb11-7"></a>    <span class="op">,</span> <span class="fu">depth</span> : <span class="dt">Int</span>           <span class="co">-- ラムダ抽象の深さ</span></span>
<span id="cb11-8"><a href="#cb11-8"></a>    }</span>
<span id="cb11-9"><a href="#cb11-9"></a></span>
<span id="cb11-10"><a href="#cb11-10"></a><span class="fu">iniCtx</span> : <span class="dt">Context</span></span>
<span id="cb11-11"><a href="#cb11-11"></a><span class="fu">iniCtx</span> <span class="op">=</span></span>
<span id="cb11-12"><a href="#cb11-12"></a>    { <span class="fu">env</span> <span class="op">=</span> <span class="dt">Dict</span><span class="op">.</span><span class="fu">empty</span><span class="op">,</span> <span class="fu">depth</span> <span class="op">=</span> <span class="dv">0</span> }</span>
<span id="cb11-13"><a href="#cb11-13"></a></span>
<span id="cb11-14"><a href="#cb11-14"></a><span class="fu">parse</span> : <span class="dt">String</span> <span class="op">-&gt;</span> <span class="dt">Result</span> (<span class="dt">List</span> <span class="dt">Parser</span><span class="op">.</span><span class="dt">DeadEnd</span>) <span class="dt">Term</span></span>
<span id="cb11-15"><a href="#cb11-15"></a><span class="fu">parse</span> <span class="op">=</span></span>
<span id="cb11-16"><a href="#cb11-16"></a>    <span class="dt">Parser</span><span class="op">.</span><span class="fu">run</span> <span class="fu">parser</span></span>
<span id="cb11-17"><a href="#cb11-17"></a></span>
<span id="cb11-18"><a href="#cb11-18"></a><span class="fu">parser</span> : <span class="dt">Parser</span> <span class="dt">Term</span></span>
<span id="cb11-19"><a href="#cb11-19"></a><span class="fu">parser</span> <span class="op">=</span></span>
<span id="cb11-20"><a href="#cb11-20"></a>    <span class="fu">termParser</span> <span class="fu">iniCtx</span> <span class="op">|.</span> <span class="dt">Parser</span><span class="op">.</span><span class="fu">end</span></span>
<span id="cb11-21"><a href="#cb11-21"></a></span>
<span id="cb11-22"><a href="#cb11-22"></a><span class="fu">termParser</span> : <span class="dt">Context</span> <span class="op">-&gt;</span> <span class="dt">Parser</span> <span class="dt">Term</span></span>
<span id="cb11-23"><a href="#cb11-23"></a><span class="fu">termParser</span> <span class="fu">ctx</span> <span class="op">=</span> <span class="op">...</span></span></code></pre></div>
<p>まずは関数適用を無視してパーサーを定義する(難しいので):</p>
<div class="sourceCode" id="cb12"><pre class="sourceCode elm"><code class="sourceCode elm"><span id="cb12-1"><a href="#cb12-1"></a><span class="fu">termParser</span> : <span class="dt">Context</span> <span class="op">-&gt;</span> <span class="dt">Parser</span> <span class="dt">Term</span></span>
<span id="cb12-2"><a href="#cb12-2"></a><span class="fu">termParser</span> <span class="fu">ctx</span> <span class="op">=</span></span>
<span id="cb12-3"><a href="#cb12-3"></a>    <span class="co">-- oneOf は最初にマッチしたパース結果を採用する</span></span>
<span id="cb12-4"><a href="#cb12-4"></a>    <span class="dt">Parser</span><span class="op">.</span><span class="fu">oneOf</span></span>
<span id="cb12-5"><a href="#cb12-5"></a>        [ <span class="fu">parParser</span> <span class="fu">ctx</span> <span class="co">-- カッコのパーサー(割愛)</span></span>
<span id="cb12-6"><a href="#cb12-6"></a>        <span class="op">,</span> <span class="fu">absParser</span> <span class="fu">ctx</span></span>
<span id="cb12-7"><a href="#cb12-7"></a>        <span class="op">,</span> <span class="fu">varParser</span> <span class="fu">ctx</span></span>
<span id="cb12-8"><a href="#cb12-8"></a>        ]</span>
<span id="cb12-9"><a href="#cb12-9"></a></span>
<span id="cb12-10"><a href="#cb12-10"></a><span class="co">-- ラムダ抽象(`\x. t`)のパーサー</span></span>
<span id="cb12-11"><a href="#cb12-11"></a><span class="fu">absParser</span> : <span class="dt">Context</span> <span class="op">-&gt;</span> <span class="dt">Parser</span> <span class="dt">Term</span></span>
<span id="cb12-12"><a href="#cb12-12"></a><span class="fu">absParser</span> <span class="fu">ctx</span> <span class="op">=</span></span>
<span id="cb12-13"><a href="#cb12-13"></a>    <span class="dt">Parser</span><span class="op">.</span><span class="fu">succeed</span> <span class="fu">identity</span></span>
<span id="cb12-14"><a href="#cb12-14"></a>        <span class="op">|.</span> <span class="dt">Parser</span><span class="op">.</span><span class="fu">symbol</span> <span class="st">&quot;\\&quot;</span></span>
<span id="cb12-15"><a href="#cb12-15"></a>        <span class="op">|.</span> <span class="dt">Parser</span><span class="op">.</span><span class="fu">spaces</span></span>
<span id="cb12-16"><a href="#cb12-16"></a>        <span class="op">|=</span> <span class="fu">varStrParser</span></span>
<span id="cb12-17"><a href="#cb12-17"></a>        <span class="op">|.</span> <span class="dt">Parser</span><span class="op">.</span><span class="fu">spaces</span></span>
<span id="cb12-18"><a href="#cb12-18"></a>        <span class="op">|.</span> <span class="dt">Parser</span><span class="op">.</span><span class="fu">symbol</span> <span class="st">&quot;.&quot;</span></span>
<span id="cb12-19"><a href="#cb12-19"></a>        <span class="op">|.</span> <span class="dt">Parser</span><span class="op">.</span><span class="fu">spaces</span></span>
<span id="cb12-20"><a href="#cb12-20"></a>        <span class="op">|&gt;</span> <span class="dt">Parser</span><span class="op">.</span><span class="fu">andThen</span> (<span class="fu">absParserN</span> <span class="fu">ctx</span>)</span>
<span id="cb12-21"><a href="#cb12-21"></a></span>
<span id="cb12-22"><a href="#cb12-22"></a><span class="co">-- 変数名のパーサー (小文字始まりで [A-z0-9_'] だけ許容する)</span></span>
<span id="cb12-23"><a href="#cb12-23"></a><span class="fu">varStrParser</span> : <span class="dt">Parser</span> <span class="dt">String</span></span>
<span id="cb12-24"><a href="#cb12-24"></a><span class="fu">varStrParser</span> <span class="op">=</span></span>
<span id="cb12-25"><a href="#cb12-25"></a>    <span class="dt">Parser</span><span class="op">.</span><span class="fu">variable</span></span>
<span id="cb12-26"><a href="#cb12-26"></a>        { <span class="fu">start</span> <span class="op">=</span> <span class="dt">Char</span><span class="op">.</span><span class="fu">isLower</span></span>
<span id="cb12-27"><a href="#cb12-27"></a>        <span class="op">,</span> <span class="fu">inner</span> <span class="op">=</span> \<span class="fu">c</span> <span class="op">-&gt;</span> <span class="dt">Char</span><span class="op">.</span><span class="fu">isAlphaNum</span> <span class="fu">c</span> <span class="op">||</span> <span class="fu">c</span> <span class="op">==</span> <span class="ch">'_'</span> <span class="op">||</span> <span class="fu">c</span> <span class="op">==</span> <span class="ch">'\'</span>'</span>
<span id="cb12-28"><a href="#cb12-28"></a>        <span class="op">,</span> <span class="fu">reserved</span> <span class="op">=</span> <span class="dt">Set</span><span class="op">.</span><span class="fu">fromList</span> []</span>
<span id="cb12-29"><a href="#cb12-29"></a>        }</span>
<span id="cb12-30"><a href="#cb12-30"></a></span>
<span id="cb12-31"><a href="#cb12-31"></a><span class="co">-- ラムダ抽象が深くなるのでコンテキストを更新して再度 Term をパースする</span></span>
<span id="cb12-32"><a href="#cb12-32"></a><span class="fu">absParserN</span> : <span class="dt">Context</span> <span class="op">-&gt;</span> <span class="dt">String</span> <span class="op">-&gt;</span> <span class="dt">Parser</span> <span class="dt">Term</span></span>
<span id="cb12-33"><a href="#cb12-33"></a><span class="fu">absParserN</span> <span class="fu">ctx</span> <span class="fu">v</span> <span class="op">=</span></span>
<span id="cb12-34"><a href="#cb12-34"></a>  <span class="dt">Parser</span><span class="op">.</span><span class="fu">succeed</span> (<span class="dt">TmAbs</span> <span class="fu">v</span>)</span>
<span id="cb12-35"><a href="#cb12-35"></a>      <span class="op">|=</span> <span class="dt">Parser</span><span class="op">.</span><span class="fu">lazy</span> (\<span class="fu">_</span> <span class="op">-&gt;</span> <span class="fu">termParser</span> <span class="op">&lt;|</span> <span class="fu">pushVar</span> <span class="fu">v</span> <span class="op">&lt;|</span> <span class="fu">incrCtx</span> <span class="fu">ctx</span>)</span>
<span id="cb12-36"><a href="#cb12-36"></a></span>
<span id="cb12-37"><a href="#cb12-37"></a><span class="co">-- ラムダ抽象が1つ深くなる</span></span>
<span id="cb12-38"><a href="#cb12-38"></a><span class="co">-- なので深さと全てのドブラウン・インデックスを +1 する</span></span>
<span id="cb12-39"><a href="#cb12-39"></a><span class="fu">incrCtx</span> : <span class="dt">Context</span> <span class="op">-&gt;</span> <span class="dt">Context</span></span>
<span id="cb12-40"><a href="#cb12-40"></a><span class="fu">incrCtx</span> <span class="fu">ctx</span> <span class="op">=</span></span>
<span id="cb12-41"><a href="#cb12-41"></a>    { <span class="fu">ctx</span> <span class="op">|</span> <span class="fu">depth</span> <span class="op">=</span> <span class="fu">ctx</span><span class="op">.</span><span class="fu">depth</span> <span class="op">+</span> <span class="dv">1</span><span class="op">,</span> <span class="fu">env</span> <span class="op">=</span> <span class="dt">Dict</span><span class="op">.</span><span class="fu">map</span> (\<span class="fu">_</span> <span class="fu">v</span> <span class="op">-&gt;</span> <span class="fu">v</span> <span class="op">+</span> <span class="dv">1</span>) <span class="fu">ctx</span><span class="op">.</span><span class="fu">env</span> }</span>
<span id="cb12-42"><a href="#cb12-42"></a></span>
<span id="cb12-43"><a href="#cb12-43"></a><span class="co">-- 新しい変数名を追加する</span></span>
<span id="cb12-44"><a href="#cb12-44"></a><span class="co">-- 同じ変数名は上書きしてしまって良い</span></span>
<span id="cb12-45"><a href="#cb12-45"></a><span class="fu">pushVar</span> : <span class="dt">String</span> <span class="op">-&gt;</span> <span class="dt">Context</span> <span class="op">-&gt;</span> <span class="dt">Context</span></span>
<span id="cb12-46"><a href="#cb12-46"></a><span class="fu">pushVar</span> <span class="fu">v</span> <span class="fu">ctx</span> <span class="op">=</span></span>
<span id="cb12-47"><a href="#cb12-47"></a>    { <span class="fu">ctx</span> <span class="op">|</span> <span class="fu">env</span> <span class="op">=</span> <span class="dt">Dict</span><span class="op">.</span><span class="fu">insert</span> <span class="fu">v</span> <span class="dv">0</span> <span class="fu">ctx</span><span class="op">.</span><span class="fu">env</span> }</span>
<span id="cb12-48"><a href="#cb12-48"></a></span>
<span id="cb12-49"><a href="#cb12-49"></a><span class="co">-- 変数のパーサー</span></span>
<span id="cb12-50"><a href="#cb12-50"></a><span class="fu">varParser</span> : <span class="dt">Context</span> <span class="op">-&gt;</span> <span class="dt">Parser</span> <span class="dt">Term</span></span>
<span id="cb12-51"><a href="#cb12-51"></a><span class="fu">varParser</span> <span class="fu">ctx</span> <span class="op">=</span></span>
<span id="cb12-52"><a href="#cb12-52"></a>    <span class="fu">varStrParser</span></span>
<span id="cb12-53"><a href="#cb12-53"></a>        <span class="op">|&gt;</span> <span class="dt">Parser</span><span class="op">.</span><span class="fu">andThen</span> (<span class="fu">lookupVar</span> <span class="fu">ctx</span>)</span>
<span id="cb12-54"><a href="#cb12-54"></a>        <span class="op">|&gt;</span> <span class="dt">Parser</span><span class="op">.</span><span class="fu">map</span> (<span class="fu">flip</span> <span class="dt">TmVar</span> <span class="fu">ctx</span><span class="op">.</span><span class="fu">depth</span>)</span>
<span id="cb12-55"><a href="#cb12-55"></a></span>
<span id="cb12-56"><a href="#cb12-56"></a><span class="co">-- コンテキストには変数名とドブラウン・インデックスの連想配列がある</span></span>
<span id="cb12-57"><a href="#cb12-57"></a><span class="co">-- なので，変数名で引っ張ってくるだけ</span></span>
<span id="cb12-58"><a href="#cb12-58"></a><span class="fu">lookupVar</span> : <span class="dt">Context</span> <span class="op">-&gt;</span> <span class="dt">String</span> <span class="op">-&gt;</span> <span class="dt">Parser</span> <span class="dt">Int</span></span>
<span id="cb12-59"><a href="#cb12-59"></a><span class="fu">lookupVar</span> <span class="fu">ctx</span> <span class="fu">s</span> <span class="op">=</span></span>
<span id="cb12-60"><a href="#cb12-60"></a>  <span class="dt">Dict</span><span class="op">.</span><span class="fu">get</span> <span class="fu">s</span> <span class="fu">ctx</span><span class="op">.</span><span class="fu">env</span></span>
<span id="cb12-61"><a href="#cb12-61"></a>      <span class="op">|&gt;</span> <span class="dt">Maybe</span><span class="op">.</span><span class="fu">map</span> <span class="dt">Parser</span><span class="op">.</span><span class="fu">succeed</span></span>
<span id="cb12-62"><a href="#cb12-62"></a>      <span class="op">|&gt;</span> <span class="dt">Maybe</span><span class="op">.</span><span class="fu">withDefault</span> (<span class="dt">Parser</span><span class="op">.</span><span class="fu">problem</span> (<span class="st">&quot;undefined variable: &quot;</span> <span class="op">++</span> <span class="fu">s</span>))</span></code></pre></div>
<p>REPL で試してみる:</p>
<div class="sourceCode" id="cb13"><pre class="sourceCode elm"><code class="sourceCode elm"><span id="cb13-1"><a href="#cb13-1"></a><span class="op">&gt;</span> <span class="kw">import</span> <span class="dt">TaPL</span><span class="op">.</span><span class="dt">Chap7</span><span class="op">.</span><span class="dt">Parser</span> <span class="kw">as</span> <span class="dt">Parser</span></span>
<span id="cb13-2"><a href="#cb13-2"></a><span class="op">&gt;</span> <span class="dt">Parser</span><span class="op">.</span><span class="fu">parse</span> <span class="st">&quot;\\x. x&quot;</span></span>
<span id="cb13-3"><a href="#cb13-3"></a><span class="dt">Ok</span> (<span class="dt">TmAbs</span> <span class="st">&quot;x&quot;</span> (<span class="dt">TmVar</span> <span class="dv">0</span> <span class="dv">1</span>))</span>
<span id="cb13-4"><a href="#cb13-4"></a>    : <span class="dt">Result</span> (<span class="dt">List</span> <span class="dt">Parser</span><span class="op">.</span><span class="dt">DeadEnd</span>) <span class="dt">Term</span></span>
<span id="cb13-5"><a href="#cb13-5"></a><span class="op">&gt;</span> <span class="dt">Parser</span><span class="op">.</span><span class="fu">parse</span> <span class="st">&quot;\\x. (\\y . x)&quot;</span></span>
<span id="cb13-6"><a href="#cb13-6"></a><span class="dt">Ok</span> (<span class="dt">TmAbs</span> <span class="st">&quot;x&quot;</span> (<span class="dt">TmAbs</span> <span class="st">&quot;y&quot;</span> (<span class="dt">TmVar</span> <span class="dv">1</span> <span class="dv">2</span>)))</span>
<span id="cb13-7"><a href="#cb13-7"></a>    : <span class="dt">Result</span> (<span class="dt">List</span> <span class="dt">Parser</span><span class="op">.</span><span class="dt">DeadEnd</span>) <span class="dt">Term</span></span>
<span id="cb13-8"><a href="#cb13-8"></a><span class="op">&gt;</span> <span class="dt">Parser</span><span class="op">.</span><span class="fu">parse</span> <span class="st">&quot;\\x. (\\y . z)&quot;</span></span>
<span id="cb13-9"><a href="#cb13-9"></a><span class="dt">Err</span> [{ <span class="fu">col</span> <span class="op">=</span> <span class="dv">12</span><span class="op">,</span> <span class="fu">problem</span> <span class="op">=</span> <span class="dt">Problem</span> (<span class="st">&quot;undefined variable: z&quot;</span>)<span class="op">,</span> <span class="fu">row</span> <span class="op">=</span> <span class="dv">1</span> }]</span>
<span id="cb13-10"><a href="#cb13-10"></a>    : <span class="dt">Result</span> (<span class="dt">List</span> <span class="dt">Parser</span><span class="op">.</span><span class="dt">DeadEnd</span>) <span class="dt">Term</span></span></code></pre></div>
<p>自由変数が出てくるとちゃんとエラーになる．</p>
<p>残るは関数適用だ． 実はこいつが難しい． というのも，雑に実装をするといわゆる左再帰が出てくるからだ．</p>
<ul>
<li><a href="https://kazu-yamamoto.hatenablog.jp/entry/20110127/1296098875">chainl と左再帰 - あどけない話</a></li>
</ul>
<p>なので，一工夫する必要がある:</p>
<div class="sourceCode" id="cb14"><pre class="sourceCode elm"><code class="sourceCode elm"><span id="cb14-1"><a href="#cb14-1"></a><span class="fu">termParser</span> : <span class="dt">Context</span> <span class="op">-&gt;</span> <span class="dt">Parser</span> <span class="dt">Term</span></span>
<span id="cb14-2"><a href="#cb14-2"></a><span class="fu">termParser</span> <span class="fu">ctx</span> <span class="op">=</span></span>
<span id="cb14-3"><a href="#cb14-3"></a>    <span class="co">-- 関数適用は t1 t2 なのでまずは t1 にマッチさせ</span></span>
<span id="cb14-4"><a href="#cb14-4"></a>    <span class="dt">Parser</span><span class="op">.</span><span class="fu">oneOf</span></span>
<span id="cb14-5"><a href="#cb14-5"></a>        [ <span class="fu">parParser</span> <span class="fu">ctx</span></span>
<span id="cb14-6"><a href="#cb14-6"></a>        <span class="op">,</span> <span class="fu">absParser</span> <span class="fu">ctx</span></span>
<span id="cb14-7"><a href="#cb14-7"></a>        <span class="op">,</span> <span class="fu">varParser</span> <span class="fu">ctx</span></span>
<span id="cb14-8"><a href="#cb14-8"></a>        ]  <span class="co">-- 後から t2 を探す</span></span>
<span id="cb14-9"><a href="#cb14-9"></a>        <span class="op">|&gt;</span> <span class="dt">Parser</span><span class="op">.</span><span class="fu">andThen</span> (<span class="fu">appParser</span> <span class="fu">ctx</span>)</span>
<span id="cb14-10"><a href="#cb14-10"></a></span>
<span id="cb14-11"><a href="#cb14-11"></a><span class="co">-- 関数適用 t1 t2 のパーサー</span></span>
<span id="cb14-12"><a href="#cb14-12"></a><span class="fu">appParser</span> : <span class="dt">Context</span> <span class="op">-&gt;</span> <span class="dt">Term</span> <span class="op">-&gt;</span> <span class="dt">Parser</span> <span class="dt">Term</span></span>
<span id="cb14-13"><a href="#cb14-13"></a><span class="fu">appParser</span> <span class="fu">ctx</span> <span class="fu">t</span> <span class="op">=</span></span>
<span id="cb14-14"><a href="#cb14-14"></a>    <span class="dt">Parser</span><span class="op">.</span><span class="fu">oneOf</span></span>
<span id="cb14-15"><a href="#cb14-15"></a>        [ <span class="dt">Parser</span><span class="op">.</span><span class="fu">succeed</span> (<span class="dt">TmApp</span> <span class="fu">t</span>)</span>
<span id="cb14-16"><a href="#cb14-16"></a>            <span class="co">-- backtrackable や commit は一旦無視して良い</span></span>
<span id="cb14-17"><a href="#cb14-17"></a>            <span class="co">-- termWithoutAppParser が先に出てくるのは関数適用が左結合のため</span></span>
<span id="cb14-18"><a href="#cb14-18"></a>            <span class="co">-- 例: t1 t2 t3 は (t1 t2) t3 つまり (TmApp (TmApp t1 t2) t3)</span></span>
<span id="cb14-19"><a href="#cb14-19"></a>            <span class="op">|.</span> <span class="dt">Parser</span><span class="op">.</span><span class="fu">backtrackable</span> (<span class="dt">Parser</span><span class="op">.</span><span class="fu">symbol</span> <span class="st">&quot; &quot;</span> <span class="op">|.</span> <span class="dt">Parser</span><span class="op">.</span><span class="fu">spaces</span>)</span>
<span id="cb14-20"><a href="#cb14-20"></a>            <span class="op">|=</span> <span class="dt">Parser</span><span class="op">.</span><span class="fu">lazy</span> (\<span class="fu">_</span> <span class="op">-&gt;</span> <span class="fu">termWithoutAppParser</span> <span class="fu">ctx</span>)</span>
<span id="cb14-21"><a href="#cb14-21"></a>            <span class="op">|&gt;</span> <span class="dt">Parser</span><span class="op">.</span><span class="fu">andThen</span> <span class="dt">Parser</span><span class="op">.</span><span class="fu">commit</span></span>
<span id="cb14-22"><a href="#cb14-22"></a>            <span class="op">|&gt;</span> <span class="dt">Parser</span><span class="op">.</span><span class="fu">andThen</span> (<span class="fu">appParser</span> <span class="fu">ctx</span>)</span>
<span id="cb14-23"><a href="#cb14-23"></a>        <span class="co">-- t2 がなければ t1 のまんま返す</span></span>
<span id="cb14-24"><a href="#cb14-24"></a>        <span class="op">,</span> <span class="dt">Parser</span><span class="op">.</span><span class="fu">succeed</span> <span class="fu">t</span></span>
<span id="cb14-25"><a href="#cb14-25"></a>        ]</span>
<span id="cb14-26"><a href="#cb14-26"></a></span>
<span id="cb14-27"><a href="#cb14-27"></a><span class="co">-- 関数適用を抜いた termParser</span></span>
<span id="cb14-28"><a href="#cb14-28"></a><span class="fu">termWithoutAppParser</span> : <span class="dt">Context</span> <span class="op">-&gt;</span> <span class="dt">Parser</span> <span class="dt">Term</span></span>
<span id="cb14-29"><a href="#cb14-29"></a><span class="fu">termWithoutAppParser</span> <span class="fu">ctx</span> <span class="op">=</span></span>
<span id="cb14-30"><a href="#cb14-30"></a>    <span class="dt">Parser</span><span class="op">.</span><span class="fu">oneOf</span></span>
<span id="cb14-31"><a href="#cb14-31"></a>        [ <span class="fu">parParser</span> <span class="fu">ctx</span></span>
<span id="cb14-32"><a href="#cb14-32"></a>        <span class="op">,</span> <span class="fu">absParser</span> <span class="fu">ctx</span></span>
<span id="cb14-33"><a href="#cb14-33"></a>        <span class="op">,</span> <span class="fu">varParser</span> <span class="fu">ctx</span></span>
<span id="cb14-34"><a href="#cb14-34"></a>        ]</span></code></pre></div>
<p><code>backtrackable</code> と <code>commit</code> はパーサーが文字列を消費してしまう問題の解決方法だ． パーサーの処理が進むと対象の文字列をどんどん消費していく． <code>oneOf</code> で複数のパーサーを許容するとき，1文字目の結果で分岐できることが保証されているなら問題ないが，途中まで進み文字列を消費して失敗すると，その文字列を消費した状態で <code>oneOf</code> 内の次のパーサーへ進んでしまう． そこで，elm/parser の場合は消費を戻して欲しい場合はし <code>backtrackable</code> を使い，もう戻らなくて良くなった時点で <code>commit</code> を使う，という感じ（たぶん）． まぁ今回は必要ではない気がするが，後々必要になってくる．</p>
<h1 id="section-2"></h1>
<p>さぁ REPL で確認してみよう:</p>
<div class="sourceCode" id="cb15"><pre class="sourceCode elm"><code class="sourceCode elm"><span id="cb15-1"><a href="#cb15-1"></a><span class="op">&gt;</span>  <span class="dt">Parser</span><span class="op">.</span><span class="fu">parse</span> <span class="st">&quot;(\\x . \\f . f x) (\\x . x) (\\x . (\\x . x))&quot;</span></span>
<span id="cb15-2"><a href="#cb15-2"></a><span class="op">|</span>   <span class="op">|&gt;</span> <span class="dt">Result</span><span class="op">.</span><span class="fu">toMaybe</span></span>
<span id="cb15-3"><a href="#cb15-3"></a><span class="op">|</span>   <span class="op">|&gt;</span> <span class="dt">Maybe</span><span class="op">.</span><span class="fu">andThen</span> (<span class="dt">Chap7</span><span class="op">.</span><span class="fu">eval</span> [])</span>
<span id="cb15-4"><a href="#cb15-4"></a><span class="op">|</span>   <span class="op">|&gt;</span> <span class="dt">Maybe</span><span class="op">.</span><span class="fu">map</span> <span class="dt">Chap7</span><span class="op">.</span><span class="fu">display</span></span>
<span id="cb15-5"><a href="#cb15-5"></a><span class="op">|</span>   </span>
<span id="cb15-6"><a href="#cb15-6"></a><span class="dt">Just</span> (<span class="st">&quot;\\x. x&quot;</span>) : <span class="dt">Maybe</span> <span class="dt">String</span></span></code></pre></div>
<p>完璧だ．</p>
<h2 id="おまけ-spa-にする">おまけ: SPA にする</h2>
<p>今回も同様に SPA にする． 章ごとにページ分けても良かったが，試しに一つにまとめてみた． つまり，4章の言語と7章の言語を同じように扱う． どちらも:</p>
<ul>
<li>文字列をパースする(<code>parse</code>)</li>
<li>項を1ステップ評価する(<code>eval1</code>)</li>
<li>項を文字列に変換する(<code>display</code>)</li>
</ul>
<p>をしたい． こういった場合，多くの言語ではインターフェースや型クラスのようなアドホック多相を利用する． しかし，Elm にはアドホック多相はない． そのため，パラメトリック多相で模倣する:</p>
<div class="sourceCode" id="cb16"><pre class="sourceCode elm"><code class="sourceCode elm"><span id="cb16-1"><a href="#cb16-1"></a><span class="co">-- 各章の言語の Context と Term 型を受け取る</span></span>
<span id="cb16-2"><a href="#cb16-2"></a><span class="kw">type</span> <span class="kw">alias</span> <span class="dt">Calculus</span> <span class="fu">ctx</span> <span class="fu">t</span> <span class="op">=</span></span>
<span id="cb16-3"><a href="#cb16-3"></a>    { <span class="fu">parse</span> : <span class="dt">String</span> <span class="op">-&gt;</span> <span class="dt">Result</span> (<span class="dt">List</span> <span class="dt">Parser</span><span class="op">.</span><span class="dt">DeadEnd</span>) <span class="fu">t</span></span>
<span id="cb16-4"><a href="#cb16-4"></a>    <span class="op">,</span> <span class="fu">eval1</span> : <span class="fu">ctx</span> <span class="op">-&gt;</span> <span class="fu">t</span> <span class="op">-&gt;</span> <span class="dt">Maybe</span> <span class="fu">t</span></span>
<span id="cb16-5"><a href="#cb16-5"></a>    <span class="op">,</span> <span class="fu">display</span> : <span class="fu">t</span> <span class="op">-&gt;</span> <span class="dt">String</span></span>
<span id="cb16-6"><a href="#cb16-6"></a>    <span class="op">,</span> <span class="fu">init</span> : <span class="fu">ctx</span>     <span class="co">-- Context の初期値</span></span>
<span id="cb16-7"><a href="#cb16-7"></a>    <span class="op">,</span> <span class="fu">logs</span> : <span class="dt">List</span> <span class="fu">t</span>  <span class="co">-- Term の履歴(表示用)</span></span>
<span id="cb16-8"><a href="#cb16-8"></a>    }</span>
<span id="cb16-9"><a href="#cb16-9"></a></span>
<span id="cb16-10"><a href="#cb16-10"></a><span class="fu">parse</span> : <span class="dt">String</span> <span class="op">-&gt;</span> <span class="dt">Calculus</span> <span class="fu">ctx</span> <span class="fu">t</span> <span class="fu">ty</span> <span class="op">-&gt;</span> <span class="dt">Result</span> (<span class="dt">List</span> <span class="dt">Parser</span><span class="op">.</span><span class="dt">DeadEnd</span>) (<span class="dt">Calculus</span> <span class="fu">ctx</span> <span class="fu">t</span> <span class="fu">ty</span>)</span>
<span id="cb16-11"><a href="#cb16-11"></a><span class="fu">eval1</span> : <span class="dt">Calculus</span> <span class="fu">ctx</span> <span class="fu">t</span> <span class="fu">ty</span> <span class="op">-&gt;</span> <span class="dt">Maybe</span> (<span class="dt">Calculus</span> <span class="fu">ctx</span> <span class="fu">t</span> <span class="fu">ty</span>)</span>
<span id="cb16-12"><a href="#cb16-12"></a><span class="fu">display</span> : <span class="dt">Calculus</span> <span class="fu">ctx</span> <span class="fu">t</span> <span class="fu">ty</span> <span class="op">-&gt;</span> <span class="dt">List</span> <span class="dt">String</span></span></code></pre></div>
<p><code>Calculus</code> には章ごとに型が異なるものを全部突っ込む必要がある． そのため <code>logs</code> のようなフィールドもある(前回 <code>Model</code> 型の <code>exps</code> にあったやつ)． この型の値を各章ごとに定義しよう:</p>
<div class="sourceCode" id="cb17"><pre class="sourceCode elm"><code class="sourceCode elm"><span id="cb17-1"><a href="#cb17-1"></a><span class="kw">type</span> <span class="dt">Chapter</span></span>
<span id="cb17-2"><a href="#cb17-2"></a>    <span class="op">=</span> <span class="dt">Chap0</span></span>
<span id="cb17-3"><a href="#cb17-3"></a>    <span class="op">|</span> <span class="dt">Chap4</span> (<span class="dt">Calculus</span> () <span class="dt">Chap4</span><span class="op">.</span><span class="dt">Term</span>)</span>
<span id="cb17-4"><a href="#cb17-4"></a>    <span class="op">|</span> <span class="dt">Chap7</span> (<span class="dt">Calculus</span> <span class="dt">Chap7</span><span class="op">.</span><span class="dt">Context</span> <span class="dt">Chap7</span><span class="op">.</span><span class="dt">Term</span>)</span>
<span id="cb17-5"><a href="#cb17-5"></a></span>
<span id="cb17-6"><a href="#cb17-6"></a><span class="fu">init</span> : <span class="dt">String</span> <span class="op">-&gt;</span> <span class="dt">Chapter</span></span>
<span id="cb17-7"><a href="#cb17-7"></a><span class="fu">init</span> <span class="fu">s</span> <span class="op">=</span></span>
<span id="cb17-8"><a href="#cb17-8"></a>    <span class="cf">case</span> <span class="fu">s</span> <span class="cf">of</span></span>
<span id="cb17-9"><a href="#cb17-9"></a>        <span class="st">&quot;chap4&quot;</span> <span class="op">-&gt;</span></span>
<span id="cb17-10"><a href="#cb17-10"></a>            <span class="dt">Chap4</span></span>
<span id="cb17-11"><a href="#cb17-11"></a>                { <span class="fu">parse</span> <span class="op">=</span> <span class="dt">Chap4</span><span class="op">.</span><span class="fu">parse</span></span>
<span id="cb17-12"><a href="#cb17-12"></a>                <span class="op">,</span> <span class="fu">eval1</span> <span class="op">=</span> \<span class="fu">_</span> <span class="op">-&gt;</span> <span class="dt">Chap4</span><span class="op">.</span><span class="fu">eval1</span></span>
<span id="cb17-13"><a href="#cb17-13"></a>                <span class="op">,</span> <span class="fu">display</span> <span class="op">=</span> <span class="dt">Chap4</span><span class="op">.</span><span class="fu">display</span></span>
<span id="cb17-14"><a href="#cb17-14"></a>                <span class="op">,</span> <span class="fu">init</span> <span class="op">=</span> ()</span>
<span id="cb17-15"><a href="#cb17-15"></a>                <span class="op">,</span> <span class="fu">logs</span> <span class="op">=</span> []</span>
<span id="cb17-16"><a href="#cb17-16"></a>                }</span>
<span id="cb17-17"><a href="#cb17-17"></a></span>
<span id="cb17-18"><a href="#cb17-18"></a>        <span class="st">&quot;chap7&quot;</span> <span class="op">-&gt;</span></span>
<span id="cb17-19"><a href="#cb17-19"></a>            <span class="dt">Chap7</span></span>
<span id="cb17-20"><a href="#cb17-20"></a>                { <span class="fu">parse</span> <span class="op">=</span> <span class="dt">Chap7</span><span class="op">.</span><span class="fu">parse</span></span>
<span id="cb17-21"><a href="#cb17-21"></a>                <span class="op">,</span> <span class="fu">eval1</span> <span class="op">=</span> <span class="dt">Chap7</span><span class="op">.</span><span class="fu">eval1</span></span>
<span id="cb17-22"><a href="#cb17-22"></a>                <span class="op">,</span> <span class="fu">display</span> <span class="op">=</span> <span class="dt">Chap7</span><span class="op">.</span><span class="fu">display</span></span>
<span id="cb17-23"><a href="#cb17-23"></a>                <span class="op">,</span> <span class="fu">init</span> <span class="op">=</span> []</span>
<span id="cb17-24"><a href="#cb17-24"></a>                <span class="op">,</span> <span class="fu">logs</span> <span class="op">=</span> []</span>
<span id="cb17-25"><a href="#cb17-25"></a>                }</span>
<span id="cb17-26"><a href="#cb17-26"></a></span>
<span id="cb17-27"><a href="#cb17-27"></a><span class="fu">parse</span> : <span class="dt">Chapter</span> <span class="op">-&gt;</span> <span class="dt">String</span> <span class="op">-&gt;</span> <span class="dt">Result</span> (<span class="dt">List</span> <span class="dt">Parser</span><span class="op">.</span><span class="dt">DeadEnd</span>) <span class="dt">Chapter</span></span>
<span id="cb17-28"><a href="#cb17-28"></a><span class="fu">eval1</span> : <span class="dt">Chapter</span> <span class="op">-&gt;</span> <span class="dt">Maybe</span> <span class="dt">Chapter</span></span>
<span id="cb17-29"><a href="#cb17-29"></a><span class="fu">display</span> : <span class="dt">Chapter</span> <span class="op">-&gt;</span> <span class="dt">List</span> <span class="dt">String</span></span></code></pre></div>
<p>あとは <code>Chapter</code> 型を <code>main</code> の <code>Model</code> に持たせて，それぞれの関数を <code>Chapter</code> のものへと置き換えるだけ． これが良い方法かどうか，正直なんとも言えないが面白いモノができたの個人的には満足．</p>
<h2 id="おしまい">おしまい</h2>
<p>ところで，型なしラムダ計算は停止しない場合がある(例えば <code>(\x . x x) (\x . x x)</code> とか)． このような式を SPA に突っ込むと無限に eval ボタンを押せてしまう． そこで，同期からは「eval ボタンが下にずれていくから無限プチプチみたいなのができない」と言われた笑． 検討した結果，ボタン固定にすると式の結果を追うのに上下スクロールを何回もしないとなので却下した(ごめんね)．</p>
  </div>
</div>
</article>

          </div>
        </div>

        <footer class="site-footer">

  <div class="wrapper">

    <span class="footer-heading">ひげメモ</span>

  </div>

  <div class="page-content card" style="display: flex; justify-content: center; padding: 5px 0px">
    <a href="https://haskell.jp/blog/posts/links.html#matsubara0507.github.io">
      <img width="234" src="https://haskell.jp/img/supported-by-haskell-jp.svg" alt="Supported By Haskell-jp.">
    </a>
  </div>

</footer>


      </div>
  </body>

</html>
