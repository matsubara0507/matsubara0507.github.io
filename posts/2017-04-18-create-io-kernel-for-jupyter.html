<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE html>
<html lang="ja">

  <head>
  <meta charset="utf-8">
  <link rel="icon" href="../assets/icon.jpg">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
    
      <meta property="og:title" content="Io 言語の Jupyter Kernel を作る with Docker" />
    
  

  <meta property="og:site_name" content="ひげメモ" />

  
    <meta property="og:image" content="/assets/create-io-kernel-for-jupyter/iio2.png" />
  

  
    <script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-86386380-1', 'auto');
  ga('send', 'pageview');
</script>

  

  <title>
    
      
        Io 言語の Jupyter Kernel を作る with Docker
      
    
  </title>

  <link rel="stylesheet" href="../css/main.css">
  <link rel="stylesheet" href="../css/highlight.css">
  <link rel="stylesheet" type="text/css" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.4.0/css/font-awesome.min.css" />
</head>


  <body>
      <div class="outer">

        <header class="site-header">

  <div class="wrapper">

    <a class="site-title" href="https://matsubara0507.github.io/">ひげメモ</a>

  </div>

  <div class="header-badge">
    <a href="https://matsubara0507.github.io/">
        <img src="../assets/icon.jpg" />
    </a>
  </div>

</header>


        <div class="page-content">
          <div class="wrapper">
            <article class="post card" itemscope itemtype="http://schema.org/BlogPosting">
 <div class="card-content">
  <header class="post-header">
    <h1 class="post-title" itemprop="name headline">Io 言語の Jupyter Kernel を作る with Docker</h1>
    <p class="post-meta">
      <time datetime="2017-04-18" itemprop="datePublished">
        Apr 18, 2017
      </time>
      
    </p>
  </header>

  <div class="post-content" itemprop="articleBody">
    <p><a href="https://www.docker.com/">Docker</a> 使いながら，<a href="http://iolanguage.org/">Io</a> 言語の <a href="http://jupyter.org/">Jupyter</a> Kernel を作ったので，そのときのメモを書いておく．</p>
<p><a href="https://hub.docker.com/r/matsubara0507/iio/">作った Kernel は Dockerイメージとして置いときました．</a></p>
<h2 id="いきさつ">いきさつ</h2>
<p><a href="../posts/2017-03-27-seven-lang-on-docker.html">何回か前の記事</a>で書いたんだが，「<a href="https://estore.ohmsha.co.jp/titles/978427406857P">7つの言語、7つの世界</a>」という書籍の Jupyter notebook を作りたい． が，Io の Kernerl だけ<a href="https://github.com/jupyter/jupyter/wiki/Jupyter-kernels">なかった</a>ので，(ついに)作ろうかなと．</p>
<h3 id="io">Io</h3>
<p>7つの言語の書籍の2つ目に紹介されていた言語． 公式サイト曰く，純粋な<a href="https://en.wikipedia.org/wiki/Prototype-based_programming">プロトタイプベース</a>の言語らしい．</p>
<p>(書籍曰く)プロトタイプベースの言語の最も有名な言語は Javascript であり，要するにオブジェクトをどんどんコピーして新しいオブジェクト(クラス)を定義していくプログラミングスタイルらしい． Javascript は機能がすごい豊富だが，Io はものすごくコンパクトに作られている． まぁ，興味があったら，書籍の Io の章だけ呼んでみると面白いと思う．</p>
<h3 id="jupyter-notebook">Jupyter notebook</h3>
<p>すごくリッチな REPL というイメージ． データサイエンティストはよく使うらしい(Python とかを)．</p>
<p>うれしいのは，REPL の履歴をファイルとして残せること． 7つの言語の書籍は特に，REPL 形式での例題が多いので，相性が良いかなと思ってる．</p>
<h2 id="作る">作る</h2>
<p><a href="http://jupyter-client.readthedocs.io/en/latest/kernels.html#making-kernels-for-jupyter">作り方は大きく分けて2つあるらしい</a>．</p>
<blockquote>
<ol style="list-style-type: decimal">
<li>You can reuse the IPython kernel machinery to handle the communications, and just describe how to execute your code. This is much simpler if the target language can be driven from Python. See Making simple Python wrapper kernels for details.</li>
<li>You can implement the kernel machinery in your target language. This is more work initially, but the people using your kernel might be more likely to contribute to it if it’s in the language they know.</li>
</ol>
</blockquote>
<p>IPyhorn でラップして作るか，Io で直接作るか，の2択． 後者の方が難しいけど，カッコいい(?)ので挑戦しようとしたが <strong>ぜんぜんよくわからなかった</strong> ので，諦めて前者にした．</p>
<p>前者の場合は日本語の記事も含めて，情報が豊富なので助かった．</p>
<ul>
<li><a href="http://jupyter-client.readthedocs.io/en/latest/wrapperkernels.html">Making simple Python wrapper kernels — jupyter_client 5.1.0.dev documentation</a></li>
<li><a href="http://qiita.com/antimon2/items/7d9c084b142d38b67b1f">Jupyter の Egison 簡易カーネルを自作してみた。 - Qiita</a></li>
<li><a href="http://qiita.com/SaitoTsutomu/items/3c996bde01ef2637aadc">Jupyterのkernelを作ってみる - Qiita</a></li>
</ul>
<p>IPython をラップする形で Kernel を作るには、Jupyter(Python) と，ターゲット言語(今回では Io)が必要である． ローカルでやってもいいんだけど， <strong>Windows 的にはつらいものが多い</strong> ので Docker でガチャガチャする．</p>
<h3 id="開発環境">開発環境</h3>
<ul>
<li>ホストOS : Windows 10 Home</li>
<li>Docker : 1.12.3</li>
<li>Python : 3.6.1</li>
<li>Jupyter : 4.3.0</li>
<li>Io : 2015.11.11 (v.20140919)</li>
</ul>
<h3 id="dockerfile-を作る">Dockerfile を作る</h3>
<p>前述したとおり，Jupyter + Io が必要．</p>
<p>いくつかのやり方が考えられる．</p>
<ol style="list-style-type: decimal">
<li><a href="https://hub.docker.com/r/jupyter/notebook/">Jupyter のイメージ</a> + Io をインストール</li>
<li><a href="https://github.com/matsubara0507/seven-languages-in-seven-weeks/blob/docker/Dockerfiles/io/Dockerfile">Io のイメージ</a> + Jupyter をインストール</li>
<li><a href="https://hub.docker.com/_/python/">Python のイメージ</a> + Jupyter と Io をインストール</li>
</ol>
<p>上から順に試したところ，3番でなら難なくできた． ちなみに，1 は Io をビルドするとこける． 2 は Jupyter をインストールするときにこける． 理由も良くわからなかったので，どんどんやり方を変えてったら 3 でうまくいった．</p>
<p>以下が Dockerfile</p>
<div class="sourceCode"><pre class="sourceCode dockerfile"><code class="sourceCode dockerfile"><span class="kw">FROM</span> python:latest

<span class="kw">ENV</span> HOME /root
<span class="kw">WORKDIR</span> $HOME

<span class="kw">RUN</span> pip install ipython jupyter

<span class="co"># Io</span>

<span class="kw">RUN</span> apt-get update &amp;&amp; apt-get install -y --no-install-recommends \
    cmake \
    g++ \
    gcc \
    libyajl-dev \
    libpython3.4-dev \
    libgmp-dev \
    libmemcached-dev \
    make \
    &amp;&amp; apt-get clean \
    &amp;&amp; rm -rf /var/lib/apt/lists/*
<span class="kw">RUN</span> git clone --branch 2015.11.11 --depth 1 https://github.com/stevedekorte/io.git ~/io \
    &amp;&amp; mkdir -p ~/io/build \
    &amp;&amp; cd ~/io/build \
    &amp;&amp; cmake .. \
    &amp;&amp; make install \
    &amp;&amp; rm -fr ~/io

<span class="kw">EXPOSE</span> 8888

<span class="kw">CMD</span> [<span class="st">&quot;jupyter&quot;</span>, <span class="st">&quot;notebook&quot;</span>, <span class="st">&quot;--no-browser&quot;</span>, <span class="st">&quot;--allow-root&quot;</span>, <span class="st">&quot;--ip='0.0.0.0'&quot;</span>]</code></pre></div>
<p><a href="https://docs.docker.com/docker-for-windows/">Docker for Windows</a> のせいか， <code>--ip='0.0.0.0'</code> というオプションを追加しないとうまくいかなかった．</p>
<p>これで，jupyter + Io の環境ができた．</p>
<pre><code>$ docker build -t iio .
$ docker run -it -v /c/Users/hoge/git/python/iio:/root/iio -p 8888:8888 --name=test iio /bin/bash</code></pre>
<p>カレントディレクトリを <code>/root</code> 以下に同期してる．</p>
<h3 id="kernel-を書く">Kernel を書く</h3>
<p>基本的に，「<a href="http://qiita.com/antimon2/items/7d9c084b142d38b67b1f">Jupyter の Egison 簡易カーネルを自作してみた。 - Qiita</a>」の記事を参考にして <code>egison</code> を <code>io</code> に置き換えただけ． プロンプトのところだけ，Io は <code>Io&gt;</code> となるので，そう変えた． 他にも，いらんかなぁというところ(versionをパターンマッチさせてるとことか)は削除してる．</p>
<div class="sourceCode"><pre class="sourceCode python"><code class="sourceCode python"><span class="im">from</span> ipykernel.kernelbase <span class="im">import</span> Kernel
<span class="im">from</span> pexpect <span class="im">import</span> replwrap, EOF
<span class="im">from</span> subprocess <span class="im">import</span> check_output

<span class="im">import</span> re
<span class="im">import</span> signal

crlf_pat <span class="op">=</span> re.<span class="bu">compile</span>(<span class="vs">r'[\r\n]+'</span>)

<span class="kw">class</span> IoKernel(Kernel):
    implementation <span class="op">=</span> <span class="st">'Io'</span>
    implementation_version <span class="op">=</span> <span class="st">'0.0.1'</span>

    language_info <span class="op">=</span> {
        <span class="st">'name'</span>: <span class="st">'Io'</span>,
        <span class="st">'codemirror_mode'</span>: <span class="st">'scheme'</span>,
        <span class="st">'mimetype'</span>: <span class="st">'text/plain'</span>,
        <span class="st">'file_extension'</span>: <span class="st">'.io'</span>
    }

    _language_version <span class="op">=</span> <span class="va">None</span>


    <span class="at">@property</span>
    <span class="kw">def</span> language_version(<span class="va">self</span>):
        <span class="cf">if</span> <span class="va">self</span>._language_version <span class="kw">is</span> <span class="va">None</span>:
            <span class="va">self</span>._language_version <span class="op">=</span> check_output([<span class="st">'io'</span>, <span class="st">'--version'</span>]).decode(<span class="st">'utf-8'</span>)
        <span class="cf">return</span> <span class="va">self</span>._language_version

    <span class="at">@property</span>
    <span class="kw">def</span> banner(<span class="va">self</span>):
        <span class="cf">return</span> <span class="st">u'Simple Io Kernel (</span><span class="sc">%s</span><span class="st">)'</span> <span class="op">%</span> <span class="va">self</span>.language_version

    <span class="kw">def</span> <span class="fu">__init__</span>(<span class="va">self</span>, <span class="op">**</span>kwargs):
        Kernel.<span class="fu">__init__</span>(<span class="va">self</span>, <span class="op">**</span>kwargs)
        <span class="va">self</span>._start_io()

    <span class="kw">def</span> _start_io(<span class="va">self</span>):
        sig <span class="op">=</span> signal.signal(signal.SIGINT, signal.SIG_DFL)
        <span class="cf">try</span>:
            <span class="va">self</span>.iowrapper <span class="op">=</span> replwrap.REPLWrapper(<span class="st">&quot;io&quot;</span>, <span class="st">&quot;Io&gt; &quot;</span>, <span class="va">None</span>)
        <span class="cf">finally</span>:
            signal.signal(signal.SIGINT, sig)

    <span class="kw">def</span> do_execute(<span class="va">self</span>, code, silent, store_history<span class="op">=</span><span class="va">True</span>,
                   user_expressions<span class="op">=</span><span class="va">None</span>, allow_stdin<span class="op">=</span><span class="va">False</span>):
        code <span class="op">=</span> crlf_pat.sub(<span class="st">' '</span>, code.strip())
        <span class="cf">if</span> <span class="kw">not</span> code:
            <span class="cf">return</span> {<span class="st">'status'</span>: <span class="st">'ok'</span>, <span class="st">'execution_count'</span>: <span class="va">self</span>.execution_count,
                    <span class="st">'payload'</span>: [], <span class="st">'user_expressions'</span>: {}}

        interrupted <span class="op">=</span> <span class="va">False</span>
        <span class="cf">try</span>:
            output <span class="op">=</span> <span class="va">self</span>.iowrapper.run_command(code, timeout<span class="op">=</span><span class="va">None</span>)
        <span class="cf">except</span> <span class="pp">KeyboardInterrupt</span>:
            <span class="va">self</span>.iowrapper.child.sendintr()
            interrupted <span class="op">=</span> <span class="va">True</span>
            <span class="va">self</span>.iowrapper._expect_prompt()
            output <span class="op">=</span> <span class="va">self</span>.iowrapper.child.before
        <span class="cf">except</span> EOF:
            output <span class="op">=</span> <span class="va">self</span>.iowrapper.child.before <span class="op">+</span> <span class="st">'Restarting Io'</span>
            <span class="va">self</span>._start_io()

        <span class="cf">if</span> <span class="kw">not</span> silent:
            <span class="co"># Send standard output</span>
            stream_content <span class="op">=</span> {<span class="st">'name'</span>: <span class="st">'stdout'</span>, <span class="st">'text'</span>: output}
            <span class="va">self</span>.send_response(<span class="va">self</span>.iopub_socket, <span class="st">'stream'</span>, stream_content)

        <span class="cf">if</span> interrupted:
            <span class="cf">return</span> {<span class="st">'status'</span>: <span class="st">'abort'</span>, <span class="st">'execution_count'</span>: <span class="va">self</span>.execution_count}

        <span class="cf">return</span> {<span class="st">'status'</span>: <span class="st">'ok'</span>, <span class="st">'execution_count'</span>: <span class="va">self</span>.execution_count,
                <span class="st">'payload'</span>: [], <span class="st">'user_expressions'</span>: {}}

<span class="co"># ===== MAIN =====</span>
<span class="cf">if</span> <span class="va">__name__</span> <span class="op">==</span> <span class="st">'__main__'</span>:
    <span class="im">from</span> IPython.kernel.zmq.kernelapp <span class="im">import</span> IPKernelApp
    IPKernelApp.launch_instance(kernel_class<span class="op">=</span>IoKernel)</code></pre></div>
<p>これを <code>iokernel.py</code> という名前でカレントディレクトリで保存した．</p>
<p>次に，以下のような <code>kernel.json</code> というファイルを作成した．</p>
<div class="sourceCode"><pre class="sourceCode json"><code class="sourceCode json"><span class="fu">{</span>
  <span class="dt">&quot;display_name&quot;</span><span class="fu">:</span> <span class="st">&quot;Io&quot;</span><span class="fu">,</span>
  <span class="dt">&quot;language&quot;</span><span class="fu">:</span> <span class="st">&quot;io&quot;</span><span class="fu">,</span>
  <span class="dt">&quot;argv&quot;</span><span class="fu">:</span> <span class="ot">[</span><span class="st">&quot;python&quot;</span><span class="ot">,</span> <span class="st">&quot;/root/iio/iokernel.py&quot;</span><span class="ot">,</span> <span class="st">&quot;-f&quot;</span><span class="ot">,</span> <span class="st">&quot;{connection_file}&quot;</span><span class="ot">]</span><span class="fu">,</span>
  <span class="dt">&quot;codemirror_mode&quot;</span><span class="fu">:</span> <span class="st">&quot;scheme&quot;</span>
<span class="fu">}</span></code></pre></div>
<p>これを，適当な名前のディレクトリ(今回は <code>./iokernel/</code>)の下に置く． で，<code>/root/iio</code> で <code>jupyter kernelspec install kernel.json</code> を実行すると，Io の Kernel が Jupyter notebook に登録される．</p>
<h2 id="実行">実行</h2>
<p>Docker 内で <code>jupyter notebook --no-browser --allow-root --ip='0.0.0.0'</code> と実行し，設定されている IP アドレスにアクセスすると Jupyter が起動し，右上の New に Io が追加されているはず．</p>
<div class="figure">
<img src="../assets/create-io-kernel-for-jupyter/iio1.jpg" />

</div>
<div class="figure">
<img src="../assets/create-io-kernel-for-jupyter/iio2.png" />

</div>
<h2 id="dockerイメージ化">Dockerイメージ化</h2>
<p><code>./iokernel.py</code> と <code>./iokernel/kernel.json</code> をマウントしたり，<code>jupyter kernelspec install</code> を実行したりを追加する．</p>
<p>前に書いた Dockerfile の <code>EXPOSE</code> の行の前に以下を追加した．</p>
<div class="sourceCode"><pre class="sourceCode dockerfile"><code class="sourceCode dockerfile"><span class="kw">WORKDIR</span> $HOME/iio
<span class="kw">ADD</span> . $HOME/iio
<span class="kw">RUN</span> jupyter kernelspec install iokernel</code></pre></div>
<p>これで，<code>docker run</code> するだけで，Io 入りの Jupyter のコンテナがイメージが出来上がった． やった．</p>
<h2 id="おしまい">おしまい</h2>
<p>何十番煎じだよというネタだったが，まぁメモなのでご勘弁を． もう少し，改良するとして，これで全ての言語の Jupyter Kernel が揃った．</p>
<p>あとマージするだけ． どーやるんだろ…？</p>
  </div>
</div>
</article>

          </div>
        </div>

        <footer class="site-footer">

  <div class="wrapper">

    <span class="footer-heading">ひげメモ</span>

  </div>

  <div class="page-content card" style="display: flex; justify-content: center; padding: 5px 0px">
    <a href="https://haskell.jp/blog/posts/links.html#matsubara0507.github.io">
      <img width="234" src="https://haskell.jp/img/supported-by-haskell-jp.svg" alt="Supported By Haskell-jp.">
    </a>
  </div>

</footer>


      </div>
  </body>

</html>
