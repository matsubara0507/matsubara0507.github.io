<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE html>
<html lang="ja">

  <head>
  <meta charset="utf-8">
  <link rel="icon" href="../assets/icon.jpg">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
    
      <meta property="og:title" content="Elm で line charts する" />
    
  

  <meta property="og:site_name" content="ひげメモ" />

  
    <meta property="og:image" content="/assets/line-charts-with-elm/graph.jpg" />
  

  
    <script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-86386380-1', 'auto');
  ga('send', 'pageview');
</script>

  

  <title>
    
      
        Elm で line charts する
      
    
  </title>

  <link rel="stylesheet" href="../css/main.css">
  <link rel="stylesheet" href="../css/highlight.css">
  <link rel="stylesheet" type="text/css" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.4.0/css/font-awesome.min.css" />
</head>


  <body>
      <div class="outer">

        <header class="site-header">

  <div class="wrapper">

    <a class="site-title" href="https://matsubara0507.github.io/">ひげメモ</a>

  </div>

  <div class="header-badge">
    <a href="https://matsubara0507.github.io/">
        <img src="../assets/icon.jpg" />
    </a>
  </div>

</header>


        <div class="page-content">
          <div class="wrapper">
            <article class="post card" itemscope itemtype="http://schema.org/BlogPosting">
 <div class="card-content">
  <header class="post-header">
    <h1 class="post-title" itemprop="name headline">Elm で line charts する</h1>
    <p class="post-meta">
      <time datetime="2019-11-15" itemprop="datePublished">
        Nov 15, 2019
      </time>
      
      
      <div class="tags">
          <i class="fa fa-tags"></i> <a href="../tags/Elm.html">Elm</a>
      </div>
      
    </p>
  </header>

  <div class="post-content" itemprop="articleBody">
    <p>Elm で作っているスコアボードにスコアの線グラフを追加したかったので <a href="https://package.elm-lang.org/packages/terezka/line-charts/"><code>terezka/line-charts</code></a> というパッケージを使って追加した． っていうメモ書き。 追加の PR はこれです:</p>
<ul>
<li><a href="https://github.com/matsubara0507/git-plantation/pull/49">スコアボードにグラフを描写するページを追加 by matsubara0507 · Pull Request #49 · matsubara0507/git-plantation</a></li>
</ul>
<p>最終的に出来上がったグラフがこんな感じ:</p>
<p><img src="../assets/line-charts-with-elm/graph.jpg" /></p>
<p>実は色をランダムに生成している部分がキモ(?)です． ちなみに，本記事で扱う <code>terezka/line-charts</code> パッケージのバージョンは 2.0 です．</p>
<h2 id="terezkaline-charts">terezka/line-charts</h2>
<p>どんなグラフが書けるかは作者が用意してる<a href="https://terezka.github.io/line-charts">サンプルページ</a>を見ると良い． ただし，<code>see source</code> ボタンで右からニュッっと出てくるソースコードは Elm 0.19 では動かない点に注意． サンプルページのコードはおそらく<a href="https://github.com/terezka/line-charts/blob/2.0.0/docs/src">ココ</a>にある．</p>
<p>今回は競技プログラミングのスコア変遷をグラフ化したかったので <a href="https://github.com/terezka/line-charts/blob/2.0.0/docs/src/Stepped.elm"><code>Steeped</code></a> というグラフを使うことにする(段々になっているやつ)．</p>
<h3 id="linechart.viewcustom-を使ってみる"><code>LineChart.viewCustom</code> を使ってみる</h3>
<p>グラフを描写するには <code>LineChart.viewCustom</code> 関数を使う:</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode elm"><code class="sourceCode elm"><span id="cb1-1"><a href="#cb1-1"></a><span class="fu">viewCustom</span></span>
<span id="cb1-2"><a href="#cb1-2"></a>  : <span class="dt">Config</span> <span class="fu">data</span> <span class="fu">msg</span></span>
<span id="cb1-3"><a href="#cb1-3"></a>  <span class="op">-&gt;</span> <span class="dt">List</span> (<span class="dt">Series</span> <span class="fu">data</span>)</span>
<span id="cb1-4"><a href="#cb1-4"></a>  <span class="op">-&gt;</span> <span class="dt">Svg</span> <span class="fu">msg</span></span></code></pre></div>
<p>1引数めがどうのように描写するかの設定で，2引数目は描写する(プロットする)データのリストをである． <code>Config data msg</code> 型は次のようになっている:</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode elm"><code class="sourceCode elm"><span id="cb2-1"><a href="#cb2-1"></a><span class="kw">type</span> <span class="kw">alias</span> <span class="dt">Config</span> <span class="fu">data</span> <span class="fu">msg</span> <span class="op">=</span></span>
<span id="cb2-2"><a href="#cb2-2"></a>    { <span class="fu">x</span> : <span class="dt">Axis</span><span class="op">.</span><span class="dt">Config</span> <span class="fu">data</span> <span class="fu">msg</span></span>
<span id="cb2-3"><a href="#cb2-3"></a>    <span class="op">,</span> <span class="fu">y</span> : <span class="dt">Axis</span><span class="op">.</span><span class="dt">Config</span> <span class="fu">data</span> <span class="fu">msg</span></span>
<span id="cb2-4"><a href="#cb2-4"></a>    <span class="op">,</span> <span class="fu">container</span> : <span class="dt">Container</span><span class="op">.</span><span class="dt">Config</span> <span class="fu">msg</span></span>
<span id="cb2-5"><a href="#cb2-5"></a>    <span class="op">,</span> <span class="fu">intersection</span> : <span class="dt">Axis</span><span class="op">.</span><span class="dt">Intersection</span><span class="op">.</span><span class="dt">Config</span></span>
<span id="cb2-6"><a href="#cb2-6"></a>    <span class="op">,</span> <span class="fu">interpolation</span> : <span class="dt">Interpolation</span><span class="op">.</span><span class="dt">Config</span></span>
<span id="cb2-7"><a href="#cb2-7"></a>    <span class="op">,</span> <span class="fu">legends</span> : <span class="dt">Legends</span><span class="op">.</span><span class="dt">Config</span> <span class="fu">data</span> <span class="fu">msg</span></span>
<span id="cb2-8"><a href="#cb2-8"></a>    <span class="op">,</span> <span class="fu">events</span> : <span class="dt">Events</span><span class="op">.</span><span class="dt">Config</span> <span class="fu">data</span> <span class="fu">msg</span></span>
<span id="cb2-9"><a href="#cb2-9"></a>    <span class="op">,</span> <span class="fu">area</span> : <span class="dt">Area</span><span class="op">.</span><span class="dt">Config</span></span>
<span id="cb2-10"><a href="#cb2-10"></a>    <span class="op">,</span> <span class="fu">grid</span> : <span class="dt">Grid</span><span class="op">.</span><span class="dt">Config</span></span>
<span id="cb2-11"><a href="#cb2-11"></a>    <span class="op">,</span> <span class="fu">line</span> : <span class="dt">Line</span><span class="op">.</span><span class="dt">Config</span> <span class="fu">data</span></span>
<span id="cb2-12"><a href="#cb2-12"></a>    <span class="op">,</span> <span class="fu">dots</span> : <span class="dt">Dots</span><span class="op">.</span><span class="dt">Config</span> <span class="fu">data</span></span>
<span id="cb2-13"><a href="#cb2-13"></a>    <span class="op">,</span> <span class="fu">junk</span> : <span class="dt">Junk</span><span class="op">.</span><span class="dt">Config</span> <span class="fu">data</span> <span class="fu">msg</span></span>
<span id="cb2-14"><a href="#cb2-14"></a>    }</span></code></pre></div>
<p>それぞれサブモジュールの設定をしている(例えば <code>container</code> フィールドは <code>LineChart.Container</code> モジュール):</p>
<ul>
<li><code>x</code>,<code>y</code> はX軸とY軸の設定</li>
<li><code>container</code> はグラフを描写する外枠の設定(たぶん)</li>
<li><code>intersection</code> は両軸の交点の設定(真ん中にするとか左下にするとか)</li>
<li><code>interpolation</code> は点と点を結ぶ線の引き方を設定(直線か曲線かなど)</li>
<li><code>legends</code> はグラフの凡例のを設定(どの線が何のグラフかなど)</li>
<li><code>events</code> はグラフ上でのイベント(<code>Msg</code>)を設定(クリックとかマウスホバーとか)</li>
<li><code>area</code> は線の下の部分の描写の仕方を設定
<ul>
<li><code>default</code> だと何も描写しないのでただの線グラフになる</li>
<li><code>normal</code> だと同じ色で塗りつぶしてくれる(引数は <code>opacity</code>)</li>
</ul></li>
<li><code>grid</code> はグラフのグリッドを設定(そのまんま)</li>
<li><code>line</code> は線の幅やホバーした時の動作を設定</li>
<li><code>dots</code> は点の大きさやホバーした時の動作を設定</li>
<li><code>junk</code> は点や線にホバーした時にモーダル(?)かなんかを表示する設定(たぶん)</li>
</ul>
<p>今回は基本的にサンプルコードのまんまで，軸や <code>junk</code> の設定を少しだけいじった．</p>
<h3 id="プロットデータを用意する">プロットデータを用意する</h3>
<p>2引数目の <code>Series data</code> はプロットしたいデータ型(<code>data</code>)に描写するための情報を付与したデータ型だ． 次の関数などで変換する:</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode elm"><code class="sourceCode elm"><span id="cb3-1"><a href="#cb3-1"></a><span class="fu">line</span> : <span class="dt">Color</span> <span class="op">-&gt;</span> <span class="dt">Shape</span> <span class="op">-&gt;</span> <span class="dt">String</span> <span class="op">-&gt;</span> <span class="dt">List</span> <span class="fu">data</span> <span class="op">-&gt;</span> <span class="dt">Series</span> <span class="fu">data</span></span>
<span id="cb3-2"><a href="#cb3-2"></a><span class="fu">dash</span> : <span class="dt">Color</span> <span class="op">-&gt;</span> <span class="dt">Shape</span> <span class="op">-&gt;</span> <span class="dt">String</span> <span class="op">-&gt;</span> <span class="dt">List</span> <span class="dt">Float</span> <span class="op">-&gt;</span> <span class="dt">List</span> <span class="fu">data</span> <span class="op">-&gt;</span> <span class="dt">Series</span> <span class="fu">data</span></span></code></pre></div>
<p><code>line</code> は直線で <code>dash</code> はたぶん破線． <code>Color</code> は色を，<code>Shape</code> は <code>LineChart.Dots</code> にある関数で点の形を，<code>String</code> は線の凡例名を与える． で，実際のプロットデータは <code>List data</code> だ． <code>data</code> から何をX軸にして，何をY軸にするかは <code>Config</code> の <code>x</code>・<code>y</code> で指定する(<code>variable</code>)．</p>
<p>今回は，各チームのスコアデータの時間毎での遷移を描写したいので，X軸に正解時間をY軸に総ポイントを割り当てる． そのためのデータ型を用意した:</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode elm"><code class="sourceCode elm"><span id="cb4-1"><a href="#cb4-1"></a><span class="kw">type</span> <span class="kw">alias</span> <span class="dt">ScoreHistory</span> <span class="op">=</span></span>
<span id="cb4-2"><a href="#cb4-2"></a>    { <span class="fu">point</span> : <span class="dt">Int</span>                <span class="co">-- 総ポイント</span></span>
<span id="cb4-3"><a href="#cb4-3"></a>    <span class="op">,</span> <span class="fu">latest</span> : <span class="dt">Maybe</span> <span class="dt">API</span><span class="op">.</span><span class="dt">Status</span>  <span class="co">-- 最後にクリアステータス</span></span>
<span id="cb4-4"><a href="#cb4-4"></a>    }</span>
<span id="cb4-5"><a href="#cb4-5"></a></span>
<span id="cb4-6"><a href="#cb4-6"></a><span class="kw">type</span> <span class="kw">alias</span> <span class="dt">Status</span> <span class="op">=</span></span>
<span id="cb4-7"><a href="#cb4-7"></a>    { <span class="fu">problem_id</span> : <span class="dt">Int</span></span>
<span id="cb4-8"><a href="#cb4-8"></a>    <span class="op">,</span> <span class="fu">correct</span> : <span class="dt">Bool</span>           <span class="co">-- クリアしてると True</span></span>
<span id="cb4-9"><a href="#cb4-9"></a>    <span class="op">,</span> <span class="fu">corrected_at</span> : <span class="dt">Maybe</span> <span class="dt">Int</span> <span class="co">-- まだクリアしてないと Nothing</span></span>
<span id="cb4-10"><a href="#cb4-10"></a>    }</span></code></pre></div>
<p><code>Status</code> はもともとある型で，サーバーサイドからスコア(<code>Score</code>)を取得する際に用いる． このサーバーからのスコアから <code>Series ScoreHistory</code> を構築する関数を用意した:</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode elm"><code class="sourceCode elm"><span id="cb5-1"><a href="#cb5-1"></a><span class="kw">type</span> <span class="kw">alias</span> <span class="dt">Score</span> <span class="op">=</span></span>
<span id="cb5-2"><a href="#cb5-2"></a>    { <span class="fu">team</span> : <span class="dt">String</span></span>
<span id="cb5-3"><a href="#cb5-3"></a>    <span class="op">,</span> <span class="fu">point</span> : <span class="dt">Int</span></span>
<span id="cb5-4"><a href="#cb5-4"></a>    <span class="op">,</span> <span class="fu">stats</span> : <span class="dt">List</span> <span class="dt">Status</span></span>
<span id="cb5-5"><a href="#cb5-5"></a>    }</span>
<span id="cb5-6"><a href="#cb5-6"></a></span>
<span id="cb5-7"><a href="#cb5-7"></a><span class="fu">buildScoreHistories</span> : <span class="dt">Model</span> <span class="op">-&gt;</span> <span class="dt">Color</span> <span class="op">-&gt;</span> <span class="dt">API</span><span class="op">.</span><span class="dt">Score</span> <span class="op">-&gt;</span> <span class="dt">LineChart</span><span class="op">.</span><span class="dt">Series</span> <span class="dt">ScoreHistory</span></span>
<span id="cb5-8"><a href="#cb5-8"></a><span class="fu">buildScoreHistories</span> <span class="fu">model</span> <span class="fu">color</span> <span class="fu">score</span> <span class="op">=</span></span>
<span id="cb5-9"><a href="#cb5-9"></a>    <span class="fu">score</span><span class="op">.</span><span class="fu">stats</span></span>
<span id="cb5-10"><a href="#cb5-10"></a>        <span class="op">|&gt;</span> <span class="dt">List</span><span class="op">.</span><span class="fu">filter</span> <span class="op">.</span><span class="fu">correct</span></span>
<span id="cb5-11"><a href="#cb5-11"></a>        <span class="op">|&gt;</span> <span class="dt">List</span><span class="op">.</span><span class="fu">sortBy</span> (<span class="dt">Maybe</span><span class="op">.</span><span class="fu">withDefault</span> <span class="dv">0</span> <span class="op">&lt;&lt;</span> <span class="op">.</span><span class="fu">corrected_at</span>)</span>
<span id="cb5-12"><a href="#cb5-12"></a>        <span class="op">|&gt;</span> <span class="dt">List</span><span class="op">.</span><span class="fu">scanl</span> (<span class="op">::</span>) []</span>
<span id="cb5-13"><a href="#cb5-13"></a>        <span class="op">|&gt;</span> <span class="dt">List</span><span class="op">.</span><span class="fu">map</span> (<span class="fu">buildScoreHistory</span> <span class="fu">model</span>)</span>
<span id="cb5-14"><a href="#cb5-14"></a>        <span class="op">|&gt;</span> <span class="dt">LineChart</span><span class="op">.</span><span class="fu">line</span> <span class="fu">color</span> <span class="dt">Dots</span><span class="op">.</span><span class="fu">circle</span> <span class="fu">score</span><span class="op">.</span><span class="fu">team</span></span>
<span id="cb5-15"><a href="#cb5-15"></a></span>
<span id="cb5-16"><a href="#cb5-16"></a><span class="fu">buildScoreHistory</span> : <span class="dt">Model</span> <span class="op">-&gt;</span> <span class="dt">List</span> <span class="dt">API</span><span class="op">.</span><span class="dt">Status</span> <span class="op">-&gt;</span> <span class="dt">ScoreHistory</span></span>
<span id="cb5-17"><a href="#cb5-17"></a><span class="fu">buildScoreHistory</span> <span class="fu">model</span> <span class="fu">stats</span> <span class="op">=</span></span>
<span id="cb5-18"><a href="#cb5-18"></a>    { <span class="fu">point</span> <span class="op">=</span> <span class="dt">List</span><span class="op">.</span><span class="fu">sum</span> (<span class="dt">List</span><span class="op">.</span><span class="fu">map</span> (<span class="fu">findProblemPoint</span> <span class="fu">model</span>) <span class="fu">stats</span>)</span>
<span id="cb5-19"><a href="#cb5-19"></a>    <span class="op">,</span> <span class="fu">latest</span> <span class="op">=</span> <span class="dt">List</span><span class="op">.</span><span class="fu">head</span> <span class="fu">stats</span></span>
<span id="cb5-20"><a href="#cb5-20"></a>    }</span>
<span id="cb5-21"><a href="#cb5-21"></a></span>
<span id="cb5-22"><a href="#cb5-22"></a><span class="co">-- どの問題が何点かは `Model.problems` にしか書いてない</span></span>
<span id="cb5-23"><a href="#cb5-23"></a><span class="fu">findProblemPoint</span> : <span class="dt">Model</span> <span class="op">-&gt;</span> <span class="dt">API</span><span class="op">.</span><span class="dt">Status</span> <span class="op">-&gt;</span> <span class="dt">Int</span></span>
<span id="cb5-24"><a href="#cb5-24"></a><span class="fu">findProblemPoint</span> <span class="fu">model</span> <span class="fu">status</span> <span class="op">=</span></span>
<span id="cb5-25"><a href="#cb5-25"></a>    <span class="fu">model</span><span class="op">.</span><span class="fu">problems</span></span>
<span id="cb5-26"><a href="#cb5-26"></a>        <span class="op">|&gt;</span> <span class="dt">List</span><span class="op">.</span><span class="fu">find</span> (\<span class="fu">p</span> <span class="op">-&gt;</span> <span class="fu">p</span><span class="op">.</span><span class="fu">id</span> <span class="op">==</span> <span class="fu">status</span><span class="op">.</span><span class="fu">problem_id</span>)</span>
<span id="cb5-27"><a href="#cb5-27"></a>        <span class="op">|&gt;</span> <span class="dt">Maybe</span><span class="op">.</span><span class="fu">map</span> <span class="op">.</span><span class="fu">difficulty</span></span>
<span id="cb5-28"><a href="#cb5-28"></a>        <span class="op">|&gt;</span> <span class="dt">Maybe</span><span class="op">.</span><span class="fu">withDefault</span> <span class="dv">0</span></span></code></pre></div>
<p><code>scanl</code> で綺麗になってるのが気持ちいい． また，<code>variable</code> は次のように設定した:</p>
<div class="sourceCode" id="cb6"><pre class="sourceCode elm"><code class="sourceCode elm"><span id="cb6-1"><a href="#cb6-1"></a><span class="fu">chart</span> : <span class="dt">Model</span> <span class="op">-&gt;</span> <span class="dt">Html</span><span class="op">.</span><span class="dt">Html</span> <span class="dt">Msg</span></span>
<span id="cb6-2"><a href="#cb6-2"></a><span class="fu">chart</span> <span class="fu">model</span> <span class="op">=</span></span>
<span id="cb6-3"><a href="#cb6-3"></a>    <span class="dt">LineChart</span><span class="op">.</span><span class="fu">viewCustom</span></span>
<span id="cb6-4"><a href="#cb6-4"></a>        { <span class="fu">y</span> <span class="op">=</span></span>
<span id="cb6-5"><a href="#cb6-5"></a>            <span class="dt">Axis</span><span class="op">.</span><span class="fu">custom</span></span>
<span id="cb6-6"><a href="#cb6-6"></a>                { <span class="fu">title</span> <span class="op">=</span> <span class="dt">Title</span><span class="op">.</span><span class="fu">default</span> <span class="st">&quot;Point&quot;</span></span>
<span id="cb6-7"><a href="#cb6-7"></a>                <span class="op">,</span> <span class="fu">variable</span> <span class="op">=</span> <span class="dt">Just</span> <span class="op">&lt;&lt;</span> <span class="fu">toFloat</span> <span class="op">&lt;&lt;</span> <span class="op">.</span><span class="fu">point</span></span>
<span id="cb6-8"><a href="#cb6-8"></a>                <span class="op">,</span> <span class="fu">pixels</span> <span class="op">=</span> <span class="dv">380</span></span>
<span id="cb6-9"><a href="#cb6-9"></a>                <span class="op">,</span> <span class="fu">range</span> <span class="op">=</span> <span class="dt">Range</span><span class="op">.</span><span class="fu">padded</span> <span class="dv">20</span> <span class="dv">20</span></span>
<span id="cb6-10"><a href="#cb6-10"></a>                <span class="op">,</span> <span class="fu">axisLine</span> <span class="op">=</span> <span class="dt">AxisLine</span><span class="op">.</span><span class="fu">full</span> <span class="dt">Colors</span><span class="op">.</span><span class="fu">gray</span></span>
<span id="cb6-11"><a href="#cb6-11"></a>                <span class="op">,</span> <span class="fu">ticks</span> <span class="op">=</span> <span class="dt">Ticks</span><span class="op">.</span><span class="fu">float</span> <span class="dv">5</span> <span class="co">-- これは軸に表示する数字の間隔</span></span>
<span id="cb6-12"><a href="#cb6-12"></a>                }</span>
<span id="cb6-13"><a href="#cb6-13"></a>        <span class="op">,</span> <span class="fu">x</span> <span class="op">=</span></span>
<span id="cb6-14"><a href="#cb6-14"></a>            <span class="dt">Axis</span><span class="op">.</span><span class="fu">custom</span></span>
<span id="cb6-15"><a href="#cb6-15"></a>                { <span class="fu">title</span> <span class="op">=</span> <span class="dt">Title</span><span class="op">.</span><span class="fu">default</span> <span class="st">&quot;Time&quot;</span></span>
<span id="cb6-16"><a href="#cb6-16"></a>                <span class="op">,</span> <span class="fu">variable</span> <span class="op">=</span></span>
<span id="cb6-17"><a href="#cb6-17"></a>                    <span class="dt">Maybe</span><span class="op">.</span><span class="fu">map</span> <span class="fu">toFloat</span></span>
<span id="cb6-18"><a href="#cb6-18"></a>                      <span class="op">&lt;&lt;</span> <span class="dt">Maybe</span><span class="op">.</span><span class="fu">map</span> (\<span class="fu">n</span> <span class="op">-&gt;</span> <span class="fu">n</span> <span class="op">*</span> <span class="dv">1000</span>) <span class="co">-- 確かデフォルト millisec</span></span>
<span id="cb6-19"><a href="#cb6-19"></a>                      <span class="op">&lt;&lt;</span> <span class="dt">Maybe</span><span class="op">.</span><span class="fu">andThen</span> <span class="op">.</span><span class="fu">corrected_at</span></span>
<span id="cb6-20"><a href="#cb6-20"></a>                      <span class="op">&lt;&lt;</span> <span class="op">.</span><span class="fu">latest</span></span>
<span id="cb6-21"><a href="#cb6-21"></a>                <span class="op">,</span> <span class="fu">pixels</span> <span class="op">=</span> <span class="dv">1270</span></span>
<span id="cb6-22"><a href="#cb6-22"></a>                <span class="op">,</span> <span class="fu">range</span> <span class="op">=</span> <span class="dt">Range</span><span class="op">.</span><span class="fu">padded</span> <span class="dv">20</span> <span class="dv">20</span></span>
<span id="cb6-23"><a href="#cb6-23"></a>                <span class="op">,</span> <span class="fu">axisLine</span> <span class="op">=</span> <span class="dt">AxisLine</span><span class="op">.</span><span class="fu">full</span> <span class="dt">Colors</span><span class="op">.</span><span class="fu">gray</span></span>
<span id="cb6-24"><a href="#cb6-24"></a>                <span class="op">,</span> <span class="fu">ticks</span> <span class="op">=</span> <span class="dt">Ticks</span><span class="op">.</span><span class="fu">time</span> <span class="fu">model</span><span class="op">.</span><span class="fu">zone</span> <span class="dv">10</span></span>
<span id="cb6-25"><a href="#cb6-25"></a>                }</span>
<span id="cb6-26"><a href="#cb6-26"></a>        <span class="op">...</span></span>
<span id="cb6-27"><a href="#cb6-27"></a>        }</span></code></pre></div>
<p>さて，ここまではいい感じにできた． 問題は <code>buildScoreHistories</code> の <code>Color</code> にどうやってチームごとに違う色を渡すか． <code>LineChart.Colors</code> には事前に色が用意されていたが全部で22色ぐらいしかない． できればチーム数に応じて可変にしたい．</p>
<h2 id="color-を付け変える">Color を付け変える</h2>
<p>グラフ描写に使うグラフの色はチーム数によって可変にしたい． 色を任意個数だけ生成する方法はないか調べてみたところ，<a href="https://package.elm-lang.org/packages/tesk9/palette"><code>tesk9/palette</code></a> の <code>Palette.Cubehelix.generate</code> を使えば実現できそうだ:</p>
<div class="sourceCode" id="cb7"><pre class="sourceCode elm"><code class="sourceCode elm"><span id="cb7-1"><a href="#cb7-1"></a><span class="op">#</span> ただし <span class="dv">0</span><span class="op">-</span><span class="dv">256</span> の間だけ有効</span>
<span id="cb7-2"><a href="#cb7-2"></a><span class="fu">generate</span> : <span class="dt">Int</span> <span class="op">-&gt;</span> <span class="dt">List</span> <span class="dt">Color</span></span></code></pre></div>
<p>ここで問題が一つ． line-charts は別の <code>Color</code> パッケージに依存しており，<code>Color</code> モジュールが衝突して使うことができない！</p>
<p>困った． とりあえず，フォークして差し替えるしかない． 差し替えたものがコチラ:</p>
<ul>
<li><a href="https://github.com/matsubara0507/line-charts/tree/color-palette">matsubara0507/line-charts at color-palette</a></li>
</ul>
<p>Elm のビルドツールにはパッケージをいい感じにフォーク先などに変更する方法がない． ざっくり調べてみたところ，フォークしたもの elm-packages にあげて使うか，プロジェクト内にフォークしたリポジトリを直接置いて参照するか． Elm-jp でも相談してみたところ，後者の方が良さそうなのでそうすることにした．</p>
<h3 id="elm-のパッケージをフォークしたのにa差し替える">Elm のパッケージをフォークしたのにa差し替える</h3>
<p>まずは普通に <code>git submodule</code> をします:</p>
<pre><code>$ mkdir elm-lib
$ git submodule add git@github.com:matsubara0507/line-charts.git elm-lib/line-charts
$ elm-lib/line-charts
$ git checkout color-palette</code></pre>
<p>そしてこのディレクトリも見るように <code>elm.json</code> を書き換えます:</p>
<div class="sourceCode" id="cb9"><pre class="sourceCode diff"><code class="sourceCode diff"><span id="cb9-1"><a href="#cb9-1"></a><span class="dt">@@ -1,30 +1,40 @@</span></span>
<span id="cb9-2"><a href="#cb9-2"></a>  {</span>
<span id="cb9-3"><a href="#cb9-3"></a>      &quot;type&quot;: &quot;application&quot;,</span>
<span id="cb9-4"><a href="#cb9-4"></a>      &quot;source-directories&quot;: [</span>
<span id="cb9-5"><a href="#cb9-5"></a><span class="st">-         &quot;elm-src&quot;</span></span>
<span id="cb9-6"><a href="#cb9-6"></a><span class="va">+         &quot;elm-src&quot;,</span></span>
<span id="cb9-7"><a href="#cb9-7"></a><span class="va">+         &quot;elm-lib/line-charts/src&quot;</span></span>
<span id="cb9-8"><a href="#cb9-8"></a>      ],</span></code></pre></div>
<p>そして，適当に <code>import LineChart</code> を追記して <code>elm make</code> するとどうなるでしょうか？ 残念ながらうまくいきません:</p>
<pre><code>$ elm make elm-src/Main.elm --output=static/main.js
-- UNKNOWN IMPORT -------- elm-lib/line-charts/src/Internal/Axis/Values/Time.elm

The Internal.Axis.Values.Time module has a bad import:

    import Time.Extra

I cannot find that module! Is there a typo in the module name?

The &quot;source-directories&quot; field of your elm.json tells me to look in directories
like elm-src, but it is not in any of them. Maybe it is in a package that is not
installed yet?</code></pre>
<p><code>Time.Extra</code> は line-charts が依存しているパッケージで，それが <code>elm.json</code> に書かれてないというエラーメッセージです． サブモジュール側の依存パッケージは自動で解決してくれない(単純にローカルのソースコードが増えてるだけなので，そりゃそうって感じだ)． なので，自分で書き足す必要がある:</p>
<div class="sourceCode" id="cb11"><pre class="sourceCode diff"><code class="sourceCode diff"><span id="cb11-1"><a href="#cb11-1"></a><span class="kw">diff --git a/elm.json b/elm.json</span></span>
<span id="cb11-2"><a href="#cb11-2"></a>index 30d0662..7c32604 100644</span>
<span id="cb11-3"><a href="#cb11-3"></a><span class="dt">--- a/elm.json</span></span>
<span id="cb11-4"><a href="#cb11-4"></a><span class="dt">+++ b/elm.json</span></span>
<span id="cb11-5"><a href="#cb11-5"></a><span class="dt">@@ -1,36 +1,36 @@</span></span>
<span id="cb11-6"><a href="#cb11-6"></a>     &quot;dependencies&quot;: {</span>
<span id="cb11-7"><a href="#cb11-7"></a>         &quot;direct&quot;: {</span>
<span id="cb11-8"><a href="#cb11-8"></a>             &quot;avh4/elm-color&quot;: &quot;1.0.0&quot;,</span>
<span id="cb11-9"><a href="#cb11-9"></a>             &quot;bartavelle/json-helpers&quot;: &quot;2.0.2&quot;,</span>
<span id="cb11-10"><a href="#cb11-10"></a><span class="va">+            &quot;debois/elm-dom&quot;: &quot;1.3.0&quot;,</span></span>
<span id="cb11-11"><a href="#cb11-11"></a>             &quot;elm/browser&quot;: &quot;1.0.1&quot;,</span>
<span id="cb11-12"><a href="#cb11-12"></a>             &quot;elm/core&quot;: &quot;1.0.2&quot;,</span>
<span id="cb11-13"><a href="#cb11-13"></a>             &quot;elm/html&quot;: &quot;1.0.0&quot;,</span>
<span id="cb11-14"><a href="#cb11-14"></a>             &quot;elm/http&quot;: &quot;2.0.0&quot;,</span>
<span id="cb11-15"><a href="#cb11-15"></a>             &quot;elm/json&quot;: &quot;1.1.3&quot;,</span>
<span id="cb11-16"><a href="#cb11-16"></a><span class="va">+            &quot;elm/svg&quot;: &quot;1.0.1&quot;,</span></span>
<span id="cb11-17"><a href="#cb11-17"></a>             &quot;elm/time&quot;: &quot;1.0.0&quot;,</span>
<span id="cb11-18"><a href="#cb11-18"></a>             &quot;elm/url&quot;: &quot;1.0.0&quot;,</span>
<span id="cb11-19"><a href="#cb11-19"></a>             &quot;elm-community/list-extra&quot;: &quot;8.2.2&quot;,</span>
<span id="cb11-20"><a href="#cb11-20"></a><span class="va">+            &quot;justinmimbs/time-extra&quot;: &quot;1.1.0&quot;,</span></span>
<span id="cb11-21"><a href="#cb11-21"></a>             &quot;justinmimbs/timezone-data&quot;: &quot;2.1.4&quot;,</span>
<span id="cb11-22"><a href="#cb11-22"></a>             &quot;krisajenkins/remotedata&quot;: &quot;6.0.1&quot;,</span>
<span id="cb11-23"><a href="#cb11-23"></a><span class="st">-            &quot;terezka/line-charts&quot;: &quot;2.0.0&quot;</span></span>
<span id="cb11-24"><a href="#cb11-24"></a><span class="va">+            &quot;myrho/elm-round&quot;: &quot;1.0.4&quot;,</span></span>
<span id="cb11-25"><a href="#cb11-25"></a><span class="va">+            &quot;ryannhg/date-format&quot;: &quot;2.3.0&quot;</span></span>
<span id="cb11-26"><a href="#cb11-26"></a>         },</span>
<span id="cb11-27"><a href="#cb11-27"></a>         &quot;indirect&quot;: {</span>
<span id="cb11-28"><a href="#cb11-28"></a><span class="st">-            &quot;debois/elm-dom&quot;: &quot;1.3.0&quot;,</span></span>
<span id="cb11-29"><a href="#cb11-29"></a>             &quot;elm/bytes&quot;: &quot;1.0.8&quot;,</span>
<span id="cb11-30"><a href="#cb11-30"></a>             &quot;elm/file&quot;: &quot;1.0.5&quot;,</span>
<span id="cb11-31"><a href="#cb11-31"></a>             &quot;elm/parser&quot;: &quot;1.1.0&quot;,</span>
<span id="cb11-32"><a href="#cb11-32"></a><span class="st">-            &quot;elm/svg&quot;: &quot;1.0.1&quot;,</span></span>
<span id="cb11-33"><a href="#cb11-33"></a>             &quot;elm/virtual-dom&quot;: &quot;1.0.0&quot;,</span>
<span id="cb11-34"><a href="#cb11-34"></a><span class="st">-            &quot;justinmimbs/date&quot;: &quot;3.2.0&quot;,</span></span>
<span id="cb11-35"><a href="#cb11-35"></a><span class="st">-            &quot;justinmimbs/time-extra&quot;: &quot;1.1.0&quot;,</span></span>
<span id="cb11-36"><a href="#cb11-36"></a><span class="st">-            &quot;myrho/elm-round&quot;: &quot;1.0.4&quot;,</span></span>
<span id="cb11-37"><a href="#cb11-37"></a><span class="st">-            &quot;ryannhg/date-format&quot;: &quot;2.3.0&quot;</span></span>
<span id="cb11-38"><a href="#cb11-38"></a><span class="va">+            &quot;justinmimbs/date&quot;: &quot;3.2.0&quot;</span></span>
<span id="cb11-39"><a href="#cb11-39"></a>         }</span>
<span id="cb11-40"><a href="#cb11-40"></a>     },</span>
<span id="cb11-41"><a href="#cb11-41"></a>     &quot;test-dependencies&quot;: {</span></code></pre></div>
<p>これで無事 <code>elm make</code> をすることができるようになった．</p>
<h3 id="palette.cubehelix-を使ってみる"><code>Palette.Cubehelix</code> を使ってみる</h3>
<p>いよいよ <code>Palette.Cubehelix</code> を使ってみる． そもそも Cubehelix とはなんなのか．</p>
<p><a href="http://www.mrao.cam.ac.uk/~dag/CUBEHELIX/">ググった感じこれっぽい</a>． 宇宙を撮影した画像を描写するときのためのカラースキーマーっぽい(なにが課題なのかはよくわからなんだw)． <code>Palette.Cubehelix.generate :: Int -&gt; List Color</code> を使うことで最大で256色を返してくれる． 更にどんな感じの色を返してくれるかは <code>generateAdvanced</code> の方を使い，<code>AdvancedConfig</code> 型の値を自作することでコントロールできる:</p>
<div class="sourceCode" id="cb12"><pre class="sourceCode elm"><code class="sourceCode elm"><span id="cb12-1"><a href="#cb12-1"></a><span class="kw">type</span> <span class="kw">alias</span> <span class="dt">AdvancedConfig</span> <span class="op">=</span></span>
<span id="cb12-2"><a href="#cb12-2"></a>    { <span class="fu">start</span> : <span class="dt">Color</span></span>
<span id="cb12-3"><a href="#cb12-3"></a>    <span class="op">,</span> <span class="fu">rotationDirection</span> : <span class="dt">RotationDirection</span></span>
<span id="cb12-4"><a href="#cb12-4"></a>    <span class="op">,</span> <span class="fu">rotations</span> : <span class="dt">Float</span></span>
<span id="cb12-5"><a href="#cb12-5"></a>    <span class="op">,</span> <span class="fu">gamma</span> : <span class="dt">Float</span></span>
<span id="cb12-6"><a href="#cb12-6"></a>    }</span></code></pre></div>
<p>色々試したところ各引数はこんな感じだった:</p>
<ul>
<li><code>start</code> は HSL の Hue + Saturation を元に起点を決める</li>
<li><code>rotationDirection</code> は回転方向 (RGB or BGR)</li>
<li><code>rotation</code> は回転角を 0-1.5 で指定（小さいほど似た色になる）</li>
<li><code>gamma</code> は明暗な色のバランスを 0-2 で指定（0は明るい、2は暗い色が長くなる）</li>
</ul>
<p>HSLとは RGB とは違う色の表現のし方で，色相（Hue）・彩度（Saturation）・輝度（Lightness）を指定する． 直感的なイメートして，黒から白へこうぐるっと指定した螺旋でカラーパレットを表現する感じ．</p>
<p>物は試し，repl で色々と試すと良い(色だけに):</p>
<div class="sourceCode" id="cb13"><pre class="sourceCode elm"><code class="sourceCode elm"><span id="cb13-1"><a href="#cb13-1"></a><span class="op">&gt;</span> <span class="dt">List</span><span class="op">.</span><span class="fu">map</span> <span class="dt">Color</span><span class="op">.</span><span class="fu">toHex</span> <span class="op">&lt;|</span> <span class="dt">Palette</span><span class="op">.</span><span class="fu">generateAdvanced</span> <span class="dv">10</span> { <span class="fu">start</span> <span class="op">=</span> <span class="dt">Color</span><span class="op">.</span><span class="fu">fromHSL</span> (<span class="op">-</span><span class="dv">60</span><span class="op">,</span><span class="dv">100</span><span class="op">,</span><span class="dv">0</span>)<span class="op">,</span> <span class="fu">rotationDirection</span> <span class="op">=</span> <span class="dt">Palette</span><span class="op">.</span><span class="dt">RGB</span><span class="op">,</span> <span class="fu">rotations</span> <span class="op">=</span> <span class="dv">1</span><span class="op">.</span><span class="dv">5</span><span class="op">,</span> <span class="fu">gamma</span> <span class="op">=</span> <span class="dv">1</span><span class="op">.</span><span class="dv">0</span> }</span>
<span id="cb13-2"><a href="#cb13-2"></a>[<span class="st">&quot;#000000&quot;</span><span class="op">,</span><span class="st">&quot;#311410&quot;</span><span class="op">,</span><span class="st">&quot;#3C3F0D&quot;</span><span class="op">,</span><span class="st">&quot;#2B6F39&quot;</span><span class="op">,</span><span class="st">&quot;#3E8590&quot;</span><span class="op">,</span><span class="st">&quot;#8984CC&quot;</span><span class="op">,</span><span class="st">&quot;#D490C6&quot;</span><span class="op">,</span><span class="st">&quot;#EAB8B1&quot;</span><span class="op">,</span><span class="st">&quot;#E5E6CA&quot;</span><span class="op">,</span><span class="st">&quot;#FFFFFF&quot;</span>]</span>
<span id="cb13-3"><a href="#cb13-3"></a>   : <span class="dt">List</span> <span class="dt">String</span></span></code></pre></div>
<p>なんとこれを Slack に貼ると色を確認できる(賢い)． で，最終的には最初と最後の黒白を抜いて適当に使った．</p>
<h2 id="おしまい">おしまい</h2>
<p>submodule のやつしんどいし，なんか自動で <code>elm.json</code> を書き換えてくれる CLI ツールでも作ろうかしら．</p>
  </div>

  <footer class="post-footer">
    <a href="https://twitter.com/share?ref_src=twsrc%5Etfw" class="twitter-share-button" data-show-count="false">Tweet</a>
    <script async src="https://platform.twitter.com/widgets.js" charset="utf-8"></script>
  </footer>
</div>
</article>

          </div>
        </div>

        <footer class="site-footer">

  <div class="wrapper">

    <span class="footer-heading">ひげメモ</span>

  </div>

  <div class="page-content card" style="display: flex; justify-content: center; padding: 5px 0px">
    <a href="https://haskell.jp/blog/posts/links.html#matsubara0507.github.io">
      <img width="234" src="https://haskell.jp/img/supported-by-haskell-jp.svg" alt="Supported By Haskell-jp.">
    </a>
  </div>

</footer>


      </div>
  </body>

</html>
