<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE html>
<html lang="ja">

  <head>
  <meta charset="utf-8">
  <link rel="icon" href="../assets/icon.jpg">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
    
      <meta property="og:title" content="Elixir による JSON Parser" />
    
  

  <meta property="og:site_name" content="ひげメモ" />

  

  
    <script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-86386380-1', 'auto');
  ga('send', 'pageview');
</script>

  

  <title>
    
      
        Elixir による JSON Parser
      
    
  </title>

  <link rel="stylesheet" href="../css/main.css">
  <link rel="stylesheet" href="../css/highlight.css">
  <link rel="stylesheet" type="text/css" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.4.0/css/font-awesome.min.css" />
</head>


  <body>
      <div class="outer">

        <header class="site-header">

  <div class="wrapper">

    <a class="site-title" href="https://matsubara0507.github.io/">ひげメモ</a>

  </div>

  <div class="header-badge">
    <a href="https://matsubara0507.github.io/">
        <img src="../assets/icon.jpg" />
    </a>
  </div>

</header>


        <div class="page-content">
          <div class="wrapper">
            <article class="post card" itemscope itemtype="http://schema.org/BlogPosting">
 <div class="card-content">
  <header class="post-header">
    <h1 class="post-title" itemprop="name headline">Elixir による JSON Parser</h1>
    <p class="post-meta">
      <time datetime="2019-12-22" itemprop="datePublished">
        Dec 22, 2019
      </time>
      
      
      <div class="tags">
          <i class="fa fa-tags"></i> <a href="../tags/Elixir.html">Elixir</a>
      </div>
      
    </p>
  </header>

  <div class="post-content" itemprop="articleBody">
    <p>「<a href="https://matsubara0507.github.io/posts/2019-12-08-re-create-thank-you-stars-ver-elixir.html">久しぶりに thank_you_stars をビルドする</a>」の続きというかおまけというかって感じの記事です． この記事の最後で poison を抜いてお手製 JSON パーサーを組み込みました． 綺麗に整えたので記事にまとめる．</p>
<h2 id="実装する">実装する</h2>
<p>外部パッケージを使えない縛りなので，完全な Pure Elixir で実装していく．</p>
<h3 id="result-型">Result 型</h3>
<p>その前に便利モジュールを作っておく． いわゆる <code>Either</code> 型だ．</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode elixir"><code class="sourceCode elixir"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true"></a><span class="co"># Result e a = {:error, e} | {:ok, a} のような型を扱う</span></span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true"></a><span class="kw">defmodule</span> <span class="cn">ThankYouStars</span><span class="op">.</span><span class="cn">Result</span> <span class="kw">do</span></span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true"></a>  <span class="co"># {:ok, a}, {:error, e} をそのまま返す</span></span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true"></a>  <span class="kw">def</span> success(v), <span class="kw">do</span>: {<span class="va">:ok</span>, v}</span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true"></a>  <span class="kw">def</span> failure(v), <span class="kw">do</span>: {<span class="va">:error</span>, v}</span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true"></a></span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true"></a>  <span class="co"># {:ok, a} だった場合に {:ok, f(a)} を返す (f は a -&gt; b)</span></span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true"></a>  <span class="kw">def</span> map({<span class="va">:ok</span>, v}, f), <span class="kw">do</span>: success(f<span class="op">.</span>(v))</span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true"></a>  <span class="kw">def</span> map(err <span class="op">=</span> {<span class="va">:error</span>, _}, _), <span class="kw">do</span>: err</span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true"></a></span>
<span id="cb1-11"><a href="#cb1-11" aria-hidden="true"></a>  <span class="co"># {:ok, a} だった場合に f(a) を返す (f は a -&gt; Result e b)</span></span>
<span id="cb1-12"><a href="#cb1-12" aria-hidden="true"></a>  <span class="kw">def</span> and_then({<span class="va">:ok</span>, v}, f), <span class="kw">do</span>: f<span class="op">.</span>(v)</span>
<span id="cb1-13"><a href="#cb1-13" aria-hidden="true"></a>  <span class="kw">def</span> and_then(err <span class="op">=</span> {<span class="va">:error</span>, _}, _), <span class="kw">do</span>: err</span>
<span id="cb1-14"><a href="#cb1-14" aria-hidden="true"></a></span>
<span id="cb1-15"><a href="#cb1-15" aria-hidden="true"></a>  <span class="co"># {:error, e} だった場合に {:error, f(e)} を返す (f は e -&gt; b)</span></span>
<span id="cb1-16"><a href="#cb1-16" aria-hidden="true"></a>  <span class="kw">def</span> map_error({<span class="va">:error</span>, e}, f), <span class="kw">do</span>: failure(f<span class="op">.</span>(e))</span>
<span id="cb1-17"><a href="#cb1-17" aria-hidden="true"></a>  <span class="kw">def</span> map_error(r <span class="op">=</span> {<span class="va">:ok</span>, _}, _), <span class="kw">do</span>: r</span>
<span id="cb1-18"><a href="#cb1-18" aria-hidden="true"></a><span class="kw">end</span></span></code></pre></div>
<p>これを作っておくと <code>{:ok, a} | {:error, e}</code> なデータ型をパイプラインと組み合わせて利用できるようになる(実はプリミティブあったりしないよね？)．</p>
<h3 id="状態のデータ構造">状態のデータ構造</h3>
<p>シンプルにパース結果と残りの文字列を保存する連想配列を持ち回ることにする:</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode elixir"><code class="sourceCode elixir"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true"></a><span class="kw">defmodule</span> <span class="cn">ThankYouStars</span><span class="op">.</span><span class="cn">JSON</span> <span class="kw">do</span></span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true"></a>  <span class="im">alias</span> <span class="cn">ThankYouStars</span><span class="op">.</span><span class="cn">Result</span>, <span class="va">as:</span> <span class="cn">Result</span></span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true"></a></span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true"></a>  <span class="kw">def</span> decode(str) <span class="kw">do</span></span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true"></a>    init_stat(str)</span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true"></a>    <span class="op">|&gt;</span> match_element() <span class="co"># これがパーサー</span></span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true"></a>    <span class="op">|&gt;</span> <span class="kw">case</span> <span class="kw">do</span></span>
<span id="cb2-8"><a href="#cb2-8" aria-hidden="true"></a>      <span class="co"># パースが成功した場合 {:ok} かつ残り文字列が空になる想定</span></span>
<span id="cb2-9"><a href="#cb2-9" aria-hidden="true"></a>      {<span class="va">:ok</span>, %{<span class="va">rest:</span> <span class="st">&quot;&quot;</span>, <span class="va">result:</span> result}} <span class="op">-&gt;</span> <span class="cn">Result</span><span class="op">.</span>success(result)</span>
<span id="cb2-10"><a href="#cb2-10" aria-hidden="true"></a>      {_, %{<span class="va">rest:</span> rest}} <span class="op">-&gt;</span> <span class="cn">Result</span><span class="op">.</span>failure(rest)</span>
<span id="cb2-11"><a href="#cb2-11" aria-hidden="true"></a>    <span class="kw">end</span></span>
<span id="cb2-12"><a href="#cb2-12" aria-hidden="true"></a>  <span class="kw">end</span></span>
<span id="cb2-13"><a href="#cb2-13" aria-hidden="true"></a></span>
<span id="cb2-14"><a href="#cb2-14" aria-hidden="true"></a>  <span class="co"># rest が残り文字列で result がパース結果</span></span>
<span id="cb2-15"><a href="#cb2-15" aria-hidden="true"></a>  <span class="kw">defp</span> init_stat(str), <span class="kw">do</span>: %{<span class="va">rest:</span> str, <span class="va">result:</span> %{}}</span>
<span id="cb2-16"><a href="#cb2-16" aria-hidden="true"></a></span>
<span id="cb2-17"><a href="#cb2-17" aria-hidden="true"></a>  <span class="op">...</span></span>
<span id="cb2-18"><a href="#cb2-18" aria-hidden="true"></a><span class="kw">end</span></span></code></pre></div>
<p>今回実装する JSON パーサーは最終的に Elixir の連想配列や配列，真偽値や文字列などのプリミティブなデータ型へ変換することとする． なので，初期値として空の連想配列 <code>%{}</code> を渡している．</p>
<h3 id="json.org">JSON.org</h3>
<p>JSON の(基本的な)構文定義は <a href="https://json.org">JSON.org</a> に書いてある． ご丁寧に BNF が書いてあるので，これに沿って実装するだけだ． 例えば，こんな感じの BNF が記述されている:</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode txt"><code class="sourceCode default"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true"></a>json</span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true"></a>  := element</span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true"></a></span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true"></a>element</span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true"></a>  := ws value ws</span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true"></a></span>
<span id="cb3-7"><a href="#cb3-7" aria-hidden="true"></a>value</span>
<span id="cb3-8"><a href="#cb3-8" aria-hidden="true"></a>  := object</span>
<span id="cb3-9"><a href="#cb3-9" aria-hidden="true"></a>   | array</span>
<span id="cb3-10"><a href="#cb3-10" aria-hidden="true"></a>   | string</span>
<span id="cb3-11"><a href="#cb3-11" aria-hidden="true"></a>   | number</span>
<span id="cb3-12"><a href="#cb3-12" aria-hidden="true"></a>   | &quot;true&quot;</span>
<span id="cb3-13"><a href="#cb3-13" aria-hidden="true"></a>   | &quot;false&quot;</span>
<span id="cb3-14"><a href="#cb3-14" aria-hidden="true"></a>   | &quot;null&quot;</span>
<span id="cb3-15"><a href="#cb3-15" aria-hidden="true"></a></span>
<span id="cb3-16"><a href="#cb3-16" aria-hidden="true"></a>ws</span>
<span id="cb3-17"><a href="#cb3-17" aria-hidden="true"></a>  := ... // 空白除去</span></code></pre></div>
<p>これをパターンマッチを駆使して実装するとこんな感じ:</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode elixir"><code class="sourceCode elixir"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true"></a><span class="kw">defp</span> match_element(stat) <span class="kw">do</span></span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true"></a>  trim_leading(stat) <span class="co"># rest の前方の空白を除去します</span></span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true"></a>  <span class="op">|&gt;</span> match_value()</span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true"></a>  <span class="op">|&gt;</span> <span class="cn">Result</span><span class="op">.</span>map(<span class="op">&amp;</span>trim_leading(<span class="op">&amp;</span><span class="dv">1</span>))</span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true"></a><span class="kw">end</span></span>
<span id="cb4-6"><a href="#cb4-6" aria-hidden="true"></a></span>
<span id="cb4-7"><a href="#cb4-7" aria-hidden="true"></a><span class="co"># match_string や match_array はあとで</span></span>
<span id="cb4-8"><a href="#cb4-8" aria-hidden="true"></a><span class="kw">defp</span> match_value(%{<span class="va">rest:</span> <span class="st">&quot;true&quot;</span> <span class="op">&lt;&gt;</span> rest}), <span class="kw">do</span>: <span class="cn">Result</span><span class="op">.</span>success(%{<span class="va">result:</span> <span class="cn">true</span>, <span class="va">rest:</span> rest})</span>
<span id="cb4-9"><a href="#cb4-9" aria-hidden="true"></a><span class="kw">defp</span> match_value(%{<span class="va">rest:</span> <span class="st">&quot;false&quot;</span> <span class="op">&lt;&gt;</span> rest}), <span class="kw">do</span>: <span class="cn">Result</span><span class="op">.</span>success(%{<span class="va">result:</span> <span class="cn">false</span>, <span class="va">rest:</span> rest})</span>
<span id="cb4-10"><a href="#cb4-10" aria-hidden="true"></a><span class="kw">defp</span> match_value(%{<span class="va">rest:</span> <span class="st">&quot;null&quot;</span> <span class="op">&lt;&gt;</span> rest}), <span class="kw">do</span>: <span class="cn">Result</span><span class="op">.</span>success(%{<span class="va">result:</span> <span class="cn">nil</span>, <span class="va">rest:</span> rest})</span>
<span id="cb4-11"><a href="#cb4-11" aria-hidden="true"></a><span class="kw">defp</span> match_value(stat <span class="op">=</span> %{<span class="va">rest:</span> <span class="st">&quot;\&quot;&quot;</span> <span class="op">&lt;&gt;</span> _}), <span class="kw">do</span>: match_string(stat)</span>
<span id="cb4-12"><a href="#cb4-12" aria-hidden="true"></a><span class="kw">defp</span> match_value(stat <span class="op">=</span> %{<span class="va">rest:</span> <span class="st">&quot;[&quot;</span> <span class="op">&lt;&gt;</span> _}), <span class="kw">do</span>: match_array(stat)</span>
<span id="cb4-13"><a href="#cb4-13" aria-hidden="true"></a><span class="kw">defp</span> match_value(stat <span class="op">=</span> %{<span class="va">rest:</span> <span class="st">&quot;{&quot;</span> <span class="op">&lt;&gt;</span> _}), <span class="kw">do</span>: match_object(stat)</span>
<span id="cb4-14"><a href="#cb4-14" aria-hidden="true"></a><span class="kw">defp</span> match_value(stat), <span class="kw">do</span>: match_number(stat)</span></code></pre></div>
<p><code>match_xxx</code> 系の関数は全て前述した <code>Result e a</code> 型を返すイメージ(<code>e</code> も <code>a</code> も前述した状態の連想配列だが)．</p>
<h3 id="オブジェクトのパース">オブジェクトのパース</h3>
<p><code>{}</code> で囲まれた連想配列のようなもの，例えば <code>{ "key" : true }</code> がオブジェクトだ:</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode txt"><code class="sourceCode default"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true"></a>object</span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true"></a>  := '{' ws '}'</span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true"></a>   | '{' members '}'</span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true"></a></span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true"></a>members</span>
<span id="cb5-6"><a href="#cb5-6" aria-hidden="true"></a>  := member</span>
<span id="cb5-7"><a href="#cb5-7" aria-hidden="true"></a>   | member ',' members</span>
<span id="cb5-8"><a href="#cb5-8" aria-hidden="true"></a></span>
<span id="cb5-9"><a href="#cb5-9" aria-hidden="true"></a>member</span>
<span id="cb5-10"><a href="#cb5-10" aria-hidden="true"></a>  := ws string ws ':' element</span>
<span id="cb5-11"><a href="#cb5-11" aria-hidden="true"></a></span>
<span id="cb5-12"><a href="#cb5-12" aria-hidden="true"></a>string</span>
<span id="cb5-13"><a href="#cb5-13" aria-hidden="true"></a>  := ... // 文字列</span></code></pre></div>
<p>文字列の部分はあとで実装するとして，他の部分だけをパターンマッチとパイプを利用して実装するとこんな感じ:</p>
<div class="sourceCode" id="cb6"><pre class="sourceCode elixir"><code class="sourceCode elixir"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true"></a><span class="co"># parse_when_unmatch_by(stat, char, parser) は</span></span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true"></a><span class="co"># char の文字列にマッチしなければ parser を実行し</span></span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true"></a><span class="co"># マッチした場合は parser を実行せずに stat をそのまま返す</span></span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true"></a><span class="kw">defp</span> match_object(stat) <span class="kw">do</span></span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true"></a>  match_left_par(stat)                               <span class="co"># `{` にマッチ</span></span>
<span id="cb6-6"><a href="#cb6-6" aria-hidden="true"></a>  <span class="op">|&gt;</span> <span class="cn">Result</span><span class="op">.</span>map(<span class="op">&amp;</span>trim_leading(<span class="op">&amp;</span><span class="dv">1</span>))                   <span class="co"># 空白除去</span></span>
<span id="cb6-7"><a href="#cb6-7" aria-hidden="true"></a>  <span class="op">|&gt;</span> <span class="cn">Result</span><span class="op">.</span>and_then(<span class="op">&amp;</span>update_stat(<span class="op">&amp;</span><span class="dv">1</span>, <span class="va">:result</span>, %{})) <span class="co"># 状態の result を空オブジェクト %{} に更新</span></span>
<span id="cb6-8"><a href="#cb6-8" aria-hidden="true"></a>  <span class="op">|&gt;</span> <span class="cn">Result</span><span class="op">.</span>and_then(<span class="op">&amp;</span>parse_when_unmatch_by(<span class="op">&amp;</span><span class="dv">1</span>, <span class="st">&quot;}&quot;</span>, <span class="kw">fn</span> s <span class="op">-&gt;</span> match_members(s) <span class="kw">end</span>))</span>
<span id="cb6-9"><a href="#cb6-9" aria-hidden="true"></a>  <span class="op">|&gt;</span> <span class="cn">Result</span><span class="op">.</span>and_then(<span class="op">&amp;</span>match_right_par(<span class="op">&amp;</span><span class="dv">1</span>))           <span class="co"># `}` にマッチ</span></span>
<span id="cb6-10"><a href="#cb6-10" aria-hidden="true"></a><span class="kw">end</span></span>
<span id="cb6-11"><a href="#cb6-11" aria-hidden="true"></a></span>
<span id="cb6-12"><a href="#cb6-12" aria-hidden="true"></a><span class="kw">defp</span> match_members(stat) <span class="kw">do</span></span>
<span id="cb6-13"><a href="#cb6-13" aria-hidden="true"></a>  match_member(stat)</span>
<span id="cb6-14"><a href="#cb6-14" aria-hidden="true"></a>  <span class="op">|&gt;</span> <span class="cn">Result</span><span class="op">.</span>and_then(<span class="op">&amp;</span>match_members_tail(<span class="op">&amp;</span><span class="dv">1</span>))</span>
<span id="cb6-15"><a href="#cb6-15" aria-hidden="true"></a><span class="kw">end</span></span>
<span id="cb6-16"><a href="#cb6-16" aria-hidden="true"></a></span>
<span id="cb6-17"><a href="#cb6-17" aria-hidden="true"></a><span class="co"># match_members_tail は members の再帰処理をする</span></span>
<span id="cb6-18"><a href="#cb6-18" aria-hidden="true"></a><span class="co"># 先頭が `,` にマッチした時には再帰処理を行い</span></span>
<span id="cb6-19"><a href="#cb6-19" aria-hidden="true"></a><span class="co"># マッチしない場合は stat をそのまま返す</span></span>
<span id="cb6-20"><a href="#cb6-20" aria-hidden="true"></a><span class="kw">defp</span> match_members_tail(stat <span class="op">=</span> %{<span class="va">rest:</span> <span class="st">&quot;,&quot;</span> <span class="op">&lt;&gt;</span> rest}) <span class="kw">do</span></span>
<span id="cb6-21"><a href="#cb6-21" aria-hidden="true"></a>  update_stat(stat, <span class="va">:rest</span>, rest)</span>
<span id="cb6-22"><a href="#cb6-22" aria-hidden="true"></a>  <span class="op">|&gt;</span> <span class="cn">Result</span><span class="op">.</span>and_then(<span class="op">&amp;</span>match_members(<span class="op">&amp;</span><span class="dv">1</span>))</span>
<span id="cb6-23"><a href="#cb6-23" aria-hidden="true"></a><span class="kw">end</span></span>
<span id="cb6-24"><a href="#cb6-24" aria-hidden="true"></a><span class="kw">defp</span> match_members_tail(stat), <span class="kw">do</span>: <span class="cn">Result</span><span class="op">.</span>success(stat)</span>
<span id="cb6-25"><a href="#cb6-25" aria-hidden="true"></a></span>
<span id="cb6-26"><a href="#cb6-26" aria-hidden="true"></a><span class="kw">defp</span> match_member(stat <span class="op">=</span> %{<span class="va">result:</span> prev}) <span class="kw">do</span></span>
<span id="cb6-27"><a href="#cb6-27" aria-hidden="true"></a>  <span class="co"># 空白を除去してから文字列にマッチさせてみる</span></span>
<span id="cb6-28"><a href="#cb6-28" aria-hidden="true"></a>  <span class="kw">case</span> match_string(trim_leading(stat)) <span class="kw">do</span></span>
<span id="cb6-29"><a href="#cb6-29" aria-hidden="true"></a>    {<span class="va">:error</span>, stat} <span class="op">-&gt;</span></span>
<span id="cb6-30"><a href="#cb6-30" aria-hidden="true"></a>      <span class="cn">Result</span><span class="op">.</span>failure(stat)</span>
<span id="cb6-31"><a href="#cb6-31" aria-hidden="true"></a></span>
<span id="cb6-32"><a href="#cb6-32" aria-hidden="true"></a>    <span class="co"># string のパースに成功した場合にのみ，そのパース結果を `key` として残りをパースする</span></span>
<span id="cb6-33"><a href="#cb6-33" aria-hidden="true"></a>    {<span class="va">:ok</span>, stat <span class="op">=</span> %{<span class="va">result:</span> key}} <span class="op">-&gt;</span></span>
<span id="cb6-34"><a href="#cb6-34" aria-hidden="true"></a>      trim_leading(stat)</span>
<span id="cb6-35"><a href="#cb6-35" aria-hidden="true"></a>      <span class="op">|&gt;</span> match_colon() <span class="co"># ':' にマッチ</span></span>
<span id="cb6-36"><a href="#cb6-36" aria-hidden="true"></a>      <span class="op">|&gt;</span> <span class="cn">Result</span><span class="op">.</span>and_then(<span class="op">&amp;</span>match_element(<span class="op">&amp;</span><span class="dv">1</span>)) <span class="co">#match_element は前のと同じ</span></span>
<span id="cb6-37"><a href="#cb6-37" aria-hidden="true"></a>      <span class="op">|&gt;</span> <span class="cn">Result</span><span class="op">.</span>and_then(<span class="op">&amp;</span>modify_stat(<span class="op">&amp;</span><span class="dv">1</span>, <span class="va">:result</span>, <span class="kw">fn</span> v <span class="op">-&gt;</span> <span class="cn">Map</span><span class="op">.</span>put(prev, key, v) <span class="kw">end</span>))</span>
<span id="cb6-38"><a href="#cb6-38" aria-hidden="true"></a>  <span class="kw">end</span></span>
<span id="cb6-39"><a href="#cb6-39" aria-hidden="true"></a><span class="kw">end</span></span></code></pre></div>
<p><code>update_stat(stat, key, value)</code> は <code>stat</code> の <code>key</code> を <code>value</code> で置き換える関数で，<code>modify_stat(stat, key, func)</code> は <code>stat</code> の <code>key</code> を <code>func</code> で更新する関数だ．</p>
<p>余談だが，Elixir は(僕が思うに)普通の関数それ自体は第一級では無いが，無名関数 <code>fn args -&gt; ... end</code> は第一級のようだ． <code>&amp;any_function(&amp;1, &amp;2)</code> などとすることで <code>fn arg1 arg2 -&gt; any_function(arg1, arg2) end</code> の糖衣構文になるっぽく，関数を関数の引数に渡す場合はこうするらしい． ただし，この記法は入れ子にできないので，<code>modify_stat</code> や <code>parse_when_unmatch_by</code> では内部の方の関数を <code>fn args -&gt; ... end</code> で直接囲っている(<a href="https://stackoverflow.com/questions/38217426/can-i-nest-anonymous-functions-in-elixir">参照</a>)．</p>
<h3 id="配列のパース">配列のパース</h3>
<div class="sourceCode" id="cb7"><pre class="sourceCode txt"><code class="sourceCode default"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true"></a>array</span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true"></a>  := '[' ws ']'</span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true"></a>   | '[' elements ']'</span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true"></a></span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true"></a>elements</span>
<span id="cb7-6"><a href="#cb7-6" aria-hidden="true"></a>  := element</span>
<span id="cb7-7"><a href="#cb7-7" aria-hidden="true"></a>   | element ',' elements</span></code></pre></div>
<p>実は <code>{}</code> が <code>[]</code> になっただけで，だいたいオブジェクトと同じだ:</p>
<div class="sourceCode" id="cb8"><pre class="sourceCode elixir"><code class="sourceCode elixir"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true"></a><span class="kw">defp</span> match_array(stat) <span class="kw">do</span></span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true"></a>  match_left_square(stat)                           <span class="co"># '[' にマッチ</span></span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true"></a>  <span class="op">|&gt;</span> <span class="cn">Result</span><span class="op">.</span>map(<span class="op">&amp;</span>trim_leading(<span class="op">&amp;</span><span class="dv">1</span>))                  <span class="co"># 空白除去</span></span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true"></a>  <span class="op">|&gt;</span> <span class="cn">Result</span><span class="op">.</span>and_then(<span class="op">&amp;</span>update_stat(<span class="op">&amp;</span><span class="dv">1</span>, <span class="va">:result</span>, [])) <span class="co"># 状態の result を空配列 [] に更新</span></span>
<span id="cb8-5"><a href="#cb8-5" aria-hidden="true"></a>  <span class="op">|&gt;</span> <span class="cn">Result</span><span class="op">.</span>and_then(<span class="op">&amp;</span>parse_when_unmatch_by(<span class="op">&amp;</span><span class="dv">1</span>, <span class="st">&quot;]&quot;</span>, <span class="kw">fn</span> s <span class="op">-&gt;</span> match_elements(s) <span class="kw">end</span>))</span>
<span id="cb8-6"><a href="#cb8-6" aria-hidden="true"></a>  <span class="op">|&gt;</span> <span class="cn">Result</span><span class="op">.</span>and_then(<span class="op">&amp;</span>match_right_square(<span class="op">&amp;</span><span class="dv">1</span>))       <span class="co"># ']' にマッチ</span></span>
<span id="cb8-7"><a href="#cb8-7" aria-hidden="true"></a><span class="kw">end</span></span>
<span id="cb8-8"><a href="#cb8-8" aria-hidden="true"></a></span>
<span id="cb8-9"><a href="#cb8-9" aria-hidden="true"></a><span class="kw">defp</span> match_elements(stat <span class="op">=</span> %{<span class="va">result:</span> prev}) <span class="kw">do</span></span>
<span id="cb8-10"><a href="#cb8-10" aria-hidden="true"></a>  match_element(stat)</span>
<span id="cb8-11"><a href="#cb8-11" aria-hidden="true"></a>  <span class="co"># ここで状態(配列)の更新をしてる点だけが違う</span></span>
<span id="cb8-12"><a href="#cb8-12" aria-hidden="true"></a>  <span class="op">|&gt;</span> <span class="cn">Result</span><span class="op">.</span>and_then(<span class="op">&amp;</span>modify_stat(<span class="op">&amp;</span><span class="dv">1</span>, <span class="va">:result</span>, <span class="kw">fn</span> v <span class="op">-&gt;</span> prev <span class="op">++</span> [v] <span class="kw">end</span>))</span>
<span id="cb8-13"><a href="#cb8-13" aria-hidden="true"></a>  <span class="op">|&gt;</span> <span class="cn">Result</span><span class="op">.</span>and_then(<span class="op">&amp;</span>match_elements_tail(<span class="op">&amp;</span><span class="dv">1</span>))</span>
<span id="cb8-14"><a href="#cb8-14" aria-hidden="true"></a><span class="kw">end</span></span>
<span id="cb8-15"><a href="#cb8-15" aria-hidden="true"></a></span>
<span id="cb8-16"><a href="#cb8-16" aria-hidden="true"></a><span class="kw">defp</span> match_elements_tail(stat <span class="op">=</span> %{<span class="va">rest:</span> <span class="st">&quot;,&quot;</span> <span class="op">&lt;&gt;</span> rest}) <span class="kw">do</span></span>
<span id="cb8-17"><a href="#cb8-17" aria-hidden="true"></a>  update_stat(stat, <span class="va">:rest</span>, rest)</span>
<span id="cb8-18"><a href="#cb8-18" aria-hidden="true"></a>  <span class="op">|&gt;</span> <span class="cn">Result</span><span class="op">.</span>and_then(<span class="op">&amp;</span>match_elements(<span class="op">&amp;</span><span class="dv">1</span>))</span>
<span id="cb8-19"><a href="#cb8-19" aria-hidden="true"></a><span class="kw">end</span></span>
<span id="cb8-20"><a href="#cb8-20" aria-hidden="true"></a><span class="kw">defp</span> match_elements_tail(stat), <span class="kw">do</span>: <span class="cn">Result</span><span class="op">.</span>success(stat)</span></code></pre></div>
<h3 id="文字列のパース">文字列のパース</h3>
<p>さぁこっからが大変． 文字列内でのエスケープをそれっぽく処理する必要がある:</p>
<div class="sourceCode" id="cb9"><pre class="sourceCode elixir"><code class="sourceCode elixir"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true"></a><span class="kw">defp</span> match_string(stat) <span class="kw">do</span></span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true"></a>  match_double_quote(stat)                          <span class="co"># '&quot;' にマッチ</span></span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true"></a>  <span class="op">|&gt;</span> <span class="cn">Result</span><span class="op">.</span>and_then(<span class="op">&amp;</span>update_stat(<span class="op">&amp;</span><span class="dv">1</span>, <span class="va">:result</span>, <span class="st">&quot;&quot;</span>)) <span class="co"># 状態の result を空文字列 &quot;&quot; に更新</span></span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true"></a>  <span class="op">|&gt;</span> <span class="cn">Result</span><span class="op">.</span>and_then(<span class="op">&amp;</span>match_characters(<span class="op">&amp;</span><span class="dv">1</span>))</span>
<span id="cb9-5"><a href="#cb9-5" aria-hidden="true"></a>  <span class="op">|&gt;</span> <span class="cn">Result</span><span class="op">.</span>and_then(<span class="op">&amp;</span>match_double_quote(<span class="op">&amp;</span><span class="dv">1</span>))       <span class="co"># '&quot;' にマッチ</span></span>
<span id="cb9-6"><a href="#cb9-6" aria-hidden="true"></a><span class="kw">end</span></span>
<span id="cb9-7"><a href="#cb9-7" aria-hidden="true"></a></span>
<span id="cb9-8"><a href="#cb9-8" aria-hidden="true"></a><span class="co"># どう見ても成功じゃ無いがどーせ後々エラーになるので...</span></span>
<span id="cb9-9"><a href="#cb9-9" aria-hidden="true"></a><span class="kw">defp</span> match_characters(stat <span class="op">=</span> %{<span class="va">rest:</span> <span class="st">&quot;&quot;</span>}), <span class="kw">do</span>: <span class="cn">Result</span><span class="op">.</span>success(stat)</span>
<span id="cb9-10"><a href="#cb9-10" aria-hidden="true"></a></span>
<span id="cb9-11"><a href="#cb9-11" aria-hidden="true"></a><span class="co"># '&quot;' にマッチしたら終わり</span></span>
<span id="cb9-12"><a href="#cb9-12" aria-hidden="true"></a><span class="kw">defp</span> match_characters(stat <span class="op">=</span> %{<span class="va">rest:</span> <span class="st">&quot;\&quot;&quot;</span> <span class="op">&lt;&gt;</span> _}), <span class="kw">do</span>: <span class="cn">Result</span><span class="op">.</span>success(stat)</span>
<span id="cb9-13"><a href="#cb9-13" aria-hidden="true"></a><span class="kw">defp</span> match_characters(stat) <span class="kw">do</span></span>
<span id="cb9-14"><a href="#cb9-14" aria-hidden="true"></a>  <span class="co"># &quot;\&quot; はエスケープ文字として処理する必要があるのでまずはそれ以外</span></span>
<span id="cb9-15"><a href="#cb9-15" aria-hidden="true"></a>  parse_when_unmatch_by(stat, <span class="st">&quot;\\&quot;</span>, <span class="op">&amp;</span>match_noescape_characters(<span class="op">&amp;</span><span class="dv">1</span>))</span>
<span id="cb9-16"><a href="#cb9-16" aria-hidden="true"></a>  <span class="op">|&gt;</span> <span class="cn">Result</span><span class="op">.</span>and_then(<span class="op">&amp;</span>match_escape(<span class="op">&amp;</span><span class="dv">1</span>))     <span class="co"># 次にエスケープ文字の処理</span></span>
<span id="cb9-17"><a href="#cb9-17" aria-hidden="true"></a>  <span class="op">|&gt;</span> <span class="cn">Result</span><span class="op">.</span>and_then(<span class="op">&amp;</span>match_characters(<span class="op">&amp;</span><span class="dv">1</span>)) <span class="co"># 再帰する</span></span>
<span id="cb9-18"><a href="#cb9-18" aria-hidden="true"></a><span class="kw">end</span></span></code></pre></div>
<p>関数名の通り，<code>match_noescape_characters</code> がエスケープ文字以外のパーサーで，<code>match_escape</code> がエスケープ文字のパーサーだ． <code>match_noescape_characters</code> ではまず <code>\</code> や <code>"</code> を含まない文字列をマッチさせたい． しかし，パターンマッチは exclude なマッチはできないので，あんまり良く無いが正規表現でサボることにする:</p>
<div class="sourceCode" id="cb10"><pre class="sourceCode elixir"><code class="sourceCode elixir"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true"></a><span class="co"># エスケープされてない文字はダメっぽい</span></span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true"></a><span class="kw">defp</span> match_noescape_characters(stat <span class="op">=</span> %{<span class="va">rest:</span> <span class="st">&quot;\n&quot;</span> <span class="op">&lt;&gt;</span> _}), <span class="kw">do</span>: <span class="cn">Result</span><span class="op">.</span>failure(stat)</span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true"></a><span class="kw">defp</span> match_noescape_characters(stat <span class="op">=</span> %{<span class="va">rest:</span> <span class="st">&quot;\t&quot;</span> <span class="op">&lt;&gt;</span> _}), <span class="kw">do</span>: <span class="cn">Result</span><span class="op">.</span>failure(stat)</span>
<span id="cb10-4"><a href="#cb10-4" aria-hidden="true"></a><span class="kw">defp</span> match_noescape_characters(stat <span class="op">=</span> %{<span class="va">rest:</span> <span class="st">&quot;\u0000&quot;</span> <span class="op">&lt;&gt;</span> _}), <span class="kw">do</span>: <span class="cn">Result</span><span class="op">.</span>failure(stat)</span>
<span id="cb10-5"><a href="#cb10-5" aria-hidden="true"></a></span>
<span id="cb10-6"><a href="#cb10-6" aria-hidden="true"></a><span class="kw">defp</span> match_noescape_characters(stat <span class="op">=</span> %{<span class="va">result:</span> prev}) <span class="kw">do</span></span>
<span id="cb10-7"><a href="#cb10-7" aria-hidden="true"></a>  <span class="co"># 名前付きキャプチャ，便利</span></span>
<span id="cb10-8"><a href="#cb10-8" aria-hidden="true"></a>  %{<span class="st">&quot;body&quot;</span> <span class="op">=&gt;</span> body, <span class="st">&quot;rest&quot;</span> <span class="op">=&gt;</span> rest} <span class="op">=</span></span>
<span id="cb10-9"><a href="#cb10-9" aria-hidden="true"></a>    <span class="cn">Regex</span><span class="op">.</span>named_captures(<span class="op">~</span>r<span class="op">/</span>(?<span class="op">&lt;</span>body<span class="op">&gt;</span>[<span class="op">^</span>\\\<span class="st">&quot;\n\x00\t]*)(?&lt;rest&gt;.*)/s, stat[:rest])</span></span>
<span id="cb10-10"><a href="#cb10-10" aria-hidden="true"></a></span>
<span id="cb10-11"><a href="#cb10-11" aria-hidden="true"></a><span class="st">  update_stat(%{result: prev &lt;&gt; body}, :rest, rest)</span></span>
<span id="cb10-12"><a href="#cb10-12" aria-hidden="true"></a><span class="st">end</span></span></code></pre></div>
<p>エスケープ文字は，もうパターンマッチで頑張る:</p>
<div class="sourceCode" id="cb11"><pre class="sourceCode elixir"><code class="sourceCode elixir"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true"></a><span class="kw">defp</span> match_escape(%{<span class="va">rest:</span> <span class="st">&quot;\\\&quot;&quot;</span> <span class="op">&lt;&gt;</span> rest, <span class="va">result:</span> prev}),</span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true"></a>  <span class="kw">do</span>: update_stat(%{<span class="va">result:</span> prev <span class="op">&lt;&gt;</span> <span class="st">&quot;\&quot;&quot;</span>}, <span class="va">:rest</span>, rest)</span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true"></a></span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true"></a><span class="kw">defp</span> match_escape(%{<span class="va">rest:</span> <span class="st">&quot;\\\\&quot;</span> <span class="op">&lt;&gt;</span> rest, <span class="va">result:</span> prev}),</span>
<span id="cb11-5"><a href="#cb11-5" aria-hidden="true"></a>  <span class="kw">do</span>: update_stat(%{<span class="va">result:</span> prev <span class="op">&lt;&gt;</span> <span class="st">&quot;\\&quot;</span>}, <span class="va">:rest</span>, rest)</span>
<span id="cb11-6"><a href="#cb11-6" aria-hidden="true"></a></span>
<span id="cb11-7"><a href="#cb11-7" aria-hidden="true"></a><span class="kw">defp</span> match_escape(%{<span class="va">rest:</span> <span class="st">&quot;\\\/&quot;</span> <span class="op">&lt;&gt;</span> rest, <span class="va">result:</span> prev}),</span>
<span id="cb11-8"><a href="#cb11-8" aria-hidden="true"></a>  <span class="kw">do</span>: update_stat(%{<span class="va">result:</span> prev <span class="op">&lt;&gt;</span> <span class="st">&quot;\/&quot;</span>}, <span class="va">:rest</span>, rest)</span>
<span id="cb11-9"><a href="#cb11-9" aria-hidden="true"></a></span>
<span id="cb11-10"><a href="#cb11-10" aria-hidden="true"></a><span class="kw">defp</span> match_escape(%{<span class="va">rest:</span> <span class="st">&quot;\\b&quot;</span> <span class="op">&lt;&gt;</span> rest, <span class="va">result:</span> prev}),</span>
<span id="cb11-11"><a href="#cb11-11" aria-hidden="true"></a>  <span class="kw">do</span>: update_stat(%{<span class="va">result:</span> prev <span class="op">&lt;&gt;</span> <span class="st">&quot;\b&quot;</span>}, <span class="va">:rest</span>, rest)</span>
<span id="cb11-12"><a href="#cb11-12" aria-hidden="true"></a></span>
<span id="cb11-13"><a href="#cb11-13" aria-hidden="true"></a><span class="kw">defp</span> match_escape(%{<span class="va">rest:</span> <span class="st">&quot;\\f&quot;</span> <span class="op">&lt;&gt;</span> rest, <span class="va">result:</span> prev}),</span>
<span id="cb11-14"><a href="#cb11-14" aria-hidden="true"></a>  <span class="kw">do</span>: update_stat(%{<span class="va">result:</span> prev <span class="op">&lt;&gt;</span> <span class="st">&quot;\f&quot;</span>}, <span class="va">:rest</span>, rest)</span>
<span id="cb11-15"><a href="#cb11-15" aria-hidden="true"></a></span>
<span id="cb11-16"><a href="#cb11-16" aria-hidden="true"></a><span class="kw">defp</span> match_escape(%{<span class="va">rest:</span> <span class="st">&quot;\\n&quot;</span> <span class="op">&lt;&gt;</span> rest, <span class="va">result:</span> prev}),</span>
<span id="cb11-17"><a href="#cb11-17" aria-hidden="true"></a>  <span class="kw">do</span>: update_stat(%{<span class="va">result:</span> prev <span class="op">&lt;&gt;</span> <span class="st">&quot;\n&quot;</span>}, <span class="va">:rest</span>, rest)</span>
<span id="cb11-18"><a href="#cb11-18" aria-hidden="true"></a></span>
<span id="cb11-19"><a href="#cb11-19" aria-hidden="true"></a><span class="kw">defp</span> match_escape(%{<span class="va">rest:</span> <span class="st">&quot;\\r&quot;</span> <span class="op">&lt;&gt;</span> rest, <span class="va">result:</span> prev}),</span>
<span id="cb11-20"><a href="#cb11-20" aria-hidden="true"></a>  <span class="kw">do</span>: update_stat(%{<span class="va">result:</span> prev <span class="op">&lt;&gt;</span> <span class="st">&quot;\r&quot;</span>}, <span class="va">:rest</span>, rest)</span>
<span id="cb11-21"><a href="#cb11-21" aria-hidden="true"></a></span>
<span id="cb11-22"><a href="#cb11-22" aria-hidden="true"></a><span class="kw">defp</span> match_escape(%{<span class="va">rest:</span> <span class="st">&quot;\\t&quot;</span> <span class="op">&lt;&gt;</span> rest, <span class="va">result:</span> prev}),</span>
<span id="cb11-23"><a href="#cb11-23" aria-hidden="true"></a>  <span class="kw">do</span>: update_stat(%{<span class="va">result:</span> prev <span class="op">&lt;&gt;</span> <span class="st">&quot;\t&quot;</span>}, <span class="va">:rest</span>, rest)</span>
<span id="cb11-24"><a href="#cb11-24" aria-hidden="true"></a></span>
<span id="cb11-25"><a href="#cb11-25" aria-hidden="true"></a><span class="co"># \u1234 とかいうやつ</span></span>
<span id="cb11-26"><a href="#cb11-26" aria-hidden="true"></a><span class="kw">defp</span> match_escape(stat <span class="op">=</span> %{<span class="va">rest:</span> <span class="st">&quot;\\u&quot;</span> <span class="op">&lt;&gt;</span> rest, <span class="va">result:</span> prev}) <span class="kw">do</span></span>
<span id="cb11-27"><a href="#cb11-27" aria-hidden="true"></a>  <span class="co"># /.{n,m}/ で n 個以上 m 個以下にマッチする</span></span>
<span id="cb11-28"><a href="#cb11-28" aria-hidden="true"></a>  <span class="kw">case</span> <span class="cn">Regex</span><span class="op">.</span>named_captures(<span class="op">~</span>r<span class="op">/</span>(?<span class="op">&lt;</span>body<span class="op">&gt;</span>[\dA<span class="op">-</span><span class="cn">Fa</span><span class="op">-</span>f]{<span class="dv">4</span>,<span class="dv">4</span>})(?<span class="op">&lt;</span>rest<span class="op">&gt;.*</span>)<span class="op">/</span>s, rest) <span class="kw">do</span></span>
<span id="cb11-29"><a href="#cb11-29" aria-hidden="true"></a>    %{<span class="st">&quot;body&quot;</span> <span class="op">=&gt;</span> body, <span class="st">&quot;rest&quot;</span> <span class="op">=&gt;</span> rest} <span class="op">-&gt;</span></span>
<span id="cb11-30"><a href="#cb11-30" aria-hidden="true"></a>      <span class="co"># 4桁の16進数をエスケープされた文字列として変換する</span></span>
<span id="cb11-31"><a href="#cb11-31" aria-hidden="true"></a>      <span class="co"># 変換できなかった場合は nil が返ってくる</span></span>
<span id="cb11-32"><a href="#cb11-32" aria-hidden="true"></a>      <span class="kw">case</span> hex_to_string(body) <span class="kw">do</span></span>
<span id="cb11-33"><a href="#cb11-33" aria-hidden="true"></a>        <span class="cn">nil</span> <span class="op">-&gt;</span> <span class="cn">Result</span><span class="op">.</span>failure(stat)</span>
<span id="cb11-34"><a href="#cb11-34" aria-hidden="true"></a>        hex <span class="op">-&gt;</span> update_stat(%{<span class="va">result:</span> prev <span class="op">&lt;&gt;</span> hex}, <span class="va">:rest</span>, rest)</span>
<span id="cb11-35"><a href="#cb11-35" aria-hidden="true"></a>      <span class="kw">end</span></span>
<span id="cb11-36"><a href="#cb11-36" aria-hidden="true"></a></span>
<span id="cb11-37"><a href="#cb11-37" aria-hidden="true"></a>    _ <span class="op">-&gt;</span></span>
<span id="cb11-38"><a href="#cb11-38" aria-hidden="true"></a>      <span class="cn">Result</span><span class="op">.</span>failure(stat)</span>
<span id="cb11-39"><a href="#cb11-39" aria-hidden="true"></a>  <span class="kw">end</span></span>
<span id="cb11-40"><a href="#cb11-40" aria-hidden="true"></a><span class="kw">end</span></span>
<span id="cb11-41"><a href="#cb11-41" aria-hidden="true"></a></span>
<span id="cb11-42"><a href="#cb11-42" aria-hidden="true"></a><span class="kw">defp</span> hex_to_string(str) <span class="kw">do</span></span>
<span id="cb11-43"><a href="#cb11-43" aria-hidden="true"></a>  <span class="cf">try</span> <span class="kw">do</span></span>
<span id="cb11-44"><a href="#cb11-44" aria-hidden="true"></a>    <span class="co"># 文字列を16進数として int 型に変換</span></span>
<span id="cb11-45"><a href="#cb11-45" aria-hidden="true"></a>    {hex, _} <span class="op">=</span> <span class="cn">Integer</span><span class="op">.</span>parse(str, <span class="dv">16</span>)</span>
<span id="cb11-46"><a href="#cb11-46" aria-hidden="true"></a>    <span class="op">&lt;&lt;</span><span class="va">hex::utf8</span><span class="op">&gt;&gt;</span> <span class="co"># こういう記法で int を16進数でエスケープされた文字列に変換できる</span></span>
<span id="cb11-47"><a href="#cb11-47" aria-hidden="true"></a>  <span class="cf">rescue</span></span>
<span id="cb11-48"><a href="#cb11-48" aria-hidden="true"></a>    _ <span class="op">-&gt;</span> <span class="cn">nil</span></span>
<span id="cb11-49"><a href="#cb11-49" aria-hidden="true"></a>  <span class="kw">end</span></span>
<span id="cb11-50"><a href="#cb11-50" aria-hidden="true"></a><span class="kw">end</span></span></code></pre></div>
<p>まぁ正直，色々と雑で漏れてるケースもきっとあるのだが，そんな変な JSON をパースしたいわけでは無いのでこれでいいかな．</p>
<h3 id="数値のパース">数値のパース</h3>
<p>数値は，マイナス符号・整数・浮動小数点数・<code>e</code>記法を網羅する必要がある． これも，めんどくさいので正規表現に頼っちゃう:</p>
<div class="sourceCode" id="cb12"><pre class="sourceCode elixir"><code class="sourceCode elixir"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true"></a><span class="kw">defp</span> match_number(stat) <span class="kw">do</span></span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true"></a>  {value, rest} <span class="op">=</span> compile_number(stat[<span class="va">:rest</span>])</span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true"></a></span>
<span id="cb12-4"><a href="#cb12-4" aria-hidden="true"></a>  <span class="co"># 文字列から数値を取得できなかった場合は nil が返ってくる</span></span>
<span id="cb12-5"><a href="#cb12-5" aria-hidden="true"></a>  <span class="kw">case</span> value <span class="kw">do</span></span>
<span id="cb12-6"><a href="#cb12-6" aria-hidden="true"></a>    <span class="cn">nil</span> <span class="op">-&gt;</span></span>
<span id="cb12-7"><a href="#cb12-7" aria-hidden="true"></a>      <span class="cn">Result</span><span class="op">.</span>failure(stat)</span>
<span id="cb12-8"><a href="#cb12-8" aria-hidden="true"></a></span>
<span id="cb12-9"><a href="#cb12-9" aria-hidden="true"></a>    _ <span class="op">-&gt;</span></span>
<span id="cb12-10"><a href="#cb12-10" aria-hidden="true"></a>      <span class="cn">Map</span><span class="op">.</span>put(stat, <span class="va">:result</span>, value)</span>
<span id="cb12-11"><a href="#cb12-11" aria-hidden="true"></a>      <span class="op">|&gt;</span> <span class="cn">Map</span><span class="op">.</span>put(<span class="va">:rest</span>, rest)</span>
<span id="cb12-12"><a href="#cb12-12" aria-hidden="true"></a>      <span class="op">|&gt;</span> <span class="cn">Result</span><span class="op">.</span>success()</span>
<span id="cb12-13"><a href="#cb12-13" aria-hidden="true"></a>  <span class="kw">end</span></span>
<span id="cb12-14"><a href="#cb12-14" aria-hidden="true"></a><span class="kw">end</span></span>
<span id="cb12-15"><a href="#cb12-15" aria-hidden="true"></a></span>
<span id="cb12-16"><a href="#cb12-16" aria-hidden="true"></a><span class="kw">def</span> compile_number(str) <span class="kw">do</span></span>
<span id="cb12-17"><a href="#cb12-17" aria-hidden="true"></a>  <span class="co"># 名前付きキャプチャ，超便利</span></span>
<span id="cb12-18"><a href="#cb12-18" aria-hidden="true"></a>  <span class="co"># minus は `-`，digit は整数部，frac は小数点以下，exp は `e`記法 (`10e-2`とか)</span></span>
<span id="cb12-19"><a href="#cb12-19" aria-hidden="true"></a>  %{<span class="st">&quot;minus&quot;</span> <span class="op">=&gt;</span> minus, <span class="st">&quot;digit&quot;</span> <span class="op">=&gt;</span> digit, <span class="st">&quot;frac&quot;</span> <span class="op">=&gt;</span> frac, <span class="st">&quot;exp&quot;</span> <span class="op">=&gt;</span> exp, <span class="st">&quot;rest&quot;</span> <span class="op">=&gt;</span> rest} <span class="op">=</span></span>
<span id="cb12-20"><a href="#cb12-20" aria-hidden="true"></a>    <span class="cn">Regex</span><span class="op">.</span>named_captures(</span>
<span id="cb12-21"><a href="#cb12-21" aria-hidden="true"></a>      <span class="op">~</span>r<span class="op">/</span>(?<span class="op">&lt;</span>minus<span class="op">&gt;-</span>?)(?<span class="op">&lt;</span>digit<span class="op">&gt;</span>[[<span class="va">:digit</span>:]]<span class="op">*</span>)(?<span class="op">&lt;</span>frac<span class="op">&gt;</span>\<span class="op">.</span>?[[<span class="va">:digit</span>:]]<span class="op">*</span>)(?<span class="op">&lt;</span>exp<span class="op">&gt;</span>[eE]?[<span class="op">-+</span>]?[[<span class="va">:digit</span>:]]<span class="op">*</span>)(?<span class="op">&lt;</span>rest<span class="op">&gt;.*</span>)<span class="op">/</span>s,</span>
<span id="cb12-22"><a href="#cb12-22" aria-hidden="true"></a>      str</span>
<span id="cb12-23"><a href="#cb12-23" aria-hidden="true"></a>    )</span>
<span id="cb12-24"><a href="#cb12-24" aria-hidden="true"></a></span>
<span id="cb12-25"><a href="#cb12-25" aria-hidden="true"></a>  value <span class="op">=</span></span>
<span id="cb12-26"><a href="#cb12-26" aria-hidden="true"></a>    <span class="kw">case</span> {digit, frac, exp} <span class="kw">do</span></span>
<span id="cb12-27"><a href="#cb12-27" aria-hidden="true"></a>      {<span class="st">&quot;&quot;</span>, _, _} <span class="op">-&gt;</span></span>
<span id="cb12-28"><a href="#cb12-28" aria-hidden="true"></a>        <span class="cn">nil</span> <span class="co"># 整数部が無い場合はダメ</span></span>
<span id="cb12-29"><a href="#cb12-29" aria-hidden="true"></a></span>
<span id="cb12-30"><a href="#cb12-30" aria-hidden="true"></a>      {<span class="st">&quot;0&quot;</span> <span class="op">&lt;&gt;</span> num, <span class="st">&quot;&quot;</span>, <span class="st">&quot;&quot;</span>} <span class="kw">when</span> num<span class="op"> !=</span> <span class="st">&quot;&quot;</span> <span class="op">-&gt;</span></span>
<span id="cb12-31"><a href="#cb12-31" aria-hidden="true"></a>        <span class="cn">nil</span> <span class="co"># 0 から始まる整数もダメ(小数はOK)</span></span>
<span id="cb12-32"><a href="#cb12-32" aria-hidden="true"></a></span>
<span id="cb12-33"><a href="#cb12-33" aria-hidden="true"></a>      {_, <span class="st">&quot;.&quot;</span> <span class="op">&lt;&gt;</span> num, _} <span class="kw">when</span> num <span class="op">==</span> <span class="st">&quot;&quot;</span> <span class="op">-&gt;</span></span>
<span id="cb12-34"><a href="#cb12-34" aria-hidden="true"></a>        <span class="cn">nil</span> <span class="co"># 小数点だけはダメ</span></span>
<span id="cb12-35"><a href="#cb12-35" aria-hidden="true"></a></span>
<span id="cb12-36"><a href="#cb12-36" aria-hidden="true"></a>      {_, _, <span class="st">&quot;e&quot;</span> <span class="op">&lt;&gt;</span> num} <span class="kw">when</span> num <span class="op">==</span> <span class="st">&quot;&quot;</span> <span class="op">-&gt;</span></span>
<span id="cb12-37"><a href="#cb12-37" aria-hidden="true"></a>        <span class="cn">nil</span> <span class="co"># e だけはダメ</span></span>
<span id="cb12-38"><a href="#cb12-38" aria-hidden="true"></a></span>
<span id="cb12-39"><a href="#cb12-39" aria-hidden="true"></a>      {_, _, <span class="st">&quot;E&quot;</span> <span class="op">&lt;&gt;</span> num} <span class="kw">when</span> num <span class="op">==</span> <span class="st">&quot;&quot;</span> <span class="op">-&gt;</span></span>
<span id="cb12-40"><a href="#cb12-40" aria-hidden="true"></a>        <span class="cn">nil</span> <span class="co"># E だけはダメ</span></span>
<span id="cb12-41"><a href="#cb12-41" aria-hidden="true"></a></span>
<span id="cb12-42"><a href="#cb12-42" aria-hidden="true"></a>      {_, <span class="st">&quot;&quot;</span>, <span class="st">&quot;&quot;</span>} <span class="op">-&gt;</span> <span class="co"># これは整数の場合</span></span>
<span id="cb12-43"><a href="#cb12-43" aria-hidden="true"></a>        <span class="kw">case</span> <span class="cn">Integer</span><span class="op">.</span>parse(minus <span class="op">&lt;&gt;</span> digit) <span class="kw">do</span></span>
<span id="cb12-44"><a href="#cb12-44" aria-hidden="true"></a>          {num, <span class="st">&quot;&quot;</span>} <span class="op">-&gt;</span> num</span>
<span id="cb12-45"><a href="#cb12-45" aria-hidden="true"></a>          _ <span class="op">-&gt;</span> <span class="cn">nil</span></span>
<span id="cb12-46"><a href="#cb12-46" aria-hidden="true"></a>        <span class="kw">end</span></span>
<span id="cb12-47"><a href="#cb12-47" aria-hidden="true"></a></span>
<span id="cb12-48"><a href="#cb12-48" aria-hidden="true"></a>      _ <span class="op">-&gt;</span> <span class="co"># これは浮動小数点数の場合</span></span>
<span id="cb12-49"><a href="#cb12-49" aria-hidden="true"></a>        <span class="kw">case</span> <span class="cn">Float</span><span class="op">.</span>parse(minus <span class="op">&lt;&gt;</span> digit <span class="op">&lt;&gt;</span> frac <span class="op">&lt;&gt;</span> exp) <span class="kw">do</span></span>
<span id="cb12-50"><a href="#cb12-50" aria-hidden="true"></a>          {num, <span class="st">&quot;&quot;</span>} <span class="op">-&gt;</span> num</span>
<span id="cb12-51"><a href="#cb12-51" aria-hidden="true"></a>          _ <span class="op">-&gt;</span> <span class="cn">nil</span></span>
<span id="cb12-52"><a href="#cb12-52" aria-hidden="true"></a>        <span class="kw">end</span></span>
<span id="cb12-53"><a href="#cb12-53" aria-hidden="true"></a>    <span class="kw">end</span></span>
<span id="cb12-54"><a href="#cb12-54" aria-hidden="true"></a></span>
<span id="cb12-55"><a href="#cb12-55" aria-hidden="true"></a>  {value, rest}</span>
<span id="cb12-56"><a href="#cb12-56" aria-hidden="true"></a><span class="kw">end</span></span></code></pre></div>
<p>これでとりあえず完成．</p>
<h2 id="テストする">テストする</h2>
<p>JSON のテストスイートとして <a href="https://github.com/nst/JSONTestSuite">nst/JSONTestSuite</a> と言うのがあるので使わせてもらう． こんな感じに配置する:</p>
<div class="sourceCode" id="cb13"><pre class="sourceCode txt"><code class="sourceCode default"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true"></a>\</span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true"></a>|- lib // elixir のコード置き場</span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true"></a>|- test</span>
<span id="cb13-4"><a href="#cb13-4" aria-hidden="true"></a>|  |- fixture</span>
<span id="cb13-5"><a href="#cb13-5" aria-hidden="true"></a>|  |  \- test_parsing // JSONTestSuite のテスト用 JSON ファイル群</span>
<span id="cb13-6"><a href="#cb13-6" aria-hidden="true"></a>|  \- json_spec.exs</span>
<span id="cb13-7"><a href="#cb13-7" aria-hidden="true"></a>\- mix.exs</span></code></pre></div>
<p>テストには espec を使ってこんな感じに記述した:</p>
<div class="sourceCode" id="cb14"><pre class="sourceCode elixir"><code class="sourceCode elixir"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true"></a><span class="co"># json_spec.exs</span></span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true"></a><span class="kw">defmodule</span> <span class="cn">JSONSuite</span> <span class="kw">do</span></span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true"></a>  <span class="kw">def</span> test_suite <span class="kw">do</span></span>
<span id="cb14-4"><a href="#cb14-4" aria-hidden="true"></a>    [</span>
<span id="cb14-5"><a href="#cb14-5" aria-hidden="true"></a>      <span class="co"># エラーケース</span></span>
<span id="cb14-6"><a href="#cb14-6" aria-hidden="true"></a>      {<span class="st">&quot;n_array_1_true_without_comma.json&quot;</span>, {<span class="va">:error</span>, <span class="cn">nil</span>}},</span>
<span id="cb14-7"><a href="#cb14-7" aria-hidden="true"></a>      {<span class="st">&quot;n_array_a_invalid_utf8.json&quot;</span>, {<span class="va">:error</span>, <span class="cn">nil</span>}},</span>
<span id="cb14-8"><a href="#cb14-8" aria-hidden="true"></a>      <span class="op">...</span></span>
<span id="cb14-9"><a href="#cb14-9" aria-hidden="true"></a>      <span class="co"># 成功ケース</span></span>
<span id="cb14-10"><a href="#cb14-10" aria-hidden="true"></a>      {<span class="st">&quot;y_array_arraysWithSpaces.json&quot;</span>, {<span class="va">:ok</span>, [[]]}},</span>
<span id="cb14-11"><a href="#cb14-11" aria-hidden="true"></a>      {<span class="st">&quot;y_array_empty-string.json&quot;</span>, {<span class="va">:ok</span>, [<span class="st">&quot;&quot;</span>]}},</span>
<span id="cb14-12"><a href="#cb14-12" aria-hidden="true"></a>      <span class="op">...</span></span>
<span id="cb14-13"><a href="#cb14-13" aria-hidden="true"></a>    ]</span>
<span id="cb14-14"><a href="#cb14-14" aria-hidden="true"></a>  <span class="kw">end</span></span>
<span id="cb14-15"><a href="#cb14-15" aria-hidden="true"></a><span class="kw">end</span></span>
<span id="cb14-16"><a href="#cb14-16" aria-hidden="true"></a></span>
<span id="cb14-17"><a href="#cb14-17" aria-hidden="true"></a><span class="co"># JSONSuite を先に宣言しないと使えなかった</span></span>
<span id="cb14-18"><a href="#cb14-18" aria-hidden="true"></a><span class="kw">defmodule</span> <span class="cn">JSONSpec</span> <span class="kw">do</span></span>
<span id="cb14-19"><a href="#cb14-19" aria-hidden="true"></a>  <span class="im">use</span> <span class="cn">ESpec</span></span>
<span id="cb14-20"><a href="#cb14-20" aria-hidden="true"></a>  <span class="im">alias</span> <span class="cn">ThankYouStars</span><span class="op">.</span><span class="cn">JSON</span>, <span class="va">as:</span> <span class="cn">JSON</span></span>
<span id="cb14-21"><a href="#cb14-21" aria-hidden="true"></a>  <span class="im">alias</span> <span class="cn">ThankYouStars</span><span class="op">.</span><span class="cn">Result</span>, <span class="va">as:</span> <span class="cn">Result</span></span>
<span id="cb14-22"><a href="#cb14-22" aria-hidden="true"></a></span>
<span id="cb14-23"><a href="#cb14-23" aria-hidden="true"></a>  describe <span class="st">&quot;JSON.decode&quot;</span> <span class="kw">do</span></span>
<span id="cb14-24"><a href="#cb14-24" aria-hidden="true"></a>    <span class="cn">Enum</span><span class="op">.</span>map(<span class="cn">JSONSuite</span><span class="op">.</span>test_suite(), <span class="kw">fn</span> {path, result} <span class="op">-&gt;</span></span>
<span id="cb14-25"><a href="#cb14-25" aria-hidden="true"></a>      context path <span class="kw">do</span></span>
<span id="cb14-26"><a href="#cb14-26" aria-hidden="true"></a>        <span class="co"># 変数を利用するには unquote する必要がある(マクロのせい？)</span></span>
<span id="cb14-27"><a href="#cb14-27" aria-hidden="true"></a>        let(<span class="va">:json</span>, <span class="kw">do</span>: <span class="cn">File</span><span class="op">.</span>read!(<span class="st">&quot;test/fixture/test_parsing/</span><span class="ot">#{</span><span class="kw">unquote</span>(path)<span class="ot">}</span><span class="st">&quot;</span>))</span>
<span id="cb14-28"><a href="#cb14-28" aria-hidden="true"></a>        it(</span>
<span id="cb14-29"><a href="#cb14-29" aria-hidden="true"></a>          <span class="kw">do</span>:</span>
<span id="cb14-30"><a href="#cb14-30" aria-hidden="true"></a>            <span class="cn">Result</span><span class="op">.</span>map_error(<span class="cn">JSON</span><span class="op">.</span>decode(json()), <span class="kw">fn</span> _ <span class="op">-&gt;</span> <span class="cn">nil</span> <span class="kw">end</span>)</span>
<span id="cb14-31"><a href="#cb14-31" aria-hidden="true"></a>            <span class="op">|&gt;</span> to(eq(<span class="kw">unquote</span>(<span class="cn">Macro</span><span class="op">.</span>escape(result))))</span>
<span id="cb14-32"><a href="#cb14-32" aria-hidden="true"></a>        )</span>
<span id="cb14-33"><a href="#cb14-33" aria-hidden="true"></a>      <span class="kw">end</span></span>
<span id="cb14-34"><a href="#cb14-34" aria-hidden="true"></a>    <span class="kw">end</span>)</span>
<span id="cb14-35"><a href="#cb14-35" aria-hidden="true"></a>  <span class="kw">end</span></span>
<span id="cb14-36"><a href="#cb14-36" aria-hidden="true"></a><span class="kw">end</span></span></code></pre></div>
<p><code>unquote</code> やらモジュールの順序周りやら結構苦労した． なお，いくつかテストの通らない JSONTestSuite のケースがあるので，そう言うのはとりあえずコメントアウトしてる．</p>
<h2 id="おしまい">おしまい</h2>
<p>意外と綺麗にかけて満足． なお，パフォーマンスは無視してる笑．</p>
  </div>

  <footer class="post-footer">
    <a href="https://twitter.com/share?ref_src=twsrc%5Etfw" class="twitter-share-button" data-show-count="false">Tweet</a>
    <script async src="https://platform.twitter.com/widgets.js" charset="utf-8"></script>
  </footer>
</div>
</article>

          </div>
        </div>

        <footer class="site-footer">

  <div class="wrapper">

    <span class="footer-heading">ひげメモ</span>

  </div>

  <div class="page-content card" style="display: flex; justify-content: center; padding: 5px 0px">
    <a href="https://haskell.jp/blog/posts/links.html#matsubara0507.github.io">
      <img width="234" src="https://haskell.jp/img/supported-by-haskell-jp.svg" alt="Supported By Haskell-jp.">
    </a>
  </div>

</footer>


      </div>
  </body>

</html>
