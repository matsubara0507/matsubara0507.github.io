<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE html>
<html lang="ja">

  <head>
  <meta charset="utf-8">
  <link rel="icon" href="../assets/icon.jpg">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
    
      <meta property="og:title" content="GitHub に Bookmark を送る Chrome 拡張を作ってみた" />
    
  

  <meta property="og:site_name" content="ひげメモ" />

  
    <meta property="og:image" content="/assets/make-chrome-extension-bookmark-hub/bookmark-hub.jpg" />
  

  
    <script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-86386380-1', 'auto');
  ga('send', 'pageview');
</script>

  

  <title>
    
      
        GitHub に Bookmark を送る Chrome 拡張を作ってみた
      
    
  </title>

  <link rel="stylesheet" href="../css/main.css">
  <link rel="stylesheet" href="../css/highlight.css">
  <link rel="stylesheet" type="text/css" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.4.0/css/font-awesome.min.css" />
</head>


  <body>
      <div class="outer">

        <header class="site-header">

  <div class="wrapper">

    <a class="site-title" href="https://matsubara0507.github.io/">ひげメモ</a>

  </div>

  <div class="header-badge">
    <a href="https://matsubara0507.github.io/">
        <img src="../assets/icon.jpg" />
    </a>
  </div>

</header>


        <div class="page-content">
          <div class="wrapper">
            <article class="post card" itemscope itemtype="http://schema.org/BlogPosting">
 <div class="card-content">
  <header class="post-header">
    <h1 class="post-title" itemprop="name headline">GitHub に Bookmark を送る Chrome 拡張を作ってみた</h1>
    <p class="post-meta">
      <time datetime="2017-06-06" itemprop="datePublished">
        Jun 6, 2017
      </time>
      
      
      <div class="tags">
          <i class="fa fa-tags"></i> <a href="../tags/JavaScript.html">JavaScript</a> <a href="../tags/ChromeExtension.html">ChromeExtension</a>
      </div>
      
    </p>
  </header>

  <div class="post-content" itemprop="articleBody">
    <p>Chrome 拡張を作ってみた． どんなのを作ったかというと，ブックマークを GitHub のリポジトリのファイルに書き込んでいくやつ． ファイルを指定して，どんな時に参照してたかを分けたり，メッセージを残せたり．</p>
<p>残りの細かい作業(消したり，修正したり，検索したり)は GitHub 側で自由にやってくれって感じの拡張です．</p>
<p>なんか作業してるとタブがたまってしょうがない(あとで記事でも書こうかなと思うと尚更)のでずっと欲しかった． まぁ車輪の再発明の可能性あるけど，まぁいいや．</p>
<h2 id="作った">作った</h2>
<p>こんな感じ．</p>
<p><img src="../assets/make-chrome-extension-bookmark-hub/bookmark-hub.jpg" /></p>
<p>一応<a href="https://chrome.google.com/webstore/detail/bookmark-using-github/aoicnpaoijbcdgcailchgfmfiefpmpjm?hl=ja">公開</a>してみたけど，<strong>バグは残ってそう</strong>． ごめんなさい．</p>
<p><a href="https://github.com/matsubara0507/bookmark-hub">ソースコードはコチラ</a>．</p>
<p>見た目は <a href="http://primercss.io/">Primer.css</a> っていう GitHub 公式の CSS ツールキットを用いて寄せた． あとは，リポジトリとブランチを既存のを取ってきて選択できるようにした．</p>
<h2 id="作る">作る</h2>
<p>要約すると <a href="https://developer.github.com/v3/">GitHub API</a> でプッシュするだけ． で，認証とかをどうするかというと，愛用してる <a href="https://github.com/leonhartX/gas-github">GAS と GitHub をつなぐ Chrome 拡張</a>がいい感じで MIT ライセンスなので，使わせてもらった． これをベースに以下のサイトを見ながら，読み解いて作っていった．</p>
<ul>
<li><a href="https://liginc.co.jp/web/tool/browser/163575">Chromeのオリジナル拡張機能を開発しよう（ソースコードあり） | 株式会社LIG</a></li>
</ul>
<h3 id="vs-github-api">vs GitHub API</h3>
<p>最初は，<a href="../posts/2017-05-03-make-githubapi-lib-for-gas.html">前作った日記 Bot</a> を参考にしながら</p>
<ol type="1">
<li>コミットしたいブランチの情報を取得(既存のブランチに紐づけないならいらない)</li>
<li>blobオブジェクトを作成(ファイル単位のオブジェクト)</li>
<li>treeオブジェクトを作成(ディレクトリ単位のオブジェクト)</li>
<li>commitオブジェクトを作成(treeオブジェクトをコミットに紐づける)</li>
<li>ブランチに紐づける</li>
</ol>
<p>とかやってた． しかし，ちゃんと GitHub API を見てると，ファイルを直接送れる <a href="https://developer.github.com/v3/repos/contents/">Contents API</a> というのがあった． 早く気づきたかった…orz</p>
<p>ただ，ファイルの有無をチャックするのには <a href="https://developer.github.com/v3/git/trees/">tree オブジェクトの API</a> を使って再帰的に探すようにした． <a href="https://developer.github.com/v3/repos/contents/#get-contents">get contents</a> でもできるんだけど，1000ファイルを超えると使えなくなるらしいし，せっかくだから自作してしまった．</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode javascript"><code class="sourceCode javascript"><a class="sourceLine" id="cb1-1" data-line-number="1"><span class="kw">function</span> <span class="at">existContents</span>(filepath<span class="op">,</span> pTree) <span class="op">{</span></a>
<a class="sourceLine" id="cb1-2" data-line-number="2">  <span class="kw">var</span> loop <span class="op">=</span> (<span class="kw">function</span> (filepaths<span class="op">,</span> index<span class="op">,</span> pTree<span class="op">,</span> resolve) <span class="op">{</span></a>
<a class="sourceLine" id="cb1-3" data-line-number="3">    <span class="kw">var</span> path <span class="op">=</span> filepaths[index]<span class="op">;</span></a>
<a class="sourceLine" id="cb1-4" data-line-number="4">    <span class="kw">var</span> result <span class="op">=</span> <span class="op">{};</span></a>
<a class="sourceLine" id="cb1-5" data-line-number="5">    <span class="cf">for</span> (<span class="kw">var</span> i <span class="kw">in</span> pTree) <span class="op">{</span></a>
<a class="sourceLine" id="cb1-6" data-line-number="6">      <span class="cf">if</span> (pTree[i].<span class="va">path</span>.<span class="at">toString</span>() <span class="op">===</span> <span class="va">path</span>.<span class="at">toString</span>()) <span class="op">{</span></a>
<a class="sourceLine" id="cb1-7" data-line-number="7">        <span class="cf">if</span> (i <span class="op">-</span> <span class="dv">0</span> <span class="op">===</span> <span class="va">filepaths</span>.<span class="at">length</span> <span class="op">-</span> <span class="dv">1</span> <span class="op">&amp;&amp;</span> pTree[i].<span class="va">type</span>.<span class="at">toString</span>() <span class="op">===</span> <span class="st">'blob'</span>) <span class="op">{</span></a>
<a class="sourceLine" id="cb1-8" data-line-number="8">          result <span class="op">=</span> pTree[i]<span class="op">;</span></a>
<a class="sourceLine" id="cb1-9" data-line-number="9">          <span class="cf">break</span><span class="op">;</span></a>
<a class="sourceLine" id="cb1-10" data-line-number="10">        <span class="op">}</span> <span class="cf">else</span> <span class="cf">if</span> (pTree[i].<span class="va">type</span>.<span class="at">toString</span>() <span class="op">===</span> <span class="st">'tree'</span>) <span class="op">{</span></a>
<a class="sourceLine" id="cb1-11" data-line-number="11">          result <span class="op">=</span> pTree[i]<span class="op">;</span></a>
<a class="sourceLine" id="cb1-12" data-line-number="12">          <span class="cf">break</span><span class="op">;</span></a>
<a class="sourceLine" id="cb1-13" data-line-number="13">        <span class="op">}</span></a>
<a class="sourceLine" id="cb1-14" data-line-number="14">      <span class="op">}</span></a>
<a class="sourceLine" id="cb1-15" data-line-number="15">    <span class="op">}</span></a>
<a class="sourceLine" id="cb1-16" data-line-number="16">    <span class="cf">switch</span> (<span class="va">result</span>.<span class="at">type</span>) <span class="op">{</span></a>
<a class="sourceLine" id="cb1-17" data-line-number="17">      <span class="cf">case</span> <span class="st">'blob'</span><span class="op">:</span></a>
<a class="sourceLine" id="cb1-18" data-line-number="18">        <span class="at">resolve</span>(<span class="op">{</span> <span class="dt">ok</span><span class="op">:</span> <span class="kw">true</span><span class="op">,</span> <span class="dt">sha</span><span class="op">:</span> pTree[i].<span class="at">sha</span> <span class="op">}</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb1-19" data-line-number="19">        <span class="cf">break</span><span class="op">;</span></a>
<a class="sourceLine" id="cb1-20" data-line-number="20">      <span class="cf">case</span> <span class="st">'tree'</span><span class="op">:</span></a>
<a class="sourceLine" id="cb1-21" data-line-number="21">        <span class="va">$</span>.<span class="at">ajax</span>(<span class="op">{</span></a>
<a class="sourceLine" id="cb1-22" data-line-number="22">          <span class="dt">url</span><span class="op">:</span> <span class="vs">`</span><span class="sc">${</span><span class="va">github</span>.<span class="at">baseUrl</span><span class="sc">}</span><span class="vs">/repos/</span><span class="sc">${</span><span class="va">github</span>.<span class="at">user</span><span class="sc">}</span><span class="vs">/</span><span class="sc">${</span><span class="va">github</span>.<span class="at">repo</span><span class="sc">}</span><span class="vs">/git/trees/</span><span class="sc">${</span>pTree[i].<span class="at">sha</span><span class="sc">}</span><span class="vs">`</span><span class="op">,</span></a>
<a class="sourceLine" id="cb1-23" data-line-number="23">          <span class="dt">headers </span><span class="op">:</span> <span class="op">{</span> <span class="dt">Authorization</span><span class="op">:</span> <span class="vs">`token </span><span class="sc">${</span><span class="va">github</span>.<span class="at">token</span><span class="sc">}</span><span class="vs">`</span> <span class="op">}</span></a>
<a class="sourceLine" id="cb1-24" data-line-number="24">        <span class="op">}</span>).<span class="at">done</span>((tree) <span class="op">=&gt;</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb1-25" data-line-number="25">          <span class="at">loop</span>(filepaths<span class="op">,</span> index1<span class="op">,</span> <span class="va">tree</span>.<span class="at">tree</span><span class="op">,</span> resolve)<span class="op">;</span></a>
<a class="sourceLine" id="cb1-26" data-line-number="26">        <span class="op">}</span>).<span class="at">fail</span>(() <span class="op">=&gt;</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb1-27" data-line-number="27">          <span class="at">resolve</span>(<span class="op">{</span> <span class="dt">ok</span><span class="op">:</span> <span class="kw">false</span> <span class="op">}</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb1-28" data-line-number="28">        <span class="op">}</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb1-29" data-line-number="29">        <span class="cf">break</span><span class="op">;</span></a>
<a class="sourceLine" id="cb1-30" data-line-number="30">      <span class="dt">default</span><span class="op">:</span></a>
<a class="sourceLine" id="cb1-31" data-line-number="31">        <span class="at">resolve</span>(<span class="op">{</span> <span class="dt">ok</span><span class="op">:</span> <span class="kw">false</span> <span class="op">}</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb1-32" data-line-number="32">    <span class="op">}</span></a>
<a class="sourceLine" id="cb1-33" data-line-number="33">  <span class="op">}</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb1-34" data-line-number="34"></a>
<a class="sourceLine" id="cb1-35" data-line-number="35">  <span class="cf">return</span> <span class="kw">new</span> <span class="at">Promise</span>((resolve) <span class="op">=&gt;</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb1-36" data-line-number="36">    <span class="at">loop</span>(<span class="va">filepath</span>.<span class="at">split</span>(<span class="st">'/'</span>)<span class="op">,</span> <span class="dv">0</span><span class="op">,</span> pTree<span class="op">,</span> resolve)<span class="op">;</span></a>
<a class="sourceLine" id="cb1-37" data-line-number="37">  <span class="op">}</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb1-38" data-line-number="38"><span class="op">}</span></a></code></pre></div>
<p>イロイロやってみた結果，<code>loop</code> という関数を使って，与えられたファイルパスを基にして再帰的に呼び出している．</p>
<h3 id="vs-promise">vs Promise</h3>
<p>上のコードを見るとあるように，<code>Promise</code> っていうオブジェクトを複製(生成)してる．</p>
<p>Javascript は外のリソース(API をたたくとか)とやり取りする場合は，<code>Promise</code> オブジェクトに処理を記述して，あとで実行し，返ってくるまで処理が止まるようにしているみたいだ(なんでこうなっているんだろう？)． これを，<code>then</code> メソッドで数珠つなぎみたいにしていく． こんな感じ．</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode javascript"><code class="sourceCode javascript"><a class="sourceLine" id="cb2-1" data-line-number="1"><span class="at">initContext</span>()</a>
<a class="sourceLine" id="cb2-2" data-line-number="2">.<span class="at">then</span>(initUserInfo)</a>
<a class="sourceLine" id="cb2-3" data-line-number="3">.<span class="at">then</span>(checkGitHubAPI)</a>
<a class="sourceLine" id="cb2-4" data-line-number="4">.<span class="at">then</span>(() <span class="op">=&gt;</span> <span class="kw">new</span> <span class="at">Promise</span>((resolve) <span class="op">=&gt;</span> <span class="op">{</span> <span class="va">github</span>.<span class="at">repo</span> <span class="op">=</span> repository<span class="op">;</span> <span class="at">resolve</span>()<span class="op">;</span> <span class="op">}</span>))</a>
<a class="sourceLine" id="cb2-5" data-line-number="5">.<span class="at">then</span>(<span class="va">github</span>.<span class="at">get</span>(<span class="vs">`repos/</span><span class="sc">${</span><span class="va">github</span>.<span class="at">user</span><span class="sc">}</span><span class="vs">/</span><span class="sc">${</span><span class="va">github</span>.<span class="at">repo</span><span class="sc">}</span><span class="vs">/branches/</span><span class="sc">${</span>branch<span class="sc">}</span><span class="vs">`</span>))</a>
<a class="sourceLine" id="cb2-6" data-line-number="6">.<span class="at">then</span>(branch <span class="op">=&gt;</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb2-7" data-line-number="7">  <span class="cf">if</span> (<span class="op">!</span>(<span class="va">context</span>.<span class="at">name</span> <span class="op">&amp;&amp;</span> <span class="va">context</span>.<span class="at">email</span>)) <span class="op">{</span></a>
<a class="sourceLine" id="cb2-8" data-line-number="8">    <span class="va">context</span>.<span class="at">name</span> <span class="op">=</span> <span class="va">branch</span>.<span class="va">commit</span>.<span class="va">commit</span>.<span class="va">author</span>.<span class="at">name</span><span class="op">;</span></a>
<a class="sourceLine" id="cb2-9" data-line-number="9">    <span class="va">context</span>.<span class="at">email</span> <span class="op">=</span> <span class="va">branch</span>.<span class="va">commit</span>.<span class="va">commit</span>.<span class="va">author</span>.<span class="at">email</span><span class="op">;</span></a>
<a class="sourceLine" id="cb2-10" data-line-number="10">  <span class="op">}</span></a>
<a class="sourceLine" id="cb2-11" data-line-number="11">  <span class="cf">return</span> <span class="va">github</span>.<span class="at">get</span>(<span class="vs">`repos/</span><span class="sc">${</span><span class="va">github</span>.<span class="at">user</span><span class="sc">}</span><span class="vs">/</span><span class="sc">${</span><span class="va">github</span>.<span class="at">repo</span><span class="sc">}</span><span class="vs">/git/trees/</span><span class="sc">${</span><span class="va">branch</span>.<span class="va">commit</span>.<span class="va">commit</span>.<span class="va">tree</span>.<span class="at">sha</span><span class="sc">}</span><span class="vs">`</span>)()<span class="op">;</span></a>
<a class="sourceLine" id="cb2-12" data-line-number="12"><span class="op">}</span>)</a>
<a class="sourceLine" id="cb2-13" data-line-number="13">.<span class="at">then</span>(tree <span class="op">=&gt;</span> <span class="at">existContents</span>(filepath<span class="op">,</span> <span class="va">tree</span>.<span class="at">tree</span><span class="op">,</span> repository))</a></code></pre></div>
<p>4つ目の <code>() =&gt; new Promise((resolve) =&gt; { github.repo = repository; resolve(); })</code> にあるように，引数の <code>resolve</code> が次の <code>then</code> で与えるメソッドである．</p>
<p>なんかこういう構造は型クラスと相性よさそうだ．</p>
<p>値が返ってきてから実行したい処理は，ちゃんと <code>Promise</code> の中に入れないとうまく動作しない(このあたりにバグが潜んでそう…)． 今は愚直に数珠繋ぎしてるが，きっともっと賢い繋げ方がある気がする．</p>
<h3 id="vs-debug">vs Debug</h3>
<p>やり方わからないから自流でやった．</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode html"><code class="sourceCode html"><a class="sourceLine" id="cb3-1" data-line-number="1"><span class="kw">&lt;div</span><span class="ot"> id=</span><span class="st">'result'</span><span class="kw">&gt;&lt;/div&gt;</span></a></code></pre></div>
<p>みたいのを書いておいて</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode javascript"><code class="sourceCode javascript"><a class="sourceLine" id="cb4-1" data-line-number="1"><span class="at">$</span>(<span class="st">'#result'</span>).<span class="at">text</span>(<span class="at">$</span>(<span class="st">'#result'</span>).<span class="at">text</span>()<span class="vs">` : 1 </span><span class="sc">${</span><span class="va">JSON</span>.<span class="at">stringify</span>(data)<span class="sc">}</span><span class="vs">`</span>)<span class="op">;</span></a></code></pre></div>
<p>みたいな感じでいわゆる printf デバッグをしてた． あとは，Developer Tools とかを見ると，エラーが出ていることも(構文的なモノとかはコッチのが多いかなぁ)． 動的言語は静的検査があればわかるバグもごちゃっになって出てくるのでつらいですね…</p>
<h3 id="vs-primer.css">vs Primer.css</h3>
<p>最後にサクッとデザイン変えて完成！っていう感じの軽い気持ちで手を出したら，思ったより時間かかった． というのも，Primer.css には Bootstrap みたいな Web 越しでリンクを貼れる公式のとこが見当たらなかった(ローカルに落とさなくても使える的な)． なので，ローカルにリポジトリを落として，ビルドする必要がある．</p>
<p>が，ぼくは Windows なので，ちとつらい． このためだけに <code>node</code> いれるのもだるかったので，Docker でビルドして持ってこようと考えた(どーせ css を生成するだけだろーし)．</p>
<p>しかし，<a href="https://github.com/primer/primer-css/blob/master/README.md">ドキュメント</a>にあるとおりに，クローンして <code>npm run build</code> とやったのに，<code>Error: File to import not found or unreadable: primer-core/index.scss</code> とでたり，<a href="https://www.npmjs.com/package/primer-module-build"><code>primer-module-build</code></a> が無いといわれたり，なかなかすんなりいかなかった．</p>
<p>最終的には，</p>
<ol type="1">
<li><code>docker run --rm -it -v /c/Users/username/tekitounatokoro:/mnt node /bin/bash</code> って感じに適当なところを適当なとこにマウントし</li>
<li><code>/root</code> で</li>
<li><code>npm install --save primer-module-build</code> し</li>
<li><code>npm install --save primer-css</code> して</li>
<li><code>/root/node_modules</code> 以下にあるビルド済み <code>prime-css</code> の中から生成された CSS ファイルを</li>
<li>マウント先にコピーして取ってきた</li>
</ol>
<p>あとはこの <a href="http://primercss.io/archive/scaffolding/">Primer.css のドキュメント</a>に従って，いい感じにデザインを変えていった．</p>
<h3 id="vs-javascript">vs Javascript</h3>
<p>意外な挙動がいくつか．</p>
<h4 id="日時のフォーマット">日時のフォーマット</h4>
<p>まず，日時のフォーマットをするメソッドが無かったので<a href="http://kuroeveryday.blogspot.jp/2016/06/format-to-ISO8601.html">調べて</a>作った． まぁこれは最終的には使ってないんだが(コミットするときに必要だった)．</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode javascript"><code class="sourceCode javascript"><a class="sourceLine" id="cb5-1" data-line-number="1"><span class="kw">function</span> <span class="at">formatISO8601</span>(date) <span class="op">{</span></a>
<a class="sourceLine" id="cb5-2" data-line-number="2">  <span class="kw">var</span> offset <span class="op">=</span> (<span class="kw">function</span> (d) <span class="op">{</span></a>
<a class="sourceLine" id="cb5-3" data-line-number="3">    <span class="kw">var</span> o <span class="op">=</span> <span class="va">d</span>.<span class="at">getTimezoneOffset</span>() / <span class="dv">-60</span><span class="op">;</span></a>
<a class="sourceLine" id="cb5-4" data-line-number="4">    <span class="cf">return</span> ((<span class="dv">0</span> <span class="op">&lt;</span> o) <span class="op">?</span> <span class="st">'+'</span> : <span class="st">'-'</span>)(<span class="st">'00'</span><span class="va">Math</span>.<span class="at">abs</span>(o)).<span class="at">substr</span>(<span class="op">-</span><span class="dv">2</span>)<span class="st">':00'</span><span class="op">;</span></a>
<a class="sourceLine" id="cb5-5" data-line-number="5">  <span class="op">}</span>)(date)<span class="op">;</span></a>
<a class="sourceLine" id="cb5-6" data-line-number="6">  <span class="cf">return</span> [</a>
<a class="sourceLine" id="cb5-7" data-line-number="7">    [</a>
<a class="sourceLine" id="cb5-8" data-line-number="8">      <span class="va">date</span>.<span class="at">getFullYear</span>()<span class="op">,</span></a>
<a class="sourceLine" id="cb5-9" data-line-number="9">      (<span class="st">'00'</span>(<span class="va">date</span>.<span class="at">getMonth</span>()<span class="dv">1</span>)).<span class="at">substr</span>(<span class="op">-</span><span class="dv">2</span>)<span class="op">,</span></a>
<a class="sourceLine" id="cb5-10" data-line-number="10">      (<span class="st">'00'</span><span class="va">date</span>.<span class="at">getDate</span>()).<span class="at">substr</span>(<span class="op">-</span><span class="dv">2</span>)</a>
<a class="sourceLine" id="cb5-11" data-line-number="11">    ].<span class="at">join</span>(<span class="st">'-'</span>)<span class="op">,</span></a>
<a class="sourceLine" id="cb5-12" data-line-number="12">    <span class="st">'T'</span><span class="op">,</span></a>
<a class="sourceLine" id="cb5-13" data-line-number="13">    [</a>
<a class="sourceLine" id="cb5-14" data-line-number="14">      (<span class="st">'00'</span><span class="va">date</span>.<span class="at">getHours</span>()).<span class="at">substr</span>(<span class="op">-</span><span class="dv">2</span>)<span class="op">,</span></a>
<a class="sourceLine" id="cb5-15" data-line-number="15">      (<span class="st">'00'</span><span class="va">date</span>.<span class="at">getMinutes</span>()).<span class="at">substr</span>(<span class="op">-</span><span class="dv">2</span>)<span class="op">,</span></a>
<a class="sourceLine" id="cb5-16" data-line-number="16">      (<span class="st">'00'</span><span class="va">date</span>.<span class="at">getSeconds</span>()).<span class="at">substr</span>(<span class="op">-</span><span class="dv">2</span>)</a>
<a class="sourceLine" id="cb5-17" data-line-number="17">    ].<span class="at">join</span>(<span class="st">':'</span>)<span class="op">,</span></a>
<a class="sourceLine" id="cb5-18" data-line-number="18">    offset</a>
<a class="sourceLine" id="cb5-19" data-line-number="19">  ].<span class="at">join</span>(<span class="st">''</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb5-20" data-line-number="20"><span class="op">}</span></a></code></pre></div>
<h4 id="this">this</h4>
<p>GitHub API に関するのだけ外に出してたら</p>
<div class="sourceCode" id="cb6"><pre class="sourceCode javascript"><code class="sourceCode javascript"><a class="sourceLine" id="cb6-1" data-line-number="1"><span class="kw">function</span> <span class="at">GitHubAPI</span>(baseUrl<span class="op">,</span> user<span class="op">,</span> repo<span class="op">,</span> token) <span class="op">{</span></a>
<a class="sourceLine" id="cb6-2" data-line-number="2">  <span class="kw">this</span>.<span class="at">baseUrl</span> <span class="op">=</span> baseUrl<span class="op">;</span></a>
<a class="sourceLine" id="cb6-3" data-line-number="3">  <span class="kw">this</span>.<span class="at">user</span> <span class="op">=</span> user<span class="op">;</span></a>
<a class="sourceLine" id="cb6-4" data-line-number="4">  <span class="kw">this</span>.<span class="at">repo</span> <span class="op">=</span> repo<span class="op">;</span></a>
<a class="sourceLine" id="cb6-5" data-line-number="5">  <span class="kw">this</span>.<span class="at">token</span> <span class="op">=</span> token<span class="op">;</span></a>
<a class="sourceLine" id="cb6-6" data-line-number="6"><span class="op">}</span></a>
<a class="sourceLine" id="cb6-7" data-line-number="7"></a>
<a class="sourceLine" id="cb6-8" data-line-number="8"><span class="va">GitHubAPI</span>.<span class="va">prototype</span>.<span class="at">fetch</span> <span class="op">=</span> <span class="kw">function</span>(method<span class="op">,</span> endpoint<span class="op">,</span> data) <span class="op">{</span></a>
<a class="sourceLine" id="cb6-9" data-line-number="9">  <span class="cf">return</span> <span class="kw">new</span> <span class="at">Promise</span>((resolve<span class="op">,</span> reject) <span class="op">=&gt;</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb6-10" data-line-number="10">    <span class="kw">var</span> params <span class="op">=</span> <span class="op">{</span></a>
<a class="sourceLine" id="cb6-11" data-line-number="11">      <span class="dt">url</span><span class="op">:</span> <span class="vs">`</span><span class="sc">${</span><span class="kw">this</span>.<span class="at">baseUrl</span><span class="sc">}</span><span class="vs">/</span><span class="sc">${</span>endpoint<span class="sc">}</span><span class="vs">`</span><span class="op">,</span></a>
<a class="sourceLine" id="cb6-12" data-line-number="12">      <span class="dt">headers </span><span class="op">:</span> <span class="op">{</span> <span class="dt">Authorization</span><span class="op">:</span> <span class="vs">`token </span><span class="sc">${</span><span class="kw">this</span>.<span class="at">token</span><span class="sc">}</span><span class="vs">`</span> <span class="op">}</span></a>
<a class="sourceLine" id="cb6-13" data-line-number="13">    <span class="op">};</span></a>
<a class="sourceLine" id="cb6-14" data-line-number="14">    ...</a>
<a class="sourceLine" id="cb6-15" data-line-number="15">  <span class="op">}</span>)<span class="op">;</span></a>
<a class="sourceLine" id="cb6-16" data-line-number="16"><span class="op">};</span></a>
<a class="sourceLine" id="cb6-17" data-line-number="17"></a>
<a class="sourceLine" id="cb6-18" data-line-number="18"><span class="va">GitHubAPI</span>.<span class="va">prototype</span>.<span class="at">get</span> <span class="op">=</span> <span class="kw">function</span> (endpoint) <span class="op">{</span></a>
<a class="sourceLine" id="cb6-19" data-line-number="19">  <span class="cf">return</span> <span class="kw">function</span>() <span class="op">{</span> <span class="cf">return</span> <span class="kw">this</span>.<span class="at">fetch</span>(<span class="st">'GET'</span><span class="op">,</span> endpoint<span class="op">,</span> <span class="kw">null</span>)<span class="op">;</span> <span class="op">};</span></a>
<a class="sourceLine" id="cb6-20" data-line-number="20"><span class="op">};</span></a></code></pre></div>
<p>こんな感じのコードで <code>this</code> に <code>fetch</code> がないと怒られた． ぜんぜん意味が分からなかったんだけど，調べてみたら．</p>
<ul>
<li><a href="http://qiita.com/takeharu/items/9935ce476a17d6258e27">JavaScriptの「this」は「4種類」？？ - Qiita</a></li>
</ul>
<blockquote>
<p>メソッド呼び出しの中で関数呼び出しされているので、 あくまで注2の「this」はグローバルを指してしまいます。</p>
</blockquote>
<p>えぇぇ，って感じだった． (メソッドではなく)関数の <code>this</code> はグローバルを指すんだってさ． まぁ確かに，関数を実行するのはオブジェクトでないしなぁ． で解決策は</p>
<blockquote>
<p>「<code>this</code>」を別の変数で持っておきます。この手法はよく使われます。 慣用的に変数は「<code>self</code>」, 「<code>that</code>」, 「<code>_this</code>」のどれかが使われる事が多いです。</p>
</blockquote>
<p>なんか <code>var _this = this</code> とか何度か見たけど，そういう意味だったのね．</p>
<h4 id="primitive-string-型と-string-クラス">Primitive string 型と String クラス</h4>
<p><a href="http://jshint.com/">JSHint</a> 使ってリファクタリングしたら <code>==</code> を <code>===</code> にしろと言われた． 言われたとおりにしたら動かなくなった…</p>
<p>原因のひとつは Primitive の文字列型と文字列クラスを比較してたから． <code>'abc'</code> とかみたいに値を書けば文字列型だが，API の返り値である JSON オブジェクトの文字列は文字列クラスになっている． なので，JSONオブジェクトだったほうを <code>toString()</code> して比較した．</p>
<h4 id="for-in-の挙動">for-in の挙動</h4>
<p>Javascript の拡張 for 文として次のようなのがある</p>
<div class="sourceCode" id="cb7"><pre class="sourceCode javascript"><code class="sourceCode javascript"><a class="sourceLine" id="cb7-1" data-line-number="1"><span class="kw">var</span> xs <span class="op">=</span> [<span class="dv">1</span><span class="op">,</span><span class="dv">2</span><span class="op">,</span><span class="dv">3</span>]<span class="op">;</span></a>
<a class="sourceLine" id="cb7-2" data-line-number="2"><span class="cf">for</span> (<span class="kw">var</span> i <span class="kw">in</span> xs)</a>
<a class="sourceLine" id="cb7-3" data-line-number="3">  <span class="va">console</span>.<span class="at">log</span>(xs[i])<span class="op">;</span></a></code></pre></div>
<p>for-in なのに，要素(<code>1,2,3</code> の方)ではなく，インデックスが変えるのにも驚きなのだが，じつはこの <code>i</code>，文字列なのである．</p>
<div class="sourceCode" id="cb8"><pre class="sourceCode javascript"><code class="sourceCode javascript"><a class="sourceLine" id="cb8-1" data-line-number="1"><span class="cf">for</span> (<span class="kw">var</span> i <span class="kw">in</span> [<span class="dv">1</span><span class="op">,</span><span class="dv">2</span><span class="op">,</span><span class="dv">3</span>])</a>
<a class="sourceLine" id="cb8-2" data-line-number="2">  <span class="va">console</span>.<span class="at">log</span>(<span class="kw">typeof</span> i)<span class="op">;</span></a></code></pre></div>
<p>とやると <code>string</code> が変える． <code>i === xs.length - 1</code> が必ず <code>false</code> になるので気づいた． 文字列を数値に変換するだけなので，直すのは簡単．</p>
<p>ちなみに，なんでこうなってるのかとトゥートしてみたら．</p>
<p>https://qiitadon.com/<span class="citation" data-cites="okadahiroshi/37851">@okadahiroshi/37851</span></p>
<blockquote>
<p>javascript の for in はあくまでオブジェクトのプロパティー<em>名</em> に対して列挙するので、文字列になる。</p>
</blockquote>
<p>とのこと． 要するに連想配列のことも考慮してるみたい． なるほど(別の動作でいいのに)．</p>
<h2 id="公開">公開</h2>
<p>以下を参考に5ドル払って公開してみた． アイコンやスクリーンショットのサイズが厳密に決まってたのなんでなんだろう．</p>
<ul>
<li><a href="http://qiita.com/otchy/items/e29bf2e377c5b7ddc2f7">超最低限の Chrome エクステンションを開発しウェブストアで公開するまでの手順 - Qiita</a></li>
</ul>
<h2 id="使う">使う</h2>
<p><img src="../assets/make-chrome-extension-bookmark-hub/bookmark-hub-run1.jpg" /></p>
<p><img src="../assets/make-chrome-extension-bookmark-hub/bookmark-hub-run2.jpg" /></p>
<p><img src="../assets/make-chrome-extension-bookmark-hub/bookmark-hub-run3.jpg" /></p>
<h2 id="おしまい">おしまい</h2>
<p>出来たのはうれしいけど，その場しのぎでサクッと作ったのでもやぁぁっとしますね． javascript の勉強もしたいなぁ． あと，再現性の低いバグがなぁ…</p>
  </div>
</div>
</article>

          </div>
        </div>

        <footer class="site-footer">

  <div class="wrapper">

    <span class="footer-heading">ひげメモ</span>

  </div>

  <div class="page-content card" style="display: flex; justify-content: center; padding: 5px 0px">
    <a href="https://haskell.jp/blog/posts/links.html#matsubara0507.github.io">
      <img width="234" src="https://haskell.jp/img/supported-by-haskell-jp.svg" alt="Supported By Haskell-jp.">
    </a>
  </div>

</footer>


      </div>
  </body>

</html>
