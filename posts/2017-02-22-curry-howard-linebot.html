<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE html>
<html lang="ja">

  <head>
  <meta charset="utf-8">
  <link rel="icon" href="../assets/icon.jpg">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
    
      <meta property="og:title" content="Haskell で LINE Bot を作った" />
    
  

  <meta property="og:site_name" content="ひげメモ" />

  

  
    <script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-86386380-1', 'auto');
  ga('send', 'pageview');
</script>

  

  <title>
    
      
        Haskell で LINE Bot を作った
      
    
  </title>

  <link rel="stylesheet" href="../css/main.css">
  <link rel="stylesheet" href="../css/highlight.css">
  <link rel="stylesheet" type="text/css" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.4.0/css/font-awesome.min.css" />
</head>


  <body>
      <div class="outer">

        <header class="site-header">

  <div class="wrapper">

    <a class="site-title" href="https://matsubara0507.github.io/">ひげメモ</a>

  </div>

  <div class="header-badge">
    <a href="https://matsubara0507.github.io/">
        <img src="../assets/icon.jpg" />
    </a>
  </div>

</header>


        <div class="page-content">
          <div class="wrapper">
            <article class="post card" itemscope itemtype="http://schema.org/BlogPosting">
 <div class="card-content">
  <header class="post-header">
    <h1 class="post-title" itemprop="name headline">Haskell で LINE Bot を作った</h1>
    <p class="post-meta">
      <time datetime="2017-02-22" itemprop="datePublished">
        Feb 22, 2017
      </time>
      
    </p>
  </header>

  <div class="post-content" itemprop="articleBody">
    <p>GitHub で <strong>LINE Messaging API の <a href="https://github.com/noraesae/line">Haskell 版 SDK</a> があった</strong> ので作ってみた． リポジトリは<a href="https://github.com/matsubara0507/curry-howard-linebot">こちら</a>．</p>
<p>Bot の友達登録も README に載せたんでそっちからどーぞ．</p>
<h2 id="いきさつ">いきさつ</h2>
<p>先日行ってきた，エンジニアMEETUP!!で発表する用に，何かネタ感のあることをしたかった．</p>
<p>最初は LINE BOT AWARD 用に作った Score Bot の話をしようかと思ったが，話が普通すぎるので，他に何か面白そうなのが無いかを考えた結果．</p>
<h2 id="どんな-bot-か">どんな Bot か</h2>
<p>Bot 自体の機能は <strong>どーでもよかった</strong> ので適当に考える． Haskell にあやかって，Curry-Howard 同型対応を返す Bot にすることにした． 「型付きラムダ計算」って送ると「自然演繹」と返ってくるイメージ．</p>
<p>しょうもない．</p>
<h2 id="環境">環境</h2>
<h3 id="開発環境">開発環境</h3>
<p>貧乏学生なので Heroku を使おう．</p>
<ul>
<li>Windows 10 Home</li>
<li>Haskell Stack LTS 8.1 (GHC 8.02)</li>
<li>Heroku (<a href="https://github.com/mfine/heroku-buildpack-stack">stack の buildpack</a> を使う)</li>
</ul>
<h3 id="依存ライブラリ">依存ライブラリ</h3>
<p>下の2つだけ</p>
<ul>
<li>Haskell SDK for LINE Messaging API
<ul>
<li><a href="https://github.com/noraesae/line">github.com/noraesae/line</a></li>
</ul></li>
<li>Haskell Web Application Interface
<ul>
<li><a href="https://github.com/yesodweb/wai">github.com/yesodweb/wai</a></li>
</ul></li>
</ul>
<p>と，Heroku で Haskell を build するための buildpack．</p>
<ul>
<li>Heroku buildpack for Haskell Stack
<ul>
<li><a href="https://github.com/mfine/heroku-buildpack-stack">github.com/mfine/heroku-buildpack-stack</a></li>
</ul></li>
</ul>
<p>Haskell on Heroku というのもあったが，S3がどーのこーのとめんどくさそうだったので，まずは簡単そうなこっちでやってみた． で，うまくいったのでこの buildpack で十分．</p>
<h2 id="実装">実装</h2>
<h3 id="stack-と-リポジトリの準備">stack と リポジトリの準備</h3>
<p>余計かな．</p>
<pre><code>$ stack new curry-howard-linebot
$ git init</code></pre>
<p>不必要なのが多いので cabal ファイルを編集し，要らんコードを削除．</p>
<pre><code>executable curry-howard-linebot-exe
  hs-source-dirs:      app
  main-is:             Main.hs
  ghc-options:         -threaded -rtsopts -with-rtsopts=-N
  build-depends:       base
                     , line
                     , text
                     , wai
                     , warp
  default-language:    Haskell2010

source-repository head
  type:     git
  location: https://github.com/matsubara0507/curry-howard-linebot</code></pre>
<h3 id="echo-bot">echo bot</h3>
<p>まずはテストがてら echo bot を作った．</p>
<p>その時のソースコードは<a href="https://github.com/matsubara0507/curry-howard-linebot">コチラ</a>．</p>
<p>Haskell SDK にある [sample コード] が一応 echo bot を作るための handler になってるっぽい． ので，それを参考にしながら，<code>main</code> を補い，不必要な部分は削除して書いた．</p>
<div class="sourceCode"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span class="ot">{-# LANGUAGE OverloadedStrings #-}</span>

<span class="kw">module</span> <span class="dt">Main</span> <span class="kw">where</span>

<span class="kw">import </span><span class="dt">Control.Monad</span> (forM_)
<span class="kw">import </span><span class="dt">Data.Maybe</span>(fromJust)
<span class="kw">import qualified</span> <span class="dt">Data.Text</span> <span class="kw">as</span> <span class="dt">T</span> (<span class="dt">Text</span>, pack, unpack)
<span class="kw">import </span><span class="dt">Line.Messaging.API</span> ( <span class="dt">APIIO</span>, <span class="dt">APIError</span>, <span class="dt">ChannelSecret</span>, <span class="dt">ChannelAccessToken</span>
                          , <span class="dt">Message</span>(<span class="fu">..</span>), runAPI, reply)
<span class="kw">import </span><span class="dt">Line.Messaging.Webhook</span> ( <span class="dt">Event</span>(..), <span class="dt">EventMessage</span>(..), <span class="dt">ReplyToken</span>(..)
                              , <span class="dt">ReplyableEvent</span>(<span class="fu">..</span>), webhookApp
                              , defaultOnFailure, getMessage, getReplyToken)
<span class="kw">import </span><span class="dt">Line.Messaging.Types</span> (<span class="dt">Text</span>(..))
<span class="kw">import </span><span class="dt">Network.Wai</span> (<span class="dt">Application</span>)
<span class="kw">import </span><span class="dt">Network.Wai.Handler.Warp</span> (run)
<span class="kw">import </span><span class="dt">System.Environment</span> (lookupEnv)

<span class="ot">main ::</span> <span class="dt">IO</span> ()
main <span class="fu">=</span> <span class="kw">do</span>
  port <span class="ot">&lt;-</span> maybe <span class="dv">8080</span> read <span class="fu">&lt;$&gt;</span> lookupEnv <span class="st">&quot;PORT&quot;</span><span class="ot"> ::</span> <span class="dt">IO</span> <span class="dt">Int</span>
  run port app

<span class="ot">getChannelSecret ::</span> <span class="dt">IO</span> <span class="dt">ChannelSecret</span>
getChannelSecret <span class="fu">=</span> T.pack <span class="fu">.</span> fromJust <span class="fu">&lt;$&gt;</span> lookupEnv <span class="st">&quot;CHANNEL_SECRET&quot;</span>

<span class="ot">getChannelToken ::</span> <span class="dt">IO</span> <span class="dt">ChannelAccessToken</span>
getChannelToken <span class="fu">=</span> T.pack <span class="fu">.</span> fromJust <span class="fu">&lt;$&gt;</span> lookupEnv <span class="st">&quot;CHANNEL_TOKEN&quot;</span>

<span class="co">-- | A WAI application to handle webhook requests.</span>
<span class="ot">app ::</span> <span class="dt">Application</span>
app req f <span class="fu">=</span> <span class="kw">do</span>
  channelSecret <span class="ot">&lt;-</span> getChannelSecret
  webhookApp channelSecret handler defaultOnFailure req f

<span class="ot">handler ::</span> [<span class="dt">Event</span>] <span class="ot">-&gt;</span> <span class="dt">IO</span> ()
handler events <span class="fu">=</span> forM_ events handleEvent

<span class="ot">handleEvent ::</span> <span class="dt">Event</span> <span class="ot">-&gt;</span> <span class="dt">IO</span> ()
handleEvent (<span class="dt">MessageEvent</span> event) <span class="fu">=</span> handleMessageEvent event
handleEvent _ <span class="fu">=</span> return ()

<span class="ot">handleMessageEvent ::</span> <span class="dt">ReplyableEvent</span> <span class="dt">EventMessage</span> <span class="ot">-&gt;</span> <span class="dt">IO</span> ()
handleMessageEvent event <span class="fu">=</span> <span class="kw">do</span>
  <span class="kw">case</span> getMessage event <span class="kw">of</span>
    <span class="dt">TextEM</span> _ (<span class="dt">Text</span> text) <span class="ot">-&gt;</span> echo (getReplyToken event) text
    _ <span class="ot">-&gt;</span> echo (getReplyToken event) <span class="st">&quot;undefined message&quot;</span>

<span class="ot">api ::</span> <span class="dt">APIIO</span> a <span class="ot">-&gt;</span> <span class="dt">IO</span> (<span class="dt">Either</span> <span class="dt">APIError</span> a)
api <span class="fu">=</span> runAPI getChannelToken

<span class="ot">echo ::</span> <span class="dt">ReplyToken</span> <span class="ot">-&gt;</span> <span class="dt">T.Text</span> <span class="ot">-&gt;</span> <span class="dt">IO</span> ()
echo replyToken content <span class="fu">=</span> <span class="kw">do</span>
  api <span class="fu">$</span> reply replyToken [ <span class="dt">Message</span> <span class="fu">.</span> <span class="dt">Text</span> <span class="fu">$</span> content ]
  return ()</code></pre></div>
<p>LINE Bot に webhook するためにはシークレットキーが必要で，API を叩くためにはAPIトークンが必要． どちらも，環境変数から取ってきたかったので <code>loohupEnv</code> で取ってきている． エラー処理も何もしていないので，改善の余地ありですね． <code>ChannelSecret</code> 型も <code>ChannelAccessToken</code> 型も一般的な <code>Text</code> 型(lineライブラリには別の意味の <code>Text</code> 型があるので注意)のエイリアスなので，<code>T.pack</code> して変換してる．</p>
<p>他は，まぁ，Haskell で Web 系のアプリ書くと，こうなるんだろーなという感じに書いてある(サンプルそのまんま)．</p>
<h3 id="bot-の準備">Bot の準備</h3>
<p>LINE Bot のアカウントの取得と Heroku アプリを作成． それぞれ公式サイトでカチカチやってればできるはず(ないしはググれば腐るほど出てくる)．</p>
<p>カチカチして Heroku アプリを作った場合は，まずはリポジトリにリモート設定する．</p>
<pre><code>$ heroku git:remote -a &lt;app-name&gt;</code></pre>
<p>次に buildpack を設定．</p>
<pre><code>$ heroku buildpacks:set https://github.com/mfine/heroku-buildpack-stack</code></pre>
<p>そしたら後はデプロイするだけ．</p>
<pre><code>$ git push heroku master</code></pre>
<p>初めは時間がかかるけど，無事にビルド出来るはず．</p>
<h3 id="curry-howard-同型対応を返す">Curry-Howard 同型対応を返す</h3>
<p>データベースをいじるのはめんどくさいのでハードコーディング．</p>
<div class="sourceCode"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span class="ot">curryHowardCorrespondence ::</span> [([<span class="dt">Text</span>], [<span class="dt">Text</span>], <span class="dt">URL</span>)]
curryHowardCorrespondence <span class="fu">=</span>
  [ ( [<span class="st">&quot;Natural Deducation&quot;</span>, <span class="st">&quot;自然演繹&quot;</span>]
    , [<span class="st">&quot;Typed Lambda Calclus&quot;</span>, <span class="st">&quot;型付きラムダ計算&quot;</span>, <span class="st">&quot;単純型付きラムダ計算&quot;</span>, <span class="st">&quot;型付きλ計算&quot;</span>, <span class="st">&quot;単純型付きλ計算&quot;</span>]
    , <span class="st">&quot;http://disi.unitn.it/~bernardi/RSISE11/Papers/curry-howard.pdf&quot;</span>)
  , ( [<span class="st">&quot;Sequent Calculus&quot;</span>, <span class="st">&quot;シーケント計算&quot;</span>]
    , [<span class="st">&quot;Typed Lambda Calclus&quot;</span>, <span class="st">&quot;型付きラムダ計算&quot;</span>, <span class="st">&quot;単純型付きラムダ計算&quot;</span>, <span class="st">&quot;型付きλ計算&quot;</span>, <span class="st">&quot;単純型付きλ計算&quot;</span>]
    , <span class="st">&quot;http://disi.unitn.it/~bernardi/RSISE11/Papers/curry-howard.pdf&quot;</span>)
  , ( [<span class="st">&quot;System F&quot;</span>]
    , [<span class="st">&quot;Polymorphic Lambda Calculus&quot;</span>, <span class="st">&quot;2階ラムダ計算&quot;</span>, <span class="st">&quot;多相ラムダ計算&quot;</span>, <span class="st">&quot;2階λ計算&quot;</span>, <span class="st">&quot;多相λ計算&quot;</span>]
    , <span class="st">&quot;http://disi.unitn.it/~bernardi/RSISE11/Papers/curry-howard.pdf&quot;</span>)
  , ( [<span class="st">&quot;Modal Logic&quot;</span>, <span class="st">&quot;様相論理&quot;</span>]
    , [<span class="st">&quot;Mondad&quot;</span>, <span class="st">&quot;モナド&quot;</span>]
    , <span class="st">&quot;http://www.sciencedirect.com/science/article/pii/S0304397596001697&quot;</span>)
  , ( [<span class="st">&quot;Linear Logic&quot;</span>, <span class="st">&quot;線形論理&quot;</span>]
    , [<span class="st">&quot;Session Type&quot;</span>, <span class="st">&quot;セッション型&quot;</span>]
    , <span class="st">&quot;http://ctp.di.fct.unl.pt/~btoninho/mscs12.pdf&quot;</span>)
  ]</code></pre></div>
<p>対応表は<a href>このスライド</a>を参考にして証明が載ってそうな論文を探した(大変)．</p>
<p>これを参照して取ってくるように echo bot を書き換える． Haskell プログラミングはトップダウン．</p>
<div class="sourceCode"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span class="ot">handleMessageEvent ::</span> <span class="dt">ReplyableEvent</span> <span class="dt">EventMessage</span> <span class="ot">-&gt;</span> <span class="dt">IO</span> ()
handleMessageEvent event <span class="fu">=</span> <span class="kw">do</span>
  <span class="kw">case</span> getMessage event <span class="kw">of</span>
    <span class="dt">TextEM</span> _ (<span class="dt">Text</span> text) <span class="ot">-&gt;</span> echo (getReplyToken event) (getCorrespondence text)
    _ <span class="ot">-&gt;</span> echo (getReplyToken event) <span class="st">&quot;undefined message&quot;</span>

<span class="ot">getCorrespondence ::</span> <span class="dt">Text</span> <span class="ot">-&gt;</span> <span class="dt">Text</span>
getCorrespondence <span class="fu">=</span> undefined</code></pre></div>
<p>見つからない場合を考慮して分ける．</p>
<div class="sourceCode"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span class="ot">getCorrespondence ::</span> <span class="dt">Text</span> <span class="ot">-&gt;</span> <span class="dt">Text</span>
getCorrespondence <span class="fu">=</span> fromMaybe <span class="st">&quot;unknown...&quot;</span> <span class="fu">.</span> lookupCorrespondence

<span class="ot">lookupCorrespondence ::</span> <span class="dt">Text</span> <span class="ot">-&gt;</span> <span class="dt">Maybe</span> <span class="dt">Text</span>
lookupCorrespondence txt <span class="fu">=</span> undefined</code></pre></div>
<p>あとは適当に</p>
<div class="sourceCode"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span class="ot">lookupCorrespondence ::</span> <span class="dt">Text</span> <span class="ot">-&gt;</span> <span class="dt">Maybe</span> <span class="dt">Text</span>
lookupCorrespondence txt <span class="fu">=</span> msum <span class="fu">$</span> fmap match curryHowardCorrespondence
  <span class="kw">where</span>
    txt' <span class="fu">=</span> toLower txt
    match (as, bs, url)
      <span class="fu">|</span> any ((<span class="fu">==</span>) txt' <span class="fu">.</span> toLower) as <span class="fu">=</span> appendUrl url <span class="fu">&lt;$&gt;</span> safeHead bs
      <span class="fu">|</span> any ((<span class="fu">==</span>) txt' <span class="fu">.</span> toLower) bs <span class="fu">=</span> appendUrl url <span class="fu">&lt;$&gt;</span> safeHead as
      <span class="fu">|</span> otherwise <span class="fu">=</span> <span class="dt">Nothing</span>

<span class="ot">appendUrl ::</span> <span class="dt">URL</span> <span class="ot">-&gt;</span> <span class="dt">Text</span> <span class="ot">-&gt;</span> <span class="dt">Text</span>
appendUrl url <span class="fu">=</span> unwords <span class="fu">.</span> (<span class="fu">:</span> [url])

<span class="ot">safeHead ::</span> [a] <span class="ot">-&gt;</span> <span class="dt">Maybe</span> a
safeHead <span class="fu">=</span> find (const <span class="dt">True</span>)</code></pre></div>
<p><code>toLower</code> してるのは英字の大文字小文字の違いを無視するため．</p>
<h2 id="実行">実行</h2>
<div class="figure">
<img src="../assets/curry-howard-linebot/demo.gif" />

</div>
<h2 id="おしまい">おしまい</h2>
<p>一日ぐらいでサクッと作れた． LINE Bot に慣れたというのもあるが，それ以上にライブラリのおかげでしょう．</p>
<p>最初に <code>stack build</code> した時に，2,3個しか依存するライブラリ書いてないのに，100個ほどインストール(依存ライブラリに依存するライブラリを含む)されたときには，「巨人の肩に乗ってるなー」と感じた．</p>
  </div>
</div>
</article>

          </div>
        </div>

        <footer class="site-footer">

  <div class="wrapper">

    <span class="footer-heading">ひげメモ</span>

  </div>

</footer>


      </div>
  </body>

</html>
