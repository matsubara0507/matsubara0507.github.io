<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE html>
<html lang="ja">

  <head>
  <meta charset="utf-8">
  <link rel="icon" href="../assets/icon.jpg">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
    
      <meta property="og:title" content="Drone 1.0 を GCE 上に構築する" />
    
  

  <meta property="og:site_name" content="ひげメモ" />

  
    <meta property="og:image" content="/assets/drone-1-0-in-gce/my-drone-example.jpg" />
  

  
    <script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-86386380-1', 'auto');
  ga('send', 'pageview');
</script>

  

  <title>
    
      
        Drone 1.0 を GCE 上に構築する
      
    
  </title>

  <link rel="stylesheet" href="../css/main.css">
  <link rel="stylesheet" href="../css/highlight.css">
  <link rel="stylesheet" type="text/css" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.4.0/css/font-awesome.min.css" />
</head>


  <body>
      <div class="outer">

        <header class="site-header">

  <div class="wrapper">

    <a class="site-title" href="https://matsubara0507.github.io/">ひげメモ</a>

  </div>

  <div class="header-badge">
    <a href="https://matsubara0507.github.io/">
        <img src="../assets/icon.jpg" />
    </a>
  </div>

</header>


        <div class="page-content">
          <div class="wrapper">
            <article class="post card" itemscope itemtype="http://schema.org/BlogPosting">
 <div class="card-content">
  <header class="post-header">
    <h1 class="post-title" itemprop="name headline">Drone 1.0 を GCE 上に構築する</h1>
    <p class="post-meta">
      <time datetime="2019-04-06" itemprop="datePublished">
        Apr 6, 2019
      </time>
      
      
      <div class="tags">
          <i class="fa fa-tags"></i> <a href="../tags/Drone.html">Drone</a> <a href="../tags/GCP.html">GCP</a>
      </div>
      
    </p>
  </header>

  <div class="post-content" itemprop="articleBody">
    <p>先月ついに <a href="https://drone.io/">Drone CI</a> のバージョン1.0がリリースされました(rc でも無い方)． まだドキュメントの方が追いついてないところもありますが，これで大手を振って本番導入できますね！</p>
<p>で，別に本番導入したわけじゃ無いんですけど，とあるイベントで Drone CI を使いたかったので GCE 上に立てました． 本記事はそのメモ書きです．</p>
<h2 id="drone-ci">Drone CI</h2>
<p>Jenkins のような OSS な CI/CD プラットフォーム． 使い勝手的には TravisCI や CircleCI に近く、<code>.drone.yml</code> という設定ファイルにパイプラインを使って記述する:</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode yaml"><code class="sourceCode yaml"><a class="sourceLine" id="cb1-1" title="1"><span class="fu">kind:</span><span class="at"> pipeline</span></a>
<a class="sourceLine" id="cb1-2" title="2"><span class="fu">steps:</span></a>
<a class="sourceLine" id="cb1-3" title="3"><span class="kw">-</span> <span class="fu">name:</span><span class="at"> test</span></a>
<a class="sourceLine" id="cb1-4" title="4">  <span class="fu">image:</span><span class="at"> node</span></a>
<a class="sourceLine" id="cb1-5" title="5">  <span class="fu">commands:</span></a>
<a class="sourceLine" id="cb1-6" title="6">  <span class="kw">-</span> npm install</a>
<a class="sourceLine" id="cb1-7" title="7">  <span class="kw">-</span> npm test</a>
<a class="sourceLine" id="cb1-8" title="8"><span class="fu">services:</span></a>
<a class="sourceLine" id="cb1-9" title="9"><span class="kw">-</span> <span class="fu">name:</span><span class="at"> database</span></a>
<a class="sourceLine" id="cb1-10" title="10">  <span class="fu">image:</span><span class="at"> mysql</span></a>
<a class="sourceLine" id="cb1-11" title="11">  <span class="fu">ports:</span></a>
<a class="sourceLine" id="cb1-12" title="12">  <span class="kw">-</span> <span class="dv">3306</span></a></code></pre></div>
<p>Go言語製で，Docker との親和性がかなり高いという特徴を持っている． また，<a href="https://cloud.drone.io/">Drone Cloud</a> というクラウドサービスも提供されているので，とりあえず試したい人はぜひ．</p>
<h2 id="drone-on-gcp">Drone on GCP</h2>
<p>Drone 自体は Docker で起動できる(<a href="https://docs.drone.io/installation">公式ドキュメント</a>)． docker-compose を次のように記述することで簡単に起動可能だ:</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode yaml"><code class="sourceCode yaml"><a class="sourceLine" id="cb2-1" title="1"><span class="fu">version:</span><span class="at"> </span><span class="st">'2'</span></a>
<a class="sourceLine" id="cb2-2" title="2"></a>
<a class="sourceLine" id="cb2-3" title="3"><span class="fu">services:</span></a>
<a class="sourceLine" id="cb2-4" title="4">  <span class="fu">drone:</span></a>
<a class="sourceLine" id="cb2-5" title="5">    <span class="fu">image:</span><span class="at"> drone/drone:1</span></a>
<a class="sourceLine" id="cb2-6" title="6">    <span class="fu">ports:</span></a>
<a class="sourceLine" id="cb2-7" title="7">      <span class="kw">-</span> 8000:80</a>
<a class="sourceLine" id="cb2-8" title="8">      <span class="kw">-</span> 443:443</a>
<a class="sourceLine" id="cb2-9" title="9">    <span class="fu">volumes:</span></a>
<a class="sourceLine" id="cb2-10" title="10">      <span class="kw">-</span> /var/run/docker.sock:/var/run/docker.sock</a>
<a class="sourceLine" id="cb2-11" title="11">      <span class="kw">-</span> /var/lib/drone:/data</a>
<a class="sourceLine" id="cb2-12" title="12">    <span class="fu">restart:</span><span class="at"> always</span></a>
<a class="sourceLine" id="cb2-13" title="13">    <span class="fu">environment:</span></a>
<a class="sourceLine" id="cb2-14" title="14">      <span class="kw">-</span> DRONE_GITHUB_SERVER=https://github.com</a>
<a class="sourceLine" id="cb2-15" title="15">      <span class="kw">-</span> DRONE_GITHUB_CLIENT_ID=$<span class="kw">{</span>DRONE_GITHUB_CLIENT<span class="kw">}</span></a>
<a class="sourceLine" id="cb2-16" title="16">      <span class="kw">-</span> DRONE_GITHUB_CLIENT_SECRET=$<span class="kw">{</span>DRONE_GITHUB_SECRET<span class="kw">}</span></a>
<a class="sourceLine" id="cb2-17" title="17">      <span class="kw">-</span> DRONE_AGENTS_ENABLED=true</a>
<a class="sourceLine" id="cb2-18" title="18">      <span class="kw">-</span> DRONE_RPC_SECRET=$<span class="kw">{</span>DRONE_SECRET<span class="kw">}</span></a>
<a class="sourceLine" id="cb2-19" title="19">      <span class="kw">-</span> DRONE_SERVER_HOST=$<span class="kw">{</span>DRONE_HOST<span class="kw">}</span></a>
<a class="sourceLine" id="cb2-20" title="20">      <span class="kw">-</span> DRONE_SERVER_PROTO=https</a>
<a class="sourceLine" id="cb2-21" title="21">      <span class="kw">-</span> DRONE_TLS_AUTOCERT=true</a>
<a class="sourceLine" id="cb2-22" title="22"></a>
<a class="sourceLine" id="cb2-23" title="23">  <span class="fu">agent:</span></a>
<a class="sourceLine" id="cb2-24" title="24">    <span class="fu">image:</span><span class="at"> drone/agent:1</span></a>
<a class="sourceLine" id="cb2-25" title="25">    <span class="fu">restart:</span><span class="at"> always</span></a>
<a class="sourceLine" id="cb2-26" title="26">    <span class="fu">depends_on:</span></a>
<a class="sourceLine" id="cb2-27" title="27">      <span class="kw">-</span> drone</a>
<a class="sourceLine" id="cb2-28" title="28">    <span class="fu">volumes:</span></a>
<a class="sourceLine" id="cb2-29" title="29">      <span class="kw">-</span> /var/run/docker.sock:/var/run/docker.sock</a>
<a class="sourceLine" id="cb2-30" title="30">    <span class="fu">environment:</span></a>
<a class="sourceLine" id="cb2-31" title="31">      <span class="kw">-</span> DRONE_RPC_SERVER=http://drone</a>
<a class="sourceLine" id="cb2-32" title="32">      <span class="kw">-</span> DRONE_RPC_SECRET=$<span class="kw">{</span>DRONE_SECRET<span class="kw">}</span></a>
<a class="sourceLine" id="cb2-33" title="33">      <span class="kw">-</span> DRONE_RUNNER_CAPACITY=2</a>
<a class="sourceLine" id="cb2-34" title="34">      <span class="kw">-</span> DRONE_RUNNER_NAME=$<span class="kw">{</span>HOSTNAME<span class="kw">}</span></a></code></pre></div>
<p>(<a href="../posts/2019-01-05-docker-compose-up-drone-1-0.html">ローカルで試す話は前に書いた</a>)</p>
<p>今回はこれを GCE 上でやることにした(GKE を試そうとも思ったが，まだ時期尚早って感じだったのでやめた)．</p>
<h3 id="gcpでの準備">GCPでの準備</h3>
<p>HTTPS 通信をやりたいのでドメインの取得をし，HTTP(S) LB と Managed SSL を使って簡単に証明書を発行することにした． この仕組みは下記の記事を参考にした:</p>
<ul>
<li><a href="https://qiita.com/koshilife/items/a75a69d03e2524f33c8e">GCP managed SSL(β版)を利用したhttpsサーバ構築 - Qiita</a></li>
</ul>
<p>β版だったためか，ところどころ違った気がするけど概ね記事の通りできた．</p>
<ol type="1">
<li>GCEインスタンスを立てる
<ul>
<li>スペックは <code>n1-standard-1（vCPU x 1、メモリ 3.75 GB）+ 10GB disk</code> にした</li>
<li>HTTPアクセスを許可しておく</li>
</ul></li>
<li>インスタンスグループを作成</li>
<li>HTTP(S) LB を作成
<ul>
<li>バックエンド: (2)のインスタンスグループを選んで他はデフォルト値</li>
<li>ホストとパスのルール: 特になし</li>
<li>フロントエンド: エフェラメルIPでHTTP/HTTPSの2つを作成</li>
</ul></li>
<li>DNSのAレコードを作成
<ul>
<li>有効化されるのに長いと1時間ぐらいかかる</li>
</ul></li>
</ol>
<p>ドメインは Google Domain で取得したのだが，そっちの DNS 設定を切っておくのを忘れて有効化に失敗していた．</p>
<h3 id="drone-の準備と起動">Drone の準備と起動</h3>
<p>上記手順の(1)で以下のプログラムをインストール:</p>
<ul>
<li><code>docker</code></li>
<li><code>docker-compose</code></li>
<li><code>nginx</code></li>
</ul>
<p>nginx の設定は雑に次のような感じ(<a href="https://angristan.xyz/host-your-own-ci-cd-server-with-drone/">参考</a>):</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode conf"><code class="sourceCode ini"><a class="sourceLine" id="cb3-1" title="1"><span class="dt">server {</span></a>
<a class="sourceLine" id="cb3-2" title="2"><span class="dt">  listen 80 default_server;</span></a>
<a class="sourceLine" id="cb3-3" title="3"><span class="dt">  listen </span><span class="kw">[::]</span><span class="dt">:80 default_server;</span></a>
<a class="sourceLine" id="cb3-4" title="4"><span class="dt">  server_name _;</span></a>
<a class="sourceLine" id="cb3-5" title="5"><span class="dt">  return 444;</span></a>
<a class="sourceLine" id="cb3-6" title="6"><span class="dt">}</span></a>
<a class="sourceLine" id="cb3-7" title="7"></a>
<a class="sourceLine" id="cb3-8" title="8"><span class="dt">server {</span></a>
<a class="sourceLine" id="cb3-9" title="9"><span class="dt">  listen 80;</span></a>
<a class="sourceLine" id="cb3-10" title="10"><span class="dt">  server_name </span><span class="kw">[(4)で設定するドメイン]</span><span class="dt">;</span></a>
<a class="sourceLine" id="cb3-11" title="11"></a>
<a class="sourceLine" id="cb3-12" title="12"><span class="dt">  if ($http_x_forwarded_proto </span><span class="ot">=</span><span class="st"> 'http') {</span></a>
<a class="sourceLine" id="cb3-13" title="13"><span class="dt">    return 301 https://$server_name$request_uri;</span></a>
<a class="sourceLine" id="cb3-14" title="14"><span class="dt">  }</span></a>
<a class="sourceLine" id="cb3-15" title="15"></a>
<a class="sourceLine" id="cb3-16" title="16"><span class="dt">  location / {</span></a>
<a class="sourceLine" id="cb3-17" title="17"><span class="dt">    proxy_set_header Host $http_host;</span></a>
<a class="sourceLine" id="cb3-18" title="18"><span class="dt">    proxy_set_header X-Real-IP $remote_addr;</span></a>
<a class="sourceLine" id="cb3-19" title="19"><span class="dt">    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;</span></a>
<a class="sourceLine" id="cb3-20" title="20"><span class="dt">    proxy_set_header X-Forwarded-Proto $scheme;</span></a>
<a class="sourceLine" id="cb3-21" title="21"><span class="dt">    proxy_pass http://localhost:8000;</span></a>
<a class="sourceLine" id="cb3-22" title="22"><span class="dt">    proxy_redirect off;</span></a>
<a class="sourceLine" id="cb3-23" title="23"><span class="dt">    proxy_buffering off;</span></a>
<a class="sourceLine" id="cb3-24" title="24"><span class="dt">    chunked_transfer_encoding off;</span></a>
<a class="sourceLine" id="cb3-25" title="25"><span class="dt">  }</span></a>
<a class="sourceLine" id="cb3-26" title="26"><span class="dt">}</span></a></code></pre></div>
<p>これで (4) で設定したドメインの HTTPS 通信のみ許可するようになった． あとは適当なところで <code>docker-compose up -d</code> とすれば良い．</p>
<p><img src="../assets/drone-1-0-in-gce/my-drone-example.jpg" /></p>
<h2 id="おまけ">おまけ</h2>
<h3 id="drone-起動時の環境変数">Drone 起動時の環境変数</h3>
<p>このあたりのを適宜使った:</p>
<ul>
<li>DRONE_USER_FILTER
<ul>
<li>認証後に閲覧できるユーザーを絞る</li>
<li>ただし Public は誰でも見れる(はず)</li>
<li>ちなみに Internal はここで指定したユーザー全員が見れる</li>
</ul></li>
<li>DRONE_USER_CREATE
<ul>
<li>Admin ユーザーみたいな感じ</li>
</ul></li>
<li>DRONE_LOGS_DEBUG,DRONE_LOGS_TRACE
<ul>
<li>この二つをオンにしておくと <code>docker logs</code> でだいたいログを追える</li>
</ul></li>
</ul>
<h3 id="drone-の情報">Drone の情報</h3>
<p>冒頭で述べた通り，Drone の公式情報は綺麗にまとまってるとは言い難い． 基本は以下の公式ドキュメント:</p>
<ul>
<li><a href="https://docs.drone.io/">Drone Documentation</a></li>
</ul>
<p><code>.drone.yml</code> の書き方はここにまとまってるので Drone CI を使うってだけならここで概ね問題ないでしょう． API を使ったり，drone-cli を使ったり，コンテナ起動時の設定を調べたりは情報が足りない時がちょくちょくある． Drone は <a href="https://github.com/search?q=org%3Adrone&amp;type=Issues">GitHub Issue</a> の他に <a href="https://discourse.org/">Discourse</a> というサービスを使っている:</p>
<ul>
<li><a href="https://discourse.drone.io/">Drone</a></li>
</ul>
<p>具体的なエラーなんかは StackOverflow よりここを検索した方が見つかる． またチャットサービスとして Gitter も用意しているので，そこに聞きに行ってもいいかもしれない:</p>
<ul>
<li><a href="https://gitter.im/drone/home">drone/home - Gitter</a></li>
</ul>
<p>まぁあとは OSS なので直接コードを観に行けばだいたい仕様はわかる． 特に，API に関する情報は 0.8 以前の古いものしかなく，<a href="https://github.com/matsubara0507/drone-haskell">Haskell の Drone クライアント</a>を作るときは直接ソースコードを見ていた:</p>
<ul>
<li><a href="https://github.com/drone/drone">drone/drone - GitHub</a>: <code>handler/api</code> とか見ると良い</li>
<li><a href="https://github.com/drone/drone-go">drone/drone-go - GitHub</a>: Drone API の Go クライアント</li>
</ul>
<h1 id="おしまい">おしまい</h1>
  </div>
</div>
</article>

          </div>
        </div>

        <footer class="site-footer">

  <div class="wrapper">

    <span class="footer-heading">ひげメモ</span>

  </div>

  <div class="page-content card" style="display: flex; justify-content: center; padding: 5px 0px">
    <a href="https://haskell.jp/blog/posts/links.html#matsubara0507.github.io">
      <img width="234" src="https://haskell.jp/img/supported-by-haskell-jp.svg" alt="Supported By Haskell-jp.">
    </a>
  </div>

</footer>


      </div>
  </body>

</html>
