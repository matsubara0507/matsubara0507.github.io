<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE html>
<html lang="ja">

  <head>
  <meta charset="utf-8">
  <link rel="icon" href="../assets/icon.jpg">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
    
      <meta property="og:title" content="req を使って REST API Haskell パッケージを作る その１" />
    
  

  <meta property="og:site_name" content="ひげメモ" />

  

  
    <script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-86386380-1', 'auto');
  ga('send', 'pageview');
</script>

  

  <title>
    
      
        req を使って REST API Haskell パッケージを作る その１
      
    
  </title>

  <link rel="stylesheet" href="../css/main.css">
  <link rel="stylesheet" href="../css/highlight.css">
  <link rel="stylesheet" type="text/css" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.4.0/css/font-awesome.min.css" />
</head>


  <body>
      <div class="outer">

        <header class="site-header">

  <div class="wrapper">

    <a class="site-title" href="https://matsubara0507.github.io/">ひげメモ</a>

  </div>

  <div class="header-badge">
    <a href="https://matsubara0507.github.io/">
        <img src="../assets/icon.jpg" />
    </a>
  </div>

</header>


        <div class="page-content">
          <div class="wrapper">
            <article class="post card" itemscope itemtype="http://schema.org/BlogPosting">
 <div class="card-content">
  <header class="post-header">
    <h1 class="post-title" itemprop="name headline">req を使って REST API Haskell パッケージを作る その１</h1>
    <p class="post-meta">
      <time datetime="2017-08-07" itemprop="datePublished">
        Aug 7, 2017
      </time>
      
      
      <div class="tags">
          <i class="fa fa-tags"></i> <a href="../tags/Haskell.html">Haskell</a> <a href="../tags/library.html">library</a>
      </div>
      
    </p>
  </header>

  <div class="post-content" itemprop="articleBody">
    <p>こういう名前は正しくないかもしれないが，ここでは REST API パッケージ(ライブラリ)とは，既存の REST API を走査するための Haskell パッケージのことを指してる． 例えば，既にあるものだと，<a href="https://developer.github.com/v3/">GitHub API</a> の <a href="http://hackage.haskell.org/package/github"><code>github</code></a> や <a href="https://api.slack.com/">Slack API</a> の <a href="https://hackage.haskell.org/package/slack-api"><code>slack-api</code></a> などがある．</p>
<p>今回はとある事情で，<a href="http://developer.chatwork.com/">ChatWork API</a> の Haskell パッケージを <a href="https://hackage.haskell.org/package/req"><code>req</code></a> ライブラリを使って作ったので，その過程を残しておく．</p>
<p>ちなみに，完成品は<a href="https://github.com/matsubara0507/chatwork">ココ</a>にある．</p>
<h2 id="いきさつ">いきさつ</h2>
<p>Haskell でプログラミングする(別に Haskell だけではないけど)アルバイトをしてて，そこで ChatWork API を走査する Haskell パッケージが無いから作ってと言われた． だけ．</p>
<h3 id="なぜ-req-か">なぜ <code>req</code> か</h3>
<p>他に同種の有名なものには以下のものがある．</p>
<ul>
<li><a href="https://github.com/snoyberg/http-client"><code>http-client</code></a></li>
<li><a href="https://github.com/snoyberg/http-client/tree/master/http-conduit"><code>http-conduit</code></a></li>
<li><a href="https://hackage.haskell.org/package/wreq"><code>wreq</code></a></li>
</ul>
<p><code>http-client</code> は “同種” というと語弊がある． <code>req</code> を含め，他の3つのライブラリのベースになるような，低レイヤーのライブラリだ． ちなみに，<code>github</code> ライブラリは <code>http-client</code> を直接使っている．</p>
<h2 id="section"></h2>
<p><code>http-conduit</code> は <code>http-client</code> と同じリポジトリで開発されてるだけあって，<code>http-client</code> の割と公式的な高レイヤーライブラリなのかもしれない． 事実多くの REST API ライブラリが <code>http-conduit</code> を採用している．</p>
<ul>
<li><a href="https://hackage.haskell.org/package/aws">aws: Amazon Web Services (AWS) for Haskell</a></li>
<li><a href="https://hackage.haskell.org/package/fb">fb: Bindings to Facebook’s API.</a></li>
<li><a href="https://hackage.haskell.org/package/twitter-conduit">twitter-conduit: Twitter API package with conduit interface and Streaming API support.</a></li>
</ul>
<p>日本語の使い方を紹介した記事もあった．</p>
<ul>
<li><a href="http://qiita.com/lotz/items/f8440fa08a62d1c44e1a">Haskellから簡単にWeb APIを叩く方法 - Qiita</a></li>
</ul>
<p>なぜ，<code>http-conduit</code> を使わなかったかと言うと，<code>conduit</code> ありきなのに少し抵抗があったからだ． <strong>実際に使ったことは無いので，ありきでは無いかもしれないけど</strong>．</p>
<h2 id="section-1"></h2>
<p><code>wreq</code> は <code>slack-api</code> で使われている． 最近の Reddit のコメントを見ると，この手のものであれば，一番有名なのだろうか？</p>
<ul>
<li><a href="https://www.reddit.com/r/haskell/comments/6ra2sv/which_libraries_should_i_use_for_writing_a_simple/">Which libraries should I use for writing a simple REST web client? : haskell</a></li>
</ul>
<h2 id="section-2"></h2>
<p>で，実は <code>req</code> には「何故これらのライブラリがあるのに新しく開発したのか」が<a href="https://hackage.haskell.org/package/req#motivation-and-req-vs-other-libraries">書いてあった</a>． その中に <code>wreq</code> の開発が遅いから <code>req</code> 作った，的なことが書いてあった．</p>
<p>どーせ新しく作るなら，割と活発のモノの方がいいかなという(軽い)理由で <code>req</code> を使うことにした． もっと本音を言えば，良さそうな割に<a href="https://github.com/search?q=req+extension%3A.cabal&amp;type=Code&amp;ref=advsearch">あんまり使ってる人いない</a>感じだったので，目立つかなぁという下心もあった(笑)</p>
<h2 id="作る">作る</h2>
<p>ずいぶん余計な話が長くなったが，ここから本題．</p>
<h2 id="ちなみに">ちなみに</h2>
<p><code>curl</code> を使う場合は次のように書く．</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb1-1"><a href="#cb1-1"></a><span class="ex">curl</span> -X GET -H <span class="st">&quot;X-ChatWorkToken: XXXXX&quot;</span> <span class="st">&quot;https://api.chatwork.com/v2/me&quot;</span></span></code></pre></div>
<p><code>XXXXX</code> が発行したトークン．</p>
<h3 id="返ってくる-json-の型を作る">返ってくる JSON の型を作る</h3>
<p><a href="http://developer.chatwork.com/ja/endpoint_me.html"><code>https://api.chatwork.com/v2/me</code></a> というエンドポイントを考える．</p>
<p>返ってくる JSON は次のような感じ．</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode json"><code class="sourceCode json"><span id="cb2-1"><a href="#cb2-1"></a><span class="fu">{</span></span>
<span id="cb2-2"><a href="#cb2-2"></a>  <span class="dt">&quot;account_id&quot;</span><span class="fu">:</span> <span class="dv">123</span><span class="fu">,</span></span>
<span id="cb2-3"><a href="#cb2-3"></a>  <span class="dt">&quot;room_id&quot;</span><span class="fu">:</span> <span class="dv">322</span><span class="fu">,</span></span>
<span id="cb2-4"><a href="#cb2-4"></a>  <span class="dt">&quot;name&quot;</span><span class="fu">:</span> <span class="st">&quot;John Smith&quot;</span><span class="fu">,</span></span>
<span id="cb2-5"><a href="#cb2-5"></a>  <span class="dt">&quot;chatwork_id&quot;</span><span class="fu">:</span> <span class="st">&quot;tarochatworkid&quot;</span><span class="fu">,</span></span>
<span id="cb2-6"><a href="#cb2-6"></a>  <span class="dt">&quot;organization_id&quot;</span><span class="fu">:</span> <span class="dv">101</span><span class="fu">,</span></span>
<span id="cb2-7"><a href="#cb2-7"></a>  <span class="dt">&quot;organization_name&quot;</span><span class="fu">:</span> <span class="st">&quot;Hello Company&quot;</span><span class="fu">,</span></span>
<span id="cb2-8"><a href="#cb2-8"></a>  <span class="dt">&quot;department&quot;</span><span class="fu">:</span> <span class="st">&quot;Marketing&quot;</span><span class="fu">,</span></span>
<span id="cb2-9"><a href="#cb2-9"></a>  <span class="dt">&quot;title&quot;</span><span class="fu">:</span> <span class="st">&quot;CMO&quot;</span><span class="fu">,</span></span>
<span id="cb2-10"><a href="#cb2-10"></a>  <span class="dt">&quot;url&quot;</span><span class="fu">:</span> <span class="st">&quot;http://mycompany.com&quot;</span><span class="fu">,</span></span>
<span id="cb2-11"><a href="#cb2-11"></a>  <span class="dt">&quot;introduction&quot;</span><span class="fu">:</span> <span class="st">&quot;Self Introduction&quot;</span><span class="fu">,</span></span>
<span id="cb2-12"><a href="#cb2-12"></a>  <span class="dt">&quot;mail&quot;</span><span class="fu">:</span> <span class="st">&quot;taro@example.com&quot;</span><span class="fu">,</span></span>
<span id="cb2-13"><a href="#cb2-13"></a>  <span class="dt">&quot;tel_organization&quot;</span><span class="fu">:</span> <span class="st">&quot;XXX-XXXX-XXXX&quot;</span><span class="fu">,</span></span>
<span id="cb2-14"><a href="#cb2-14"></a>  <span class="dt">&quot;tel_extension&quot;</span><span class="fu">:</span> <span class="st">&quot;YYY-YYYY-YYYY&quot;</span><span class="fu">,</span></span>
<span id="cb2-15"><a href="#cb2-15"></a>  <span class="dt">&quot;tel_mobile&quot;</span><span class="fu">:</span> <span class="st">&quot;ZZZ-ZZZZ-ZZZZ&quot;</span><span class="fu">,</span></span>
<span id="cb2-16"><a href="#cb2-16"></a>  <span class="dt">&quot;skype&quot;</span><span class="fu">:</span> <span class="st">&quot;myskype_id&quot;</span><span class="fu">,</span></span>
<span id="cb2-17"><a href="#cb2-17"></a>  <span class="dt">&quot;facebook&quot;</span><span class="fu">:</span> <span class="st">&quot;myfacebook_id&quot;</span><span class="fu">,</span></span>
<span id="cb2-18"><a href="#cb2-18"></a>  <span class="dt">&quot;twitter&quot;</span><span class="fu">:</span> <span class="st">&quot;mytwitter_id&quot;</span><span class="fu">,</span></span>
<span id="cb2-19"><a href="#cb2-19"></a>  <span class="dt">&quot;avatar_image_url&quot;</span><span class="fu">:</span> <span class="st">&quot;https://example.com/abc.png&quot;</span></span>
<span id="cb2-20"><a href="#cb2-20"></a><span class="fu">}</span></span></code></pre></div>
<p>コレをレコードで表現する． どう考えても <code>account_id</code> とか <code>name</code> とかが重複しそうなので適当なプレフィックスを付ける(ダサいけど…)．</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb3-1"><a href="#cb3-1"></a><span class="kw">import</span> <span class="dt">Data.Text</span> (<span class="dt">Text</span>)</span>
<span id="cb3-2"><a href="#cb3-2"></a><span class="kw">import</span> <span class="dt">GHC.Generic</span> (<span class="dt">Generic</span>)</span>
<span id="cb3-3"><a href="#cb3-3"></a></span>
<span id="cb3-4"><a href="#cb3-4"></a><span class="kw">data</span> <span class="dt">Me</span> <span class="ot">=</span> <span class="dt">Me</span></span>
<span id="cb3-5"><a href="#cb3-5"></a>         {<span class="ot"> meToAccountId        ::</span> <span class="dt">Int</span></span>
<span id="cb3-6"><a href="#cb3-6"></a>         ,<span class="ot"> meToRoomId           ::</span> <span class="dt">Int</span></span>
<span id="cb3-7"><a href="#cb3-7"></a>         ,<span class="ot"> meToName             ::</span> <span class="dt">Text</span></span>
<span id="cb3-8"><a href="#cb3-8"></a>         ,<span class="ot"> meToChatworkId       ::</span> <span class="dt">Text</span></span>
<span id="cb3-9"><a href="#cb3-9"></a>         ,<span class="ot"> meToOrganizationId   ::</span> <span class="dt">Int</span></span>
<span id="cb3-10"><a href="#cb3-10"></a>         ,<span class="ot"> meToOrganizationName ::</span> <span class="dt">Text</span></span>
<span id="cb3-11"><a href="#cb3-11"></a>         ,<span class="ot"> meToDepartment       ::</span> <span class="dt">Text</span></span>
<span id="cb3-12"><a href="#cb3-12"></a>         ,<span class="ot"> meToTitle            ::</span> <span class="dt">Text</span></span>
<span id="cb3-13"><a href="#cb3-13"></a>         ,<span class="ot"> meToUrl              ::</span> <span class="dt">Text</span></span>
<span id="cb3-14"><a href="#cb3-14"></a>         ,<span class="ot"> meToIntroduction     ::</span> <span class="dt">Text</span></span>
<span id="cb3-15"><a href="#cb3-15"></a>         ,<span class="ot"> meToMail             ::</span> <span class="dt">Text</span></span>
<span id="cb3-16"><a href="#cb3-16"></a>         ,<span class="ot"> meToTelOrganization  ::</span> <span class="dt">Text</span></span>
<span id="cb3-17"><a href="#cb3-17"></a>         ,<span class="ot"> meToTelExtension     ::</span> <span class="dt">Text</span></span>
<span id="cb3-18"><a href="#cb3-18"></a>         ,<span class="ot"> meToTelMobile        ::</span> <span class="dt">Text</span></span>
<span id="cb3-19"><a href="#cb3-19"></a>         ,<span class="ot"> meToSkype            ::</span> <span class="dt">Text</span></span>
<span id="cb3-20"><a href="#cb3-20"></a>         ,<span class="ot"> meToFacebook         ::</span> <span class="dt">Text</span></span>
<span id="cb3-21"><a href="#cb3-21"></a>         ,<span class="ot"> meToTwitter          ::</span> <span class="dt">Text</span></span>
<span id="cb3-22"><a href="#cb3-22"></a>         ,<span class="ot"> meToAvatarImageUrl   ::</span> <span class="dt">Text</span></span>
<span id="cb3-23"><a href="#cb3-23"></a>         } <span class="kw">deriving</span> (<span class="dt">Eq</span>, <span class="dt">Show</span>, <span class="dt">Generic</span>)</span></code></pre></div>
<p>これを <code>FronJSON</code> 型クラスのインスタンスにしてやる(<code>ToJSON</code> はついで)．</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb4-1"><a href="#cb4-1"></a><span class="kw">import</span> <span class="dt">Data.Aeson.Casing</span> (aesonDrop, snakeCase)</span>
<span id="cb4-2"><a href="#cb4-2"></a><span class="kw">import</span> <span class="dt">Data.Aeson</span> (<span class="dt">FromJSON</span> (..), <span class="dt">ToJSON</span> (..),</span>
<span id="cb4-3"><a href="#cb4-3"></a>                   genericParseJSON, genericToJSON)</span>
<span id="cb4-4"><a href="#cb4-4"></a></span>
<span id="cb4-5"><a href="#cb4-5"></a><span class="kw">instance</span> <span class="dt">ToJSON</span> <span class="dt">Me</span> <span class="kw">where</span></span>
<span id="cb4-6"><a href="#cb4-6"></a>  toJSON <span class="ot">=</span> genericToJSON <span class="op">$</span> aesonDrop (<span class="fu">length</span> <span class="st">&quot;meTo&quot;</span>) snakeCase</span>
<span id="cb4-7"><a href="#cb4-7"></a><span class="kw">instance</span> <span class="dt">FromJSON</span> <span class="dt">Me</span> <span class="kw">where</span></span>
<span id="cb4-8"><a href="#cb4-8"></a>  parseJSON <span class="ot">=</span> genericParseJSON <span class="op">$</span> aesonDrop (<span class="fu">length</span> <span class="st">&quot;meTo&quot;</span>) snakeCase</span></code></pre></div>
<p><code>Data.Aeson.Casing</code> は <a href="https://hackage.haskell.org/package/aeson-casing"><code>aeson-casing</code></a> というパッケージのモジュールで，これを利用すると簡単に <code>aeson</code> のための前処理を記述できる．</p>
<h3 id="エンドポイント用の関数を作る">エンドポイント用の関数を作る</h3>
<p>トークンを与えてエンドポイント用の関数を実行すると，先に定義した <code>Me</code> 型の値が返ってくる．</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb5-1"><a href="#cb5-1"></a><span class="kw">import</span> <span class="dt">Network.HTTP.Req</span></span>
<span id="cb5-2"><a href="#cb5-2"></a></span>
<span id="cb5-3"><a href="#cb5-3"></a><span class="kw">type</span> <span class="dt">Token</span> <span class="ot">=</span> <span class="dt">ByteString</span></span>
<span id="cb5-4"><a href="#cb5-4"></a></span>
<span id="cb5-5"><a href="#cb5-5"></a><span class="ot">baseUrl ::</span> <span class="dt">Url</span> <span class="dt">'Https</span></span>
<span id="cb5-6"><a href="#cb5-6"></a>baseUrl <span class="ot">=</span> https <span class="st">&quot;api.chatwork.com&quot;</span> <span class="op">/:</span> <span class="st">&quot;v2&quot;</span></span>
<span id="cb5-7"><a href="#cb5-7"></a></span>
<span id="cb5-8"><a href="#cb5-8"></a><span class="ot">mkHeader ::</span> <span class="dt">Token</span> <span class="ot">-&gt;</span> <span class="dt">Option</span> <span class="dt">'Https</span></span>
<span id="cb5-9"><a href="#cb5-9"></a>mkHeader token <span class="ot">=</span> header <span class="st">&quot;X-ChatWorkToken&quot;</span> token</span>
<span id="cb5-10"><a href="#cb5-10"></a></span>
<span id="cb5-11"><a href="#cb5-11"></a><span class="ot">getMe ::</span> (<span class="dt">MonadHttp</span> m) <span class="ot">=&gt;</span> <span class="dt">Token</span> <span class="ot">-&gt;</span> m (<span class="dt">JsonResponse</span> <span class="dt">Me</span>)</span>
<span id="cb5-12"><a href="#cb5-12"></a>getMe token <span class="ot">=</span> req <span class="dt">GET</span> (baseUrl <span class="op">/:</span> <span class="st">&quot;me&quot;</span>) <span class="dt">NoReqBody</span> jsonResponse (mkHeader token)</span></code></pre></div>
<p>べた書きはあんまりよくないが，<code>baseUrl</code> にどのエンドポイントでも変わらない，ベースとなる URL を定義しておく． <code>req</code> 関数の型は以下の通り</p>
<div class="sourceCode" id="cb6"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb6-1"><a href="#cb6-1"></a>req</span>
<span id="cb6-2"><a href="#cb6-2"></a><span class="ot">  ::</span> ( <span class="dt">MonadHttp</span>    m</span>
<span id="cb6-3"><a href="#cb6-3"></a>     , <span class="dt">HttpMethod</span>   method</span>
<span id="cb6-4"><a href="#cb6-4"></a>     , <span class="dt">HttpBody</span>     body</span>
<span id="cb6-5"><a href="#cb6-5"></a>     , <span class="dt">HttpResponse</span> response</span>
<span id="cb6-6"><a href="#cb6-6"></a>     , <span class="dt">HttpBodyAllowed</span> (<span class="dt">AllowsBody</span> method) (<span class="dt">ProvidesBody</span> body) )</span>
<span id="cb6-7"><a href="#cb6-7"></a>  <span class="ot">=&gt;</span> method            <span class="co">-- ^ HTTP method</span></span>
<span id="cb6-8"><a href="#cb6-8"></a>  <span class="ot">-&gt;</span> <span class="dt">Url</span> scheme        <span class="co">-- ^ 'Url'—location of resource</span></span>
<span id="cb6-9"><a href="#cb6-9"></a>  <span class="ot">-&gt;</span> body              <span class="co">-- ^ Body of the request</span></span>
<span id="cb6-10"><a href="#cb6-10"></a>  <span class="ot">-&gt;</span> <span class="dt">Proxy</span> response    <span class="co">-- ^ A hint how to interpret response</span></span>
<span id="cb6-11"><a href="#cb6-11"></a>  <span class="ot">-&gt;</span> <span class="dt">Option</span> scheme     <span class="co">-- ^ Collection of optional parameters</span></span>
<span id="cb6-12"><a href="#cb6-12"></a>  <span class="ot">-&gt;</span> m response        <span class="co">-- ^ Response</span></span></code></pre></div>
<p>一見難しそうだが</p>
<ul>
<li><code>method</code> は <a href="https://hackage.haskell.org/package/req-0.4.0/docs/Network-HTTP-Req.html#t:GET"><code>GET</code></a> や <a href="https://hackage.haskell.org/package/req-0.4.0/docs/Network-HTTP-Req.html#t:POST"><code>POST</code></a> などの HTTPメソッド</li>
<li><code>Url scheme</code> は(細かいことを気にしなければ) エンドポイントURLを表している</li>
<li><code>body</code> はリクエストの本体(<code>POST</code> や <code>PUT</code> のときに用いる)</li>
<li><code>Proxy response</code> はレスポンスの型を Proxy 型で指定する(JSON なのか，生の文字列なのかなど)</li>
<li><code>Option scheme</code> はその他のリクエストパラメータ</li>
<li><code>m response</code> 返り値の型</li>
</ul>
<p><code>Url scheme</code> 型は <a href="https://hackage.haskell.org/package/req-0.4.0/docs/Network-HTTP-Req.html#v:-47-:"><code>/:</code></a>で組み立てていく． GETメソッドの場合は本体(<code>body</code>)を指定できない(これは <code>HttpBpdyAllowed</code> 型クラスで決まってる)ので <a href="https://hackage.haskell.org/package/req-0.4.0/docs/Network-HTTP-Req.html#t:NoReqBody"><code>NoReqBody</code></a> コンストラクタを使う． <code>Proxy response</code> の値は既に定義されているのでそれを使う(e.g. <code>jsonResponse</code>)． その他のリクエストパラメータにはトークンを指定したいので，<code>mkHeader</code> 関数で <code>Token</code> 型の値(まぁただの <code>ByteString</code>)から生成する．</p>
<h2 id="section-3"></h2>
<p>これを GHCi で実行すると次のようになる</p>
<div class="sourceCode" id="cb7"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb7-1"><a href="#cb7-1"></a><span class="op">&gt;&gt;</span> <span class="op">:</span><span class="kw">module</span> <span class="dt">Network.HTTP.Req</span> <span class="dt">ChatWork</span></span>
<span id="cb7-2"><a href="#cb7-2"></a><span class="op">&gt;&gt;</span> token <span class="ot">=</span> <span class="st">&quot;xxx&quot;</span></span>
<span id="cb7-3"><a href="#cb7-3"></a><span class="op">&gt;&gt;</span> <span class="fu">print</span> <span class="op">=&lt;&lt;</span> (responseBody <span class="op">&lt;$&gt;</span> getMe token)</span>
<span id="cb7-4"><a href="#cb7-4"></a><span class="dt">Right</span> (<span class="dt">Me</span> {meToAccountId <span class="ot">=</span> <span class="dv">1234567</span>, meToRoomId <span class="ot">=</span> <span class="dv">9876543</span>, meToName <span class="ot">=</span> <span class="st">&quot;\26494\21407\20449\24544&quot;</span>, meToChatworkId <span class="ot">=</span> <span class="st">&quot;&quot;</span>, meToOrganizationId <span class="ot">=</span> <span class="dv">13579</span>, meToOrganizationName <span class="ot">=</span> <span class="st">&quot;&quot;</span>, meToDepartment <span class="ot">=</span> <span class="st">&quot;&quot;</span>, meToTitle <span class="ot">=</span> <span class="st">&quot;&quot;</span>, meToUrl <span class="ot">=</span> <span class="st">&quot;&quot;</span>, meToIntroduction <span class="ot">=</span> <span class="st">&quot;&quot;</span>, meToMail <span class="ot">=</span> <span class="st">&quot;&quot;</span>, meToTelOrganization <span class="ot">=</span> <span class="st">&quot;&quot;</span>, meToTelExtension <span class="ot">=</span> <span class="st">&quot;&quot;</span>, meToTelMobile <span class="ot">=</span> <span class="st">&quot;&quot;</span>, meToSkype <span class="ot">=</span> <span class="st">&quot;&quot;</span>, meToFacebook <span class="ot">=</span> <span class="st">&quot;&quot;</span>, meToTwitter <span class="ot">=</span> <span class="st">&quot;&quot;</span>, meToAvatarImageUrl <span class="ot">=</span> <span class="st">&quot;https://appdata.chatwork.com/avatar/1234/12345678.rsz.png&quot;</span>})</span></code></pre></div>
<h3 id="manager-を使ってカスタマイズ"><code>Manager</code> を使ってカスタマイズ</h3>
<p>ChatWork のエンドポイントのいくつかは配列が返ってくることがある．</p>
<p>例えば，<a href="http://developer.chatwork.com/ja/endpoint_contacts.html"><code>https://api.chatwork.com/v2/contacts</code></a>では次のようなJSONが返ってくる．</p>
<div class="sourceCode" id="cb8"><pre class="sourceCode json"><code class="sourceCode json"><span id="cb8-1"><a href="#cb8-1"></a><span class="ot">[</span></span>
<span id="cb8-2"><a href="#cb8-2"></a>  <span class="fu">{</span></span>
<span id="cb8-3"><a href="#cb8-3"></a>    <span class="dt">&quot;account_id&quot;</span><span class="fu">:</span> <span class="dv">123</span><span class="fu">,</span></span>
<span id="cb8-4"><a href="#cb8-4"></a>    <span class="dt">&quot;room_id&quot;</span><span class="fu">:</span> <span class="dv">322</span><span class="fu">,</span></span>
<span id="cb8-5"><a href="#cb8-5"></a>    <span class="dt">&quot;name&quot;</span><span class="fu">:</span> <span class="st">&quot;John Smith&quot;</span><span class="fu">,</span></span>
<span id="cb8-6"><a href="#cb8-6"></a>    <span class="dt">&quot;chatwork_id&quot;</span><span class="fu">:</span> <span class="st">&quot;tarochatworkid&quot;</span><span class="fu">,</span></span>
<span id="cb8-7"><a href="#cb8-7"></a>    <span class="dt">&quot;organization_id&quot;</span><span class="fu">:</span> <span class="dv">101</span><span class="fu">,</span></span>
<span id="cb8-8"><a href="#cb8-8"></a>    <span class="dt">&quot;organization_name&quot;</span><span class="fu">:</span> <span class="st">&quot;Hello Company&quot;</span><span class="fu">,</span></span>
<span id="cb8-9"><a href="#cb8-9"></a>    <span class="dt">&quot;department&quot;</span><span class="fu">:</span> <span class="st">&quot;Marketing&quot;</span><span class="fu">,</span></span>
<span id="cb8-10"><a href="#cb8-10"></a>    <span class="dt">&quot;avatar_image_url&quot;</span><span class="fu">:</span> <span class="st">&quot;https://example.com/abc.png&quot;</span></span>
<span id="cb8-11"><a href="#cb8-11"></a>  <span class="fu">}</span></span>
<span id="cb8-12"><a href="#cb8-12"></a><span class="ot">]</span></span></code></pre></div>
<p>問題は，配列が空の場合． その場合，<code>[]</code> ではなく，なにも返ってこない… そのため，次のようなエラーで落ちてしまう．</p>
<div class="sourceCode" id="cb9"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb9-1"><a href="#cb9-1"></a><span class="op">&gt;&gt;</span> <span class="fu">print</span> <span class="op">=&lt;&lt;</span> (responseBody <span class="op">&lt;$&gt;</span> getContacts <span class="st">&quot;xxxx&quot;</span>)</span>
<span id="cb9-2"><a href="#cb9-2"></a><span class="op">***</span> <span class="dt">Exception</span><span class="op">:</span> <span class="dt">JsonHttpException</span> <span class="st">&quot;Error in $: not enough input&quot;</span></span></code></pre></div>
<p><code>aeson</code> のパーサーは空文字 <code>""</code> をパースできないのだ… 一度は完全に詰んだかと思ったが，たまたま作ってた当時の翌週に <code>req</code> パッケージが v3.0 にアップデートし，<a href="https://hackage.haskell.org/package/req-0.4.0/docs/Network-HTTP-Req.html#v:req-39-"><code>req'</code></a> と言う関数が追加された！</p>
<div class="sourceCode" id="cb10"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb10-1"><a href="#cb10-1"></a><span class="kw">import</span> <span class="kw">qualified</span> <span class="dt">Network.HTTP.Client</span> <span class="kw">as</span> <span class="dt">L</span></span>
<span id="cb10-2"><a href="#cb10-2"></a></span>
<span id="cb10-3"><a href="#cb10-3"></a>req'</span>
<span id="cb10-4"><a href="#cb10-4"></a><span class="ot">  ::</span> <span class="kw">forall</span> m method body scheme a<span class="op">.</span></span>
<span id="cb10-5"><a href="#cb10-5"></a>     ( <span class="dt">MonadHttp</span>  m</span>
<span id="cb10-6"><a href="#cb10-6"></a>     , <span class="dt">HttpMethod</span> method</span>
<span id="cb10-7"><a href="#cb10-7"></a>     , <span class="dt">HttpBody</span>   body</span>
<span id="cb10-8"><a href="#cb10-8"></a>     , <span class="dt">HttpBodyAllowed</span> (<span class="dt">AllowsBody</span> method) (<span class="dt">ProvidesBody</span> body) )</span>
<span id="cb10-9"><a href="#cb10-9"></a>  <span class="ot">=&gt;</span> method            <span class="co">-- ^ HTTP method</span></span>
<span id="cb10-10"><a href="#cb10-10"></a>  <span class="ot">-&gt;</span> <span class="dt">Url</span> scheme        <span class="co">-- ^ 'Url'—location of resource</span></span>
<span id="cb10-11"><a href="#cb10-11"></a>  <span class="ot">-&gt;</span> body              <span class="co">-- ^ Body of the request</span></span>
<span id="cb10-12"><a href="#cb10-12"></a>  <span class="ot">-&gt;</span> <span class="dt">Option</span> scheme     <span class="co">-- ^ Collection of optional parameters</span></span>
<span id="cb10-13"><a href="#cb10-13"></a>  <span class="ot">-&gt;</span> (<span class="dt">L.Request</span> <span class="ot">-&gt;</span> <span class="dt">L.Manager</span> <span class="ot">-&gt;</span> m a) <span class="co">-- ^ How to perform request</span></span>
<span id="cb10-14"><a href="#cb10-14"></a>  <span class="ot">-&gt;</span> m a</span></code></pre></div>
<p>変わったのは5引数目の <code>(L.Request -&gt; L.Manager -&gt; m a)</code> 型(もともとは <code>Proxy response</code> 型)． ざっくりいうと，<a href="https://hackage.haskell.org/package/http-client-0.5.7.0"><code>http-client</code></a> パッケージの <a href="https://hackage.haskell.org/package/http-client-0.5.7.0/docs/Network-HTTP-Client.html#t:Manager"><code>Manager</code></a> 型を使って，様々な前処理を書き加えることができるようになる(他の用途もあるだろうが)．</p>
<p>これで，空文字だったら <code>[]</code> に変化する前処理を加えてあげれば良い．</p>
<div class="sourceCode" id="cb11"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb11-1"><a href="#cb11-1"></a><span class="kw">import</span> <span class="dt">Control.Monad.IO.Class</span> (<span class="dt">MonadIO</span> (..))</span>
<span id="cb11-2"><a href="#cb11-2"></a><span class="kw">import</span> <span class="dt">Data.Default.Class</span> (def)</span>
<span id="cb11-3"><a href="#cb11-3"></a><span class="kw">import</span> <span class="dt">Data.List</span> (lookup)</span>
<span id="cb11-4"><a href="#cb11-4"></a><span class="kw">import</span> <span class="dt">Data.Maybe</span> (fromMaybe)</span>
<span id="cb11-5"><a href="#cb11-5"></a><span class="kw">import</span> <span class="dt">Data.Proxy</span> (<span class="dt">Proxy</span> (..))</span>
<span id="cb11-6"><a href="#cb11-6"></a><span class="kw">import</span> <span class="dt">Network.Connection</span> (initConnectionContext)</span>
<span id="cb11-7"><a href="#cb11-7"></a><span class="kw">import</span> <span class="dt">Network.HTTP.Client</span> (<span class="dt">BodyReader</span>, <span class="dt">Manager</span>,</span>
<span id="cb11-8"><a href="#cb11-8"></a>                            <span class="dt">ManagerSettings</span> (<span class="op">..</span>), <span class="dt">Request</span>,</span>
<span id="cb11-9"><a href="#cb11-9"></a>                            <span class="dt">Response</span> (<span class="op">..</span>), newManager)</span>
<span id="cb11-10"><a href="#cb11-10"></a><span class="kw">import</span> <span class="dt">Network.HTTP.Client.Internal</span> (constBodyReader)</span>
<span id="cb11-11"><a href="#cb11-11"></a><span class="kw">import</span> <span class="dt">Network.HTTP.Client.TLS</span> (mkManagerSettingsContext)</span>
<span id="cb11-12"><a href="#cb11-12"></a><span class="kw">import</span> <span class="dt">Network.HTTP.Req</span> (<span class="dt">AllowsBody</span>, <span class="dt">HttpBody</span>, <span class="dt">HttpBodyAllowed</span>,</span>
<span id="cb11-13"><a href="#cb11-13"></a>                         <span class="dt">HttpMethod</span>, <span class="dt">HttpResponse</span>, <span class="dt">MonadHttp</span>, <span class="dt">Option</span>,</span>
<span id="cb11-14"><a href="#cb11-14"></a>                         <span class="dt">ProvidesBody</span>, <span class="dt">Url</span>, req')</span>
<span id="cb11-15"><a href="#cb11-15"></a><span class="kw">import</span> <span class="dt">Network.HTTP.Types.Header</span> (hContentLength)</span>
<span id="cb11-16"><a href="#cb11-16"></a></span>
<span id="cb11-17"><a href="#cb11-17"></a><span class="ot">req ::</span></span>
<span id="cb11-18"><a href="#cb11-18"></a>  ( <span class="dt">MonadHttp</span> m, <span class="dt">HttpMethod</span> method, <span class="dt">HttpBody</span> body, <span class="dt">HttpResponse</span> response</span>
<span id="cb11-19"><a href="#cb11-19"></a>  , <span class="dt">HttpBodyAllowed</span> (<span class="dt">AllowsBody</span> method) (<span class="dt">ProvidesBody</span> body))</span>
<span id="cb11-20"><a href="#cb11-20"></a>  <span class="ot">=&gt;</span> method</span>
<span id="cb11-21"><a href="#cb11-21"></a>  <span class="ot">-&gt;</span> <span class="dt">Url</span> scheme</span>
<span id="cb11-22"><a href="#cb11-22"></a>  <span class="ot">-&gt;</span> body</span>
<span id="cb11-23"><a href="#cb11-23"></a>  <span class="ot">-&gt;</span> <span class="dt">Proxy</span> response</span>
<span id="cb11-24"><a href="#cb11-24"></a>  <span class="ot">-&gt;</span> <span class="dt">Option</span> scheme</span>
<span id="cb11-25"><a href="#cb11-25"></a>  <span class="ot">-&gt;</span> m response</span>
<span id="cb11-26"><a href="#cb11-26"></a>req method url body proxy option <span class="ot">=</span></span>
<span id="cb11-27"><a href="#cb11-27"></a>  req' method url body option (getHttpResponse' proxy)</span>
<span id="cb11-28"><a href="#cb11-28"></a></span>
<span id="cb11-29"><a href="#cb11-29"></a><span class="ot">getHttpResponse' ::</span> (<span class="dt">HttpResponse</span> a, <span class="dt">MonadHttp</span> m) <span class="ot">=&gt;</span> <span class="dt">Proxy</span> a <span class="ot">-&gt;</span> (<span class="dt">Request</span> <span class="ot">-&gt;</span> <span class="dt">Manager</span> <span class="ot">-&gt;</span> m a)</span>
<span id="cb11-30"><a href="#cb11-30"></a>getHttpResponse' <span class="dt">Proxy</span> r _ <span class="ot">=</span> liftIO <span class="op">$</span> getHttpResponse r <span class="op">=&lt;&lt;</span> fixEmptyStringManager</span>
<span id="cb11-31"><a href="#cb11-31"></a></span>
<span id="cb11-32"><a href="#cb11-32"></a><span class="ot">fixEmptyStringManager ::</span> <span class="dt">IO</span> <span class="dt">Manager</span></span>
<span id="cb11-33"><a href="#cb11-33"></a>fixEmptyStringManager <span class="ot">=</span> <span class="kw">do</span></span>
<span id="cb11-34"><a href="#cb11-34"></a>  context <span class="ot">&lt;-</span> initConnectionContext</span>
<span id="cb11-35"><a href="#cb11-35"></a>  <span class="kw">let</span> settings <span class="ot">=</span> mkManagerSettingsContext (<span class="dt">Just</span> context) def <span class="dt">Nothing</span></span>
<span id="cb11-36"><a href="#cb11-36"></a>  newManager <span class="op">$</span> settings { managerModifyResponse <span class="ot">=</span> fixEmptyString }</span>
<span id="cb11-37"><a href="#cb11-37"></a></span>
<span id="cb11-38"><a href="#cb11-38"></a><span class="ot">fixEmptyString ::</span> <span class="dt">Response</span> <span class="dt">BodyReader</span> <span class="ot">-&gt;</span> <span class="dt">IO</span> (<span class="dt">Response</span> <span class="dt">BodyReader</span>)</span>
<span id="cb11-39"><a href="#cb11-39"></a>fixEmptyString res <span class="ot">=</span> <span class="kw">do</span></span>
<span id="cb11-40"><a href="#cb11-40"></a>  reader <span class="ot">&lt;-</span> constBodyReader [<span class="st">&quot;[]&quot;</span>]</span>
<span id="cb11-41"><a href="#cb11-41"></a>  <span class="kw">let</span></span>
<span id="cb11-42"><a href="#cb11-42"></a>    contentLength <span class="ot">=</span> fromMaybe <span class="st">&quot;0&quot;</span> <span class="op">$</span> <span class="fu">lookup</span> hContentLength (responseHeaders res)</span>
<span id="cb11-43"><a href="#cb11-43"></a>  <span class="fu">return</span> <span class="op">$</span> <span class="kw">if</span> contentLength <span class="op">/=</span> <span class="st">&quot;0&quot;</span> <span class="kw">then</span> res <span class="kw">else</span> res { responseBody <span class="ot">=</span> reader }</span></code></pre></div>
<p>レスポンスパラメータの <code>ContentLength</code> が <code>0</code> だった場合は，<code>"[]"</code> を新しく返している，という処理だ． 元の <code>Network.HTTP.Req.req</code> 関数の代わりに，この <code>req</code> 関数を使えばうまく動作するはずだ．</p>
<h3 id="post-や-put-はどうするか">POST や PUT はどうするか</h3>
<p>例えば，チャットルームを作るエンドポイントの場合を考える． <code>curl</code> であれば次のように書く．</p>
<div class="sourceCode" id="cb12"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb12-1"><a href="#cb12-1"></a><span class="ex">curl</span> -X POST -H <span class="st">&quot;X-ChatWorkToken: 自分のAPIトークン&quot;</span> -d <span class="st">&quot;description=group+chat+description&amp;icon_preset=meeting&amp;members_admin_ids=123%2C542%2C1001&amp;members_member_ids=21%2C344&amp;members_readonly_ids=15%2C103&amp;name=Website+renewal+project&quot;</span> <span class="st">&quot;https://api.chatwork.com/v2/rooms&quot;</span></span></code></pre></div>
<p><code>-d</code> オプションを使ってルーム名 <code>name</code> や誰を招待するか <code>members_member_ids</code> を指定している． <code>req</code> パッケージでは次のように書く．</p>
<div class="sourceCode" id="cb13"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb13-1"><a href="#cb13-1"></a><span class="kw">import</span> <span class="dt">Network.HTTP.Req</span>  (<span class="dt">MonadHttp</span>, <span class="dt">POST</span> (..), <span class="dt">ReqBodyUrlEnc</span> (..),</span>
<span id="cb13-2"><a href="#cb13-2"></a>                          jsonResponse, (<span class="op">/:</span>))</span>
<span id="cb13-3"><a href="#cb13-3"></a></span>
<span id="cb13-4"><a href="#cb13-4"></a><span class="kw">newtype</span> <span class="dt">RoomIdWrap</span> <span class="ot">=</span> <span class="dt">RoomIdWrap</span> {<span class="ot"> getRoomId ::</span> <span class="dt">Int</span> } <span class="kw">deriving</span> (<span class="dt">Eq</span>, <span class="dt">Show</span>, <span class="dt">Generic</span>)</span>
<span id="cb13-5"><a href="#cb13-5"></a></span>
<span id="cb13-6"><a href="#cb13-6"></a><span class="kw">data</span> <span class="dt">CreateRoomParams</span> <span class="ot">=</span> <span class="dt">CreateRoomParams</span></span>
<span id="cb13-7"><a href="#cb13-7"></a>                      {<span class="ot"> cRoomDescription    ::</span> <span class="dt">Maybe</span> <span class="dt">Text</span></span>
<span id="cb13-8"><a href="#cb13-8"></a>                      ,<span class="ot"> cIconPreset         ::</span> <span class="dt">Maybe</span> <span class="dt">IconPreset</span></span>
<span id="cb13-9"><a href="#cb13-9"></a>                      ,<span class="ot"> cMembersAdminIds    ::</span> [<span class="dt">Int</span>]</span>
<span id="cb13-10"><a href="#cb13-10"></a>                      ,<span class="ot"> cMembersMemberIds   ::</span> <span class="dt">Maybe</span> [<span class="dt">Int</span>]</span>
<span id="cb13-11"><a href="#cb13-11"></a>                      ,<span class="ot"> cMembersReadonlyIds ::</span> <span class="dt">Maybe</span> [<span class="dt">Int</span>]</span>
<span id="cb13-12"><a href="#cb13-12"></a>                      ,<span class="ot"> cRoomName           ::</span> <span class="dt">Text</span></span>
<span id="cb13-13"><a href="#cb13-13"></a>                      } <span class="kw">deriving</span> (<span class="dt">Show</span>)</span>
<span id="cb13-14"><a href="#cb13-14"></a></span>
<span id="cb13-15"><a href="#cb13-15"></a><span class="ot">createRoom ::</span> (<span class="dt">MonadHttp</span> m) <span class="ot">=&gt;</span> <span class="dt">Token</span> <span class="ot">-&gt;</span> <span class="dt">CreateRoomParams</span> <span class="ot">-&gt;</span> m (<span class="dt">ChatWorkResponse</span> <span class="dt">RoomIdWrap</span>)</span>
<span id="cb13-16"><a href="#cb13-16"></a>createRoom token params <span class="ot">=</span></span>
<span id="cb13-17"><a href="#cb13-17"></a>  req <span class="dt">POST</span> (baseUrl c <span class="op">/:</span> <span class="st">&quot;rooms&quot;</span>) (<span class="dt">ReqBodyUrlEnc</span> params') jsonResponse <span class="op">$</span> mkHeader token</span>
<span id="cb13-18"><a href="#cb13-18"></a>  <span class="kw">where</span></span>
<span id="cb13-19"><a href="#cb13-19"></a>    params' <span class="ot">=</span> toReqParam <span class="st">&quot;description&quot;</span> (cRoomDescription params)</span>
<span id="cb13-20"><a href="#cb13-20"></a>           <span class="op">&lt;&gt;</span> toReqParam <span class="st">&quot;icon_preset&quot;</span> (cIconPreset params)</span>
<span id="cb13-21"><a href="#cb13-21"></a>           <span class="op">&lt;&gt;</span> toReqParam <span class="st">&quot;members_admin_ids&quot;</span> (cMembersAdminIds params)</span>
<span id="cb13-22"><a href="#cb13-22"></a>           <span class="op">&lt;&gt;</span> toReqParam <span class="st">&quot;members_member_ids&quot;</span> (cMembersMemberIds params)</span>
<span id="cb13-23"><a href="#cb13-23"></a>           <span class="op">&lt;&gt;</span> toReqParam <span class="st">&quot;members_readonly_ids&quot;</span> (cMembersReadonlyIds params)</span>
<span id="cb13-24"><a href="#cb13-24"></a>           <span class="op">&lt;&gt;</span> toReqParam <span class="st">&quot;name&quot;</span> (cRoomName params)</span></code></pre></div>
<p><code>IconPreset</code> 型は <code>icon_preset</code> パラメータに丁度対応するように作った型である(長いので割愛してる)． 今回はURLエンコードする必要があるので，<a href="https://hackage.haskell.org/package/req-0.4.0/docs/Network-HTTP-Req.html#t:ReqBodyUrlEnc"><code>ReqBodyUrlEnc</code></a> コンストラクタを使う． コンストラクタの引数には <a href="https://hackage.haskell.org/package/req-0.4.0/docs/Network-HTTP-Req.html#t:FormUrlEncodedParam"><code>FormUrlEncodedParam</code></a> 型の値を指定してやる必要があり，本来は <code>(=:)</code> 演算子を使って次のように定義する．</p>
<div class="sourceCode" id="cb14"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb14-1"><a href="#cb14-1"></a><span class="ot">param ::</span> <span class="dt">FormUrlEncodedParam</span></span>
<span id="cb14-2"><a href="#cb14-2"></a>param <span class="ot">=</span> <span class="st">&quot;price&quot;</span> <span class="op">=:</span> (<span class="dv">24</span><span class="ot"> ::</span> <span class="dt">Int</span>)</span>
<span id="cb14-3"><a href="#cb14-3"></a>     <span class="op">&lt;&gt;</span> <span class="st">&quot;mmember&quot;</span> <span class="op">=:</span> (<span class="st">&quot;hoge&quot;</span><span class="ot"> ::</span> <span class="dt">Text</span>)</span></code></pre></div>
<p><code>Int</code> 型や <code>Text</code> 型だけなら楽だが，<code>Maybe</code> 型やリスト型のようなコンテナ型が関わってくるとめんどくさい．</p>
<div class="sourceCode" id="cb15"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb15-1"><a href="#cb15-1"></a><span class="ot">param ::</span> <span class="dt">FormUrlEncodedParam</span></span>
<span id="cb15-2"><a href="#cb15-2"></a>param <span class="ot">=</span> fromMaybe <span class="fu">mempty</span> (<span class="st">&quot;price&quot;</span> <span class="op">=:</span>) (<span class="dv">24</span><span class="ot"> ::</span> <span class="dt">Maybe</span> <span class="dt">Int</span>)</span>
<span id="cb15-3"><a href="#cb15-3"></a>     <span class="op">&lt;&gt;</span> <span class="st">&quot;member&quot;</span> <span class="op">=:</span> (<span class="fu">foldl1</span> (\acc txt <span class="ot">-&gt;</span> <span class="fu">mconcat</span> [acc, <span class="st">&quot;,&quot;</span>, txt]) ([<span class="st">&quot;hoge&quot;</span>, <span class="st">&quot;fuga&quot;</span>]<span class="ot"> ::</span> [<span class="dt">Text</span>]))</span></code></pre></div>
<p>なので，これを抽象化した <code>toReqParam</code> 型クラスを作った．</p>
<div class="sourceCode" id="cb16"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb16-1"><a href="#cb16-1"></a><span class="kw">class</span> <span class="dt">ToReqParam</span> a <span class="kw">where</span></span>
<span id="cb16-2"><a href="#cb16-2"></a><span class="ot">  toReqParam ::</span> (<span class="dt">QueryParam</span> param, <span class="dt">Monoid</span> param) <span class="ot">=&gt;</span> <span class="dt">Text</span> <span class="ot">-&gt;</span> a <span class="ot">-&gt;</span> param</span>
<span id="cb16-3"><a href="#cb16-3"></a></span>
<span id="cb16-4"><a href="#cb16-4"></a><span class="kw">instance</span> <span class="dt">ToReqParam</span> <span class="dt">Int</span> <span class="kw">where</span></span>
<span id="cb16-5"><a href="#cb16-5"></a>  toReqParam <span class="ot">=</span> (<span class="op">=:</span>)</span>
<span id="cb16-6"><a href="#cb16-6"></a></span>
<span id="cb16-7"><a href="#cb16-7"></a><span class="kw">instance</span> <span class="dt">ToReqParam</span> <span class="dt">Text</span> <span class="kw">where</span></span>
<span id="cb16-8"><a href="#cb16-8"></a>  toReqParam <span class="ot">=</span> (<span class="op">=:</span>)</span>
<span id="cb16-9"><a href="#cb16-9"></a></span>
<span id="cb16-10"><a href="#cb16-10"></a><span class="kw">instance</span> <span class="dt">ToReqParam</span> a <span class="ot">=&gt;</span> <span class="dt">ToReqParam</span> (<span class="dt">Maybe</span> a) <span class="kw">where</span></span>
<span id="cb16-11"><a href="#cb16-11"></a>  toReqParam <span class="ot">=</span> <span class="fu">maybe</span> <span class="fu">mempty</span> <span class="op">.</span> toReqParam</span>
<span id="cb16-12"><a href="#cb16-12"></a></span>
<span id="cb16-13"><a href="#cb16-13"></a><span class="kw">instance</span> <span class="dt">Show</span> a <span class="ot">=&gt;</span> <span class="dt">ToReqParam</span> [a] <span class="kw">where</span></span>
<span id="cb16-14"><a href="#cb16-14"></a>  toReqParam name <span class="ot">=</span> toReqParam name <span class="op">.</span> <span class="fu">foldl1</span> (\acc txt <span class="ot">-&gt;</span> <span class="fu">mconcat</span> [acc, <span class="st">&quot;,&quot;</span>, txt]) <span class="op">.</span> <span class="fu">fmap</span> (<span class="fu">pack</span> <span class="op">.</span> <span class="fu">show</span>)</span></code></pre></div>
<p>楽になった．</p>
<h3 id="あとは">あとは…</h3>
<p>あとはこれらをエンドポイントの種類だけ書く． まぁこれがしんどいんだが….</p>
<h2 id="おしまい">おしまい</h2>
<p>概ねこれで完成だが，「その２」では 「API に関するエラーの場合の処理の加え方」と「自分流のテストの書き方」を書こうと思う． ちなみに，「レコードだとフィールド名の重複がつらい問題」は <a href="https://hackage.haskell.org/package/extensible"><code>extensible</code></a> パッケージを入れていずれ何とかしたい．</p>
  </div>

  <footer class="post-footer">
    <a href="https://twitter.com/share?ref_src=twsrc%5Etfw" class="twitter-share-button" data-show-count="false">Tweet</a>
    <script async src="https://platform.twitter.com/widgets.js" charset="utf-8"></script>
  </footer>
</div>
</article>

          </div>
        </div>

        <footer class="site-footer">

  <div class="wrapper">

    <span class="footer-heading">ひげメモ</span>

  </div>

  <div class="page-content card" style="display: flex; justify-content: center; padding: 5px 0px">
    <a href="https://haskell.jp/blog/posts/links.html#matsubara0507.github.io">
      <img width="234" src="https://haskell.jp/img/supported-by-haskell-jp.svg" alt="Supported By Haskell-jp.">
    </a>
  </div>

</footer>


      </div>
  </body>

</html>
