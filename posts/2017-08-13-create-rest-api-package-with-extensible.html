<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE html>
<html lang="ja">

  <head>
  <meta charset="utf-8">
  <link rel="icon" href="../assets/icon.jpg">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
    
      <meta property="og:title" content="extensible の拡張可能レコードを使って REST API Haskell パッケージを作る" />
    
  

  <meta property="og:site_name" content="ひげメモ" />

  

  
    <script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-86386380-1', 'auto');
  ga('send', 'pageview');
</script>

  

  <title>
    
      
        extensible の拡張可能レコードを使って REST API Haskell パッケージを作る
      
    
  </title>

  <link rel="stylesheet" href="../css/main.css">
  <link rel="stylesheet" href="../css/highlight.css">
  <link rel="stylesheet" type="text/css" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.4.0/css/font-awesome.min.css" />
</head>


  <body>
      <div class="outer">

        <header class="site-header">

  <div class="wrapper">

    <a class="site-title" href="https://matsubara0507.github.io/">ひげメモ</a>

  </div>

  <div class="header-badge">
    <a href="https://matsubara0507.github.io/">
        <img src="../assets/icon.jpg" />
    </a>
  </div>

</header>


        <div class="page-content">
          <div class="wrapper">
            <article class="post card" itemscope itemtype="http://schema.org/BlogPosting">
 <div class="card-content">
  <header class="post-header">
    <h1 class="post-title" itemprop="name headline">extensible の拡張可能レコードを使って REST API Haskell パッケージを作る</h1>
    <p class="post-meta">
      <time datetime="2017-08-13" itemprop="datePublished">
        Aug 13, 2017
      </time>
      
    </p>
  </header>

  <div class="post-content" itemprop="articleBody">
    <p><a href="https://github.com/fumieval">fumieval</a> さんが作ってる <a href="https://hackage.haskell.org/package/extensible"><code>extensible</code></a> パッケージの拡張可能レコードを使って，<a href="https://webservice.rakuten.co.jp/document/">楽天のウェブサービスのAPI</a>のための Haskell パッケージ <a href="https://github.com/matsubara0507/rakuten"><code>rakuten</code></a> というのを作ってるので，その簡単な紹介です．</p>
<p>まだ途中だけど，<code>extensible</code> の拡張可能レコードを使うためにの良い例になるかなと思ったので書いておく．</p>
<h2 id="いきさつ">いきさつ</h2>
<p><a href="../posts/2017-08-07-create-rest-api-package-with-req-part1.html">前</a>では <code>req</code> パッケージを使って <a href="https://github.com/matsubara0507/chatwork">chatwork</a> という REST API の Haskell パッケージを作った話を書いた． その時の最後にも，レコードのフィールド名が被ったりしてつらいので <code>extensible</code> を使いたい，という話を書いた．</p>
<p>で，さらにバイト先から「楽天の API のも作って」と言われたので，こっちは最初っから <code>extensible</code> 使っちゃおうと思ったわけです(ちゃんと許可は取ったよ)．</p>
<p>まだ，<a href="https://webservice.rakuten.co.jp/api/ichibaitemsearch/">楽天商品検索 API</a> しか作ってないけどね．</p>
<h2 id="拡張可能レコードを使う">拡張可能レコードを使う</h2>
<p>今のところ次の2ヶ所で使ってる．</p>
<h3 id="api-のレスポンス-json">API のレスポンス JSON</h3>
<p>ドキュメントに従って，こんな風に書ける．</p>
<div class="sourceCode"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span class="kw">type</span> <span class="dt">IchibaItems</span> <span class="fu">=</span>
  <span class="dt">Record</span> <span class="ch">'[</span>
    <span class="st">&quot;count&quot;</span> <span class="ch">':&gt; Int,</span>
    <span class="st">&quot;page&quot;</span> <span class="ch">':&gt; Int,</span>
    <span class="st">&quot;first&quot;</span> <span class="ch">':&gt; Int,</span>
    <span class="st">&quot;last&quot;</span> <span class="ch">':&gt; Int,</span>
    <span class="st">&quot;hits&quot;</span> <span class="ch">':&gt; Int,</span>
    <span class="st">&quot;carrier&quot;</span> <span class="ch">':&gt; Int,</span>
    <span class="st">&quot;pageCount&quot;</span> <span class="ch">':&gt; Int,</span>
    <span class="st">&quot;Items&quot;</span> <span class="ch">':&gt; [ItemWrap],</span>
    <span class="st">&quot;GenreInformation&quot;</span> <span class="ch">':&gt; [GenreInformation],</span>
    <span class="st">&quot;TagInformation&quot;</span> <span class="ch">':&gt; [TagGroupWrap]</span>
  ]</code></pre></div>
<p><code>ItemWrap</code> 型とか，<code>GenreInformation</code> 型とかも同じように定義してある． で，これらを <a href="https://hackage.haskell.org/package/aeson"><code>aeson</code></a>パッケージの <a href="https://hackage.haskell.org/package/aeson-1.2.1.0/docs/Data-Aeson-Types.html#t:FromJSON"><code>FromJSON</code></a> 型クラスのインスタンスにする必要があるが，<code>extensible</code> の拡張可能レコードなら一括にできる！</p>
<div class="sourceCode"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span class="kw">instance</span> <span class="dt">Forall</span> (<span class="dt">KeyValue</span> <span class="dt">KnownSymbol</span> <span class="dt">FromJSON</span>) xs <span class="ot">=&gt;</span> <span class="dt">FromJSON</span> (<span class="dt">Record</span> xs) <span class="kw">where</span>
  parseJSON <span class="fu">=</span> withObject <span class="st">&quot;Object&quot;</span> <span class="fu">$</span>
    \v <span class="ot">-&gt;</span> hgenerateFor (<span class="dt">Proxy</span><span class="ot"> ::</span> <span class="dt">Proxy</span> (<span class="dt">KeyValue</span> <span class="dt">KnownSymbol</span> <span class="dt">FromJSON</span>)) <span class="fu">$</span>
    \m <span class="ot">-&gt;</span> <span class="kw">let</span> k <span class="fu">=</span> symbolVal (proxyAssocKey m) <span class="kw">in</span>
      <span class="kw">case</span> HM.lookup (fromString k) v <span class="kw">of</span>
        <span class="dt">Just</span> a <span class="ot">-&gt;</span> <span class="dt">Field</span> <span class="fu">.</span> return <span class="fu">&lt;$&gt;</span> parseJSON a
        <span class="dt">Nothing</span> <span class="ot">-&gt;</span> fail <span class="fu">$</span> <span class="st">&quot;Missing key: &quot;</span> <span class="ot">`mappend`</span> k</code></pre></div>
<p>まぁこれは <a href="https://github.com/fumieval/extensible"><code>extensible</code> のリポジトリ</a>に<a href="https://github.com/fumieval/extensible/blob/master/examples/aeson.hs">サンプル</a>として置いてあるんだけどね．</p>
<h3 id="リクエストパラメータ">リクエストパラメータ</h3>
<p>検索をしたいので，いろんなパラメータを渡せる仕様になってる…(つらい)． フィールドの名前も被りそうだし，これも拡張可能レコードにしてしまおう．</p>
<div class="sourceCode"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span class="kw">type</span> <span class="dt">IchibaItemSearchParam</span> <span class="fu">=</span>
  <span class="dt">Record</span> <span class="ch">'[</span>
    <span class="st">&quot;keyword&quot;</span> <span class="ch">':&gt; Text,</span>
    <span class="st">&quot;shopCode&quot;</span> <span class="ch">':&gt; Maybe Text,</span>
    <span class="st">&quot;itemCode&quot;</span> <span class="ch">':&gt; Maybe Text,</span>
    <span class="st">&quot;genreId&quot;</span> <span class="ch">':&gt; Maybe Int,</span>
    <span class="st">&quot;tagId&quot;</span> <span class="ch">':&gt; Maybe Int,</span>
    <span class="st">&quot;hits&quot;</span> <span class="ch">':&gt; Maybe Int,</span>
    <span class="st">&quot;page&quot;</span> <span class="ch">':&gt; Maybe Int,</span>
    <span class="st">&quot;sort&quot;</span> <span class="ch">':&gt; Maybe Text,</span>
    <span class="st">&quot;minPrice&quot;</span> <span class="ch">':&gt; Maybe Int,</span>
    <span class="st">&quot;maxPrice&quot;</span> <span class="ch">':&gt; Maybe Int,</span>
    <span class="st">&quot;availability&quot;</span> <span class="ch">':&gt; Maybe Bool,</span>
    <span class="st">&quot;field&quot;</span> <span class="ch">':&gt; Maybe Bool,</span>
    <span class="st">&quot;carrier&quot;</span> <span class="ch">':&gt; Maybe Bool,</span>
    <span class="st">&quot;imageFlag&quot;</span> <span class="ch">':&gt; Maybe Bool,</span>
    <span class="st">&quot;orFlag&quot;</span> <span class="ch">':&gt; Maybe Bool,</span>
    <span class="st">&quot;NGKeyword&quot;</span> <span class="ch">':&gt; Maybe Text,</span>
    <span class="st">&quot;purchaseType&quot;</span> <span class="ch">':&gt; Maybe Int,</span>
    <span class="st">&quot;shipOverseasFlag&quot;</span> <span class="ch">':&gt; Maybe Bool,</span>
    <span class="st">&quot;shipOverseasArea&quot;</span> <span class="ch">':&gt; Maybe Text,</span>
    <span class="st">&quot;asurakuFlag&quot;</span> <span class="ch">':&gt; Maybe Bool,</span>
    <span class="st">&quot;asurakuArea&quot;</span> <span class="ch">':&gt; Maybe Int,</span>
    <span class="st">&quot;pointRateFlag&quot;</span> <span class="ch">':&gt; Maybe Bool,</span>
    <span class="st">&quot;pointRate&quot;</span> <span class="ch">':&gt; Maybe Int,</span>
    <span class="st">&quot;postageFlag&quot;</span> <span class="ch">':&gt; Maybe Bool,</span>
    <span class="st">&quot;creditCardFlag&quot;</span> <span class="ch">':&gt; Maybe Bool,</span>
    <span class="st">&quot;giftFlag&quot;</span> <span class="ch">':&gt; Maybe Bool,</span>
    <span class="st">&quot;hasReviewFlag&quot;</span> <span class="ch">':&gt; Maybe Bool,</span>
    <span class="st">&quot;maxAffiliateRate&quot;</span> <span class="ch">':&gt; Maybe Double,</span>
    <span class="st">&quot;minAffiliateRate&quot;</span> <span class="ch">':&gt; Maybe Double,</span>
    <span class="st">&quot;hasMovieFlag&quot;</span> <span class="ch">':&gt; Maybe Bool,</span>
    <span class="st">&quot;pamphletFlag&quot;</span> <span class="ch">':&gt; Maybe Bool,</span>
    <span class="st">&quot;appointDeliveryDateFlag&quot;</span> <span class="ch">':&gt; Maybe Bool,</span>
    <span class="st">&quot;genreInformationFlag&quot;</span> <span class="ch">':&gt; Maybe Bool,</span>
    <span class="st">&quot;tagInformationFlag&quot;</span> <span class="ch">':&gt; Maybe Bool</span>
  ]</code></pre></div>
<p>(ほぼなくても良いので <code>Maybe</code> 型になってる)</p>
<p><a href="https://hackage.haskell.org/package/req"><code>req</code></a> パッケージでリクエストパラメータにするには次のように <a href="https://hackage.haskell.org/package/base-4.10.0.0/docs/Data-Monoid.html#t:Monoid"><code>Monoid</code></a> 型クラスで合成していく．</p>
<div class="sourceCode"><pre class="sourceCode haskell"><code class="sourceCode haskell">param <span class="fu">=</span> <span class="st">&quot;price&quot;</span> <span class="fu">=:</span> (<span class="dv">24</span><span class="ot"> ::</span> <span class="dt">Int</span>)
     <span class="fu">&lt;&gt;</span> <span class="st">&quot;mmember&quot;</span> <span class="fu">=:</span> (<span class="st">&quot;hoge&quot;</span><span class="ot"> ::</span> <span class="dt">Text</span>)</code></pre></div>
<p>この数を書くのはだるいよね… そこで <code>extensible</code> ですよ！</p>
<div class="sourceCode"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span class="kw">class</span> <span class="dt">ToParam</span> a <span class="kw">where</span>
<span class="ot">  toParam ::</span> (<span class="dt">QueryParam</span> param, <span class="dt">Monoid</span> param) <span class="ot">=&gt;</span> <span class="dt">Text</span> <span class="ot">-&gt;</span> a <span class="ot">-&gt;</span> param

<span class="kw">instance</span> <span class="dt">ToParam</span> <span class="dt">Int</span> <span class="kw">where</span>
  toParam <span class="fu">=</span> (<span class="fu">=:</span>)

<span class="kw">instance</span> <span class="dt">ToParam</span> a <span class="ot">=&gt;</span> <span class="dt">ToParam</span> (<span class="dt">Maybe</span> a) <span class="kw">where</span>
  toParam <span class="fu">=</span> maybe mempty <span class="fu">.</span> toParam

<span class="kw">instance</span> <span class="dt">ToParam</span> a <span class="ot">=&gt;</span> <span class="dt">ToParam</span> (<span class="dt">Identity</span> a) <span class="kw">where</span>
  toParam name <span class="fu">=</span> toParam name <span class="fu">.</span> runIdentity

<span class="kw">class</span> <span class="dt">ToParams</span> a <span class="kw">where</span>
<span class="ot">  toParams ::</span> (<span class="dt">QueryParam</span> param, <span class="dt">Monoid</span> param) <span class="ot">=&gt;</span> a <span class="ot">-&gt;</span> param

<span class="kw">instance</span> <span class="dt">Forall</span> (<span class="dt">KeyValue</span> <span class="dt">KnownSymbol</span> <span class="dt">ToParam</span>) xs <span class="ot">=&gt;</span> <span class="dt">ToParams</span> (<span class="dt">Record</span> xs) <span class="kw">where</span>
  toParams <span class="fu">=</span> flip appEndo mempty <span class="fu">.</span> hfoldMap getConst' <span class="fu">.</span> hzipWith
    (\(<span class="dt">Comp</span> <span class="dt">Dict</span>) <span class="ot">-&gt;</span> <span class="dt">Const'</span> <span class="fu">.</span> <span class="dt">Endo</span> <span class="fu">.</span> (<span class="fu">&lt;&gt;</span>) <span class="fu">.</span>
      liftA2 toParam (fromString <span class="fu">.</span> symbolVal <span class="fu">.</span> proxyAssocKey) getField)
    (<span class="ot">library ::</span> <span class="dt">Comp</span> <span class="dt">Dict</span> (<span class="dt">KeyValue</span> <span class="dt">KnownSymbol</span> <span class="dt">ToParam</span>) <span class="fu">:*</span> xs)</code></pre></div>
<p><code>ToParam</code> 型クラスは <code>chatwork</code> パッケージのときにも定義した． もちろん，<code>Text</code> 型や <code>Bool</code> 型のインスタンスも定義してある． 前と違うのは <code>Identity</code> 型のインスタンス． <code>Forall (KeyValue KnownSymbol ToParam) xs</code> 型クラスは，<code>xs</code> が<a href="http://hackage.haskell.org/package/extensible-0.4.3/docs/Data-Extensible-Field.html#t:Record">普通の拡張可能レコード</a>の場合は <code>Member xs x =&gt; ToParam (Identity (AssocValue x))</code> であることを保証するため定義した(<code>Identity</code> 以外のモナドにしようと思えばできるけど)．</p>
<p>これで <code>toParams</code> を呼ぶだけで，<code>req</code> でのリクエストパラメータとして使える(やったぁ)．</p>
<h3 id="default-型クラス"><code>Default</code> 型クラス</h3>
<p>リクエストパラメータのフィールドはこんなにあるけど，基本使わない… なので，デフォルトな値があって，レコード構文みたいに書き換えるのが良くある手法な気がする．</p>
<div class="sourceCode"><pre class="sourceCode haskell"><code class="sourceCode haskell">param <span class="fu">=</span> defaultParam { keyword <span class="fu">=</span> <span class="st">&quot;Rakuten&quot;</span> }</code></pre></div>
<p>しかし，このデフォルトの値を定義するのもだるい！ なので，拡張可能レコードを <a href="http://hackage.haskell.org/package/data-default-class"><code>data-default-class</code></a> パッケージの <a href="http://hackage.haskell.org/package/data-default-class-0.1.2.0/docs/Data-Default-Class.html#t:Default"><code>Default</code></a> 型クラスのインスタンスにしてしまおう！</p>
<div class="sourceCode"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span class="kw">instance</span> <span class="dt">Default</span> a <span class="ot">=&gt;</span> <span class="dt">Default</span> (<span class="dt">Identity</span> a) <span class="kw">where</span>
  def <span class="fu">=</span> <span class="dt">Identity</span> def

<span class="kw">instance</span> <span class="dt">Default</span> <span class="dt">Text</span> <span class="kw">where</span>
  def <span class="fu">=</span> mempty

<span class="kw">instance</span> <span class="dt">Forall</span> (<span class="dt">KeyValue</span> <span class="dt">KnownSymbol</span> <span class="dt">Default</span>) xs <span class="ot">=&gt;</span> <span class="dt">Default</span> (<span class="dt">Record</span> xs) <span class="kw">where</span>
  def <span class="fu">=</span> runIdentity <span class="fu">$</span> hgenerateFor
    (<span class="dt">Proxy</span><span class="ot"> ::</span> <span class="dt">Proxy</span> (<span class="dt">KeyValue</span> <span class="dt">KnownSymbol</span> <span class="dt">Default</span>)) (const <span class="fu">$</span> pure (<span class="dt">Field</span> def))</code></pre></div>
<p>簡単ですね． これで，<a href="https://hackage.haskell.org/package/lens"><code>lens</code></a> のセッターを使って簡単に書き換えれるようになった．</p>
<div class="sourceCode"><pre class="sourceCode haskell"><code class="sourceCode haskell">param <span class="fu">=</span> def <span class="fu">&amp;</span> <span class="fu">#</span>keyword <span class="fu">.~</span> <span class="st">&quot;Rakuten&quot;</span></code></pre></div>
<h2 id="気になるところ">気になるところ</h2>
<p>Haskell の型クラスのインスタンスのスコープって制限するのは難しい． なので，拡張可能レコード全般という，こうも広範囲に影響しそうなインスタンスをバシバシ定義してもいいのかなぁという気持ちはある．</p>
<p>(だれもこのパッケージを使わないだろうけど)</p>
<h2 id="おしまい">おしまい</h2>
<p>それでも全てのエンドポイント分を作るのはだるいけどね…</p>
  </div>
</div>
</article>

          </div>
        </div>

        <footer class="site-footer">

  <div class="wrapper">

    <span class="footer-heading">ひげメモ</span>

  </div>

  <div class="page-content card" style="display: flex; justify-content: center; padding: 5px 0px">
    <a href="https://haskell.jp/blog/posts/links.html#matsubara0507.github.io">
      <img width="234" src="https://haskell.jp/img/supported-by-haskell-jp.svg" alt="Supported By Haskell-jp.">
    </a>
  </div>

</footer>


      </div>
  </body>

</html>
