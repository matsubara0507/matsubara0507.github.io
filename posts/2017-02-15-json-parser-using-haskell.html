<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE html>
<html lang="ja">

  <head>
  <meta charset="utf-8">
  <link rel="icon" href="../assets/icon.jpg">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
    
      <meta property="og:title" content="Haskell による JSON Parser" />
    
  

  <meta property="og:site_name" content="ひげメモ" />

  

  
    <script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-86386380-1', 'auto');
  ga('send', 'pageview');
</script>

  

  <title>
    
      
        Haskell による JSON Parser
      
    
  </title>

  <link rel="stylesheet" href="../css/main.css">
  <link rel="stylesheet" href="../css/highlight.css">
  <link rel="stylesheet" type="text/css" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.4.0/css/font-awesome.min.css" />
</head>


  <body>
      <div class="outer">

        <header class="site-header">

  <div class="wrapper">

    <a class="site-title" href="https://matsubara0507.github.io/">ひげメモ</a>

  </div>

  <div class="header-badge">
    <a href="https://matsubara0507.github.io/">
        <img src="../assets/icon.jpg" />
    </a>
  </div>

</header>


        <div class="page-content">
          <div class="wrapper">
            <article class="post card" itemscope itemtype="http://schema.org/BlogPosting">
 <div class="card-content">
  <header class="post-header">
    <h1 class="post-title" itemprop="name headline">Haskell による JSON Parser</h1>
    <p class="post-meta">
      <time datetime="2017-02-15" itemprop="datePublished">
        Feb 15, 2017
      </time>
      
    </p>
  </header>

  <div class="post-content" itemprop="articleBody">
    <p>タイトルの通り． Haskell の Functional Parser ライブラリ，Parsec を使って，JSON Parser を作った話． ありきたりですね．</p>
<p>作ったコードのリポジトリは<a href="https://github.com/matsubara0507/jsonparser">ココ</a>です．</p>
<h2 id="いきさつ">いきさつ</h2>
<p>名〇屋でやってる(数少ない FP な)勉強会，「<a href="https://fp-in-scala-nagoya.connpass.com/">FP in Scala 読書会</a>」に6月ぐらいから参加している． 前々回ぐらいから第8章の「関数型パーサー」に入って，猛烈な盛り上がりを見せている(？)．</p>
<p>書籍中の例題として JSON Parser を書くのだが，目の前の人が無限に「<a href="http://json.org">json.org</a> は素晴らしい」と言っており，洗脳されたため，サクッと JSON Parser を書きたくなってしまった．</p>
<p>まぁサクッと書くなら Haskell ですよねってことで書いてみた(Scala で書けよ)．</p>
<h2 id="作る">作る</h2>
<h3 id="型">型</h3>
<p>(関数型プログラミングの常套手段として)まずは型を用意する．</p>
<div class="sourceCode"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span class="kw">type</span> <span class="dt">JSON</span> <span class="fu">=</span> [(<span class="dt">String</span>, <span class="dt">JValue</span>)]  <span class="co">-- (1)</span>
<span class="kw">data</span> <span class="dt">JValue</span> <span class="fu">=</span> <span class="dt">JNull</span>             
            <span class="fu">|</span> <span class="dt">JNumber</span> <span class="dt">Double</span>
            <span class="fu">|</span> <span class="dt">JString</span> <span class="dt">String</span>
            <span class="fu">|</span> <span class="dt">JBool</span>   <span class="dt">Bool</span>
            <span class="fu">|</span> <span class="dt">JArray</span>  [<span class="dt">JValue</span>]
            <span class="fu">|</span> <span class="dt">JObject</span> <span class="dt">JSON</span>      <span class="co">-- (2)</span>
            <span class="kw">deriving</span> (<span class="dt">Show</span>, <span class="dt">Eq</span>)</code></pre></div>
<p>(1)のように，わざわざ型シノニムする必要は全くない((2)の <code>JSON</code> を置き換えればよい)が，頭の整理がつきやすかったので敢えて書いた． 言語によっては連想配列を使っていると思うが，どーせ頭から順にパースした結果を突っ込むだけなので，解析中はリストで十分なはず．</p>
<p>数値に <code>Double</code> 型を使ってるのも気になるが，<a href="http://book.impress.co.jp/books/1114101091">FP in Scala</a>でも <code>Double</code> 使ってるからこれでいいかな．</p>
<div class="sourceCode"><pre class="sourceCode scala"><code class="sourceCode scala"><span class="kw">trait</span> JSON

<span class="kw">object</span> JSON {
  <span class="kw">case</span> <span class="kw">object</span> JNull <span class="kw">extends</span> JSON
  <span class="kw">case</span> <span class="kw">class</span> <span class="fu">JNumber</span>(get: Double) <span class="kw">extends</span> JSON
  <span class="kw">case</span> <span class="kw">class</span> <span class="fu">JString</span>(get: String) <span class="kw">extends</span> JSON
  <span class="kw">case</span> <span class="kw">class</span> <span class="fu">JBool</span>(get: Boolean) <span class="kw">extends</span> JSON
  <span class="kw">case</span> <span class="kw">class</span> <span class="fu">JArray</span>(get: IndexedSeq[JSON]) <span class="kw">extends</span> JSON
  <span class="kw">case</span> <span class="kw">class</span> <span class="fu">JObject</span>(get: Map[String, JSON]) <span class="kw">extends</span> JSON
}</code></pre></div>
<p>Scala と比べるとすごいシンプルに書けるよね． すばらしい．</p>
<h3 id="パーサー">パーサー</h3>
<p>後は，JSON の BNF みて実装するだけ．</p>
<p>ちなみに，関数型プログラミングなのでトップダウン的に考える． 細部はまだ <code>undefined</code> にして，定期的にコンパイルすべき． 例えば</p>
<div class="sourceCode"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span class="ot">jsonParser ::</span> <span class="dt">Parser</span> <span class="dt">JSON</span>
jsonParser <span class="fu">=</span> objectParser

<span class="ot">objectParser ::</span> <span class="dt">Parser</span> <span class="dt">JSON</span>
objectParser <span class="fu">=</span> between (string <span class="st">&quot;{&quot;</span>) (string <span class="st">&quot;}&quot;</span>) membersParser

<span class="ot">membersParser ::</span> <span class="dt">Parser</span> <span class="dt">JSON</span>
membersParser <span class="fu">=</span> undefined</code></pre></div>
<p>と書いて，コンパイルし，問題なければ</p>
<div class="sourceCode"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span class="ot">membersParser ::</span> <span class="dt">Parser</span> <span class="dt">JSON</span>
membersParser <span class="fu">=</span> pairParser <span class="ot">`sepBy`</span> char <span class="ch">','</span>

<span class="ot">pairParser ::</span> <span class="dt">Parser</span> (<span class="dt">String</span>, <span class="dt">JValue</span>)
pairParser <span class="fu">=</span> undefined</code></pre></div>
<p>と次の階層へ降りていく．</p>
<p>ちなみに <code>string</code>, <code>between</code>, <code>sepBy</code>, <code>char</code> は <a href="https://hackage.haskell.org/package/megaparsec">megaparsec</a> というライブラリに標準である関数(もとい Parsec 系のライブラリにはだいたいある)． 本当に便利．</p>
<h3 id="工夫">工夫</h3>
<p>殆んどない． 強いてあげるなら，Monad は使わずに Applicative だけで書いた． JSON は文脈自由文法なので bind (flatMap, do記法) は要らない(と FP in Scala には書いてあった)．</p>
<p>その代わり，読みにくい関数もあるけどね．</p>
<p>これとか</p>
<div class="sourceCode"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span class="ot">pairParser ::</span> <span class="dt">Parser</span> (<span class="dt">String</span>, <span class="dt">JValue</span>)
pairParser <span class="fu">=</span> (,) <span class="fu">&lt;$&gt;</span> (token stringParser <span class="fu">&lt;*</span> char <span class="ch">':'</span>) <span class="fu">&lt;*&gt;</span> token valueParser</code></pre></div>
<p>あとは，様々な記法の数値を変換するのだるくて <code>read</code> 使った(そのために文字列を返して最後に読んでる)．</p>
<h3 id="今後">今後</h3>
<p>GADT と存在型(?)を使って，<code>Double</code> を任意の <code>Num</code> 型クラスのインスタンス型を解釈させてもいいかも．</p>
<div class="sourceCode"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span class="kw">data</span> <span class="dt">JValue</span> <span class="kw">where</span>
  <span class="dt">JNull</span><span class="ot">   ::</span> <span class="dt">JValue</span>
  <span class="dt">JNumber</span><span class="ot"> ::</span> <span class="dt">Num</span> a <span class="ot">=&gt;</span> a <span class="ot">-&gt;</span> <span class="dt">JValue</span>
  <span class="dt">JString</span><span class="ot"> ::</span> <span class="dt">String</span> <span class="ot">-&gt;</span> <span class="dt">JValue</span>
  <span class="dt">JBool</span><span class="ot">   ::</span> <span class="dt">Bool</span> <span class="ot">-&gt;</span> <span class="dt">JValue</span>
  <span class="dt">JArray</span><span class="ot">  ::</span> [<span class="dt">JValue</span>] <span class="ot">-&gt;</span> <span class="dt">JValue</span>
  <span class="dt">JObject</span><span class="ot"> ::</span> <span class="dt">JSON</span> <span class="ot">-&gt;</span> <span class="dt">JValue</span></code></pre></div>
<p>うまくいくかはわかんない． <code>read</code> 使ってるからつらそう．</p>
<h2 id="おしまい">おしまい</h2>
  </div>
</div>
</article>

          </div>
        </div>

        <footer class="site-footer">

  <div class="wrapper">

    <span class="footer-heading">ひげメモ</span>

  </div>

</footer>


      </div>
  </body>

</html>
