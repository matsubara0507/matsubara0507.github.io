<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE html>
<html lang="ja">

  <head>
  <meta charset="utf-8">
  <link rel="icon" href="../assets/icon.jpg">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
    
      <meta property="og:title" content="Haskell による JSON Parser" />
    
  

  <meta property="og:site_name" content="ひげメモ" />

  

  
    <script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-86386380-1', 'auto');
  ga('send', 'pageview');
</script>

  

  <title>
    
      
        Haskell による JSON Parser
      
    
  </title>

  <link rel="stylesheet" href="../css/main.css">
  <link rel="stylesheet" href="../css/highlight.css">
  <link rel="stylesheet" type="text/css" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.4.0/css/font-awesome.min.css" />
</head>


  <body>
      <div class="outer">

        <header class="site-header">

  <div class="wrapper">

    <a class="site-title" href="https://matsubara0507.github.io/">ひげメモ</a>

  </div>

  <div class="header-badge">
    <a href="https://matsubara0507.github.io/">
        <img src="../assets/icon.jpg" />
    </a>
  </div>

</header>


        <div class="page-content">
          <div class="wrapper">
            <article class="post card" itemscope itemtype="http://schema.org/BlogPosting">
 <div class="card-content">
  <header class="post-header">
    <h1 class="post-title" itemprop="name headline">Haskell による JSON Parser</h1>
    <p class="post-meta">
      <time datetime="2017-02-15" itemprop="datePublished">
        Feb 15, 2017
      </time>
      
    </p>
  </header>

  <div class="post-content" itemprop="articleBody">
    <p>タイトルの通り． Haskell の Functional Parser ライブラリ，Parsec を使って，JSON Parser を作った話． ありきたりですね．</p>
<p>作ったコードのリポジトリは<a href="https://github.com/matsubara0507/jsonparser">ココ</a>です．</p>
<h5 id="追記2018.02.14">追記(2018.02.14)</h5>
<p>GitHub にあった<a href="https://github.com/nst/JSONTestSuite">テストスイート</a>を使ってテストを書いてみたらイロイロと JSON を勘違いしていたので大幅修正した．</p>
<h2 id="いきさつ">いきさつ</h2>
<p>名〇屋でやってる(数少ない FP な)勉強会，「<a href="https://fp-in-scala-nagoya.connpass.com/">FP in Scala 読書会</a>」に6月ぐらいから参加している． 前々回ぐらいから第8章の「関数型パーサー」に入って，猛烈な盛り上がりを見せている(？)．</p>
<p>書籍中の例題として JSON Parser を書くのだが，目の前の人が無限に「<a href="http://json.org">json.org</a> は素晴らしい」と言っており，洗脳されたため，サクッと JSON Parser を書きたくなってしまった．</p>
<p>まぁサクッと書くなら Haskell ですよねってことで書いてみた(Scala で書けよ)．</p>
<h2 id="作る">作る</h2>
<h3 id="型">型</h3>
<p>(関数型プログラミングの常套手段として)まずは型を用意する．</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb1-1" data-line-number="1"><span class="kw">type</span> <span class="dt">JSON</span> <span class="fu">=</span> <span class="dt">JValue</span></a>
<a class="sourceLine" id="cb1-2" data-line-number="2"><span class="kw">type</span> <span class="dt">Pair</span> <span class="fu">=</span> (<span class="dt">String</span>, <span class="dt">JValue</span>)</a>
<a class="sourceLine" id="cb1-3" data-line-number="3"></a>
<a class="sourceLine" id="cb1-4" data-line-number="4"><span class="kw">data</span> <span class="dt">JValue</span></a>
<a class="sourceLine" id="cb1-5" data-line-number="5">  <span class="fu">=</span> <span class="dt">JNull</span></a>
<a class="sourceLine" id="cb1-6" data-line-number="6">  <span class="fu">|</span> <span class="dt">JNumber</span> <span class="dt">Double</span></a>
<a class="sourceLine" id="cb1-7" data-line-number="7">  <span class="fu">|</span> <span class="dt">JString</span> <span class="dt">String</span></a>
<a class="sourceLine" id="cb1-8" data-line-number="8">  <span class="fu">|</span> <span class="dt">JBool</span>   <span class="dt">Bool</span></a>
<a class="sourceLine" id="cb1-9" data-line-number="9">  <span class="fu">|</span> <span class="dt">JObject</span> [<span class="dt">Pair</span>]</a>
<a class="sourceLine" id="cb1-10" data-line-number="10">  <span class="fu">|</span> <span class="dt">JArray</span>  [<span class="dt">JValue</span>]</a>
<a class="sourceLine" id="cb1-11" data-line-number="11">  <span class="kw">deriving</span> (<span class="dt">Show</span>, <span class="dt">Eq</span>)</a></code></pre></div>
<p>数値に <code>Double</code> 型を使ってるのも気になるが，<a href="http://book.impress.co.jp/books/1114101091">FP in Scala</a>でも <code>Double</code> 使ってるからこれでいいかな．</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode scala"><code class="sourceCode scala"><a class="sourceLine" id="cb2-1" data-line-number="1"><span class="kw">trait</span> JSON</a>
<a class="sourceLine" id="cb2-2" data-line-number="2"></a>
<a class="sourceLine" id="cb2-3" data-line-number="3"><span class="kw">object</span> JSON {</a>
<a class="sourceLine" id="cb2-4" data-line-number="4">  <span class="kw">case</span> <span class="kw">object</span> JNull <span class="kw">extends</span> JSON</a>
<a class="sourceLine" id="cb2-5" data-line-number="5">  <span class="kw">case</span> <span class="kw">class</span> <span class="fu">JNumber</span>(get: Double) <span class="kw">extends</span> JSON</a>
<a class="sourceLine" id="cb2-6" data-line-number="6">  <span class="kw">case</span> <span class="kw">class</span> <span class="fu">JString</span>(get: String) <span class="kw">extends</span> JSON</a>
<a class="sourceLine" id="cb2-7" data-line-number="7">  <span class="kw">case</span> <span class="kw">class</span> <span class="fu">JBool</span>(get: Boolean) <span class="kw">extends</span> JSON</a>
<a class="sourceLine" id="cb2-8" data-line-number="8">  <span class="kw">case</span> <span class="kw">class</span> <span class="fu">JArray</span>(get: IndexedSeq[JSON]) <span class="kw">extends</span> JSON</a>
<a class="sourceLine" id="cb2-9" data-line-number="9">  <span class="kw">case</span> <span class="kw">class</span> <span class="fu">JObject</span>(get: Map[String, JSON]) <span class="kw">extends</span> JSON</a>
<a class="sourceLine" id="cb2-10" data-line-number="10">}</a></code></pre></div>
<p>Scala と比べるとすごいシンプルに書けるよね． すばらしい．</p>
<h3 id="パーサー">パーサー</h3>
<p>後は，JSON の BNF みて実装するだけ．</p>
<p>ちなみに，関数型プログラミングなのでトップダウン的に考える． 細部はまだ <code>undefined</code> にして，定期的にコンパイルすべき． 例えば</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb3-1" data-line-number="1"><span class="kw">import</span> <span class="dt">Text.Megaparsec</span> (<span class="dt">Parsec</span>, between)</a>
<a class="sourceLine" id="cb3-2" data-line-number="2"><span class="kw">import</span> <span class="dt">Text.Megaparsec.Char</span> (string, space)</a>
<a class="sourceLine" id="cb3-3" data-line-number="3"></a>
<a class="sourceLine" id="cb3-4" data-line-number="4"><span class="kw">type</span> <span class="dt">Parser</span> <span class="fu">=</span> <span class="dt">Parsec</span> <span class="dt">String</span> <span class="dt">String</span></a>
<a class="sourceLine" id="cb3-5" data-line-number="5"></a>
<a class="sourceLine" id="cb3-6" data-line-number="6"><span class="ot">jsonParser ::</span> <span class="dt">Parser</span> <span class="dt">JSON</span></a>
<a class="sourceLine" id="cb3-7" data-line-number="7">jsonParser <span class="fu">=</span> token valueParser</a>
<a class="sourceLine" id="cb3-8" data-line-number="8"></a>
<a class="sourceLine" id="cb3-9" data-line-number="9"><span class="ot">valueParser ::</span> <span class="dt">Parser</span> <span class="dt">JValue</span></a>
<a class="sourceLine" id="cb3-10" data-line-number="10">valueParser</a>
<a class="sourceLine" id="cb3-11" data-line-number="11">    <span class="fu">=</span> <span class="dt">JString</span> <span class="fu">&lt;$&gt;</span> stringParser</a>
<a class="sourceLine" id="cb3-12" data-line-number="12">  <span class="fu">&lt;|&gt;</span> <span class="dt">JNumber</span> <span class="fu">&lt;$&gt;</span> numberParser</a>
<a class="sourceLine" id="cb3-13" data-line-number="13">  <span class="fu">&lt;|&gt;</span> <span class="dt">JObject</span> <span class="fu">&lt;$&gt;</span> objectParser</a>
<a class="sourceLine" id="cb3-14" data-line-number="14">  <span class="fu">&lt;|&gt;</span> <span class="dt">JArray</span>  <span class="fu">&lt;$&gt;</span> arrayParser</a>
<a class="sourceLine" id="cb3-15" data-line-number="15">  <span class="fu">&lt;|&gt;</span> <span class="dt">JBool</span>   <span class="fu">&lt;$&gt;</span> boolParser</a>
<a class="sourceLine" id="cb3-16" data-line-number="16">  <span class="fu">&lt;|&gt;</span> const <span class="dt">JNull</span> <span class="fu">&lt;$&gt;</span> string <span class="st">&quot;null&quot;</span></a>
<a class="sourceLine" id="cb3-17" data-line-number="17"></a>
<a class="sourceLine" id="cb3-18" data-line-number="18"><span class="ot">token ::</span> <span class="dt">Parser</span> a <span class="ot">-&gt;</span> <span class="dt">Parser</span> a</a>
<a class="sourceLine" id="cb3-19" data-line-number="19">token p <span class="fu">=</span> space <span class="fu">*&gt;</span> p <span class="fu">&lt;*</span> space</a>
<a class="sourceLine" id="cb3-20" data-line-number="20"></a>
<a class="sourceLine" id="cb3-21" data-line-number="21"><span class="ot">stringParser ::</span> <span class="dt">Parser</span> <span class="dt">String</span></a>
<a class="sourceLine" id="cb3-22" data-line-number="22">stringParser <span class="fu">=</span> undefined</a>
<a class="sourceLine" id="cb3-23" data-line-number="23"></a>
<a class="sourceLine" id="cb3-24" data-line-number="24"><span class="ot">numberParser ::</span> <span class="dt">Parser</span> <span class="dt">Double</span></a>
<a class="sourceLine" id="cb3-25" data-line-number="25">numberParser <span class="fu">=</span> undefined</a>
<a class="sourceLine" id="cb3-26" data-line-number="26"></a>
<a class="sourceLine" id="cb3-27" data-line-number="27"><span class="ot">objectParser ::</span> <span class="dt">Parser</span> [<span class="dt">Pair</span>]</a>
<a class="sourceLine" id="cb3-28" data-line-number="28">objectParser <span class="fu">=</span> undefined</a>
<a class="sourceLine" id="cb3-29" data-line-number="29"></a>
<a class="sourceLine" id="cb3-30" data-line-number="30"><span class="ot">arrayParser ::</span> <span class="dt">Parser</span> [<span class="dt">JValue</span>]</a>
<a class="sourceLine" id="cb3-31" data-line-number="31">arrayParser <span class="fu">=</span> undefined</a>
<a class="sourceLine" id="cb3-32" data-line-number="32"></a>
<a class="sourceLine" id="cb3-33" data-line-number="33"><span class="ot">boolParser ::</span> <span class="dt">Parser</span> <span class="dt">Bool</span></a>
<a class="sourceLine" id="cb3-34" data-line-number="34">boolParser <span class="fu">=</span> undefined</a></code></pre></div>
<p>と書いて，コンパイルし，問題なければ書きやすいところから少しずつ書いていく(書いてコンパイルを繰り返す)．</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb4-1" data-line-number="1"><span class="ot">symbol ::</span> <span class="dt">String</span> <span class="ot">-&gt;</span> <span class="dt">Parser</span> <span class="dt">String</span></a>
<a class="sourceLine" id="cb4-2" data-line-number="2">symbol <span class="fu">=</span> token <span class="fu">.</span> string</a>
<a class="sourceLine" id="cb4-3" data-line-number="3"></a>
<a class="sourceLine" id="cb4-4" data-line-number="4"><span class="ot">objectParser ::</span> <span class="dt">Parser</span> [<span class="dt">Pair</span>]</a>
<a class="sourceLine" id="cb4-5" data-line-number="5">objectParser <span class="fu">=</span> between (symbol <span class="st">&quot;{&quot;</span>) (symbol <span class="st">&quot;}&quot;</span>) membersParser</a>
<a class="sourceLine" id="cb4-6" data-line-number="6"></a>
<a class="sourceLine" id="cb4-7" data-line-number="7"><span class="ot">membersParser ::</span> <span class="dt">Parser</span> [<span class="dt">Pair</span>]</a>
<a class="sourceLine" id="cb4-8" data-line-number="8">membersParser <span class="fu">=</span> undefined</a></code></pre></div>
<h3 id="工夫">工夫</h3>
<p>殆んどない． 強いてあげるなら，Monad は使わずに Applicative だけで書いた． JSON は文脈自由文法なので bind (flatMap, do記法) は要らない(と FP in Scala には書いてあった)． その代わり，読みにくい関数もあるけどね．</p>
<p>これ(<code>pairParser</code>)とか</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb5-1" data-line-number="1"><span class="ot">membersParser ::</span> <span class="dt">Parser</span> [<span class="dt">Pair</span>]</a>
<a class="sourceLine" id="cb5-2" data-line-number="2">membersParser <span class="fu">=</span> pairParser <span class="ot">`sepBy`</span> char <span class="ch">','</span></a>
<a class="sourceLine" id="cb5-3" data-line-number="3"></a>
<a class="sourceLine" id="cb5-4" data-line-number="4"><span class="ot">pairParser ::</span> <span class="dt">Parser</span> <span class="dt">Pair</span></a>
<a class="sourceLine" id="cb5-5" data-line-number="5">pairParser <span class="fu">=</span> (,) <span class="fu">&lt;$&gt;</span> (token stringParser <span class="fu">&lt;*</span> char <span class="ch">':'</span>) <span class="fu">&lt;*&gt;</span> token valueParser</a></code></pre></div>
<p>あとは，様々な記法の数値を変換するのだるくて <code>read</code> 使った(そのために文字列を返して最後に読んでる)．</p>
<h3 id="今後">今後</h3>
<p>GADT と存在型(?)を使って，<code>Double</code> を任意の <code>Num</code> 型クラスのインスタンス型を解釈させてもいいかも．</p>
<div class="sourceCode" id="cb6"><pre class="sourceCode haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb6-1" data-line-number="1"><span class="kw">data</span> <span class="dt">JValue</span> <span class="kw">where</span></a>
<a class="sourceLine" id="cb6-2" data-line-number="2">  <span class="dt">JNull</span><span class="ot">   ::</span> <span class="dt">JValue</span></a>
<a class="sourceLine" id="cb6-3" data-line-number="3">  <span class="dt">JNumber</span><span class="ot"> ::</span> <span class="dt">Num</span> a <span class="ot">=&gt;</span> a <span class="ot">-&gt;</span> <span class="dt">JValue</span></a>
<a class="sourceLine" id="cb6-4" data-line-number="4">  <span class="dt">JString</span><span class="ot"> ::</span> <span class="dt">String</span> <span class="ot">-&gt;</span> <span class="dt">JValue</span></a>
<a class="sourceLine" id="cb6-5" data-line-number="5">  <span class="dt">JBool</span><span class="ot">   ::</span> <span class="dt">Bool</span> <span class="ot">-&gt;</span> <span class="dt">JValue</span></a>
<a class="sourceLine" id="cb6-6" data-line-number="6">  <span class="dt">JArray</span><span class="ot">  ::</span> [<span class="dt">JValue</span>] <span class="ot">-&gt;</span> <span class="dt">JValue</span></a>
<a class="sourceLine" id="cb6-7" data-line-number="7">  <span class="dt">JObject</span><span class="ot"> ::</span> <span class="dt">JSON</span> <span class="ot">-&gt;</span> <span class="dt">JValue</span></a></code></pre></div>
<p>うまくいくかはわかんない． <code>read</code> 使ってるからつらそう．</p>
<h2 id="おしまい">おしまい</h2>
  </div>
</div>
</article>

          </div>
        </div>

        <footer class="site-footer">

  <div class="wrapper">

    <span class="footer-heading">ひげメモ</span>

  </div>

  <div class="page-content card" style="display: flex; justify-content: center; padding: 5px 0px">
    <a href="https://haskell.jp/blog/posts/links.html#matsubara0507.github.io">
      <img width="234" src="https://haskell.jp/img/supported-by-haskell-jp.svg" alt="Supported By Haskell-jp.">
    </a>
  </div>

</footer>


      </div>
  </body>

</html>
