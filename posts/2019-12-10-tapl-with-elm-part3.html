<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE html>
<html lang="ja">

  <head>
  <meta charset="utf-8">
  <link rel="icon" href="../assets/icon.jpg">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
    
      <meta property="og:title" content="Elm で作る TaPL のラムダ計算（その３）" />
    
  

  <meta property="og:site_name" content="ひげメモ" />

  
    <meta property="og:image" content="/assets/tapl-with-elm/chap10.jpg" />
  

  
    <script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-86386380-1', 'auto');
  ga('send', 'pageview');
</script>

  

  <title>
    
      
        Elm で作る TaPL のラムダ計算（その３）
      
    
  </title>

  <link rel="stylesheet" href="../css/main.css">
  <link rel="stylesheet" href="../css/highlight.css">
  <link rel="stylesheet" type="text/css" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.4.0/css/font-awesome.min.css" />
</head>


  <body>
      <div class="outer">

        <header class="site-header">

  <div class="wrapper">

    <a class="site-title" href="https://matsubara0507.github.io/">ひげメモ</a>

  </div>

  <div class="header-badge">
    <a href="https://matsubara0507.github.io/">
        <img src="../assets/icon.jpg" />
    </a>
  </div>

</header>


        <div class="page-content">
          <div class="wrapper">
            <article class="post card" itemscope itemtype="http://schema.org/BlogPosting">
 <div class="card-content">
  <header class="post-header">
    <h1 class="post-title" itemprop="name headline">Elm で作る TaPL のラムダ計算（その３）</h1>
    <p class="post-meta">
      <time datetime="2019-12-10" itemprop="datePublished">
        Dec 10, 2019
      </time>
      
      
      <div class="tags">
          <i class="fa fa-tags"></i> <a href="../tags/Elm.html">Elm</a>
      </div>
      
    </p>
  </header>

  <div class="post-content" itemprop="articleBody">
    <p>本記事は「<a href="https://adventar.org/calendars/4212">IGGG Advent Calendar 2019</a>」の10日目の記事です．</p>
<h1 id="section"></h1>
<p>表題の通り，TaPL という書籍で紹介されているプログラミング言語の実装例を Elm でやってみたという話です（その３）． <a href="https://matsubara0507.github.io/posts/2019-12-06-tapl-with-elm-part1.html">その１</a>と<a href="https://matsubara0507.github.io/posts/2019-12-07-tapl-with-elm-part2.html">その２</a>はこちら．</p>
<ul>
<li>第4章 算術式のML実装</li>
<li>第7章 ラムダ計算の ML 実装</li>
<li>第10章 単純型のML実装 (本記事はココ)
<ul>
<li>7章のを型付きラムダ計算にする</li>
</ul></li>
<li>第17章 部分型付けの ML 実装</li>
<li>第25章 System F の ML 実装
<ul>
<li>最後に型の多相性を追加</li>
</ul></li>
</ul>
<p>実装は全て下記のリポジトリにあげています:</p>
<ul>
<li><a href="https://github.com/matsubara0507/ELaMbda">matsubara0507/ELaMbda - GitHub</a></li>
</ul>
<p>また，今まで同様に<a href="https://matsubara0507.github.io/ELaMbda/?chap=chap10">Web ブラウザから遊べるようになってます</a>．</p>
<p><a href="http://localhost:8000/docs/index.html?chap=chap10&amp;exp=(\x%20:%20Bool%20.%20if%20x%20then%20x%20else%20(\f%20:%20Bool%20-%3E%20Bool%20-%3E%20Bool%20.%20f%20x%20x)%20(\x%20:%20Bool%20.%20\y%20:%20Bool%20.%20y))%20(if%20true%20then%20false%20else%20true)"><img src="../assets/tapl-with-elm/chap10.jpg" /></a></p>
<h2 id="第10章-単純型の-ml-実装">第10章 単純型の ML 実装</h2>
<p>さて，いよいよみんな大好き「型」の登場だ． 10章は少し面白くて，4章で実装した算術式の真偽値に関する部分と7章の型なしラムダ計算を組み合わせて，更にそれに型をのせるプログラミング言語を実装する． つまり，今までの実装をちゃんとやっていれば割とサクッとできています．</p>
<h1 id="section-1"></h1>
<p>なお，同期各位は全然やらなかったせいか10章を5週ぐらいやっている笑．</p>
<h3 id="構文規則">構文規則</h3>
<div class="sourceCode" id="cb1"><pre class="sourceCode txt"><code class="sourceCode default"><span id="cb1-1"><a href="#cb1-1"></a>t := x       [変数]</span>
<span id="cb1-2"><a href="#cb1-2"></a>   | \x:T.t  [ラムダ抽象]</span>
<span id="cb1-3"><a href="#cb1-3"></a>   | t t     [関数適用]</span>
<span id="cb1-4"><a href="#cb1-4"></a>   | true</span>
<span id="cb1-5"><a href="#cb1-5"></a>   | false</span>
<span id="cb1-6"><a href="#cb1-6"></a>   | if t then t else t</span>
<span id="cb1-7"><a href="#cb1-7"></a></span>
<span id="cb1-8"><a href="#cb1-8"></a>v := \x:T.t</span>
<span id="cb1-9"><a href="#cb1-9"></a>   | true</span>
<span id="cb1-10"><a href="#cb1-10"></a>   | false</span>
<span id="cb1-11"><a href="#cb1-11"></a></span>
<span id="cb1-12"><a href="#cb1-12"></a>T := Bool    [真偽値型]</span>
<span id="cb1-13"><a href="#cb1-13"></a>   | T -&gt; T  [関数型]</span></code></pre></div>
<p>ラムダ抽象には型注釈(<code>:T</code> の部分)がある． なんで付けるのかとかは9章に書いてあるのでぜひ TaPL を買って読んでください(おい)． これを Elm の型として実装する:</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode elm"><code class="sourceCode elm"><span id="cb2-1"><a href="#cb2-1"></a><span class="kw">type</span> <span class="dt">Term</span></span>
<span id="cb2-2"><a href="#cb2-2"></a>    <span class="op">=</span> <span class="dt">TmVar</span> <span class="dt">Int</span> <span class="dt">Int</span></span>
<span id="cb2-3"><a href="#cb2-3"></a>    <span class="op">|</span> <span class="dt">TmAbs</span> <span class="dt">String</span> <span class="dt">Ty</span> <span class="dt">Term</span></span>
<span id="cb2-4"><a href="#cb2-4"></a>    <span class="op">|</span> <span class="dt">TmApp</span> <span class="dt">Term</span> <span class="dt">Term</span></span>
<span id="cb2-5"><a href="#cb2-5"></a>    <span class="op">|</span> <span class="dt">TmTrue</span></span>
<span id="cb2-6"><a href="#cb2-6"></a>    <span class="op">|</span> <span class="dt">TmFalse</span></span>
<span id="cb2-7"><a href="#cb2-7"></a>    <span class="op">|</span> <span class="dt">TmIf</span> <span class="dt">Term</span> <span class="dt">Term</span> <span class="dt">Term</span></span>
<span id="cb2-8"><a href="#cb2-8"></a></span>
<span id="cb2-9"><a href="#cb2-9"></a><span class="kw">type</span> <span class="dt">Ty</span></span>
<span id="cb2-10"><a href="#cb2-10"></a>    <span class="op">=</span> <span class="dt">TyArr</span> <span class="dt">Ty</span> <span class="dt">Ty</span> <span class="co">-- Arrow の Arr ね</span></span>
<span id="cb2-11"><a href="#cb2-11"></a>    <span class="op">|</span> <span class="dt">TyBool</span></span>
<span id="cb2-12"><a href="#cb2-12"></a></span>
<span id="cb2-13"><a href="#cb2-13"></a><span class="fu">isval</span> : <span class="dt">Context</span> <span class="op">-&gt;</span> <span class="dt">Term</span> <span class="op">-&gt;</span> <span class="dt">Bool</span></span>
<span id="cb2-14"><a href="#cb2-14"></a><span class="fu">isval</span> <span class="fu">_</span> <span class="fu">t</span> <span class="op">=</span></span>
<span id="cb2-15"><a href="#cb2-15"></a>    <span class="cf">case</span> <span class="fu">t</span> <span class="cf">of</span></span>
<span id="cb2-16"><a href="#cb2-16"></a>        <span class="dt">TmAbs</span> <span class="fu">_</span> <span class="fu">_</span> <span class="fu">_</span> <span class="op">-&gt;</span></span>
<span id="cb2-17"><a href="#cb2-17"></a>            <span class="dt">True</span></span>
<span id="cb2-18"><a href="#cb2-18"></a></span>
<span id="cb2-19"><a href="#cb2-19"></a>        <span class="dt">TmTrue</span> <span class="op">-&gt;</span></span>
<span id="cb2-20"><a href="#cb2-20"></a>            <span class="dt">True</span></span>
<span id="cb2-21"><a href="#cb2-21"></a></span>
<span id="cb2-22"><a href="#cb2-22"></a>        <span class="dt">TmFalse</span> <span class="op">-&gt;</span></span>
<span id="cb2-23"><a href="#cb2-23"></a>            <span class="dt">True</span></span>
<span id="cb2-24"><a href="#cb2-24"></a></span>
<span id="cb2-25"><a href="#cb2-25"></a>        <span class="fu">_</span> <span class="op">-&gt;</span></span>
<span id="cb2-26"><a href="#cb2-26"></a>            <span class="dt">False</span></span>
<span id="cb2-27"><a href="#cb2-27"></a></span>
<span id="cb2-28"><a href="#cb2-28"></a><span class="kw">type</span> <span class="kw">alias</span> <span class="dt">Context</span> <span class="op">=</span> <span class="dt">List</span> ( <span class="dt">String</span><span class="op">,</span> <span class="dt">Binding</span> )</span>
<span id="cb2-29"><a href="#cb2-29"></a><span class="kw">type</span> <span class="dt">Binding</span> <span class="op">=</span> <span class="dt">NameBind</span></span></code></pre></div>
<p>型の型 <code>Ty</code> 以外は，4章と7章の <code>Term</code> や <code>isval</code> を合体させているだけだ．</p>
<h3 id="評価規則">評価規則</h3>
<div class="sourceCode" id="cb3"><pre class="sourceCode txt"><code class="sourceCode default"><span id="cb3-1"><a href="#cb3-1"></a>// 7章の評価規則</span>
<span id="cb3-2"><a href="#cb3-2"></a> t1 =&gt; t1'</span>
<span id="cb3-3"><a href="#cb3-3"></a>---------------</span>
<span id="cb3-4"><a href="#cb3-4"></a> t1 t2 =&gt; t1' t2</span>
<span id="cb3-5"><a href="#cb3-5"></a></span>
<span id="cb3-6"><a href="#cb3-6"></a> t2 =&gt; t2'</span>
<span id="cb3-7"><a href="#cb3-7"></a>---------------</span>
<span id="cb3-8"><a href="#cb3-8"></a> v1 t2 =&gt; v1 t2'</span>
<span id="cb3-9"><a href="#cb3-9"></a></span>
<span id="cb3-10"><a href="#cb3-10"></a> (\x:T.t12) v2 -&gt; [x|-&gt; v2]t12</span>
<span id="cb3-11"><a href="#cb3-11"></a></span>
<span id="cb3-12"><a href="#cb3-12"></a>// 4章の評価規則</span>
<span id="cb3-13"><a href="#cb3-13"></a> if true then t2 else t3 =&gt; t2</span>
<span id="cb3-14"><a href="#cb3-14"></a></span>
<span id="cb3-15"><a href="#cb3-15"></a> if false then t2 else t3 =&gt; t3</span>
<span id="cb3-16"><a href="#cb3-16"></a></span>
<span id="cb3-17"><a href="#cb3-17"></a> t1 -&gt; t1'</span>
<span id="cb3-18"><a href="#cb3-18"></a>-------------------------------------------------</span>
<span id="cb3-19"><a href="#cb3-19"></a> if t1 then t2 else t3 =&gt; if t1' then t2 else t3</span></code></pre></div>
<p>評価規則も同様に型注釈の構文が追加されただけでほとんど変わらない． 変わらないということはすなわち，実行時(評価)には型の有無は影響しないということだ． 構文規則同様，4章と7章の実装を組み合わせることで実装が終わる:</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode elm"><code class="sourceCode elm"><span id="cb4-1"><a href="#cb4-1"></a><span class="fu">eval</span> : <span class="dt">Context</span> <span class="op">-&gt;</span> <span class="dt">Term</span> <span class="op">-&gt;</span> <span class="dt">Maybe</span> <span class="dt">Term</span></span>
<span id="cb4-2"><a href="#cb4-2"></a><span class="fu">eval</span> <span class="fu">ctx</span> <span class="fu">t</span> <span class="op">=</span></span>
<span id="cb4-3"><a href="#cb4-3"></a>    <span class="cf">if</span> <span class="fu">isval</span> <span class="fu">ctx</span> <span class="fu">t</span> <span class="cf">then</span></span>
<span id="cb4-4"><a href="#cb4-4"></a>        <span class="dt">Just</span> <span class="fu">t</span></span>
<span id="cb4-5"><a href="#cb4-5"></a>    <span class="cf">else</span></span>
<span id="cb4-6"><a href="#cb4-6"></a>        <span class="dt">Maybe</span><span class="op">.</span><span class="fu">andThen</span> (<span class="fu">eval</span> <span class="fu">ctx</span>) (<span class="fu">eval1</span> <span class="fu">ctx</span> <span class="fu">t</span>)</span>
<span id="cb4-7"><a href="#cb4-7"></a></span>
<span id="cb4-8"><a href="#cb4-8"></a><span class="co">-- あらゆる TmAbs のパターンマッチに Ty のパラメーターを追加する必要はある</span></span>
<span id="cb4-9"><a href="#cb4-9"></a><span class="fu">eval1</span> : <span class="dt">Context</span> <span class="op">-&gt;</span> <span class="dt">Term</span> <span class="op">-&gt;</span> <span class="dt">Maybe</span> <span class="dt">Term</span></span>
<span id="cb4-10"><a href="#cb4-10"></a><span class="fu">eval1</span> <span class="fu">ctx</span> <span class="fu">t</span> <span class="op">=</span></span>
<span id="cb4-11"><a href="#cb4-11"></a>    <span class="cf">case</span> <span class="fu">t</span> <span class="cf">of</span></span>
<span id="cb4-12"><a href="#cb4-12"></a>        <span class="dt">TmApp</span> (<span class="dt">TmAbs</span> <span class="fu">x</span> <span class="fu">ty</span> <span class="fu">t12</span>) <span class="fu">t2</span> <span class="op">-&gt;</span></span>
<span id="cb4-13"><a href="#cb4-13"></a>            <span class="cf">if</span> <span class="fu">isval</span> <span class="fu">ctx</span> <span class="fu">t2</span> <span class="cf">then</span></span>
<span id="cb4-14"><a href="#cb4-14"></a>                <span class="dt">Just</span> (<span class="fu">termSubstTop</span> <span class="fu">t2</span> <span class="fu">t12</span>)</span>
<span id="cb4-15"><a href="#cb4-15"></a>            <span class="cf">else</span></span>
<span id="cb4-16"><a href="#cb4-16"></a>                <span class="dt">Maybe</span><span class="op">.</span><span class="fu">map</span> (<span class="dt">TmApp</span> (<span class="dt">TmAbs</span> <span class="fu">x</span> <span class="fu">ty</span> <span class="fu">t12</span>)) (<span class="fu">eval1</span> <span class="fu">ctx</span> <span class="fu">t2</span>)</span>
<span id="cb4-17"><a href="#cb4-17"></a></span>
<span id="cb4-18"><a href="#cb4-18"></a>        <span class="dt">TmApp</span> <span class="fu">t1</span> <span class="fu">t2</span> <span class="op">-&gt;</span></span>
<span id="cb4-19"><a href="#cb4-19"></a>            <span class="dt">Maybe</span><span class="op">.</span><span class="fu">map</span> (<span class="fu">flip</span> <span class="dt">TmApp</span> <span class="fu">t2</span>) (<span class="fu">eval1</span> <span class="fu">ctx</span> <span class="fu">t1</span>)</span>
<span id="cb4-20"><a href="#cb4-20"></a></span>
<span id="cb4-21"><a href="#cb4-21"></a>        <span class="dt">TmIf</span> <span class="dt">TmTrue</span> <span class="fu">t2</span> <span class="fu">_</span> <span class="op">-&gt;</span></span>
<span id="cb4-22"><a href="#cb4-22"></a>            <span class="dt">Just</span> <span class="fu">t2</span></span>
<span id="cb4-23"><a href="#cb4-23"></a></span>
<span id="cb4-24"><a href="#cb4-24"></a>        <span class="dt">TmIf</span> <span class="dt">TmFalse</span> <span class="fu">_</span> <span class="fu">t3</span> <span class="op">-&gt;</span></span>
<span id="cb4-25"><a href="#cb4-25"></a>            <span class="dt">Just</span> <span class="fu">t3</span></span>
<span id="cb4-26"><a href="#cb4-26"></a></span>
<span id="cb4-27"><a href="#cb4-27"></a>        <span class="dt">TmIf</span> <span class="fu">t1</span> <span class="fu">t2</span> <span class="fu">t3</span> <span class="op">-&gt;</span></span>
<span id="cb4-28"><a href="#cb4-28"></a>            <span class="fu">eval1</span> <span class="fu">ctx</span> <span class="fu">t1</span> <span class="op">|&gt;</span> <span class="dt">Maybe</span><span class="op">.</span><span class="fu">map</span> (\<span class="fu">t1_</span> <span class="op">-&gt;</span> <span class="dt">TmIf</span> <span class="fu">t1_</span> <span class="fu">t2</span> <span class="fu">t3</span>)</span>
<span id="cb4-29"><a href="#cb4-29"></a></span>
<span id="cb4-30"><a href="#cb4-30"></a>        <span class="fu">_</span> <span class="op">-&gt;</span></span>
<span id="cb4-31"><a href="#cb4-31"></a>            <span class="dt">Nothing</span></span>
<span id="cb4-32"><a href="#cb4-32"></a></span>
<span id="cb4-33"><a href="#cb4-33"></a><span class="co">-- t に s を代入する</span></span>
<span id="cb4-34"><a href="#cb4-34"></a><span class="fu">termSubstTop</span> : <span class="dt">Term</span> <span class="op">-&gt;</span> <span class="dt">Term</span> <span class="op">-&gt;</span> <span class="dt">Term</span></span>
<span id="cb4-35"><a href="#cb4-35"></a><span class="fu">termSubstTop</span> <span class="fu">s</span> <span class="fu">t</span> <span class="op">=</span> <span class="op">...</span></span></code></pre></div>
<h3 id="型付け規則">型付け規則</h3>
<p>ここからが新しい． いわゆる型検査のことだ． TaPL では「正しく型付けされた項はおかしくならない」という性質(安全性・健全性ともいう)について議論されている(8章で)． 例えば，これから定義する型検査が通った項(<code>Term</code>)は <code>eval</code> 関数を適用しても無限ループなどにはならない． さて，そのための型付け規則は次のようになっている:</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode txt"><code class="sourceCode default"><span id="cb5-1"><a href="#cb5-1"></a>// 真偽値の型付け規則</span>
<span id="cb5-2"><a href="#cb5-2"></a> true : Bool</span>
<span id="cb5-3"><a href="#cb5-3"></a></span>
<span id="cb5-4"><a href="#cb5-4"></a> false : Bool</span>
<span id="cb5-5"><a href="#cb5-5"></a></span>
<span id="cb5-6"><a href="#cb5-6"></a> t1 : Bool    t2 : T    t3 : T</span>
<span id="cb5-7"><a href="#cb5-7"></a>-------------------------------</span>
<span id="cb5-8"><a href="#cb5-8"></a> if t1 then t2 else t3 : T</span>
<span id="cb5-9"><a href="#cb5-9"></a></span>
<span id="cb5-10"><a href="#cb5-10"></a>// 単純ラムダ計算の型付け規則</span>
<span id="cb5-11"><a href="#cb5-11"></a> x : T ∈ Γ</span>
<span id="cb5-12"><a href="#cb5-12"></a>-----------</span>
<span id="cb5-13"><a href="#cb5-13"></a> Γ ⊢ x : T</span>
<span id="cb5-14"><a href="#cb5-14"></a></span>
<span id="cb5-15"><a href="#cb5-15"></a> Γ, x : T1 ⊢ t2 : T2</span>
<span id="cb5-16"><a href="#cb5-16"></a>-----------------------------</span>
<span id="cb5-17"><a href="#cb5-17"></a> Γ ⊢ \x : T1 . t2 : T1 -&gt; T2</span>
<span id="cb5-18"><a href="#cb5-18"></a></span>
<span id="cb5-19"><a href="#cb5-19"></a> Γ ⊢ t1 : T11 -&gt; T12    Γ ⊢ t2 : T11</span>
<span id="cb5-20"><a href="#cb5-20"></a>-------------------------------------</span>
<span id="cb5-21"><a href="#cb5-21"></a> Γ ⊢ t1 t2 : T12</span></code></pre></div>
<p>ここで新しく出てくる <code>Γ</code> は型環境と言い，変数と型の対応関係を線形リストのような感じに保持している． <code>Γ ⊢ t : T</code> というのは「型環境 <code>Γ</code> のもと項 <code>t</code> は型 <code>T</code> に型付け可能」という風に読める(たぶん)． まぁ実装してみればわかる(ほんとか？):</p>
<div class="sourceCode" id="cb6"><pre class="sourceCode elm"><code class="sourceCode elm"><span id="cb6-1"><a href="#cb6-1"></a><span class="co">-- 型環境には Context を再利用する</span></span>
<span id="cb6-2"><a href="#cb6-2"></a><span class="kw">type</span> <span class="kw">alias</span> <span class="dt">Context</span> <span class="op">=</span> <span class="dt">List</span> ( <span class="dt">String</span><span class="op">,</span> <span class="dt">Binding</span> )</span>
<span id="cb6-3"><a href="#cb6-3"></a><span class="kw">type</span> <span class="dt">Binding</span></span>
<span id="cb6-4"><a href="#cb6-4"></a>    <span class="op">=</span> <span class="dt">NameBind</span></span>
<span id="cb6-5"><a href="#cb6-5"></a>    <span class="op">|</span> <span class="dt">VarBind</span> <span class="dt">Ty</span> <span class="co">-- 変数の型を保持</span></span>
<span id="cb6-6"><a href="#cb6-6"></a></span>
<span id="cb6-7"><a href="#cb6-7"></a><span class="co">-- 項 t の型が最終的に導出できれば型付け可能ということになる</span></span>
<span id="cb6-8"><a href="#cb6-8"></a><span class="fu">typeof</span> : <span class="dt">Context</span> <span class="op">-&gt;</span> <span class="dt">Term</span> <span class="op">-&gt;</span> <span class="dt">Maybe</span> <span class="dt">Ty</span></span>
<span id="cb6-9"><a href="#cb6-9"></a><span class="fu">typeof</span> <span class="fu">ctx</span> <span class="fu">t</span> <span class="op">=</span></span>
<span id="cb6-10"><a href="#cb6-10"></a>    <span class="cf">case</span> <span class="fu">t</span> <span class="cf">of</span></span>
<span id="cb6-11"><a href="#cb6-11"></a>        <span class="dt">TmVar</span> <span class="fu">x</span> <span class="fu">_</span> <span class="op">-&gt;</span></span>
<span id="cb6-12"><a href="#cb6-12"></a>            <span class="co">-- Context から型情報を引っ張ってくる</span></span>
<span id="cb6-13"><a href="#cb6-13"></a>            <span class="fu">getTypeFromContext</span> <span class="fu">ctx</span> <span class="fu">x</span></span>
<span id="cb6-14"><a href="#cb6-14"></a></span>
<span id="cb6-15"><a href="#cb6-15"></a>        <span class="dt">TmAbs</span> <span class="fu">x</span> <span class="fu">ty1</span> <span class="fu">t2</span> <span class="op">-&gt;</span></span>
<span id="cb6-16"><a href="#cb6-16"></a>            <span class="kw">let</span></span>
<span id="cb6-17"><a href="#cb6-17"></a>                <span class="co">-- Context に 変数と型の対応を追加する</span></span>
<span id="cb6-18"><a href="#cb6-18"></a>                <span class="fu">ctx1</span> <span class="op">=</span> <span class="fu">addbinding</span> <span class="fu">ctx</span> <span class="fu">x</span> (<span class="dt">VarBind</span> <span class="fu">ty1</span>)</span>
<span id="cb6-19"><a href="#cb6-19"></a>            <span class="kw">in</span></span>
<span id="cb6-20"><a href="#cb6-20"></a>            <span class="co">-- ラムダ抽象は中の項 t2 が型付け可能である必要がある</span></span>
<span id="cb6-21"><a href="#cb6-21"></a>            <span class="fu">typeof</span> <span class="fu">ctx1</span> <span class="fu">t2</span></span>
<span id="cb6-22"><a href="#cb6-22"></a>                <span class="op">|&gt;</span> <span class="dt">Maybe</span><span class="op">.</span><span class="fu">map</span> (\<span class="fu">ty2</span> <span class="op">-&gt;</span> <span class="dt">TyArr</span> <span class="fu">ty1</span> <span class="fu">ty2</span>)</span>
<span id="cb6-23"><a href="#cb6-23"></a></span>
<span id="cb6-24"><a href="#cb6-24"></a>        <span class="dt">TmApp</span> <span class="fu">t1</span> <span class="fu">t2</span> <span class="op">-&gt;</span></span>
<span id="cb6-25"><a href="#cb6-25"></a>            <span class="cf">case</span> ( <span class="fu">typeof</span> <span class="fu">ctx</span> <span class="fu">t1</span><span class="op">,</span> <span class="fu">typeof</span> <span class="fu">ctx</span> <span class="fu">t2</span> ) <span class="cf">of</span></span>
<span id="cb6-26"><a href="#cb6-26"></a>                ( <span class="dt">Just</span> (<span class="dt">TyArr</span> <span class="fu">ty11</span> <span class="fu">ty12</span>)<span class="op">,</span> <span class="dt">Just</span> <span class="fu">ty2</span> ) <span class="op">-&gt;</span></span>
<span id="cb6-27"><a href="#cb6-27"></a>                    <span class="co">-- 関数適用の場合は引数の型 ty11 と適用する項の型 ty2 が同じである必要がある</span></span>
<span id="cb6-28"><a href="#cb6-28"></a>                    <span class="cf">if</span> <span class="fu">ty11</span> <span class="op">==</span> <span class="fu">ty2</span> <span class="cf">then</span></span>
<span id="cb6-29"><a href="#cb6-29"></a>                        <span class="dt">Just</span> <span class="fu">ty12</span></span>
<span id="cb6-30"><a href="#cb6-30"></a>                    <span class="cf">else</span></span>
<span id="cb6-31"><a href="#cb6-31"></a>                        <span class="dt">Nothing</span></span>
<span id="cb6-32"><a href="#cb6-32"></a>                <span class="fu">_</span> <span class="op">-&gt;</span></span>
<span id="cb6-33"><a href="#cb6-33"></a>                    <span class="dt">Nothing</span></span>
<span id="cb6-34"><a href="#cb6-34"></a></span>
<span id="cb6-35"><a href="#cb6-35"></a>        <span class="dt">TmTrue</span> <span class="op">-&gt;</span></span>
<span id="cb6-36"><a href="#cb6-36"></a>            <span class="dt">Just</span> <span class="dt">TyBool</span></span>
<span id="cb6-37"><a href="#cb6-37"></a></span>
<span id="cb6-38"><a href="#cb6-38"></a>        <span class="dt">TmFalse</span> <span class="op">-&gt;</span></span>
<span id="cb6-39"><a href="#cb6-39"></a>            <span class="dt">Just</span> <span class="dt">TyBool</span></span>
<span id="cb6-40"><a href="#cb6-40"></a></span>
<span id="cb6-41"><a href="#cb6-41"></a>        <span class="dt">TmIf</span> <span class="fu">t1</span> <span class="fu">t2</span> <span class="fu">t3</span> <span class="op">-&gt;</span></span>
<span id="cb6-42"><a href="#cb6-42"></a>            <span class="cf">case</span> ( <span class="fu">typeof</span> <span class="fu">ctx</span> <span class="fu">t1</span><span class="op">,</span> <span class="fu">typeof</span> <span class="fu">ctx</span> <span class="fu">t2</span><span class="op">,</span> <span class="fu">typeof</span> <span class="fu">ctx</span> <span class="fu">t3</span> ) <span class="cf">of</span></span>
<span id="cb6-43"><a href="#cb6-43"></a>                ( <span class="dt">Just</span> <span class="dt">TyBool</span><span class="op">,</span> <span class="dt">Just</span> <span class="fu">ty2</span><span class="op">,</span> <span class="dt">Just</span> <span class="fu">ty3</span> ) <span class="op">-&gt;</span></span>
<span id="cb6-44"><a href="#cb6-44"></a>                    <span class="co">-- if-then-else の場合は t2 と t3 の型が同じである必要がある</span></span>
<span id="cb6-45"><a href="#cb6-45"></a>                    <span class="cf">if</span> <span class="fu">ty2</span> <span class="op">==</span> <span class="fu">ty3</span> <span class="cf">then</span></span>
<span id="cb6-46"><a href="#cb6-46"></a>                        <span class="dt">Just</span> <span class="fu">ty2</span></span>
<span id="cb6-47"><a href="#cb6-47"></a>                    <span class="cf">else</span></span>
<span id="cb6-48"><a href="#cb6-48"></a>                        <span class="dt">Nothing</span></span>
<span id="cb6-49"><a href="#cb6-49"></a>                <span class="fu">_</span> <span class="op">-&gt;</span></span>
<span id="cb6-50"><a href="#cb6-50"></a>                    <span class="dt">Nothing</span></span>
<span id="cb6-51"><a href="#cb6-51"></a></span>
<span id="cb6-52"><a href="#cb6-52"></a><span class="fu">getTypeFromContext</span> : <span class="dt">Context</span> <span class="op">-&gt;</span> <span class="dt">Int</span> <span class="op">-&gt;</span> <span class="dt">Maybe</span> <span class="dt">Ty</span></span>
<span id="cb6-53"><a href="#cb6-53"></a><span class="fu">getTypeFromContext</span> <span class="fu">ctx</span> <span class="fu">idx</span> <span class="op">=</span></span>
<span id="cb6-54"><a href="#cb6-54"></a>    <span class="cf">case</span> <span class="fu">getbinding</span> <span class="fu">ctx</span> <span class="fu">idx</span> <span class="cf">of</span></span>
<span id="cb6-55"><a href="#cb6-55"></a>        <span class="dt">Just</span> (<span class="dt">VarBind</span> <span class="fu">ty</span>) <span class="op">-&gt;</span></span>
<span id="cb6-56"><a href="#cb6-56"></a>            <span class="dt">Just</span> <span class="fu">ty</span></span>
<span id="cb6-57"><a href="#cb6-57"></a></span>
<span id="cb6-58"><a href="#cb6-58"></a>        <span class="fu">_</span> <span class="op">-&gt;</span></span>
<span id="cb6-59"><a href="#cb6-59"></a>            <span class="dt">Nothing</span></span>
<span id="cb6-60"><a href="#cb6-60"></a></span>
<span id="cb6-61"><a href="#cb6-61"></a><span class="fu">getbinding</span> : <span class="dt">Context</span> <span class="op">-&gt;</span> <span class="dt">Int</span> <span class="op">-&gt;</span> <span class="dt">Maybe</span> <span class="dt">Binding</span></span>
<span id="cb6-62"><a href="#cb6-62"></a><span class="fu">getbinding</span> <span class="fu">ctx</span> <span class="fu">n</span> <span class="op">=</span></span>
<span id="cb6-63"><a href="#cb6-63"></a>    <span class="cf">case</span> ( <span class="fu">ctx</span><span class="op">,</span> <span class="fu">n</span> ) <span class="cf">of</span></span>
<span id="cb6-64"><a href="#cb6-64"></a>        ( []<span class="op">,</span> <span class="fu">_</span> ) <span class="op">-&gt;</span></span>
<span id="cb6-65"><a href="#cb6-65"></a>            <span class="dt">Nothing</span></span>
<span id="cb6-66"><a href="#cb6-66"></a></span>
<span id="cb6-67"><a href="#cb6-67"></a>        ( ( <span class="fu">_</span><span class="op">,</span> <span class="fu">bind</span> ) <span class="op">::</span> <span class="fu">_</span><span class="op">,</span> <span class="dv">0</span> ) <span class="op">-&gt;</span></span>
<span id="cb6-68"><a href="#cb6-68"></a>            <span class="dt">Just</span> <span class="fu">bind</span></span>
<span id="cb6-69"><a href="#cb6-69"></a></span>
<span id="cb6-70"><a href="#cb6-70"></a>        ( <span class="fu">_</span> <span class="op">::</span> <span class="fu">next</span><span class="op">,</span> <span class="fu">_</span> ) <span class="op">-&gt;</span></span>
<span id="cb6-71"><a href="#cb6-71"></a>            <span class="fu">getbinding</span> <span class="fu">next</span> (<span class="fu">n</span> <span class="op">-</span> <span class="dv">1</span>)</span>
<span id="cb6-72"><a href="#cb6-72"></a></span>
<span id="cb6-73"><a href="#cb6-73"></a><span class="fu">addbinding</span> : <span class="dt">Context</span> <span class="op">-&gt;</span> <span class="dt">String</span> <span class="op">-&gt;</span> <span class="dt">Binding</span> <span class="op">-&gt;</span> <span class="dt">Context</span></span>
<span id="cb6-74"><a href="#cb6-74"></a><span class="fu">addbinding</span> <span class="fu">ctx</span> <span class="fu">x</span> <span class="fu">bind</span> <span class="op">=</span></span>
<span id="cb6-75"><a href="#cb6-75"></a>    ( <span class="fu">x</span><span class="op">,</span> <span class="fu">bind</span> ) <span class="op">::</span> <span class="fu">ctx</span></span></code></pre></div>
<p>REPL で試してみる:</p>
<div class="sourceCode" id="cb7"><pre class="sourceCode elm"><code class="sourceCode elm"><span id="cb7-1"><a href="#cb7-1"></a><span class="op">&gt;</span> <span class="kw">import</span> <span class="dt">TaPL</span><span class="op">.</span><span class="dt">Chap10</span> <span class="kw">as</span> <span class="dt">Chap10</span> <span class="kw">exposing</span> (<span class="dt">Term</span>(<span class="op">..</span>)<span class="op">,</span> <span class="dt">Ty</span>(<span class="op">..</span>)<span class="op">,</span> <span class="dt">Binding</span>(<span class="op">..</span>))</span>
<span id="cb7-2"><a href="#cb7-2"></a><span class="co">-- (\x : (Bool -&gt; Bool) . (\f : (Bool -&gt; Bool -&gt; Bool) . f x)) (\x : Bool . x)</span></span>
<span id="cb7-3"><a href="#cb7-3"></a><span class="op">&gt;</span> <span class="dt">Chap10</span><span class="op">.</span><span class="fu">typeof</span> [] (<span class="dt">TmApp</span> (<span class="dt">TmAbs</span> <span class="st">&quot;x&quot;</span> (<span class="dt">TyArr</span> <span class="dt">TyBool</span> <span class="dt">TyBool</span>) (<span class="dt">TmAbs</span> <span class="st">&quot;f&quot;</span> (<span class="dt">TyArr</span> (<span class="dt">TyArr</span> <span class="dt">TyBool</span> <span class="dt">TyBool</span>) <span class="dt">TyBool</span>) (<span class="dt">TmApp</span> (<span class="dt">TmVar</span> <span class="dv">0</span> <span class="dv">2</span>) (<span class="dt">TmVar</span> <span class="dv">1</span> <span class="dv">2</span>)))) (<span class="dt">TmAbs</span> <span class="st">&quot;x&quot;</span> <span class="dt">TyBool</span> (<span class="dt">TmVar</span> <span class="dv">0</span> <span class="dv">1</span>)))</span>
<span id="cb7-4"><a href="#cb7-4"></a><span class="dt">Just</span> (<span class="dt">TyArr</span> (<span class="dt">TyArr</span> (<span class="dt">TyArr</span> <span class="dt">TyBool</span> <span class="dt">TyBool</span>) <span class="dt">TyBool</span>) <span class="dt">TyBool</span>)</span>
<span id="cb7-5"><a href="#cb7-5"></a>    : <span class="dt">Maybe</span> <span class="dt">Ty</span></span>
<span id="cb7-6"><a href="#cb7-6"></a><span class="co">-- (\x . x x) (\x . x x) はうまく型付けできない</span></span>
<span id="cb7-7"><a href="#cb7-7"></a><span class="op">&gt;</span> <span class="dt">Chap10</span><span class="op">.</span><span class="fu">typeof</span> [] (<span class="dt">TmApp</span> (<span class="dt">TmAbs</span> <span class="st">&quot;x&quot;</span> (<span class="dt">TyArr</span> <span class="dt">TyBool</span> <span class="dt">TyBool</span>) (<span class="dt">TmApp</span> (<span class="dt">TmVar</span> <span class="dv">0</span> <span class="dv">1</span>) (<span class="dt">TmVar</span> <span class="dv">0</span> <span class="dv">1</span>))) (<span class="dt">TmAbs</span> <span class="st">&quot;x&quot;</span> (<span class="dt">TyArr</span> <span class="dt">TyBool</span> <span class="dt">TyBool</span>) (<span class="dt">TmApp</span> (<span class="dt">TmVar</span> <span class="dv">0</span> <span class="dv">1</span>) (<span class="dt">TmVar</span> <span class="dv">0</span> <span class="dv">1</span>))))</span>
<span id="cb7-8"><a href="#cb7-8"></a><span class="dt">Nothing</span> : <span class="dt">Maybe</span> <span class="dt">Ty</span></span></code></pre></div>
<h3 id="文字列に変換">文字列に変換</h3>
<p>基本的に4・7章の定義を利用すれば良いのだが，型注釈ができるようになったので型も変換できるようにする:</p>
<div class="sourceCode" id="cb8"><pre class="sourceCode elm"><code class="sourceCode elm"><span id="cb8-1"><a href="#cb8-1"></a><span class="fu">display</span> : <span class="dt">Term</span> <span class="op">-&gt;</span> <span class="dt">String</span></span>
<span id="cb8-2"><a href="#cb8-2"></a><span class="fu">display</span> <span class="fu">t</span> <span class="op">=</span></span>
<span id="cb8-3"><a href="#cb8-3"></a>    <span class="fu">printtm</span> [] <span class="fu">t</span></span>
<span id="cb8-4"><a href="#cb8-4"></a>        <span class="op">|&gt;</span> <span class="dt">Maybe</span><span class="op">.</span><span class="fu">map</span> (<span class="fu">dropIfStartsWith</span> <span class="st">&quot;(&quot;</span>) <span class="co">-- 最初と最後のカッコを消している</span></span>
<span id="cb8-5"><a href="#cb8-5"></a>        <span class="op">|&gt;</span> <span class="dt">Maybe</span><span class="op">.</span><span class="fu">map</span> (<span class="fu">dropIfEndsWith</span> <span class="st">&quot;)&quot;</span>)</span>
<span id="cb8-6"><a href="#cb8-6"></a>        <span class="op">|&gt;</span> <span class="dt">Maybe</span><span class="op">.</span><span class="fu">withDefault</span> <span class="st">&quot;&quot;</span></span>
<span id="cb8-7"><a href="#cb8-7"></a></span>
<span id="cb8-8"><a href="#cb8-8"></a><span class="fu">printtm</span> : <span class="dt">Context</span> <span class="op">-&gt;</span> <span class="dt">Term</span> <span class="op">-&gt;</span> <span class="dt">Maybe</span> <span class="dt">String</span></span>
<span id="cb8-9"><a href="#cb8-9"></a><span class="fu">printtm</span> <span class="fu">ctx</span> <span class="fu">t</span> <span class="op">=</span></span>
<span id="cb8-10"><a href="#cb8-10"></a>    <span class="cf">case</span> <span class="fu">t</span> <span class="cf">of</span></span>
<span id="cb8-11"><a href="#cb8-11"></a>        <span class="dt">TmAbs</span> <span class="fu">x</span> <span class="fu">ty</span> <span class="fu">t1</span> <span class="op">-&gt;</span></span>
<span id="cb8-12"><a href="#cb8-12"></a>            <span class="kw">let</span> <span class="co">-- 重複しない変数名を生成して Context に積む</span></span>
<span id="cb8-13"><a href="#cb8-13"></a>                ( <span class="fu">ctx1</span><span class="op">,</span> <span class="fu">x1</span> ) <span class="op">=</span> <span class="fu">pickfreshname</span> <span class="fu">ctx</span> <span class="fu">x</span></span>
<span id="cb8-14"><a href="#cb8-14"></a>            <span class="kw">in</span></span>
<span id="cb8-15"><a href="#cb8-15"></a>            <span class="dt">Maybe</span><span class="op">.</span><span class="fu">map</span></span>
<span id="cb8-16"><a href="#cb8-16"></a>                (\<span class="fu">s1</span> <span class="op">-&gt;</span> <span class="dt">String</span><span class="op">.</span><span class="fu">concat</span> [ <span class="st">&quot;(\\&quot;</span><span class="op">,</span> <span class="fu">x1</span><span class="op">,</span> <span class="st">&quot; : &quot;</span><span class="op">,</span> <span class="fu">printty</span> <span class="fu">ty</span><span class="op">,</span> <span class="st">&quot;. &quot;</span><span class="op">,</span> <span class="fu">s1</span><span class="op">,</span> <span class="st">&quot;)&quot;</span> ])</span>
<span id="cb8-17"><a href="#cb8-17"></a>                (<span class="fu">printtm</span> <span class="fu">ctx1</span> <span class="fu">t1</span>)</span>
<span id="cb8-18"><a href="#cb8-18"></a>        <span class="op">...</span> <span class="co">-- あとは同じ</span></span>
<span id="cb8-19"><a href="#cb8-19"></a></span>
<span id="cb8-20"><a href="#cb8-20"></a><span class="fu">printty</span> : <span class="dt">Ty</span> <span class="op">-&gt;</span> <span class="dt">String</span></span>
<span id="cb8-21"><a href="#cb8-21"></a><span class="fu">printty</span> <span class="fu">ty</span> <span class="op">=</span></span>
<span id="cb8-22"><a href="#cb8-22"></a>    <span class="cf">case</span> <span class="fu">ty</span> <span class="cf">of</span></span>
<span id="cb8-23"><a href="#cb8-23"></a>        <span class="dt">TyArr</span> <span class="fu">ty1</span> <span class="fu">ty2</span> <span class="op">-&gt;</span></span>
<span id="cb8-24"><a href="#cb8-24"></a>            <span class="dt">String</span><span class="op">.</span><span class="fu">concat</span> [ <span class="st">&quot;(&quot;</span><span class="op">,</span> <span class="fu">printty</span> <span class="fu">ty1</span><span class="op">,</span> <span class="st">&quot; -&gt; &quot;</span><span class="op">,</span> <span class="fu">printty</span> <span class="fu">ty2</span><span class="op">,</span> <span class="st">&quot;)&quot;</span> ]</span>
<span id="cb8-25"><a href="#cb8-25"></a></span>
<span id="cb8-26"><a href="#cb8-26"></a>        <span class="dt">TyBool</span> <span class="op">-&gt;</span></span>
<span id="cb8-27"><a href="#cb8-27"></a>            <span class="st">&quot;Bool&quot;</span></span>
<span id="cb8-28"><a href="#cb8-28"></a></span>
<span id="cb8-29"><a href="#cb8-29"></a><span class="co">-- Context から重複する変数名を探し ' を追加する</span></span>
<span id="cb8-30"><a href="#cb8-30"></a><span class="fu">pickfreshname</span> : <span class="dt">Context</span> <span class="op">-&gt;</span> <span class="dt">String</span> <span class="op">-&gt;</span> ( <span class="dt">Context</span><span class="op">,</span> <span class="dt">String</span> )</span>
<span id="cb8-31"><a href="#cb8-31"></a><span class="fu">pickfreshname</span> <span class="fu">ctx</span> <span class="fu">x</span> <span class="op">=</span> <span class="op">...</span></span></code></pre></div>
<p>REPL で試す:</p>
<div class="sourceCode" id="cb9"><pre class="sourceCode elm"><code class="sourceCode elm"><span id="cb9-1"><a href="#cb9-1"></a><span class="op">&gt;</span> <span class="dt">Chap10</span><span class="op">.</span><span class="fu">display</span> (<span class="dt">TmApp</span> (<span class="dt">TmAbs</span> <span class="st">&quot;x&quot;</span> (<span class="dt">TyArr</span> <span class="dt">TyBool</span> <span class="dt">TyBool</span>) (<span class="dt">TmAbs</span> <span class="st">&quot;f&quot;</span> (<span class="dt">TyArr</span> (<span class="dt">TyArr</span> <span class="dt">TyBool</span> <span class="dt">TyBool</span>) <span class="dt">TyBool</span>) (<span class="dt">TmApp</span> (<span class="dt">TmVar</span> <span class="dv">0</span> <span class="dv">2</span>) (<span class="dt">TmVar</span> <span class="dv">1</span> <span class="dv">2</span>)))) (<span class="dt">TmAbs</span> <span class="st">&quot;x&quot;</span> <span class="dt">TyBool</span> (<span class="dt">TmVar</span> <span class="dv">0</span> <span class="dv">1</span>)))</span>
<span id="cb9-2"><a href="#cb9-2"></a><span class="st">&quot;(\\x : (Bool -&gt; Bool). (\\f : ((Bool -&gt; Bool) -&gt; Bool). (f x))) (\\x : Bool. x)&quot;</span></span>
<span id="cb9-3"><a href="#cb9-3"></a>    : <span class="dt">String</span></span></code></pre></div>
<h3 id="パーサー">パーサー</h3>
<p>これも同様に4・7章の実装を合わせるだけ:</p>
<div class="sourceCode" id="cb10"><pre class="sourceCode elm"><code class="sourceCode elm"><span id="cb10-1"><a href="#cb10-1"></a><span class="kw">module</span> <span class="dt">TaPL</span><span class="op">.</span><span class="dt">Chap10</span><span class="op">.</span><span class="dt">Parser</span> <span class="kw">exposing</span> (<span class="fu">parse</span>)</span>
<span id="cb10-2"><a href="#cb10-2"></a></span>
<span id="cb10-3"><a href="#cb10-3"></a><span class="kw">import</span> <span class="dt">Parser</span> <span class="kw">exposing</span> ((<span class="op">|.</span>)<span class="op">,</span> (<span class="op">|=</span>)<span class="op">,</span> <span class="dt">Parser</span>)</span>
<span id="cb10-4"><a href="#cb10-4"></a><span class="kw">import</span> <span class="dt">TaPL</span><span class="op">.</span><span class="dt">Chap10</span> <span class="kw">exposing</span> (<span class="dt">Term</span>(<span class="op">..</span>)<span class="op">,</span> <span class="dt">Ty</span>(<span class="op">..</span>))</span>
<span id="cb10-5"><a href="#cb10-5"></a></span>
<span id="cb10-6"><a href="#cb10-6"></a><span class="kw">type</span> <span class="kw">alias</span> <span class="dt">Context</span> <span class="op">=</span></span>
<span id="cb10-7"><a href="#cb10-7"></a>    { <span class="fu">env</span> : <span class="dt">Dict</span> <span class="dt">String</span> <span class="dt">Int</span></span>
<span id="cb10-8"><a href="#cb10-8"></a>    <span class="op">,</span> <span class="fu">depth</span> : <span class="dt">Int</span></span>
<span id="cb10-9"><a href="#cb10-9"></a>    }</span>
<span id="cb10-10"><a href="#cb10-10"></a></span>
<span id="cb10-11"><a href="#cb10-11"></a><span class="fu">iniCtx</span> : <span class="dt">Context</span></span>
<span id="cb10-12"><a href="#cb10-12"></a><span class="fu">iniCtx</span> <span class="op">=</span></span>
<span id="cb10-13"><a href="#cb10-13"></a>    { <span class="fu">env</span> <span class="op">=</span> <span class="dt">Dict</span><span class="op">.</span><span class="fu">empty</span><span class="op">,</span> <span class="fu">depth</span> <span class="op">=</span> <span class="dv">0</span> }</span>
<span id="cb10-14"><a href="#cb10-14"></a></span>
<span id="cb10-15"><a href="#cb10-15"></a><span class="fu">parse</span> : <span class="dt">String</span> <span class="op">-&gt;</span> <span class="dt">Result</span> (<span class="dt">List</span> <span class="dt">Parser</span><span class="op">.</span><span class="dt">DeadEnd</span>) <span class="dt">Term</span></span>
<span id="cb10-16"><a href="#cb10-16"></a><span class="fu">parse</span> <span class="op">=</span></span>
<span id="cb10-17"><a href="#cb10-17"></a>    <span class="dt">Parser</span><span class="op">.</span><span class="fu">run</span> <span class="fu">parser</span></span>
<span id="cb10-18"><a href="#cb10-18"></a></span>
<span id="cb10-19"><a href="#cb10-19"></a><span class="fu">parser</span> : <span class="dt">Parser</span> <span class="dt">Term</span></span>
<span id="cb10-20"><a href="#cb10-20"></a><span class="fu">parser</span> <span class="op">=</span></span>
<span id="cb10-21"><a href="#cb10-21"></a>    <span class="fu">termParser</span> <span class="fu">iniCtx</span> <span class="op">|.</span> <span class="dt">Parser</span><span class="op">.</span><span class="fu">end</span></span>
<span id="cb10-22"><a href="#cb10-22"></a></span>
<span id="cb10-23"><a href="#cb10-23"></a><span class="fu">termParser</span> : <span class="dt">Context</span> <span class="op">-&gt;</span> <span class="dt">Parser</span> <span class="dt">Term</span></span>
<span id="cb10-24"><a href="#cb10-24"></a><span class="fu">termParser</span> <span class="fu">ctx</span> <span class="op">=</span></span>
<span id="cb10-25"><a href="#cb10-25"></a>    <span class="dt">Parser</span><span class="op">.</span><span class="fu">oneOf</span></span>
<span id="cb10-26"><a href="#cb10-26"></a>        [ <span class="fu">parParser</span> <span class="fu">ctx</span> <span class="co">-- 括弧のパーサー</span></span>
<span id="cb10-27"><a href="#cb10-27"></a>        <span class="op">,</span> <span class="fu">absParser</span> <span class="fu">ctx</span> <span class="co">-- ラムダ抽象のパーサー</span></span>
<span id="cb10-28"><a href="#cb10-28"></a>        <span class="op">,</span> <span class="fu">valParser</span>     <span class="co">-- ture/false のパーサー</span></span>
<span id="cb10-29"><a href="#cb10-29"></a>        <span class="op">,</span> <span class="fu">ifParser</span> <span class="fu">ctx</span>  <span class="co">-- if-then-else のパーサー</span></span>
<span id="cb10-30"><a href="#cb10-30"></a>        <span class="op">,</span> <span class="fu">varParser</span> <span class="fu">ctx</span> <span class="co">-- 変数のパーサー</span></span>
<span id="cb10-31"><a href="#cb10-31"></a>        ] <span class="co">-- 関数適用のパーサーだけ分けてるのは左再帰対策(その２参照)</span></span>
<span id="cb10-32"><a href="#cb10-32"></a>        <span class="op">|&gt;</span> <span class="dt">Parser</span><span class="op">.</span><span class="fu">andThen</span> (<span class="fu">appParser</span> <span class="fu">ctx</span>)</span></code></pre></div>
<p>言わずもがな，型注釈のパースをする必要があるので，<code>absParser</code> はその２のと若干異なる:</p>
<div class="sourceCode" id="cb11"><pre class="sourceCode elm"><code class="sourceCode elm"><span id="cb11-1"><a href="#cb11-1"></a><span class="fu">absParser</span> : <span class="dt">Context</span> <span class="op">-&gt;</span> <span class="dt">Parser</span> <span class="dt">Term</span></span>
<span id="cb11-2"><a href="#cb11-2"></a><span class="fu">absParser</span> <span class="fu">ctx</span> <span class="op">=</span></span>
<span id="cb11-3"><a href="#cb11-3"></a>    <span class="dt">Parser</span><span class="op">.</span><span class="fu">succeed</span> <span class="dt">Tuple</span><span class="op">.</span><span class="fu">pair</span></span>
<span id="cb11-4"><a href="#cb11-4"></a>        <span class="op">|.</span> <span class="dt">Parser</span><span class="op">.</span><span class="fu">symbol</span> <span class="st">&quot;\\&quot;</span></span>
<span id="cb11-5"><a href="#cb11-5"></a>        <span class="op">|.</span> <span class="dt">Parser</span><span class="op">.</span><span class="fu">spaces</span></span>
<span id="cb11-6"><a href="#cb11-6"></a>        <span class="op">|=</span> <span class="dt">Parser</span><span class="op">.</span><span class="fu">lazy</span> (\<span class="fu">_</span> <span class="op">-&gt;</span> <span class="fu">varStrParser</span>)</span>
<span id="cb11-7"><a href="#cb11-7"></a>        <span class="op">|.</span> <span class="dt">Parser</span><span class="op">.</span><span class="fu">spaces</span></span>
<span id="cb11-8"><a href="#cb11-8"></a>        <span class="op">|.</span> <span class="dt">Parser</span><span class="op">.</span><span class="fu">symbol</span> <span class="st">&quot;:&quot;</span>            <span class="co">-- ここから</span></span>
<span id="cb11-9"><a href="#cb11-9"></a>        <span class="op">|.</span> <span class="dt">Parser</span><span class="op">.</span><span class="fu">spaces</span></span>
<span id="cb11-10"><a href="#cb11-10"></a>        <span class="op">|=</span> <span class="dt">Parser</span><span class="op">.</span><span class="fu">lazy</span> (\<span class="fu">_</span> <span class="op">-&gt;</span> <span class="fu">tyParser</span>) <span class="co">-- ここまでが追加</span></span>
<span id="cb11-11"><a href="#cb11-11"></a>        <span class="op">|.</span> <span class="dt">Parser</span><span class="op">.</span><span class="fu">spaces</span></span>
<span id="cb11-12"><a href="#cb11-12"></a>        <span class="op">|.</span> <span class="dt">Parser</span><span class="op">.</span><span class="fu">symbol</span> <span class="st">&quot;.&quot;</span></span>
<span id="cb11-13"><a href="#cb11-13"></a>        <span class="op">|.</span> <span class="dt">Parser</span><span class="op">.</span><span class="fu">spaces</span></span>
<span id="cb11-14"><a href="#cb11-14"></a>        <span class="op">|&gt;</span> <span class="dt">Parser</span><span class="op">.</span><span class="fu">andThen</span> (<span class="fu">absParserN</span> <span class="fu">ctx</span>)</span>
<span id="cb11-15"><a href="#cb11-15"></a></span>
<span id="cb11-16"><a href="#cb11-16"></a><span class="co">-- 型のパーサー</span></span>
<span id="cb11-17"><a href="#cb11-17"></a><span class="fu">tyParser</span> : <span class="dt">Parser</span> <span class="dt">Ty</span></span>
<span id="cb11-18"><a href="#cb11-18"></a><span class="fu">tyParser</span> <span class="op">=</span></span>
<span id="cb11-19"><a href="#cb11-19"></a>    <span class="dt">Parser</span><span class="op">.</span><span class="fu">oneOf</span></span>
<span id="cb11-20"><a href="#cb11-20"></a>        [ <span class="fu">value</span> <span class="st">&quot;Bool&quot;</span> <span class="dt">TyBool</span></span>
<span id="cb11-21"><a href="#cb11-21"></a>        ]</span>
<span id="cb11-22"><a href="#cb11-22"></a>        <span class="op">|.</span> <span class="dt">Parser</span><span class="op">.</span><span class="fu">spaces</span></span>
<span id="cb11-23"><a href="#cb11-23"></a>        <span class="co">-- これも左再帰対策(その２参照)</span></span>
<span id="cb11-24"><a href="#cb11-24"></a>        <span class="op">|&gt;</span> <span class="dt">Parser</span><span class="op">.</span><span class="fu">andThen</span> <span class="fu">tyArrParser</span></span>
<span id="cb11-25"><a href="#cb11-25"></a></span>
<span id="cb11-26"><a href="#cb11-26"></a><span class="co">-- 関数型のパーサー</span></span>
<span id="cb11-27"><a href="#cb11-27"></a><span class="co">-- 関数型 T-&gt;T は右結合(T-&gt;T-&gt;T は T-&gt;(T-&gt;T) となる)</span></span>
<span id="cb11-28"><a href="#cb11-28"></a><span class="fu">tyArrParser</span> : <span class="dt">Ty</span> <span class="op">-&gt;</span> <span class="dt">Parser</span> <span class="dt">Ty</span></span>
<span id="cb11-29"><a href="#cb11-29"></a><span class="fu">tyArrParser</span> <span class="fu">ty</span> <span class="op">=</span></span>
<span id="cb11-30"><a href="#cb11-30"></a>    <span class="dt">Parser</span><span class="op">.</span><span class="fu">oneOf</span></span>
<span id="cb11-31"><a href="#cb11-31"></a>        [ <span class="dt">Parser</span><span class="op">.</span><span class="fu">succeed</span> (<span class="dt">TyArr</span> <span class="fu">ty</span>)</span>
<span id="cb11-32"><a href="#cb11-32"></a>            <span class="op">|.</span> <span class="dt">Parser</span><span class="op">.</span><span class="fu">keyword</span> <span class="st">&quot;-&gt;&quot;</span></span>
<span id="cb11-33"><a href="#cb11-33"></a>            <span class="op">|.</span> <span class="dt">Parser</span><span class="op">.</span><span class="fu">spaces</span></span>
<span id="cb11-34"><a href="#cb11-34"></a>            <span class="op">|=</span> <span class="dt">Parser</span><span class="op">.</span><span class="fu">lazy</span> (\<span class="fu">_</span> <span class="op">-&gt;</span> <span class="fu">tyParser</span>)</span>
<span id="cb11-35"><a href="#cb11-35"></a>        <span class="op">,</span> <span class="dt">Parser</span><span class="op">.</span><span class="fu">succeed</span> <span class="fu">ty</span></span>
<span id="cb11-36"><a href="#cb11-36"></a>        ]</span></code></pre></div>
<p>REPL で試してみる:</p>
<div class="sourceCode" id="cb12"><pre class="sourceCode elm"><code class="sourceCode elm"><span id="cb12-1"><a href="#cb12-1"></a><span class="op">&gt;</span>  <span class="st">&quot;(\\x : Bool . if x then x else (\\f : Bool -&gt; Bool -&gt; Bool . f x x) (\\x : Bool . \\y : Bool . y)) (if true then false else true)&quot;</span></span>
<span id="cb12-2"><a href="#cb12-2"></a><span class="op">|</span>   <span class="op">|&gt;</span> <span class="dt">Parser</span><span class="op">.</span><span class="fu">parse</span></span>
<span id="cb12-3"><a href="#cb12-3"></a><span class="op">|</span>   <span class="op">|&gt;</span> <span class="dt">Result</span><span class="op">.</span><span class="fu">toMaybe</span></span>
<span id="cb12-4"><a href="#cb12-4"></a><span class="op">|</span>   <span class="op">|&gt;</span> <span class="dt">Maybe</span><span class="op">.</span><span class="fu">andThen</span> (\<span class="fu">t</span> <span class="op">-&gt;</span> <span class="dt">Chap10</span><span class="op">.</span><span class="fu">typeof</span> [] <span class="fu">t</span> <span class="op">|&gt;</span> <span class="dt">Maybe</span><span class="op">.</span><span class="fu">map</span> (<span class="fu">always</span> <span class="fu">t</span>)) <span class="co">-- 型検査</span></span>
<span id="cb12-5"><a href="#cb12-5"></a><span class="op">|</span>   <span class="op">|&gt;</span> <span class="dt">Maybe</span><span class="op">.</span><span class="fu">andThen</span> (<span class="dt">Chap10</span><span class="op">.</span><span class="fu">eval</span> [])</span>
<span id="cb12-6"><a href="#cb12-6"></a><span class="op">|</span>   <span class="op">|&gt;</span> <span class="dt">Maybe</span><span class="op">.</span><span class="fu">map</span> <span class="dt">Chap10</span><span class="op">.</span><span class="fu">display</span></span>
<span id="cb12-7"><a href="#cb12-7"></a><span class="op">|</span>   </span>
<span id="cb12-8"><a href="#cb12-8"></a><span class="dt">Just</span> <span class="st">&quot;false&quot;</span> : <span class="dt">Maybe</span> <span class="dt">String</span></span></code></pre></div>
<p>完璧だ．</p>
<h2 id="おまけ-spa">おまけ: SPA</h2>
<p>前回整理したので基本的に足していくだけだ． ただし，型検査を <code>Calculus</code> に加える必要がある:</p>
<div class="sourceCode" id="cb13"><pre class="sourceCode elm"><code class="sourceCode elm"><span id="cb13-1"><a href="#cb13-1"></a><span class="kw">module</span> <span class="dt">TaPL</span><span class="op">.</span><span class="dt">Calculus</span> <span class="kw">exposing</span> (<span class="op">..</span>)</span>
<span id="cb13-2"><a href="#cb13-2"></a></span>
<span id="cb13-3"><a href="#cb13-3"></a><span class="kw">type</span> <span class="kw">alias</span> <span class="dt">Calculus</span> <span class="fu">ctx</span> <span class="fu">t</span> <span class="fu">ty</span> <span class="op">=</span></span>
<span id="cb13-4"><a href="#cb13-4"></a>    { <span class="fu">parse</span> : <span class="dt">String</span> <span class="op">-&gt;</span> <span class="dt">Result</span> (<span class="dt">List</span> <span class="dt">Parser</span><span class="op">.</span><span class="dt">DeadEnd</span>) <span class="fu">t</span></span>
<span id="cb13-5"><a href="#cb13-5"></a>    <span class="op">,</span> <span class="fu">typeof</span> : <span class="dt">Maybe</span> (<span class="fu">ctx</span> <span class="op">-&gt;</span> <span class="fu">t</span> <span class="op">-&gt;</span> <span class="dt">Maybe</span> <span class="fu">ty</span>) <span class="co">-- 追加</span></span>
<span id="cb13-6"><a href="#cb13-6"></a>    <span class="op">,</span> <span class="fu">eval1</span> : <span class="fu">ctx</span> <span class="op">-&gt;</span> <span class="fu">t</span> <span class="op">-&gt;</span> <span class="dt">Maybe</span> <span class="fu">t</span></span>
<span id="cb13-7"><a href="#cb13-7"></a>    <span class="op">,</span> <span class="fu">display</span> : <span class="fu">t</span> <span class="op">-&gt;</span> <span class="dt">String</span></span>
<span id="cb13-8"><a href="#cb13-8"></a>    <span class="op">,</span> <span class="fu">init</span> : <span class="fu">ctx</span></span>
<span id="cb13-9"><a href="#cb13-9"></a>    <span class="op">,</span> <span class="fu">logs</span> : <span class="dt">List</span> <span class="fu">t</span></span>
<span id="cb13-10"><a href="#cb13-10"></a>    }</span>
<span id="cb13-11"><a href="#cb13-11"></a></span>
<span id="cb13-12"><a href="#cb13-12"></a><span class="fu">eval1</span> : <span class="dt">Calculus</span> <span class="fu">ctx</span> <span class="fu">t</span> <span class="fu">ty</span> <span class="op">-&gt;</span> <span class="dt">Maybe</span> (<span class="dt">Calculus</span> <span class="fu">ctx</span> <span class="fu">t</span> <span class="fu">ty</span>)</span>
<span id="cb13-13"><a href="#cb13-13"></a><span class="fu">typecheck</span> : <span class="dt">Calculus</span> <span class="fu">ctx</span> <span class="fu">t</span> <span class="fu">ty</span> <span class="op">-&gt;</span> <span class="dt">Bool</span></span>
<span id="cb13-14"><a href="#cb13-14"></a><span class="fu">parse</span> : <span class="dt">String</span> <span class="op">-&gt;</span> <span class="dt">Calculus</span> <span class="fu">ctx</span> <span class="fu">t</span> <span class="fu">ty</span> <span class="op">-&gt;</span> <span class="dt">Result</span> (<span class="dt">List</span> <span class="dt">Parser</span><span class="op">.</span><span class="dt">DeadEnd</span>) (<span class="dt">Calculus</span> <span class="fu">ctx</span> <span class="fu">t</span> <span class="fu">ty</span>)</span>
<span id="cb13-15"><a href="#cb13-15"></a><span class="fu">display</span> : <span class="dt">Calculus</span> <span class="fu">ctx</span> <span class="fu">t</span> <span class="fu">ty</span> <span class="op">-&gt;</span> <span class="dt">List</span> <span class="dt">String</span></span></code></pre></div>
<p>あとは <code>chap10</code> の定義も追加するだけ:</p>
<div class="sourceCode" id="cb14"><pre class="sourceCode elm"><code class="sourceCode elm"><span id="cb14-1"><a href="#cb14-1"></a><span class="kw">module</span> <span class="dt">TaPL</span> <span class="kw">exposing</span> (<span class="op">..</span>)</span>
<span id="cb14-2"><a href="#cb14-2"></a></span>
<span id="cb14-3"><a href="#cb14-3"></a><span class="kw">type</span> <span class="dt">Chapter</span></span>
<span id="cb14-4"><a href="#cb14-4"></a>    <span class="op">=</span> <span class="dt">Chap0</span></span>
<span id="cb14-5"><a href="#cb14-5"></a>    <span class="op">|</span> <span class="dt">Chap4</span> (<span class="dt">Calculus</span> () <span class="dt">Chap4</span><span class="op">.</span><span class="dt">Term</span> <span class="dt">Never</span>)</span>
<span id="cb14-6"><a href="#cb14-6"></a>    <span class="op">|</span> <span class="dt">Chap7</span> (<span class="dt">Calculus</span> <span class="dt">Chap7</span><span class="op">.</span><span class="dt">Context</span> <span class="dt">Chap7</span><span class="op">.</span><span class="dt">Term</span> <span class="dt">Never</span>)</span>
<span id="cb14-7"><a href="#cb14-7"></a>    <span class="op">|</span> <span class="dt">Chap10</span> (<span class="dt">Calculus</span> <span class="dt">Chap10</span><span class="op">.</span><span class="dt">Context</span> <span class="dt">Chap10</span><span class="op">.</span><span class="dt">Term</span> <span class="dt">Chap10</span><span class="op">.</span><span class="dt">Ty</span>)</span>
<span id="cb14-8"><a href="#cb14-8"></a></span>
<span id="cb14-9"><a href="#cb14-9"></a><span class="fu">init</span> : <span class="dt">String</span> <span class="op">-&gt;</span> <span class="dt">Chapter</span></span>
<span id="cb14-10"><a href="#cb14-10"></a><span class="fu">init</span> <span class="fu">s</span> <span class="op">=</span></span>
<span id="cb14-11"><a href="#cb14-11"></a>    <span class="cf">case</span> <span class="fu">s</span> <span class="cf">of</span></span>
<span id="cb14-12"><a href="#cb14-12"></a>        <span class="st">&quot;chap4&quot;</span> <span class="op">-&gt;</span> <span class="op">...</span></span>
<span id="cb14-13"><a href="#cb14-13"></a></span>
<span id="cb14-14"><a href="#cb14-14"></a>        <span class="st">&quot;chap7&quot;</span> <span class="op">-&gt;</span> <span class="op">...</span></span>
<span id="cb14-15"><a href="#cb14-15"></a></span>
<span id="cb14-16"><a href="#cb14-16"></a>        <span class="co">-- 追加</span></span>
<span id="cb14-17"><a href="#cb14-17"></a>        <span class="st">&quot;chap10&quot;</span> <span class="op">-&gt;</span></span>
<span id="cb14-18"><a href="#cb14-18"></a>            <span class="dt">Chap10</span></span>
<span id="cb14-19"><a href="#cb14-19"></a>                { <span class="fu">eval1</span> <span class="op">=</span> <span class="dt">Chap10</span><span class="op">.</span><span class="fu">eval1</span></span>
<span id="cb14-20"><a href="#cb14-20"></a>                <span class="op">,</span> <span class="fu">display</span> <span class="op">=</span> <span class="dt">Chap10</span><span class="op">.</span><span class="fu">display</span></span>
<span id="cb14-21"><a href="#cb14-21"></a>                <span class="op">,</span> <span class="fu">parse</span> <span class="op">=</span> <span class="dt">Chap10</span><span class="op">.</span><span class="fu">parse</span></span>
<span id="cb14-22"><a href="#cb14-22"></a>                <span class="op">,</span> <span class="fu">init</span> <span class="op">=</span> []</span>
<span id="cb14-23"><a href="#cb14-23"></a>                <span class="op">,</span> <span class="fu">logs</span> <span class="op">=</span> []</span>
<span id="cb14-24"><a href="#cb14-24"></a>                <span class="op">,</span> <span class="fu">syntax</span> <span class="op">=</span> <span class="dt">Chap10</span><span class="op">.</span><span class="fu">syntax</span></span>
<span id="cb14-25"><a href="#cb14-25"></a>                <span class="op">,</span> <span class="fu">typeof</span> <span class="op">=</span> <span class="dt">Just</span> <span class="dt">Chap10</span><span class="op">.</span><span class="fu">typeof</span></span>
<span id="cb14-26"><a href="#cb14-26"></a>                }</span>
<span id="cb14-27"><a href="#cb14-27"></a></span>
<span id="cb14-28"><a href="#cb14-28"></a>        <span class="fu">_</span> <span class="op">-&gt;</span></span>
<span id="cb14-29"><a href="#cb14-29"></a>            <span class="dt">Chap0</span></span>
<span id="cb14-30"><a href="#cb14-30"></a></span>
<span id="cb14-31"><a href="#cb14-31"></a><span class="fu">parse</span> : <span class="dt">Chapter</span> <span class="op">-&gt;</span> <span class="dt">String</span> <span class="op">-&gt;</span> <span class="dt">Result</span> (<span class="dt">List</span> <span class="dt">Parser</span><span class="op">.</span><span class="dt">DeadEnd</span>) <span class="dt">Chapter</span></span>
<span id="cb14-32"><a href="#cb14-32"></a><span class="fu">eval1</span> : <span class="dt">Chapter</span> <span class="op">-&gt;</span> <span class="dt">Maybe</span> <span class="dt">Chapter</span></span>
<span id="cb14-33"><a href="#cb14-33"></a><span class="fu">typecheck</span> : <span class="dt">Chapter</span> <span class="op">-&gt;</span> <span class="dt">Bool</span></span>
<span id="cb14-34"><a href="#cb14-34"></a><span class="fu">display</span> : <span class="dt">Chapter</span> <span class="op">-&gt;</span> <span class="dt">List</span> <span class="dt">String</span></span></code></pre></div>
<p>あとはこれらを <code>Main</code> でいい感じに呼び出すだけ．</p>
<h2 id="おしまい">おしまい</h2>
<p>次回はいつになることやら．</p>
  </div>

  <footer class="post-footer">
    <a href="https://twitter.com/share?ref_src=twsrc%5Etfw" class="twitter-share-button" data-show-count="false">Tweet</a>
    <script async src="https://platform.twitter.com/widgets.js" charset="utf-8"></script>
  </footer>
</div>
</article>

          </div>
        </div>

        <footer class="site-footer">

  <div class="wrapper">

    <span class="footer-heading">ひげメモ</span>

  </div>

  <div class="page-content card" style="display: flex; justify-content: center; padding: 5px 0px">
    <a href="https://haskell.jp/blog/posts/links.html#matsubara0507.github.io">
      <img width="234" src="https://haskell.jp/img/supported-by-haskell-jp.svg" alt="Supported By Haskell-jp.">
    </a>
  </div>

</footer>


      </div>
  </body>

</html>
