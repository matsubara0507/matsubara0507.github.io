<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE html>
<html lang="ja">

  <head>
  <meta charset="utf-8">
  <link rel="icon" href="../assets/icon.jpg">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
    
      <meta property="og:title" content="自己紹介ページを生成する whoami CLI を作った (Haskell)" />
    
  

  <meta property="og:site_name" content="ひげメモ" />

  

  
    <script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-86386380-1', 'auto');
  ga('send', 'pageview');
</script>

  

  <title>
    
      
        自己紹介ページを生成する whoami CLI を作った (Haskell)
      
    
  </title>

  <link rel="stylesheet" href="../css/main.css">
  <link rel="stylesheet" href="../css/highlight.css">
  <link rel="stylesheet" type="text/css" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.4.0/css/font-awesome.min.css" />
</head>


  <body>
      <div class="outer">

        <header class="site-header">

  <div class="wrapper">

    <a class="site-title" href="https://matsubara0507.github.io/">ひげメモ</a>

  </div>

  <div class="header-badge">
    <a href="https://matsubara0507.github.io/">
        <img src="../assets/icon.jpg" />
    </a>
  </div>

</header>


        <div class="page-content">
          <div class="wrapper">
            <article class="post card" itemscope itemtype="http://schema.org/BlogPosting">
 <div class="card-content">
  <header class="post-header">
    <h1 class="post-title" itemprop="name headline">自己紹介ページを生成する whoami CLI を作った (Haskell)</h1>
    <p class="post-meta">
      <time datetime="2018-02-19" itemprop="datePublished">
        Feb 19, 2018
      </time>
      
      
      <div class="tags">
          <i class="fa fa-tags"></i> <a href="../tags/Haskell.html">Haskell</a> <a href="../tags/application.html">application</a> <a href="../tags/extensible-package.html">extensible-package</a>
      </div>
      
    </p>
  </header>

  <div class="post-content" itemprop="articleBody">
    <p><a href="https://github.com/matsubara0507/whoami">whoami</a> という CLI を作りました． こんな感じの Yaml ファイルから</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode yaml"><code class="sourceCode yaml"><a class="sourceLine" id="cb1-1" data-line-number="1"><span class="fu">name:</span><span class="at"> MATSUBARA Nobutada</span></a>
<a class="sourceLine" id="cb1-2" data-line-number="2"><span class="fu">account:</span></a>
<a class="sourceLine" id="cb1-3" data-line-number="3">  <span class="fu">github:</span><span class="at"> matsubara0507</span></a>
<a class="sourceLine" id="cb1-4" data-line-number="4">  <span class="fu">qiita:</span><span class="at"> matsubara0507</span></a>
<a class="sourceLine" id="cb1-5" data-line-number="5"><span class="fu">site:</span></a>
<a class="sourceLine" id="cb1-6" data-line-number="6">  <span class="kw">-</span> <span class="fu">name:</span><span class="at"> ひげメモ</span></a>
<a class="sourceLine" id="cb1-7" data-line-number="7">    <span class="fu">url:</span><span class="at"> http://matsubara0507.github.io</span></a>
<a class="sourceLine" id="cb1-8" data-line-number="8">    <span class="fu">description:</span><span class="at"> メモ書きブログ</span></a>
<a class="sourceLine" id="cb1-9" data-line-number="9"><span class="fu">post:</span></a>
<a class="sourceLine" id="cb1-10" data-line-number="10">  <span class="fu">latest:</span><span class="at"> 10</span></a>
<a class="sourceLine" id="cb1-11" data-line-number="11">  <span class="fu">posts:</span></a>
<a class="sourceLine" id="cb1-12" data-line-number="12">    <span class="kw">-</span> <span class="fu">url:</span><span class="at"> http://haskell.jp/blog/posts/2017/advent-calendar-2017.html</span></a>
<a class="sourceLine" id="cb1-13" data-line-number="13">      <span class="fu">date:</span><span class="at"> 2017-12-31</span></a>
<a class="sourceLine" id="cb1-14" data-line-number="14">    <span class="kw">-</span> <span class="fu">url:</span><span class="at"> http://iggg.github.io/2017/06/01/make-tweet-slack-bot</span></a>
<a class="sourceLine" id="cb1-15" data-line-number="15"><span class="fu">library:</span></a>
<a class="sourceLine" id="cb1-16" data-line-number="16">  <span class="kw">-</span> <span class="fu">name:</span><span class="at"> chatwork</span></a>
<a class="sourceLine" id="cb1-17" data-line-number="17">    <span class="fu">url:</span><span class="at"> http://hackage.haskell.org/package/chatwork</span></a>
<a class="sourceLine" id="cb1-18" data-line-number="18">    <span class="fu">description:</span><span class="at"> The ChatWork API in Haskell</span></a>
<a class="sourceLine" id="cb1-19" data-line-number="19">    <span class="fu">language:</span><span class="at"> haskell</span></a>
<a class="sourceLine" id="cb1-20" data-line-number="20">  <span class="kw">-</span> <span class="fu">name:</span><span class="at"> thank_you_stars</span></a>
<a class="sourceLine" id="cb1-21" data-line-number="21">    <span class="fu">url:</span><span class="at"> http://hex.pm/packages/thank_you_stars</span></a>
<a class="sourceLine" id="cb1-22" data-line-number="22">    <span class="fu">language:</span><span class="at"> elixir</span></a>
<a class="sourceLine" id="cb1-23" data-line-number="23"><span class="fu">qiita:</span></a>
<a class="sourceLine" id="cb1-24" data-line-number="24">  <span class="fu">posts:</span><span class="at"> true</span></a>
<a class="sourceLine" id="cb1-25" data-line-number="25"><span class="fu">app:</span></a>
<a class="sourceLine" id="cb1-26" data-line-number="26">  <span class="kw">-</span> <span class="fu">name:</span><span class="at"> AnaQRam</span></a>
<a class="sourceLine" id="cb1-27" data-line-number="27">    <span class="fu">url:</span><span class="at"> http://github.com/matsubara0507/AnaQRam</span></a>
<a class="sourceLine" id="cb1-28" data-line-number="28">    <span class="fu">description:</span><span class="at"> QRコードを利用したアナグラム(並び替えパズル)</span></a></code></pre></div>
<p>こんな感じの Markdown を生成する．</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode markdown"><code class="sourceCode markdown"><a class="sourceLine" id="cb2-1" data-line-number="1"><span class="fu"># MATSUBARA Nobutada</span></a>
<a class="sourceLine" id="cb2-2" data-line-number="2">- <span class="ot">[GitHub](https://github.com/matsubara0507)</span></a>
<a class="sourceLine" id="cb2-3" data-line-number="3"><span class="fl">- </span><span class="ot">[Qiita](https://qiita.com/matsubara0507)</span></a>
<a class="sourceLine" id="cb2-4" data-line-number="4"></a>
<a class="sourceLine" id="cb2-5" data-line-number="5"><span class="fu">## My Sites</span></a>
<a class="sourceLine" id="cb2-6" data-line-number="6">- <span class="ot">[ひげメモ](http://matsubara0507.github.io)</span></a>
<a class="sourceLine" id="cb2-7" data-line-number="7"><span class="fl">    - メモ書きブログ</span></a>
<a class="sourceLine" id="cb2-8" data-line-number="8"></a>
<a class="sourceLine" id="cb2-9" data-line-number="9"><span class="fu">## My Posts</span></a>
<a class="sourceLine" id="cb2-10" data-line-number="10">- <span class="ot">[Haskell Advent Calendar 2017 まとめ - Haskell-jp](http://haskell.jp/blog/posts/2017/advent-calendar-2017.html)</span></a>
<a class="sourceLine" id="cb2-11" data-line-number="11"><span class="fl">    - posted on 2017-12-31</span></a>
<a class="sourceLine" id="cb2-12" data-line-number="12"><span class="fl">- </span><span class="ot">[LINE の Echo Bot を Google Cloud Functions に作る](https://qiita.com/matsubara0507/items/04ab3c2197aa5f68e499)</span></a>
<a class="sourceLine" id="cb2-13" data-line-number="13"><span class="fl">    - posted on 2017-11-21</span></a>
<a class="sourceLine" id="cb2-14" data-line-number="14"><span class="fl">- </span><span class="ot">[GitHub にチャット機能のようなものが追加された (team discussions)](https://qiita.com/matsubara0507/items/47d2e2545553e415f969)</span></a>
<a class="sourceLine" id="cb2-15" data-line-number="15"><span class="fl">    - posted on 2017-11-21</span></a>
<a class="sourceLine" id="cb2-16" data-line-number="16"><span class="fl">- </span><span class="ot">[GitHub Project に自動でカードのカラム遷移をする機能が追加された](https://qiita.com/matsubara0507/items/f384991b4854aa28745a)</span></a>
<a class="sourceLine" id="cb2-17" data-line-number="17"><span class="fl">    - posted on 2017-10-31</span></a>
<a class="sourceLine" id="cb2-18" data-line-number="18"><span class="fl">- </span><span class="ot">[Slack から特定のアカウントでツイートする Bot を作った｜群馬大学電子計算機研究会 IGGG](http://iggg.github.io/2017/06/01/make-tweet-slack-bot)</span></a>
<a class="sourceLine" id="cb2-19" data-line-number="19"><span class="fl">    - posted on 2017-06-01</span></a>
<a class="sourceLine" id="cb2-20" data-line-number="20"></a>
<a class="sourceLine" id="cb2-21" data-line-number="21"><span class="fu">## Applications</span></a>
<a class="sourceLine" id="cb2-22" data-line-number="22">- <span class="ot">[AnaQRam](http://github.com/matsubara0507/AnaQRam)</span></a>
<a class="sourceLine" id="cb2-23" data-line-number="23"><span class="fl">    - QRコードを利用したアナグラム(並び替えパズル)</span></a>
<a class="sourceLine" id="cb2-24" data-line-number="24"></a>
<a class="sourceLine" id="cb2-25" data-line-number="25"><span class="fu">## Libraries</span></a>
<a class="sourceLine" id="cb2-26" data-line-number="26">- <span class="ot">[chatwork](http://hackage.haskell.org/package/chatwork)</span></a>
<a class="sourceLine" id="cb2-27" data-line-number="27"><span class="fl">    - The ChatWork API in Haskell</span></a>
<a class="sourceLine" id="cb2-28" data-line-number="28"><span class="fl">- </span><span class="ot">[thank_you_stars](http://hex.pm/packages/thank_you_stars)</span></a>
<a class="sourceLine" id="cb2-29" data-line-number="29"><span class="fl">    - A tool for starring GitHub repositories.</span></a></code></pre></div>
<p>Yaml ファイルでは足りない情報をスクレイピングや各種 Web サービスの API で拾ってくる． なんか自分のアクティビティを紹介するページを SNS にリンクしてる人が多いと思うんだけど，そのページをできるだけ楽して生成したいなぁというのがモチベーション．</p>
<h2 id="section"></h2>
<p>ホントはバイト先で作ってる Haskell 製の社内用 CLI ツールを公開したくて，内容を公開できるようにしたツールです． こんな感じのデータ処理をするツールを，バイト先では Haskell で作ってた．</p>
<h2 id="extensible">extensible</h2>
<p>このツールの(まぁまぁ)面白いところは，<a href="https://hackage.haskell.org/package/extensible">extensible</a> というパッケージの機能をふんだんに使っている． 拡張可能レコード，バリアント，作用を使い，ついでに <a href="https://hackage.haskell.org/package/extensible/docs/Data-Extensible-GetOpt.html">GetOpt</a> も使ってみた． 軽く補足しておく(<strong>但し，作者ではないので間違っている部分はあるかも</strong>)．</p>
<h3 id="拡張可能レコード">拡張可能レコード</h3>
<p>Haskell のレコード構文</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb3-1" data-line-number="1"><span class="kw">data</span> <span class="dt">Hoge</span> <span class="fu">=</span> {<span class="ot"> hoge1 ::</span> <span class="dt">Int</span>,<span class="ot"> hoge2 ::</span> <span class="dt">Text</span> }</a></code></pre></div>
<p>を，型レベル辞書を用いて次のように書ける．</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb4-1" data-line-number="1"><span class="kw">type</span> <span class="dt">Hoge</span> <span class="fu">=</span> <span class="dt">Record</span> <span class="ch">'[ &quot;hoge1&quot; &gt;: Int, &quot;hoge2&quot; &gt;: Text ]</span></a></code></pre></div>
<p><code>OverloadedLabels</code> 言語拡張と組み合わせて，名前衝突の無いフィールド名を扱えたり，<code>lens</code> を用いた OOP のような参照(e.g. <code>hoge ^. #hoge1</code>)が出来る． また，<a href="../posts/2017-11-28-fun-of-extensible-1.html">レコードの拡縮もできる</a>．</p>
<h3 id="拡張可能バリアント">拡張可能バリアント</h3>
<p>次のような直和型</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb5-1" data-line-number="1"><span class="kw">data</span> <span class="dt">Hoge</span> <span class="fu">=</span> <span class="dt">Hoge1</span> <span class="dt">Int</span> <span class="fu">|</span> <span class="dt">Hoge2</span> <span class="dt">Text</span></a></code></pre></div>
<p>を，型レベル辞書を用いて，バリアント型のように書ける．</p>
<div class="sourceCode" id="cb6"><pre class="sourceCode haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb6-1" data-line-number="1"><span class="kw">type</span> <span class="dt">Hoge</span> <span class="fu">=</span> <span class="dt">Variant</span> <span class="ch">'[ &quot;hoge1&quot; &gt;: Int, &quot;hoge2&quot; &gt;: Text ]</span></a></code></pre></div>
<p>(正直あんまり利点が分かってないけど)拡縮はもちろん，<a href="../posts/2018-01-31-fun-of-extensible-2.html">バリアントの操作関数をファイル分割して実装</a>もできる．</p>
<h3 id="拡張可能作用">拡張可能作用</h3>
<p>型レベル辞書によってモナドスタックを表現する． 今回は次のようなモナドを定義した．</p>
<div class="sourceCode" id="cb7"><pre class="sourceCode haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb7-1" data-line-number="1"><span class="kw">type</span> <span class="dt">ServiceM</span> <span class="fu">=</span> <span class="dt">Eff</span></a>
<a class="sourceLine" id="cb7-2" data-line-number="2">  <span class="ch">'[ ReaderDef Config</span></a>
<a class="sourceLine" id="cb7-3" data-line-number="3">   , <span class="dt">EitherDef</span> <span class="dt">ServiceException</span></a>
<a class="sourceLine" id="cb7-4" data-line-number="4">   , <span class="dt">LoggerDef</span></a>
<a class="sourceLine" id="cb7-5" data-line-number="5">   , <span class="st">&quot;IO&quot;</span> <span class="fu">&gt;:</span> <span class="dt">IO</span></a>
<a class="sourceLine" id="cb7-6" data-line-number="6">   ]</a></code></pre></div>
<p>基本的に<a href="../posts/2017-12-09-extensible-effects-step-by-step.html">普通のモナドトランスフォーマーのように扱える</a>． じゃぁ素直にモナドトランスフォーマー使えよって感じかもしれないけど気にしないで．</p>
<h3 id="getopt-ラッパー"><code>GetOpt</code> ラッパー</h3>
<p>GHCには標準で <code>--output hoge</code> みたいな CLI のオプション引数をパースしてくれるモジュール <a href="https://hackage.haskell.org/package/base-4.10.1.0/docs/System-Console-GetOpt.html"><code>GetOpt</code></a> がある(ぼくは初めて使った)． extensible では，パース結果を拡張可能レコードにマッピングするための補助関数が<a href="https://hackage.haskell.org/package/extensible-0.4.7.1/docs/Data-Extensible-GetOpt.html">提供されている</a>．</p>
<p>キモになるのは <code>withGetOpt</code> 関数である．</p>
<div class="sourceCode" id="cb8"><pre class="sourceCode haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb8-1" data-line-number="1">withGetOpt</a>
<a class="sourceLine" id="cb8-2" data-line-number="2"><span class="ot">  ::</span> <span class="dt">MonadIO</span> m</a>
<a class="sourceLine" id="cb8-3" data-line-number="3">  <span class="ot">=&gt;</span> <span class="dt">String</span></a>
<a class="sourceLine" id="cb8-4" data-line-number="4">  <span class="ot">-&gt;</span> <span class="dt">RecordOf</span> (<span class="dt">OptionDescr</span> h) xs</a>
<a class="sourceLine" id="cb8-5" data-line-number="5">  <span class="ot">-&gt;</span> (<span class="dt">RecordOf</span> h xs <span class="ot">-&gt;</span> [<span class="dt">String</span>] <span class="ot">-&gt;</span> m a)</a>
<a class="sourceLine" id="cb8-6" data-line-number="6">  <span class="ot">-&gt;</span> m a</a></code></pre></div>
<p>一引数目の文字列はパース失敗したとき(要するにオプションが間違ってるとき)に表示する「使い方」に使われる． 例えば，whoami だと</p>
<pre><code>whoami [options] [input-file]
  -o FILE               --output=FILE                Write output to FILE instead of stdout.
  -t FORMAT, -w FORMAT  --to=FORMAT, --write=FORMAT  Specify output format. default is `markdown`.</code></pre>
<p>の <code>[options] [input-file]</code> が一引数目だ． 二引数目はオプションのパーサー(？)の定義を拡張可能レコードで与えており，三引数目がパース結果の拡張可能レコードと残りの(空白区切りの)文字列を受け取ってどうするかの振る舞いを与える．</p>
<p>まぁ詳しくは<a href="https://www.schoolofhaskell.com/user/fumieval/extensible/getopt-and-extensible-records">作者さんの記事</a>で紹介されている(英語だけど，あと一引数目の文字列はこの記事以降に追加された機能らしく，サンプルコードにはない)．</p>
<h3 id="extensible-instances">extensible-instances</h3>
<p>拡張可能レコードは全て <code>Record '[...]</code> の型エイリアスで定義する． つまり，拡張可能レコードの何らかの型クラスのインスタンスは <code>Record '[...]</code> に適用しておけば全部で使える(逆に影響力がでかいともいえる)．</p>
<p>いくつかの自作アプリーケーションでインスタンスを作っていて，ダブってたのでひとつのリポジトリにまとめた．</p>
<ul>
<li><a href="https://github.com/matsubara0507/extensible-instances">matsubara0507/extensible-instances - GitHub</a></li>
</ul>
<p>(なんか作者本人じゃないから気が引けて) Hackage にはあげてないがパッケージの体はしてるので，<a href="https://docs.haskellstack.org/en/stable/yaml_configuration/#git-and-mercurial-repos"><code>stack.yaml</code> の <code>extra-deps</code> に記述</a>することで使えるはず．</p>
<h2 id="section-1"></h2>
<p>注意点として <a href="https://github.com/fumieval/extensible">fumieval/extensible</a> の<a href="https://github.com/fumieval/extensible/blob/master/examples/aeson.hs">例にある <code>FromJSON</code> のインスタンス</a>とは微妙に実装が違う． 作者さんのは <code>Maybe a</code> にしてもキーが存在しないといけないのだが，<code>aeson</code> の <code>Generics</code> は <code>Maybe a</code> ならキーが無くても良いので，そっちに合わせた．</p>
<h2 id="仕組み">仕組み</h2>
<p>コード自体は<a href="https://github.com/matsubara0507/whoami">このリポジトリ</a>にある．</p>
<h3 id="基本的な部分">基本的な部分</h3>
<p>基本的に Yaml ファイルにはサイト・記事・ライブラリ・アプリケーションを列挙してもらう． それらは次のような型になっている(型の値として取り出せる)．</p>
<div class="sourceCode" id="cb10"><pre class="sourceCode haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb10-1" data-line-number="1"><span class="kw">type</span> <span class="dt">Config</span> <span class="fu">=</span> <span class="dt">Record</span></a>
<a class="sourceLine" id="cb10-2" data-line-number="2">  <span class="ch">'[ &quot;name&quot;    &gt;: Text</span></a>
<a class="sourceLine" id="cb10-3" data-line-number="3">   , <span class="st">&quot;account&quot;</span> <span class="fu">&gt;:</span> <span class="dt">Accounts</span></a>
<a class="sourceLine" id="cb10-4" data-line-number="4">   , <span class="st">&quot;site&quot;</span>    <span class="fu">&gt;:</span> [<span class="dt">SiteConfig</span>]</a>
<a class="sourceLine" id="cb10-5" data-line-number="5">   , <span class="st">&quot;post&quot;</span>    <span class="fu">&gt;:</span> <span class="dt">Record</span> <span class="ch">'[ &quot;latest&quot; &gt;: Maybe Int, &quot;posts&quot; &gt;: [PostConfig]]</span></a>
<a class="sourceLine" id="cb10-6" data-line-number="6">   , <span class="st">&quot;library&quot;</span> <span class="fu">&gt;:</span> [<span class="dt">LibConfig</span>]</a>
<a class="sourceLine" id="cb10-7" data-line-number="7">   , <span class="st">&quot;app&quot;</span>     <span class="fu">&gt;:</span> [<span class="dt">AppConfig</span>]</a>
<a class="sourceLine" id="cb10-8" data-line-number="8">   , <span class="st">&quot;qiita&quot;</span>   <span class="fu">&gt;:</span> <span class="dt">QiitaConfig</span></a>
<a class="sourceLine" id="cb10-9" data-line-number="9">   ]</a>
<a class="sourceLine" id="cb10-10" data-line-number="10"></a>
<a class="sourceLine" id="cb10-11" data-line-number="11"><span class="kw">type</span> <span class="dt">Accounts</span> <span class="fu">=</span> <span class="dt">Map</span> <span class="dt">Text</span> <span class="dt">Text</span></a>
<a class="sourceLine" id="cb10-12" data-line-number="12"><span class="kw">type</span> <span class="dt">Url</span> <span class="fu">=</span> <span class="dt">Text</span></a>
<a class="sourceLine" id="cb10-13" data-line-number="13"><span class="kw">type</span> <span class="dt">Date</span> <span class="fu">=</span> <span class="dt">Text</span></a>
<a class="sourceLine" id="cb10-14" data-line-number="14"></a>
<a class="sourceLine" id="cb10-15" data-line-number="15"><span class="kw">type</span> <span class="dt">SiteConfig</span> <span class="fu">=</span> <span class="dt">Record</span></a>
<a class="sourceLine" id="cb10-16" data-line-number="16">  <span class="ch">'[ &quot;name&quot; &gt;: Text</span></a>
<a class="sourceLine" id="cb10-17" data-line-number="17">   , <span class="st">&quot;url&quot;</span>  <span class="fu">&gt;:</span> <span class="dt">Url</span></a>
<a class="sourceLine" id="cb10-18" data-line-number="18">   , <span class="st">&quot;description&quot;</span> <span class="fu">&gt;:</span> <span class="dt">Text</span></a>
<a class="sourceLine" id="cb10-19" data-line-number="19">   ]</a>
<a class="sourceLine" id="cb10-20" data-line-number="20"></a>
<a class="sourceLine" id="cb10-21" data-line-number="21"><span class="kw">type</span> <span class="dt">PostConfig</span> <span class="fu">=</span> <span class="dt">Record</span></a>
<a class="sourceLine" id="cb10-22" data-line-number="22">  <span class="ch">'[ &quot;title&quot; &gt;: Maybe Text</span></a>
<a class="sourceLine" id="cb10-23" data-line-number="23">   , <span class="st">&quot;url&quot;</span>  <span class="fu">&gt;:</span> <span class="dt">Url</span></a>
<a class="sourceLine" id="cb10-24" data-line-number="24">   , <span class="st">&quot;date&quot;</span> <span class="fu">&gt;:</span> <span class="dt">Maybe</span> <span class="dt">Date</span></a>
<a class="sourceLine" id="cb10-25" data-line-number="25">   ]</a>
<a class="sourceLine" id="cb10-26" data-line-number="26"></a>
<a class="sourceLine" id="cb10-27" data-line-number="27"><span class="kw">type</span> <span class="dt">LibConfig</span> <span class="fu">=</span> <span class="dt">Record</span></a>
<a class="sourceLine" id="cb10-28" data-line-number="28">  <span class="ch">'[ &quot;name&quot; &gt;: Text</span></a>
<a class="sourceLine" id="cb10-29" data-line-number="29">   , <span class="st">&quot;url&quot;</span>  <span class="fu">&gt;:</span> <span class="dt">Url</span></a>
<a class="sourceLine" id="cb10-30" data-line-number="30">   , <span class="st">&quot;description&quot;</span> <span class="fu">&gt;:</span> <span class="dt">Maybe</span> <span class="dt">Text</span></a>
<a class="sourceLine" id="cb10-31" data-line-number="31">   , <span class="st">&quot;language&quot;</span> <span class="fu">&gt;:</span> <span class="dt">Text</span></a>
<a class="sourceLine" id="cb10-32" data-line-number="32">   ]</a>
<a class="sourceLine" id="cb10-33" data-line-number="33"></a>
<a class="sourceLine" id="cb10-34" data-line-number="34"><span class="kw">type</span> <span class="dt">AppConfig</span> <span class="fu">=</span> <span class="dt">Record</span></a>
<a class="sourceLine" id="cb10-35" data-line-number="35">  <span class="ch">'[ &quot;name&quot; &gt;: Text</span></a>
<a class="sourceLine" id="cb10-36" data-line-number="36">   , <span class="st">&quot;url&quot;</span>  <span class="fu">&gt;:</span> <span class="dt">Url</span></a>
<a class="sourceLine" id="cb10-37" data-line-number="37">   , <span class="st">&quot;description&quot;</span> <span class="fu">&gt;:</span> <span class="dt">Maybe</span> <span class="dt">Text</span></a>
<a class="sourceLine" id="cb10-38" data-line-number="38">   ]</a></code></pre></div>
<p><a href="https://hackage.haskell.org/package/yaml">yaml</a>パッケージを使って，Yaml ファイルから <code>Config</code> 型にデコードしてもらう． <code>Maybe a</code> になっているところは書いてあっても無くても良い項目だ．</p>
<p>そしてサイト・記事・ライブラリ・アプリケーション固有の <code>Config</code> 型を共通のフォーマットである <code>Info</code> 型に変換する手続きを型クラスを用いて定義した．</p>
<div class="sourceCode" id="cb11"><pre class="sourceCode haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb11-1" data-line-number="1"><span class="kw">type</span> <span class="dt">Info</span> <span class="fu">=</span> <span class="dt">Record</span></a>
<a class="sourceLine" id="cb11-2" data-line-number="2">  <span class="ch">'[ &quot;name&quot; &gt;: Text</span></a>
<a class="sourceLine" id="cb11-3" data-line-number="3">   , <span class="st">&quot;url&quot;</span> <span class="fu">&gt;:</span> <span class="dt">Url</span></a>
<a class="sourceLine" id="cb11-4" data-line-number="4">   , <span class="st">&quot;description&quot;</span> <span class="fu">&gt;:</span> <span class="dt">Text</span></a>
<a class="sourceLine" id="cb11-5" data-line-number="5">   , <span class="st">&quot;type&quot;</span> <span class="fu">&gt;:</span> <span class="dt">ServiceType</span></a>
<a class="sourceLine" id="cb11-6" data-line-number="6">   ]</a>
<a class="sourceLine" id="cb11-7" data-line-number="7"></a>
<a class="sourceLine" id="cb11-8" data-line-number="8"><span class="kw">type</span> <span class="dt">ServiceType</span> <span class="fu">=</span> <span class="dt">Variant</span></a>
<a class="sourceLine" id="cb11-9" data-line-number="9">  <span class="ch">'[ &quot;post&quot; &gt;: Post</span></a>
<a class="sourceLine" id="cb11-10" data-line-number="10">   , <span class="st">&quot;app&quot;</span>  <span class="fu">&gt;:</span> <span class="dt">Application</span></a>
<a class="sourceLine" id="cb11-11" data-line-number="11">   , <span class="st">&quot;lib&quot;</span>  <span class="fu">&gt;:</span> <span class="dt">Library</span></a>
<a class="sourceLine" id="cb11-12" data-line-number="12">   , <span class="st">&quot;site&quot;</span> <span class="fu">&gt;:</span> <span class="dt">Site</span></a>
<a class="sourceLine" id="cb11-13" data-line-number="13">   ]</a>
<a class="sourceLine" id="cb11-14" data-line-number="14"></a>
<a class="sourceLine" id="cb11-15" data-line-number="15"><span class="kw">class</span> <span class="dt">Uniform</span> a <span class="kw">where</span></a>
<a class="sourceLine" id="cb11-16" data-line-number="16"><span class="ot">  fetch ::</span> a <span class="ot">-&gt;</span> <span class="dt">ServiceM</span> <span class="dt">Data</span></a>
<a class="sourceLine" id="cb11-17" data-line-number="17"><span class="ot">  fill ::</span> a <span class="ot">-&gt;</span> <span class="dt">Data</span> <span class="ot">-&gt;</span> <span class="dt">ServiceM</span> a</a>
<a class="sourceLine" id="cb11-18" data-line-number="18"><span class="ot">  uniform ::</span> a <span class="ot">-&gt;</span> <span class="dt">ServiceM</span> <span class="dt">Info</span></a>
<a class="sourceLine" id="cb11-19" data-line-number="19"></a>
<a class="sourceLine" id="cb11-20" data-line-number="20"><span class="kw">type</span> <span class="dt">Data</span> <span class="fu">=</span> <span class="dt">Text</span></a>
<a class="sourceLine" id="cb11-21" data-line-number="21"></a>
<a class="sourceLine" id="cb11-22" data-line-number="22"><span class="ot">toInfo ::</span> <span class="dt">Uniform</span> a <span class="ot">=&gt;</span> a <span class="ot">-&gt;</span> <span class="dt">ServiceM</span> <span class="dt">Info</span></a>
<a class="sourceLine" id="cb11-23" data-line-number="23">toInfo conf <span class="fu">=</span> uniform <span class="fu">=&lt;&lt;</span> fill conf <span class="fu">=&lt;&lt;</span> fetch conf</a></code></pre></div>
<p><code>Uniform</code> 型クラスに3つの関数は</p>
<ul>
<li><code>fill</code> 関数は共通のフォーマットにするための足りない情報(<code>Maybe a</code> で <code>Nothing</code> だったところ)をスクレイピングなどで補完</li>
<li><code>fetch</code> 関数はスクレイピングするための HTML などを取ってくる</li>
<li><code>uniform</code> 関数は実際に共通フォーマットに変換する</li>
</ul>
<p>といった具合だ(正直分けなくてもいい)．</p>
<h2 id="section-2"></h2>
<p>他にも GitHub・BitBacket・GitLab なんかを全部一緒に取り扱う <code>Repo</code> とかも作ってもいいかもしれない． 問題は，自分が GitHub 以外に使ってないのでテストできない点だ．</p>
<h3 id="qiita-とか">Qiita とか</h3>
<p>Qiita とかは RESTful API を叩いて記事を集めてる． そもそも記事自体を集めるところと，<code>Uniform</code> 型クラスのインスタンスを共通化するのに <code>Service</code> 型クラスを作った(名前が微妙)．</p>
<div class="sourceCode" id="cb12"><pre class="sourceCode haskell"><code class="sourceCode haskell"><a class="sourceLine" id="cb12-1" data-line-number="1"><span class="kw">class</span> <span class="dt">Service</span> a <span class="kw">where</span></a>
<a class="sourceLine" id="cb12-2" data-line-number="2"><span class="ot">  genInfo ::</span> <span class="dt">Proxy</span> a <span class="ot">-&gt;</span> <span class="dt">ServiceM</span> [<span class="dt">Info</span>]</a></code></pre></div>
<p><code>Proxy a</code> なのはしょうがない． お好きなサービス(自分のサイトとかでも)を <code>Service</code> 型クラスのインスタンスにして，<code>Whoami</code> 型のインスタンスを書き換えれば，いろんなサイトを共通の形式で扱える．</p>
<h2 id="on-github-pages">on GitHub Pages</h2>
<p>GitHub Pages で簡単に使えるようにした． サンプルのリポジトリを作ったので，これをフォークして Travis CI と GitHub Pages を設定するだけで使えるはずだ(もちろん <code>whoami.yaml</code> を書き換えて)．</p>
<ul>
<li><a href="https://github.com/matsubara0507/whoami-example">matsubara0507/whoami-example - GitHub</a></li>
</ul>
<p>Stackage (というか Hackage)に置いていないツールを <code>stack install</code> するために，<code>package.yaml</code> と <code>stack.yaml</code> と <code>.gitignore</code> を置いてるけど気にしないで． Travis CI の定期実行を設定しておけば定期的に Qita の記事とかを更新してくれる．</p>
<h2 id="おしまい">おしまい</h2>
<p>そーいえば，UNIX 系には <code>whoami</code> というコマンドがあるんでしたね(Windowsユーザー)． 紛らわしい名前にしてしまった．</p>
  </div>
</div>
</article>

          </div>
        </div>

        <footer class="site-footer">

  <div class="wrapper">

    <span class="footer-heading">ひげメモ</span>

  </div>

  <div class="page-content card" style="display: flex; justify-content: center; padding: 5px 0px">
    <a href="https://haskell.jp/blog/posts/links.html#matsubara0507.github.io">
      <img width="234" src="https://haskell.jp/img/supported-by-haskell-jp.svg" alt="Supported By Haskell-jp.">
    </a>
  </div>

</footer>


      </div>
  </body>

</html>
