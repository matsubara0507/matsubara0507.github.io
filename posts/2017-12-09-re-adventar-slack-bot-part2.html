<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE html>
<html lang="ja">

  <head>
  <meta charset="utf-8">
  <link rel="icon" href="../assets/icon.jpg">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
    
      <meta property="og:title" content="Re: ゼロから作る ADVENTAR の Slack Bot (CircleCI 編)" />
    
  

  <meta property="og:site_name" content="ひげメモ" />

  
    <meta property="og:image" content="/assets/re-adventar-slack-bot/run-on-circleci.jpg" />
  

  
    <script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-86386380-1', 'auto');
  ga('send', 'pageview');
</script>

  

  <title>
    
      
        Re: ゼロから作る ADVENTAR の Slack Bot (CircleCI 編)
      
    
  </title>

  <link rel="stylesheet" href="../css/main.css">
  <link rel="stylesheet" href="../css/highlight.css">
  <link rel="stylesheet" type="text/css" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.4.0/css/font-awesome.min.css" />
</head>


  <body>
      <div class="outer">

        <header class="site-header">

  <div class="wrapper">

    <a class="site-title" href="https://matsubara0507.github.io/">ひげメモ</a>

  </div>

  <div class="header-badge">
    <a href="https://matsubara0507.github.io/">
        <img src="../assets/icon.jpg" />
    </a>
  </div>

</header>


        <div class="page-content">
          <div class="wrapper">
            <article class="post card" itemscope itemtype="http://schema.org/BlogPosting">
 <div class="card-content">
  <header class="post-header">
    <h1 class="post-title" itemprop="name headline">Re: ゼロから作る ADVENTAR の Slack Bot (CircleCI 編)</h1>
    <p class="post-meta">
      <time datetime="2017-12-09" itemprop="datePublished">
        Dec 9, 2017
      </time>
      
    </p>
  </header>

  <div class="post-content" itemprop="articleBody">
    <p>ドーモ CircleCI でなんでもするマンです．</p>
<div class="figure">
<img src="../assets/re-adventar-slack-bot/nandemoyaruman.jpg" />

</div>
<p>ADVENTAR の更新通知 Slack Bot を作ったという話の後編です(書いてたら長くなったので分けた)． ちなみに，前半に書いた通り，わざわざスクレイピングとかしなくても RSS を取得できます (;ω;)</p>
<p><a href="../posts/2017-12-02-re-adventar-slack-bot-part1.html">前編</a>はコチラ．</p>
<h2 id="前回までのあらすじ">前回までのあらすじ</h2>
<p>Haskell 製 ADVENTAR の更新通知 Slack Bot プログラムが完成した．</p>
<h3 id="今回">今回</h3>
<p>できたけどドコで定期実行する？ お金ないのでタダで回したいよね？ CircleCI なら Docker 使えるからやりたい放題じゃん！！ ってことで CircleCI で Haskell プログラムを実行する．</p>
<h2 id="戦略">戦略</h2>
<p>Circle CI で実行するための戦略はこうだ．</p>
<ol style="list-style-type: decimal">
<li>プログラムを Dockerrize する</li>
<li>selenium のスタンドアローンと docker-compose する</li>
<li>Circle CI では docker-compose を実行する(だけ)</li>
<li>前の状態は JSON で管理し更新があったらリポジトリに push</li>
<li>コレを cron で回す</li>
</ol>
<p>いちいち CIrcle CI 上で Docker ビルドしてたら時間がかかりすぎる． なので，事前にビルドしたイメージを Docker Hub にあげておいて，Circle CI 上では docker pull するだけにする．</p>
<div class="figure">
<img src="../assets/re-adventar-slack-bot/run-on-circleci.jpg" />

</div>
<h2 id="作る">作る</h2>
<h3 id="プログラムを-dockerize">1. プログラムを Dockerize</h3>
<p>前回で Haskell の話は終わりと言ったが <strong>あれはウソだ</strong> ！！</p>
<p>(※ 言ってません)</p>
<p>Haskell のビルドツール <a href="https://docs.haskellstack.org/en/stable/README/">stack</a> には <a href="https://docs.haskellstack.org/en/stable/docker_integration/">Docker Integration</a> と言う機能がある． Docker Integration は主に以下の2つの機能を提供する．</p>
<ol style="list-style-type: decimal">
<li>ホスト環境ではなく Docker の上でビルド</li>
<li>Docker イメージの作成</li>
</ol>
<p>これらの設定は <code>stack.yaml</code> で行う．</p>
<div class="sourceCode"><pre class="sourceCode yaml"><code class="sourceCode yaml"><span class="fu">resolver:</span><span class="at"> lts-9.12</span>
<span class="fu">packages:</span>
  <span class="kw">-</span> .
<span class="fu">extra-deps:</span>
  <span class="kw">-</span> slack-api-0.12
<span class="fu">flags:</span><span class="at"> </span><span class="kw">{}</span>
<span class="fu">extra-package-dbs:</span><span class="at"> </span><span class="kw">[]</span>

<span class="fu">docker:</span>
  <span class="fu">repo:</span><span class="at"> </span><span class="st">&quot;fpco/stack-build&quot;</span>

<span class="fu">image:</span>
  <span class="fu">container:</span>
    <span class="fu">name:</span><span class="at"> </span><span class="st">&quot;matsubara0507/adventar-bot&quot;</span>
    <span class="fu">base:</span><span class="at"> </span><span class="st">&quot;matsubara0507/ubuntu-tcp&quot;</span>
    <span class="fu">add:</span>
      <span class="fu">scripts:</span><span class="at"> /usr/local/bin</span></code></pre></div>
<p><code>docker</code> の部分が (1) でのビルドするイメージを指定している． <code>image</code> の部分が (2) で作成するイメージの設定だ．</p>
<p>あとは</p>
<pre><code>$ stack build --docker --ghc-options='-optl-static -optl-pthread'
$ stack image container</code></pre>
<p>とすればよい． <code>--ghc-options='-optl-static -optl-pthread'</code> は Haskell のアプリケーションを静的コンパイルするためのオプションだ．</p>
<ul>
<li><a href="https://www.ishiy.xyz/posts/2016-02-28-haskell-docker.html">stackとdockerでHaskellプログラムを静的リンクする - iLog</a></li>
</ul>
<p>何故静的コンパイルする必要があるかと言うと，これは所謂，(Docker で最近追加された)マルチステージビルドのようなことをしているからだ． Haskell の実行環境は非常に重く，数GBは普通にいく． しかし，この方法で生成される Docker イメージはビルドした実行ファイルをコピペしてるだけなので非常に軽い．</p>
<p>これでビルドイメージがこちら．</p>
<ul>
<li><a href="https://hub.docker.com/r/matsubara0507/adventar-bot/">matsubara0507/adventar-bot - Docker Hub</a></li>
</ul>
<p>99MBしかない．</p>
<p>ちなみに，イメージを作成するときに使っている <code>matsubara0507/ubuntu-tcp</code> は，このアプリケーションを実行するためにイロイロと雑に <code>apt-get</code> したイメージだ(<a href="https://github.com/IGGG/adventar-bot/blob/master/Dockerfiles/ubuntu-tcp/Dockerfile">Dockerfileはココ</a>)．</p>
<ul>
<li><a href="https://hub.docker.com/r/matsubara0507/ubuntu-tcp/">matsubara0507/ubuntu-tcp - Docker Hub</a></li>
</ul>
<p><code>ubuntu-tcp</code> じゃなくて <code>ubuntu</code> のイメージを使うと，確か次のようなエラーが出る．</p>
<pre><code>ConnectionFailure Network.BSD.getProtocolByName: does not exist (no such protocol name: tcp)</code></pre>
<p>最終的に参考になったのは<a href="https://github.com/bos/wreq/issues/5#issuecomment-108086543">この Issue コメント</a>． 要するに <code>netbase</code> と <code>ca-certificates</code> を <code>apt-get</code> した．</p>
<h3 id="selenium-と-docker-compose">2. Selenium と docker-compose</h3>
<p>次は <a href="http://www.seleniumhq.org/">Selenuim</a> と docker-compose する． 前半の記事に詳しくは書いたが，React.js の Web ページをスクレイピングするために，Headless Browser (Selenium)を使っている．</p>
<p>今回は以下の Selenium のイメージを用いた．</p>
<ul>
<li><a href="https://hub.docker.com/r/selenium/standalone-chrome/">selenium/standalone-chrome - Docker Hub</a></li>
</ul>
<p><a href="https://github.com/IGGG/adventar-bot/blob/master/docker-compose.yml">docker-compose.yaml</a> はこんな感じ．</p>
<div class="sourceCode"><pre class="sourceCode yaml"><code class="sourceCode yaml"><span class="fu">version:</span><span class="at"> </span><span class="st">&quot;2&quot;</span>
<span class="fu">services:</span>
  <span class="fu">bot:</span>
    <span class="fu">image:</span><span class="at"> matsubara0507/adventar-bot</span>
    <span class="fu">command:</span><span class="at"> wait.sh adventar-bot &quot;${HTML_URL}&quot; &quot;/config/entry.json&quot; &quot;${SLACK_CHANNEL}&quot;</span>
    <span class="fu">volumes:</span>
      <span class="kw">-</span> <span class="fu">./.circleci:</span><span class="at">/config</span>
    <span class="fu">depends_on:</span>
      <span class="kw">-</span> selenium
    <span class="fu">networks:</span>
      <span class="kw">-</span> apps
    <span class="fu">environment:</span>
      <span class="fu">LANG:</span><span class="at"> C.utf-8</span>
      <span class="fu">TZ:</span><span class="at"> Asia/Tokyo</span>
      <span class="fu">WD_HOST:</span><span class="at"> selenium</span>
      <span class="fu">WD_PORT:</span><span class="at"> 4444</span>
      <span class="fu">SLACK_TOKEN:</span>
  <span class="fu">selenium:</span>
    <span class="fu">image:</span><span class="at"> selenium/standalone-chrome</span>
    <span class="fu">networks:</span>
      <span class="kw">-</span> apps
    <span class="fu">ports:</span><span class="at"> </span><span class="kw">[</span><span class="st">&quot;4444&quot;</span><span class="kw">]</span>
    <span class="fu">environment:</span>
      <span class="fu">TZ:</span><span class="at"> Asia/Tokyo</span>
<span class="fu">networks:</span>
  <span class="fu">apps:</span></code></pre></div>
<p><code>adventar-bot</code> に渡している引数が前半の記事と違うのはあんまり気にしないで(適当にいくつかを環境変数で渡すようにした)． <code>wait.sh</code> は何かというと，<code>adventar-bot</code> の実行を遅延させる，こんな感じのシェルスクリプトだ．</p>
<pre class="shell"><code>#!/bin/bash
set -e
sleep 2
$@</code></pre>
<p>docker-compose あるあるだが，複数のコンテナの実行する順番を依存関係から制御することは可能だが，実行し始めてから通信の準備が完了するのを待ってはくれない． Selenium のコンテナは，通信が可能になるまで時間がかかるため，今回は 2,3 秒ほど <code>adventar-bot</code> の実行を遅らせているのだ．</p>
<h4 id="タイムゾーン">タイムゾーン</h4>
<p>これは運用し始めてからわかったのだが，ADVENTAR は事前にセットした URL の <code>hidden</code> 属性を <strong>アクセスしたマシンのタイムゾーンでの日付によって外していた</strong>． つまり，日本時間でアドベントカレンダーの担当日になっても，スクレイピングするマシーンのタイムゾーンが UTC だと，まだ日付が変わっていないので投稿していないことになってしまう(笑) なので，<code>TZ</code> 環境変数でコンテナのタイムゾーンを日本にした．</p>
<h3 id="circle-ci-で-docker-compose">3. Circle CI で docker-compose</h3>
<p>次はこの設定で <code>docker-compose</code> を CircleCI 上で実行する． これはかなり簡単で，次のような <code>.circleci/config.yml</code> を書くだけ．</p>
<div class="sourceCode"><pre class="sourceCode yaml"><code class="sourceCode yaml"><span class="fu">version:</span><span class="at"> 2</span>
<span class="fu">jobs:</span>
  <span class="fu">build:</span>
    <span class="fu">machine:</span><span class="at"> true</span>
    <span class="fu">steps:</span>
      <span class="kw">-</span> checkout
      <span class="kw">-</span> <span class="fu">run:</span>
          <span class="fu">name:</span><span class="at"> Build Docker Image</span>
          <span class="fu">command:</span><span class="at"> docker-compose pull</span>
      <span class="kw">-</span> <span class="fu">run:</span>
          <span class="fu">name:</span><span class="at"> docker-compose run bot</span>
          <span class="fu">command:</span><span class="at"> |</span>
            docker-compose -f ./docker-compose.yml run bot
<span class="fu">workflows:</span>
  <span class="fu">version:</span><span class="at"> 2</span>
  <span class="fu">normal_workflow:</span>
    <span class="fu">jobs:</span>
      <span class="kw">-</span> <span class="fu">build:</span>
          <span class="fu">filters:</span>
            <span class="fu">branches:</span>
              <span class="fu">only:</span><span class="at"> dump</span></code></pre></div>
<p>CircleCI は最初っから docker と docker-compose が入っているので，めちゃくちゃ楽ですね．</p>
<h3 id="リポジトリに-push">4. リポジトリに push</h3>
<p>ここが少しめんどくさい． CircleCI が自動で設定してくれるアクセストークンは Read Only なのだ． そのため，このままでは Push できない．</p>
<p>まぁこの辺りは公式も良く分かってるので，ちゃんとドキュメントが用意してある(英語だけどな！！)</p>
<ul>
<li><a href="https://circleci.com/docs/2.0/gh-bb-integration/#adding-readwrite-deployment-keys-to-github-or-bitbucket">Adding Read/Write Deployment Keys to GitHub or Bitbucket - CircleCI</a></li>
</ul>
<ol style="list-style-type: decimal">
<li><a href="https://help.github.com/articles/generating-ssh-keys/">GitHub のページ</a>を参考に SSH 鍵を作って(ただし <em>パスフレーズは入れちゃダメ</em>)</li>
<li>公開鍵を GitHub の <code>https://github.com/you/test-repo/settings/keys</code> に登録して</li>
<li>秘密鍵を CircleCI の <code>https://circleci.com/gh/you/test-repo/edit#ssh</code> に Hosename を <code>github.com</code> にして登録して</li>
<li>config.yml に以下のように fingerprints を書いて鍵を上書きする(チェックアウトする前に)</li>
</ol>
<div class="sourceCode"><pre class="sourceCode yaml"><code class="sourceCode yaml"><span class="fu">steps:</span>
  <span class="kw">-</span> <span class="fu">add_ssh_keys:</span>
    <span class="fu">fingerprints:</span>
      <span class="kw">-</span> <span class="st">&quot;SO:ME:FIN:G:ER:PR:IN:T&quot;</span></code></pre></div>
<h4 id="更新がある時だけ-push-する">更新がある時だけ Push する</h4>
<p>ようにしたいよね？ もちろんシェルスクリプトを書いて，<code>if</code> で分岐すればいいんだけど，めんどくさいのでシェル芸みたいにワンライナーで何とかしたい． 頑張ってググってみたら，同じ質問をしている人が居た．</p>
<ul>
<li><a href="https://stackoverflow.com/questions/22040113/how-to-let-jenkins-git-commit-only-if-there-are-changes">How to let Jenkins git commit only if there are changes? - Stack Overflow</a></li>
</ul>
<p><code>git diff --quiet &amp;&amp; git diff --staged --quiet || git commit -am 'Added license headers'</code> って感じにすれば良いみたい． なるほどなるほど．</p>
<h2 id="section"></h2>
<p>で，結果として <code>config.yml</code> の <code>jobs</code> の部分が以下のようになる．</p>
<div class="sourceCode"><pre class="sourceCode yaml"><code class="sourceCode yaml"><span class="fu">jobs:</span>
  <span class="fu">build:</span>
    <span class="fu">machine:</span><span class="at"> true</span>
    <span class="fu">steps:</span>
      <span class="kw">-</span> <span class="fu">add-ssh-keys:</span>
          <span class="fu">fingerprints:</span>
            <span class="kw">-</span> <span class="st">&quot;99:5c:f8:55:4d:2c:ab:aa:3a:e6:4b:73:1b:07:19:98&quot;</span>
      <span class="kw">-</span> checkout
      <span class="kw">-</span> <span class="fu">run:</span>
          <span class="fu">name:</span><span class="at"> Git config</span>
          <span class="fu">command:</span><span class="at"> |</span>
             git config --global user.email <span class="st">&quot;example@example.com&quot;</span>
             git config --global user.name <span class="st">&quot;Bot&quot;</span>
      <span class="kw">-</span> <span class="fu">run:</span>
          <span class="fu">name:</span><span class="at"> Build Docker Image</span>
          <span class="fu">command:</span><span class="at"> docker-compose pull</span>
      <span class="kw">-</span> <span class="fu">run:</span>
          <span class="fu">name:</span><span class="at"> docker-compose run bot</span>
          <span class="fu">command:</span><span class="at"> |</span>
            docker-compose -f ./docker-compose.yml run bot
      <span class="kw">-</span> <span class="fu">run:</span>
          <span class="fu">name:</span><span class="at"> Push update json</span>
          <span class="fu">command:</span><span class="at"> |</span>
            git status
            git diff --quiet &amp;&amp; git diff --staged --quiet || git commit -am <span class="st">&quot;[skip ci] Update entry.json&quot;</span>
            git push origin dump</code></pre></div>
<p>コミットメッセージに <code>[skip ci]</code> と書いておけば，このコミットによる CI は無視される． また，<code>Git config</code> のところはコミットするのに最低限必要な設定を書いてある．</p>
<h3 id="cron-で回す">5. cron で回す</h3>
<p>CircleCI 2.0 で cron を書けるようになった． TravisCI と違い，どんな cron でも指定できる．</p>
<div class="sourceCode"><pre class="sourceCode yaml"><code class="sourceCode yaml"><span class="fu">workflows:</span>
  <span class="fu">version:</span><span class="at"> 2</span>
  <span class="fu">normal_workflow:</span>
    <span class="fu">jobs:</span>
      <span class="kw">-</span> <span class="fu">build:</span>
          <span class="fu">filters:</span>
            <span class="fu">branches:</span>
              <span class="fu">only:</span><span class="at"> dump</span>
  <span class="fu">nightly_workflow:</span>
    <span class="fu">triggers:</span>
      <span class="kw">-</span> <span class="fu">schedule:</span>
          <span class="fu">cron:</span><span class="at"> </span><span class="st">&quot;0 0 * * *&quot;</span>
          <span class="fu">filters:</span>
            <span class="fu">branches:</span>
              <span class="fu">only:</span><span class="at"> dump</span>
    <span class="fu">jobs:</span>
      <span class="kw">-</span> build</code></pre></div>
<p>ちなみに，CircleCI のタイムゾーンは UTC なので，毎朝9時に実行されることになる．</p>
<h2 id="完成">完成</h2>
<p>見た目全く変わらないけど，一応 CircleCI から実行されてる．</p>
<div class="figure">
<img src="../assets/re-adventar-slack-bot/adventar-bot-1.jpg" />

</div>
<h2 id="おしまい">おしまい</h2>
<p>ただし，CircleCI は月に使えるビルド時間が決まってて，1500分しかない． こいつはだいたい1分ぐらいかかるので月1500回． まぁ1日1回ぐらいなら余裕か．</p>
  </div>
</div>
</article>

          </div>
        </div>

        <footer class="site-footer">

  <div class="wrapper">

    <span class="footer-heading">ひげメモ</span>

  </div>

  <div class="page-content card" style="display: flex; justify-content: center; padding: 5px 0px">
    <a href="https://haskell.jp/blog/posts/links.html#matsubara0507.github.io">
      <img width="234" src="https://haskell.jp/img/supported-by-haskell-jp.svg" alt="Supported By Haskell-jp.">
    </a>
  </div>

</footer>


      </div>
  </body>

</html>
