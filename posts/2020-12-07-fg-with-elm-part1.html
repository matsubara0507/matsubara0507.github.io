<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE html>
<html lang="ja">

  <head>
  <meta charset="utf-8">
  <link rel="icon" href="../assets/icon.jpg">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
    
      <meta property="og:title" content="Elm で Featherweight Go を書いてみた（その１）" />
    
  

  <meta property="og:site_name" content="ひげメモ" />

  
    <meta property="og:image" content="/assets/fg-with-elm/fg-parser-page.jpg" />
  

  
    <script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-86386380-1', 'auto');
  ga('send', 'pageview');
</script>

  

  <title>
    
      
        Elm で Featherweight Go を書いてみた（その１）
      
    
  </title>

  <link rel="stylesheet" href="../css/main.css">
  <link rel="stylesheet" href="../css/highlight.css">
  <link rel="stylesheet" type="text/css" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.4.0/css/font-awesome.min.css" />
</head>


  <body>
      <div class="outer">

        <header class="site-header">

  <div class="wrapper">

    <a class="site-title" href="https://matsubara0507.github.io/">ひげメモ</a>

  </div>

  <div class="header-badge">
    <a href="https://matsubara0507.github.io/">
        <img src="../assets/icon.jpg" />
    </a>
  </div>

</header>


        <div class="page-content">
          <div class="wrapper">
            <article class="post card" itemscope itemtype="http://schema.org/BlogPosting">
 <div class="card-content">
  <header class="post-header">
    <h1 class="post-title" itemprop="name headline">Elm で Featherweight Go を書いてみた（その１）</h1>
    <p class="post-meta">
      <time datetime="2020-12-07" itemprop="datePublished">
        Dec 7, 2020
      </time>
      
      
      <div class="tags">
          <i class="fa fa-tags"></i> <a href="../tags/Elm.html">Elm</a> <a href="../tags/Go.html">Go</a>
      </div>
      
    </p>
  </header>

  <div class="post-content" itemprop="articleBody">
    <p>タイトルの通り，Elm で Featherweight Go を作って遊んでました． 本記事はそのメモ書きです．</p>
<h1 id="section"></h1>
<p>あとこれは <a href="https://qiita.com/advent-calendar/2020/elm">Elm Advent Calendar 2020</a> の7日目の記事です．</p>
<h2 id="featherweight-go">Featherweight Go</h2>
<p>Go にジェネリクスを導入するために考案された，極めてミニマムな Go 処理系（の形式的な定義）． そのまんま「<a href="https://arxiv.org/abs/2005.11710">Featherweight Go</a>」という論文が出てる． 前に，ざっくり日本語でまとめました：</p>
<ul>
<li><a href="https://matsubara0507.github.io/posts/2020-07-02-read-featherweight-go.html">Featherweight Go を読んでみた - ひげメモ</a></li>
</ul>
<p>論文では Featherweight Go（以下 FG）と，それにジェネリクスを追加した Featherweight Generics Go の構文規則・評価規則・型付け規則などが定義されており，型安全性が証明されている． 今回は，Featherweight Go のパーサーと型検査器を論文の定義に則って Elm で実装した話．</p>
<p>ちなみに評価の方は実装しないです．</p>
<h2 id="elm">Elm</h2>
<p>Elm は JavaScript へとトランスパイルされる Web フロントエンドに特化した純粋関数型プログラミング言語． 構文は Haskell に似ているが，言語機能自体は Haskell のように多彩ではなく，極めてコンパクトである．</p>
<p>今回 Elm を使う理由は2つあって：</p>
<ol type="1">
<li>Elm でプログラミング言語作る人がほとんど居ないから</li>
<li>簡単に Web ビュー側を作れるから</li>
</ol>
<p>です．</p>
<h3 id="elm-でパーサーを作るには">Elm でパーサーを作るには</h3>
<p>Elm でパーサーを記述するには <a href="https://package.elm-lang.org/packages/elm/parser">elm/parser</a> という公式が提供しているパーサーコンビネーターライブラリを使う．</p>
<h2 id="fgのパーサーを作る">FGのパーサーを作る</h2>
<p>構文規則は次の通り：</p>
<p><img src="../assets/read-featherweight-go/fg.jpg" /></p>
<p>これを Elm でひたすら実装していく．</p>
<h3 id="構文の型を定義">構文の型を定義</h3>
<p>まずは，構文を表現する型を定義しよう． ひたすら予約語にあたる部分を排除するだけだ：</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode elm"><code class="sourceCode elm"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true"></a><span class="kw">module</span> <span class="dt">Go</span><span class="op">.</span><span class="dt">Featherweight</span><span class="op">.</span><span class="dt">Syntax</span> <span class="kw">exposing</span> (<span class="op">..</span>)</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true"></a></span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true"></a><span class="kw">type</span> <span class="kw">alias</span> <span class="dt">Program</span> <span class="op">=</span></span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true"></a>    { <span class="fu">decls</span> : <span class="dt">List</span> <span class="dt">Declaration</span><span class="op">,</span> <span class="fu">exp</span> : <span class="dt">Expression</span> }</span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true"></a></span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true"></a><span class="kw">type</span> <span class="dt">Declaration</span></span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true"></a>    <span class="op">=</span> <span class="dt">TDecl</span></span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true"></a>        { <span class="fu">name</span> : <span class="dt">TypeName</span></span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true"></a>        <span class="op">,</span> <span class="fu">literal</span> : <span class="dt">TypeLiteral</span></span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true"></a>        }</span>
<span id="cb1-11"><a href="#cb1-11" aria-hidden="true"></a>    <span class="op">|</span> <span class="dt">MDecl</span></span>
<span id="cb1-12"><a href="#cb1-12" aria-hidden="true"></a>        { <span class="fu">recv</span> : ( <span class="dt">VarName</span><span class="op">,</span> <span class="dt">TypeName</span> )</span>
<span id="cb1-13"><a href="#cb1-13" aria-hidden="true"></a>        <span class="op">,</span> <span class="fu">name</span> : <span class="dt">MethodName</span></span>
<span id="cb1-14"><a href="#cb1-14" aria-hidden="true"></a>        <span class="op">,</span> <span class="fu">sign</span> : <span class="dt">MethodSignature</span></span>
<span id="cb1-15"><a href="#cb1-15" aria-hidden="true"></a>        <span class="op">,</span> <span class="fu">retv</span> : <span class="dt">Expression</span></span>
<span id="cb1-16"><a href="#cb1-16" aria-hidden="true"></a>        }</span>
<span id="cb1-17"><a href="#cb1-17" aria-hidden="true"></a></span>
<span id="cb1-18"><a href="#cb1-18" aria-hidden="true"></a><span class="kw">type</span> <span class="kw">alias</span> <span class="dt">TypeName</span> <span class="op">=</span> <span class="dt">String</span></span>
<span id="cb1-19"><a href="#cb1-19" aria-hidden="true"></a><span class="kw">type</span> <span class="kw">alias</span> <span class="dt">VarName</span> <span class="op">=</span> <span class="dt">String</span></span>
<span id="cb1-20"><a href="#cb1-20" aria-hidden="true"></a><span class="kw">type</span> <span class="kw">alias</span> <span class="dt">MethodName</span> <span class="op">=</span> <span class="dt">String</span></span>
<span id="cb1-21"><a href="#cb1-21" aria-hidden="true"></a><span class="kw">type</span> <span class="kw">alias</span> <span class="dt">FieldName</span> <span class="op">=</span> <span class="dt">String</span></span>
<span id="cb1-22"><a href="#cb1-22" aria-hidden="true"></a></span>
<span id="cb1-23"><a href="#cb1-23" aria-hidden="true"></a><span class="kw">type</span> <span class="dt">TypeLiteral</span></span>
<span id="cb1-24"><a href="#cb1-24" aria-hidden="true"></a>    <span class="op">=</span> <span class="dt">Structure</span> (<span class="dt">List</span> ( <span class="dt">FieldName</span><span class="op">,</span> <span class="dt">TypeName</span> ))</span>
<span id="cb1-25"><a href="#cb1-25" aria-hidden="true"></a>    <span class="op">|</span> <span class="dt">Interface</span> (<span class="dt">List</span> <span class="dt">MethodSpecific</span>)</span>
<span id="cb1-26"><a href="#cb1-26" aria-hidden="true"></a></span>
<span id="cb1-27"><a href="#cb1-27" aria-hidden="true"></a><span class="kw">type</span> <span class="kw">alias</span> <span class="dt">MethodSpecific</span> <span class="op">=</span></span>
<span id="cb1-28"><a href="#cb1-28" aria-hidden="true"></a>    { <span class="fu">name</span> : <span class="dt">MethodName</span><span class="op">,</span> <span class="fu">sign</span> : <span class="dt">MethodSignature</span> }</span>
<span id="cb1-29"><a href="#cb1-29" aria-hidden="true"></a></span>
<span id="cb1-30"><a href="#cb1-30" aria-hidden="true"></a><span class="kw">type</span> <span class="kw">alias</span> <span class="dt">MethodSignature</span> <span class="op">=</span></span>
<span id="cb1-31"><a href="#cb1-31" aria-hidden="true"></a>    { <span class="fu">args</span> : <span class="dt">List</span> ( <span class="dt">VarName</span><span class="op">,</span> <span class="dt">TypeName</span> )<span class="op">,</span> <span class="fu">rett</span> : <span class="dt">TypeName</span> }</span>
<span id="cb1-32"><a href="#cb1-32" aria-hidden="true"></a></span>
<span id="cb1-33"><a href="#cb1-33" aria-hidden="true"></a><span class="kw">type</span> <span class="dt">Expression</span></span>
<span id="cb1-34"><a href="#cb1-34" aria-hidden="true"></a>    <span class="op">=</span> <span class="dt">Var</span> <span class="dt">VarName</span></span>
<span id="cb1-35"><a href="#cb1-35" aria-hidden="true"></a>    <span class="op">|</span> <span class="dt">MethodCall</span></span>
<span id="cb1-36"><a href="#cb1-36" aria-hidden="true"></a>        { <span class="fu">exp</span> : <span class="dt">Expression</span></span>
<span id="cb1-37"><a href="#cb1-37" aria-hidden="true"></a>        <span class="op">,</span> <span class="fu">method</span> : <span class="dt">MethodName</span></span>
<span id="cb1-38"><a href="#cb1-38" aria-hidden="true"></a>        <span class="op">,</span> <span class="fu">args</span> : <span class="dt">List</span> <span class="dt">Expression</span></span>
<span id="cb1-39"><a href="#cb1-39" aria-hidden="true"></a>        }</span>
<span id="cb1-40"><a href="#cb1-40" aria-hidden="true"></a>    <span class="op">|</span> <span class="dt">StructLiteral</span></span>
<span id="cb1-41"><a href="#cb1-41" aria-hidden="true"></a>        { <span class="fu">struct</span> : <span class="dt">TypeName</span></span>
<span id="cb1-42"><a href="#cb1-42" aria-hidden="true"></a>        <span class="op">,</span> <span class="fu">args</span> : <span class="dt">List</span> <span class="dt">Expression</span></span>
<span id="cb1-43"><a href="#cb1-43" aria-hidden="true"></a>        }</span>
<span id="cb1-44"><a href="#cb1-44" aria-hidden="true"></a>    <span class="op">|</span> <span class="dt">SelectField</span></span>
<span id="cb1-45"><a href="#cb1-45" aria-hidden="true"></a>        { <span class="fu">exp</span> : <span class="dt">Expression</span></span>
<span id="cb1-46"><a href="#cb1-46" aria-hidden="true"></a>        <span class="op">,</span> <span class="fu">field</span> : <span class="dt">FieldName</span></span>
<span id="cb1-47"><a href="#cb1-47" aria-hidden="true"></a>        }</span>
<span id="cb1-48"><a href="#cb1-48" aria-hidden="true"></a>    <span class="op">|</span> <span class="dt">TypeAssertion</span></span>
<span id="cb1-49"><a href="#cb1-49" aria-hidden="true"></a>        { <span class="fu">exp</span> : <span class="dt">Expression</span></span>
<span id="cb1-50"><a href="#cb1-50" aria-hidden="true"></a>        <span class="op">,</span> <span class="fu">ty</span> : <span class="dt">TypeName</span></span>
<span id="cb1-51"><a href="#cb1-51" aria-hidden="true"></a>        }</span></code></pre></div>
<h3 id="パーサーを書く">パーサーを書く</h3>
<p>先に，FG のパーサーを記述する上で便利なヘルパー関数をいくつか定義しておく：</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode elm"><code class="sourceCode elm"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true"></a><span class="kw">module</span> <span class="dt">Go</span><span class="op">.</span><span class="dt">Parser</span><span class="op">.</span><span class="dt">Helper</span> <span class="kw">exposing</span> (<span class="op">..</span>)</span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true"></a></span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true"></a><span class="fu">newlineSequence</span> : <span class="dt">Parser</span> () <span class="op">-&gt;</span> <span class="dt">Parser</span> <span class="fu">a</span> <span class="op">-&gt;</span> <span class="dt">Parser</span> (<span class="dt">List</span> <span class="fu">a</span>)</span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true"></a><span class="fu">newlineSequence</span> <span class="fu">end</span> <span class="fu">p</span> <span class="op">=</span> <span class="op">...</span></span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true"></a></span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true"></a><span class="fu">blockWith</span> : ( <span class="dt">String</span><span class="op">,</span> <span class="dt">String</span> ) <span class="op">-&gt;</span> <span class="dt">Parser</span> <span class="fu">a</span> <span class="op">-&gt;</span> <span class="dt">Parser</span> (<span class="dt">List</span> <span class="fu">a</span>)</span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true"></a><span class="fu">blockWith</span> ( <span class="fu">start</span><span class="op">,</span> <span class="fu">end</span> ) <span class="fu">p</span> <span class="op">=</span> <span class="op">...</span></span>
<span id="cb2-8"><a href="#cb2-8" aria-hidden="true"></a></span>
<span id="cb2-9"><a href="#cb2-9" aria-hidden="true"></a><span class="fu">whitespaces</span> : <span class="dt">Parser</span> ()</span>
<span id="cb2-10"><a href="#cb2-10" aria-hidden="true"></a><span class="fu">whitespaces</span> <span class="op">=</span> <span class="op">...</span></span>
<span id="cb2-11"><a href="#cb2-11" aria-hidden="true"></a></span>
<span id="cb2-12"><a href="#cb2-12" aria-hidden="true"></a><span class="fu">newlines</span> : <span class="dt">Parser</span> ()</span>
<span id="cb2-13"><a href="#cb2-13" aria-hidden="true"></a><span class="fu">newlines</span> <span class="op">=</span> <span class="op">...</span></span></code></pre></div>
<p><a href="https://github.com/matsubara0507/featherweight-go/blob/4ce84918c80b0852b4c32989bdbfe29331ab1fe9/src/Go/Parser/Helper.elm">実装はこの辺りを見てください</a>． <code>newlineSequence</code> は改行区切りで引数のパーサーを実行してくれる． 例えば，構造体のフィールドを改行区切りで列挙するのをパースするのに役立つ． <code>blockWith</code> は，1引数目で与えた開始文字列と終端文字列で囲まれてかつ，2引数目のパーサーをカンマ区切りで実行してくれる． 関数定義の引数のパースなどに役立つ． <code>whitespaces</code> は1つ以上の空白を，<code>newlines</code> は1つ以上の改行をパースする．</p>
<p>で，まずは「プログラム」の部分のパーサーだ． プログラムは次のようなのをパースしたい：</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode go"><code class="sourceCode go"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true"></a><span class="kw">package</span> main</span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true"></a></span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true"></a><span class="co">// 構造体や関数の定義</span></span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true"></a></span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true"></a><span class="kw">func</span> main() {</span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true"></a>    _ = .. <span class="co">// なんらかの式</span></span>
<span id="cb3-7"><a href="#cb3-7" aria-hidden="true"></a>}</span></code></pre></div>
<p>とりあえず，式や構造体の定義のパーサーはあるものと仮定して実装する：</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode elm"><code class="sourceCode elm"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true"></a><span class="kw">import</span> <span class="dt">Parser</span> <span class="kw">exposing</span> (<span class="op">..</span>)</span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true"></a><span class="kw">import</span> <span class="dt">Go</span><span class="op">.</span><span class="dt">Parser</span><span class="op">.</span><span class="dt">Helper</span> <span class="kw">exposing</span> (<span class="op">..</span>)</span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true"></a></span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true"></a><span class="fu">parser</span> : <span class="dt">Parser</span> <span class="dt">Program</span></span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true"></a><span class="fu">parser</span> <span class="op">=</span></span>
<span id="cb4-6"><a href="#cb4-6" aria-hidden="true"></a>    <span class="kw">let</span></span>
<span id="cb4-7"><a href="#cb4-7" aria-hidden="true"></a>        <span class="fu">parseMainPackage</span> <span class="op">=</span> <span class="co">-- package main の部分</span></span>
<span id="cb4-8"><a href="#cb4-8" aria-hidden="true"></a>            <span class="fu">succeed</span> ()</span>
<span id="cb4-9"><a href="#cb4-9" aria-hidden="true"></a>                <span class="op">|.</span> <span class="fu">keyword</span> <span class="st">&quot;package&quot;</span></span>
<span id="cb4-10"><a href="#cb4-10" aria-hidden="true"></a>                <span class="op">|.</span> <span class="fu">whitespaces</span></span>
<span id="cb4-11"><a href="#cb4-11" aria-hidden="true"></a>                <span class="op">|.</span> <span class="fu">keyword</span> <span class="st">&quot;main&quot;</span></span>
<span id="cb4-12"><a href="#cb4-12" aria-hidden="true"></a></span>
<span id="cb4-13"><a href="#cb4-13" aria-hidden="true"></a>        <span class="fu">parseMainFunc</span> <span class="op">=</span> <span class="co">-- func main() の部分</span></span>
<span id="cb4-14"><a href="#cb4-14" aria-hidden="true"></a>            <span class="fu">succeed</span> ()</span>
<span id="cb4-15"><a href="#cb4-15" aria-hidden="true"></a>                <span class="op">|.</span> <span class="fu">backtrackable</span> (<span class="fu">keyword</span> <span class="st">&quot;func&quot;</span>)</span>
<span id="cb4-16"><a href="#cb4-16" aria-hidden="true"></a>                <span class="op">|.</span> <span class="fu">backtrackable</span> <span class="fu">whitespaces</span></span>
<span id="cb4-17"><a href="#cb4-17" aria-hidden="true"></a>                <span class="op">|.</span> <span class="fu">keyword</span> <span class="st">&quot;main()&quot;</span></span>
<span id="cb4-18"><a href="#cb4-18" aria-hidden="true"></a></span>
<span id="cb4-19"><a href="#cb4-19" aria-hidden="true"></a>        <span class="fu">parseMainExp</span> <span class="op">=</span> <span class="co">-- _ = e の部分</span></span>
<span id="cb4-20"><a href="#cb4-20" aria-hidden="true"></a>            <span class="fu">succeed</span> <span class="fu">identity</span></span>
<span id="cb4-21"><a href="#cb4-21" aria-hidden="true"></a>                <span class="op">|.</span> <span class="fu">symbol</span> <span class="st">&quot;_&quot;</span></span>
<span id="cb4-22"><a href="#cb4-22" aria-hidden="true"></a>                <span class="op">|.</span> <span class="fu">whitespaces</span></span>
<span id="cb4-23"><a href="#cb4-23" aria-hidden="true"></a>                <span class="op">|.</span> <span class="fu">symbol</span> <span class="st">&quot;=&quot;</span></span>
<span id="cb4-24"><a href="#cb4-24" aria-hidden="true"></a>                <span class="op">|.</span> <span class="fu">whitespaces</span></span>
<span id="cb4-25"><a href="#cb4-25" aria-hidden="true"></a>                <span class="op">|=</span> <span class="fu">expParser</span></span>
<span id="cb4-26"><a href="#cb4-26" aria-hidden="true"></a>    <span class="kw">in</span></span>
<span id="cb4-27"><a href="#cb4-27" aria-hidden="true"></a>    <span class="fu">succeed</span> <span class="dt">Program</span></span>
<span id="cb4-28"><a href="#cb4-28" aria-hidden="true"></a>        <span class="op">|.</span> <span class="fu">parseMainPackage</span></span>
<span id="cb4-29"><a href="#cb4-29" aria-hidden="true"></a>        <span class="op">|.</span> <span class="fu">newlines</span></span>
<span id="cb4-30"><a href="#cb4-30" aria-hidden="true"></a>        <span class="op">|=</span> <span class="fu">newlineSequence</span> <span class="fu">parseMainFunc</span> <span class="fu">declParser</span></span>
<span id="cb4-31"><a href="#cb4-31" aria-hidden="true"></a>        <span class="op">|.</span> <span class="fu">spaces</span></span>
<span id="cb4-32"><a href="#cb4-32" aria-hidden="true"></a>        <span class="op">|.</span> <span class="fu">symbol</span> <span class="st">&quot;{&quot;</span></span>
<span id="cb4-33"><a href="#cb4-33" aria-hidden="true"></a>        <span class="op">|.</span> <span class="fu">spaces</span></span>
<span id="cb4-34"><a href="#cb4-34" aria-hidden="true"></a>        <span class="op">|=</span> <span class="fu">parseMainExp</span></span>
<span id="cb4-35"><a href="#cb4-35" aria-hidden="true"></a>        <span class="op">|.</span> <span class="fu">spaces</span></span>
<span id="cb4-36"><a href="#cb4-36" aria-hidden="true"></a>        <span class="op">|.</span> <span class="fu">symbol</span> <span class="st">&quot;}&quot;</span></span>
<span id="cb4-37"><a href="#cb4-37" aria-hidden="true"></a>        <span class="op">|.</span> <span class="fu">spaces</span></span>
<span id="cb4-38"><a href="#cb4-38" aria-hidden="true"></a>        <span class="op">|.</span> <span class="dt">Parser</span><span class="op">.</span><span class="fu">end</span></span>
<span id="cb4-39"><a href="#cb4-39" aria-hidden="true"></a></span>
<span id="cb4-40"><a href="#cb4-40" aria-hidden="true"></a><span class="fu">declParser</span> : <span class="dt">Parser</span> <span class="dt">Declaration</span></span>
<span id="cb4-41"><a href="#cb4-41" aria-hidden="true"></a><span class="fu">declParser</span> <span class="op">=</span> <span class="dt">Debug</span><span class="op">.</span><span class="fu">todo</span> <span class="st">&quot;Decl Parser&quot;</span></span>
<span id="cb4-42"><a href="#cb4-42" aria-hidden="true"></a></span>
<span id="cb4-43"><a href="#cb4-43" aria-hidden="true"></a><span class="fu">expParser</span> : <span class="dt">Parser</span> <span class="dt">Expression</span></span>
<span id="cb4-44"><a href="#cb4-44" aria-hidden="true"></a><span class="fu">expParser</span> <span class="op">=</span> <span class="dt">Debug</span><span class="op">.</span><span class="fu">todo</span> <span class="st">&quot;Exp Parser&quot;</span></span></code></pre></div>
<p>基本的に <code>declParser</code> や <code>expParser</code> も同じように構文定義を見ながら実装していくだけなので割愛する（<a href="https://github.com/matsubara0507/featherweight-go/blob/4ce84918c80b0852b4c32989bdbfe29331ab1fe9/tests/Test/Go/Featherweight/Syntax.elm">コード</a>）． 1つだけ，なんらかの変数をパースするパーサーだけは書いておく． elm/parser には <code>variable</code> というまさにこれをやるパーサーコンビネーターがあるのでこれを利用する：</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode elm"><code class="sourceCode elm"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true"></a><span class="fu">nameParser</span> : <span class="dt">Parser</span> <span class="dt">String</span></span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true"></a><span class="fu">nameParser</span> <span class="op">=</span></span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true"></a>    <span class="fu">variable</span></span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true"></a>        { <span class="fu">start</span> <span class="op">=</span> <span class="dt">Char</span><span class="op">.</span><span class="fu">isAlphaNum</span> <span class="co">-- 先頭文字，小文字や数字を含まないとかできる</span></span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true"></a>        <span class="op">,</span> <span class="fu">inner</span> <span class="op">=</span> \<span class="fu">c</span> <span class="op">-&gt;</span> <span class="dt">Char</span><span class="op">.</span><span class="fu">isAlphaNum</span> <span class="fu">c</span> <span class="op">||</span> <span class="fu">c</span> <span class="op">==</span> <span class="ch">'_'</span></span>
<span id="cb5-6"><a href="#cb5-6" aria-hidden="true"></a>        <span class="op">,</span> <span class="fu">reserved</span> <span class="op">=</span> <span class="fu">keywords</span>     <span class="co">-- 変数にはならない予約を列挙する</span></span>
<span id="cb5-7"><a href="#cb5-7" aria-hidden="true"></a>        }</span>
<span id="cb5-8"><a href="#cb5-8" aria-hidden="true"></a></span>
<span id="cb5-9"><a href="#cb5-9" aria-hidden="true"></a><span class="fu">keywords</span> : <span class="dt">Set</span> <span class="dt">String</span></span>
<span id="cb5-10"><a href="#cb5-10" aria-hidden="true"></a><span class="fu">keywords</span> <span class="op">=</span></span>
<span id="cb5-11"><a href="#cb5-11" aria-hidden="true"></a>    <span class="dt">Set</span><span class="op">.</span><span class="fu">fromList</span></span>
<span id="cb5-12"><a href="#cb5-12" aria-hidden="true"></a>        [ <span class="st">&quot;package&quot;</span></span>
<span id="cb5-13"><a href="#cb5-13" aria-hidden="true"></a>        <span class="op">,</span> <span class="st">&quot;main&quot;</span></span>
<span id="cb5-14"><a href="#cb5-14" aria-hidden="true"></a>        <span class="op">,</span> <span class="st">&quot;func&quot;</span></span>
<span id="cb5-15"><a href="#cb5-15" aria-hidden="true"></a>        <span class="op">,</span> <span class="st">&quot;struct&quot;</span></span>
<span id="cb5-16"><a href="#cb5-16" aria-hidden="true"></a>        <span class="op">,</span> <span class="st">&quot;interface&quot;</span></span>
<span id="cb5-17"><a href="#cb5-17" aria-hidden="true"></a>        <span class="op">,</span> <span class="st">&quot;type&quot;</span></span>
<span id="cb5-18"><a href="#cb5-18" aria-hidden="true"></a>        <span class="op">,</span> <span class="st">&quot;return&quot;</span></span>
<span id="cb5-19"><a href="#cb5-19" aria-hidden="true"></a>        ]</span></code></pre></div>
<h3 id="テスト">テスト</h3>
<p>とりあえず簡単に，FGの論文にあるサンプルコードが動作するかのテストだけを書いた：</p>
<div class="sourceCode" id="cb6"><pre class="sourceCode elm"><code class="sourceCode elm"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true"></a><span class="kw">module</span> <span class="dt">Test</span><span class="op">.</span><span class="dt">Go</span><span class="op">.</span><span class="dt">Featherweight</span><span class="op">.</span><span class="dt">Syntax</span> <span class="kw">exposing</span> (<span class="fu">suite</span>)</span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true"></a></span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true"></a><span class="kw">import</span> <span class="dt">Go</span><span class="op">.</span><span class="dt">Featherweight</span><span class="op">.</span><span class="dt">Syntax</span> <span class="kw">exposing</span> (<span class="op">..</span>)</span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true"></a><span class="kw">import</span> <span class="dt">Parser</span></span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true"></a><span class="kw">import</span> <span class="dt">Test</span> <span class="kw">exposing</span> (<span class="op">..</span>)</span>
<span id="cb6-6"><a href="#cb6-6" aria-hidden="true"></a></span>
<span id="cb6-7"><a href="#cb6-7" aria-hidden="true"></a><span class="fu">suite</span> : <span class="dt">Test</span></span>
<span id="cb6-8"><a href="#cb6-8" aria-hidden="true"></a><span class="fu">suite</span> <span class="op">=</span></span>
<span id="cb6-9"><a href="#cb6-9" aria-hidden="true"></a>    <span class="fu">describe</span> <span class="st">&quot;module Go.Featherweight.Syntax&quot;</span></span>
<span id="cb6-10"><a href="#cb6-10" aria-hidden="true"></a>        [ <span class="fu">describe</span> <span class="st">&quot;parser&quot;</span></span>
<span id="cb6-11"><a href="#cb6-11" aria-hidden="true"></a>            [ <span class="fu">test</span> <span class="st">&quot;parse sample FG code&quot;</span> <span class="op">&lt;|</span></span>
<span id="cb6-12"><a href="#cb6-12" aria-hidden="true"></a>                \<span class="fu">_</span> <span class="op">-&gt;</span></span>
<span id="cb6-13"><a href="#cb6-13" aria-hidden="true"></a>                    <span class="dt">Parser</span><span class="op">.</span><span class="fu">run</span> <span class="fu">parser</span> <span class="fu">sample</span></span>
<span id="cb6-14"><a href="#cb6-14" aria-hidden="true"></a>                        <span class="op">|&gt;</span> <span class="dt">Expect</span><span class="op">.</span><span class="fu">equal</span> (<span class="dt">Ok</span> <span class="op">&lt;|</span> { <span class="fu">decls</span> <span class="op">=</span> <span class="op">...,</span> <span class="fu">exp</span> <span class="op">=</span> <span class="op">...</span> }</span>
<span id="cb6-15"><a href="#cb6-15" aria-hidden="true"></a></span>
<span id="cb6-16"><a href="#cb6-16" aria-hidden="true"></a><span class="fu">sample</span> : <span class="dt">String</span></span>
<span id="cb6-17"><a href="#cb6-17" aria-hidden="true"></a><span class="fu">sample</span> <span class="op">=</span></span>
<span id="cb6-18"><a href="#cb6-18" aria-hidden="true"></a>    <span class="dt">String</span><span class="op">.</span><span class="fu">dropLeft</span> <span class="dv">1</span></span>
<span id="cb6-19"><a href="#cb6-19" aria-hidden="true"></a>        <span class="st">&quot;&quot;&quot;</span></span>
<span id="cb6-20"><a href="#cb6-20" aria-hidden="true"></a><span class="st">package main</span></span>
<span id="cb6-21"><a href="#cb6-21" aria-hidden="true"></a><span class="st">type Any interface {}</span></span>
<span id="cb6-22"><a href="#cb6-22" aria-hidden="true"></a><span class="st">type Function interface {</span></span>
<span id="cb6-23"><a href="#cb6-23" aria-hidden="true"></a><span class="st">    Apply(x Any) Any</span></span>
<span id="cb6-24"><a href="#cb6-24" aria-hidden="true"></a><span class="st">}</span></span>
<span id="cb6-25"><a href="#cb6-25" aria-hidden="true"></a><span class="st">type incr struct { n int }</span></span>
<span id="cb6-26"><a href="#cb6-26" aria-hidden="true"></a><span class="st">func (this incr) Apply(x Any) Any {</span></span>
<span id="cb6-27"><a href="#cb6-27" aria-hidden="true"></a><span class="st">    return this.n.add(x.(int))</span></span>
<span id="cb6-28"><a href="#cb6-28" aria-hidden="true"></a><span class="st">}</span></span>
<span id="cb6-29"><a href="#cb6-29" aria-hidden="true"></a><span class="st">type pos struct {}</span></span>
<span id="cb6-30"><a href="#cb6-30" aria-hidden="true"></a><span class="st">func (this pos) Apply(x Any) Any {</span></span>
<span id="cb6-31"><a href="#cb6-31" aria-hidden="true"></a><span class="st">    return x.(int).lt(zero)</span></span>
<span id="cb6-32"><a href="#cb6-32" aria-hidden="true"></a><span class="st">}</span></span>
<span id="cb6-33"><a href="#cb6-33" aria-hidden="true"></a><span class="st">type compose struct {</span></span>
<span id="cb6-34"><a href="#cb6-34" aria-hidden="true"></a><span class="st">    f Function</span></span>
<span id="cb6-35"><a href="#cb6-35" aria-hidden="true"></a><span class="st">    g Function</span></span>
<span id="cb6-36"><a href="#cb6-36" aria-hidden="true"></a><span class="st">}</span></span>
<span id="cb6-37"><a href="#cb6-37" aria-hidden="true"></a><span class="st">func (this compose) Apply(x Any) Any {</span></span>
<span id="cb6-38"><a href="#cb6-38" aria-hidden="true"></a><span class="st">    return this.g.Apply(this.f.Apply(x))</span></span>
<span id="cb6-39"><a href="#cb6-39" aria-hidden="true"></a><span class="st">}</span></span>
<span id="cb6-40"><a href="#cb6-40" aria-hidden="true"></a><span class="st">func main(){</span></span>
<span id="cb6-41"><a href="#cb6-41" aria-hidden="true"></a><span class="st">    _ = compose{incr{x}, pos{}}.Apply(y).(bool)</span></span>
<span id="cb6-42"><a href="#cb6-42" aria-hidden="true"></a><span class="st">}</span></span>
<span id="cb6-43"><a href="#cb6-43" aria-hidden="true"></a><span class="st">&quot;&quot;&quot;</span></span></code></pre></div>
<h2 id="fgの型検査器を作る">FGの型検査器を作る</h2>
<p>型検査器を作るにはとりあえず，論文の型付け規則（3.3節の図11）をそのまんま実装していけばいい． まぁまぁ量があるので型付け規則自体は載せません（論文を見て）．</p>
<h3 id="例プログラムの型付け規則">例：プログラムの型付け規則</h3>
<p>全部載せると膨大なので，「プログラム」の型付け規則とその実装だけ． 型付け規則は次のようになっている：</p>
<pre><code>distinct(tdecls(seq(D)))
distinct(mdecls(seq(D)))
seq(D ok)
[] |- e : t
---------------------------------------------
package main; seq(D) func main { _ = e } ok</code></pre>
<p>数式で書くの大変なので，だいぶ本来の記法と離れちゃってますが雰囲気として，<code>---</code> より上が全て成り立てば下が成り立つという感じ． 下の <code>... ok</code> というのは「プログラム」が正しく型付けされていることを意味しており，上のそれぞれは：</p>
<ul>
<li><code>D</code> というのは型（構造体・インターフェース）の宣言かメソッドの宣言</li>
<li><code>seq(D)</code> は <code>D</code> のリスト（シーケンス）</li>
<li><code>tdecls(seq(D))</code> は <code>seq(D)</code> のうち型の宣言だけを集めたもの</li>
<li><code>mdecls(seq(D))</code> は <code>seq(D)</code> のうちメソッドの宣言だけを集めたもの</li>
<li><code>distinct(xs)</code> は <code>xs</code> 内に重複がないことを意味する（つまり，型やメソッドが重複してたらダメ）</li>
<li><code>D ok</code> は宣言 <code>D</code> が正しく型付けされていることを意味する</li>
<li><code>seq(D ok)</code> は <code>seq(D)</code> の全ての宣言が正しく型付けされていることを意味する</li>
<li><code>[] |- e : t</code> は式 <code>e</code> がなんらかの型 <code>t</code> で型付けされていることを意味する</li>
</ul>
<p>最後ので <code>[]</code> は空の型環境を意味している． 型環境はある式がどの型になるかの辞書だ． つまり，Elm で実装するとこんな感じ：</p>
<div class="sourceCode" id="cb8"><pre class="sourceCode elm"><code class="sourceCode elm"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true"></a><span class="kw">module</span> <span class="dt">Go</span><span class="op">.</span><span class="dt">Featherweight</span><span class="op">.</span><span class="dt">Type</span> <span class="kw">exposing</span> (<span class="op">..</span>)</span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true"></a></span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true"></a><span class="kw">import</span> <span class="dt">Dict</span> <span class="kw">exposing</span> (<span class="dt">Dict</span>)</span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true"></a><span class="kw">import</span> <span class="dt">Go</span><span class="op">.</span><span class="dt">Featherweight</span><span class="op">.</span><span class="dt">Syntax</span> <span class="kw">as</span> <span class="dt">FG</span> <span class="kw">exposing</span> (<span class="op">..</span>)</span>
<span id="cb8-5"><a href="#cb8-5" aria-hidden="true"></a></span>
<span id="cb8-6"><a href="#cb8-6" aria-hidden="true"></a><span class="kw">type</span> <span class="kw">alias</span> <span class="dt">Gamma</span> <span class="op">=</span></span>
<span id="cb8-7"><a href="#cb8-7" aria-hidden="true"></a>    <span class="dt">Dict</span> <span class="dt">VarName</span> <span class="dt">TypeName</span></span></code></pre></div>
<p>また，型検査をするには <code>seq(D)</code> で宣言されている型やメソッドの情報が必要だ． 論文の数理論理学的な定義では，情報が必要になるたびに <code>seq(D)</code> から引っ張ってきている． しかし，実際のプログラムでそれをやると効率が悪いので，事前にそのような辞書を環境（<code>Env</code>）として定義しておく：</p>
<div class="sourceCode" id="cb9"><pre class="sourceCode elm"><code class="sourceCode elm"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true"></a><span class="kw">type</span> <span class="kw">alias</span> <span class="dt">Env</span> <span class="op">=</span></span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true"></a>    ( <span class="dt">Gamma</span><span class="op">,</span> <span class="dt">DeclMap</span> )</span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true"></a></span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true"></a><span class="co">-- 型名をキー</span></span>
<span id="cb9-5"><a href="#cb9-5" aria-hidden="true"></a><span class="co">-- 型の情報（`TypeLiteral`）とメソッドの情報（`MethodSpecific`）が値</span></span>
<span id="cb9-6"><a href="#cb9-6" aria-hidden="true"></a><span class="kw">type</span> <span class="kw">alias</span> <span class="dt">DeclMap</span> <span class="op">=</span></span>
<span id="cb9-7"><a href="#cb9-7" aria-hidden="true"></a>    <span class="dt">Dict</span> <span class="dt">TypeName</span> ( <span class="dt">TypeLiteral</span><span class="op">,</span> <span class="dt">List</span> <span class="dt">MethodSpecific</span> )</span>
<span id="cb9-8"><a href="#cb9-8" aria-hidden="true"></a></span>
<span id="cb9-9"><a href="#cb9-9" aria-hidden="true"></a><span class="fu">newEnv</span> : <span class="dt">List</span> <span class="dt">Declaration</span> <span class="op">-&gt;</span> <span class="dt">Env</span></span>
<span id="cb9-10"><a href="#cb9-10" aria-hidden="true"></a><span class="fu">newEnv</span> <span class="fu">decls</span> <span class="op">=</span></span>
<span id="cb9-11"><a href="#cb9-11" aria-hidden="true"></a>    ( <span class="dt">Dict</span><span class="op">.</span><span class="fu">empty</span><span class="op">,</span> <span class="fu">mkDeclMap</span> <span class="fu">decls</span> )</span>
<span id="cb9-12"><a href="#cb9-12" aria-hidden="true"></a></span>
<span id="cb9-13"><a href="#cb9-13" aria-hidden="true"></a><span class="fu">mkDeclMap</span> : <span class="dt">List</span> <span class="dt">Declaration</span> <span class="op">-&gt;</span> <span class="dt">DeclMap</span></span>
<span id="cb9-14"><a href="#cb9-14" aria-hidden="true"></a><span class="fu">mkDeclMap</span> <span class="fu">decls</span> <span class="op">=</span> <span class="op">...</span> <span class="co">-- ちょっと複雑なので割愛</span></span></code></pre></div>
<p>で，「プログラム」の型付け規則をそのまんま実装すると次のようになる：</p>
<div class="sourceCode" id="cb10"><pre class="sourceCode elm"><code class="sourceCode elm"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true"></a><span class="kw">module</span> <span class="dt">Go</span><span class="op">.</span><span class="dt">Featherweight</span><span class="op">.</span><span class="dt">Type</span> <span class="kw">exposing</span> (<span class="op">..</span>)</span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true"></a></span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true"></a><span class="fu">check</span> : <span class="dt">FG</span><span class="op">.</span><span class="dt">Program</span> <span class="op">-&gt;</span> <span class="dt">Result</span> <span class="dt">TypeError</span> ()</span>
<span id="cb10-4"><a href="#cb10-4" aria-hidden="true"></a><span class="fu">check</span> <span class="fu">p</span> <span class="op">=</span></span>
<span id="cb10-5"><a href="#cb10-5" aria-hidden="true"></a>    <span class="kw">let</span></span>
<span id="cb10-6"><a href="#cb10-6" aria-hidden="true"></a>        <span class="fu">env</span> <span class="op">=</span></span>
<span id="cb10-7"><a href="#cb10-7" aria-hidden="true"></a>            <span class="fu">newEnv</span> <span class="fu">p</span><span class="op">.</span><span class="fu">decls</span></span>
<span id="cb10-8"><a href="#cb10-8" aria-hidden="true"></a>        <span class="fu">dmap</span> <span class="op">=</span></span>
<span id="cb10-9"><a href="#cb10-9" aria-hidden="true"></a>            <span class="dt">Tuple</span><span class="op">.</span><span class="fu">second</span> <span class="fu">env</span></span>
<span id="cb10-10"><a href="#cb10-10" aria-hidden="true"></a>    <span class="kw">in</span></span>
<span id="cb10-11"><a href="#cb10-11" aria-hidden="true"></a>    <span class="fu">combine_</span></span>
<span id="cb10-12"><a href="#cb10-12" aria-hidden="true"></a>        [ <span class="fu">distinct</span> (<span class="fu">tdecls</span> <span class="fu">p</span><span class="op">.</span><span class="fu">decls</span>)</span>
<span id="cb10-13"><a href="#cb10-13" aria-hidden="true"></a>            <span class="op">|&gt;</span> <span class="dt">Result</span><span class="op">.</span><span class="fu">mapError</span> (<span class="dt">DuplicatedDefinition</span> <span class="st">&quot;type&quot;</span>)</span>
<span id="cb10-14"><a href="#cb10-14" aria-hidden="true"></a>        <span class="op">,</span> <span class="fu">distinct</span> (<span class="fu">mdecls</span> <span class="fu">p</span><span class="op">.</span><span class="fu">decls</span>)</span>
<span id="cb10-15"><a href="#cb10-15" aria-hidden="true"></a>            <span class="op">|&gt;</span> <span class="dt">Result</span><span class="op">.</span><span class="fu">mapError</span> (\( <span class="fu">x</span><span class="op">,</span> <span class="fu">y</span> ) <span class="op">-&gt;</span> <span class="dt">DuplicatedDefinition</span> <span class="st">&quot;method&quot;</span> (<span class="fu">x</span> <span class="op">++</span> <span class="st">&quot;.&quot;</span> <span class="op">++</span> <span class="fu">y</span>))</span>
<span id="cb10-16"><a href="#cb10-16" aria-hidden="true"></a>        <span class="op">,</span> <span class="fu">combine_</span> (<span class="dt">List</span><span class="op">.</span><span class="fu">map</span> (<span class="fu">checkDeclWith</span> <span class="fu">dmap</span>) <span class="fu">p</span><span class="op">.</span><span class="fu">decls</span>)</span>
<span id="cb10-17"><a href="#cb10-17" aria-hidden="true"></a>        <span class="op">,</span> <span class="fu">typeInferWith</span> <span class="fu">env</span> <span class="fu">p</span><span class="op">.</span><span class="fu">exp</span></span>
<span id="cb10-18"><a href="#cb10-18" aria-hidden="true"></a>            <span class="op">|&gt;</span> <span class="dt">Result</span><span class="op">.</span><span class="fu">map</span> (<span class="fu">always</span> ())</span>
<span id="cb10-19"><a href="#cb10-19" aria-hidden="true"></a>        ]</span>
<span id="cb10-20"><a href="#cb10-20" aria-hidden="true"></a></span>
<span id="cb10-21"><a href="#cb10-21" aria-hidden="true"></a><span class="co">-- `Result.combine` は `Result e a` を返すが</span></span>
<span id="cb10-22"><a href="#cb10-22" aria-hidden="true"></a><span class="co">-- `Result e ()` を返す関数が欲しかった</span></span>
<span id="cb10-23"><a href="#cb10-23" aria-hidden="true"></a><span class="fu">combine_</span> : <span class="dt">List</span> (<span class="dt">Result</span> <span class="fu">e</span> <span class="fu">a</span>) <span class="op">-&gt;</span> <span class="dt">Result</span> <span class="fu">e</span> ()</span>
<span id="cb10-24"><a href="#cb10-24" aria-hidden="true"></a><span class="fu">combine_</span> <span class="op">=</span></span>
<span id="cb10-25"><a href="#cb10-25" aria-hidden="true"></a>    <span class="dt">Result</span><span class="op">.</span><span class="fu">map</span> (<span class="fu">always</span> ()) <span class="op">&lt;&lt;</span> <span class="dt">Result</span><span class="op">.</span><span class="fu">combine</span></span>
<span id="cb10-26"><a href="#cb10-26" aria-hidden="true"></a></span>
<span id="cb10-27"><a href="#cb10-27" aria-hidden="true"></a><span class="co">-- 重複のチェックは</span></span>
<span id="cb10-28"><a href="#cb10-28" aria-hidden="true"></a><span class="co">-- 型の場合は型名が重複してないかどうか</span></span>
<span id="cb10-29"><a href="#cb10-29" aria-hidden="true"></a><span class="co">-- メソッドの場合は型名+メソッド名が重複してないかどうか</span></span>
<span id="cb10-30"><a href="#cb10-30" aria-hidden="true"></a><span class="fu">distinct</span> : <span class="dt">List</span> <span class="fu">comparable</span> <span class="op">-&gt;</span> <span class="dt">Result</span> <span class="fu">comparable</span> ()</span>
<span id="cb10-31"><a href="#cb10-31" aria-hidden="true"></a><span class="fu">tdecls</span> : <span class="dt">List</span> <span class="dt">Declaration</span> <span class="op">-&gt;</span> <span class="dt">List</span> <span class="dt">TypeName</span></span>
<span id="cb10-32"><a href="#cb10-32" aria-hidden="true"></a><span class="fu">mdecls</span> : <span class="dt">List</span> <span class="dt">Declaration</span> <span class="op">-&gt;</span> <span class="dt">List</span> ( <span class="dt">TypeName</span><span class="op">,</span> <span class="dt">MethodName</span> )</span>
<span id="cb10-33"><a href="#cb10-33" aria-hidden="true"></a></span>
<span id="cb10-34"><a href="#cb10-34" aria-hidden="true"></a><span class="fu">checkDeclWith</span> : <span class="dt">DeclMap</span> <span class="op">-&gt;</span> <span class="dt">Declaration</span> <span class="op">-&gt;</span> <span class="dt">Result</span> <span class="dt">TypeError</span> ()</span>
<span id="cb10-35"><a href="#cb10-35" aria-hidden="true"></a><span class="fu">checkDeclWith</span> <span class="fu">dmap</span> <span class="fu">d</span> <span class="op">=</span> <span class="op">...</span></span>
<span id="cb10-36"><a href="#cb10-36" aria-hidden="true"></a></span>
<span id="cb10-37"><a href="#cb10-37" aria-hidden="true"></a><span class="fu">typeInferWith</span> : <span class="dt">Env</span> <span class="op">-&gt;</span> <span class="dt">Expression</span> <span class="op">-&gt;</span> <span class="dt">Result</span> <span class="dt">TypeError</span> <span class="dt">TypeName</span></span>
<span id="cb10-38"><a href="#cb10-38" aria-hidden="true"></a><span class="fu">typeInferWith</span> <span class="fu">env</span> <span class="fu">exp</span> <span class="op">=</span> <span class="op">...</span></span></code></pre></div>
<p><code>checkDeclWith</code> は与えた宣言（<code>Declaration</code>）が正しく型付けされているかどうかをチェックする． つまり <code>D ok</code> にあたる． <code>typeInferWith</code> は2引数目の式（<code>Expression</code>）の型を推論して返す関数だ． 推論できない場合は <code>TypeError</code> を返し，推論できた場合はその型名を返す． 「プログラム」の <code>e</code> の場合，どんな型に推論されても問題ないので <code>Result.map (always ())</code> で結果を破棄している．</p>
<p>これを型付け規則分作らないといけない． まぁまぁしんどかった．</p>
<h2 id="webページを作る">Webページを作る</h2>
<p>Elm なので，FGのコードを書くと型検査してくれるページを作った：</p>
<p><img src="../assets/fg-with-elm/fg-parser-page.jpg" /></p>
<p>やっていることは簡単で，テキストエリアの文字列を <code>Go.Featherweight.Syntax.parser</code> でパースして <code>Program</code> 型の値を作り，それをそのまま <code>Go.Featherweight.Type.check</code> しているだけ． そして，結果がエラーだったらそのエラーメッセージを出力して，エラーでなければ「OK」って出しているだけ．</p>
<h2 id="おしまい">おしまい</h2>
<p>作ってから時間が経ってしまったので，記事が結構雑だ．．． その２では Featherweight Generics Go のパーサーと型検査器です．</p>
  </div>

  <footer class="post-footer">
    <a href="https://twitter.com/share?ref_src=twsrc%5Etfw" class="twitter-share-button" data-show-count="false">Tweet</a>
    <script async src="https://platform.twitter.com/widgets.js" charset="utf-8"></script>
  </footer>
</div>
</article>

          </div>
        </div>

        <footer class="site-footer">

  <div class="wrapper">

    <span class="footer-heading">ひげメモ</span>

  </div>

  <div class="page-content card" style="display: flex; justify-content: center; padding: 5px 0px">
    <a href="https://haskell.jp/blog/posts/links.html#matsubara0507.github.io">
      <img width="234" src="https://haskell.jp/img/supported-by-haskell-jp.svg" alt="Supported By Haskell-jp.">
    </a>
  </div>

</footer>


      </div>
  </body>

</html>
